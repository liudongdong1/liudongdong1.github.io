<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>Android_启动流程 - DAY By DAY</title><meta name=author content="LiuDongdong"><meta name=author-link content="https://liudongdong1.github.io/"><meta name=description content="1. Bootloader U-boot启动流程 第一阶段：汇编代码：U-boot的第一条指令从cpu/armXXX/start.S文件开始 第二阶段：C代码：从文件/"><meta name=keywords content="Android"><meta itemprop=name content="Android_启动流程"><meta itemprop=description content="1. Bootloader U-boot启动流程 第一阶段：汇编代码：U-boot的第一条指令从cpu/armXXX/start.S文件开始 第二阶段：C代码：从文件/"><meta itemprop=dateModified content="2023-09-28T22:47:27+08:00"><meta itemprop=wordCount content="6615"><meta itemprop=image content="/logo.png"><meta itemprop=keywords content="Android,"><meta property="og:title" content="Android_启动流程"><meta property="og:description" content="1. Bootloader U-boot启动流程 第一阶段：汇编代码：U-boot的第一条指令从cpu/armXXX/start.S文件开始 第二阶段：C代码：从文件/"><meta property="og:type" content="article"><meta property="og:url" content="liudongdong1.github.io/android-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"><meta property="og:image" content="/logo.png"><meta property="article:section" content="posts"><meta property="article:modified_time" content="2023-09-28T22:47:27+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/logo.png"><meta name=twitter:title content="Android_启动流程"><meta name=twitter:description content="1. Bootloader U-boot启动流程 第一阶段：汇编代码：U-boot的第一条指令从cpu/armXXX/start.S文件开始 第二阶段：C代码：从文件/"><meta name=application-name content="DAY By DAY"><meta name=apple-mobile-web-app-title content="DAY By DAY"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=liudongdong1.github.io/android-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/><link rel=prev href=liudongdong1.github.io/android_%E9%9F%B3%E8%A7%86%E9%A2%91%E5%BC%80%E5%8F%91/><link rel=next href=liudongdong1.github.io/android_%E5%AD%98%E5%82%A8/><link rel=stylesheet href=/liudongdong1.github.io/css/style.min.css><link rel=stylesheet href=/liudongdong1.github.io/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/liudongdong1.github.io/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Android_启动流程","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"liudongdong1.github.io\/android-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B\/"},"genre":"posts","keywords":"Android","wordcount":6615,"url":"liudongdong1.github.io\/android-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B\/","dateModified":"2023-09-28T22:47:27+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"LiuDongdong","logo":"\/images\/person.png"},"author":{"@type":"Person","name":"liudongdong1"},"description":""}</script></head><body data-header-desktop=auto data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=right><div class=header-title><a href=liudongdong1.github.io/ title="DAY By DAY"><img class="lazyload logo" src=/liudongdong1.github.io/svg/loading.min.svg data-src=/fixit.min.svg data-srcset="/fixit.min.svg, /fixit.min.svg 1.5x, /fixit.min.svg 2x" data-sizes=auto alt="DAY By DAY" title="DAY By DAY"><span class=header-title-text></span></a><span id=typeit-header-subtitle-desktop class="typeit header-subtitle"></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/liudongdong1.github.io/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 所有文章</a></li><li class=menu-item><a class=menu-link href=/liudongdong1.github.io/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/liudongdong1.github.io/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/liudongdong1.github.io/friends/ title=友情链接><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/liudongdong1.github.io/about/><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item language"><span role=button aria-label=选择语言 title=选择语言>简体中文<i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i></span><ul class=sub-menu><li class=menu-item>没有更多翻译</li></ul></li><li class="menu-item search" id=search-desktop><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=liudongdong1.github.io/ title="DAY By DAY"><img class="lazyload logo" src=/liudongdong1.github.io/svg/loading.min.svg data-src=/fixit.min.svg data-srcset="/fixit.min.svg, /fixit.min.svg 1.5x, /fixit.min.svg 2x" data-sizes=auto alt=/fixit.min.svg title=/fixit.min.svg><span class=header-title-text></span></a><span id=typeit-header-subtitle-mobile class="typeit header-subtitle"></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/liudongdong1.github.io/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 所有文章</a></li><li class=menu-item><a class=menu-link href=/liudongdong1.github.io/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/liudongdong1.github.io/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/liudongdong1.github.io/friends/ title=友情链接><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/liudongdong1.github.io/about/><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item text-center"><a class=menu-link href=https://liudongdong1.github.io/ title=GitHub rel="noopener noreferrer" target=_blank><i class='fa-brands fa-github fa-fw' aria-hidden=true></i></a></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li><li class="menu-item language"><span role=button aria-label=选择语言 title=选择语言>简体中文<i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i></span>
<select class=language-select onchange="location=this.value"><option disabled>没有更多翻译</option></select></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container data-page-style=normal><aside class=toc id=toc-auto><h2 class=toc-title>目录 <i class="toc-icon fa-solid fa-angle-down fa-fw"></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom id=aside-sakana><div class=sakana-widget><div class=sakana-item id=takina-widget></div><div class=sakana-item id=chisato-widget></div></div><script>function initSakanaWidget(){const e=SakanaWidget.getCharacter("takina");SakanaWidget.registerCharacter("takina-slow",e),new SakanaWidget({character:"takina-slow",controls:!1,autoFit:!0,stroke:{color:"#b4b4b4",width:2}}).mount("#takina-widget");const t=SakanaWidget.getCharacter("chisato");SakanaWidget.registerCharacter("chisato-slow",t),new SakanaWidget({character:"chisato-slow",controls:!1,autoFit:!0,stroke:{color:"#b4b4b4",width:2}}).mount("#chisato-widget")}</script><script async onload=initSakanaWidget() src=https://cdn.jsdelivr.net/npm/sakana-widget@2.3.0/lib/sakana.min.js></script></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>Android_启动流程</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><i class="fa-solid fa-user-circle" aria-hidden=true></i>
liudongdong1</span></span>
<span class=post-category>收录于 <a href=liudongdong1.github.io/categories/><i class="fa-regular fa-folder fa-fw"></i>&nbsp;Categories</a>&ensp;<a href=liudongdong1.github.io/categories/framework/><i class="fa-regular fa-folder fa-fw"></i>&nbsp;Framework</a></span></div><div class=post-meta-line><span title="0001-01-01 00:00:00"><i class="fa-regular fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=0001-01-01>0001-01-01</time>
</span>&nbsp;<i class="fa-solid fa-pencil-alt fa-fw"></i>&nbsp;约 6615 字&nbsp;
<i class="fa-regular fa-clock fa-fw"></i>&nbsp;预计阅读 14 分钟&nbsp;<span id=busuanzi_container_page_pv class="busuanzi_visitors comment-visitors" data-flag-title=Android_启动流程>
<i class="fa-regular fa-eye fa-fw"></i>&nbsp;<span id=busuanzi_value_page_pv>-</span>&nbsp;次阅读
</span>&nbsp;</div></div><div class=featured-image><img class=lazyload src=/liudongdong1.github.io/svg/loading.min.svg data-src=https://cdn.pixabay.com/photo/2021/09/15/06/29/pot-marigold-6625895__340.jpg data-srcset="https://cdn.pixabay.com/photo/2021/09/15/06/29/pot-marigold-6625895__340.jpg, https://cdn.pixabay.com/photo/2021/09/15/06/29/pot-marigold-6625895__340.jpg 1.5x, https://cdn.pixabay.com/photo/2021/09/15/06/29/pot-marigold-6625895__340.jpg 2x" data-sizes=auto alt=https://cdn.pixabay.com/photo/2021/09/15/06/29/pot-marigold-6625895__340.jpg title=https://cdn.pixabay.com/photo/2021/09/15/06/29/pot-marigold-6625895__340.jpg></div><div class="details toc" id=toc-static kept=true><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#1-bootloader>1. Bootloader</a></li><li><a href=#2-initcpp>2. Init.cpp</a></li><li><a href=#3-zygotehttpswwwjianshucomp4e5909d24d65>3. <a href=https://www.jianshu.com/p/4e5909d24d65>zygote</a></a></li><li><a href=#4-systemservice>4. SystemService</a></li><li><a href=#resource>Resource</a></li></ul></li></ul></nav></div></div><div class=content id=content><p><img class=lazyload src=/liudongdong1.github.io/svg/loading.min.svg data-src=https://gitee.com/github-25970295/blogimgv2022/raw/master/webp-166919226600621.webp data-srcset="https://gitee.com/github-25970295/blogimgv2022/raw/master/webp-166919226600621.webp, https://gitee.com/github-25970295/blogimgv2022/raw/master/webp-166919226600621.webp 1.5x, https://gitee.com/github-25970295/blogimgv2022/raw/master/webp-166919226600621.webp 2x" data-sizes=auto alt=https://gitee.com/github-25970295/blogimgv2022/raw/master/webp-166919226600621.webp title=https://gitee.com/github-25970295/blogimgv2022/raw/master/webp-166919226600621.webp></p><h3 id=1-bootloader>1. Bootloader</h3><ul><li>U-boot启动流程<ul><li>第一阶段：汇编代码：U-boot的第一条指令从cpu/armXXX/start.S文件开始</li><li>第二阶段：C代码：从文件/lib_arm/board.c的start_armboot()函数开始。</li></ul></li></ul><table><thead><tr><th>Bootloader</th><th style=text-align:center>Monitor？</th><th style=text-align:right>描述</th><th style=text-align:right>X86</th><th style=text-align:right>ARM</th><th style=text-align:right>PowerPC</th></tr></thead><tbody><tr><td>U-boot</td><td style=text-align:center>是</td><td style=text-align:right>通用引导程序</td><td style=text-align:right>是</td><td style=text-align:right>是</td><td style=text-align:right>是</td></tr><tr><td>ReBoot</td><td style=text-align:center>是</td><td style=text-align:right>是基于eCos的引导程序</td><td style=text-align:right>是</td><td style=text-align:right>是</td><td style=text-align:right>是</td></tr><tr><td>BLOB</td><td style=text-align:center>否</td><td style=text-align:right>(StrongARM架构) LART(主板)等硬件平台的引导程序</td><td style=text-align:right>否</td><td style=text-align:right>是</td><td style=text-align:right>否</td></tr><tr><td>LILO</td><td style=text-align:center>否</td><td style=text-align:right>Linux磁盘引导程序</td><td style=text-align:right>是</td><td style=text-align:right>否</td><td style=text-align:right>否</td></tr><tr><td>GRUB</td><td style=text-align:center>否</td><td style=text-align:right>GNU的LILO替代程序</td><td style=text-align:right>是</td><td style=text-align:right>否</td><td style=text-align:right>否</td></tr><tr><td>Loadlin</td><td style=text-align:center>否</td><td style=text-align:right>从DOS引导Linux</td><td style=text-align:right>是</td><td style=text-align:right>否</td><td style=text-align:right>否</td></tr><tr><td>Vivi</td><td style=text-align:center>是</td><td style=text-align:right>韩国mizi公司开发的bootloader</td><td style=text-align:right>否</td><td style=text-align:right>是</td><td style=text-align:right>否</td></tr></tbody></table><h3 id=2-initcpp>2. Init.cpp</h3><p>init进程是Android系统启动的第一个进程。它通过解析init.rc脚本来构建出系统的初始形态。</p><ul><li><a href=http://androidxref.com/6.0.1_r10/xref/system/core/init/init.cpp target=_blank rel="external nofollow noopener noreferrer">http://androidxref.com/6.0.1_r10/xref/system/core/init/init.cpp<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a> ， <a href=https://www.jianshu.com/p/464c3d1203b1 target=_blank rel="external nofollow noopener noreferrer">解析<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></li><li>android6 代码， android 10 不太一样</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span><span style=color:#f92672>**</span> argv) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ****************** 第一部分 ****************** 
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 检查启动程序的文件名
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>strcmp(basename(argv[<span style=color:#ae81ff>0</span>]), <span style=color:#e6db74>&#34;ueventd&#34;</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> ueventd_main(argc, argv);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>strcmp(basename(argv[<span style=color:#ae81ff>0</span>]), <span style=color:#e6db74>&#34;watchdogd&#34;</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> watchdogd_main(argc, argv);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ****************** 第二部分 ****************** 
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 设置文件属性为0777
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Clear the umask.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    umask(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ****************** 第三部分 ****************** 
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 设置环境变量
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    add_environment(<span style=color:#e6db74>&#34;PATH&#34;</span>, _PATH_DEFPATH);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ****************** 第四部分 ****************** 
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 创建一些基本目录，并挂载
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//判断是否是第一次
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>bool</span> is_first_stage <span style=color:#f92672>=</span> (argc <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>||</span> (strcmp(argv[<span style=color:#ae81ff>1</span>], <span style=color:#e6db74>&#34;--second-stage&#34;</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Get the basic filesystem setup we need put together in the initramdisk
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// on / and then we&#39;ll let the rc file figure out the rest
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//如果是第一次.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (is_first_stage) {
</span></span><span style=display:flex><span>        mount(<span style=color:#e6db74>&#34;tmpfs&#34;</span>, <span style=color:#e6db74>&#34;/dev&#34;</span>, <span style=color:#e6db74>&#34;tmpfs&#34;</span>, MS_NOSUID, <span style=color:#e6db74>&#34;mode=0755&#34;</span>);
</span></span><span style=display:flex><span>        mkdir(<span style=color:#e6db74>&#34;/dev/pts&#34;</span>, <span style=color:#ae81ff>0755</span>);
</span></span><span style=display:flex><span>        mkdir(<span style=color:#e6db74>&#34;/dev/socket&#34;</span>, <span style=color:#ae81ff>0755</span>);
</span></span><span style=display:flex><span>        mount(<span style=color:#e6db74>&#34;devpts&#34;</span>, <span style=color:#e6db74>&#34;/dev/pts&#34;</span>, <span style=color:#e6db74>&#34;devpts&#34;</span>, <span style=color:#ae81ff>0</span>, NULL);
</span></span><span style=display:flex><span>        mount(<span style=color:#e6db74>&#34;proc&#34;</span>, <span style=color:#e6db74>&#34;/proc&#34;</span>, <span style=color:#e6db74>&#34;proc&#34;</span>, <span style=color:#ae81ff>0</span>, NULL);
</span></span><span style=display:flex><span>        mount(<span style=color:#e6db74>&#34;sysfs&#34;</span>, <span style=color:#e6db74>&#34;/sys&#34;</span>, <span style=color:#e6db74>&#34;sysfs&#34;</span>, <span style=color:#ae81ff>0</span>, NULL);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ****************** 第五部分 ****************** 
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 把标准输入、标准输出和标准错误重定向到空设备文件&#34;/dev/_null_&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// We must have some place other than / to create the device nodes for
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// kmsg and null, otherwise we won&#39;t be able to remount / read-only
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// later on. Now that tmpfs is mounted on /dev, we can actually talk
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// to the outside world.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    open_devnull_stdio();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ****************** 第六部分 ****************** 
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 启动kernel log
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    klog_init();
</span></span><span style=display:flex><span>    klog_set_level(KLOG_NOTICE_LEVEL);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 输出init启动阶段的log      
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    NOTICE(<span style=color:#e6db74>&#34;init%s started!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, is_first_stage <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34; second stage&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ****************** 第七部分 ****************** 
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 设置系统属性
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>is_first_stage) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Indicate that booting is in progress to background fw loaders, etc.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 7.1 创建初始化标志
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        close(open(<span style=color:#e6db74>&#34;/dev/.booting&#34;</span>, O_WRONLY <span style=color:#f92672>|</span> O_CREAT <span style=color:#f92672>|</span> O_CLOEXEC, <span style=color:#ae81ff>0000</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//7.2 初始化Android的属性系统
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        property_init();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// If arguments are passed both on the command line and in DT,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// properties set in DT always have priority over the command-line ones.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//7.3  解析DT和命令行中的kernel启动参数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        process_kernel_dt();
</span></span><span style=display:flex><span>        process_kernel_cmdline();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Propogate the kernel variables to internal variables
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// used by init as well as the current required properties.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//7.4  设置系统属性
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        export_kernel_boot_props();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ****************** 第八部分 ****************** 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Set up SELinux, including loading the SELinux policy if we&#39;re in the kernel domain.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 调用selinux_initialize函数启动SELinux
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    selinux_initialize(is_first_stage);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// If we&#39;re in the kernel domain, re-exec init to transition to the init domain now
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// that the SELinux policy has been loaded.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (is_first_stage) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 按照selinux policy要求，重新设置init文件属性
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (restorecon(<span style=color:#e6db74>&#34;/init&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>            ERROR(<span style=color:#e6db74>&#34;restorecon failed: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, strerror(errno));
</span></span><span style=display:flex><span>            security_failure();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> path <span style=color:#f92672>=</span> argv[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 设置参数  --second-stage
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> args[] <span style=color:#f92672>=</span> { path, <span style=color:#66d9ef>const_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>char</span><span style=color:#f92672>*&gt;</span>(<span style=color:#e6db74>&#34;--second-stage&#34;</span>), <span style=color:#66d9ef>nullptr</span> };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 执行init进程，重新进入main函数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (execv(path, args) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>            ERROR(<span style=color:#e6db74>&#34;execv(</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>%s</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>) failed: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, path, strerror(errno));
</span></span><span style=display:flex><span>            security_failure();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// These directories were necessarily created before initial policy load
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// and therefore need their security context restored to the proper value.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// This must happen before /dev is populated by ueventd.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    INFO(<span style=color:#e6db74>&#34;Running restorecon...</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    restorecon(<span style=color:#e6db74>&#34;/dev&#34;</span>);
</span></span><span style=display:flex><span>    restorecon(<span style=color:#e6db74>&#34;/dev/socket&#34;</span>);
</span></span><span style=display:flex><span>    restorecon(<span style=color:#e6db74>&#34;/dev/__properties__&#34;</span>);
</span></span><span style=display:flex><span>    restorecon_recursive(<span style=color:#e6db74>&#34;/sys&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ****************** 第九部分 ****************** 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    epoll_fd <span style=color:#f92672>=</span> epoll_create1(EPOLL_CLOEXEC);  <span style=color:#75715e>//调用epoll_create1创建epoll句柄
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (epoll_fd <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        ERROR(<span style=color:#e6db74>&#34;epoll_create1 failed: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, strerror(errno));
</span></span><span style=display:flex><span>        exit(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    signal_handler_init();  <span style=color:#75715e>//调用signal_handler_init()函数，主要是装载进程信号处理器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//主要是当子进程被kill之后，会在父进程接受一个信号。处理这个信号的时候往sockpair一段写数据，而另一端的fd是加入epoll中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ****************** 第十部分 ****************** 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    property_load_boot_defaults();
</span></span><span style=display:flex><span>    start_property_service();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ****************** 第十一部分 ****************** 
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 重点部分，我们后面用专门用一篇文章讲解
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    init_parse_config_file(<span style=color:#e6db74>&#34;/init.rc&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ****************** 第十二部分 ****************** 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    action_for_each_trigger(<span style=color:#e6db74>&#34;early-init&#34;</span>, action_add_queue_tail);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Queue an action that waits for coldboot done so we know ueventd has set up all of /dev...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    queue_builtin_action(wait_for_coldboot_done_action, <span style=color:#e6db74>&#34;wait_for_coldboot_done&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ... so that we can start queuing up actions that require stuff from /dev.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    queue_builtin_action(mix_hwrng_into_linux_rng_action, <span style=color:#e6db74>&#34;mix_hwrng_into_linux_rng&#34;</span>);
</span></span><span style=display:flex><span>    queue_builtin_action(keychord_init_action, <span style=color:#e6db74>&#34;keychord_init&#34;</span>);
</span></span><span style=display:flex><span>    queue_builtin_action(console_init_action, <span style=color:#e6db74>&#34;console_init&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Trigger all the boot actions to get us started.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    action_for_each_trigger(<span style=color:#e6db74>&#34;init&#34;</span>, action_add_queue_tail);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Repeat mix_hwrng_into_linux_rng in case /dev/hw_random or /dev/random
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// wasn&#39;t ready immediately after wait_for_coldboot_done
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    queue_builtin_action(mix_hwrng_into_linux_rng_action, <span style=color:#e6db74>&#34;mix_hwrng_into_linux_rng&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Don&#39;t mount filesystems or start core system services in charger mode.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>char</span> bootmode[PROP_VALUE_MAX];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (property_get(<span style=color:#e6db74>&#34;ro.bootmode&#34;</span>, bootmode) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> strcmp(bootmode, <span style=color:#e6db74>&#34;charger&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        action_for_each_trigger(<span style=color:#e6db74>&#34;charger&#34;</span>, action_add_queue_tail);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        action_for_each_trigger(<span style=color:#e6db74>&#34;late-init&#34;</span>, action_add_queue_tail);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Run all property triggers based on current state of the properties.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    queue_builtin_action(queue_property_triggers_action, <span style=color:#e6db74>&#34;queue_property_triggers&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ****************** 第十三部分 ****************** 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>while</span> (true) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>waiting_for_exec) {
</span></span><span style=display:flex><span>            execute_one_command();
</span></span><span style=display:flex><span>            restart_processes();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> timeout <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (process_needs_restart) {
</span></span><span style=display:flex><span>            timeout <span style=color:#f92672>=</span> (process_needs_restart <span style=color:#f92672>-</span> gettime()) <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (timeout <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                timeout <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>action_queue_empty() <span style=color:#f92672>||</span> cur_action) {
</span></span><span style=display:flex><span>            timeout <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        bootchart_sample(<span style=color:#f92672>&amp;</span>timeout);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        epoll_event ev;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> nr <span style=color:#f92672>=</span> TEMP_FAILURE_RETRY(epoll_wait(epoll_fd, <span style=color:#f92672>&amp;</span>ev, <span style=color:#ae81ff>1</span>, timeout));
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (nr <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>            ERROR(<span style=color:#e6db74>&#34;epoll_wait failed: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, strerror(errno));
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (nr <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>            ((<span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>)()) ev.data.ptr)();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>signal_handler_init() todo？ 具体实现原理</li></ul><blockquote><p>每个进程在处理其他进程发送的signal信号时都需要先注册，当进程的运行状态改变或终止时会产生某种signal信号，init进程是所有用户空间进程的父进程，当其子进程终止时产生SIGCHLD信号，init进程调用信号安装函数sigaction()，传递参数给sigaction结构体，便完成信号处理的过程。</p><p>当init进程调用signal_handler_init后，一旦受到子进程终止带来的SIGCHLD消息后，将利用信号处理者SIGCHLD_handler向signal_write_fd写入信息；epoll句柄监听到signal_read_fd收到消息后，将调用handle_signal进行处理。</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>signal_handler_init</span>() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 在Linux中，父进程是通过捕捉SIGCHILD信号来得知子进程运行结束的情况
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Create a signalling mechanism for SIGCHLD.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> s[<span style=color:#ae81ff>2</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 利用socketpair创建出已经连接的两个socket，分别作为信号的读、写端
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (socketpair(AF_UNIX, SOCK_STREAM <span style=color:#f92672>|</span> SOCK_NONBLOCK <span style=color:#f92672>|</span> SOCK_CLOEXEC, <span style=color:#ae81ff>0</span>, s) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        ERROR(<span style=color:#e6db74>&#34;socketpair failed: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, strerror(errno));
</span></span><span style=display:flex><span>        exit(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    signal_write_fd <span style=color:#f92672>=</span> s[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>    signal_read_fd <span style=color:#f92672>=</span> s[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Write to signal_write_fd if we catch SIGCHLD.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>sigaction</span> act;
</span></span><span style=display:flex><span>    memset(<span style=color:#f92672>&amp;</span>act, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(act));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 信号处理器为SIGCHLD_handler，其被存在sigaction结构体重，负责处理SIGCHLD消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 信号处理器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    act.sa_handler <span style=color:#f92672>=</span> SIGCHLD_handler;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>// 仅当进程终止时才接受+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    act.sa_flags <span style=color:#f92672>=</span> SA_NOCLDSTOP;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>// 调用信号安装函数sigaction，将监听的信号及对应的信号处理器注册到内核中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    sigaction(SIGCHLD, <span style=color:#f92672>&amp;</span>act, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    reap_any_outstanding_children();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 定义在system/core/init/init.cpp中，注册epoll handler，当signal_read_fd 有数据可读时，调用handle_signal
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    register_epoll_handler(signal_read_fd, handle_signal);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=2-initrc-文件>2. init.rc 文件</h4><ul><li><a href=http://androidxref.com/6.0.1_r10/xref/system/core/rootdir/init.rc target=_blank rel="external nofollow noopener noreferrer">http://androidxref.com/6.0.1_r10/xref/system/core/rootdir/init.rc<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></li><li><a href=https://www.jianshu.com/p/cb73a88b0eed target=_blank rel="external nofollow noopener noreferrer">https://www.jianshu.com/p/cb73a88b0eed<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a> 解析</li></ul><h3 id=3-zygotehttpswwwjianshucomp4e5909d24d65>3. <a href=https://www.jianshu.com/p/4e5909d24d65 target=_blank rel="external nofollow noopener noreferrer">zygote<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></h3><blockquote><p>Linux的进程是通过系统调用fork产生的，fork出的子进程除了内核中的一些核心的数据结构和父进程不同之外，其余的内存映像都是和父进程共享的。只有当子进程需要去改写这些共享的内存时，操作系统才会为子进程分配一个新的页面，并将老的页面上的数据复制一份到新的页面，这就是所谓的"写拷贝"。</p><ul><li>Zygote创建应用程序时却只使用了fork，没有调用exec。Android应用中执行的是Java代码，Java代码的不同才造成了应用的区别，而对于运行Java的环境，要求却是一样的。</li><li>Zygote初始化时会创建创建虚拟机，同时把需要的系统类库和资源文件加载到内存里面。Zygote fork出子进程后，这个子进程也继承了能正常工作的虚拟机和各类系统资源，接下来子进程只需要装载APK文件的字节码文件就可以运行了。这样应用程序的启动时间就会大大缩短。</li></ul></blockquote><p><img class=lazyload src=/liudongdong1.github.io/svg/loading.min.svg data-src=https://gitee.com/github-25970295/blogimgv2022/raw/master/webp-166919953084124.webp data-srcset="https://gitee.com/github-25970295/blogimgv2022/raw/master/webp-166919953084124.webp, https://gitee.com/github-25970295/blogimgv2022/raw/master/webp-166919953084124.webp 1.5x, https://gitee.com/github-25970295/blogimgv2022/raw/master/webp-166919953084124.webp 2x" data-sizes=auto alt=img title=img></p><ul><li>具体代码解析 todo？ 没有看懂</li></ul><p><img class=lazyload src=/liudongdong1.github.io/svg/loading.min.svg data-src=https://gitee.com/github-25970295/blogimgv2022/raw/master/5713484-27464477f2175cbb.png data-srcset="https://gitee.com/github-25970295/blogimgv2022/raw/master/5713484-27464477f2175cbb.png, https://gitee.com/github-25970295/blogimgv2022/raw/master/5713484-27464477f2175cbb.png 1.5x, https://gitee.com/github-25970295/blogimgv2022/raw/master/5713484-27464477f2175cbb.png 2x" data-sizes=auto alt=img title=img></p><h4 id=2-androidruntime>.2. AndroidRuntime</h4><ul><li>负责启动虚拟机以及Java线程。AndroidRuntime类是在一个进程中只有一个实例对象，并将其保存在全局变量gCurRuntime中。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>AndroidRuntime:<span style=color:#f92672>:</span>AndroidRuntime<span style=color:#f92672>(</span><span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> argBlockStart<span style=color:#f92672>,</span> <span style=color:#66d9ef>const</span> size_t argBlockLength<span style=color:#f92672>)</span> <span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        mExitWithoutCleanup<span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>        mArgBlockStart<span style=color:#f92672>(</span>argBlockStart<span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>        mArgBlockLength<span style=color:#f92672>(</span>argBlockLength<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    SkGraphics<span style=color:#f92672>::</span>Init<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// There is also a global font cache, but its budget is specified by
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// SK_DEFAULT_FONT_CACHE_COUNT_LIMIT and SK_DEFAULT_FONT_CACHE_LIMIT.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Pre-allocate enough space to hold a fair number of options.    
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    mOptions<span style=color:#f92672>.</span><span style=color:#a6e22e>setCapacity</span><span style=color:#f92672>(</span>20<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>assert</span><span style=color:#f92672>(</span>gCurRuntime <span style=color:#f92672>==</span> NULL<span style=color:#f92672>);</span>        <span style=color:#75715e>// one per process
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    gCurRuntime <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li><strong>SkGraphics::Init()</strong>: 这里主要是初始化skia图形系统。skia是google的第一个底层的图形、图像、动画、SVG、文本等多方面的图形图，是Android图形系统的引擎。skia作为第三方软件放在external目录下： external/skia/。后面附了一个skia结构图</li><li><strong>mOptions.setCapacity(20);</strong>：预先分配空间来存放传入虚拟机的参数</li><li><strong>gCurRuntime = this;</strong>：首先通过的断言判断gCurRuntime是否为空，保证只能被初始化一次</li></ul><p><img class=lazyload src=/liudongdong1.github.io/svg/loading.min.svg data-src=https://gitee.com/github-25970295/blogimgv2022/raw/master/webp-166920030983629.webp data-srcset="https://gitee.com/github-25970295/blogimgv2022/raw/master/webp-166920030983629.webp, https://gitee.com/github-25970295/blogimgv2022/raw/master/webp-166920030983629.webp 1.5x, https://gitee.com/github-25970295/blogimgv2022/raw/master/webp-166920030983629.webp 2x" data-sizes=auto alt=https://gitee.com/github-25970295/blogimgv2022/raw/master/webp-166920030983629.webp title=https://gitee.com/github-25970295/blogimgv2022/raw/master/webp-166920030983629.webp></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Start the Android runtime.  This involves starting the virtual machine
</span></span></span><span style=display:flex><span><span style=color:#75715e> * and calling the &#34;static void main(String[] args)&#34; method in the class
</span></span></span><span style=display:flex><span><span style=color:#75715e> * named by &#34;className&#34;.
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Passes the main function two arguments, the class name and the specified
</span></span></span><span style=display:flex><span><span style=color:#75715e> * options string.
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> AndroidRuntime<span style=color:#f92672>::</span>start(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> className, <span style=color:#66d9ef>const</span> Vector<span style=color:#f92672>&lt;</span>String8<span style=color:#f92672>&gt;&amp;</span> options, <span style=color:#66d9ef>bool</span> zygote)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>//******************* 第一部分**********************
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ALOGD(<span style=color:#e6db74>&#34;&gt;&gt;&gt;&gt;&gt;&gt; START %s uid %d &lt;&lt;&lt;&lt;&lt;&lt;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>            className <span style=color:#f92672>!=</span> NULL <span style=color:#f92672>?</span> className : <span style=color:#e6db74>&#34;(unknown)&#34;</span>, getuid());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>const</span> String8 <span style=color:#a6e22e>startSystemServer</span>(<span style=color:#e6db74>&#34;start-system-server&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * &#39;startSystemServer == true&#39; means runtime is obsolete and not run from
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * init.rc anymore, so we print out the boot start event here.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (size_t i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> options.size(); <span style=color:#f92672>++</span>i) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (options[i] <span style=color:#f92672>==</span> startSystemServer) {
</span></span><span style=display:flex><span>           <span style=color:#75715e>/* track our progress through the boot sequence */</span>
</span></span><span style=display:flex><span>           <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>int</span> LOG_BOOT_PROGRESS_START <span style=color:#f92672>=</span> <span style=color:#ae81ff>3000</span>;
</span></span><span style=display:flex><span>           LOG_EVENT_LONG(LOG_BOOT_PROGRESS_START,  ns2ms(systemTime(SYSTEM_TIME_MONOTONIC)));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>//******************* 第二部分**********************
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> rootDir <span style=color:#f92672>=</span> getenv(<span style=color:#e6db74>&#34;ANDROID_ROOT&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (rootDir <span style=color:#f92672>==</span> NULL) {
</span></span><span style=display:flex><span>        rootDir <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/system&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>hasDir(<span style=color:#e6db74>&#34;/system&#34;</span>)) {
</span></span><span style=display:flex><span>            LOG_FATAL(<span style=color:#e6db74>&#34;No root directory specified, and /android does not exist.&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        setenv(<span style=color:#e6db74>&#34;ANDROID_ROOT&#34;</span>, rootDir, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//const char* kernelHack = getenv(&#34;LD_ASSUME_KERNEL&#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//ALOGD(&#34;Found LD_ASSUME_KERNEL=&#39;%s&#39;\n&#34;, kernelHack);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//******************* 第三部分**********************
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>/* start the virtual machine */</span>
</span></span><span style=display:flex><span>    JniInvocation jni_invocation;
</span></span><span style=display:flex><span>    jni_invocation.Init(NULL);
</span></span><span style=display:flex><span>    JNIEnv<span style=color:#f92672>*</span> env;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (startVm(<span style=color:#f92672>&amp;</span>mJavaVM, <span style=color:#f92672>&amp;</span>env, zygote) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//******************* 第四部分**********************
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    onVmCreated(env);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//******************* 第五部分**********************
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Register android functions.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (startReg(env) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        ALOGE(<span style=color:#e6db74>&#34;Unable to register all android natives</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#75715e>//******************* 第六部分**********************
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * We want to call main() with a String array with arguments in it.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * At present we have two arguments, the class name and an option string.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Create an array to hold them.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    jclass stringClass;
</span></span><span style=display:flex><span>    jobjectArray strArray;
</span></span><span style=display:flex><span>    jstring classNameStr;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    stringClass <span style=color:#f92672>=</span> env<span style=color:#f92672>-&gt;</span>FindClass(<span style=color:#e6db74>&#34;java/lang/String&#34;</span>);
</span></span><span style=display:flex><span>    assert(stringClass <span style=color:#f92672>!=</span> NULL);
</span></span><span style=display:flex><span>    strArray <span style=color:#f92672>=</span> env<span style=color:#f92672>-&gt;</span>NewObjectArray(options.size() <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, stringClass, NULL);
</span></span><span style=display:flex><span>    assert(strArray <span style=color:#f92672>!=</span> NULL);
</span></span><span style=display:flex><span>    classNameStr <span style=color:#f92672>=</span> env<span style=color:#f92672>-&gt;</span>NewStringUTF(className);
</span></span><span style=display:flex><span>    assert(classNameStr <span style=color:#f92672>!=</span> NULL);
</span></span><span style=display:flex><span>    env<span style=color:#f92672>-&gt;</span>SetObjectArrayElement(strArray, <span style=color:#ae81ff>0</span>, classNameStr);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (size_t i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> options.size(); <span style=color:#f92672>++</span>i) {
</span></span><span style=display:flex><span>        jstring optionsStr <span style=color:#f92672>=</span> env<span style=color:#f92672>-&gt;</span>NewStringUTF(options.itemAt(i).string());
</span></span><span style=display:flex><span>        assert(optionsStr <span style=color:#f92672>!=</span> NULL);
</span></span><span style=display:flex><span>        env<span style=color:#f92672>-&gt;</span>SetObjectArrayElement(strArray, i <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, optionsStr);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#75715e>//******************* 第七部分**********************
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Start VM.  This thread becomes the main thread of the VM, and will
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * not return until the VM exits.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> slashClassName <span style=color:#f92672>=</span> toSlashClassName(className);
</span></span><span style=display:flex><span>    jclass startClass <span style=color:#f92672>=</span> env<span style=color:#f92672>-&gt;</span>FindClass(slashClassName);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (startClass <span style=color:#f92672>==</span> NULL) {
</span></span><span style=display:flex><span>        ALOGE(<span style=color:#e6db74>&#34;JavaVM unable to locate class &#39;%s&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, slashClassName);
</span></span><span style=display:flex><span>        <span style=color:#75715e>/* keep going */</span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        jmethodID startMeth <span style=color:#f92672>=</span> env<span style=color:#f92672>-&gt;</span>GetStaticMethodID(startClass, <span style=color:#e6db74>&#34;main&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;([Ljava/lang/String;)V&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (startMeth <span style=color:#f92672>==</span> NULL) {
</span></span><span style=display:flex><span>            ALOGE(<span style=color:#e6db74>&#34;JavaVM unable to find main() in &#39;%s&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, className);
</span></span><span style=display:flex><span>            <span style=color:#75715e>/* keep going */</span>
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            env<span style=color:#f92672>-&gt;</span>CallStaticVoidMethod(startClass, startMeth, strArray);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#if 0</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>            if (env-&gt;ExceptionCheck())
</span></span></span><span style=display:flex><span><span style=color:#75715e>                threadExitUncaughtException(env);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    free(slashClassName);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ALOGD(<span style=color:#e6db74>&#34;Shutting down VM</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (mJavaVM<span style=color:#f92672>-&gt;</span>DetachCurrentThread() <span style=color:#f92672>!=</span> JNI_OK)
</span></span><span style=display:flex><span>        ALOGW(<span style=color:#e6db74>&#34;Warning: unable to detach main thread</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (mJavaVM<span style=color:#f92672>-&gt;</span>DestroyJavaVM() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        ALOGW(<span style=color:#e6db74>&#34;Warning: VM did not shut down cleanly</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=3-java-层-zygoteinit>3. Java 层 ZygoteInit</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String argv<span style=color:#f92672>[])</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//**************** 第一阶段 **********************
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 启动DDMS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        RuntimeInit<span style=color:#f92672>.</span><span style=color:#a6e22e>enableDdms</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Start profiling the zygote initialization.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 启动性能统计 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        SamplingProfilerIntegration<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> startSystemServer <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        String socketName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;zygote&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        String abiList <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 1<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> argv<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;start-system-server&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>argv<span style=color:#f92672>[</span>i<span style=color:#f92672>]))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                startSystemServer <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>argv<span style=color:#f92672>[</span>i<span style=color:#f92672>].</span><span style=color:#a6e22e>startsWith</span><span style=color:#f92672>(</span>ABI_LIST_ARG<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                abiList <span style=color:#f92672>=</span> argv<span style=color:#f92672>[</span>i<span style=color:#f92672>].</span><span style=color:#a6e22e>substring</span><span style=color:#f92672>(</span>ABI_LIST_ARG<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>argv<span style=color:#f92672>[</span>i<span style=color:#f92672>].</span><span style=color:#a6e22e>startsWith</span><span style=color:#f92672>(</span>SOCKET_NAME_ARG<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                socketName <span style=color:#f92672>=</span> argv<span style=color:#f92672>[</span>i<span style=color:#f92672>].</span><span style=color:#a6e22e>substring</span><span style=color:#f92672>(</span>SOCKET_NAME_ARG<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Unknown command line argument: &#34;</span> <span style=color:#f92672>+</span> argv<span style=color:#f92672>[</span>i<span style=color:#f92672>]);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>abiList <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;No ABI list supplied.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//**************** 第二阶段 **********************
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        registerZygoteSocket<span style=color:#f92672>(</span>socketName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        EventLog<span style=color:#f92672>.</span><span style=color:#a6e22e>writeEvent</span><span style=color:#f92672>(</span>LOG_BOOT_PROGRESS_PRELOAD_START<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            SystemClock<span style=color:#f92672>.</span><span style=color:#a6e22e>uptimeMillis</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//**************** 第三阶段 **********************
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        preload<span style=color:#f92672>();</span>  <span style=color:#75715e>//系统预加载类、Framework资源和openGL的资源
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        EventLog<span style=color:#f92672>.</span><span style=color:#a6e22e>writeEvent</span><span style=color:#f92672>(</span>LOG_BOOT_PROGRESS_PRELOAD_END<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            SystemClock<span style=color:#f92672>.</span><span style=color:#a6e22e>uptimeMillis</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Finish profiling the zygote initialization.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        SamplingProfilerIntegration<span style=color:#f92672>.</span><span style=color:#a6e22e>writeZygoteSnapshot</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Do an initial gc to clean up after startup
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        gcAndFinalize<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Disable tracing so that forked processes do not inherit stale tracing tags from
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// Zygote.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>setTracingEnabled</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//**************** 第四阶段 **********************
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>startSystemServer<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            startSystemServer<span style=color:#f92672>(</span>abiList<span style=color:#f92672>,</span> socketName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>i</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Accepting command socket connections&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//**************** 第五阶段 **********************
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        runSelectLoop<span style=color:#f92672>(</span>abiList<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        closeServerSocket<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>MethodAndArgsCaller caller<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        caller<span style=color:#f92672>.</span><span style=color:#a6e22e>run</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RuntimeException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Log<span style=color:#f92672>.</span><span style=color:#a6e22e>e</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Zygote died with exception&#34;</span><span style=color:#f92672>,</span> ex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        closeServerSocket<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> ex<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h5 id=runselectloop>runSelectLoop</h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>654    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>655     * Runs the zygote process&#39;s select loop. Accepts new connections as
</span></span></span><span style=display:flex><span><span style=color:#75715e>656     * they happen, and reads commands from connections one spawn-request&#39;s
</span></span></span><span style=display:flex><span><span style=color:#75715e>657     * worth at a time.
</span></span></span><span style=display:flex><span><span style=color:#75715e>658     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>659     * @throws MethodAndArgsCaller in a child process when a main() should
</span></span></span><span style=display:flex><span><span style=color:#75715e>660     * be executed.
</span></span></span><span style=display:flex><span><span style=color:#75715e>661     */</span>
</span></span><span style=display:flex><span>662    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>runSelectLoop</span><span style=color:#f92672>(</span>String abiList<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> MethodAndArgsCaller <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>663        ArrayList<span style=color:#f92672>&lt;</span>FileDescriptor<span style=color:#f92672>&gt;</span> fds <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;</span>FileDescriptor<span style=color:#f92672>&gt;();</span>
</span></span><span style=display:flex><span>664        ArrayList<span style=color:#f92672>&lt;</span>ZygoteConnection<span style=color:#f92672>&gt;</span> peers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;</span>ZygoteConnection<span style=color:#f92672>&gt;();</span>
</span></span><span style=display:flex><span>665
</span></span><span style=display:flex><span>          <span style=color:#75715e>//fds[0]为sServerSocket，即sServerSocket为位于zygote进程中的socket服务端
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>666        fds<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>sServerSocket<span style=color:#f92672>.</span><span style=color:#a6e22e>getFileDescriptor</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>667        peers<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>668
</span></span><span style=display:flex><span>669        <span style=color:#a6e22e>while</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//************************** 第1部分   ************************** 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>670            StructPollfd<span style=color:#f92672>[]</span> pollFds <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StructPollfd<span style=color:#f92672>[</span>fds<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>()];</span>
</span></span><span style=display:flex><span>671            <span style=color:#a6e22e>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> pollFds<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span> <span style=color:#f92672>++</span>i<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>672                pollFds<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StructPollfd<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                   <span style=color:#75715e>// pollFds[0].fd即为sServerSocket，位于zygote进程中的socket服务端。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>673                pollFds<span style=color:#f92672>[</span>i<span style=color:#f92672>].</span><span style=color:#a6e22e>fd</span> <span style=color:#f92672>=</span> fds<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>i<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>674                pollFds<span style=color:#f92672>[</span>i<span style=color:#f92672>].</span><span style=color:#a6e22e>events</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>short</span><span style=color:#f92672>)</span> POLLIN<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>675            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>676            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                   <span style=color:#75715e>// 查询轮训状态，当pollFdd有事件到来则往下执行，否则阻塞在这里
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>677                Os<span style=color:#f92672>.</span><span style=color:#a6e22e>poll</span><span style=color:#f92672>(</span>pollFds<span style=color:#f92672>,</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>678            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>ErrnoException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>679                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>RuntimeException</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;poll failed&#34;</span><span style=color:#f92672>,</span> ex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>680            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>681            <span style=color:#a6e22e>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> pollFds<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> 1<span style=color:#f92672>;</span> i <span style=color:#f92672>&gt;=</span> 0<span style=color:#f92672>;</span> <span style=color:#f92672>--</span>i<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                 <span style=color:#75715e>// 采用I/O 多路复用机制，当接受到客户端发出的连接请求，或者处理出具时，则往下执行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                 <span style=color:#75715e>// 否则进入continue，跳出本次循环 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>682                <span style=color:#a6e22e>if</span> <span style=color:#f92672>((</span>pollFds<span style=color:#f92672>[</span>i<span style=color:#f92672>].</span><span style=color:#a6e22e>revents</span> <span style=color:#f92672>&amp;</span> POLLIN<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>683                    <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>684                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//************************** 第2部分   **************************
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>685                <span style=color:#a6e22e>if</span> <span style=color:#f92672>(</span>i <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                      <span style=color:#75715e>// 客户端第一次请求服务端，服务端调用accept与客户端建立连接，客户端在zygote以ZygoteConnection对象表示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>686                    ZygoteConnection newPeer <span style=color:#f92672>=</span> acceptCommandPeer<span style=color:#f92672>(</span>abiList<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>687                    peers<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>newPeer<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>688                    fds<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>newPeer<span style=color:#f92672>.</span><span style=color:#a6e22e>getFileDesciptor</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>689                <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//*************************** 第3部分   **************************
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                      <span style=color:#75715e>// 经过上个if操作后，客户端与服务端已经建立连接，并开始发送数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                      <span style=color:#75715e>//peers.get(index)取得发送数据客户端的ZygoteConnection对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                      <span style=color:#75715e>// 然后调用runOnce()方法来出具具体请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>690                    <span style=color:#66d9ef>boolean</span> done <span style=color:#f92672>=</span> peers<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>i<span style=color:#f92672>).</span><span style=color:#a6e22e>runOnce</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>691                    <span style=color:#a6e22e>if</span> <span style=color:#f92672>(</span>done<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>692                        peers<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>(</span>i<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                           <span style=color:#75715e>// 处理完则从fds中移除该文件描述符
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>693                        fds<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>(</span>i<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>694                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>695                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>696            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>697        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>698    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=4-systemservice>4. SystemService</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>176    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>177        <span style=color:#75715e>// If a device&#39;s clock is before 1970 (before 0), a lot of
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>178        <span style=color:#75715e>// APIs crash dealing with negative numbers, notably
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>179        <span style=color:#75715e>// java.io.File#setLastModified, so instead we fake it and
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>180        <span style=color:#75715e>// hope that time from cell towers or NTP fixes it shortly.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>           <span style=color:#75715e>// 计算时间 如果当前系统时间比1970年更早，就设置当前系统时间为1970年
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>181        <span style=color:#a6e22e>if</span> <span style=color:#f92672>(</span>System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>()</span> <span style=color:#f92672>&lt;</span> EARLIEST_SUPPORTED_TIME<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>182            Slog<span style=color:#f92672>.</span><span style=color:#a6e22e>w</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;System clock is before 1970; setting to 1970.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>183            SystemClock<span style=color:#f92672>.</span><span style=color:#a6e22e>setCurrentTimeMillis</span><span style=color:#f92672>(</span>EARLIEST_SUPPORTED_TIME<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>184        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>185
</span></span><span style=display:flex><span>186        <span style=color:#75715e>// If the system has &#34;persist.sys.language&#34; and friends set, replace them with
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>187        <span style=color:#75715e>// &#34;persist.sys.locale&#34;. Note that the default locale at this point is calculated
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>188        <span style=color:#75715e>// using the &#34;-Duser.locale&#34; command line flag. That flag is usually populated by
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>189        <span style=color:#75715e>// AndroidRuntime using the same set of system properties, but only the system_server
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>190        <span style=color:#75715e>// and system apps are allowed to set them.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>191        <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>192        <span style=color:#75715e>// NOTE: Most changes made here will need an equivalent change to
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>193        <span style=color:#75715e>// core/jni/AndroidRuntime.cpp
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>           <span style=color:#75715e>// 如果没有设置 语言，则设置当地的语言
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>194        <span style=color:#a6e22e>if</span> <span style=color:#f92672>(!</span>SystemProperties<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;persist.sys.language&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>195            <span style=color:#66d9ef>final</span> String languageTag <span style=color:#f92672>=</span> Locale<span style=color:#f92672>.</span><span style=color:#a6e22e>getDefault</span><span style=color:#f92672>().</span><span style=color:#a6e22e>toLanguageTag</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>196
</span></span><span style=display:flex><span>197            SystemProperties<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;persist.sys.locale&#34;</span><span style=color:#f92672>,</span> languageTag<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>198            SystemProperties<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;persist.sys.language&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>199            SystemProperties<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;persist.sys.country&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>200            SystemProperties<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;persist.sys.localevar&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>201        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>202
</span></span><span style=display:flex><span>203        <span style=color:#75715e>// Here we go!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>204        Slog<span style=color:#f92672>.</span><span style=color:#a6e22e>i</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Entered the Android system server!&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>205        EventLog<span style=color:#f92672>.</span><span style=color:#a6e22e>writeEvent</span><span style=color:#f92672>(</span>EventLogTags<span style=color:#f92672>.</span><span style=color:#a6e22e>BOOT_PROGRESS_SYSTEM_RUN</span><span style=color:#f92672>,</span> SystemClock<span style=color:#f92672>.</span><span style=color:#a6e22e>uptimeMillis</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>206
</span></span><span style=display:flex><span>207        <span style=color:#75715e>// In case the runtime switched since last boot (such as when
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>208        <span style=color:#75715e>// the old runtime was removed in an OTA), set the system
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>209        <span style=color:#75715e>// property so that it is in sync. We can&#39;t do this in
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>210        <span style=color:#75715e>// libnativehelper&#39;s JniInvocation::Init code where we already
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>211        <span style=color:#75715e>// had to fallback to a different runtime because it is
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>212        <span style=color:#75715e>// running as root and we need to be the system user to set
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>213        <span style=color:#75715e>// the property. http://b/11463182
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 设置虚拟机库文件路径，5.0以后是libart.so
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>214        SystemProperties<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;persist.sys.dalvik.vm.lib.2&#34;</span><span style=color:#f92672>,</span> VMRuntime<span style=color:#f92672>.</span><span style=color:#a6e22e>getRuntime</span><span style=color:#f92672>().</span><span style=color:#a6e22e>vmLibrary</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>215
</span></span><span style=display:flex><span>216        <span style=color:#75715e>// Enable the sampling profiler.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>           <span style=color:#75715e>// 如果开启了性能分析标志，则开启性能分析
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>217        <span style=color:#a6e22e>if</span> <span style=color:#f92672>(</span>SamplingProfilerIntegration<span style=color:#f92672>.</span><span style=color:#a6e22e>isEnabled</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>218            SamplingProfilerIntegration<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>219            mProfilerSnapshotTimer <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Timer<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>220            mProfilerSnapshotTimer<span style=color:#f92672>.</span><span style=color:#a6e22e>schedule</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> TimerTask<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>221                <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>222                <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>223                    SamplingProfilerIntegration<span style=color:#f92672>.</span><span style=color:#a6e22e>writeSnapshot</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;system_server&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>224                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>225            <span style=color:#f92672>},</span> SNAPSHOT_INTERVAL<span style=color:#f92672>,</span> SNAPSHOT_INTERVAL<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>226        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>227
</span></span><span style=display:flex><span>228        <span style=color:#75715e>// Mmmmmm... more memory!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          <span style=color:#75715e>// 清楚VM内存增长上线，由于启动过程需要较多的虚拟机内存空间
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>229        VMRuntime<span style=color:#f92672>.</span><span style=color:#a6e22e>getRuntime</span><span style=color:#f92672>().</span><span style=color:#a6e22e>clearGrowthLimit</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>230
</span></span><span style=display:flex><span>231        <span style=color:#75715e>// The system server has to run all of the time, so it needs to be
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>232        <span style=color:#75715e>// as efficient as possible with its memory usage.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>           <span style=color:#75715e>// 设置内存可能有效使用率为0.8
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>233        VMRuntime<span style=color:#f92672>.</span><span style=color:#a6e22e>getRuntime</span><span style=color:#f92672>().</span><span style=color:#a6e22e>setTargetHeapUtilization</span><span style=color:#f92672>(</span>0<span style=color:#f92672>.</span><span style=color:#a6e22e>8f</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>234
</span></span><span style=display:flex><span>235        <span style=color:#75715e>// Some devices rely on runtime fingerprint generation, so make sure
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>236        <span style=color:#75715e>// we&#39;ve defined it before booting further.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>           <span style=color:#75715e>// 针对部分设备依赖运行时就产生指纹信息，因此需要在开机完成前已经定义
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>237        Build<span style=color:#f92672>.</span><span style=color:#a6e22e>ensureFingerprintProperty</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>238
</span></span><span style=display:flex><span>239        <span style=color:#75715e>// Within the system server, it is an error to access Environment paths without
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>240        <span style=color:#75715e>// explicitly specifying a user.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>           <span style=color:#75715e>// 设置访问环境变量的条件，即需要明确指定用户
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>241        Environment<span style=color:#f92672>.</span><span style=color:#a6e22e>setUserRequired</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>242
</span></span><span style=display:flex><span>243        <span style=color:#75715e>// Ensure binder calls into the system always run at foreground priority.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>           <span style=color:#75715e>//确保当前系统进程的binder调用，总是运行在前台优先级(foreground)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>244        BinderInternal<span style=color:#f92672>.</span><span style=color:#a6e22e>disableBackgroundScheduling</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>245
</span></span><span style=display:flex><span>246        <span style=color:#75715e>// Prepare the main looper thread (this thread).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>247        android<span style=color:#f92672>.</span><span style=color:#a6e22e>os</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Process</span><span style=color:#f92672>.</span><span style=color:#a6e22e>setThreadPriority</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>248                android<span style=color:#f92672>.</span><span style=color:#a6e22e>os</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Process</span><span style=color:#f92672>.</span><span style=color:#a6e22e>THREAD_PRIORITY_FOREGROUND</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>249        android<span style=color:#f92672>.</span><span style=color:#a6e22e>os</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Process</span><span style=color:#f92672>.</span><span style=color:#a6e22e>setCanSelfBackground</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>           <span style=color:#75715e>// 主线程Looper就在当前线程运行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>250        Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>prepareMainLooper</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>251
</span></span><span style=display:flex><span>           <span style=color:#75715e>// 加载“android_servers.so”库，该库包含源码在frameworks/base/services/目录下
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>252        <span style=color:#75715e>// Initialize native services.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>253        System<span style=color:#f92672>.</span><span style=color:#a6e22e>loadLibrary</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;android_servers&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>254
</span></span><span style=display:flex><span>255        <span style=color:#75715e>// Check whether we failed to shut down last time we tried.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>256        <span style=color:#75715e>// This call may not return.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>           <span style=color:#75715e>//检查上次关键是否失败了，可能没有返回值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>257        <span style=color:#a6e22e>performPendingShutdown</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>258
</span></span><span style=display:flex><span>259        <span style=color:#75715e>// Initialize the system context.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>           <span style=color:#75715e>// 初始化系统上下文
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>260        <span style=color:#a6e22e>createSystemContext</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>261
</span></span><span style=display:flex><span>262        <span style=color:#75715e>// Create the system service manager.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>           <span style=color:#75715e>// 创建SystemServiceManager 用于后面的binder机制
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>263        mSystemServiceManager <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SystemServiceManager<span style=color:#f92672>(</span>mSystemContext<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>264        LocalServices<span style=color:#f92672>.</span><span style=color:#a6e22e>addService</span><span style=color:#f92672>(</span>SystemServiceManager<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> mSystemServiceManager<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>265
</span></span><span style=display:flex><span>266        <span style=color:#75715e>// Start services.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>           <span style=color:#75715e>//启动各种系统服务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>267        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>268            <span style=color:#a6e22e>startBootstrapServices</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>269            <span style=color:#a6e22e>startCoreServices</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>270            <span style=color:#a6e22e>startOtherServices</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>271        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>272            Slog<span style=color:#f92672>.</span><span style=color:#a6e22e>e</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;System&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;******************************************&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>273            Slog<span style=color:#f92672>.</span><span style=color:#a6e22e>e</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;System&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;************ Failure starting system services&#34;</span><span style=color:#f92672>,</span> ex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>274            <span style=color:#66d9ef>throw</span> ex<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>275        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>276
</span></span><span style=display:flex><span>277        <span style=color:#75715e>// For debug builds, log event loop stalls to dropbox for analysis.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>           <span style=color:#75715e>// 如果是debug版本，为了方便分析，将log事件不断循环地输出到dropbox
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>278        <span style=color:#a6e22e>if</span> <span style=color:#f92672>(</span>StrictMode<span style=color:#f92672>.</span><span style=color:#a6e22e>conditionallyEnableDebugLogging</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>279            Slog<span style=color:#f92672>.</span><span style=color:#a6e22e>i</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Enabled StrictMode for system server main thread.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>280        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>281
</span></span><span style=display:flex><span>282        <span style=color:#75715e>// Loop forever.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>           <span style=color:#75715e>// 主进程的looper开启死循环
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>283        Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>loop</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>284        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>RuntimeException</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Main thread loop unexpectedly exited&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>285    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=createsystemcontext>createSystemContext</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>09    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>createSystemContext</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>              <span style=color:#75715e>// 获取ActivityThread对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>310        ActivityThread activityThread <span style=color:#f92672>=</span> ActivityThread<span style=color:#f92672>.</span><span style=color:#a6e22e>systemMain</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>              <span style=color:#75715e>// 获取系统的Context
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>311        mSystemContext <span style=color:#f92672>=</span> activityThread<span style=color:#f92672>.</span><span style=color:#a6e22e>getSystemContext</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>           <span style=color:#75715e>// 设置主题
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>312        mSystemContext<span style=color:#f92672>.</span><span style=color:#a6e22e>setTheme</span><span style=color:#f92672>(</span>android<span style=color:#f92672>.</span><span style=color:#a6e22e>R</span><span style=color:#f92672>.</span><span style=color:#a6e22e>style</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Theme_DeviceDefault_Light_DarkActionBar</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>313    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=addservice>addService</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>49    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>50     * Adds a service instance of the specified interface to the global registry of local services.
</span></span></span><span style=display:flex><span><span style=color:#75715e>51     */</span>
</span></span><span style=display:flex><span>52    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>addService</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> type<span style=color:#f92672>,</span> T service<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>53        <span style=color:#a6e22e>synchronized</span> <span style=color:#f92672>(</span>sLocalServiceObjects<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>54            <span style=color:#a6e22e>if</span> <span style=color:#f92672>(</span>sLocalServiceObjects<span style=color:#f92672>.</span><span style=color:#a6e22e>containsKey</span><span style=color:#f92672>(</span>type<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>55                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>IllegalStateException</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Overriding service registration&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>56            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>57            sLocalServiceObjects<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>type<span style=color:#f92672>,</span> service<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>58        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>59    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=startbootstrapservices>startBootstrapServices</h4><ul><li>ActivityManagerService, PowerManagerService, LightsService, DisplayManagerService, PackageManagerService, UserManagerService, sensor服务</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>316     * Starts the small tangle of critical services that are needed to get
</span></span></span><span style=display:flex><span><span style=color:#75715e>317     * the system off the ground.  These services have complex mutual dependencies
</span></span></span><span style=display:flex><span><span style=color:#75715e>318     * which is why we initialize them all in one place here.  Unless your service
</span></span></span><span style=display:flex><span><span style=color:#75715e>319     * is also entwined in these dependencies, it should be initialized in one of
</span></span></span><span style=display:flex><span><span style=color:#75715e>320     * the other functions.
</span></span></span><span style=display:flex><span><span style=color:#75715e>321     */</span>
</span></span><span style=display:flex><span>322    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>startBootstrapServices</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>323        <span style=color:#75715e>// Wait for installd to finish starting up so that it has a chance to
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>324        <span style=color:#75715e>// create critical directories such as /data/user with the appropriate
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>325        <span style=color:#75715e>// permissions.  We need this to complete before we initialize other services.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>           <span style=color:#75715e>// 阻塞等待与installd建立socket通道
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>326        Installer installer <span style=color:#f92672>=</span> mSystemServiceManager<span style=color:#f92672>.</span><span style=color:#a6e22e>startService</span><span style=color:#f92672>(</span>Installer<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>327
</span></span><span style=display:flex><span>328        <span style=color:#75715e>// Activity manager runs the show.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>           <span style=color:#75715e>//创建AMS(ActivityManagerService)，并启动
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>329        mActivityManagerService <span style=color:#f92672>=</span> mSystemServiceManager<span style=color:#f92672>.</span><span style=color:#a6e22e>startService</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>330                ActivityManagerService<span style=color:#f92672>.</span><span style=color:#a6e22e>Lifecycle</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>).</span><span style=color:#a6e22e>getService</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>331        mActivityManagerService<span style=color:#f92672>.</span><span style=color:#a6e22e>setSystemServiceManager</span><span style=color:#f92672>(</span>mSystemServiceManager<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>332        mActivityManagerService<span style=color:#f92672>.</span><span style=color:#a6e22e>setInstaller</span><span style=color:#f92672>(</span>installer<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>333
</span></span><span style=display:flex><span>334        <span style=color:#75715e>// Power manager needs to be started early because other services need it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>335        <span style=color:#75715e>// Native daemons may be watching for it to be registered so it must be ready
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>336        <span style=color:#75715e>// to handle incoming binder calls immediately (including being able to verify
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>337        <span style=color:#75715e>// the permissions for those calls).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>           <span style=color:#75715e>// 启动电源管理服务，即PowerManagerService
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>338        mPowerManagerService <span style=color:#f92672>=</span> mSystemServiceManager<span style=color:#f92672>.</span><span style=color:#a6e22e>startService</span><span style=color:#f92672>(</span>PowerManagerService<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>339
</span></span><span style=display:flex><span>340        <span style=color:#75715e>// Now that the power manager has been started, let the activity manager
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>341        <span style=color:#75715e>// initialize power management features.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>           <span style=color:#75715e>// mActivityManagerService初始化，并在其中初始化PowerManager
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>342        mActivityManagerService<span style=color:#f92672>.</span><span style=color:#a6e22e>initPowerManagement</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>343
</span></span><span style=display:flex><span>344        <span style=color:#75715e>// Manages LEDs and display backlight so we need it to bring up the display.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>           <span style=color:#75715e>// 开启服务LightsService，即灯光服务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>345        mSystemServiceManager<span style=color:#f92672>.</span><span style=color:#a6e22e>startService</span><span style=color:#f92672>(</span>LightsService<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>346
</span></span><span style=display:flex><span>347        <span style=color:#75715e>// Display manager is needed to provide display metrics before package manager
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>348        <span style=color:#75715e>// starts up.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>           <span style=color:#75715e>// 开启服务DisplayManagerService，显示服务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>349        mDisplayManagerService <span style=color:#f92672>=</span> mSystemServiceManager<span style=color:#f92672>.</span><span style=color:#a6e22e>startService</span><span style=color:#f92672>(</span>DisplayManagerService<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>350
</span></span><span style=display:flex><span>351        <span style=color:#75715e>// We need the default display before we can initialize the package manager.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>           <span style=color:#75715e>// 在初始化package manager之前，需要默认的显示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>352        mSystemServiceManager<span style=color:#f92672>.</span><span style=color:#a6e22e>startBootPhase</span><span style=color:#f92672>(</span>SystemService<span style=color:#f92672>.</span><span style=color:#a6e22e>PHASE_WAIT_FOR_DEFAULT_DISPLAY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>353
</span></span><span style=display:flex><span>354        <span style=color:#75715e>// Only run &#34;core&#34; apps if we&#39;re encrypting the device.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>           <span style=color:#75715e>// 根据加密设备状态，决定mOnlyCore的值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>355        String cryptState <span style=color:#f92672>=</span> SystemProperties<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;vold.decrypt&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>356        <span style=color:#a6e22e>if</span> <span style=color:#f92672>(</span>ENCRYPTING_STATE<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>cryptState<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>357            Slog<span style=color:#f92672>.</span><span style=color:#a6e22e>w</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Detected encryption in progress - only parsing core apps&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>358            mOnlyCore <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>359        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ENCRYPTED_STATE<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>cryptState<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>360            Slog<span style=color:#f92672>.</span><span style=color:#a6e22e>w</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Device encrypted - only parsing core apps&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>361            mOnlyCore <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>362        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>363
</span></span><span style=display:flex><span>364        <span style=color:#75715e>// Start the package manager.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>365        Slog<span style=color:#f92672>.</span><span style=color:#a6e22e>i</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Package Manager&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>           <span style=color:#75715e>// 启动服务PackageManagerService 即包管理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>366        mPackageManagerService <span style=color:#f92672>=</span> PackageManagerService<span style=color:#f92672>.</span><span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>mSystemContext<span style=color:#f92672>,</span> installer<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>367                mFactoryTestMode <span style=color:#f92672>!=</span> FactoryTest<span style=color:#f92672>.</span><span style=color:#a6e22e>FACTORY_TEST_OFF</span><span style=color:#f92672>,</span> mOnlyCore<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>368        mFirstBoot <span style=color:#f92672>=</span> mPackageManagerService<span style=color:#f92672>.</span><span style=color:#a6e22e>isFirstBoot</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>369        mPackageManager <span style=color:#f92672>=</span> mSystemContext<span style=color:#f92672>.</span><span style=color:#a6e22e>getPackageManager</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>370
</span></span><span style=display:flex><span>371        Slog<span style=color:#f92672>.</span><span style=color:#a6e22e>i</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;User Service&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>           <span style=color:#75715e>// 启动UserManagerService，即用户服务，新建目录“/data/user/”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>372        ServiceManager<span style=color:#f92672>.</span><span style=color:#a6e22e>addService</span><span style=color:#f92672>(</span>Context<span style=color:#f92672>.</span><span style=color:#a6e22e>USER_SERVICE</span><span style=color:#f92672>,</span> UserManagerService<span style=color:#f92672>.</span><span style=color:#a6e22e>getInstance</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>373
</span></span><span style=display:flex><span>374        <span style=color:#75715e>// Initialize attribute cache used to cache resources from packages.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>375        AttributeCache<span style=color:#f92672>.</span><span style=color:#a6e22e>init</span><span style=color:#f92672>(</span>mSystemContext<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>376
</span></span><span style=display:flex><span>377        <span style=color:#75715e>// Set up the Application instance for the system process and get started.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>           <span style=color:#75715e>// 设置AMS，这样SystemServer进程可以加入到AMS中，冰杯它管理。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>378        mActivityManagerService<span style=color:#f92672>.</span><span style=color:#a6e22e>setSystemProcess</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>379
</span></span><span style=display:flex><span>380        <span style=color:#75715e>// The sensor service needs access to package manager service, app ops
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>381        <span style=color:#75715e>// service, and permissions service, therefore we start it after them.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//启动传感器服务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>             <span style=color:#75715e>//开启传感器服务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>382        <span style=color:#a6e22e>startSensorService</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>383    <span style=color:#f92672>}</span> 
</span></span></code></pre></div><h4 id=startcoreservices>startCoreServices</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>385    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>386     * Starts some essential services that are not tangled up in the bootstrap process.
</span></span></span><span style=display:flex><span><span style=color:#75715e>387     */</span>
</span></span><span style=display:flex><span>388    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>startCoreServices</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>389        <span style=color:#75715e>// Tracks the battery level.  Requires LightService.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          <span style=color:#75715e>// 启动服务BatteryService，用于统计电池量量
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>390        mSystemServiceManager<span style=color:#f92672>.</span><span style=color:#a6e22e>startService</span><span style=color:#f92672>(</span>BatteryService<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>391
</span></span><span style=display:flex><span>392        <span style=color:#75715e>// Tracks application usage stats.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>           <span style=color:#75715e>// 启动服务UsageStatsService，用于统计应用使用情况
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>393        mSystemServiceManager<span style=color:#f92672>.</span><span style=color:#a6e22e>startService</span><span style=color:#f92672>(</span>UsageStatsService<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>394        mActivityManagerService<span style=color:#f92672>.</span><span style=color:#a6e22e>setUsageStatsManager</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>395                LocalServices<span style=color:#f92672>.</span><span style=color:#a6e22e>getService</span><span style=color:#f92672>(</span>UsageStatsManagerInternal<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>396        <span style=color:#75715e>// Update after UsageStatsService is available, needed before performBootDexOpt.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>397        mPackageManagerService<span style=color:#f92672>.</span><span style=color:#a6e22e>getUsageStatsIfNoPackageUsageInfo</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>398
</span></span><span style=display:flex><span>399        <span style=color:#75715e>// Tracks whether the updatable WebView is in a ready state and watches for update installs.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>           <span style=color:#75715e>//启动服务WebViewUpdateService
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>400        mSystemServiceManager<span style=color:#f92672>.</span><span style=color:#a6e22e>startService</span><span style=color:#f92672>(</span>WebViewUpdateService<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>401    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=startotherserviceshttpswwwjianshucomp327f583f970b54576e41-16ed-b257-c092-01ad9e36c010><a href=https://www.jianshu.com/p/327f583f970b#54576e41-16ed-b257-c092-01ad9e36c010 target=_blank rel="external nofollow noopener noreferrer">startOtherServices<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>403    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>404     * Starts a miscellaneous grab bag of stuff that has yet to be refactored
</span></span></span><span style=display:flex><span><span style=color:#75715e>405     * and organized.
</span></span></span><span style=display:flex><span><span style=color:#75715e>406     */</span>
</span></span><span style=display:flex><span>407    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>startOtherServices</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>408        <span style=color:#66d9ef>final</span> Context context <span style=color:#f92672>=</span> mSystemContext<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>409        AccountManagerService accountManager <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>410        ContentService contentService <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>411        VibratorService vibrator <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>412        IAlarmManager alarm <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>413        IMountService mountService <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>414        NetworkManagementService networkManagement <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>415        NetworkStatsService networkStats <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>416        NetworkPolicyManagerService networkPolicy <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>417        ConnectivityService connectivity <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>418        NetworkScoreService networkScore <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>419        NsdService serviceDiscovery<span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>420        WindowManagerService wm <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>421        UsbService usb <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>422        SerialService serial <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>423        NetworkTimeUpdateService networkTimeUpdater <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>424        CommonTimeManagementService commonTimeMgmtService <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>425        InputManagerService inputManager <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>426        TelephonyRegistry telephonyRegistry <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>427        ConsumerIrService consumerIr <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>428        AudioService audioService <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>429        MmsServiceBroker mmsService <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>430        EntropyMixer entropyMixer <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>431        CameraService cameraService <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>535        StatusBarManagerService statusBar <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>536        INotificationManager notification <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>537        InputMethodManagerService imm <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>538        WallpaperManagerService wallpaper <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>539        LocationManagerService location <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>540        CountryDetectorService countryDetector <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>541        TextServicesManagerService tsms <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>542        LockSettingsService lockSettings <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>543        AssetAtlasService atlas <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>544        MediaRouterService mediaRouter <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=resource>Resource</h3><ul><li><a href=https://www.jianshu.com/p/4e5909d24d65 target=_blank rel="external nofollow noopener noreferrer">https://www.jianshu.com/p/4e5909d24d65<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></li><li><a href=https://www.jianshu.com/p/4e5909d24d65#66fcc52f-96f9-9ad9-d07b-e7721cdd08af target=_blank rel="external nofollow noopener noreferrer">https://www.jianshu.com/p/4e5909d24d65#66fcc52f-96f9-9ad9-d07b-e7721cdd08af<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a> zyogte 介绍 todo？没太懂多少</li><li><a href=https://www.jianshu.com/p/327f583f970b#54576e41-16ed-b257-c092-01ad9e36c010 target=_blank rel="external nofollow noopener noreferrer">https://www.jianshu.com/p/327f583f970b#54576e41-16ed-b257-c092-01ad9e36c010<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a> SystemService 服务相关todo</li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="2023-09-28 22:47:27">更新于 2023-09-28&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=liudongdong1.github.io/android-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span><span><a href=https://liudongdong1.github.io/edit/master/content/posts%5cAndroid%5cAndroidFramework%5cAndroid%20%e5%90%af%e5%8a%a8%e6%b5%81%e7%a8%8b.md title=编辑此页 target=_blank rel="external nofollow noopener noreferrer" class=link-to-edit>编辑此页</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=liudongdong1.github.io/android-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/ data-title=Android_启动流程 data-hashtags=Android><i class="fa-brands fa-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=liudongdong1.github.io/android-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/ data-hashtag=Android><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=liudongdong1.github.io/android-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/ data-title=Android_启动流程 data-image=https://cdn.pixabay.com/photo/2021/09/15/06/29/pot-marigold-6625895__340.jpg><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=liudongdong1.github.io/tags/android/>Android</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=liudongdong1.github.io/>主页</a></span></section></div><div class=post-nav><a href=liudongdong1.github.io/android_%E9%9F%B3%E8%A7%86%E9%A2%91%E5%BC%80%E5%8F%91/ class=prev rel=prev title=Android_音视频应用开发><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>Android_音视频应用开发</a>
<a href=liudongdong1.github.io/android_%E5%AD%98%E5%82%A8/ class=next rel=next title=Android_存储>Android_存储<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line powered">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.118.2">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.2.17-RC"><img class=fixit-icon src=/liudongdong1.github.io/fixit.min.svg alt="FixIt logo">&nbsp;FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2020 - 2023</span><span class=author itemprop=copyrightHolder>
<a href=https://liudongdong1.github.io/ target=_blank rel="external nofollow noopener noreferrer">LiuDongdong</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"><span class=site-time title='网站运行中 ...'><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden=true></i>&nbsp;<span class=run-times>网站运行中 ...</span></span></div><div class="footer-line ibruce"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div></div><a href=https://liudongdong1.github.io/ title="在 GitHub 上查看源代码" target=_blank rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;top:0;--bg-progress:#0076ff;--bg-progress-dark:#fff></div><noscript><div class=noscript-warning>FixIt 主题在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/liudongdong1.github.io/lib/katex/katex.min.css><link rel=stylesheet href=/liudongdong1.github.io/lib/cookieconsent/cookieconsent.min.css><script src=/liudongdong1.github.io/lib/autocomplete/autocomplete.min.js defer></script><script src=/liudongdong1.github.io/lib/algoliasearch/algoliasearch-lite.umd.min.js defer></script><script src=/liudongdong1.github.io/lib/lazysizes/lazysizes.min.js async defer></script><script src=/liudongdong1.github.io/lib/sharer/sharer.min.js async defer></script><script src=/liudongdong1.github.io/lib/typeit/index.umd.js defer></script><script src=/liudongdong1.github.io/lib/katex/katex.min.js defer></script><script src=/liudongdong1.github.io/lib/katex/auto-render.min.js defer></script><script src=/liudongdong1.github.io/lib/katex/copy-tex.min.js defer></script><script src=/liudongdong1.github.io/lib/katex/mhchem.min.js defer></script><script src=/liudongdong1.github.io/lib/cookieconsent/cookieconsent.min.js defer></script><script src=/liudongdong1.github.io/lib/pangu/pangu.min.js defer></script><script src=/liudongdong1.github.io/lib/cell-watermark/watermark.min.js defer></script><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:10},comment:{enable:!1},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},data:{"typeit-header-subtitle-desktop":`<span style='font-family: MMT,"沐目体";'>吾日三省吾身</span>`,"typeit-header-subtitle-mobile":`<span style='font-family: MMT,"沐目体";'>吾日三省吾身</span>`},enablePWA:!0,enablePangu:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"2R1K9SKLQZ",algoliaIndex:"index.zh-cn",algoliaSearchKey:"4a226aa1c5c98d6859e4d1386adb2bc7",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},siteTime:"2020-12-18T16:15:22+08:00",typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"typeit-header-subtitle-desktop":["typeit-header-subtitle-desktop"],"typeit-header-subtitle-mobile":["typeit-header-subtitle-mobile"]},duration:-1,speed:100},watermark:{appendto:".wrapper>main",colspacing:30,content:'<img class="fixit-icon" src="/fixit.min.svg" alt="FixIt logo" /> FixIt 主题',enable:!0,fontfamily:"inherit",fontsize:.85,height:21,opacity:.0125,rotate:15,rowspacing:60,width:150}}</script><script src=/liudongdong1.github.io/js/theme.min.js defer></script><script src=/liudongdong1.github.io/js/custom.min.js defer></script></body></html>