<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>PytorchGNN - DAY By DAY</title><meta name="author" content="LiuDongdong">
<meta name="author-link" content="https://liudongdong1.github.io/">
<meta name="description" content="论文对GNN模型分类如下： 图卷积网络(Graph convolutional networks)和图注意力网络(graph attention networks)，因为涉及到传播步骤(pr" /><meta name="keywords" content='pytorch, GNN' /><meta itemprop="name" content="PytorchGNN">
<meta itemprop="description" content="论文对GNN模型分类如下： 图卷积网络(Graph convolutional networks)和图注意力网络(graph attention networks)，因为涉及到传播步骤(pr"><meta itemprop="datePublished" content="2021-06-14T21:59:57+00:00" />
<meta itemprop="dateModified" content="2023-12-31T16:20:25+08:00" />
<meta itemprop="wordCount" content="9657"><meta itemprop="image" content="https://liudongdong1.github.io/logo.png"/>
<meta itemprop="keywords" content="pytorch,GNN," /><meta property="og:title" content="PytorchGNN" />
<meta property="og:description" content="论文对GNN模型分类如下： 图卷积网络(Graph convolutional networks)和图注意力网络(graph attention networks)，因为涉及到传播步骤(pr" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://liudongdong1.github.io/pytorchgnn/" /><meta property="og:image" content="https://liudongdong1.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-14T21:59:57+00:00" />
<meta property="article:modified_time" content="2023-12-31T16:20:25+08:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://liudongdong1.github.io/logo.png"/>

<meta name="twitter:title" content="PytorchGNN"/>
<meta name="twitter:description" content="论文对GNN模型分类如下： 图卷积网络(Graph convolutional networks)和图注意力网络(graph attention networks)，因为涉及到传播步骤(pr"/>
<meta name="application-name" content="DAY By DAY">
<meta name="apple-mobile-web-app-title" content="DAY By DAY"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://liudongdong1.github.io/pytorchgnn/" /><link rel="prev" href="https://liudongdong1.github.io/frfntptn/" /><link rel="next" href="https://liudongdong1.github.io/pytorch3d/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "PytorchGNN",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/liudongdong1.github.io\/pytorchgnn\/"
    },"genre": "posts","keywords": "pytorch, GNN","wordcount":  9657 ,
    "url": "https:\/\/liudongdong1.github.io\/pytorchgnn\/","datePublished": "2021-06-14T21:59:57+00:00","dateModified": "2023-12-31T16:20:25+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
      "@type": "Organization",
      "name": "LiuDongdong","logo": "https:\/\/liudongdong1.github.io\/images\/person.png"},"author": {
        "@type": "Person",
        "name": "liudongdong1"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="auto" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper"><script type="text/javascript"
        async
        src="https://cdnjs.cloudflare.com/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$']],
    displayMath: [['$$','$$']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>
<header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper" data-github-corner="right">
    <div class="header-title">
      <a href="/" title="DAY By DAY"><img
    class="lazyload logo"
    src="/svg/loading.min.svg"
    data-src="/fixit.min.svg"
    data-srcset="/fixit.min.svg, /fixit.min.svg 1.5x, /fixit.min.svg 2x"
    data-sizes="auto"
    alt="DAY By DAY"
    title="DAY By DAY"/><span class="header-title-text"></span></a><span id="typeit-header-subtitle-desktop" class="typeit header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 所有文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/friends/"
                title="友情链接"
                
              ><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden="true"></i> 友链</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              ><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden="true"></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item language">
            <span role="button" aria-label="选择语言" title="选择语言">简体中文<i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden="true"></i>
            </span>
            <ul class="sub-menu"><li class="menu-item">没有更多翻译</li></ul>
          </li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li>
      </ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="DAY By DAY"><img
    class="lazyload logo"
    src="/svg/loading.min.svg"
    data-src="/fixit.min.svg"
    data-srcset="/fixit.min.svg, /fixit.min.svg 1.5x, /fixit.min.svg 2x"
    data-sizes="auto"
    alt="/fixit.min.svg"
    title="/fixit.min.svg"/><span class="header-title-text"></span></a><span id="typeit-header-subtitle-mobile" class="typeit header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 所有文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/friends/"
                  title="友情链接"
                  
                ><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden="true"></i> 友链</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                ><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden="true"></i> 关于</a></li><li
              class="menu-item text-center"
            ><a
                  class="menu-link"
                  href="/"
                  title="GitHub"
                  
                ><i class='fa-brands fa-github fa-fw' aria-hidden='true'></i> </a></li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li><li class="menu-item language">
            <span role="button" aria-label="选择语言" title="选择语言">简体中文<i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden="true"></i>
            </span>
            <select class="language-select" onchange="location = this.value;"><option disabled>没有更多翻译</option></select>
          </li></ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container" data-page-style="normal"><aside class="toc" id="toc-auto"><h2 class="toc-title">目录 <i class="toc-icon fa-solid fa-angle-down fa-fw"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside>

  <aside class="aside-custom" id="aside-sakana">
    

<div class="sakana-widget">
  <div class="sakana-item" id="takina-widget"></div>
  <div class="sakana-item" id="chisato-widget"></div>
</div>
<script>
  function initSakanaWidget() {
    const takina = SakanaWidget.getCharacter('takina')
    SakanaWidget.registerCharacter('takina-slow', takina);
    new SakanaWidget({
      character: 'takina-slow',
      controls: false,
      autoFit: true,
      stroke: {
        color: "#b4b4b4",
        width: 2
      }
    }).mount('#takina-widget');

    const chisato = SakanaWidget.getCharacter('chisato')
    SakanaWidget.registerCharacter('chisato-slow', chisato);
    new SakanaWidget({
      character: 'chisato-slow',
      controls: false,
      autoFit: true,
      stroke: {
        color: "#b4b4b4",
        width: 2
      }
    }).mount('#chisato-widget');
  }
</script>
<script async onload="initSakanaWidget()" src="https://cdn.jsdelivr.net/npm/sakana-widget@2.3.0/lib/sakana.min.js">
</script></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX">
        <span>PytorchGNN</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      liudongdong1</span></span>
          <span class="post-category">收录于 <a href="/categories/"><i class="fa-regular fa-folder fa-fw"></i>&nbsp;Categories</a>&ensp;<a href="/categories/%E6%97%B6%E7%A9%BA%E6%95%B0%E6%8D%AE/"><i class="fa-regular fa-folder fa-fw"></i>&nbsp;时空数据</a></span></div>
      <div class="post-meta-line"><span title=2021-06-14&#32;21:59:57>
            <i class="fa-regular fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-06-14" >2021-06-14</time>
          </span>&nbsp;<i class="fa-solid fa-pencil-alt fa-fw"></i>&nbsp;约 9657 字&nbsp;
        <i class="fa-regular fa-clock fa-fw"></i>&nbsp;预计阅读 20 分钟&nbsp;<span id="busuanzi_container_page_pv" class="busuanzi_visitors comment-visitors" data-flag-title="PytorchGNN">
            <i class="fa-regular fa-eye fa-fw"></i>&nbsp;<span id="busuanzi_value_page_pv">-</span>&nbsp;次阅读
          </span>&nbsp;</div>
    </div><div class="featured-image"><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://cdn.pixabay.com/photo/2021/05/19/14/31/dandelion-6266230__340.jpg"
    data-srcset="https://cdn.pixabay.com/photo/2021/05/19/14/31/dandelion-6266230__340.jpg, https://cdn.pixabay.com/photo/2021/05/19/14/31/dandelion-6266230__340.jpg 1.5x, https://cdn.pixabay.com/photo/2021/05/19/14/31/dandelion-6266230__340.jpg 2x"
    data-sizes="auto"
    alt="https://cdn.pixabay.com/photo/2021/05/19/14/31/dandelion-6266230__340.jpg"
    title="https://cdn.pixabay.com/photo/2021/05/19/14/31/dandelion-6266230__340.jpg"/></div><div class="details toc" id="toc-static" kept="true">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-structure">1. Structure</a></li>
        <li><a href="#2-datasethttpspytorch-geometricreadthedocsioenlatestnotesintroductionhtml">2. <a href="https://pytorch-geometric.readthedocs.io/en/latest/notes/introduction.html">Dataset</a></a></li>
        <li><a href="#3-models">3. Models</a></li>
        <li><a href="#4--application">4.  Application</a></li>
        <li><a href="#5-visualization">5. Visualization</a></li>
        <li><a href="#6-demo">6. Demo</a></li>
        <li><a href="#resouce">Resouce</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div
      class="content"
      id="content"
      
      
    ><blockquote>
<p>论文对GNN模型分类如下：</p>
<ul>
<li><code>图卷积网络(Graph convolutional networks)</code>和<code>图注意力网络(graph attention networks)</code>，因为涉及到传播步骤(propagation step)。</li>
<li><code>图的空域网络(spatial-temporal networks)</code>，因为该模型通常用在动态图(dynamic graph)上。</li>
<li>图的自编码(auto-encoder)，因为该模型通常使用无监督学习(unsupervised)的方式。</li>
<li><code>图生成网络(generative networks)</code>，因为是生成式网络。</li>
</ul>
</blockquote>
<p>$$
\mathbf{h}<em>{v}=f\left(\mathbf{x}</em>{v}, \mathbf{x}<em>{c o[v]}, \mathbf{h}</em>{n e[v]}, \mathbf{x}_{n e[v]}\right)\label{eq:1}
$$</p>
<p>$$
\mathbf{o}<em>{v}=g\left(\mathbf{h}</em>{v}, \mathbf{x}_{v}\right)
$$</p>
<p>其中，$\mathbf{x}<em>{v}$，$\mathbf{x}</em>{c o[v]}$，$\mathbf{h}<em>{n e[v]}$，$\mathbf{x}</em>{n e[v]}$分别表示节点$v$的特征向量，节点$v$边的特征向量，节点$v$邻居节点的状态向量和节点$v$邻居节点特征向量。</p>
<p>假设将所有的状态向量，所有的输出向量，所有的特征向量叠加起来分别使用矩阵$\mathbf{H}$，$\mathbf{O}$，$ \mathbf{X}$和 $\mathbf{X}_{N}$来表示，那么可以得到更加紧凑的表示：
$$
\mathbf{H}=F(\mathbf{H}, \mathbf{X})\label{eq:3}
$$</p>
<p>$$
\mathbf{O}=G\left(\mathbf{H}, \mathbf{X}_{N}\right)
$$</p>
<p>其中，$F$表示全局转化函数(global transition function)，$G$表示全局输出函数(global output function)，分别是所有节点$f$和$g$的叠加形式</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/graph_type.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/graph_type.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/graph_type.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/graph_type.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/graph_type.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/graph_type.png"/></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/propa_step.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/propa_step.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/propa_step.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/propa_step.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/propa_step.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/propa_step.png"/></p>
<p>不同类别模型的Aggregator计算方法和Updater计算方法如下表</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/gnn_table.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/gnn_table.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/gnn_table.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/gnn_table.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/gnn_table.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/gnn_table.png"/></p>
<blockquote>
<p>Fey M, Lenssen J E. Fast graph representation learning with PyTorch Geometric[J]. arXiv preprint arXiv:1903.02428, 2019. [<a href="https://scholar.google.com/scholar_url?url=https://arxiv.org/pdf/1903.02428&amp;hl=zh-CN&amp;sa=T&amp;oi=gsb-gga&amp;ct=res&amp;cd=0&amp;d=8986807541681358909&amp;ei=M1LMYND3EsSsywSBmKRw&amp;scisig=AAGBfm2Raynm1DnoD_UxQ8L7vr2Nf8M3xQ"target="_blank" rel="external nofollow noopener noreferrer">pdf<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a>]</p>
<p>Rozemberczki B, Scherer P, He Y, et al. PyTorch Geometric Temporal: Spatiotemporal Signal Processing with Neural Machine Learning Models[J]. arXiv preprint arXiv:2104.07788, 2021. <a href="https://github.com/benedekrozemberczki/pytorch_geometric_temporal"target="_blank" rel="external nofollow noopener noreferrer">geometrictemporal<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
</blockquote>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/table.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/table.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/table.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/table.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/table.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/table.png"/></p>
<h3 id="1-structure">1. Structure</h3>
<blockquote>
<p>provide easy to use data iterators which are parametrized with spatiotemporal data. These iterators can serve snapshots which are formed by a single graph or multiple graphs which are batched together with the block diagonal batching trick.</p>
</blockquote>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210617111513969.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210617111513969.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210617111513969.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210617111513969.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210617111513969.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210617111513969.png"/></p>
<ul>
<li>
<p><strong>Temporal signal iterators</strong></p>
<ul>
<li><code>StaticGraphTemporalSignal</code> - Is designed for <strong>temporal signals</strong> defined on a <strong>static</strong> graph.</li>
<li><code>DynamicGraphTemporalSignal</code> - Is designed for <strong>temporal signals</strong> defined on a <strong>dynamic</strong> graph.</li>
<li><code>DynamicGraphStaticSignal</code> - Is designed for <strong>static signals</strong> defined on a <strong>dynamic</strong> graph.</li>
</ul>
</li>
<li>
<p><strong>Temporal Data Snapshots</strong></p>
<ul>
<li><code>data.x</code>: Node feature matrix with shape <code>[num_nodes, num_node_features]</code></li>
<li><code>data.edge_index</code>: Graph connectivity in COO format with shape <code>[2, num_edges]</code> and type <code>torch.long</code></li>
<li><code>data.edge_attr</code>: Edge feature matrix with shape <code>[num_edges, num_edge_features]</code></li>
<li><code>data.y</code>: Target to train against (may have arbitrary shape), <em>e.g.</em>, node-level targets of shape <code>[num_nodes, *]</code> or graph-level targets of shape <code>[1, *]</code></li>
<li><code>data.pos</code>: Node position matrix with shape <code>[num_nodes, num_dimensions]</code></li>
</ul>
</li>
</ul>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618090628020.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618090628020.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618090628020.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618090628020.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618090628020.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618090628020.png"/></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#创建了一个新的Data</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#方式一</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.data <span style="color:#f92672">import</span> Data
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor([[<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">1</span>],[<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">6</span>],[<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">7</span>],[<span style="color:#ae81ff">12</span>,<span style="color:#ae81ff">0</span>]],dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>float)
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor([[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">3</span>],[<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>]],dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>long)
</span></span><span style="display:flex;"><span>edge_index <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor([[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">3</span>],
</span></span><span style="display:flex;"><span>                          [<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">2</span>]],dtype<span style="color:#f92672">=</span>torch,long)
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> Data(x<span style="color:#f92672">=</span>x,y<span style="color:#f92672">=</span>y,edge_index<span style="color:#f92672">=</span>edge_index)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#方式二：</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.data <span style="color:#f92672">import</span> Data
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor([[<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">1</span>],[<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">6</span>],[<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">7</span>],[<span style="color:#ae81ff">12</span>,<span style="color:#ae81ff">0</span>]],dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>float)
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor([[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">3</span>],[<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>]],dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>long)
</span></span><span style="display:flex;"><span>edge_index <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor([[<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>],
</span></span><span style="display:flex;"><span>                           [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>],
</span></span><span style="display:flex;"><span>                           [<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span>],
</span></span><span style="display:flex;"><span>                           [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">3</span>]
</span></span><span style="display:flex;"><span>                           [<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>]], dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>long)
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> Data(x<span style="color:#f92672">=</span>x,y<span style="color:#f92672">=</span>y,edge_index<span style="color:#f92672">=</span>edge_index<span style="color:#f92672">.</span>contiguous())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>loader <span style="color:#f92672">=</span> DataLoader(dataset, batch_size<span style="color:#f92672">=</span><span style="color:#ae81ff">512</span>, shuffle<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>Batch(x<span style="color:#f92672">=</span>[<span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">21</span>], edge_index<span style="color:#f92672">=</span>[<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1568</span>], y<span style="color:#f92672">=</span>[<span style="color:#ae81ff">512</span>], batch<span style="color:#f92672">=</span>[<span style="color:#ae81ff">1024</span>])
</span></span></code></pre></div><ul>
<li><strong>Train-Test Splitting</strong> &amp;&amp; <strong>Integrated Benchmark Dataset Loaders</strong></li>
</ul>
<h3 id="2-datasethttpspytorch-geometricreadthedocsioenlatestnotesintroductionhtml">2. <a href="https://pytorch-geometric.readthedocs.io/en/latest/notes/introduction.html"target="_blank" rel="external nofollow noopener noreferrer">Dataset<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></h3>
<h4 id="1-offered-dataset">.1. offered dataset</h4>
<ul>
<li><a href="https://pytorch-geometric-temporal.readthedocs.io/en/latest/modules/dataset.html#torch_geometric_temporal.data.dataset.chickenpox.ChickenpoxDatasetLoader"target="_blank" rel="external nofollow noopener noreferrer">Hungarian Chickenpox Dataset.<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://pytorch-geometric-temporal.readthedocs.io/en/latest/modules/dataset.html#torch_geometric_temporal.data.dataset.pedalme.PedalMeDatasetLoader"target="_blank" rel="external nofollow noopener noreferrer">PedalMe London Dataset.<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://pytorch-geometric-temporal.readthedocs.io/en/latest/modules/dataset.html#torch_geometric_temporal.data.dataset.wikimath.WikiMathsDatasetLoader"target="_blank" rel="external nofollow noopener noreferrer">Wikipedia Vital Math Dataset.<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://pytorch-geometric-temporal.readthedocs.io/en/latest/modules/dataset.html#torch_geometric_temporal.data.dataset.windmill.WindmillOutputDatasetLoader"target="_blank" rel="external nofollow noopener noreferrer">Windmill Output Dataset.<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://pytorch-geometric-temporal.readthedocs.io/en/latest/modules/dataset.html#torch_geometric_temporal.data.dataset.pems_bay.PemsBayDatasetLoader"target="_blank" rel="external nofollow noopener noreferrer">Pems Bay Dataset.<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://pytorch-geometric-temporal.readthedocs.io/en/latest/modules/dataset.html#torch_geometric_temporal.data.dataset.metr_la.METRLADatasetLoader"target="_blank" rel="external nofollow noopener noreferrer">Metr LA Dataset.<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://pytorch-geometric-temporal.readthedocs.io/en/latest/modules/dataset.html#torch_geometric_temporal.data.dataset.encovid.EnglandCovidDatasetLoader"target="_blank" rel="external nofollow noopener noreferrer">England COVID 19.<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://pytorch-geometric-temporal.readthedocs.io/en/latest/modules/dataset.html#torch_geometric_temporal.data.dataset.twitter_tennis.TwitterTennisDatasetLoader"target="_blank" rel="external nofollow noopener noreferrer">Twitter Tennis.<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.datasets <span style="color:#f92672">import</span> TUDataset
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.data <span style="color:#f92672">import</span> DataLoader
</span></span><span style="display:flex;"><span>dataset <span style="color:#f92672">=</span> TUDataset(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/tmp/ENZYMES&#39;</span>, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ENZYMES&#39;</span>, use_node_attr<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>loader <span style="color:#f92672">=</span> DataLoader(dataset, batch_size<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>, shuffle<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> batch <span style="color:#f92672">in</span> loader:
</span></span><span style="display:flex;"><span>    batch
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> Batch(batch<span style="color:#f92672">=</span>[<span style="color:#ae81ff">1082</span>], edge_index<span style="color:#f92672">=</span>[<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">4066</span>], x<span style="color:#f92672">=</span>[<span style="color:#ae81ff">1082</span>, <span style="color:#ae81ff">21</span>], y<span style="color:#f92672">=</span>[<span style="color:#ae81ff">32</span>])
</span></span><span style="display:flex;"><span>    batch<span style="color:#f92672">.</span>num_graphs
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#ae81ff">32</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#dataset split</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric_temporal.dataset <span style="color:#f92672">import</span> ChickenpoxDatasetLoader
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric_temporal.signal <span style="color:#f92672">import</span> temporal_signal_split
</span></span><span style="display:flex;"><span>loader <span style="color:#f92672">=</span> ChickenpoxDatasetLoader()
</span></span><span style="display:flex;"><span>dataset <span style="color:#f92672">=</span> loader<span style="color:#f92672">.</span>get_dataset()
</span></span><span style="display:flex;"><span>dataset <span style="color:#f92672">=</span> dataset<span style="color:#f92672">.</span>shuffle()   <span style="color:#75715e">#shuffle dataset</span>
</span></span><span style="display:flex;"><span>train_dataset, test_dataset <span style="color:#f92672">=</span> temporal_signal_split(dataset, train_ratio<span style="color:#f92672">=</span><span style="color:#ae81ff">0.8</span>)
</span></span></code></pre></div><ul>
<li><strong>Mini-Batch</strong></li>
</ul>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618092943939.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618092943939.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618092943939.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618092943939.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618092943939.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618092943939.png"/></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618093025169.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618093025169.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618093025169.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618093025169.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618093025169.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618093025169.png"/></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618160343566.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618160343566.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618160343566.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618160343566.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618160343566.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618160343566.png"/></p>
<h5 id="1-planetoid-类实例化流程">1. Planetoid 类实例化流程</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>dataset <span style="color:#f92672">=</span> Planetoid(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;dataset/PlanetoidPubMed&#39;</span>,transform<span style="color:#f92672">=</span>NormalizeFeatures())
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> dataset[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>to(device) <span style="color:#75715e">#这一步才执行transform的函数</span>
</span></span></code></pre></div><ol>
<li>
<p>首先，检查数据原始文件是否已下载：</p>
<ul>
<li>检查<code>self.raw_dir</code>目录下是否存在<code>raw_file_names()</code>属性方法返回的每个文件，</li>
<li>如有文件不存在，则调用<code>download()</code>方法执行原始文件下载。</li>
</ul>
</li>
<li>
<p>其次，检查数据是否经过处理：</p>
<ul>
<li>
<p>首先，检查之前对数据做变换的方法：检查</p>
<pre tabindex="0"><code>self.processed_dir
</code></pre><p>目录下是否存在</p>
<pre tabindex="0"><code>pre_transform.pt
</code></pre><p>文件：</p>
<ul>
<li>
<p>如果存在，意味着之前进行过数据变换，接着需要加载该文件，以获取之前所用的数据变换的方法，并检查它与当前</p>
<pre tabindex="0"><code>pre_transform
</code></pre><p>参数指定的方法是否相同，</p>
<ul>
<li>如果不相同则会报出一个警告，“The pre_transform argument differs from the one used in ……”。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>其次，检查之前的样本过滤的方法：检查</p>
<pre tabindex="0"><code>self.processed_dir
</code></pre><p>目录下是否存在</p>
<pre tabindex="0"><code>pre_filter.pt
</code></pre><p>文件：</p>
<ul>
<li>
<p>如果存在，则加载该文件并获取之前所用的样本过滤的方法，并检查它与当前</p>
<pre tabindex="0"><code>pre_filter
</code></pre><p>参数指定的方法是否相同，</p>
<ul>
<li>如果不相同则会报出一个警告，“The pre_filter argument differs from the one used in ……”。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>接着，检查是否存在处理好的数据：检查</p>
<pre tabindex="0"><code>self.processed_dir
</code></pre><p>目录下是否存在</p>
<pre tabindex="0"><code>self.processed_file_names
</code></pre><p>属性方法返回的所有文件，如有文件不存在，则需要执行以下的操作：</p>
<ul>
<li>
<p>调用<code>process()</code>方法，进行数据处理。</p>
</li>
<li>
<p>如果<code>pre_transform</code>参数不为<code>None</code>，则调用<code>pre_transform()</code>函数进行数据处理。</p>
</li>
<li>
<p>如果<code>pre_filter</code>参数不为<code>None</code>，则进行样本过滤（此例子中不需要进行样本过滤，<code>pre_filter</code>参数为<code>None</code>）。</p>
</li>
<li>
<p>保存处理好的数据到文件，文件存储在</p>
<p>processed_paths()</p>
<p>属性方法返回的文件路径。如果将数据保存到多个文件中，则返回的路径有多个。</p>
<ul>
<li><strong><code>processed_paths()</code>属性方法是在基类（<a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/data.html?highlight=dataset#torch_geometric.data.Dataset"target="_blank" rel="external nofollow noopener noreferrer">DataSet<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a>）中定义的</strong>，它对<code>self.processed_dir</code>文件夹与<code>processed_file_names()</code>属性方法的返回每一个文件名做拼接，然后返回。</li>
</ul>
</li>
<li>
<p>最后保存新的<code>pre_transform.pt</code>文件和<code>pre_filter.pt</code>文件，它们分别存储当前使用的数据处理方法和样本过滤方法。</p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>保证有预处理的文件后，在<code>self.data, self.slices = torch.load(self.processed_paths[0])</code>时从预处理文件路径中加载预处理后的数据。</p>
</li>
<li>
<p>在执行<code>data = dataset[0]</code>时才调用选择的<code>transform</code>函数。</p>
</li>
</ol>
<h4 id="2-customed-dataset">.2. customed dataset</h4>
<blockquote>
<p>PyG提供两种不同的数据集类：Dataset,InMemoryDataset ,InMemoryDataset继承Dataset, 如果要继承InMemoryDataset 需要实现以下几个类</p>
<ul>
<li><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/data.html#torch_geometric.data.InMemoryDataset.raw_file_names"target="_blank" rel="external nofollow noopener noreferrer"><code>torch_geometric.data.InMemoryDataset.raw_file_names()</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a>: A list of files in the <code>raw_dir</code> which needs to be found in order to skip the download.</li>
<li><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/data.html#torch_geometric.data.InMemoryDataset.processed_file_names"target="_blank" rel="external nofollow noopener noreferrer"><code>torch_geometric.data.InMemoryDataset.processed_file_names()</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a>: A list of files in the <code>processed_dir</code> which needs to be found in order to skip the processing.</li>
<li><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/data.html#torch_geometric.data.InMemoryDataset.download"target="_blank" rel="external nofollow noopener noreferrer"><code>torch_geometric.data.InMemoryDataset.download()</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a>: Downloads raw data into <code>raw_dir</code>.</li>
<li><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/data.html#torch_geometric.data.InMemoryDataset.process"target="_blank" rel="external nofollow noopener noreferrer"><code>torch_geometric.data.InMemoryDataset.process()</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a>: Processes raw data and saves it into the <code>processed_dir</code>.</li>
</ul>
</blockquote>
<ul>
<li><code>root</code>：字符串类型，存储数据集的文件夹的路径下。该文件夹下有两个文件夹：
<ul>
<li>一个文件夹为记录在**<code>raw_dir</code><strong>，它用于存储未处理的文件，从网络上下载的</strong>数据集原始文件**会被存放到这里；</li>
<li>另一个文件夹记录在**<code>processed_dir</code>**，<strong>处理后的数据</strong>被保存到这里，以后从此文件夹下加载文件即可获得<code>Data</code>对象。</li>
<li>注：<code>raw_dir</code>和<code>processed_dir</code>是属性方法，我们可以自定义要使用的文件夹。</li>
</ul>
</li>
<li><code>transform</code>：函数类型，一个数据转换函数，它接收一个<code>Data</code>对象并返回一个转换后的<code>Data</code>对象。<strong>此函数在每一次数据获取过程中都会被执行</strong>。获取数据的函数首先使用此函数对<code>Data</code>对象做转换，然后才返回数据。此函数应该用于数据增广（Data Augmentation）。该参数默认值为<code>None</code>，表示不对数据做转换。</li>
<li><code>pre_transform</code>：函数类型，一个数据转换函数，它接收一个<code>Data</code>对象并返回一个转换后的<code>Data</code>对象。<strong>此函数在<code>Data</code>对象被保存到文件前调用</strong>。因此它应该用于只执行一次的数据预处理。该参数默认值为<code>None</code>，表示不做数据预处理。</li>
<li><code>pre_filter</code>：函数类型，<strong>一个检查数据是否要保留的函数</strong>，它接收一个<code>Data</code>对象，返回此<code>Data</code>对象是否应该被包含在最终的数据集中。此函数也在<a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/data.html#torch_geometric.data.Data"target="_blank" rel="external nofollow noopener noreferrer"><code>Data</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a>对象被保存到文件前调用。该参数默认值为<code>None</code>，表示不做数据检查，保留所有的数据。</li>
<li>raw_file_names(): 属性方法，返回一个<strong>数据集原始文件</strong>的文件名列表，<strong>数据集原始文件应该能在<code>raw_dir</code>文件夹中找到</strong>，否则调用<code>download()</code>函数下载文件到<code>raw_dir</code>文件夹。</li>
<li>processed_file_names: 属性方法，返回一个存储<strong>处理过的数据的文件</strong>的文件名列表，存储处理过的数据的文件应该能在<code>processed_dir</code>文件夹中找到，否则调用<code>process()</code>函数对样本做处理，然后保存处理过的数据到<code>processed_dir</code>文件夹下的文件里。</li>
<li>download: 根据定义的<code>url</code>属性<strong>下载数据集原始文件</strong>到<code>raw_dir</code>文件夹。</li>
<li>processed: <strong>调用读取数据函数，将数据包装成Data</strong>，然后<strong>处理数据</strong>，保存处理好的数据到<code>processed_dir</code>文件夹下的文件。</li>
<li>raw_dir: 属性方法，原始数据存储的文件夹路径，我们可以自定义要使用的文件夹。</li>
<li>processed_dir: 属性方法，处理后数据存储的文件夹路径，我们可以自定义要使用的文件夹。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.data <span style="color:#f92672">import</span> InMemoryDataset
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyOwnDataset</span>(InMemoryDataset):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, root, transform<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, pre_transform<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        super(MyOwnDataset, self)<span style="color:#f92672">.</span>__init__(root, transform, pre_transform)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>data, self<span style="color:#f92672">.</span>slices <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>load(self<span style="color:#f92672">.</span>processed_paths[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span><span style="color:#75715e">#它返回一个包含没有处理的数据的名字的list。如果你只有一个文件，那么它返回的list将只包含一个元素。事实上，你可以返回一个空list，然后确定你的文件在后面的函数process()中。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@property</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">raw_file_names</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> [<span style="color:#e6db74">&#39;some_file_1&#39;</span>, <span style="color:#e6db74">&#39;some_file_2&#39;</span>, <span style="color:#f92672">...</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#它返回一个包含所有处理过的数据的list。在调用process()这个函数后，通常返回的list只有一个元素，它只保存已经处理过的数据的名字。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@property</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">processed_file_names</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> [<span style="color:#e6db74">&#39;data.pt&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#下载数据到你正在工作的目录中，你可以在self.raw_dir中指定。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">download</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Download to `self.raw_dir`.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Read data into huge `Data` list.</span>
</span></span><span style="display:flex;"><span>        data_list <span style="color:#f92672">=</span> [<span style="color:#f92672">...</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>pre_filter <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            data_list [data <span style="color:#66d9ef">for</span> data <span style="color:#f92672">in</span> data_list <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>pre_filter(data)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>pre_transform <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            data_list <span style="color:#f92672">=</span> [self<span style="color:#f92672">.</span>pre_transform(data) <span style="color:#66d9ef">for</span> data <span style="color:#f92672">in</span> data_list]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        data, slices <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>collate(data_list)
</span></span><span style="display:flex;"><span>        torch<span style="color:#f92672">.</span>save((data, slices), self<span style="color:#f92672">.</span>processed_paths[<span style="color:#ae81ff">0</span>])
</span></span></code></pre></div><blockquote>
<ul>
<li><code>torch_geometric.data.Dataset.len()</code>: Returns the number of examples in your dataset.</li>
<li><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/data.html#torch_geometric.data.Dataset.get"target="_blank" rel="external nofollow noopener noreferrer"><code>torch_geometric.data.Dataset.get()</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a>: Implements the logic to load a single graph.</li>
</ul>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> os.path <span style="color:#66d9ef">as</span> osp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.data <span style="color:#f92672">import</span> Dataset, download_url
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyOwnDataset</span>(Dataset):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, root, transform<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, pre_transform<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        super(MyOwnDataset, self)<span style="color:#f92672">.</span>__init__(root, transform, pre_transform)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@property</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">raw_file_names</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> [<span style="color:#e6db74">&#39;some_file_1&#39;</span>, <span style="color:#e6db74">&#39;some_file_2&#39;</span>, <span style="color:#f92672">...</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@property</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">processed_file_names</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> [<span style="color:#e6db74">&#39;data_1.pt&#39;</span>, <span style="color:#e6db74">&#39;data_2.pt&#39;</span>, <span style="color:#f92672">...</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">download</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Download to `self.raw_dir`.</span>
</span></span><span style="display:flex;"><span>        path <span style="color:#f92672">=</span> download_url(url, self<span style="color:#f92672">.</span>raw_dir)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process</span>(self):
</span></span><span style="display:flex;"><span>        i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> raw_path <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>raw_paths:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Read data from `raw_path`.</span>
</span></span><span style="display:flex;"><span>            data <span style="color:#f92672">=</span> Data(<span style="color:#f92672">...</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>pre_filter <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>pre_filter(data):
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>pre_transform <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>                data <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>pre_transform(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            torch<span style="color:#f92672">.</span>save(data, osp<span style="color:#f92672">.</span>join(self<span style="color:#f92672">.</span>processed_dir, <span style="color:#e6db74">&#39;data_</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">.pt&#39;</span><span style="color:#f92672">.</span>format(i)))
</span></span><span style="display:flex;"><span>            i <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">len</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> len(self<span style="color:#f92672">.</span>processed_file_names)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get</span>(self, idx):
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>load(osp<span style="color:#f92672">.</span>join(self<span style="color:#f92672">.</span>processed_dir, <span style="color:#e6db74">&#39;data_</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">.pt&#39;</span><span style="color:#f92672">.</span>format(idx)))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> data
</span></span></code></pre></div><h4 id="3-transformerhttpspytorch-geometricreadthedocsioenlatestmodulestransformshtml">.3. <a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html"target="_blank" rel="external nofollow noopener noreferrer">Transformer<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></h4>
<blockquote>
<p>Transforms can be chained together using <a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.Compose"target="_blank" rel="external nofollow noopener noreferrer"><code>torch_geometric. transforms. Compose</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> and are applied before saving a processed dataset on disk (<code>pre_transform</code>) or before accessing a graph in a dataset (<code>transform</code>).</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#convert the point cloud dataset into a graph dataset by generating nearest neighbor graphs from the point clouds via transform</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch_geometric.transforms <span style="color:#66d9ef">as</span> T
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.datasets <span style="color:#f92672">import</span> ShapeNet
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dataset <span style="color:#f92672">=</span> ShapeNet(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/tmp/ShapeNet&#39;</span>, categories<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;Airplane&#39;</span>],
</span></span><span style="display:flex;"><span>                    pre_transform<span style="color:#f92672">=</span>T<span style="color:#f92672">.</span>KNNGraph(k<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>))
</span></span><span style="display:flex;"><span>dataset[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> Data(edge_index<span style="color:#f92672">=</span>[<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">15108</span>], pos<span style="color:#f92672">=</span>[<span style="color:#ae81ff">2518</span>, <span style="color:#ae81ff">3</span>], y<span style="color:#f92672">=</span>[<span style="color:#ae81ff">2518</span>])
</span></span></code></pre></div><table>
<thead>
<tr>
<th><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.Compose"target="_blank" rel="external nofollow noopener noreferrer"><code>Compose</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></th>
<th>Composes several transforms together.</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.ToSparseTensor"target="_blank" rel="external nofollow noopener noreferrer"><code>ToSparseTensor</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Converts the <code>edge_index</code> attribute of a data object into a (transposed) <code>torch_sparse.SparseTensor</code> type with key <code>adj_.t</code>.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.ToUndirected"target="_blank" rel="external nofollow noopener noreferrer"><code>ToUndirected</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Converts the graph to an undirected graph, so that (j,i)∈E(j,i)∈E for every edge (i,j)∈E(i,j)∈E.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.Constant"target="_blank" rel="external nofollow noopener noreferrer"><code>Constant</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Adds a constant value to each node feature.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.Distance"target="_blank" rel="external nofollow noopener noreferrer"><code>Distance</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Saves the Euclidean distance of linked nodes in its edge attributes.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.Cartesian"target="_blank" rel="external nofollow noopener noreferrer"><code>Cartesian</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Saves the relative Cartesian coordinates of linked nodes in its edge attributes.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.LocalCartesian"target="_blank" rel="external nofollow noopener noreferrer"><code>LocalCartesian</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Saves the relative Cartesian coordinates of linked nodes in its edge attributes.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.Polar"target="_blank" rel="external nofollow noopener noreferrer"><code>Polar</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Saves the <code>polar coordinates</code> of linked nodes in its edge attributes.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.Spherical"target="_blank" rel="external nofollow noopener noreferrer"><code>Spherical</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Saves the spherical coordinates of linked nodes in its edge attributes.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.PointPairFeatures"target="_blank" rel="external nofollow noopener noreferrer"><code>PointPairFeatures</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Computes the rotation-invariant Point Pair Features</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.OneHotDegree"target="_blank" rel="external nofollow noopener noreferrer"><code>OneHotDegree</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Adds the node degree as one hot encodings to the node features.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.TargetIndegree"target="_blank" rel="external nofollow noopener noreferrer"><code>TargetIndegree</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Saves the globally normalized degree of target nodes</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.LocalDegreeProfile"target="_blank" rel="external nofollow noopener noreferrer"><code>LocalDegreeProfile</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Appends the Local Degree Profile (LDP) from the <a href="https://arxiv.org/abs/1811.03508"target="_blank" rel="external nofollow noopener noreferrer">“A Simple yet Effective Baseline for Non-attribute Graph Classification”<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> paper</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.Center"target="_blank" rel="external nofollow noopener noreferrer"><code>Center</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Centers node positions around the origin.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.NormalizeRotation"target="_blank" rel="external nofollow noopener noreferrer"><code>NormalizeRotation</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td><code>Rotates all points according to the eigenvectors of the point cloud.</code></td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.NormalizeScale"target="_blank" rel="external nofollow noopener noreferrer"><code>NormalizeScale</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Centers and normalizes node positions to the interval (−1,1)(−1,1).</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.RandomTranslate"target="_blank" rel="external nofollow noopener noreferrer"><code>RandomTranslate</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Translates node positions by randomly sampled translation values within a given interval.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.RandomFlip"target="_blank" rel="external nofollow noopener noreferrer"><code>RandomFlip</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Flips node positions along a given axis randomly with a given probability.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.LinearTransformation"target="_blank" rel="external nofollow noopener noreferrer"><code>LinearTransformation</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Transforms node positions with a square transformation matrix computed offline.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.RandomScale"target="_blank" rel="external nofollow noopener noreferrer"><code>RandomScale</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Scales node positions by a randomly sampled factor ss within a given interval, <em>e.g.</em>, resulting in the transformation matrix</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.RandomRotate"target="_blank" rel="external nofollow noopener noreferrer"><code>RandomRotate</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td><code>Rotates node positions around a specific axis by a randomly sampled factor within a given interval.</code></td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.RandomShear"target="_blank" rel="external nofollow noopener noreferrer"><code>RandomShear</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Shears node positions by randomly sampled factors ss within a given interval, <em>e.g.</em>, resulting in the transformation matrix</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.NormalizeFeatures"target="_blank" rel="external nofollow noopener noreferrer"><code>NormalizeFeatures</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Row-normalizes node features to sum-up to one.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.AddSelfLoops"target="_blank" rel="external nofollow noopener noreferrer"><code>AddSelfLoops</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Adds self-loops to edge indices.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.RemoveIsolatedNodes"target="_blank" rel="external nofollow noopener noreferrer"><code>RemoveIsolatedNodes</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Removes isolated nodes from the graph.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.KNNGraph"target="_blank" rel="external nofollow noopener noreferrer"><code>KNNGraph</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Creates a<code> k-NN graph</code> based on node positions <code>pos</code>.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.RadiusGraph"target="_blank" rel="external nofollow noopener noreferrer"><code>RadiusGraph</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Creates edges based on node positions <code>pos</code> to all points within a given distance.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.FaceToEdge"target="_blank" rel="external nofollow noopener noreferrer"><code>FaceToEdge</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Converts<code> mesh faces</code> <code>[3, num_faces]</code> to edge indices <code>[2, num_edges]</code>.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.SamplePoints"target="_blank" rel="external nofollow noopener noreferrer"><code>SamplePoints</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Uniformly samples <code>num</code> points on the mesh faces according to their face area.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.FixedPoints"target="_blank" rel="external nofollow noopener noreferrer"><code>FixedPoints</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Samples a fixed number of <code>num</code> points and features from a point cloud.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.ToDense"target="_blank" rel="external nofollow noopener noreferrer"><code>ToDense</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Converts a sparse adjacency matrix to a dense adjacency matrix with shape <code>[num_nodes, num_nodes, *]</code>.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.TwoHop"target="_blank" rel="external nofollow noopener noreferrer"><code>TwoHop</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Adds the two hop edges to the edge indices.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.LineGraph"target="_blank" rel="external nofollow noopener noreferrer"><code>LineGraph</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Converts a graph to its corresponding line-graph:</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.LaplacianLambdaMax"target="_blank" rel="external nofollow noopener noreferrer"><code>LaplacianLambdaMax</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Computes the highest eigenvalue of the graph Laplacian given by <a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/utils.html#torch_geometric.utils.get_laplacian"target="_blank" rel="external nofollow noopener noreferrer"><code>torch_geometric.utils.get_laplacian()</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a>.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.GenerateMeshNormals"target="_blank" rel="external nofollow noopener noreferrer"><code>GenerateMeshNormals</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Generate normal vectors for each mesh node based on neighboring faces.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.Delaunay"target="_blank" rel="external nofollow noopener noreferrer"><code>Delaunay</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Computes the delaunay triangulation of a set of points.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.ToSLIC"target="_blank" rel="external nofollow noopener noreferrer"><code>ToSLIC</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Converts an image to a superpixel representation using the <code>skimage.segmentation.slic()</code> algorithm, resulting in a <a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/data.html#torch_geometric.data.Data"target="_blank" rel="external nofollow noopener noreferrer"><code>torch_geometric.data.Data</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> object holding the centroids of superpixels in <code>pos</code> and their mean color in <code>x</code>.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.GDC"target="_blank" rel="external nofollow noopener noreferrer"><code>GDC</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Processes the graph via Graph Diffusion Convolution (GDC) from the <a href="https://www.kdd.in.tum.de/gdc"target="_blank" rel="external nofollow noopener noreferrer">“Diffusion Improves Graph Learning”<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> paper.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.SIGN"target="_blank" rel="external nofollow noopener noreferrer"><code>SIGN</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>The Scalable Inception Graph Neural Network module (SIGN) from the <a href="https://arxiv.org/abs/2004.11198"target="_blank" rel="external nofollow noopener noreferrer">“SIGN: Scalable Inception Graph Neural Networks”<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> paper, which precomputes the fixed representations</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.GridSampling"target="_blank" rel="external nofollow noopener noreferrer"><code>GridSampling</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Clusters points into voxels with size <code>size</code>.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.GCNNorm"target="_blank" rel="external nofollow noopener noreferrer"><code>GCNNorm</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Applies the GCN normalization from the <a href="https://arxiv.org/abs/1609.02907"target="_blank" rel="external nofollow noopener noreferrer">“Semi-supervised Classification with Graph Convolutional Networks”<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> paper.</td>
</tr>
<tr>
<td><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.AddTrainValTestMask"target="_blank" rel="external nofollow noopener noreferrer"><code>AddTrainValTestMask</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></td>
<td>Adds a node-level random split via <code>train_mask</code>, <code>val_mask</code> and <code>test_mask</code> attributes to the <code>data</code> object.</td>
</tr>
</tbody>
</table>
<h3 id="3-models">3. Models</h3>
<h4 id="1-mls">.1. MLs</h4>
<ul>
<li><strong>Temporal Deep learning:</strong>
<ul>
<li><code>LSTM or GRU</code> generates in-memory representations of data points which are iteratively updated as it learns by new snapshots;</li>
<li><code>attention mechanism</code>: to learn representation of the data points which are adaptively recontextualized based on the temporal history.</li>
</ul>
</li>
<li>**Static Graph Representation Learning: **
<ul>
<li><code>message passing formalism</code>: learning representations of vertices, edges, and whole graphs with GNN.</li>
<li>models are differentiated by assumptions about the input graph ( eg. node heterogeneity, multiplexity, presence of edge attributes ), message compression function, propagation scheme, message aggregation function.</li>
</ul>
</li>
<li><strong>Spatio-temporal Deep Learning:</strong>  combine temporal deep learning technique and graph representation learning.</li>
<li><strong>Predictive Perfromance:</strong>
<ul>
<li><code>Incremental:</code> the loss is back-propagated and model wights are updated after each temporal snapshot;</li>
<li><code>Cumulative:</code> aggregated loss from every temporal snapshot and update weights with optimizer per epoch.</li>
</ul>
</li>
</ul>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210617112633539.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210617112633539.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210617112633539.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210617112633539.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210617112633539.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210617112633539.png"/></p>
<ul>
<li><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/nn.html#convolutional-layers"target="_blank" rel="external nofollow noopener noreferrer">Convolutional Layers<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/nn.html#dense-convolutional-layers"target="_blank" rel="external nofollow noopener noreferrer">Dense Convolutional Layers<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/nn.html#normalization-layers"target="_blank" rel="external nofollow noopener noreferrer">Normalization Layers<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/nn.html#global-pooling-layers"target="_blank" rel="external nofollow noopener noreferrer">Global Pooling Layers<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/nn.html#pooling-layers"target="_blank" rel="external nofollow noopener noreferrer">Pooling Layers<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/nn.html#dense-pooling-layers"target="_blank" rel="external nofollow noopener noreferrer">Dense Pooling Layers<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/nn.html#unpooling-layers"target="_blank" rel="external nofollow noopener noreferrer">Unpooling Layers<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/nn.html#models"target="_blank" rel="external nofollow noopener noreferrer">Models<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/nn.html#functional"target="_blank" rel="external nofollow noopener noreferrer">Functional<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/nn.html#module-torch_geometric.nn.data_parallel"target="_blank" rel="external nofollow noopener noreferrer">DataParallel Layers<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
</ul>
<h4 id="2-messagepassingneighborhood-aggregation">.2. MessagePassing&amp;neighborhood aggregation</h4>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618160144302.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618160144302.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618160144302.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618160144302.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618160144302.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618160144302.png"/></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618095312400.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618095312400.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618095312400.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618095312400.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618095312400.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618095312400.png"/></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618155312167.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618155312167.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618155312167.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618155312167.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618155312167.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618155312167.png"/></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618095445424.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618095445424.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618095445424.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618095445424.png 2x"
    data-sizes="auto"
    alt="image-20210618095445424"
    title="image-20210618095445424"/></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618160311559.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618160311559.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618160311559.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618160311559.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618160311559.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618160311559.png"/></p>
<ul>
<li><code>MessagePassing(aggr=&quot;add&quot;, flow=&quot;source_to_target&quot;, node_dim=-2)</code>: Defines the aggregation scheme to use (<code>&quot;add&quot;</code>, <code>&quot;mean&quot;</code> or <code>&quot;max&quot;</code>) and the flow direction of message passing (either <code>&quot;source_to_target&quot;</code> or <code>&quot;target_to_source&quot;</code>). Furthermore, the <code>node_dim</code> attribute indicates along which axis to propagate.</li>
<li><code>MessagePassing.propagate(edge_index, size=None, **kwargs)</code>: The initial call to start propagating messages. Takes in the edge indices and all additional data which is needed to construct messages and to update node embeddings. Note that <a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/nn.html#torch_geometric.nn.conv.message_passing.MessagePassing.propagate"target="_blank" rel="external nofollow noopener noreferrer"><code>propagate()</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> is not limited to exchange messages in symmetric adjacency matrices of shape <code>[N, N]</code> only, but can also exchange messages in general sparse assignment matrices, <em>.e.g.</em>, bipartite graphs, of shape <code>[N, M]</code> by passing <code>size=(N, M)</code> as an additional argument. If set to <a href="https://docs.python.org/3/library/constants.html#None"target="_blank" rel="external nofollow noopener noreferrer"><code>None</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a>, the assignment matrix is assumed to be symmetric. For bipartite graphs with two independent sets of nodes and indices, and each set holding its own information, this split can be marked by passing the information as a tuple, <em>e.g.</em> <code>x=(x_N, x_M)</code>.</li>
<li><code>MessagePassing.message(...)</code>: Constructs messages to node i in analogy to ϕϕfor each edge in (j,i)∈E(j,i)∈E if <code>flow=&quot;source_to_target&quot;</code> and (i,j)∈E(i,j)∈E if <code>flow=&quot;target_to_source&quot;</code>. Can take any argument which was initially passed to <code>propagate()</code>. In addition, tensors passed to <code>propagate()</code> can be mapped to the respective nodes ii and jj by appending <code>_i</code> or <code>_j</code> to the variable name, <em>.e.g.</em> <code>x_i</code> and <code>x_j</code>. Note that we generally refer to ii as the central nodes that aggregates information, and refer to jj as the neighboring nodes, since this is the most common notation.</li>
<li><code>MessagePassing.update(aggr_out, ...)</code>: Updates node embeddings in analogy to γγ for each node i∈Vi∈V. Takes in the output of aggregation as first argument and any argument which was initially passed to <a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/nn.html#torch_geometric.nn.conv.message_passing.MessagePassing.propagate"target="_blank" rel="external nofollow noopener noreferrer"><code>propagate()</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a>.</li>
</ul>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618104838632.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618104838632.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618104838632.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618104838632.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618104838632.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618104838632.png"/></p>
<h5 id="1-gcn-layerhttpspytorch-geometricreadthedocsioenlatestnotescreate_gnnhtmlid2">.1. <a href="https://pytorch-geometric.readthedocs.io/en/latest/notes/create_gnn.html#id2"target="_blank" rel="external nofollow noopener noreferrer">GCN Layer<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></h5>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618095657408.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618095657408.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618095657408.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618095657408.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618095657408.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618095657408.png"/></p>
<blockquote>
<ol>
<li>Add self-loops to the adjacency matrix.</li>
<li>Linearly transform node feature matrix.</li>
<li>Compute normalization coefficients.</li>
<li>Normalize node features in ϕϕ.</li>
<li>Sum up neighboring node features (<code>&quot;add&quot;</code> aggregation).</li>
</ol>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.nn <span style="color:#f92672">import</span> MessagePassing
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.utils <span style="color:#f92672">import</span> add_self_loops, degree
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GCNConv</span>(MessagePassing):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, in_channels, out_channels):
</span></span><span style="display:flex;"><span>        super(GCNConv, self)<span style="color:#f92672">.</span>__init__(aggr<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;add&#39;</span>)  <span style="color:#75715e"># &#34;Add&#34; aggregation (Step 5).</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>lin <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Linear(in_channels, out_channels)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, x, edge_index):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># x has shape [N, in_channels]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># edge_index has shape [2, E]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Step 1: Add self-loops to the adjacency matrix.</span>
</span></span><span style="display:flex;"><span>        edge_index, _ <span style="color:#f92672">=</span> add_self_loops(edge_index, num_nodes<span style="color:#f92672">=</span>x<span style="color:#f92672">.</span>size(<span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Step 2: Linearly transform node feature matrix.</span>
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>lin(x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Step 3: Compute normalization.</span>
</span></span><span style="display:flex;"><span>        row, col <span style="color:#f92672">=</span> edge_index
</span></span><span style="display:flex;"><span>        deg <span style="color:#f92672">=</span> degree(col, x<span style="color:#f92672">.</span>size(<span style="color:#ae81ff">0</span>), dtype<span style="color:#f92672">=</span>x<span style="color:#f92672">.</span>dtype)
</span></span><span style="display:flex;"><span>        deg_inv_sqrt <span style="color:#f92672">=</span> deg<span style="color:#f92672">.</span>pow(<span style="color:#f92672">-</span><span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>        deg_inv_sqrt[deg_inv_sqrt <span style="color:#f92672">==</span> float(<span style="color:#e6db74">&#39;inf&#39;</span>)] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        norm <span style="color:#f92672">=</span> deg_inv_sqrt[row] <span style="color:#f92672">*</span> deg_inv_sqrt[col]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Step 4-5: Start propagating messages.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>propagate(edge_index, x<span style="color:#f92672">=</span>x, norm<span style="color:#f92672">=</span>norm)  <span style="color:#75715e">#当我们调用 propagate() 的时候，内部会自动的调用 message() 和 update() 函数，传递的参数是 x 。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">message</span>(self, x_j, norm):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># x_j has shape [E, out_channels]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Step 4: Normalize node features.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> norm<span style="color:#f92672">.</span>view(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> x_j
</span></span></code></pre></div><p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618103522520.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618103522520.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618103522520.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618103522520.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618103522520.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618103522520.png"/></p>
<h5 id="2edge-convolutionhttpspytorch-geometricreadthedocsioenlatestnotescreate_gnnhtmlid3">.2.<a href="https://pytorch-geometric.readthedocs.io/en/latest/notes/create_gnn.html#id3"target="_blank" rel="external nofollow noopener noreferrer">Edge Convolution<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></h5>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618100719167.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618100719167.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618100719167.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618100719167.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618100719167.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618100719167.png"/></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch.nn <span style="color:#f92672">import</span> Sequential <span style="color:#66d9ef">as</span> Seq, Linear, ReLU
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.nn <span style="color:#f92672">import</span> MessagePassing
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EdgeConv</span>(MessagePassing):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, in_channels, out_channels):
</span></span><span style="display:flex;"><span>        super(EdgeConv, self)<span style="color:#f92672">.</span>__init__(aggr<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;max&#39;</span>) <span style="color:#75715e">#  &#34;Max&#34; aggregation.</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>mlp <span style="color:#f92672">=</span> Seq(Linear(<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> in_channels, out_channels),
</span></span><span style="display:flex;"><span>                       ReLU(),
</span></span><span style="display:flex;"><span>                       Linear(out_channels, out_channels))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, x, edge_index):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># x has shape [N, in_channels]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># edge_index has shape [2, E]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>propagate(edge_index, x<span style="color:#f92672">=</span>x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">message</span>(self, x_i, x_j):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># x_i has shape [E, in_channels]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># x_j has shape [E, in_channels]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        tmp <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>cat([x_i, x_j <span style="color:#f92672">-</span> x_i], dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)  <span style="color:#75715e"># tmp has shape [E, 2 * in_channels]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>mlp(tmp)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.nn <span style="color:#f92672">import</span> knn_graph
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DynamicEdgeConv</span>(EdgeConv):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, in_channels, out_channels, k<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>):
</span></span><span style="display:flex;"><span>        super(DynamicEdgeConv, self)<span style="color:#f92672">.</span>__init__(in_channels, out_channels)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>k <span style="color:#f92672">=</span> k
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, x, batch<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        edge_index <span style="color:#f92672">=</span> knn_graph(x, self<span style="color:#f92672">.</span>k, batch, loop<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, flow<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>flow)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> super(DynamicEdgeConv, self)<span style="color:#f92672">.</span>forward(x, edge_index)
</span></span></code></pre></div><h5 id="3-global-pooling">.3. Global Pooling</h5>
<blockquote>
<p>PyG also supports <code>graph-level outputs </code>as opposed to node-level outputs by providing a variety of <code>readout functions such as global add, mean or max pooling</code>. We additionaly offer more sophisticated methods such as set-to-set (Vinyals et al., 2016), sort pooling (Zhang et al., 2018) or the global soft attention layer from Li et al. (2016).</p>
</blockquote>
<h5 id="4-hierarchical-pooling">.4. Hierarchical Pooling</h5>
<blockquote>
<p>To further <code>extract hierarchical information</code> and to allow deeper GNN models, various<code> pooling approaches can be applied in a spatial or data-dependent manner.</code> We currently provide implementation examples for <code>Graclus</code> (Dhillon et al., 2007; Fagginger Auer &amp; Bisseling, 2011) and <code>voxel grid pooling</code> (Simonovsky &amp; Komodakis, 2017), the <code>iterative farthest point sampling algorithm</code> (Qi et al., 2017) followed by <code>k-NN or query ball graph generation</code> (Qi et al., 2017; Wang et al., 2018b), and differentiable pooling mechanisms such as <code>DiffPool</code> (Ying et al., 2018) and<code> topk pooling</code> (Gao &amp; Ji, 2018; Cangea et al., 2018)</p>
</blockquote>
<h3 id="4--application">4.  Application</h3>
<blockquote>
<p>epidemiological forecasting, ride-hail demand prediction, web-traffic management, document labeling, fraud detection, traffic forecasting, chem-informatics systems</p>
</blockquote>
<h4 id="1-epidemiological-forecasting">.1. Epidemiological Forecasting</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric_temporal.dataset <span style="color:#f92672">import</span> ChickenpoxDatasetLoader
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric_temporal.signal <span style="color:#f92672">import</span> temporal_signal_split
</span></span><span style="display:flex;"><span>loader <span style="color:#f92672">=</span> ChickenpoxDatasetLoader()
</span></span><span style="display:flex;"><span>dataset <span style="color:#f92672">=</span> loader<span style="color:#f92672">.</span>get_dataset()
</span></span><span style="display:flex;"><span>train_dataset, test_dataset <span style="color:#f92672">=</span> temporal_signal_split(dataset, train_ratio<span style="color:#f92672">=</span><span style="color:#ae81ff">0.2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch.nn.functional <span style="color:#66d9ef">as</span> F
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric_temporal.nn.recurrent <span style="color:#f92672">import</span> DCRNN
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RecurrentGCN</span>(torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, node_features):
</span></span><span style="display:flex;"><span>        super(RecurrentGCN, self)<span style="color:#f92672">.</span>__init__()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>recurrent <span style="color:#f92672">=</span> DCRNN(node_features, <span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>linear <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Linear(<span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, x, edge_index, edge_weight):
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>recurrent(x, edge_index, edge_weight)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>relu(h)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>linear(h)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> tqdm <span style="color:#f92672">import</span> tqdm
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> RecurrentGCN(node_features <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>optimizer <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>Adam(model<span style="color:#f92672">.</span>parameters(), lr<span style="color:#f92672">=</span><span style="color:#ae81ff">0.01</span>)
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>train()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> tqdm(range(<span style="color:#ae81ff">200</span>)):
</span></span><span style="display:flex;"><span>    cost <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> time, snapshot <span style="color:#f92672">in</span> enumerate(train_dataset):
</span></span><span style="display:flex;"><span>        y_hat <span style="color:#f92672">=</span> model(snapshot<span style="color:#f92672">.</span>x, snapshot<span style="color:#f92672">.</span>edge_index, snapshot<span style="color:#f92672">.</span>edge_attr)
</span></span><span style="display:flex;"><span>        cost <span style="color:#f92672">=</span> cost <span style="color:#f92672">+</span> torch<span style="color:#f92672">.</span>mean((y_hat<span style="color:#f92672">-</span>snapshot<span style="color:#f92672">.</span>y)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    cost <span style="color:#f92672">=</span> cost <span style="color:#f92672">/</span> (time<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    cost<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>    optimizer<span style="color:#f92672">.</span>step()
</span></span><span style="display:flex;"><span>    optimizer<span style="color:#f92672">.</span>zero_grad()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>eval()
</span></span><span style="display:flex;"><span>cost <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> time, snapshot <span style="color:#f92672">in</span> enumerate(test_dataset):
</span></span><span style="display:flex;"><span>    y_hat <span style="color:#f92672">=</span> model(snapshot<span style="color:#f92672">.</span>x, snapshot<span style="color:#f92672">.</span>edge_index, snapshot<span style="color:#f92672">.</span>edge_attr)
</span></span><span style="display:flex;"><span>    cost <span style="color:#f92672">=</span> cost <span style="color:#f92672">+</span> torch<span style="color:#f92672">.</span>mean((y_hat<span style="color:#f92672">-</span>snapshot<span style="color:#f92672">.</span>y)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>cost <span style="color:#f92672">=</span> cost <span style="color:#f92672">/</span> (time<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>cost <span style="color:#f92672">=</span> cost<span style="color:#f92672">.</span>item()
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;MSE: </span><span style="color:#e6db74">{:.4f}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(cost))
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> MSE: <span style="color:#ae81ff">0.6866</span>
</span></span></code></pre></div><h4 id="2-web-traffic-prediction">.2. Web Traffic Prediction</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric_temporal.dataset <span style="color:#f92672">import</span> WikiMathsDatasetLoader
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric_temporal.signal <span style="color:#f92672">import</span> temporal_signal_split
</span></span><span style="display:flex;"><span>loader <span style="color:#f92672">=</span> WikiMathsDatasetLoader()
</span></span><span style="display:flex;"><span>dataset <span style="color:#f92672">=</span> loader<span style="color:#f92672">.</span>get_dataset(lags<span style="color:#f92672">=</span><span style="color:#ae81ff">14</span>)
</span></span><span style="display:flex;"><span>train_dataset, test_dataset <span style="color:#f92672">=</span> temporal_signal_split(dataset, train_ratio<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch.nn.functional <span style="color:#66d9ef">as</span> F
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric_temporal.nn.recurrent <span style="color:#f92672">import</span> GConvGRU
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RecurrentGCN</span>(torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, node_features, filters):
</span></span><span style="display:flex;"><span>        super(RecurrentGCN, self)<span style="color:#f92672">.</span>__init__()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>recurrent <span style="color:#f92672">=</span> GConvGRU(node_features, filters, <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>linear <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Linear(filters, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, x, edge_index, edge_weight):
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>recurrent(x, edge_index, edge_weight)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>relu(h)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>linear(h)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> tqdm <span style="color:#f92672">import</span> tqdm
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> RecurrentGCN(node_features<span style="color:#f92672">=</span><span style="color:#ae81ff">14</span>, filters<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>optimizer <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>Adam(model<span style="color:#f92672">.</span>parameters(), lr<span style="color:#f92672">=</span><span style="color:#ae81ff">0.01</span>)
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>train()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> tqdm(range(<span style="color:#ae81ff">50</span>)):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> time, snapshot <span style="color:#f92672">in</span> enumerate(train_dataset):
</span></span><span style="display:flex;"><span>        y_hat <span style="color:#f92672">=</span> model(snapshot<span style="color:#f92672">.</span>x, snapshot<span style="color:#f92672">.</span>edge_index, snapshot<span style="color:#f92672">.</span>edge_attr)
</span></span><span style="display:flex;"><span>        cost <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>mean((y_hat<span style="color:#f92672">-</span>snapshot<span style="color:#f92672">.</span>y)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>        cost<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>        optimizer<span style="color:#f92672">.</span>step()
</span></span><span style="display:flex;"><span>        optimizer<span style="color:#f92672">.</span>zero_grad()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>eval()
</span></span><span style="display:flex;"><span>cost <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> time, snapshot <span style="color:#f92672">in</span> enumerate(test_dataset):
</span></span><span style="display:flex;"><span>    y_hat <span style="color:#f92672">=</span> model(snapshot<span style="color:#f92672">.</span>x, snapshot<span style="color:#f92672">.</span>edge_index, snapshot<span style="color:#f92672">.</span>edge_attr)
</span></span><span style="display:flex;"><span>    cost <span style="color:#f92672">=</span> cost <span style="color:#f92672">+</span> torch<span style="color:#f92672">.</span>mean((y_hat<span style="color:#f92672">-</span>snapshot<span style="color:#f92672">.</span>y)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>cost <span style="color:#f92672">=</span> cost <span style="color:#f92672">/</span> (time<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>cost <span style="color:#f92672">=</span> cost<span style="color:#f92672">.</span>item()
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;MSE: </span><span style="color:#e6db74">{:.4f}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(cost))
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> MSE: <span style="color:#ae81ff">0.7760</span>
</span></span></code></pre></div><h4 id="3-cora-2layergcn">.3. Cora 2layerGCN</h4>
<blockquote>
<p>一个epoch中的一个data包含一个完整的数据集</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.datasets <span style="color:#f92672">import</span> Planetoid
</span></span><span style="display:flex;"><span>dataset <span style="color:#f92672">=</span> Planetoid(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/tmp/Cora&#39;</span>, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Cora&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch.nn.functional <span style="color:#66d9ef">as</span> F
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.nn <span style="color:#f92672">import</span> GCNConv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Net</span>(torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self):
</span></span><span style="display:flex;"><span>        super(Net, self)<span style="color:#f92672">.</span>__init__()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>conv1 <span style="color:#f92672">=</span> GCNConv(dataset<span style="color:#f92672">.</span>num_node_features, <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>conv2 <span style="color:#f92672">=</span> GCNConv(<span style="color:#ae81ff">16</span>, dataset<span style="color:#f92672">.</span>num_classes)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, data):
</span></span><span style="display:flex;"><span>        x, edge_index <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>x, data<span style="color:#f92672">.</span>edge_index
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>conv1(x, edge_index)
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>relu(x)
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>dropout(x, training<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>training)
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>conv2(x, edge_index)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> F<span style="color:#f92672">.</span>log_softmax(x, dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>device <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>device(<span style="color:#e6db74">&#39;cuda&#39;</span> <span style="color:#66d9ef">if</span> torch<span style="color:#f92672">.</span>cuda<span style="color:#f92672">.</span>is_available() <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#39;cpu&#39;</span>)
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> Net()<span style="color:#f92672">.</span>to(device)
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> dataset[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>to(device)
</span></span><span style="display:flex;"><span>optimizer <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>Adam(model<span style="color:#f92672">.</span>parameters(), lr<span style="color:#f92672">=</span><span style="color:#ae81ff">0.01</span>, weight_decay<span style="color:#f92672">=</span><span style="color:#ae81ff">5e-4</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>train()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">200</span>):
</span></span><span style="display:flex;"><span>    optimizer<span style="color:#f92672">.</span>zero_grad()
</span></span><span style="display:flex;"><span>    out <span style="color:#f92672">=</span> model(data)
</span></span><span style="display:flex;"><span>    loss <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>nll_loss(out[data<span style="color:#f92672">.</span>train_mask], data<span style="color:#f92672">.</span>y[data<span style="color:#f92672">.</span>train_mask])
</span></span><span style="display:flex;"><span>    loss<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>    optimizer<span style="color:#f92672">.</span>step()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>eval()
</span></span><span style="display:flex;"><span>_, pred <span style="color:#f92672">=</span> model(data)<span style="color:#f92672">.</span>max(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>correct <span style="color:#f92672">=</span> int(pred[data<span style="color:#f92672">.</span>test_mask]<span style="color:#f92672">.</span>eq(data<span style="color:#f92672">.</span>y[data<span style="color:#f92672">.</span>test_mask])<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>item())
</span></span><span style="display:flex;"><span>acc <span style="color:#f92672">=</span> correct <span style="color:#f92672">/</span> int(data<span style="color:#f92672">.</span>test_mask<span style="color:#f92672">.</span>sum())
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;Accuracy: </span><span style="color:#e6db74">{:.4f}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(acc))
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> Accuracy: <span style="color:#ae81ff">0.8150</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch.nn.functional <span style="color:#66d9ef">as</span> F
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.nn <span style="color:#f92672">import</span> GCNConv
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch_geometric.transforms <span style="color:#66d9ef">as</span> T
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.datasets <span style="color:#f92672">import</span> Planetoid
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dataset <span style="color:#f92672">=</span> Planetoid(<span style="color:#e6db74">&#34;Planetoid&#34;</span>, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Cora&#34;</span>, transform<span style="color:#f92672">=</span>T<span style="color:#f92672">.</span>ToSparseTensor())
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> dataset[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> Data(adj_t<span style="color:#f92672">=</span>[<span style="color:#ae81ff">2708</span>, <span style="color:#ae81ff">2708</span>, nnz<span style="color:#f92672">=</span><span style="color:#ae81ff">10556</span>], x<span style="color:#f92672">=</span>[<span style="color:#ae81ff">2708</span>, <span style="color:#ae81ff">1433</span>], y<span style="color:#f92672">=</span>[<span style="color:#ae81ff">2708</span>], <span style="color:#f92672">...</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Net</span>(torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self):
</span></span><span style="display:flex;"><span>        super(Net, self)<span style="color:#f92672">.</span>__init__()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>conv1 <span style="color:#f92672">=</span> GCNConv(dataset<span style="color:#f92672">.</span>num_features, <span style="color:#ae81ff">16</span>, cached<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>conv2 <span style="color:#f92672">=</span> GCNConv(<span style="color:#ae81ff">16</span>, dataset<span style="color:#f92672">.</span>num_classes, cached<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, x, adj_t):
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>conv1(x, adj_t)
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>relu(x)
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>conv2(x, adj_t)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> F<span style="color:#f92672">.</span>log_softmax(x, dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> Net()
</span></span><span style="display:flex;"><span>optimizer <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>Adam(model<span style="color:#f92672">.</span>parameters(), lr<span style="color:#f92672">=</span><span style="color:#ae81ff">0.01</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train</span>(data):
</span></span><span style="display:flex;"><span>    model<span style="color:#f92672">.</span>train()
</span></span><span style="display:flex;"><span>    optimizer<span style="color:#f92672">.</span>zero_grad()
</span></span><span style="display:flex;"><span>    out <span style="color:#f92672">=</span> model(data<span style="color:#f92672">.</span>x, data<span style="color:#f92672">.</span>adj_t)
</span></span><span style="display:flex;"><span>    loss <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>nll_loss(out, data<span style="color:#f92672">.</span>y)
</span></span><span style="display:flex;"><span>    loss<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>    optimizer<span style="color:#f92672">.</span>step()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> float(loss)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">201</span>):
</span></span><span style="display:flex;"><span>    loss <span style="color:#f92672">=</span> train(data)
</span></span></code></pre></div><h4 id="4-karate-club">.4. karate club</h4>
<blockquote>
<p><strong>Zachary&rsquo;s karate club</strong> is a social network of a university karate club, described in the paper &ldquo;An Information Flow Model for Conflict and Fission in Small Groups&rdquo; by Wayne W. Zachary. The network became a popular example of <a href="https://en.wikipedia.org/wiki/Community_structure"target="_blank" rel="external nofollow noopener noreferrer">community structure<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> in networks after its use by <a href="https://en.wikipedia.org/wiki/Michelle_Girvan"target="_blank" rel="external nofollow noopener noreferrer">Michelle Girvan<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> and <a href="https://en.wikipedia.org/wiki/Mark_Newman"target="_blank" rel="external nofollow noopener noreferrer">Mark Newman<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> in 2002.[<a href="https://en.wikipedia.org/wiki/Zachary%27s_karate_club#cite_note-GN-1"target="_blank" rel="external nofollow noopener noreferrer">1]<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
</blockquote>
<ul>
<li><strong>Node Classification</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.datasets <span style="color:#f92672">import</span> KarateClub
</span></span><span style="display:flex;"><span>dataset <span style="color:#f92672">=</span> KarateClub()  <span style="color:#75715e">#1 graph, number of features: 34, classes:4, which represent the community each node belongs to.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Data(edge_index=[2, 156], train_mask=[34], x=[34, 34], y=[34])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch.nn <span style="color:#f92672">import</span> Linear
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.nn <span style="color:#f92672">import</span> GCNConv
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GCN</span>(torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self):
</span></span><span style="display:flex;"><span>        super(GCN, self)<span style="color:#f92672">.</span>__init__()
</span></span><span style="display:flex;"><span>        torch<span style="color:#f92672">.</span>manual_seed(<span style="color:#ae81ff">12345</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>conv1 <span style="color:#f92672">=</span> GCNConv(dataset<span style="color:#f92672">.</span>num_features, <span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>conv2 <span style="color:#f92672">=</span> GCNConv(<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>conv3 <span style="color:#f92672">=</span> GCNConv(<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>classifier <span style="color:#f92672">=</span> Linear(<span style="color:#ae81ff">2</span>, dataset<span style="color:#f92672">.</span>num_classes)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, x, edge_index):
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>conv1(x, edge_index)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> h<span style="color:#f92672">.</span>tanh()
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>conv2(h, edge_index)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> h<span style="color:#f92672">.</span>tanh()
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>conv3(h, edge_index)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> h<span style="color:#f92672">.</span>tanh()  <span style="color:#75715e"># Final GNN embedding space.</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Apply a final (linear) classifier.</span>
</span></span><span style="display:flex;"><span>        out <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>classifier(h)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> out, h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> GCN()  <span style="color:#75715e">#34→4→4→2-&gt;num_classes, 每一个row表示一个节点，对每一个节点进行分类</span>
</span></span><span style="display:flex;"><span>print(model)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> GCN()
</span></span><span style="display:flex;"><span>_, h <span style="color:#f92672">=</span> model(data<span style="color:#f92672">.</span>x, data<span style="color:#f92672">.</span>edge_index)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Embedding shape: </span><span style="color:#e6db74">{</span>list(h<span style="color:#f92672">.</span>shape)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>visualize(h, color<span style="color:#f92672">=</span>data<span style="color:#f92672">.</span>y)  <span style="color:#75715e">#h:&lt;class &#39;torch.Tensor&#39;&gt;, grad_fn=&lt;TanhBackward&gt;) torch.Size([34, 2]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> IPython.display <span style="color:#f92672">import</span> Javascript  <span style="color:#75715e"># Restrict height of output cell.</span>
</span></span><span style="display:flex;"><span>display(Javascript(<span style="color:#e6db74">&#39;&#39;&#39;google.colab.output.setIframeHeight(0, true, </span><span style="color:#e6db74">{maxHeight: 430}</span><span style="color:#e6db74">)&#39;&#39;&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> GCN()
</span></span><span style="display:flex;"><span>criterion <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>CrossEntropyLoss()  <span style="color:#75715e"># Define loss criterion.</span>
</span></span><span style="display:flex;"><span>optimizer <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>Adam(model<span style="color:#f92672">.</span>parameters(), lr<span style="color:#f92672">=</span><span style="color:#ae81ff">0.01</span>)  <span style="color:#75715e"># Define optimizer.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train</span>(data):
</span></span><span style="display:flex;"><span>    optimizer<span style="color:#f92672">.</span>zero_grad()  <span style="color:#75715e"># Clear gradients.</span>
</span></span><span style="display:flex;"><span>    out, h <span style="color:#f92672">=</span> model(data<span style="color:#f92672">.</span>x, data<span style="color:#f92672">.</span>edge_index)  <span style="color:#75715e"># Perform a single forward pass.</span>
</span></span><span style="display:flex;"><span>    loss <span style="color:#f92672">=</span> criterion(out[data<span style="color:#f92672">.</span>train_mask], data<span style="color:#f92672">.</span>y[data<span style="color:#f92672">.</span>train_mask])  <span style="color:#75715e"># Compute the loss solely based on the training nodes.</span>
</span></span><span style="display:flex;"><span>    loss<span style="color:#f92672">.</span>backward()  <span style="color:#75715e"># Derive gradients.</span>
</span></span><span style="display:flex;"><span>    optimizer<span style="color:#f92672">.</span>step()  <span style="color:#75715e"># Update parameters based on gradients.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> loss, h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">401</span>):
</span></span><span style="display:flex;"><span>    loss, h <span style="color:#f92672">=</span> train(data)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> epoch <span style="color:#f92672">%</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>        visualize(h, color<span style="color:#f92672">=</span>data<span style="color:#f92672">.</span>y, epoch<span style="color:#f92672">=</span>epoch, loss<span style="color:#f92672">=</span>loss)
</span></span><span style="display:flex;"><span>        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">0.3</span>)
</span></span></code></pre></div><h4 id="5-planetoidhttpscolabresearchgooglecomdrive14ovfnaxggxb8vm4e8vsurup1taknovzxuspsharingscrollto9r_vmgmukf5r">.5. <a href="https://colab.research.google.com/drive/14OvFnAXggxB8vM4e8vSURUp1TaKnovzX?usp=sharing#scrollTo=9r_VmGMukf5R"target="_blank" rel="external nofollow noopener noreferrer">Planetoid<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></h4>
<ul>
<li><strong>Node Classification</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.datasets <span style="color:#f92672">import</span> Planetoid
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.transforms <span style="color:#f92672">import</span> NormalizeFeatures
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dataset <span style="color:#f92672">=</span> Planetoid(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;data/Planetoid&#39;</span>, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Cora&#39;</span>, transform<span style="color:#f92672">=</span>NormalizeFeatures())
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Data(edge_index=[2, 10556], test_mask=[2708], train_mask=[2708], val_mask=[2708], x=[2708, 1433], y=[2708])</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Number of classes: 7</span>
</span></span></code></pre></div><ul>
<li><strong>MLP</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch.nn <span style="color:#f92672">import</span> Linear
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch.nn.functional <span style="color:#66d9ef">as</span> F
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MLP</span>(torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, hidden_channels):
</span></span><span style="display:flex;"><span>        super(MLP, self)<span style="color:#f92672">.</span>__init__()
</span></span><span style="display:flex;"><span>        torch<span style="color:#f92672">.</span>manual_seed(<span style="color:#ae81ff">12345</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>lin1 <span style="color:#f92672">=</span> Linear(dataset<span style="color:#f92672">.</span>num_features, hidden_channels)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>lin2 <span style="color:#f92672">=</span> Linear(hidden_channels, dataset<span style="color:#f92672">.</span>num_classes)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, x):
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>lin1(x)
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>relu()
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>dropout(x, p<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>, training<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>training)
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>lin2(x)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> x
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> MLP(hidden_channels<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>print(model)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> IPython.display <span style="color:#f92672">import</span> Javascript  <span style="color:#75715e"># Restrict height of output cell.</span>
</span></span><span style="display:flex;"><span>display(Javascript(<span style="color:#e6db74">&#39;&#39;&#39;google.colab.output.setIframeHeight(0, true, </span><span style="color:#e6db74">{maxHeight: 300}</span><span style="color:#e6db74">)&#39;&#39;&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> MLP(hidden_channels<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>criterion <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>CrossEntropyLoss()  <span style="color:#75715e"># Define loss criterion.</span>
</span></span><span style="display:flex;"><span>optimizer <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>Adam(model<span style="color:#f92672">.</span>parameters(), lr<span style="color:#f92672">=</span><span style="color:#ae81ff">0.01</span>, weight_decay<span style="color:#f92672">=</span><span style="color:#ae81ff">5e-4</span>)  <span style="color:#75715e"># Define optimizer.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train</span>():
</span></span><span style="display:flex;"><span>      model<span style="color:#f92672">.</span>train()
</span></span><span style="display:flex;"><span>      optimizer<span style="color:#f92672">.</span>zero_grad()  <span style="color:#75715e"># Clear gradients.</span>
</span></span><span style="display:flex;"><span>      out <span style="color:#f92672">=</span> model(data<span style="color:#f92672">.</span>x)  <span style="color:#75715e"># Perform a single forward pass.</span>
</span></span><span style="display:flex;"><span>      loss <span style="color:#f92672">=</span> criterion(out[data<span style="color:#f92672">.</span>train_mask], data<span style="color:#f92672">.</span>y[data<span style="color:#f92672">.</span>train_mask])  <span style="color:#75715e"># Compute the loss solely based on the training nodes.</span>
</span></span><span style="display:flex;"><span>      loss<span style="color:#f92672">.</span>backward()  <span style="color:#75715e"># Derive gradients.</span>
</span></span><span style="display:flex;"><span>      optimizer<span style="color:#f92672">.</span>step()  <span style="color:#75715e"># Update parameters based on gradients.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> loss
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test</span>():
</span></span><span style="display:flex;"><span>      model<span style="color:#f92672">.</span>eval()
</span></span><span style="display:flex;"><span>      out <span style="color:#f92672">=</span> model(data<span style="color:#f92672">.</span>x)
</span></span><span style="display:flex;"><span>      pred <span style="color:#f92672">=</span> out<span style="color:#f92672">.</span>argmax(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)  <span style="color:#75715e"># Use the class with highest probability.</span>
</span></span><span style="display:flex;"><span>      test_correct <span style="color:#f92672">=</span> pred[data<span style="color:#f92672">.</span>test_mask] <span style="color:#f92672">==</span> data<span style="color:#f92672">.</span>y[data<span style="color:#f92672">.</span>test_mask]  <span style="color:#75715e"># Check against ground-truth labels.</span>
</span></span><span style="display:flex;"><span>      test_acc <span style="color:#f92672">=</span> int(test_correct<span style="color:#f92672">.</span>sum()) <span style="color:#f92672">/</span> int(data<span style="color:#f92672">.</span>test_mask<span style="color:#f92672">.</span>sum())  <span style="color:#75715e"># Derive ratio of correct predictions.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> test_acc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">201</span>):
</span></span><span style="display:flex;"><span>    loss <span style="color:#f92672">=</span> train()
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Epoch: </span><span style="color:#e6db74">{</span>epoch<span style="color:#e6db74">:</span><span style="color:#e6db74">03d</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, Loss: </span><span style="color:#e6db74">{</span>loss<span style="color:#e6db74">:</span><span style="color:#e6db74">.4f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span></code></pre></div><ul>
<li><strong>GCN</strong></li>
</ul>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618121248908.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618121248908.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618121248908.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618121248908.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618121248908.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618121248908.png"/></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.nn <span style="color:#f92672">import</span> GCNConv
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GCN</span>(torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, hidden_channels):
</span></span><span style="display:flex;"><span>        super(GCN, self)<span style="color:#f92672">.</span>__init__()
</span></span><span style="display:flex;"><span>        torch<span style="color:#f92672">.</span>manual_seed(<span style="color:#ae81ff">12345</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>conv1 <span style="color:#f92672">=</span> GCNConv(dataset<span style="color:#f92672">.</span>num_features, hidden_channels)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>conv2 <span style="color:#f92672">=</span> GCNConv(hidden_channels, dataset<span style="color:#f92672">.</span>num_classes)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, x, edge_index):
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>conv1(x, edge_index)
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>relu()
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>dropout(x, p<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>, training<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>training)
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>conv2(x, edge_index)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> x
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> GCN(hidden_channels<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>print(model)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> IPython.display <span style="color:#f92672">import</span> Javascript  <span style="color:#75715e"># Restrict height of output cell.</span>
</span></span><span style="display:flex;"><span>display(Javascript(<span style="color:#e6db74">&#39;&#39;&#39;google.colab.output.setIframeHeight(0, true, </span><span style="color:#e6db74">{maxHeight: 300}</span><span style="color:#e6db74">)&#39;&#39;&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> GCN(hidden_channels<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>optimizer <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>Adam(model<span style="color:#f92672">.</span>parameters(), lr<span style="color:#f92672">=</span><span style="color:#ae81ff">0.01</span>, weight_decay<span style="color:#f92672">=</span><span style="color:#ae81ff">5e-4</span>)
</span></span><span style="display:flex;"><span>criterion <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>CrossEntropyLoss()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train</span>():
</span></span><span style="display:flex;"><span>      model<span style="color:#f92672">.</span>train()
</span></span><span style="display:flex;"><span>      optimizer<span style="color:#f92672">.</span>zero_grad()  <span style="color:#75715e"># Clear gradients.</span>
</span></span><span style="display:flex;"><span>      out <span style="color:#f92672">=</span> model(data<span style="color:#f92672">.</span>x, data<span style="color:#f92672">.</span>edge_index)  <span style="color:#75715e"># Perform a single forward pass.</span>
</span></span><span style="display:flex;"><span>      loss <span style="color:#f92672">=</span> criterion(out[data<span style="color:#f92672">.</span>train_mask], data<span style="color:#f92672">.</span>y[data<span style="color:#f92672">.</span>train_mask])  <span style="color:#75715e"># Compute the loss solely based on the training nodes.</span>
</span></span><span style="display:flex;"><span>      loss<span style="color:#f92672">.</span>backward()  <span style="color:#75715e"># Derive gradients.</span>
</span></span><span style="display:flex;"><span>      optimizer<span style="color:#f92672">.</span>step()  <span style="color:#75715e"># Update parameters based on gradients.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> loss
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test</span>():
</span></span><span style="display:flex;"><span>      model<span style="color:#f92672">.</span>eval()
</span></span><span style="display:flex;"><span>      out <span style="color:#f92672">=</span> model(data<span style="color:#f92672">.</span>x, data<span style="color:#f92672">.</span>edge_index)
</span></span><span style="display:flex;"><span>      pred <span style="color:#f92672">=</span> out<span style="color:#f92672">.</span>argmax(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)  <span style="color:#75715e"># Use the class with highest probability.</span>
</span></span><span style="display:flex;"><span>      test_correct <span style="color:#f92672">=</span> pred[data<span style="color:#f92672">.</span>test_mask] <span style="color:#f92672">==</span> data<span style="color:#f92672">.</span>y[data<span style="color:#f92672">.</span>test_mask]  <span style="color:#75715e"># Check against ground-truth labels.</span>
</span></span><span style="display:flex;"><span>      test_acc <span style="color:#f92672">=</span> int(test_correct<span style="color:#f92672">.</span>sum()) <span style="color:#f92672">/</span> int(data<span style="color:#f92672">.</span>test_mask<span style="color:#f92672">.</span>sum())  <span style="color:#75715e"># Derive ratio of correct predictions.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> test_acc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">201</span>):
</span></span><span style="display:flex;"><span>    loss <span style="color:#f92672">=</span> train()
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Epoch: </span><span style="color:#e6db74">{</span>epoch<span style="color:#e6db74">:</span><span style="color:#e6db74">03d</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, Loss: </span><span style="color:#e6db74">{</span>loss<span style="color:#e6db74">:</span><span style="color:#e6db74">.4f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span></code></pre></div><h4 id="6-tuddataset">.6. TUDdataset</h4>
<ul>
<li><strong>Graph classification</strong></li>
</ul>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618131022161.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618131022161.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618131022161.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618131022161.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618131022161.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618131022161.png"/></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.datasets <span style="color:#f92672">import</span> TUDataset
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dataset <span style="color:#f92672">=</span> TUDataset(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;data/TUDataset&#39;</span>, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;MUTAG&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Data(edge_attr=[38, 4], edge_index=[2, 38], x=[17, 7], y=[1])</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Number of graphs: 188</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Number of features: 7</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Number of classes: 2</span>
</span></span><span style="display:flex;"><span>torch<span style="color:#f92672">.</span>manual_seed(<span style="color:#ae81ff">12345</span>)
</span></span><span style="display:flex;"><span>dataset <span style="color:#f92672">=</span> dataset<span style="color:#f92672">.</span>shuffle()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>train_dataset <span style="color:#f92672">=</span> dataset[:<span style="color:#ae81ff">150</span>]
</span></span><span style="display:flex;"><span>test_dataset <span style="color:#f92672">=</span> dataset[<span style="color:#ae81ff">150</span>:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.data <span style="color:#f92672">import</span> DataLoader
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>train_loader <span style="color:#f92672">=</span> DataLoader(train_dataset, batch_size<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span>, shuffle<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>test_loader <span style="color:#f92672">=</span> DataLoader(test_dataset, batch_size<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span>, shuffle<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> step, data <span style="color:#f92672">in</span> enumerate(train_loader):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Step </span><span style="color:#e6db74">{</span>step <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">}</span><span style="color:#e6db74">:&#39;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;=======&#39;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Number of graphs in the current batch: </span><span style="color:#e6db74">{</span>data<span style="color:#f92672">.</span>num_graphs<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>    print(data) <span style="color:#75715e">#Batch(batch=[1169], edge_attr=[2592, 4], edge_index=[2, 2592], x=[1169, 7], y=[64])</span>
</span></span><span style="display:flex;"><span>    print()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch.nn <span style="color:#f92672">import</span> Linear
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch.nn.functional <span style="color:#66d9ef">as</span> F
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.nn <span style="color:#f92672">import</span> GCNConv
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.nn <span style="color:#f92672">import</span> global_mean_pool
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GCN</span>(torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, hidden_channels):
</span></span><span style="display:flex;"><span>        super(GCN, self)<span style="color:#f92672">.</span>__init__()
</span></span><span style="display:flex;"><span>        torch<span style="color:#f92672">.</span>manual_seed(<span style="color:#ae81ff">12345</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>conv1 <span style="color:#f92672">=</span> GCNConv(dataset<span style="color:#f92672">.</span>num_node_features, hidden_channels)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>conv2 <span style="color:#f92672">=</span> GCNConv(hidden_channels, hidden_channels)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>conv3 <span style="color:#f92672">=</span> GCNConv(hidden_channels, hidden_channels)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>lin <span style="color:#f92672">=</span> Linear(hidden_channels, dataset<span style="color:#f92672">.</span>num_classes)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, x, edge_index, batch):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 1. Obtain node embeddings </span>
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>conv1(x, edge_index)
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>relu()
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>conv2(x, edge_index)
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>relu()
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>conv3(x, edge_index)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 2. Readout layer</span>
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> global_mean_pool(x, batch)  <span style="color:#75715e"># [batch_size, hidden_channels]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 3. Apply a final classifier</span>
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>dropout(x, p<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>, training<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>training)
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>lin(x)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> x
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> GCN(hidden_channels<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>print(model)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#GCN(</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  (conv1): GCNConv(7, 64)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  (conv2): GCNConv(64, 64)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  (conv3): GCNConv(64, 64)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  (lin): Linear(in_features=64, out_features=2, bias=True)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> IPython.display <span style="color:#f92672">import</span> Javascript
</span></span><span style="display:flex;"><span>display(Javascript(<span style="color:#e6db74">&#39;&#39;&#39;google.colab.output.setIframeHeight(0, true, </span><span style="color:#e6db74">{maxHeight: 300}</span><span style="color:#e6db74">)&#39;&#39;&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> GCN(hidden_channels<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>optimizer <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>Adam(model<span style="color:#f92672">.</span>parameters(), lr<span style="color:#f92672">=</span><span style="color:#ae81ff">0.01</span>)
</span></span><span style="display:flex;"><span>criterion <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>CrossEntropyLoss()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train</span>():
</span></span><span style="display:flex;"><span>    model<span style="color:#f92672">.</span>train()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> data <span style="color:#f92672">in</span> train_loader:  <span style="color:#75715e"># Iterate in batches over the training dataset.</span>
</span></span><span style="display:flex;"><span>         out <span style="color:#f92672">=</span> model(data<span style="color:#f92672">.</span>x, data<span style="color:#f92672">.</span>edge_index, data<span style="color:#f92672">.</span>batch)  <span style="color:#75715e"># Perform a single forward pass.</span>
</span></span><span style="display:flex;"><span>         loss <span style="color:#f92672">=</span> criterion(out, data<span style="color:#f92672">.</span>y)  <span style="color:#75715e"># Compute the loss.</span>
</span></span><span style="display:flex;"><span>         loss<span style="color:#f92672">.</span>backward()  <span style="color:#75715e"># Derive gradients.</span>
</span></span><span style="display:flex;"><span>         optimizer<span style="color:#f92672">.</span>step()  <span style="color:#75715e"># Update parameters based on gradients.</span>
</span></span><span style="display:flex;"><span>         optimizer<span style="color:#f92672">.</span>zero_grad()  <span style="color:#75715e"># Clear gradients.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test</span>(loader):
</span></span><span style="display:flex;"><span>     model<span style="color:#f92672">.</span>eval()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     correct <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">for</span> data <span style="color:#f92672">in</span> loader:  <span style="color:#75715e"># Iterate in batches over the training/test dataset.</span>
</span></span><span style="display:flex;"><span>         out <span style="color:#f92672">=</span> model(data<span style="color:#f92672">.</span>x, data<span style="color:#f92672">.</span>edge_index, data<span style="color:#f92672">.</span>batch)  
</span></span><span style="display:flex;"><span>         pred <span style="color:#f92672">=</span> out<span style="color:#f92672">.</span>argmax(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)  <span style="color:#75715e"># Use the class with highest probability.</span>
</span></span><span style="display:flex;"><span>         correct <span style="color:#f92672">+=</span> int((pred <span style="color:#f92672">==</span> data<span style="color:#f92672">.</span>y)<span style="color:#f92672">.</span>sum())  <span style="color:#75715e"># Check against ground-truth labels.</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">return</span> correct <span style="color:#f92672">/</span> len(loader<span style="color:#f92672">.</span>dataset)  <span style="color:#75715e"># Derive ratio of correct predictions.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">201</span>):
</span></span><span style="display:flex;"><span>    train()
</span></span><span style="display:flex;"><span>    train_acc <span style="color:#f92672">=</span> test(train_loader)
</span></span><span style="display:flex;"><span>    test_acc <span style="color:#f92672">=</span> test(test_loader)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Epoch: </span><span style="color:#e6db74">{</span>epoch<span style="color:#e6db74">:</span><span style="color:#e6db74">03d</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, Train Acc: </span><span style="color:#e6db74">{</span>train_acc<span style="color:#e6db74">:</span><span style="color:#e6db74">.4f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, Test Acc: </span><span style="color:#e6db74">{</span>test_acc<span style="color:#e6db74">:</span><span style="color:#e6db74">.4f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span></code></pre></div><h4 id="7-pointcloudclassification">.7. PointCloudClassification</h4>
<ul>
<li>GeometricShapes</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Install required packages.</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">!</span>pip install <span style="color:#f92672">-</span>q torch<span style="color:#f92672">-</span>scatter <span style="color:#f92672">-</span>f https:<span style="color:#f92672">//</span>pytorch<span style="color:#f92672">-</span>geometric<span style="color:#f92672">.</span>com<span style="color:#f92672">/</span>whl<span style="color:#f92672">/</span>torch<span style="color:#f92672">-</span><span style="color:#ae81ff">1.8.0</span><span style="color:#f92672">+</span>cu101<span style="color:#f92672">.</span>html
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">!</span>pip install <span style="color:#f92672">-</span>q torch<span style="color:#f92672">-</span>sparse <span style="color:#f92672">-</span>f https:<span style="color:#f92672">//</span>pytorch<span style="color:#f92672">-</span>geometric<span style="color:#f92672">.</span>com<span style="color:#f92672">/</span>whl<span style="color:#f92672">/</span>torch<span style="color:#f92672">-</span><span style="color:#ae81ff">1.8.0</span><span style="color:#f92672">+</span>cu101<span style="color:#f92672">.</span>html
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">!</span>pip install <span style="color:#f92672">-</span>q torch<span style="color:#f92672">-</span>cluster <span style="color:#f92672">-</span>f https:<span style="color:#f92672">//</span>pytorch<span style="color:#f92672">-</span>geometric<span style="color:#f92672">.</span>com<span style="color:#f92672">/</span>whl<span style="color:#f92672">/</span>torch<span style="color:#f92672">-</span><span style="color:#ae81ff">1.8.0</span><span style="color:#f92672">+</span>cu101<span style="color:#f92672">.</span>html
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">!</span>pip install <span style="color:#f92672">-</span>q torch<span style="color:#f92672">-</span>geometric
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Helper functions for visualization.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span>matplotlib inline
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> mpl_toolkits.mplot3d <span style="color:#f92672">import</span> Axes3D
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visualize_mesh</span>(pos, face):
</span></span><span style="display:flex;"><span>    fig <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure()
</span></span><span style="display:flex;"><span>    ax <span style="color:#f92672">=</span> fig<span style="color:#f92672">.</span>gca(projection<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;3d&#39;</span>)
</span></span><span style="display:flex;"><span>    ax<span style="color:#f92672">.</span>axes<span style="color:#f92672">.</span>xaxis<span style="color:#f92672">.</span>set_ticklabels([])
</span></span><span style="display:flex;"><span>    ax<span style="color:#f92672">.</span>axes<span style="color:#f92672">.</span>yaxis<span style="color:#f92672">.</span>set_ticklabels([])
</span></span><span style="display:flex;"><span>    ax<span style="color:#f92672">.</span>axes<span style="color:#f92672">.</span>zaxis<span style="color:#f92672">.</span>set_ticklabels([])
</span></span><span style="display:flex;"><span>    ax<span style="color:#f92672">.</span>plot_trisurf(pos[:, <span style="color:#ae81ff">0</span>], pos[:, <span style="color:#ae81ff">1</span>], pos[:, <span style="color:#ae81ff">2</span>], triangles<span style="color:#f92672">=</span>data<span style="color:#f92672">.</span>face<span style="color:#f92672">.</span>t(), antialiased<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>show()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visualize_points</span>(pos, edge_index<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, index<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>    fig <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">4</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> edge_index <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (src, dst) <span style="color:#f92672">in</span> edge_index<span style="color:#f92672">.</span>t()<span style="color:#f92672">.</span>tolist():
</span></span><span style="display:flex;"><span>             src <span style="color:#f92672">=</span> pos[src]<span style="color:#f92672">.</span>tolist()
</span></span><span style="display:flex;"><span>             dst <span style="color:#f92672">=</span> pos[dst]<span style="color:#f92672">.</span>tolist()
</span></span><span style="display:flex;"><span>             plt<span style="color:#f92672">.</span>plot([src[<span style="color:#ae81ff">0</span>], dst[<span style="color:#ae81ff">0</span>]], [src[<span style="color:#ae81ff">1</span>], dst[<span style="color:#ae81ff">1</span>]], linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;black&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> index <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>scatter(pos[:, <span style="color:#ae81ff">0</span>], pos[:, <span style="color:#ae81ff">1</span>], s<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span>, zorder<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>       mask <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>zeros(pos<span style="color:#f92672">.</span>size(<span style="color:#ae81ff">0</span>), dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>bool)
</span></span><span style="display:flex;"><span>       mask[index] <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>       plt<span style="color:#f92672">.</span>scatter(pos[<span style="color:#f92672">~</span>mask, <span style="color:#ae81ff">0</span>], pos[<span style="color:#f92672">~</span>mask, <span style="color:#ae81ff">1</span>], s<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;lightgray&#39;</span>, zorder<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span>)
</span></span><span style="display:flex;"><span>       plt<span style="color:#f92672">.</span>scatter(pos[mask, <span style="color:#ae81ff">0</span>], pos[mask, <span style="color:#ae81ff">1</span>], s<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span>, zorder<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span>)
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>show()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#75715e">#load dataset</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.datasets <span style="color:#f92672">import</span> GeometricShapes
</span></span><span style="display:flex;"><span>dataset <span style="color:#f92672">=</span> GeometricShapes(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;data/GeometricShapes&#39;</span>)
</span></span></code></pre></div><blockquote>
<p>transform our meshes into points via the usage of &ldquo;transforms&rdquo;. Here, PyTorch Geometric provides the <a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/transforms.html#torch_geometric.transforms.SamplePoints"target="_blank" rel="external nofollow noopener noreferrer"><code>torch_geometric.transforms.SamplePoints</code><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> transformation, which will uniformly sample a fixed number of points on the mesh faces according to their face area.</p>
</blockquote>
<ul>
<li><strong>RandomRotate</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.transforms <span style="color:#f92672">import</span> Compose, RandomRotate
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>torch<span style="color:#f92672">.</span>manual_seed(<span style="color:#ae81ff">123</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>random_rotate <span style="color:#f92672">=</span> Compose([
</span></span><span style="display:flex;"><span>    RandomRotate(degrees<span style="color:#f92672">=</span><span style="color:#ae81ff">180</span>, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>    RandomRotate(degrees<span style="color:#f92672">=</span><span style="color:#ae81ff">180</span>, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>    RandomRotate(degrees<span style="color:#f92672">=</span><span style="color:#ae81ff">180</span>, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>),
</span></span><span style="display:flex;"><span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dataset <span style="color:#f92672">=</span> GeometricShapes(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;data/GeometricShapes&#39;</span>, transform<span style="color:#f92672">=</span>random_rotate)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> dataset[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>print(data)
</span></span><span style="display:flex;"><span>visualize_mesh(data<span style="color:#f92672">.</span>pos, data<span style="color:#f92672">.</span>face)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> dataset[<span style="color:#ae81ff">4</span>]
</span></span><span style="display:flex;"><span>print(data)
</span></span><span style="display:flex;"><span>visualize_mesh(data<span style="color:#f92672">.</span>pos, data<span style="color:#f92672">.</span>face)
</span></span></code></pre></div><ul>
<li><strong>SamplePoints</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.transforms <span style="color:#f92672">import</span> SamplePoints
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>torch<span style="color:#f92672">.</span>manual_seed(<span style="color:#ae81ff">42</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dataset<span style="color:#f92672">.</span>transform <span style="color:#f92672">=</span> SamplePoints(num<span style="color:#f92672">=</span><span style="color:#ae81ff">256</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> dataset[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>print(data)   <span style="color:#75715e">#Data(face=[3, 30], pos=[32, 3], y=[1]) =&gt;Data(pos=[256, 3], y=[1])</span>
</span></span><span style="display:flex;"><span>visualize_points(data<span style="color:#f92672">.</span>pos, data<span style="color:#f92672">.</span>edge_index)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> dataset[<span style="color:#ae81ff">4</span>]
</span></span><span style="display:flex;"><span>print(data)   <span style="color:#75715e">#Data(face=[3, 2], pos=[4, 3], y=[1])=&gt;Data(pos=[256, 3], y=[1])</span>
</span></span><span style="display:flex;"><span>visualize_points(data<span style="color:#f92672">.</span>pos)
</span></span></code></pre></div><p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618133509868.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618133509868.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618133509868.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618133509868.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618133509868.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618133509868.png"/></p>
<blockquote>
<p><code>PointNet++</code> processes <code>point clouds iteratively</code> by following a <code>simple grouping, neighborhood aggregation and downsampling scheme:</code></p>
<ol>
<li>The <strong>grouping phase</strong> constructs a graph in which <code>nearby points are connected</code>. Typically, this is either done via <code>k-nearest neighbor search</code> or via <code>ball queries (which connects all points that are within a radius to the query point).</code></li>
<li>The <strong>neighborhood aggregation phase</strong> executes a Graph Neural Network layer that, for each point,<code>aggregates information from its direct neighbors</code>(given by the graph constructed in the previous phase). This allows PointNet++ to capture local context at different scales.</li>
<li>The <strong>downsampling phase</strong> implements a pooling scheme suitable for point clouds with potentially different sizes. We will ignore this phase for now and will come back later to it.</li>
</ol>
</blockquote>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618132211963.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618132211963.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618132211963.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618132211963.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618132211963.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618132211963.png"/></p>
<ul>
<li><strong>knn_graph</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_cluster <span style="color:#f92672">import</span> knn_graph
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> dataset[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>data<span style="color:#f92672">.</span>edge_index <span style="color:#f92672">=</span> knn_graph(data<span style="color:#f92672">.</span>pos, k<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>)
</span></span><span style="display:flex;"><span>print(data<span style="color:#f92672">.</span>edge_index<span style="color:#f92672">.</span>shape)
</span></span><span style="display:flex;"><span>visualize_points(data<span style="color:#f92672">.</span>pos, edge_index<span style="color:#f92672">=</span>data<span style="color:#f92672">.</span>edge_index)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> dataset[<span style="color:#ae81ff">4</span>]
</span></span><span style="display:flex;"><span>data<span style="color:#f92672">.</span>edge_index <span style="color:#f92672">=</span> knn_graph(data<span style="color:#f92672">.</span>pos, k<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>)
</span></span><span style="display:flex;"><span>print(data<span style="color:#f92672">.</span>edge_index<span style="color:#f92672">.</span>shape)
</span></span><span style="display:flex;"><span>visualize_points(data<span style="color:#f92672">.</span>pos, edge_index<span style="color:#f92672">=</span>data<span style="color:#f92672">.</span>edge_index)
</span></span></code></pre></div><p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618132356302.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618132356302.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618132356302.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618132356302.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618132356302.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618132356302.png"/></p>
<ul>
<li><strong>Neighborhood Aggregation</strong></li>
</ul>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618132502775.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618132502775.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618132502775.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618132502775.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618132502775.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618132502775.png"/></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> torch.nn <span style="color:#f92672">import</span> Sequential, Linear, ReLU
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.nn <span style="color:#f92672">import</span> MessagePassing
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PointNetLayer</span>(MessagePassing):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, in_channels, out_channels):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Message passing with &#34;max&#34; aggregation.</span>
</span></span><span style="display:flex;"><span>        super(PointNetLayer, self)<span style="color:#f92672">.</span>__init__(<span style="color:#e6db74">&#39;max&#39;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Initialization of the MLP:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Here, the number of input features correspond to the hidden node</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># dimensionality plus point dimensionality (=3).</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>mlp <span style="color:#f92672">=</span> Sequential(Linear(in_channels <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span>, out_channels),
</span></span><span style="display:flex;"><span>                              ReLU(),
</span></span><span style="display:flex;"><span>                              Linear(out_channels, out_channels))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, h, pos, edge_index):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Start propagating messages.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>propagate(edge_index, h<span style="color:#f92672">=</span>h, pos<span style="color:#f92672">=</span>pos)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">message</span>(self, h_j, pos_j, pos_i):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># h_j defines the features of neighboring nodes as shape [num_edges, in_channels]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># pos_j defines the position of neighboring nodes as shape [num_edges, 3]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># pos_i defines the position of central nodes as shape [num_edges, 3]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        input <span style="color:#f92672">=</span> pos_j <span style="color:#f92672">-</span> pos_i  <span style="color:#75715e"># Compute spatial relation.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> h_j <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># In the first layer, we may not have any hidden node features,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># so we only combine them in case they are present.</span>
</span></span><span style="display:flex;"><span>            input <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>cat([h_j, input], dim<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>mlp(input)  <span style="color:#75715e"># Apply our final MLP.</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch.nn.functional <span style="color:#66d9ef">as</span> F
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_cluster <span style="color:#f92672">import</span> knn_graph
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.nn <span style="color:#f92672">import</span> global_max_pool
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PointNet</span>(torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self):
</span></span><span style="display:flex;"><span>        super(PointNet, self)<span style="color:#f92672">.</span>__init__()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        torch<span style="color:#f92672">.</span>manual_seed(<span style="color:#ae81ff">12345</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>conv1 <span style="color:#f92672">=</span> PointNetLayer(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>conv2 <span style="color:#f92672">=</span> PointNetLayer(<span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>classifier <span style="color:#f92672">=</span> Linear(<span style="color:#ae81ff">32</span>, dataset<span style="color:#f92672">.</span>num_classes)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, pos, batch):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Compute the kNN graph:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Here, we need to pass the batch vector to the function call in order</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># to prevent creating edges between points of different examples.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># We also add `loop=True` which will add self-loops to the graph in</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># order to preserve central point information.</span>
</span></span><span style="display:flex;"><span>        edge_index <span style="color:#f92672">=</span> knn_graph(pos, k<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>, batch<span style="color:#f92672">=</span>batch, loop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 3. Start bipartite message passing.</span>
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>conv1(h<span style="color:#f92672">=</span>pos, pos<span style="color:#f92672">=</span>pos, edge_index<span style="color:#f92672">=</span>edge_index)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> h<span style="color:#f92672">.</span>relu()
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>conv2(h<span style="color:#f92672">=</span>h, pos<span style="color:#f92672">=</span>pos, edge_index<span style="color:#f92672">=</span>edge_index)
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> h<span style="color:#f92672">.</span>relu()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 4. Global Pooling.</span>
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> global_max_pool(h, batch)  <span style="color:#75715e"># [num_examples, hidden_channels]</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 5. Classifier.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>classifier(h)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> PointNet()
</span></span><span style="display:flex;"><span>print(model)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> IPython.display <span style="color:#f92672">import</span> Javascript  <span style="color:#75715e"># Restrict height of output cell.</span>
</span></span><span style="display:flex;"><span>display(Javascript(<span style="color:#e6db74">&#39;&#39;&#39;google.colab.output.setIframeHeight(0, true, </span><span style="color:#e6db74">{maxHeight: 300}</span><span style="color:#e6db74">)&#39;&#39;&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.data <span style="color:#f92672">import</span> DataLoader
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>train_dataset <span style="color:#f92672">=</span> GeometricShapes(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;data/GeometricShapes&#39;</span>, train<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>                                transform<span style="color:#f92672">=</span>SamplePoints(<span style="color:#ae81ff">128</span>))
</span></span><span style="display:flex;"><span>test_dataset <span style="color:#f92672">=</span> GeometricShapes(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;data/GeometricShapes&#39;</span>, train<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>                               transform<span style="color:#f92672">=</span>SamplePoints(<span style="color:#ae81ff">128</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>train_loader <span style="color:#f92672">=</span> DataLoader(train_dataset, batch_size<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>, shuffle<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>test_loader <span style="color:#f92672">=</span> DataLoader(test_dataset, batch_size<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> PointNet()
</span></span><span style="display:flex;"><span>optimizer <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>Adam(model<span style="color:#f92672">.</span>parameters(), lr<span style="color:#f92672">=</span><span style="color:#ae81ff">0.01</span>)
</span></span><span style="display:flex;"><span>criterion <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>CrossEntropyLoss()  <span style="color:#75715e"># Define loss criterion.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train</span>(model, optimizer, loader):
</span></span><span style="display:flex;"><span>    model<span style="color:#f92672">.</span>train()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    total_loss <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> data <span style="color:#f92672">in</span> loader:
</span></span><span style="display:flex;"><span>        optimizer<span style="color:#f92672">.</span>zero_grad()  <span style="color:#75715e"># Clear gradients.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#batch(batch=[1280], pos=[1280, 3], ptr=[11], y=[10])</span>
</span></span><span style="display:flex;"><span>        logits <span style="color:#f92672">=</span> model(data<span style="color:#f92672">.</span>pos, data<span style="color:#f92672">.</span>batch)  <span style="color:#75715e"># Forward pass.</span>
</span></span><span style="display:flex;"><span>        loss <span style="color:#f92672">=</span> criterion(logits, data<span style="color:#f92672">.</span>y)  <span style="color:#75715e"># Loss computation.</span>
</span></span><span style="display:flex;"><span>        loss<span style="color:#f92672">.</span>backward()  <span style="color:#75715e"># Backward pass.</span>
</span></span><span style="display:flex;"><span>        optimizer<span style="color:#f92672">.</span>step()  <span style="color:#75715e"># Update model parameters.</span>
</span></span><span style="display:flex;"><span>        total_loss <span style="color:#f92672">+=</span> loss<span style="color:#f92672">.</span>item() <span style="color:#f92672">*</span> data<span style="color:#f92672">.</span>num_graphs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> total_loss <span style="color:#f92672">/</span> len(train_loader<span style="color:#f92672">.</span>dataset)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@torch.no_grad</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test</span>(model, loader):
</span></span><span style="display:flex;"><span>    model<span style="color:#f92672">.</span>eval()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    total_correct <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> data <span style="color:#f92672">in</span> loader:
</span></span><span style="display:flex;"><span>        logits <span style="color:#f92672">=</span> model(data<span style="color:#f92672">.</span>pos, data<span style="color:#f92672">.</span>batch)
</span></span><span style="display:flex;"><span>        pred <span style="color:#f92672">=</span> logits<span style="color:#f92672">.</span>argmax(dim<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        total_correct <span style="color:#f92672">+=</span> int((pred <span style="color:#f92672">==</span> data<span style="color:#f92672">.</span>y)<span style="color:#f92672">.</span>sum())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> total_correct <span style="color:#f92672">/</span> len(loader<span style="color:#f92672">.</span>dataset)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">51</span>):
</span></span><span style="display:flex;"><span>    loss <span style="color:#f92672">=</span> train(model, optimizer, train_loader)
</span></span><span style="display:flex;"><span>    test_acc <span style="color:#f92672">=</span> test(model, test_loader)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Epoch: </span><span style="color:#e6db74">{</span>epoch<span style="color:#e6db74">:</span><span style="color:#e6db74">02d</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, Loss: </span><span style="color:#e6db74">{</span>loss<span style="color:#e6db74">:</span><span style="color:#e6db74">.4f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, Test Accuracy: </span><span style="color:#e6db74">{</span>test_acc<span style="color:#e6db74">:</span><span style="color:#e6db74">.4f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span></code></pre></div><h4 id="8-biggraph">.8. BigGraph</h4>
<blockquote>
<p><strong>Cluster-GCN</strong> (<a href="https://arxiv.org/abs/1905.07953"target="_blank" rel="external nofollow noopener noreferrer">Chiang et al. (2019)<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a>, which is based on<code> pre-partitioning the graph into subgraphs on which one can operate in a mini-batch fashion</code>.</p>
</blockquote>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618134507044.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618134507044.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618134507044.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210618134507044.png 2x"
    data-sizes="auto"
    alt="image-20210618134507044"
    title="image-20210618134507044"/></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.datasets <span style="color:#f92672">import</span> Planetoid
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.transforms <span style="color:#f92672">import</span> NormalizeFeatures
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dataset <span style="color:#f92672">=</span> Planetoid(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;data/Planetoid&#39;</span>, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;PubMed&#39;</span>, transform<span style="color:#f92672">=</span>NormalizeFeatures())
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Data(edge_index=[2, 88648], test_mask=[19717], train_mask=[19717], val_mask=[19717], x=[19717, 500], y=[19717])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.data <span style="color:#f92672">import</span> ClusterData, ClusterLoader
</span></span><span style="display:flex;"><span>torch<span style="color:#f92672">.</span>manual_seed(<span style="color:#ae81ff">12345</span>)
</span></span><span style="display:flex;"><span>cluster_data <span style="color:#f92672">=</span> ClusterData(data, num_parts<span style="color:#f92672">=</span><span style="color:#ae81ff">128</span>)  <span style="color:#75715e"># 1. Create subgraphs.</span>
</span></span><span style="display:flex;"><span>train_loader <span style="color:#f92672">=</span> ClusterLoader(cluster_data, batch_size<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>, shuffle<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)  <span style="color:#75715e"># 2. Stochastic partioning scheme.</span>
</span></span><span style="display:flex;"><span>print()
</span></span><span style="display:flex;"><span>total_num_nodes <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> step, sub_data <span style="color:#f92672">in</span> enumerate(train_loader):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Step </span><span style="color:#e6db74">{</span>step <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">}</span><span style="color:#e6db74">:&#39;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;=======&#39;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Number of nodes in the current batch: </span><span style="color:#e6db74">{</span>sub_data<span style="color:#f92672">.</span>num_nodes<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>    print(sub_data)<span style="color:#75715e">#Data(edge_index=[2, 15230], test_mask=[4946], train_mask=[4946], val_mask=[4946], x=[4946, 500], y=[4946])</span>
</span></span><span style="display:flex;"><span>    print()
</span></span><span style="display:flex;"><span>    total_num_nodes <span style="color:#f92672">+=</span> sub_data<span style="color:#f92672">.</span>num_nodes
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Iterated over </span><span style="color:#e6db74">{</span>total_num_nodes<span style="color:#e6db74">}</span><span style="color:#e6db74"> of </span><span style="color:#e6db74">{</span>data<span style="color:#f92672">.</span>num_nodes<span style="color:#e6db74">}</span><span style="color:#e6db74"> nodes!&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch.nn.functional <span style="color:#66d9ef">as</span> F
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.nn <span style="color:#f92672">import</span> GCNConv
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GCN</span>(torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, hidden_channels):
</span></span><span style="display:flex;"><span>        super(GCN, self)<span style="color:#f92672">.</span>__init__()
</span></span><span style="display:flex;"><span>        torch<span style="color:#f92672">.</span>manual_seed(<span style="color:#ae81ff">12345</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>conv1 <span style="color:#f92672">=</span> GCNConv(dataset<span style="color:#f92672">.</span>num_node_features, hidden_channels)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>conv2 <span style="color:#f92672">=</span> GCNConv(hidden_channels, dataset<span style="color:#f92672">.</span>num_classes)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, x, edge_index):
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>conv1(x, edge_index)
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>relu()
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>dropout(x, p<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>, training<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>training)
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>conv2(x, edge_index)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> x
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> GCN(hidden_channels<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>print(model)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> IPython.display <span style="color:#f92672">import</span> Javascript
</span></span><span style="display:flex;"><span>display(Javascript(<span style="color:#e6db74">&#39;&#39;&#39;google.colab.output.setIframeHeight(0, true, </span><span style="color:#e6db74">{maxHeight: 300}</span><span style="color:#e6db74">)&#39;&#39;&#39;</span>))
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> GCN(hidden_channels<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>optimizer <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>Adam(model<span style="color:#f92672">.</span>parameters(), lr<span style="color:#f92672">=</span><span style="color:#ae81ff">0.01</span>, weight_decay<span style="color:#f92672">=</span><span style="color:#ae81ff">5e-4</span>)
</span></span><span style="display:flex;"><span>criterion <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>CrossEntropyLoss()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train</span>():
</span></span><span style="display:flex;"><span>      model<span style="color:#f92672">.</span>train()
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span> sub_data <span style="color:#f92672">in</span> train_loader:  <span style="color:#75715e"># Iterate over each mini-batch.</span>
</span></span><span style="display:flex;"><span>          out <span style="color:#f92672">=</span> model(sub_data<span style="color:#f92672">.</span>x, sub_data<span style="color:#f92672">.</span>edge_index)  <span style="color:#75715e"># Perform a single forward pass.</span>
</span></span><span style="display:flex;"><span>          loss <span style="color:#f92672">=</span> criterion(out[sub_data<span style="color:#f92672">.</span>train_mask], sub_data<span style="color:#f92672">.</span>y[sub_data<span style="color:#f92672">.</span>train_mask])  <span style="color:#75715e"># Compute the loss solely based on the training nodes.</span>
</span></span><span style="display:flex;"><span>          loss<span style="color:#f92672">.</span>backward()  <span style="color:#75715e"># Derive gradients.</span>
</span></span><span style="display:flex;"><span>          optimizer<span style="color:#f92672">.</span>step()  <span style="color:#75715e"># Update parameters based on gradients.</span>
</span></span><span style="display:flex;"><span>          optimizer<span style="color:#f92672">.</span>zero_grad()  <span style="color:#75715e"># Clear gradients.</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test</span>():
</span></span><span style="display:flex;"><span>      model<span style="color:#f92672">.</span>eval()
</span></span><span style="display:flex;"><span>      out <span style="color:#f92672">=</span> model(data<span style="color:#f92672">.</span>x, data<span style="color:#f92672">.</span>edge_index)
</span></span><span style="display:flex;"><span>      pred <span style="color:#f92672">=</span> out<span style="color:#f92672">.</span>argmax(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)  <span style="color:#75715e"># Use the class with highest probability.</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      accs <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span> mask <span style="color:#f92672">in</span> [data<span style="color:#f92672">.</span>train_mask, data<span style="color:#f92672">.</span>val_mask, data<span style="color:#f92672">.</span>test_mask]:
</span></span><span style="display:flex;"><span>          correct <span style="color:#f92672">=</span> pred[mask] <span style="color:#f92672">==</span> data<span style="color:#f92672">.</span>y[mask]  <span style="color:#75715e"># Check against ground-truth labels.</span>
</span></span><span style="display:flex;"><span>          accs<span style="color:#f92672">.</span>append(int(correct<span style="color:#f92672">.</span>sum()) <span style="color:#f92672">/</span> int(mask<span style="color:#f92672">.</span>sum()))  <span style="color:#75715e"># Derive ratio of correct predictions.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> accs
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">51</span>):
</span></span><span style="display:flex;"><span>    loss <span style="color:#f92672">=</span> train()
</span></span><span style="display:flex;"><span>    train_acc, val_acc, test_acc <span style="color:#f92672">=</span> test()
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Epoch: </span><span style="color:#e6db74">{</span>epoch<span style="color:#e6db74">:</span><span style="color:#e6db74">03d</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, Train: </span><span style="color:#e6db74">{</span>train_acc<span style="color:#e6db74">:</span><span style="color:#e6db74">.4f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, Val Acc: </span><span style="color:#e6db74">{</span>val_acc<span style="color:#e6db74">:</span><span style="color:#e6db74">.4f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, Test Acc: </span><span style="color:#e6db74">{</span>test_acc<span style="color:#e6db74">:</span><span style="color:#e6db74">.4f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span></code></pre></div><h4 id="9-gnnmodelexplain">.9. GNNModelExplain</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.data <span style="color:#f92672">import</span> DataLoader
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.datasets <span style="color:#f92672">import</span> TUDataset
</span></span><span style="display:flex;"><span>path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;.&#39;</span>
</span></span><span style="display:flex;"><span>dataset <span style="color:#f92672">=</span> TUDataset(path, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Mutagenicity&#39;</span>)<span style="color:#f92672">.</span>shuffle()
</span></span><span style="display:flex;"><span>test_dataset <span style="color:#f92672">=</span> dataset[:len(dataset) <span style="color:#f92672">//</span> <span style="color:#ae81ff">10</span>]
</span></span><span style="display:flex;"><span>train_dataset <span style="color:#f92672">=</span> dataset[len(dataset) <span style="color:#f92672">//</span> <span style="color:#ae81ff">10</span>:]
</span></span><span style="display:flex;"><span>test_loader <span style="color:#f92672">=</span> DataLoader(test_dataset, batch_size<span style="color:#f92672">=</span><span style="color:#ae81ff">128</span>)
</span></span><span style="display:flex;"><span>train_loader <span style="color:#f92672">=</span> DataLoader(train_dataset, batch_size<span style="color:#f92672">=</span><span style="color:#ae81ff">128</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#model define</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch.nn.functional <span style="color:#66d9ef">as</span> F
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch.nn <span style="color:#f92672">import</span> Linear
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.nn <span style="color:#f92672">import</span> global_add_pool, GraphConv
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Net</span>(torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, dim):
</span></span><span style="display:flex;"><span>        super(Net, self)<span style="color:#f92672">.</span>__init__()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        num_features <span style="color:#f92672">=</span> dataset<span style="color:#f92672">.</span>num_features
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>dim <span style="color:#f92672">=</span> dim
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>conv1 <span style="color:#f92672">=</span> GraphConv(num_features, dim)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>conv2 <span style="color:#f92672">=</span> GraphConv(dim, dim)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>conv3 <span style="color:#f92672">=</span> GraphConv(dim, dim)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>conv4 <span style="color:#f92672">=</span> GraphConv(dim, dim)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>conv5 <span style="color:#f92672">=</span> GraphConv(dim, dim)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>fc1 <span style="color:#f92672">=</span> Linear(dim, dim)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>fc2 <span style="color:#f92672">=</span> Linear(dim, dataset<span style="color:#f92672">.</span>num_classes)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, x, edge_index, batch, edge_weight<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>relu(self<span style="color:#f92672">.</span>conv1(x, edge_index, edge_weight))
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>relu(self<span style="color:#f92672">.</span>conv2(x, edge_index, edge_weight))
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>relu(self<span style="color:#f92672">.</span>conv3(x, edge_index, edge_weight))
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>relu(self<span style="color:#f92672">.</span>conv4(x, edge_index, edge_weight))
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>relu(self<span style="color:#f92672">.</span>conv5(x, edge_index, edge_weight))
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> global_add_pool(x, batch)
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>relu(self<span style="color:#f92672">.</span>fc1(x))
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>dropout(x, p<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>, training<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>training)
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>fc2(x)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> F<span style="color:#f92672">.</span>log_softmax(x, dim<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#75715e"># train&amp;test function</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train</span>(epoch):
</span></span><span style="display:flex;"><span>    model<span style="color:#f92672">.</span>train()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> epoch <span style="color:#f92672">==</span> <span style="color:#ae81ff">51</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> param_group <span style="color:#f92672">in</span> optimizer<span style="color:#f92672">.</span>param_groups:
</span></span><span style="display:flex;"><span>            param_group[<span style="color:#e6db74">&#39;lr&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.5</span> <span style="color:#f92672">*</span> param_group[<span style="color:#e6db74">&#39;lr&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    loss_all <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> data <span style="color:#f92672">in</span> train_loader:
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>to(device)
</span></span><span style="display:flex;"><span>        optimizer<span style="color:#f92672">.</span>zero_grad()
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#Batch(batch=[3977], edge_attr=[7906, 3], edge_index=[2, 7906], ptr=[129], x=[3977, 14], y=[128])</span>
</span></span><span style="display:flex;"><span>        output <span style="color:#f92672">=</span> model(data<span style="color:#f92672">.</span>x, data<span style="color:#f92672">.</span>edge_index, data<span style="color:#f92672">.</span>batch)
</span></span><span style="display:flex;"><span>        loss <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>nll_loss(output, data<span style="color:#f92672">.</span>y)
</span></span><span style="display:flex;"><span>        loss<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>        loss_all <span style="color:#f92672">+=</span> loss<span style="color:#f92672">.</span>item() <span style="color:#f92672">*</span> data<span style="color:#f92672">.</span>num_graphs
</span></span><span style="display:flex;"><span>        optimizer<span style="color:#f92672">.</span>step()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> loss_all <span style="color:#f92672">/</span> len(train_dataset)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test</span>(loader):
</span></span><span style="display:flex;"><span>    model<span style="color:#f92672">.</span>eval()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    correct <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> data <span style="color:#f92672">in</span> loader:
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>to(device)
</span></span><span style="display:flex;"><span>        output <span style="color:#f92672">=</span> model(data<span style="color:#f92672">.</span>x, data<span style="color:#f92672">.</span>edge_index, data<span style="color:#f92672">.</span>batch)
</span></span><span style="display:flex;"><span>        pred <span style="color:#f92672">=</span> output<span style="color:#f92672">.</span>max(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        correct <span style="color:#f92672">+=</span> pred<span style="color:#f92672">.</span>eq(data<span style="color:#f92672">.</span>y)<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>item()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> correct <span style="color:#f92672">/</span> len(loader<span style="color:#f92672">.</span>dataset)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>device <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>device(<span style="color:#e6db74">&#39;cuda&#39;</span> <span style="color:#66d9ef">if</span> torch<span style="color:#f92672">.</span>cuda<span style="color:#f92672">.</span>is_available() <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#39;cpu&#39;</span>)
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> Net(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>)<span style="color:#f92672">.</span>to(device)
</span></span><span style="display:flex;"><span>optimizer <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>Adam(model<span style="color:#f92672">.</span>parameters(), lr<span style="color:#f92672">=</span><span style="color:#ae81ff">0.001</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>):
</span></span><span style="display:flex;"><span>    train_loss <span style="color:#f92672">=</span> train(epoch)
</span></span><span style="display:flex;"><span>    train_acc <span style="color:#f92672">=</span> test(train_loader)
</span></span><span style="display:flex;"><span>    test_acc <span style="color:#f92672">=</span> test(test_loader)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;Epoch: </span><span style="color:#e6db74">{:03d}</span><span style="color:#e6db74">, Train Loss: </span><span style="color:#e6db74">{:.7f}</span><span style="color:#e6db74">, &#39;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#39;Train Acc: </span><span style="color:#e6db74">{:.7f}</span><span style="color:#e6db74">, Test Acc: </span><span style="color:#e6db74">{:.7f}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(epoch, train_loss,
</span></span><span style="display:flex;"><span>                                                       train_acc, test_acc))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> captum.attr <span style="color:#f92672">import</span> Saliency, IntegratedGradients
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">model_forward</span>(edge_mask, data):
</span></span><span style="display:flex;"><span>    batch <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>zeros(data<span style="color:#f92672">.</span>x<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>], dtype<span style="color:#f92672">=</span>int)<span style="color:#f92672">.</span>to(device)
</span></span><span style="display:flex;"><span>    out <span style="color:#f92672">=</span> model(data<span style="color:#f92672">.</span>x, data<span style="color:#f92672">.</span>edge_index, batch, edge_mask)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> out
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">explain</span>(method, data, target<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>    input_mask <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>ones(data<span style="color:#f92672">.</span>edge_index<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>])<span style="color:#f92672">.</span>requires_grad_(<span style="color:#66d9ef">True</span>)<span style="color:#f92672">.</span>to(device)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;ig&#39;</span>:
</span></span><span style="display:flex;"><span>        ig <span style="color:#f92672">=</span> IntegratedGradients(model_forward)
</span></span><span style="display:flex;"><span>        mask <span style="color:#f92672">=</span> ig<span style="color:#f92672">.</span>attribute(input_mask, target<span style="color:#f92672">=</span>target,
</span></span><span style="display:flex;"><span>                            additional_forward_args<span style="color:#f92672">=</span>(data,),
</span></span><span style="display:flex;"><span>                            internal_batch_size<span style="color:#f92672">=</span>data<span style="color:#f92672">.</span>edge_index<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;saliency&#39;</span>:
</span></span><span style="display:flex;"><span>        saliency <span style="color:#f92672">=</span> Saliency(model_forward)
</span></span><span style="display:flex;"><span>        mask <span style="color:#f92672">=</span> saliency<span style="color:#f92672">.</span>attribute(input_mask, target<span style="color:#f92672">=</span>target,
</span></span><span style="display:flex;"><span>                                  additional_forward_args<span style="color:#f92672">=</span>(data,))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#39;Unknown explanation method&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    edge_mask <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>abs(mask<span style="color:#f92672">.</span>cpu()<span style="color:#f92672">.</span>detach()<span style="color:#f92672">.</span>numpy())
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> edge_mask<span style="color:#f92672">.</span>max() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:  <span style="color:#75715e"># avoid division by zero</span>
</span></span><span style="display:flex;"><span>        edge_mask <span style="color:#f92672">=</span> edge_mask <span style="color:#f92672">/</span> edge_mask<span style="color:#f92672">.</span>max()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> edge_mask
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> collections <span style="color:#f92672">import</span> defaultdict
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">aggregate_edge_directions</span>(edge_mask, data):
</span></span><span style="display:flex;"><span>    edge_mask_dict <span style="color:#f92672">=</span> defaultdict(float)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> val, u, v <span style="color:#f92672">in</span> list(zip(edge_mask, <span style="color:#f92672">*</span>data<span style="color:#f92672">.</span>edge_index)):
</span></span><span style="display:flex;"><span>        u, v <span style="color:#f92672">=</span> u<span style="color:#f92672">.</span>item(), v<span style="color:#f92672">.</span>item()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> u <span style="color:#f92672">&gt;</span> v:
</span></span><span style="display:flex;"><span>            u, v <span style="color:#f92672">=</span> v, u
</span></span><span style="display:flex;"><span>        edge_mask_dict[(u, v)] <span style="color:#f92672">+=</span> val
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> edge_mask_dict
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>choice([t <span style="color:#66d9ef">for</span> t <span style="color:#f92672">in</span> test_dataset <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> t<span style="color:#f92672">.</span>y<span style="color:#f92672">.</span>item()])
</span></span><span style="display:flex;"><span>mol <span style="color:#f92672">=</span> to_molecule(data)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> title, method <span style="color:#f92672">in</span> [(<span style="color:#e6db74">&#39;Integrated Gradients&#39;</span>, <span style="color:#e6db74">&#39;ig&#39;</span>), (<span style="color:#e6db74">&#39;Saliency&#39;</span>, <span style="color:#e6db74">&#39;saliency&#39;</span>)]:
</span></span><span style="display:flex;"><span>    edge_mask <span style="color:#f92672">=</span> explain(method, data, target<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    edge_mask_dict <span style="color:#f92672">=</span> aggregate_edge_directions(edge_mask, data)
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">5</span>))
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>title(title)
</span></span><span style="display:flex;"><span>    draw_molecule(mol, edge_mask_dict)
</span></span></code></pre></div><h3 id="5-visualization">5. Visualization</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.utils <span style="color:#f92672">import</span> to_networkx
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span>matplotlib inline
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> networkx <span style="color:#66d9ef">as</span> nx
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visualize</span>(h, color, epoch<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, loss<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">7</span>))
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>xticks([])
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>yticks([])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> torch<span style="color:#f92672">.</span>is_tensor(h):
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> h<span style="color:#f92672">.</span>detach()<span style="color:#f92672">.</span>cpu()<span style="color:#f92672">.</span>numpy()
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>scatter(h[:, <span style="color:#ae81ff">0</span>], h[:, <span style="color:#ae81ff">1</span>], s<span style="color:#f92672">=</span><span style="color:#ae81ff">140</span>, c<span style="color:#f92672">=</span>color, cmap<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Set2&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> epoch <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">and</span> loss <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Epoch: </span><span style="color:#e6db74">{</span>epoch<span style="color:#e6db74">}</span><span style="color:#e6db74">, Loss: </span><span style="color:#e6db74">{</span>loss<span style="color:#f92672">.</span>item()<span style="color:#e6db74">:</span><span style="color:#e6db74">.4f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>, fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        nx<span style="color:#f92672">.</span>draw_networkx(G, pos<span style="color:#f92672">=</span>nx<span style="color:#f92672">.</span>spring_layout(G, seed<span style="color:#f92672">=</span><span style="color:#ae81ff">42</span>), with_labels<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>                         node_color<span style="color:#f92672">=</span>color, cmap<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Set2&#34;</span>)
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>show()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#75715e">#data: Data(edge_index=[2, 156], train_mask=[34], x=[34, 34], y=[34])    </span>
</span></span><span style="display:flex;"><span>G <span style="color:#f92672">=</span> to_networkx(data, to_undirected<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#G &lt;class &#39;networkx.classes.graph.Graph&#39;&gt;</span>
</span></span><span style="display:flex;"><span>visualize(G, color<span style="color:#f92672">=</span>data<span style="color:#f92672">.</span>y)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> networkx <span style="color:#66d9ef">as</span> nx
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.utils <span style="color:#f92672">import</span> to_networkx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">draw_molecule</span>(g, edge_mask<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, draw_edge_labels<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>):
</span></span><span style="display:flex;"><span>    g <span style="color:#f92672">=</span> g<span style="color:#f92672">.</span>copy()<span style="color:#f92672">.</span>to_undirected()
</span></span><span style="display:flex;"><span>    node_labels <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> u, data <span style="color:#f92672">in</span> g<span style="color:#f92672">.</span>nodes(data<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>):
</span></span><span style="display:flex;"><span>        node_labels[u] <span style="color:#f92672">=</span> data[<span style="color:#e6db74">&#39;name&#39;</span>]
</span></span><span style="display:flex;"><span>    pos <span style="color:#f92672">=</span> nx<span style="color:#f92672">.</span>planar_layout(g)
</span></span><span style="display:flex;"><span>    pos <span style="color:#f92672">=</span> nx<span style="color:#f92672">.</span>spring_layout(g, pos<span style="color:#f92672">=</span>pos)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> edge_mask <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        edge_color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;black&#39;</span>
</span></span><span style="display:flex;"><span>        widths <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        edge_color <span style="color:#f92672">=</span> [edge_mask[(u, v)] <span style="color:#66d9ef">for</span> u, v <span style="color:#f92672">in</span> g<span style="color:#f92672">.</span>edges()]
</span></span><span style="display:flex;"><span>        widths <span style="color:#f92672">=</span> [x <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span> <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> edge_color]
</span></span><span style="display:flex;"><span>    nx<span style="color:#f92672">.</span>draw(g, pos<span style="color:#f92672">=</span>pos, labels<span style="color:#f92672">=</span>node_labels, width<span style="color:#f92672">=</span>widths,
</span></span><span style="display:flex;"><span>            edge_color<span style="color:#f92672">=</span>edge_color, edge_cmap<span style="color:#f92672">=</span>plt<span style="color:#f92672">.</span>cm<span style="color:#f92672">.</span>Blues,
</span></span><span style="display:flex;"><span>            node_color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;azure&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> draw_edge_labels <span style="color:#f92672">and</span> edge_mask <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        edge_labels <span style="color:#f92672">=</span> {k: (<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%.2f</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> v) <span style="color:#66d9ef">for</span> k, v <span style="color:#f92672">in</span> edge_mask<span style="color:#f92672">.</span>items()}    
</span></span><span style="display:flex;"><span>        nx<span style="color:#f92672">.</span>draw_networkx_edge_labels(g, pos, edge_labels<span style="color:#f92672">=</span>edge_labels,
</span></span><span style="display:flex;"><span>                                    font_color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;red&#39;</span>)
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>show()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">to_molecule</span>(data):
</span></span><span style="display:flex;"><span>    ATOM_MAP <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;C&#39;</span>, <span style="color:#e6db74">&#39;O&#39;</span>, <span style="color:#e6db74">&#39;Cl&#39;</span>, <span style="color:#e6db74">&#39;H&#39;</span>, <span style="color:#e6db74">&#39;N&#39;</span>, <span style="color:#e6db74">&#39;F&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;Br&#39;</span>, <span style="color:#e6db74">&#39;S&#39;</span>, <span style="color:#e6db74">&#39;P&#39;</span>, <span style="color:#e6db74">&#39;I&#39;</span>, <span style="color:#e6db74">&#39;Na&#39;</span>, <span style="color:#e6db74">&#39;K&#39;</span>, <span style="color:#e6db74">&#39;Li&#39;</span>, <span style="color:#e6db74">&#39;Ca&#39;</span>]
</span></span><span style="display:flex;"><span>    g <span style="color:#f92672">=</span> to_networkx(data, node_attrs<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;x&#39;</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> u, data <span style="color:#f92672">in</span> g<span style="color:#f92672">.</span>nodes(data<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>):
</span></span><span style="display:flex;"><span>        data[<span style="color:#e6db74">&#39;name&#39;</span>] <span style="color:#f92672">=</span> ATOM_MAP[data[<span style="color:#e6db74">&#39;x&#39;</span>]<span style="color:#f92672">.</span>index(<span style="color:#ae81ff">1.0</span>)]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">del</span> data[<span style="color:#e6db74">&#39;x&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> g
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>choice([t <span style="color:#66d9ef">for</span> t <span style="color:#f92672">in</span> train_dataset])
</span></span><span style="display:flex;"><span>print(type(data),data)
</span></span><span style="display:flex;"><span>mol <span style="color:#f92672">=</span> to_molecule(data)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">5</span>))
</span></span><span style="display:flex;"><span>print(type(mol))
</span></span><span style="display:flex;"><span>draw_molecule(mol)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&lt;class &#39;torch_geometric.data.data.Data&#39;&gt; Data(edge_attr=[76, 3], edge_index=[2, 76], x=[34, 14], y=[1])</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&lt;class &#39;networkx.classes.digraph.DiGraph&#39;&gt;</span>
</span></span></code></pre></div><h3 id="6-demo">6. Demo</h3>
<h4 id="1-customed-dataset">.1. Customed dataset</h4>
<ul>
<li>dataset generate</li>
</ul>
<blockquote>
<ul>
<li>
<p>10 graphs and 30 nodes per graph with random edges connections</p>
</li>
<li>
<p>number of node feature = 3</p>
</li>
<li>
<p>number of edge feature = 1</p>
</li>
<li>
<p>node&rsquo;s classification and graph classification</p>
<p>Adj [num_graph, num_node, num_node] be the adjacent matrices (sparse)
node_feature [num_graph, num_node, num_node_feature]
edge_feature [num_graph, num_node, num_node] (sparse)</p>
</li>
</ul>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.data <span style="color:#f92672">import</span> InMemoryDataset
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.data <span style="color:#f92672">import</span> Data
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch_geometric.utils <span style="color:#66d9ef">as</span> ut
</span></span><span style="display:flex;"><span>np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>seed(<span style="color:#ae81ff">42</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>num_graph <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>num_node <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>
</span></span><span style="display:flex;"><span>num_node_features <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>num_edge_features <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Adj <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>rand(num_graph, num_node, num_node)
</span></span><span style="display:flex;"><span>Adj[Adj <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0.8</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>Adj[Adj <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0.8</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>node_feature <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>rand(num_graph, num_node, num_node_features)
</span></span><span style="display:flex;"><span>edge_feature <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>rand(num_graph, num_node, num_node) <span style="color:#f92672">*</span> Adj
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>graph_label <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>rand(num_graph)
</span></span><span style="display:flex;"><span>graph_label[graph_label<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0.5</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>graph_label[graph_label<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0.5</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>graph_label <span style="color:#f92672">=</span> graph_label<span style="color:#f92672">.</span>astype(int)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>node_label <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span> random<span style="color:#f92672">.</span>rand(num_graph, num_node)
</span></span><span style="display:flex;"><span>node_label[node_label<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0.5</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>node_label[node_label<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0.5</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>node_label <span style="color:#f92672">=</span> node_label<span style="color:#f92672">.</span>astype(int)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(Adj[<span style="color:#ae81ff">0</span>, :,:], edge_feature[<span style="color:#ae81ff">0</span>, :, :], node_feature[<span style="color:#ae81ff">0</span>, :, :])
</span></span></code></pre></div><p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210621114008066.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210621114008066.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210621114008066.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210621114008066.png 2x"
    data-sizes="auto"
    alt="image-20210621114008066"
    title="image-20210621114008066"/></p>
<h4 id="2-graph-classification">.2. Graph Classification</h4>
<blockquote>
<p>一个graph数据对应一个Data， 可以将多个graph存储到一个data文件里面，也可以将每个graph存在对应单独的data文件里面。</p>
</blockquote>
<ul>
<li>multi-graph&amp;one data</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GraphDatasetInMem</span>(InMemoryDataset):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Graph classification 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, root, transform<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, pre_transform<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        super(GraphDatasetInMem, self)<span style="color:#f92672">.</span>__init__(root,transform, pre_transform)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>data, self<span style="color:#f92672">.</span>slices <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>load(self<span style="color:#f92672">.</span>processed_paths[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@property</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">raw_file_names</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@property</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">processed_file_names</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> [<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;.\GraphDatasetInMem.dataset&#39;</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">download</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process</span>(self):
</span></span><span style="display:flex;"><span>        data_list <span style="color:#f92672">=</span> [] <span style="color:#75715e"># graph classification need to define data_list for multiple graph</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(num_graph):
</span></span><span style="display:flex;"><span>            source_nodes, target_nodes <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>nonzero(Adj[i, :, :])
</span></span><span style="display:flex;"><span>            source_nodes <span style="color:#f92672">=</span> source_nodes<span style="color:#f92672">.</span>reshape((<span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>            target_nodes <span style="color:#f92672">=</span> target_nodes<span style="color:#f92672">.</span>reshape((<span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            edge_index <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(np<span style="color:#f92672">.</span>concatenate((source_nodes, target_nodes), axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>), dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>long) <span style="color:#75715e"># edge_index should be long type</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            edge_weight <span style="color:#f92672">=</span> edge_feature[i, source_nodes, target_nodes]
</span></span><span style="display:flex;"><span>            edge_weight <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(edge_weight<span style="color:#f92672">.</span>reshape((<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, num_edge_features)), dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>float) <span style="color:#75715e"># edge_index should be float</span>
</span></span><span style="display:flex;"><span>            type
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(node_feature[i, :, :], dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>float) 
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># y should be long type, graph label should not be a 0-dimesion tensor</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># use [graph_label[i]] ranther than graph_label[i]</span>
</span></span><span style="display:flex;"><span>            y <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor([graph_label[i]], dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>long) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            data <span style="color:#f92672">=</span> Data(x<span style="color:#f92672">=</span>x, edge_index<span style="color:#f92672">=</span>edge_index, y<span style="color:#f92672">=</span>y, edge_attr<span style="color:#f92672">=</span>edge_weight)
</span></span><span style="display:flex;"><span>            data_list<span style="color:#f92672">.</span>append(data)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        data, slices <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>collate(data_list) <span style="color:#75715e"># Here used to be [data] for one graph</span>
</span></span><span style="display:flex;"><span>        torch<span style="color:#f92672">.</span>save((data, slices), self<span style="color:#f92672">.</span>processed_paths[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span><span style="color:#75715e">#usage</span>
</span></span><span style="display:flex;"><span>dataset_graph_InMem <span style="color:#f92672">=</span> GraphDatasetInMem(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;./&#39;</span>)
</span></span><span style="display:flex;"><span>print(dataset_graph_InMem[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>print(dataset_graph_InMem[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span><span style="color:#75715e">#output</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Data(edge_attr=[504, 1], edge_index=[2, 504], x=[50, 3], y=[1])</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Data(edge_attr=[495, 1], edge_index=[2, 495], x=[50, 3], y=[1])</span>
</span></span></code></pre></div><ul>
<li>one graph one pt file</li>
</ul>
<blockquote>
<p>区别在于：没有data, slices = self.collate(data_list) # Here used to be [data] for one graph，但是有以下函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get</span>(self, idx):
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>load(osp<span style="color:#f92672">.</span>join(self<span style="color:#f92672">.</span>processed_dir, <span style="color:#e6db74">&#39;graphDataset1_</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">.pt&#39;</span><span style="color:#f92672">.</span>format(idx)))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> data
</span></span></code></pre></div></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GraphDataset_1</span>(Dataset):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Graph classification 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, root, transform<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, pre_transform<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        super(GraphDataset_1, self)<span style="color:#f92672">.</span>__init__(root,transform, pre_transform)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@property</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">raw_file_names</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@property</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">processed_file_names</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> [<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;.\GraphDataset1_0.pt&#39;</span>, <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;.\GraphDataset1_1.pt&#39;</span>, <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;.\GraphDataset1_2.pt&#39;</span>, <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;.\GraphDataset1_3.pt&#39;</span>, <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;.\GraphDataset1_4.pt&#39;</span>, <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;.\GraphDataset1_5.pt&#39;</span>, <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;.\GraphDataset1_6.pt&#39;</span>, <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;.\GraphDataset1_7.pt&#39;</span>, <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;.\GraphDataset1_8.pt&#39;</span>, <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;.\GraphDataset1_9.pt&#39;</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">download</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#data_list = [] # graph classification need to define data_list for multiple graph</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(num_graph):
</span></span><span style="display:flex;"><span>            source_nodes, target_nodes <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>nonzero(Adj[i, :, :])
</span></span><span style="display:flex;"><span>            source_nodes <span style="color:#f92672">=</span> source_nodes<span style="color:#f92672">.</span>reshape((<span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>            target_nodes <span style="color:#f92672">=</span> target_nodes<span style="color:#f92672">.</span>reshape((<span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            edge_index <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(np<span style="color:#f92672">.</span>concatenate((source_nodes, target_nodes), axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>), dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>long) <span style="color:#75715e"># edge_index should be long type</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            edge_weight <span style="color:#f92672">=</span> edge_feature[i, source_nodes, target_nodes]
</span></span><span style="display:flex;"><span>            edge_weight <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(edge_weight<span style="color:#f92672">.</span>reshape((<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, num_edge_features)), dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>float) <span style="color:#75715e"># edge_index should be float</span>
</span></span><span style="display:flex;"><span>            type
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(node_feature[i, :, :], dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>float) 
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># y should be long type, graph label should not be a 0-dimesion tensor</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># use [graph_label[i]] ranther than graph_label[i]</span>
</span></span><span style="display:flex;"><span>            y <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor([graph_label[i]], dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>long) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            data <span style="color:#f92672">=</span> Data(x<span style="color:#f92672">=</span>x, edge_index<span style="color:#f92672">=</span>edge_index, y<span style="color:#f92672">=</span>y, edge_attr<span style="color:#f92672">=</span>edge_weight)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#data_list.append(data)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># save one graph per time</span>
</span></span><span style="display:flex;"><span>            torch<span style="color:#f92672">.</span>save(data, osp<span style="color:#f92672">.</span>join(self<span style="color:#f92672">.</span>processed_dir, <span style="color:#e6db74">&#39;graphDataset1_</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">.pt&#39;</span><span style="color:#f92672">.</span>format(i)))
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">len</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> len(self<span style="color:#f92672">.</span>processed_file_names)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get</span>(self, idx):
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>load(osp<span style="color:#f92672">.</span>join(self<span style="color:#f92672">.</span>processed_dir, <span style="color:#e6db74">&#39;graphDataset1_</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">.pt&#39;</span><span style="color:#f92672">.</span>format(idx)))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># usage</span>
</span></span><span style="display:flex;"><span>dataset_graph_1 <span style="color:#f92672">=</span> GraphDataset_1(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;./&#39;</span>)
</span></span><span style="display:flex;"><span>print(dataset_graph_1[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>print(dataset_graph_1[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Data(edge_attr=[504, 1], edge_index=[2, 504], x=[50, 3], y=[1])</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Data(edge_attr=[495, 1], edge_index=[2, 495], x=[50, 3], y=[1])</span>
</span></span></code></pre></div><h4 id="3-node-classification">.3. Node Classification</h4>
<ul>
<li>in on graph</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> os.path <span style="color:#66d9ef">as</span> osp
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch_geometric.data <span style="color:#f92672">import</span> Dataset
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NodeDatasetInMem</span>(InMemoryDataset):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    node classification in one graph
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Should define the mask for training, validation and test
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, root, num_train_per_class<span style="color:#f92672">=</span><span style="color:#ae81ff">15</span>, num_val<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>, num_test<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>, transform<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, pre_transform<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>num_train_per_class <span style="color:#f92672">=</span> num_train_per_class
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>num_val <span style="color:#f92672">=</span> num_val
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>num_test <span style="color:#f92672">=</span> num_test
</span></span><span style="display:flex;"><span>        super(NodeDatasetInMem, self)<span style="color:#f92672">.</span>__init__(root,transform, pre_transform)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>data, self<span style="color:#f92672">.</span>slices <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>load(self<span style="color:#f92672">.</span>processed_paths[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@property</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">raw_file_names</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@property</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">processed_file_names</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> [<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;.\NodeDatasetInMem.dataset&#39;</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">download</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process</span>(self):
</span></span><span style="display:flex;"><span>        num_train_per_class <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>num_train_per_class
</span></span><span style="display:flex;"><span>        num_val <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>num_val
</span></span><span style="display:flex;"><span>        num_test <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>num_test
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#data_list = []  # node classification do not neet to define data_list just data (one graph)</span>
</span></span><span style="display:flex;"><span>        i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        source_nodes, target_nodes <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>nonzero(Adj[i, :, :])
</span></span><span style="display:flex;"><span>        source_nodes <span style="color:#f92672">=</span> source_nodes<span style="color:#f92672">.</span>reshape((<span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>        target_nodes <span style="color:#f92672">=</span> target_nodes<span style="color:#f92672">.</span>reshape((<span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        edge_index <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(np<span style="color:#f92672">.</span>concatenate((source_nodes, target_nodes), axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>), dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>long) <span style="color:#75715e"># edge_index should be long type</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        edge_weight <span style="color:#f92672">=</span> edge_feature[i, source_nodes, target_nodes]
</span></span><span style="display:flex;"><span>        edge_weight <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(edge_weight<span style="color:#f92672">.</span>reshape((<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, num_edge_features)), dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>float) <span style="color:#75715e"># edge_index should be float</span>
</span></span><span style="display:flex;"><span>        type
</span></span><span style="display:flex;"><span>        train_mask <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros((num_node,), dtype<span style="color:#f92672">=</span>bool)
</span></span><span style="display:flex;"><span>        val_mask <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros((num_node,), dtype<span style="color:#f92672">=</span>bool)
</span></span><span style="display:flex;"><span>        test_mask <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros((num_node,), dtype<span style="color:#f92672">=</span>bool)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        label <span style="color:#f92672">=</span> node_label[i, :]
</span></span><span style="display:flex;"><span>        [org_class_0_ind] <span style="color:#f92672">=</span>  np<span style="color:#f92672">.</span>nonzero(label <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) 
</span></span><span style="display:flex;"><span>        org_class_0_ind <span style="color:#f92672">=</span> org_class_0_ind<span style="color:#f92672">.</span>reshape(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        perm_class_0_ind <span style="color:#f92672">=</span> org_class_0_ind[np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>permutation(org_class_0_ind<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>])]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        [org_class_1_ind] <span style="color:#f92672">=</span>  np<span style="color:#f92672">.</span>nonzero(label <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) 
</span></span><span style="display:flex;"><span>        org_class_1_ind <span style="color:#f92672">=</span> org_class_1_ind<span style="color:#f92672">.</span>reshape(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        perm_class_1_ind <span style="color:#f92672">=</span> org_class_1_ind[np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>permutation(org_class_1_ind<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>])]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        train_ind <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>concatenate((perm_class_0_ind[:num_train_per_class], perm_class_1_ind[:num_train_per_class]), axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        train_mask[train_ind] <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        [remaining] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>nonzero(<span style="color:#f92672">~</span>train_mask)
</span></span><span style="display:flex;"><span>        remaining <span style="color:#f92672">=</span> remaining<span style="color:#f92672">.</span>reshape(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        val_mask[remaining[:num_val]] <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        test_mask[remaining[num_val:num_val<span style="color:#f92672">+</span>num_test]] <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        train_mask <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(train_mask, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>bool) <span style="color:#75715e"># mask should be long type</span>
</span></span><span style="display:flex;"><span>        val_mask <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(val_mask, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>bool)
</span></span><span style="display:flex;"><span>        test_mask <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(test_mask, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>bool)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(node_feature[i, :, :], dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>float) 
</span></span><span style="display:flex;"><span>        y <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(node_label[i, :], dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>long) <span style="color:#75715e"># y should be long type</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> Data(x<span style="color:#f92672">=</span>x, edge_index<span style="color:#f92672">=</span>edge_index, y<span style="color:#f92672">=</span>y, edge_attr<span style="color:#f92672">=</span>edge_weight, train_mask <span style="color:#f92672">=</span> train_mask, val_mask <span style="color:#f92672">=</span> val_mask, test_mask <span style="color:#f92672">=</span> test_mask)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        data, slices <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>collate([data])
</span></span><span style="display:flex;"><span>        torch<span style="color:#f92672">.</span>save((data, slices), self<span style="color:#f92672">.</span>processed_paths[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span> <span style="color:#75715e">#output</span>
</span></span><span style="display:flex;"><span>dataset_node_InMem <span style="color:#f92672">=</span> NodeDatasetInMem(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;./&#39;</span>)
</span></span><span style="display:flex;"><span>print(dataset_node_InMem[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>y)
</span></span><span style="display:flex;"><span>print(dataset_node_InMem[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>y<span style="color:#f92672">.</span>shape)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#tensor([1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 0, 1,0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 1, 1, 1,1, 1])</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#torch.Size([50])</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NodeDataset</span>(Dataset):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    node classification in one graph
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Should define the mask for training, validation and test
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, root, num_train_per_class<span style="color:#f92672">=</span><span style="color:#ae81ff">15</span>, num_val<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>, num_test<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>, transform<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, pre_transform<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>num_train_per_class <span style="color:#f92672">=</span> num_train_per_class
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>num_val <span style="color:#f92672">=</span> num_val
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>num_test <span style="color:#f92672">=</span> num_test
</span></span><span style="display:flex;"><span>        super(NodeDataset, self)<span style="color:#f92672">.</span>__init__(root,transform, pre_transform)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Do not load the data and slices here</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#self.data, self.slices = torch.load(self.processed_paths[0])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@property</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">raw_file_names</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@property</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">processed_file_names</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> [<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;./NodeDataset_0.pt&#39;</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">download</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process</span>(self):
</span></span><span style="display:flex;"><span>        num_train_per_class <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>num_train_per_class
</span></span><span style="display:flex;"><span>        num_val <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>num_val
</span></span><span style="display:flex;"><span>        num_test <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>num_test
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#data_list = []  # node classification do not neet to define data_list just data (one graph)</span>
</span></span><span style="display:flex;"><span>        i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        source_nodes, target_nodes <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>nonzero(Adj[i, :, :])
</span></span><span style="display:flex;"><span>        source_nodes <span style="color:#f92672">=</span> source_nodes<span style="color:#f92672">.</span>reshape((<span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>        target_nodes <span style="color:#f92672">=</span> target_nodes<span style="color:#f92672">.</span>reshape((<span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        edge_index <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(np<span style="color:#f92672">.</span>concatenate((source_nodes, target_nodes), axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>), dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>long) <span style="color:#75715e"># edge_index should be long type</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        edge_weight <span style="color:#f92672">=</span> edge_feature[i, source_nodes, target_nodes]
</span></span><span style="display:flex;"><span>        edge_weight <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(edge_weight<span style="color:#f92672">.</span>reshape((<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, num_edge_features)), dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>float) <span style="color:#75715e"># edge_index should be float</span>
</span></span><span style="display:flex;"><span>        type
</span></span><span style="display:flex;"><span>        train_mask <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros((num_node,), dtype<span style="color:#f92672">=</span>bool)
</span></span><span style="display:flex;"><span>        val_mask <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros((num_node,), dtype<span style="color:#f92672">=</span>bool)
</span></span><span style="display:flex;"><span>        test_mask <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros((num_node,), dtype<span style="color:#f92672">=</span>bool)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        label <span style="color:#f92672">=</span> node_label[i, :]
</span></span><span style="display:flex;"><span>        [org_class_0_ind] <span style="color:#f92672">=</span>  np<span style="color:#f92672">.</span>nonzero(label <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) 
</span></span><span style="display:flex;"><span>        org_class_0_ind <span style="color:#f92672">=</span> org_class_0_ind<span style="color:#f92672">.</span>reshape(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        perm_class_0_ind <span style="color:#f92672">=</span> org_class_0_ind[np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>permutation(org_class_0_ind<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>])]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        [org_class_1_ind] <span style="color:#f92672">=</span>  np<span style="color:#f92672">.</span>nonzero(label <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) 
</span></span><span style="display:flex;"><span>        org_class_1_ind <span style="color:#f92672">=</span> org_class_1_ind<span style="color:#f92672">.</span>reshape(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        perm_class_1_ind <span style="color:#f92672">=</span> org_class_1_ind[np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>permutation(org_class_1_ind<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>])]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        train_ind <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>concatenate((perm_class_0_ind[:num_train_per_class], perm_class_1_ind[:num_train_per_class]), axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        train_mask[train_ind] <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        [remaining] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>nonzero(<span style="color:#f92672">~</span>train_mask)
</span></span><span style="display:flex;"><span>        remaining <span style="color:#f92672">=</span> remaining<span style="color:#f92672">.</span>reshape(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        val_mask[remaining[:num_val]] <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        test_mask[remaining[num_val:num_val<span style="color:#f92672">+</span>num_test]] <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        train_mask <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(train_mask, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>bool) <span style="color:#75715e"># mask should be long type</span>
</span></span><span style="display:flex;"><span>        val_mask <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(val_mask, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>bool)
</span></span><span style="display:flex;"><span>        test_mask <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(test_mask, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>bool)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(node_feature[i, :, :], dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>float) 
</span></span><span style="display:flex;"><span>        y <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(node_label[i, :], dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>long) <span style="color:#75715e"># y should be long type</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> Data(x<span style="color:#f92672">=</span>x, edge_index<span style="color:#f92672">=</span>edge_index, y<span style="color:#f92672">=</span>y, edge_attr<span style="color:#f92672">=</span>edge_weight, train_mask <span style="color:#f92672">=</span> train_mask, val_mask <span style="color:#f92672">=</span> val_mask, test_mask <span style="color:#f92672">=</span> test_mask)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Directly save the data in order as .pt form</span>
</span></span><span style="display:flex;"><span>        torch<span style="color:#f92672">.</span>save(data, osp<span style="color:#f92672">.</span>join(self<span style="color:#f92672">.</span>processed_dir, <span style="color:#e6db74">&#39;NodeDataset_</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">.pt&#39;</span><span style="color:#f92672">.</span>format(i)))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">len</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> len(self<span style="color:#f92672">.</span>processed_file_names)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get</span>(self, idx):
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>load(osp<span style="color:#f92672">.</span>join(self<span style="color:#f92672">.</span>processed_dir, <span style="color:#e6db74">&#39;NodeDataset_</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">.pt&#39;</span><span style="color:#f92672">.</span>format(idx)))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> data
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>dataset_node <span style="color:#f92672">=</span> NodeDataset(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;./&#39;</span>)
</span></span><span style="display:flex;"><span>dataset_node[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Data(edge_attr=[504, 1], edge_index=[2, 504], test_mask=[50], train_mask=[50], val_mask=[50], x=[50, 3], y=[50])</span>
</span></span></code></pre></div><h3 id="resouce">Resouce</h3>
<ul>
<li><a href="https://github.com/rusty1s/pytorch_geometric"target="_blank" rel="external nofollow noopener noreferrer">pytorch_geometric11.3k <i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> <a href="https://pytorch-geometric.readthedocs.io/en/latest/notes/colabs.html"target="_blank" rel="external nofollow noopener noreferrer">pytorch_geometric11.3k_demo<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://github.com/benedekrozemberczki/pytorch_geometric_temporal"target="_blank" rel="external nofollow noopener noreferrer">pytorch_geometric_temporal<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a>  : A Temporal Extension Library for PyTorch Geometric</li>
<li><a href="https://pytorch-geometric.readthedocs.io/en/latest/notes/introduction.html"target="_blank" rel="external nofollow noopener noreferrer">https://pytorch-geometric.readthedocs.io/en/latest/notes/introduction.html<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://colab.research.google.com/drive/1h3-vJGRVloF5zStxL5I0rSy4ZUPNsjy8?usp=sharing"target="_blank" rel="external nofollow noopener noreferrer">Introduction: Hands-on Graph Neural Networks<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://colab.research.google.com/drive/14OvFnAXggxB8vM4e8vSURUp1TaKnovzX?usp=sharing"target="_blank" rel="external nofollow noopener noreferrer">Node Classification with Graph Neural Networks<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://colab.research.google.com/drive/1I8a0DfQ3fI7Njc62__mVXUlcAleUclnb?usp=sharing"target="_blank" rel="external nofollow noopener noreferrer">Graph Classification with Graph Neural Networks<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://colab.research.google.com/drive/1XAjcjRHrSR_ypCk_feIWFbcBKyT4Lirs?usp=sharing"target="_blank" rel="external nofollow noopener noreferrer">Scaling Graph Neural Networks<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://colab.research.google.com/drive/1D45E5bUK3gQ40YpZo65ozs7hg5l-eo_U?usp=sharing"target="_blank" rel="external nofollow noopener noreferrer">Point Cloud Classification with Graph Neural Networks<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://colab.research.google.com/drive/1fLJbFPz0yMCQg81DdCP5I8jXw9LoggKO?usp=sharing"target="_blank" rel="external nofollow noopener noreferrer">Explaining GNN Model Predictions using Captum<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="http://htmlpreview.github.io/?https://github.com/rusty1s/rusty1s.github.io/blob/master/pyg_notebook.html"target="_blank" rel="external nofollow noopener noreferrer">Fast Graph Representation<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://github.com/GQ93/Pytorch-geometric-notes/blob/master/costumed_graph_datasets.ipynb"target="_blank" rel="external nofollow noopener noreferrer">custom dataset<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
</ul>
</div>
<div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title=2023-12-31&#32;16:20:25>更新于 2023-12-31&nbsp;</span>
      </div><div class="post-info-license">
          <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
        </div></div>
    <div class="post-info-line">
      <div class="post-info-md"><span><a href="/pytorchgnn/index.md" title="阅读原始文档" class="link-to-markdown">阅读原始文档</a></span><span><a href="https://liudongdong1.github.io/edit/master/content/posts%5c%e6%97%b6%e7%a9%ba%e6%95%b0%e6%8d%ae%5cGNN%5cPytorchGNN.md" title="编辑此页"target="_blank" rel="external nofollow noopener noreferrer" class="link-to-edit">编辑此页</a></span></div>
      <div class="post-info-share">
        <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://liudongdong1.github.io/pytorchgnn/" data-title="PytorchGNN" data-hashtags="pytorch,GNN"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://liudongdong1.github.io/pytorchgnn/" data-hashtag="pytorch"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://liudongdong1.github.io/pytorchgnn/" data-title="PytorchGNN" data-image="https://cdn.pixabay.com/photo/2021/05/19/14/31/dandelion-6266230__340.jpg"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/pytorch/">pytorch</a>,&nbsp;<a href="/tags/gnn/">GNN</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/frfntptn/" class="prev" rel="prev" title="FRFNTPTN"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>FRFNTPTN</a>
      <a href="/pytorch3d/" class="next" rel="next" title="Pytorch3D">Pytorch3D<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.118.2">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.2.17-RC"><img class="fixit-icon" src="/fixit.min.svg" alt="FixIt logo" />&nbsp;FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2020 - 2024</span><span class="author" itemprop="copyrightHolder">
              <a href="https://liudongdong1.github.io/"target="_blank" rel="external nofollow noopener noreferrer">LiuDongdong</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div><div class="footer-line statistics"><span class="site-time" title='网站运行中 ...'><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden="true"></i>&nbsp;<span class="run-times">网站运行中 ...</span></span></div><div class="footer-line ibruce">
          <span id="busuanzi_container_site_uv" title='总访客数'><i class="fa-regular fa-user fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span><span id="busuanzi_container_site_pv" class="footer-divider" title='总访问量'><i class="fa-regular fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span>
        </div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric">0%</span>
        </div></div><a href="https://liudongdong1.github.io/" title="在 GitHub 上查看源代码"target="_blank" rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;--bg-progress: #0076ff;--bg-progress-dark: #fff;"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/algoliasearch/algoliasearch-lite.umd.min.js" defer></script><script src="/lib/lazysizes/lazysizes.min.js" async defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="/lib/pangu/pangu.min.js" defer></script><script src="/lib/cell-watermark/watermark.min.js" defer></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"data":{"typeit-header-subtitle-desktop":"\u003cspan style='font-family: MMT,\"沐目体\";'\u003e吾日三省吾身\u003c/span\u003e","typeit-header-subtitle-mobile":"\u003cspan style='font-family: MMT,\"沐目体\";'\u003e吾日三省吾身\u003c/span\u003e"},"enablePWA":true,"enablePangu":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"2R1K9SKLQZ","algoliaIndex":"index.zh-cn","algoliaSearchKey":"4a226aa1c5c98d6859e4d1386adb2bc7","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"siteTime":"2020-12-18T16:15:22+08:00","typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"typeit-header-subtitle-desktop":["typeit-header-subtitle-desktop"],"typeit-header-subtitle-mobile":["typeit-header-subtitle-mobile"]},"duration":-1,"speed":100},"watermark":{"appendto":".wrapper\u003emain","colspacing":30,"content":"\u003cimg class=\"fixit-icon\" src=\"/fixit.min.svg\" alt=\"FixIt logo\" /\u003e FixIt 主题","enable":true,"fontfamily":"inherit","fontsize":0.85,"height":21,"opacity":0.0125,"rotate":15,"rowspacing":60,"width":150}};</script><script src="/js/theme.min.js" defer></script><script src="/js/custom.min.js" defer></script></body>
</html>
