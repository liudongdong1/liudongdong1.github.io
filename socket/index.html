<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>Socket - DAY By DAY</title><meta name="author" content="LiuDongdong">
<meta name="author-link" content="https://liudongdong1.github.io/">
<meta name="description" content="socket屏蔽了各个协议的通信细节，使得程序员无需关注协议本身，直接使用socket提供的接口来进行互联的不同主机间的进程的通信。 1.API .1. socket 接" /><meta name="keywords" content='Python, Network' /><meta itemprop="name" content="Socket">
<meta itemprop="description" content="socket屏蔽了各个协议的通信细节，使得程序员无需关注协议本身，直接使用socket提供的接口来进行互联的不同主机间的进程的通信。 1.API .1. socket 接"><meta itemprop="datePublished" content="2021-05-10T21:31:56+00:00" />
<meta itemprop="dateModified" content="2023-09-24T17:00:05+08:00" />
<meta itemprop="wordCount" content="8464"><meta itemprop="image" content="https://liudongdong1.github.io/logo.png"/>
<meta itemprop="keywords" content="Python,Network," /><meta property="og:title" content="Socket" />
<meta property="og:description" content="socket屏蔽了各个协议的通信细节，使得程序员无需关注协议本身，直接使用socket提供的接口来进行互联的不同主机间的进程的通信。 1.API .1. socket 接" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://liudongdong1.github.io/socket/" /><meta property="og:image" content="https://liudongdong1.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-05-10T21:31:56+00:00" />
<meta property="article:modified_time" content="2023-09-24T17:00:05+08:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://liudongdong1.github.io/logo.png"/>

<meta name="twitter:title" content="Socket"/>
<meta name="twitter:description" content="socket屏蔽了各个协议的通信细节，使得程序员无需关注协议本身，直接使用socket提供的接口来进行互联的不同主机间的进程的通信。 1.API .1. socket 接"/>
<meta name="application-name" content="DAY By DAY">
<meta name="apple-mobile-web-app-title" content="DAY By DAY"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://liudongdong1.github.io/socket/" /><link rel="prev" href="https://liudongdong1.github.io/iostream/" /><link rel="next" href="https://liudongdong1.github.io/number/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Socket",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/liudongdong1.github.io\/socket\/"
    },"genre": "posts","keywords": "Python, Network","wordcount":  8464 ,
    "url": "https:\/\/liudongdong1.github.io\/socket\/","datePublished": "2021-05-10T21:31:56+00:00","dateModified": "2023-09-24T17:00:05+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
      "@type": "Organization",
      "name": "LiuDongdong","logo": "https:\/\/liudongdong1.github.io\/images\/person.png"},"author": {
        "@type": "Person",
        "name": "liudongdong1"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="auto" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper" data-github-corner="right">
    <div class="header-title">
      <a href="/" title="DAY By DAY"><img
    class="lazyload logo"
    src="/svg/loading.min.svg"
    data-src="/fixit.min.svg"
    data-srcset="/fixit.min.svg, /fixit.min.svg 1.5x, /fixit.min.svg 2x"
    data-sizes="auto"
    alt="DAY By DAY"
    title="DAY By DAY"/><span class="header-title-text"></span></a><span id="typeit-header-subtitle-desktop" class="typeit header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 所有文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/friends/"
                title="友情链接"
                
              ><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden="true"></i> 友链</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              ><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden="true"></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item language">
            <span role="button" aria-label="选择语言" title="选择语言">简体中文<i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden="true"></i>
            </span>
            <ul class="sub-menu"><li class="menu-item">没有更多翻译</li></ul>
          </li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li>
      </ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="DAY By DAY"><img
    class="lazyload logo"
    src="/svg/loading.min.svg"
    data-src="/fixit.min.svg"
    data-srcset="/fixit.min.svg, /fixit.min.svg 1.5x, /fixit.min.svg 2x"
    data-sizes="auto"
    alt="/fixit.min.svg"
    title="/fixit.min.svg"/><span class="header-title-text"></span></a><span id="typeit-header-subtitle-mobile" class="typeit header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 所有文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/friends/"
                  title="友情链接"
                  
                ><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden="true"></i> 友链</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                ><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden="true"></i> 关于</a></li><li
              class="menu-item text-center"
            ><a
                  class="menu-link"
                  href="/"
                  title="GitHub"
                  
                ><i class='fa-brands fa-github fa-fw' aria-hidden='true'></i> </a></li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li><li class="menu-item language">
            <span role="button" aria-label="选择语言" title="选择语言">简体中文<i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden="true"></i>
            </span>
            <select class="language-select" onchange="location = this.value;"><option disabled>没有更多翻译</option></select>
          </li></ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container" data-page-style="normal"><aside class="toc" id="toc-auto"><h2 class="toc-title">目录 <i class="toc-icon fa-solid fa-angle-down fa-fw"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside>

  <aside class="aside-custom" id="aside-sakana">
    

<div class="sakana-widget">
  <div class="sakana-item" id="takina-widget"></div>
  <div class="sakana-item" id="chisato-widget"></div>
</div>
<script>
  function initSakanaWidget() {
    const takina = SakanaWidget.getCharacter('takina')
    SakanaWidget.registerCharacter('takina-slow', takina);
    new SakanaWidget({
      character: 'takina-slow',
      controls: false,
      autoFit: true,
      stroke: {
        color: "#b4b4b4",
        width: 2
      }
    }).mount('#takina-widget');

    const chisato = SakanaWidget.getCharacter('chisato')
    SakanaWidget.registerCharacter('chisato-slow', chisato);
    new SakanaWidget({
      character: 'chisato-slow',
      controls: false,
      autoFit: true,
      stroke: {
        color: "#b4b4b4",
        width: 2
      }
    }).mount('#chisato-widget');
  }
</script>
<script async onload="initSakanaWidget()" src="https://cdn.jsdelivr.net/npm/sakana-widget@2.3.0/lib/sakana.min.js">
</script></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX">
        <span>Socket</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      liudongdong1</span></span>
          <span class="post-category">收录于 <a href="/categories/"><i class="fa-regular fa-folder fa-fw"></i>&nbsp;Categories</a>&ensp;<a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/"><i class="fa-regular fa-folder fa-fw"></i>&nbsp;编程语言</a></span></div>
      <div class="post-meta-line"><span title=2021-05-10&#32;21:31:56>
            <i class="fa-regular fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-05-10" >2021-05-10</time>
          </span>&nbsp;<i class="fa-solid fa-pencil-alt fa-fw"></i>&nbsp;约 8464 字&nbsp;
        <i class="fa-regular fa-clock fa-fw"></i>&nbsp;预计阅读 17 分钟&nbsp;<span id="busuanzi_container_page_pv" class="busuanzi_visitors comment-visitors" data-flag-title="Socket">
            <i class="fa-regular fa-eye fa-fw"></i>&nbsp;<span id="busuanzi_value_page_pv">-</span>&nbsp;次阅读
          </span>&nbsp;</div>
    </div><div class="featured-image"><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://gitee.com/github-25970295/blogImage/raw/master/img/20210510110733.png"
    data-srcset="https://gitee.com/github-25970295/blogImage/raw/master/img/20210510110733.png, https://gitee.com/github-25970295/blogImage/raw/master/img/20210510110733.png 1.5x, https://gitee.com/github-25970295/blogImage/raw/master/img/20210510110733.png 2x"
    data-sizes="auto"
    alt="https://gitee.com/github-25970295/blogImage/raw/master/img/20210510110733.png"
    title="https://gitee.com/github-25970295/blogImage/raw/master/img/20210510110733.png"/></div><div class="details toc" id="toc-static" kept="true">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1api">1.API</a></li>
        <li><a href="#2-python">2. python</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div
      class="content"
      id="content"
      
      
    ><blockquote>
<p>socket屏蔽了各个协议的通信细节，使得程序员无需关注协议本身，直接使用socket提供的接口来进行互联的不同主机间的进程的通信。</p>
</blockquote>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://gitee.com/github-25970295/blogImage/raw/master/img/20210510111010.png"
    data-srcset="https://gitee.com/github-25970295/blogImage/raw/master/img/20210510111010.png, https://gitee.com/github-25970295/blogImage/raw/master/img/20210510111010.png 1.5x, https://gitee.com/github-25970295/blogImage/raw/master/img/20210510111010.png 2x"
    data-sizes="auto"
    alt="https://gitee.com/github-25970295/blogImage/raw/master/img/20210510111010.png"
    title="https://gitee.com/github-25970295/blogImage/raw/master/img/20210510111010.png"/></p>
<h3 id="1api">1.API</h3>
<h4 id="1--socket-接口">.1.  socket 接口</h4>
<blockquote>
<p>int socket(int protofamily, int so_type, int protocol);</p>
</blockquote>
<ul>
<li>
<p>protofamily 指协议族，常见的值有：</p>
<p>AF_INET，指定so_pcb中的地址要采用ipv4地址类型</p>
<p>AF_INET6，指定so_pcb中的地址要采用ipv6的地址类型</p>
<p>AF_LOCAL/AF_UNIX，指定so_pcb中的地址要使用绝对路径名</p>
<p>当然也还有其他的协议族，用到再学习了</p>
</li>
<li>
<p>so_type 指定socket的类型，也就是上面讲到的so_type字段，比较常用的类型有：</p>
<p>SOCK_STREAM:对应tcp</p>
<p>SOCK_DGRAM：对应udp</p>
<p>SOCK_RAW：自定义协议或者直接对应ip层</p>
</li>
<li>
<p>protocol 指定具体的协议，也就是指定本次通信能接受的数据包的类型和发送数据包的类型，常见的值有：</p>
<p>IPPROTO_TCP，TCP协议</p>
<p>IPPROTO_UDP，UPD协议</p>
<p>0，如果指定为0，表示由内核根据so_type指定默认的通信协议</p>
</li>
</ul>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://gitee.com/github-25970295/blogImage/raw/master/img/20210510111221.png"
    data-srcset="https://gitee.com/github-25970295/blogImage/raw/master/img/20210510111221.png, https://gitee.com/github-25970295/blogImage/raw/master/img/20210510111221.png 1.5x, https://gitee.com/github-25970295/blogImage/raw/master/img/20210510111221.png 2x"
    data-sizes="auto"
    alt="https://gitee.com/github-25970295/blogImage/raw/master/img/20210510111221.png"
    title="https://gitee.com/github-25970295/blogImage/raw/master/img/20210510111221.png"/></p>
<blockquote>
<p>int bind(int sockfd, const struct sockaddr *addr, socklen_t addrlen);</p>
</blockquote>
<p>bind函数就是给图三种so_pcb结构中的地址赋值的接口</p>
<ul>
<li>sockfd 是调用socket()函数创建的socket描述符</li>
<li>addr 是具体的地址</li>
<li>addrlen 表示addr的长度</li>
</ul>
<p>举struct sockaddr其实是void的typedef，其常见的结构如下图（图片来源传智播客邢文鹏linux系统编程的笔记），这也是为什么需要addrlen参数的原因，不同的地址类型，其地址长度不一样：</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://img2018.cnblogs.com/blog/988061/201809/988061-20180904170327305-518430882.png"
    data-srcset="https://img2018.cnblogs.com/blog/988061/201809/988061-20180904170327305-518430882.png, https://img2018.cnblogs.com/blog/988061/201809/988061-20180904170327305-518430882.png 1.5x, https://img2018.cnblogs.com/blog/988061/201809/988061-20180904170327305-518430882.png 2x"
    data-sizes="auto"
    alt="https://img2018.cnblogs.com/blog/988061/201809/988061-20180904170327305-518430882.png"
    title="https://img2018.cnblogs.com/blog/988061/201809/988061-20180904170327305-518430882.png"/></p>
<blockquote>
<p>int connect(int sockfd, const struct sockaddr *addr, socklen_t addrlen);</p>
</blockquote>
<p>这三个参数和bind的三个参数类型一直，只不过此处strcut sockaddr表示对端公开的地址。三个参数都是传入参数。connect顾名思义就是拿来建立连接的函数，只有像tcp这样面向连接、提供可靠服务的协议才需要建立连接</p>
<blockquote>
<p>int listen(int sockfd, int backlog)</p>
</blockquote>
<p>告知内核在sockfd这个描述符上监听是否有连接到来，并设置同时能完成的最大连接数为backlog当调用listen后，内核就会建立两个队列，一个SYN队列，表示接受到请求，但未完成三次握手的连接；另一个是ACCEPT队列，表示已经完成了三次握手的队列</p>
<ul>
<li>sockfd 是调用socket()函数创建的socket描述符</li>
<li>backlog 已经完成三次握手而等待accept的连接数</li>
</ul>
<p>关于backlog , man listen的描述如下：</p>
<ul>
<li>The behavior of the backlog argument on TCP sockets changed with Linux 2.2. Now it specifies the queue length for completely established sockets waiting to be accepted, instead of the number of incomplete connection requests. The maximum length of the queue for incomplete sockets can be set using /proc/sys/net/ipv4/tcp_max_syn_backlog. When syncookies are enabled there is no logical maximum length and this setting is ignored. See tcp(7) for more information.翻译：TCP套接字上的积压参数的行为随着Linux 2.2而改变。现在，它指定等待被接受的完全建立的套接字的队列长度，而不是不完整连接请求的数量。不完整套接字队列的最大长度可以使用/PRO/sys／NET/IPv4/TCPPMAX Syth-ByLoSQL来设置。当启用同步功能时，没有逻辑最大长度，并且忽略该设置。有关更多信息，请参见TCP（7）。</li>
<li>If the backlog argument is greater than the value in /proc/sys/net/core/somaxconn, then it is silently truncated to that value; the default value in this file is 128. In kernels before 2.4.25, this limit was a hard coded value, SOMAXCONN, with the value 128.如果backlog参数大于/proc/sys/net/core/somaxconn中的值，那么它将被悄悄地截断为该值；该文件中的默认值为128。在2.4.25之前的内核中，这个限制是一个硬编码的值，SOMAXCONN，值为128。</li>
</ul>
<blockquote>
<p>accept接口</p>
</blockquote>
<p>int accept(int listen_sockfd, struct sockaddr *addr, socklen_t *addrlen)</p>
<p>这三个参数与bind的三个参数含义一致，不过，此处的后两个参数是传出参数。在使用listen函数告知内核监听的描述符后，内核就会建立两个队列，一个SYN队列，表示接受到请求，但未完成三次握手的连接；另一个是ACCEPT队列，表示已经完成了三次握手的队列。而accept函数就是从ACCEPT队列中拿一个连接，并生成一个新的描述符，新的描述符所指向的结构体so_pcb中的请求端ip地址、请求端端口将被初始化。</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://gitee.com/github-25970295/blogImage/raw/master/img/20210510111521.png"
    data-srcset="https://gitee.com/github-25970295/blogImage/raw/master/img/20210510111521.png, https://gitee.com/github-25970295/blogImage/raw/master/img/20210510111521.png 1.5x, https://gitee.com/github-25970295/blogImage/raw/master/img/20210510111521.png 2x"
    data-sizes="auto"
    alt="https://gitee.com/github-25970295/blogImage/raw/master/img/20210510111521.png"
    title="https://gitee.com/github-25970295/blogImage/raw/master/img/20210510111521.png"/></p>
<blockquote>
<ol>
<li>服务器端在调用listen之后，内核会建立两个队列，SYN队列和ACCEPT队列，其中ACCPET队列的长度由backlog指定。</li>
<li>服务器端在调用accpet之后，将阻塞，等待ACCPT队列有元素。</li>
<li>客户端在调用connect之后，将开始发起SYN请求，请求与服务器建立连接，此时称为第一次握手。</li>
<li>服务器端在接受到SYN请求之后，把请求方放入SYN队列中，并给客户端回复一个确认帧ACK，此帧还会携带一个请求与客户端建立连接的请求标志，也就是SYN，这称为第二次握手</li>
<li>客户端收到SYN+ACK帧后，connect返回，并发送确认建立连接帧ACK给服务器端。这称为第三次握手</li>
<li>服务器端收到ACK帧后，会把请求方从SYN队列中移出，放至ACCEPT队列中，而accept函数也等到了自己的资源，从阻塞中唤醒，从ACCEPT队列中取出请求方，重新建立一个新的sockfd，并返回。</li>
</ol>
</blockquote>
<ul>
<li>TCP:
<ul>
<li>send函数只负责将数据提交给协议层。 当调用该函数时，send先比较待发送数据的长度len和套接字s的发送缓冲区的长度，如果len大于s的发送缓冲区的长度，该函数返回SOCKET_ERROR； 如果len小于或者等于s的发送缓冲区的长度，那么send先检查协议是否正在发送s的发送缓冲中的数据； 如果是就等待协议把数据发送完，如果协议还没有开始发送s的发送缓冲中的数据或者s的发送缓冲中没有数据，那么send就比较s的发送缓冲区的剩余空间和len； 如果len大于剩余空间大小，send就一直等待协议把s的发送缓冲中的数据发送完，如果len小于剩余空间大小，send就仅仅把buf中的数据copy到剩余空间里（注意并不是send把s的发送缓冲中的数据传到连接的另一端的，而是协议传的，send仅仅是把buf中的数据copy到s的发送缓冲区的剩余空间里）。 如果send函数copy数据成功，就返回实际copy的字节数，如果send在copy数据时出现错误，那么send就返回SOCKET_ERROR； 如果send在等待协议传送数据时网络断开的话，那么send函数也返回SOCKET_ERROR。要注意send函数把buf中的数据成功copy到s的发送缓冲的剩余空间里后它就返回了，但是此时这些数据并不一定马上被传到连接的另一端。 如果协议在后续的传送过程中出现网络错误的话，那么下一个Socket函数就会返回SOCKET_ERROR。（每一个除send外的Socket函数在执行的最开始总要先等待套接字的发送缓冲中的数据被协议传送完毕才能继续，如果在等待时出现网络错误，那么该Socket函数就返回SOCKET_ERROR）</li>
<li>recv先检查套接字s的接收缓冲区，如果s接收缓冲区中没有数据或者协议正在接收数据，那么recv就一直等待，直到协议把数据接收完毕。当协议把数据接收完毕，recv函数就把s的接收缓冲中的数据copy到buf中（注意协议接收到的数据可能大于buf的长度，所以在这种情况下要调用几次recv函数才能把s的接收缓冲中的数据copy完。recv函数仅仅是copy数据，真正的接收数据是协议来完成的），recv函数返回其实际copy的字节数。如果recv在copy时出错，那么它返回SOCKET_ERROR；如果recv函数在等待协议接收数据时网络中断了，那么它返回0 。对方优雅的关闭socket并不影响本地recv的正常接收数据；如果协议缓冲区内没有数据，recv返回0，指示对方关闭；如果协议缓冲区有数据，则返回对应数据(可能需要多次recv)，在最后一次recv时，返回0，指示对方关闭。</li>
</ul>
</li>
</ul>
<h3 id="2-python">2. python</h3>
<h4 id="21-多线程基本结构">2.1. 多线程基本结构</h4>
<ul>
<li>服务器代码</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!C:\Python3.6.5\python.exe</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -*- coding: gbk -*-</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> threading
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WSGIServer</span>(object):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, port):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;初始化对象&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 创建套接字</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tcp_server_socket <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 解决程序端口占用问题</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tcp_server_socket<span style="color:#f92672">.</span>setsockopt(socket<span style="color:#f92672">.</span>SOL_SOCKET, socket<span style="color:#f92672">.</span>SO_REUSEADDR, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 绑定本地ip地址</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tcp_server_socket<span style="color:#f92672">.</span>bind((<span style="color:#e6db74">&#34;&#34;</span>, port))
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 将套接字变为监听套接字，最大连接数量为100</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tcp_server_socket<span style="color:#f92672">.</span>listen(<span style="color:#ae81ff">100</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run_forever</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;设备连接&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 1.等待设备连接(通过ip地址和端口建立tcp连接)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#   如果有设备连接，则会生成用于设备和服务器通讯的套接字：new_socket</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#   会获取到设备的ip地址和端口</span>
</span></span><span style="display:flex;"><span>            new_socket, client_addr <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>tcp_server_socket<span style="color:#f92672">.</span>accept()
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;设备</span><span style="color:#e6db74">{0}</span><span style="color:#e6db74">已连接&#34;</span><span style="color:#f92672">.</span>format(client_addr))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 2.创建线程处理设备的需求</span>
</span></span><span style="display:flex;"><span>            t1 <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>service_machine, args<span style="color:#f92672">=</span>(new_socket, client_addr))
</span></span><span style="display:flex;"><span>            t1<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">service_machine</span>(self, new_socket, client_addr):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;业务处理&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 3.接收设备发送的数据，单次最大1024字节，按‘gbk’格式解码</span>
</span></span><span style="display:flex;"><span>            receive_data <span style="color:#f92672">=</span> new_socket<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#34;gbk&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 4.如果设备发送的数据不为空</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> receive_data:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 4.1 打印接收的数据，这里可以将设备发送的数据写入到文件中</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 获取设备的ID信息</span>
</span></span><span style="display:flex;"><span>                print(receive_data)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> receive_data[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">6</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;report&#34;</span>:
</span></span><span style="display:flex;"><span>                    response <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SET OK:&#34;</span> <span style="color:#f92672">+</span> receive_data
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                    receive_data <span style="color:#f92672">=</span> receive_data[<span style="color:#ae81ff">6</span>:]<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;,&#34;</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e"># 拼接响应数据</span>
</span></span><span style="display:flex;"><span>                    response <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;alarm=&#34;</span> <span style="color:#f92672">+</span> receive_data <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;,Switch:clear&#34;</span>
</span></span><span style="display:flex;"><span>                print(response)
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 4.2 返回原数据作为应答，按‘utf-8’格式编码</span>
</span></span><span style="display:flex;"><span>                new_socket<span style="color:#f92672">.</span>send(response<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#34;utf-8&#34;</span>))
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 5.当设备断开连接时，会收到空的字节数据，判断设备已断开连接</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#39;设备</span><span style="color:#e6db74">{0}</span><span style="color:#e6db74">断开连接...&#39;</span><span style="color:#f92672">.</span>format(client_addr))
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 关闭套接字</span>
</span></span><span style="display:flex;"><span>        new_socket<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>(port):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;创建一个WEB服务器&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    wsgi_server <span style="color:#f92672">=</span> WSGIServer(port)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;服务器已开启&#34;</span>)
</span></span><span style="display:flex;"><span>    wsgi_server<span style="color:#f92672">.</span>run_forever()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    port <span style="color:#f92672">=</span> <span style="color:#ae81ff">8125</span>     <span style="color:#75715e"># 指定端口</span>
</span></span><span style="display:flex;"><span>    main(<span style="color:#ae81ff">8125</span>)
</span></span></code></pre></div><ul>
<li>客户端</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start_client</span>(addr, port):
</span></span><span style="display:flex;"><span>    PLC_ADDR <span style="color:#f92672">=</span> addr
</span></span><span style="display:flex;"><span>    PLC_PORT <span style="color:#f92672">=</span> port
</span></span><span style="display:flex;"><span>    s <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket()
</span></span><span style="display:flex;"><span>    s<span style="color:#f92672">.</span>connect((PLC_ADDR, PLC_PORT))
</span></span><span style="display:flex;"><span>    count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;进程</span><span style="color:#e6db74">{pid}</span><span style="color:#e6db74">发送数据&#39;</span><span style="color:#f92672">.</span>format(pid<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>getpid())
</span></span><span style="display:flex;"><span>        msg <span style="color:#f92672">=</span> msg<span style="color:#f92672">.</span>encode(encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;utf-8&#39;</span>)
</span></span><span style="display:flex;"><span>        s<span style="color:#f92672">.</span>send(msg)
</span></span><span style="display:flex;"><span>        recv_data <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>        print(recv_data<span style="color:#f92672">.</span>decode(encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;utf-8&#39;</span>))
</span></span><span style="display:flex;"><span>        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>        count <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> count <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">20</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    s<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    start_client(<span style="color:#e6db74">&#39;127.0.0.1&#39;</span>, <span style="color:#ae81ff">8801</span>)
</span></span></code></pre></div><h4 id="22-图片传输pythonc">2.2. 图片传输python+c++</h4>
<ul>
<li>python</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#-*-coding:utf-8 -*-</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> cv2
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 接受图片大小的信息</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">recv_size</span>(sock, count):
</span></span><span style="display:flex;"><span>    buf <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> count:
</span></span><span style="display:flex;"><span>        newbuf <span style="color:#f92672">=</span> sock<span style="color:#f92672">.</span>recv(count)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> newbuf: <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        buf <span style="color:#f92672">+=</span> newbuf
</span></span><span style="display:flex;"><span>        count <span style="color:#f92672">-=</span> len(newbuf)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> buf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 接收图片</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">recv_all</span>(sock, count):
</span></span><span style="display:flex;"><span>    buf <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> count:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 这里每次只接收一个字节的原因是增强python与C++的兼容性</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># python可以发送任意的字符串，包括乱码，但C++发送的字符中不能包含&#39;\0&#39;，也就是字符串结束标志位</span>
</span></span><span style="display:flex;"><span>        newbuf <span style="color:#f92672">=</span> sock<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> newbuf: <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        buf <span style="color:#f92672">+=</span> newbuf
</span></span><span style="display:flex;"><span>        count <span style="color:#f92672">-=</span> len(newbuf)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> buf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># socket.AF_INET用于服务器与服务器之间的网络通信</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># socket.SOCK_STREAM代表基于TCP的流式socket通信</span>
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置地址与端口，如果是接收任意ip对本服务器的连接，地址栏可空，但端口必须设置</span>
</span></span><span style="display:flex;"><span>address <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#ae81ff">8010</span>)
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>bind(address) <span style="color:#75715e"># 将Socket（套接字）绑定到地址</span>
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>listen(<span style="color:#66d9ef">True</span>) <span style="color:#75715e"># 开始监听TCP传入连接</span>
</span></span><span style="display:flex;"><span>print (<span style="color:#e6db74">&#39;Waiting for images...&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 接受TCP链接并返回（conn, addr），其中conn是新的套接字对象，可以用来接收和发送数据，addr是链接客户端的地址。</span>
</span></span><span style="display:flex;"><span>conn, addr <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>accept()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>    length <span style="color:#f92672">=</span> recv_size(conn,<span style="color:#ae81ff">16</span>) <span style="color:#75715e">#首先接收来自客户端发送的大小信息</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> isinstance (length,str): <span style="color:#75715e">#若成功接收到大小信息，进一步再接收整张图片</span>
</span></span><span style="display:flex;"><span>        stringData <span style="color:#f92672">=</span> recv_all(conn, int(length))
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> numpy<span style="color:#f92672">.</span>fromstring(stringData, dtype<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;uint8&#39;</span>)
</span></span><span style="display:flex;"><span>        decimg<span style="color:#f92672">=</span>cv2<span style="color:#f92672">.</span>imdecode(data,<span style="color:#ae81ff">1</span>) <span style="color:#75715e">#解码处理，返回mat图片</span>
</span></span><span style="display:flex;"><span>        cv2<span style="color:#f92672">.</span>imshow(<span style="color:#e6db74">&#39;SERVER&#39;</span>,decimg)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> cv2<span style="color:#f92672">.</span>waitKey(<span style="color:#ae81ff">10</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">27</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span> 
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#39;Image recieved successfully!&#39;</span>)
</span></span><span style="display:flex;"><span>        conn<span style="color:#f92672">.</span>send(<span style="color:#e6db74">&#34;Server has recieved messages!&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> cv2<span style="color:#f92672">.</span>waitKey(<span style="color:#ae81ff">10</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">27</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>cv2<span style="color:#f92672">.</span>destroyAllWindows()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#client</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#-*-coding:utf-8 -*-</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> cv2
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># socket.AF_INET用于服务器与服务器之间的网络通信</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># socket.SOCK_STREAM代表基于TCP的流式socket通信</span>
</span></span><span style="display:flex;"><span>sock <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET,socket<span style="color:#f92672">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 连接服务端</span>
</span></span><span style="display:flex;"><span>address_server <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;10.106.20.111&#39;</span>, <span style="color:#ae81ff">8010</span>)
</span></span><span style="display:flex;"><span>sock<span style="color:#f92672">.</span>connect(address_server)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 从摄像头采集图像</span>
</span></span><span style="display:flex;"><span>capture <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>VideoCapture(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>ret, frame <span style="color:#f92672">=</span> capture<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>encode_param<span style="color:#f92672">=</span>[int(cv2<span style="color:#f92672">.</span>IMWRITE_JPEG_QUALITY),<span style="color:#ae81ff">90</span>] <span style="color:#75715e">#设置编码参数</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> ret: 
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 首先对图片进行编码，因为socket不支持直接发送图片</span>
</span></span><span style="display:flex;"><span>    result, imgencode <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>imencode(<span style="color:#e6db74">&#39;.jpg&#39;</span>, frame)
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> numpy<span style="color:#f92672">.</span>array(imgencode)
</span></span><span style="display:flex;"><span>    stringData <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>tostring()
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 首先发送图片编码后的长度</span>
</span></span><span style="display:flex;"><span>    sock<span style="color:#f92672">.</span>send(str(len(stringData))<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">16</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 然后一个字节一个字节发送编码的内容</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 如果是python对python那么可以一次性发送，如果发给c++的server则必须分开发因为编码里面有字符串结束标志位，c++会截断</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range (<span style="color:#ae81ff">0</span>,len(stringData)):
</span></span><span style="display:flex;"><span>    	sock<span style="color:#f92672">.</span>send(stringData[i])
</span></span><span style="display:flex;"><span>    ret, frame <span style="color:#f92672">=</span> capture<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#cv2.imshow(&#39;CLIENT&#39;,frame)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># if cv2.waitKey(10) == 27:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#     break</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 接收server发送的返回信息</span>
</span></span><span style="display:flex;"><span>    data_r <span style="color:#f92672">=</span> sock<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">50</span>)
</span></span><span style="display:flex;"><span>    print (data_r)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sock<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>cv2<span style="color:#f92672">.</span>destroyAllWindows()
</span></span></code></pre></div><ul>
<li>c++</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Winsock2.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;opencv2/opencv.hpp&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;vector&gt; </span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#pragma comment(lib,&#34;ws2_32.lib&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>using namespace cv;
</span></span><span style="display:flex;"><span>using namespace std;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	WSADATA wsaData;
</span></span><span style="display:flex;"><span>	SOCKET sockServer;
</span></span><span style="display:flex;"><span>	SOCKADDR_IN addrServer;
</span></span><span style="display:flex;"><span>	SOCKET conn;
</span></span><span style="display:flex;"><span>	SOCKADDR_IN addr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">WSAStartup</span>(<span style="color:#a6e22e">MAKEWORD</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>), <span style="color:#f92672">&amp;</span>wsaData);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//����Socket  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	sockServer <span style="color:#f92672">=</span> <span style="color:#a6e22e">socket</span>(AF_INET, SOCK_STREAM, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//׼��ͨ�ŵ�ַ  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	addrServer.sin_addr.S_un.S_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">htonl</span>(INADDR_ANY);
</span></span><span style="display:flex;"><span>	addrServer.sin_family <span style="color:#f92672">=</span> AF_INET;
</span></span><span style="display:flex;"><span>	addrServer.sin_port <span style="color:#f92672">=</span> <span style="color:#a6e22e">htons</span>(<span style="color:#ae81ff">8010</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//��  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">bind</span>(sockServer, (SOCKADDR<span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>addrServer, <span style="color:#66d9ef">sizeof</span>(SOCKADDR));
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//����  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">listen</span>(sockServer, <span style="color:#ae81ff">5</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Waiting for images...</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> len <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(SOCKADDR);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//��������  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	conn <span style="color:#f92672">=</span> <span style="color:#a6e22e">accept</span>(sockServer, (SOCKADDR<span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>addr, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">char</span> recvBuf[<span style="color:#ae81ff">16</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">char</span> recvBuf_1[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>	Mat img_decode;
</span></span><span style="display:flex;"><span>	vector<span style="color:#f92672">&lt;</span>uchar<span style="color:#f92672">&gt;</span> data;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">recv</span>(conn, recvBuf, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">16</span>; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> (recvBuf[i]<span style="color:#f92672">&lt;</span><span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#f92672">||</span> recvBuf[i]<span style="color:#f92672">&gt;</span><span style="color:#e6db74">&#39;9&#39;</span>) recvBuf[i] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39; &#39;</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			data.<span style="color:#a6e22e">resize</span>(<span style="color:#a6e22e">atoi</span>(recvBuf));
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">atoi</span>(recvBuf); i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">recv</span>(conn, recvBuf_1, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>				data[i] <span style="color:#f92672">=</span> recvBuf_1[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Image recieved successfully!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">send</span>(conn, <span style="color:#e6db74">&#34;Server has recieved messages!&#34;</span>, <span style="color:#ae81ff">29</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>			img_decode <span style="color:#f92672">=</span> <span style="color:#a6e22e">imdecode</span>(data, CV_LOAD_IMAGE_COLOR);
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">imshow</span>(<span style="color:#e6db74">&#34;server&#34;</span>, img_decode);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">waitKey</span>(<span style="color:#ae81ff">30</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">27</span>) <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">closesocket</span>(conn);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">WSACleanup</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#client
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Winsock2.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;opencv2/opencv.hpp&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;vector&gt; </span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#pragma comment(lib,&#34;ws2_32.lib&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>using namespace cv;
</span></span><span style="display:flex;"><span>using namespace std;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	WSADATA wsaData;
</span></span><span style="display:flex;"><span>	SOCKET sockClient;<span style="color:#75715e">//�ͻ���Socket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	SOCKADDR_IN addrServer;<span style="color:#75715e">//����˵�ַ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">WSAStartup</span>(<span style="color:#a6e22e">MAKEWORD</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>), <span style="color:#f92672">&amp;</span>wsaData);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//�½��ͻ���socket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	sockClient <span style="color:#f92672">=</span> <span style="color:#a6e22e">socket</span>(AF_INET, SOCK_STREAM, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//����Ҫ���ӵķ���˵�ַ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	addrServer.sin_addr.S_un.S_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">inet_addr</span>(<span style="color:#e6db74">&#34;10.106.20.111&#34;</span>);<span style="color:#75715e">//Ŀ��IP(10.106.20.74�ǻ��͵�ַ)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	addrServer.sin_family <span style="color:#f92672">=</span> AF_INET;
</span></span><span style="display:flex;"><span>	addrServer.sin_port <span style="color:#f92672">=</span> <span style="color:#a6e22e">htons</span>(<span style="color:#ae81ff">8010</span>);<span style="color:#75715e">//���Ӷ˿�
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//���ӵ������
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">connect</span>(sockClient, (SOCKADDR<span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>addrServer, <span style="color:#66d9ef">sizeof</span>(SOCKADDR));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Mat image;
</span></span><span style="display:flex;"><span>	VideoCapture <span style="color:#a6e22e">capture</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	vector<span style="color:#f92672">&lt;</span>uchar<span style="color:#f92672">&gt;</span> data_encode;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>capture.<span style="color:#a6e22e">read</span>(image)) 
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">imencode</span>(<span style="color:#e6db74">&#34;.jpg&#34;</span>, image, data_encode);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">int</span> len_encode <span style="color:#f92672">=</span> data_encode.<span style="color:#a6e22e">size</span>();
</span></span><span style="display:flex;"><span>		string len <span style="color:#f92672">=</span> <span style="color:#a6e22e">to_string</span>(len_encode);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">int</span> length <span style="color:#f92672">=</span> len.<span style="color:#a6e22e">length</span>();
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">16</span> <span style="color:#f92672">-</span> length; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			len <span style="color:#f92672">=</span> len <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; &#34;</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">//��������
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">send</span>(sockClient, len.<span style="color:#a6e22e">c_str</span>(), <span style="color:#a6e22e">strlen</span>(len.<span style="color:#a6e22e">c_str</span>()), <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">char</span> send_char[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> len_encode; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			send_char[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> data_encode[i];
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">send</span>(sockClient, send_char, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">//���շ�����Ϣ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">char</span> recvBuf[<span style="color:#ae81ff">32</span>];
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">recv</span>(sockClient, recvBuf, <span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, recvBuf);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">closesocket</span>(sockClient);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">WSACleanup</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="23-pyqt通信httpsgithubcomwangler2333tcp_udp_web_tools-pyqt5">2.3. <a href="https://github.com/Wangler2333/tcp_udp_web_tools-pyqt5"target="_blank" rel="external nofollow noopener noreferrer">pyqt通信<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></h4>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://gitee.com/github-25970295/blogpictureV2/raw/master/image-20210510155418975.png"
    data-srcset="https://gitee.com/github-25970295/blogpictureV2/raw/master/image-20210510155418975.png, https://gitee.com/github-25970295/blogpictureV2/raw/master/image-20210510155418975.png 1.5x, https://gitee.com/github-25970295/blogpictureV2/raw/master/image-20210510155418975.png 2x"
    data-sizes="auto"
    alt="https://gitee.com/github-25970295/blogpictureV2/raw/master/image-20210510155418975.png"
    title="https://gitee.com/github-25970295/blogpictureV2/raw/master/image-20210510155418975.png"/></p>
<ul>
<li><a href="D:%5cprojectBack%5ctcp_udp_web_tools-pyqt5">TCP_Logic</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> PyQt5 <span style="color:#f92672">import</span> QtWidgets
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> tcp_udp_web_ui
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> threading
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> stopThreading
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TcpLogic</span>(tcp_udp_web_ui<span style="color:#f92672">.</span>ToolsUi):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, num):
</span></span><span style="display:flex;"><span>        super(TcpLogic, self)<span style="color:#f92672">.</span>__init__(num)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tcp_socket <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>sever_th <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>client_th <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>client_socket_list <span style="color:#f92672">=</span> list()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>link <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>  <span style="color:#75715e"># 用于标记是否开启了连接</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tcp_server_start</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        功能函数，TCP服务端开启的方法
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :return: None
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tcp_socket <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 取消主动断开连接四次握手后的TIME_WAIT状态</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tcp_socket<span style="color:#f92672">.</span>setsockopt(socket<span style="color:#f92672">.</span>SOL_SOCKET, socket<span style="color:#f92672">.</span>SO_REUSEADDR, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 设定套接字为非阻塞式</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tcp_socket<span style="color:#f92672">.</span>setblocking(<span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            port <span style="color:#f92672">=</span> int(self<span style="color:#f92672">.</span>lineEdit_port<span style="color:#f92672">.</span>text())
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>tcp_socket<span style="color:#f92672">.</span>bind((<span style="color:#e6db74">&#39;&#39;</span>, port))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> ret:
</span></span><span style="display:flex;"><span>            msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;请检查端口号</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>signal_write_msg<span style="color:#f92672">.</span>emit(msg)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>tcp_socket<span style="color:#f92672">.</span>listen()
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>sever_th <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>tcp_server_concurrency)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>sever_th<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>            msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;TCP服务端正在监听端口:</span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> str(port)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>signal_write_msg<span style="color:#f92672">.</span>emit(msg)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tcp_server_concurrency</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        功能函数，供创建线程的方法；
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        使用子线程用于监听并创建连接，使主线程可以继续运行，以免无响应
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        使用非阻塞式并发用于接收客户端消息，减少系统资源浪费，使软件轻量化
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :return:None
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                client_socket, client_address <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>tcp_socket<span style="color:#f92672">.</span>accept()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> ret:
</span></span><span style="display:flex;"><span>                time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">0.001</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                client_socket<span style="color:#f92672">.</span>setblocking(<span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 将创建的客户端套接字存入列表,client_address为ip和端口的元组</span>
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>client_socket_list<span style="color:#f92672">.</span>append((client_socket, client_address))
</span></span><span style="display:flex;"><span>                msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;TCP服务端已连接IP:</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">端口:</span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> client_address
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>signal_write_msg<span style="color:#f92672">.</span>emit(msg)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 轮询客户端套接字列表，接收数据</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> client, address <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>client_socket_list:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                    recv_msg <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> ret:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> recv_msg:
</span></span><span style="display:flex;"><span>                        msg <span style="color:#f92672">=</span> recv_msg<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)
</span></span><span style="display:flex;"><span>                        msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;来自IP:</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">端口:</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">{}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(address[<span style="color:#ae81ff">0</span>], address[<span style="color:#ae81ff">1</span>], msg)
</span></span><span style="display:flex;"><span>                        self<span style="color:#f92672">.</span>signal_write_msg<span style="color:#f92672">.</span>emit(msg)
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                        client<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>                        self<span style="color:#f92672">.</span>client_socket_list<span style="color:#f92672">.</span>remove((client, address))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tcp_client_start</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        功能函数，TCP客户端连接其他服务端的方法
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :return:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tcp_socket <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            address <span style="color:#f92672">=</span> (str(self<span style="color:#f92672">.</span>lineEdit_ip_send<span style="color:#f92672">.</span>text()), int(self<span style="color:#f92672">.</span>lineEdit_port<span style="color:#f92672">.</span>text()))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> ret:
</span></span><span style="display:flex;"><span>            msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;请检查目标IP，目标端口</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>signal_write_msg<span style="color:#f92672">.</span>emit(msg)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;正在连接目标服务器</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>signal_write_msg<span style="color:#f92672">.</span>emit(msg)
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>tcp_socket<span style="color:#f92672">.</span>connect(address)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> ret:
</span></span><span style="display:flex;"><span>                msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;无法连接目标服务器</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>signal_write_msg<span style="color:#f92672">.</span>emit(msg)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>client_th <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>tcp_client_concurrency, args<span style="color:#f92672">=</span>(address,))
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>client_th<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>                msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;TCP客户端已连接IP:</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">端口:</span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> address
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>signal_write_msg<span style="color:#f92672">.</span>emit(msg)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tcp_client_concurrency</span>(self, address):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        功能函数，用于TCP客户端创建子线程的方法，阻塞式接收
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :return:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>            recv_msg <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>tcp_socket<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> recv_msg:
</span></span><span style="display:flex;"><span>                msg <span style="color:#f92672">=</span> recv_msg<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)
</span></span><span style="display:flex;"><span>                msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;来自IP:</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">端口:</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">{}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(address[<span style="color:#ae81ff">0</span>], address[<span style="color:#ae81ff">1</span>], msg)
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>signal_write_msg<span style="color:#f92672">.</span>emit(msg)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>tcp_socket<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>reset()
</span></span><span style="display:flex;"><span>                msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;从服务器断开连接</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>signal_write_msg<span style="color:#f92672">.</span>emit(msg)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tcp_send</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        功能函数，用于TCP服务端和TCP客户端发送消息
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :return: None
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>link <span style="color:#f92672">is</span> <span style="color:#66d9ef">False</span>:
</span></span><span style="display:flex;"><span>            msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;请选择服务，并点击连接网络</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>signal_write_msg<span style="color:#f92672">.</span>emit(msg)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                send_msg <span style="color:#f92672">=</span> (str(self<span style="color:#f92672">.</span>textEdit_send<span style="color:#f92672">.</span>toPlainText()))<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>comboBox_tcp<span style="color:#f92672">.</span>currentIndex() <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e"># 向所有连接的客户端发送消息</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">for</span> client, address <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>client_socket_list:
</span></span><span style="display:flex;"><span>                        client<span style="color:#f92672">.</span>send(send_msg)
</span></span><span style="display:flex;"><span>                    msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;TCP服务端已发送</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>                    self<span style="color:#f92672">.</span>signal_write_msg<span style="color:#f92672">.</span>emit(msg)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>comboBox_tcp<span style="color:#f92672">.</span>currentIndex() <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>                    self<span style="color:#f92672">.</span>tcp_socket<span style="color:#f92672">.</span>send(send_msg)
</span></span><span style="display:flex;"><span>                    msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;TCP客户端已发送</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>                    self<span style="color:#f92672">.</span>signal_write_msg<span style="color:#f92672">.</span>emit(msg)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> ret:
</span></span><span style="display:flex;"><span>                msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;发送失败</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>signal_write_msg<span style="color:#f92672">.</span>emit(msg)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tcp_close</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        功能函数，关闭网络连接的方法
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :return:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>comboBox_tcp<span style="color:#f92672">.</span>currentIndex() <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> client, address <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>client_socket_list:
</span></span><span style="display:flex;"><span>                    client<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>tcp_socket<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>link <span style="color:#f92672">is</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>                    msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;已断开网络</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>                    self<span style="color:#f92672">.</span>signal_write_msg<span style="color:#f92672">.</span>emit(msg)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> ret:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>comboBox_tcp<span style="color:#f92672">.</span>currentIndex() <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>tcp_socket<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>link <span style="color:#f92672">is</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>                    msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;已断开网络</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>                    self<span style="color:#f92672">.</span>signal_write_msg<span style="color:#f92672">.</span>emit(msg)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> ret:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            stopThreading<span style="color:#f92672">.</span>stop_thread(self<span style="color:#f92672">.</span>sever_th)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            stopThreading<span style="color:#f92672">.</span>stop_thread(self<span style="color:#f92672">.</span>client_th)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    app <span style="color:#f92672">=</span> QtWidgets<span style="color:#f92672">.</span>QApplication(sys<span style="color:#f92672">.</span>argv)
</span></span><span style="display:flex;"><span>    ui <span style="color:#f92672">=</span> TcpLogic(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    ui<span style="color:#f92672">.</span>show()
</span></span><span style="display:flex;"><span>    sys<span style="color:#f92672">.</span>exit(app<span style="color:#f92672">.</span>exec_())
</span></span></code></pre></div><h4 id="24-pythonc-通信">2.4. python&amp;C# 通信</h4>
<blockquote>
<p>注意发送内容编码形式</p>
</blockquote>
<ul>
<li>server.py</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> face_recognition
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> cv2
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json   
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> socket <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> threading <span style="color:#f92672">import</span> Thread
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> seetaface.api <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pickle
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> threading
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SeetaFaceHandle</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self,path):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        使用到的函数:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            Extract：提取一张原始图像里的一个指定区域的人脸的特征值
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            ExtractCroppedFace: 提取一张已经裁剪好，只包含人脸图的人脸的特征值
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            CalculateSimilarity: 计算两个特征值之间的相似度
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        要加载的功能 :
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            人脸识别功能：FACERECOGNITION
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        该功能依赖 ：
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            FACE_DETECT :人脸检测
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            LANDMARKER5 :5点关键点识别
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        path: 人脸图片所在的目录
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>init_mask <span style="color:#f92672">=</span> FACE_DETECT<span style="color:#f92672">|</span>FACERECOGNITION<span style="color:#f92672">|</span>LANDMARKER5
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>seetaFace <span style="color:#f92672">=</span> SeetaFace(self<span style="color:#f92672">.</span>init_mask)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pic_path<span style="color:#f92672">=</span>path
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>faces,self<span style="color:#f92672">.</span>faceNames<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>initFaceData()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initFaceData</span>(self):
</span></span><span style="display:flex;"><span>        known_faces<span style="color:#f92672">=</span>[]
</span></span><span style="display:flex;"><span>        known_faceNames<span style="color:#f92672">=</span>[]
</span></span><span style="display:flex;"><span>        known_face_sids<span style="color:#f92672">=</span>[]
</span></span><span style="display:flex;"><span>        json_lists<span style="color:#f92672">=</span>[]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(<span style="color:#e6db74">&#39;known_faces&#39;</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># npz = np.load(&#39;all4.npz&#39;)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># known_faceNames = npz[&#39;names&#39;]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># known_faces=npz[&#39;encode&#39;]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;known_faces&#39;</span>, <span style="color:#e6db74">&#39;wb&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>                known_faces<span style="color:#f92672">=</span>pickle<span style="color:#f92672">.</span>load(known_faces, f)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;known_faceNames&#39;</span>, <span style="color:#e6db74">&#39;wb&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>                known_faceNames<span style="color:#f92672">=</span>pickle<span style="color:#f92672">.</span>load(known_faceNames, f)
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#print(&#34;type&#34;,type(known_faces))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#known_faces=self.seetaFace.get_feature_numpy(known_faces)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#print(&#34;type&#34;,type(known_faces))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#print(&#34;\nfaceimg&#34;,known_faces,&#34;\nfacename&#34;,known_faceNames)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            files<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>listdir(self<span style="color:#f92672">.</span>pic_path)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> file <span style="color:#f92672">in</span> files:
</span></span><span style="display:flex;"><span>                img_path<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(self<span style="color:#f92672">.</span>pic_path,file)
</span></span><span style="display:flex;"><span>                obj_img <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>load_image_file(img_path)
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">#print(file,&#34;obj_img:&#34;,obj_img.size)</span>
</span></span><span style="display:flex;"><span>               
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span>                a1 <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>                detect_result1 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>seetaFace<span style="color:#f92672">.</span>Detect(obj_img)
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">#print(&#34;detect_result1:&#34;,detect_result1)</span>
</span></span><span style="display:flex;"><span>                face1 <span style="color:#f92672">=</span> detect_result1<span style="color:#f92672">.</span>data[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>pos
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">#print(&#34;face1:&#34;,face1)</span>
</span></span><span style="display:flex;"><span>                points1 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>seetaFace<span style="color:#f92672">.</span>mark5(obj_img,face1)
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">#print(&#34;points1:&#34;,points1)</span>
</span></span><span style="display:flex;"><span>                obj_face_encoding <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>seetaFace<span style="color:#f92672">.</span>Extract(obj_img,points1)
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">#print(&#34;name:&#34;,file,&#34;feature:&#34;,obj_face_encoding)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">#print(&#34;obj_face_encoding:&#34;,obj_face_encoding)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">#print(&#39;handlefile=&#39;,file,&#39;time used:&#39;, time.time()-a1)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> len(obj_face_encoding):
</span></span><span style="display:flex;"><span>                    print(<span style="color:#e6db74">&#39;eee:&#39;</span>, file)
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>                known_faces<span style="color:#f92672">.</span>append(obj_face_encoding)
</span></span><span style="display:flex;"><span>                name <span style="color:#f92672">=</span> file<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;.&#39;</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>                known_faceNames<span style="color:#f92672">.</span>append(name)
</span></span><span style="display:flex;"><span>                known_face_sids<span style="color:#f92672">.</span>append(i)
</span></span><span style="display:flex;"><span>                json_lists<span style="color:#f92672">.</span>append({<span style="color:#e6db74">&#39;img&#39;</span>: file, <span style="color:#e6db74">&#39;name&#39;</span>: name, <span style="color:#e6db74">&#39;sid&#39;</span>: str(i)})
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># with open(&#39;known_faces&#39;, &#39;wb&#39;) as f:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#     pickle.dump(known_faces, f)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># with open(&#39;known_faceNames&#39;, &#39;wb&#39;) as f:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#     pickle.dump(known_faceNames, f)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#np.savez(&#39;all4.npz&#39;, encode=known_faces, sids=known_face_sids, names=known_faceNames)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># with open(&#39;facename.json&#39;, &#39;w&#39;) as f:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#     json_list_str = json.dumps(json_lists)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#     f.write(json_list_str)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> known_faces,known_faceNames
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load_image_file</span>(self, file, mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;RGB&#39;</span>):
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;pic_file&#34;</span>,file)
</span></span><span style="display:flex;"><span>        im <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>imdecode(np<span style="color:#f92672">.</span>fromfile(file,dtype<span style="color:#f92672">=</span>np<span style="color:#f92672">.</span>uint8),<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> im
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">getFaceNameFromFile</span>(self,targetPath):
</span></span><span style="display:flex;"><span>        name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;None&#34;</span>
</span></span><span style="display:flex;"><span>        image2<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>load_image_file(targetPath)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            detect_result2 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>seetaFace<span style="color:#f92672">.</span>Detect(image2)
</span></span><span style="display:flex;"><span>            face2 <span style="color:#f92672">=</span> detect_result2<span style="color:#f92672">.</span>data[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>pos
</span></span><span style="display:flex;"><span>            points2 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>seetaFace<span style="color:#f92672">.</span>mark5(image2,face2)
</span></span><span style="display:flex;"><span>            feature2 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>seetaFace<span style="color:#f92672">.</span>Extract(image2,points2)
</span></span><span style="display:flex;"><span>            max<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            index<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>,len(self<span style="color:#f92672">.</span>faces)):                
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">#targetEncoding=self.seetaFace.get_feature_numpy(feature2)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">#print(&#34;similar1:&#34;,type(self.faces[i]),&#34;  feature2:&#34;,type(targetEncoding))</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">#similar1 = self.seetaFace.compare_feature_np(self.faces[i],targetEncoding) #0.688</span>
</span></span><span style="display:flex;"><span>                similar1 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>seetaFace<span style="color:#f92672">.</span>CalculateSimilarity(self<span style="color:#f92672">.</span>faces[i],feature2) <span style="color:#75715e">#0.999</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> similar1<span style="color:#f92672">&gt;</span>max:
</span></span><span style="display:flex;"><span>                    max<span style="color:#f92672">=</span>similar1
</span></span><span style="display:flex;"><span>                    index<span style="color:#f92672">=</span>i
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;最大相似度： &#34;</span>,max, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74"> 人脸name:&#34;</span>,self<span style="color:#f92672">.</span>faceNames[index],<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">人脸特征:&#34;</span>,self<span style="color:#f92672">.</span>faces[i])
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>faceNames[index]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;file don&#39;t detect face&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> name
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">getFaceNameFromEncoding</span>(self,targetEncoding):
</span></span><span style="display:flex;"><span>        name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;None&#34;</span>
</span></span><span style="display:flex;"><span>        max<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        index<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        targetEncoding<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>seetaFace<span style="color:#f92672">.</span>get_feature_numpy(targetEncoding)
</span></span><span style="display:flex;"><span>        print(len(self<span style="color:#f92672">.</span>faces),type(self<span style="color:#f92672">.</span>faces[<span style="color:#ae81ff">0</span>]),type(targetEncoding))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">6</span>):
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;处理&#34;</span>,i,type(self<span style="color:#f92672">.</span>face[i]),type(targetEncoding))
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#similar1 = self.seetaFace.compare_feature_np(self.faces[i],targetEncoding)</span>
</span></span><span style="display:flex;"><span>            similar1<span style="color:#f92672">=</span>i
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> similar1<span style="color:#f92672">&gt;</span>max:
</span></span><span style="display:flex;"><span>                max<span style="color:#f92672">=</span>similar1
</span></span><span style="display:flex;"><span>                index<span style="color:#f92672">=</span>i
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;最大相似度： &#34;</span>,max, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74"> 人脸name:&#34;</span>,self<span style="color:#f92672">.</span>faceNames[index],<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">人脸特征:&#34;</span>,self<span style="color:#f92672">.</span>faces[i])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>faceNames[index]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FaceData</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self,path):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pic_path<span style="color:#f92672">=</span>path
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#self.initFaceDatatoFile()</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>faces,self<span style="color:#f92672">.</span>faceNames<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>initFaceData()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initFaceData</span>(self):
</span></span><span style="display:flex;"><span>        known_faces<span style="color:#f92672">=</span>[]
</span></span><span style="display:flex;"><span>        known_faceNames<span style="color:#f92672">=</span>[]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(<span style="color:#e6db74">&#34;all4.npz&#34;</span>):
</span></span><span style="display:flex;"><span>            npz<span style="color:#f92672">=</span>np<span style="color:#f92672">.</span>load(<span style="color:#e6db74">&#39;all4.npz&#39;</span>)
</span></span><span style="display:flex;"><span>            known_faceNames <span style="color:#f92672">=</span> npz[<span style="color:#e6db74">&#39;names&#39;</span>]
</span></span><span style="display:flex;"><span>            known_faces<span style="color:#f92672">=</span>npz[<span style="color:#e6db74">&#39;encode&#39;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> file <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(self<span style="color:#f92672">.</span>pic_path):
</span></span><span style="display:flex;"><span>                filepath<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(self<span style="color:#f92672">.</span>pic_path,file)
</span></span><span style="display:flex;"><span>                print(filepath)
</span></span><span style="display:flex;"><span>                image<span style="color:#f92672">=</span>face_recognition<span style="color:#f92672">.</span>load_image_file(filepath)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                    imageEncoding<span style="color:#f92672">=</span>face_recognition<span style="color:#f92672">.</span>face_encodings(image)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>                    known_faceNames<span style="color:#f92672">.</span>append(file<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;.&#39;</span>)[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>                    known_faces<span style="color:#f92672">.</span>append(imageEncoding)
</span></span><span style="display:flex;"><span>                    print(known_faceNames[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>                    print(<span style="color:#e6db74">&#34;file don&#39;t detect face&#34;</span>)
</span></span><span style="display:flex;"><span>            np<span style="color:#f92672">.</span>savez(<span style="color:#e6db74">&#39;all4.npz&#39;</span>, encode<span style="color:#f92672">=</span>known_faces, names<span style="color:#f92672">=</span>known_faceNames)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> known_faces,known_faceNames
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">loadFaceDataFromFile</span>(self):
</span></span><span style="display:flex;"><span>        fw <span style="color:#f92672">=</span>open(<span style="color:#e6db74">&#39;face_info.json&#39;</span>,<span style="color:#e6db74">&#39;w&#39;</span>,encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;utf-8&#39;</span>)   <span style="color:#75715e">#打开一个名字为‘user_info.json’的空文件</span>
</span></span><span style="display:flex;"><span>        face_dic<span style="color:#f92672">=</span>json<span style="color:#f92672">.</span>loads(fw<span style="color:#f92672">.</span>read())
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> face_dic<span style="color:#f92672">.</span>keys(),face_dic<span style="color:#f92672">.</span>values()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initFaceDatatoFile</span>(self):
</span></span><span style="display:flex;"><span>        known_faces<span style="color:#f92672">=</span>[]
</span></span><span style="display:flex;"><span>        known_faceNames<span style="color:#f92672">=</span>[]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> file <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(self<span style="color:#f92672">.</span>pic_path):
</span></span><span style="display:flex;"><span>            filepath<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(self<span style="color:#f92672">.</span>pic_path,file)
</span></span><span style="display:flex;"><span>            print(filepath)
</span></span><span style="display:flex;"><span>            image<span style="color:#f92672">=</span>face_recognition<span style="color:#f92672">.</span>load_image_file(filepath)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                imageEncoding<span style="color:#f92672">=</span>face_recognition<span style="color:#f92672">.</span>face_encodings(image)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>                known_faceNames<span style="color:#f92672">.</span>append(file<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;.&#39;</span>)[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>                known_faces<span style="color:#f92672">.</span>append(imageEncoding)
</span></span><span style="display:flex;"><span>                print(known_faceNames[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#34;file don&#39;t detect face&#34;</span>)
</span></span><span style="display:flex;"><span>        d3 <span style="color:#f92672">=</span>dict(zip(known_faceNames, np<span style="color:#f92672">.</span>array(known_faces)))
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#print(d3)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;./face_info.json&#34;</span>,<span style="color:#e6db74">&#34;w&#34;</span>,encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;utf-8&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>            f<span style="color:#f92672">.</span>write(json<span style="color:#f92672">.</span>dump(known_faces, f, indent<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">getFaceNameFromFile</span>(self,targetPath):
</span></span><span style="display:flex;"><span>        name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;None&#34;</span>
</span></span><span style="display:flex;"><span>        image<span style="color:#f92672">=</span>face_recognition<span style="color:#f92672">.</span>load_image_file(targetPath)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            face_encoding<span style="color:#f92672">=</span>face_recognition<span style="color:#f92672">.</span>face_encodings(image)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>            matches <span style="color:#f92672">=</span> face_recognition<span style="color:#f92672">.</span>compare_faces(self<span style="color:#f92672">.</span>faces, face_encoding)
</span></span><span style="display:flex;"><span>            face_distances <span style="color:#f92672">=</span> face_recognition<span style="color:#f92672">.</span>face_distance(self<span style="color:#f92672">.</span>faces, face_encoding)
</span></span><span style="display:flex;"><span>            best_match_index <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>argmin(face_distances)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#print(&#34;最小距离： &#34;,face_distances[best_match_index])</span>
</span></span><span style="display:flex;"><span>            print(face_distances)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> matches[best_match_index]:
</span></span><span style="display:flex;"><span>                name <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>faceNames[best_match_index]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> name
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;file don&#39;t detect face&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> name   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">getFaceNameFromEncoding</span>(self,targetEncoding):
</span></span><span style="display:flex;"><span>        name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;None&#34;</span>
</span></span><span style="display:flex;"><span>        matches <span style="color:#f92672">=</span> face_recognition<span style="color:#f92672">.</span>compare_faces(self<span style="color:#f92672">.</span>faces, targetEncoding)
</span></span><span style="display:flex;"><span>        face_distances <span style="color:#f92672">=</span> face_recognition<span style="color:#f92672">.</span>face_distance(self<span style="color:#f92672">.</span>faces, targetEncoding)
</span></span><span style="display:flex;"><span>        best_match_index <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>argmin(face_distances)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;最小距离： &#34;</span>,face_distances[best_match_index])
</span></span><span style="display:flex;"><span>        print(face_distances)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> matches[best_match_index]:
</span></span><span style="display:flex;"><span>            name <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>faceNames[best_match_index]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> name
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">faceRecAcc</span>(self,folder):
</span></span><span style="display:flex;"><span>        cnt<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> tempfile <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(folder):
</span></span><span style="display:flex;"><span>            filename<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(folder,tempfile)
</span></span><span style="display:flex;"><span>            name<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>getFaceNameFromFile(filename)
</span></span><span style="display:flex;"><span>            print(name)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> name <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#34;葛伟平&#34;</span>,<span style="color:#e6db74">&#34;刘冬冬&#34;</span>,<span style="color:#e6db74">&#34;徐小龙&#34;</span>]:
</span></span><span style="display:flex;"><span>                cnt<span style="color:#f92672">=</span>cnt<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        print(folder,<span style="color:#e6db74">&#34; 总个数为:&#34;</span>,len(os<span style="color:#f92672">.</span>listdir(folder)),<span style="color:#e6db74">&#34; 正确个数为:&#34;</span>,cnt)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TcpServer</span>(object):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Tcp服务器&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, Port):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;初始化对象&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>code_mode <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;utf-8&#34;</span>    <span style="color:#75715e">#收发数据编码/解码格式</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>server_socket <span style="color:#f92672">=</span> socket(AF_INET, SOCK_STREAM)   <span style="color:#75715e">#创建socket</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>server_socket<span style="color:#f92672">.</span>setsockopt(SOL_SOCKET, SO_REUSEADDR, <span style="color:#66d9ef">True</span>)   <span style="color:#75715e">#设置端口复用</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>server_socket<span style="color:#f92672">.</span>bind((<span style="color:#e6db74">&#34;&#34;</span>, Port))     <span style="color:#75715e">#绑定IP和Port</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>server_socket<span style="color:#f92672">.</span>listen(<span style="color:#ae81ff">100</span>)  <span style="color:#75715e">#设置为被动socket</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>mutex<span style="color:#f92672">=</span>threading<span style="color:#f92672">.</span>Lock()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>facedata<span style="color:#f92672">=</span>FaceData(<span style="color:#e6db74">&#34;./picture&#34;</span>)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Listen...&#34;</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;运行&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>            client_socket, client_addr <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>server_socket<span style="color:#f92672">.</span>accept()    <span style="color:#75715e">#等待客户端连接</span>
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> online&#34;</span><span style="color:#f92672">.</span>format(client_addr))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                tr <span style="color:#f92672">=</span> Thread(target<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>recv_data, args<span style="color:#f92672">=</span>(client_socket, client_addr))   <span style="color:#75715e">#创建线程为客户端服务</span>
</span></span><span style="display:flex;"><span>                tr<span style="color:#f92672">.</span>start()  <span style="color:#75715e">#开启线程</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>	            print(<span style="color:#e6db74">&#39;face_server error&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">recv_data</span>(self, client_socket, client_addr):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;收发数据&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>            data <span style="color:#f92672">=</span> client_socket<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)<span style="color:#f92672">.</span>decode(self<span style="color:#f92672">.</span>code_mode)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> data:
</span></span><span style="display:flex;"><span>                data<span style="color:#f92672">=</span>data<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;;&#34;</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(client_addr, data))
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 锁定资源</span>
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>mutex<span style="color:#f92672">.</span>acquire()
</span></span><span style="display:flex;"><span>                name<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>facedata<span style="color:#f92672">.</span>getFaceNameFromFile(<span style="color:#e6db74">&#34;./realtime/&#34;</span><span style="color:#f92672">+</span>data<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;.png&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 解锁资源</span>
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>mutex<span style="color:#f92672">.</span>release()
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#34;人脸姓名:&#34;</span><span style="color:#f92672">+</span>name)
</span></span><span style="display:flex;"><span>                client_socket<span style="color:#f92672">.</span>send(name<span style="color:#f92672">.</span>encode(self<span style="color:#f92672">.</span>code_mode))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>: 	<span style="color:#75715e">#客户端断开连接</span>
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> offline&#34;</span><span style="color:#f92672">.</span>format(client_addr))
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        client_socket<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">localcameratestFaceData</span>():
</span></span><span style="display:flex;"><span>    video_capture <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>VideoCapture(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    facedata<span style="color:#f92672">=</span>FaceData(<span style="color:#e6db74">&#34;./picture&#34;</span>)
</span></span><span style="display:flex;"><span>    process_this_frame <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Grab a single frame of video</span>
</span></span><span style="display:flex;"><span>        ret, frame <span style="color:#f92672">=</span> video_capture<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Resize frame of video to 1/4 size for faster face recognition processing</span>
</span></span><span style="display:flex;"><span>        small_frame <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>resize(frame, (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>), fx<span style="color:#f92672">=</span><span style="color:#ae81ff">0.25</span>, fy<span style="color:#f92672">=</span><span style="color:#ae81ff">0.25</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Convert the image from BGR color (which OpenCV uses) to RGB color (which face_recognition uses)</span>
</span></span><span style="display:flex;"><span>        rgb_small_frame <span style="color:#f92672">=</span> small_frame[:, :, ::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Only process every other frame of video to save time</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> process_this_frame:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Find all the faces and face encodings in the current frame of video</span>
</span></span><span style="display:flex;"><span>            face_locations <span style="color:#f92672">=</span> face_recognition<span style="color:#f92672">.</span>face_locations(rgb_small_frame)
</span></span><span style="display:flex;"><span>            face_encodings <span style="color:#f92672">=</span> face_recognition<span style="color:#f92672">.</span>face_encodings(rgb_small_frame, face_locations)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            face_names <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> face_encoding <span style="color:#f92672">in</span> face_encodings:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># See if the face is a match for the known face(s)</span>
</span></span><span style="display:flex;"><span>                name<span style="color:#f92672">=</span>facedata<span style="color:#f92672">.</span>getFaceNameFromEncoding(face_encoding)
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 需要先把输出的中文字符转换成Unicode编码形式</span>
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#34;name&#34;</span>,name)
</span></span><span style="display:flex;"><span>                face_names<span style="color:#f92672">.</span>append(name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        process_this_frame <span style="color:#f92672">=</span> <span style="color:#f92672">not</span> process_this_frame
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Display the results</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (top, right, bottom, left), name <span style="color:#f92672">in</span> zip(face_locations, face_names):
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Scale back up face locations since the frame we detected in was scaled to 1/4 size</span>
</span></span><span style="display:flex;"><span>            top <span style="color:#f92672">*=</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>            right <span style="color:#f92672">*=</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>            bottom <span style="color:#f92672">*=</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>            left <span style="color:#f92672">*=</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Draw a box around the face</span>
</span></span><span style="display:flex;"><span>            cv2<span style="color:#f92672">.</span>rectangle(frame, (left, top), (right, bottom), (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">255</span>), <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Draw a label with a name below the face</span>
</span></span><span style="display:flex;"><span>            cv2<span style="color:#f92672">.</span>rectangle(frame, (left, bottom <span style="color:#f92672">-</span> <span style="color:#ae81ff">35</span>), (right, bottom), (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">255</span>), cv2<span style="color:#f92672">.</span>FILLED)
</span></span><span style="display:flex;"><span>            font <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>FONT_HERSHEY_DUPLEX
</span></span><span style="display:flex;"><span>            cv2<span style="color:#f92672">.</span>putText(frame, name, (left <span style="color:#f92672">+</span> <span style="color:#ae81ff">6</span>, bottom <span style="color:#f92672">-</span> <span style="color:#ae81ff">6</span>), font, <span style="color:#ae81ff">1.0</span>, (<span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">255</span>), <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Display the resulting image</span>
</span></span><span style="display:flex;"><span>        cv2<span style="color:#f92672">.</span>imshow(<span style="color:#e6db74">&#39;Video&#39;</span>, frame)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Hit &#39;q&#39; on the keyboard to quit!</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> cv2<span style="color:#f92672">.</span>waitKey(<span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span> <span style="color:#f92672">==</span> ord(<span style="color:#e6db74">&#39;q&#39;</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Release handle to the webcam</span>
</span></span><span style="display:flex;"><span>    video_capture<span style="color:#f92672">.</span>release()
</span></span><span style="display:flex;"><span>    cv2<span style="color:#f92672">.</span>destroyAllWindows()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">localcameratestSeetaFace</span>():
</span></span><span style="display:flex;"><span>    video_capture <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>VideoCapture(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    facedata<span style="color:#f92672">=</span>SeetaFaceHandle(<span style="color:#e6db74">&#34;./picture&#34;</span>)
</span></span><span style="display:flex;"><span>    process_this_frame <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Grab a single frame of video</span>
</span></span><span style="display:flex;"><span>        ret, frame <span style="color:#f92672">=</span> video_capture<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Resize frame of video to 1/4 size for faster face recognition processing</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#small_frame = cv2.resize(frame, (0, 0), fx=0.25, fy=0.25)</span>
</span></span><span style="display:flex;"><span>        small_frame<span style="color:#f92672">=</span>frame
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Convert the image from BGR color (which OpenCV uses) to RGB color (which face_recognition uses)</span>
</span></span><span style="display:flex;"><span>        rgb_small_frame <span style="color:#f92672">=</span> small_frame[:, :, ::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Only process every other frame of video to save time</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> process_this_frame:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Find all the faces and face encodings in the current frame of video</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                detect_result2 <span style="color:#f92672">=</span> facedata<span style="color:#f92672">.</span>seetaFace<span style="color:#f92672">.</span>Detect(rgb_small_frame)
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">#print(detect_result2)</span>
</span></span><span style="display:flex;"><span>                face2 <span style="color:#f92672">=</span> detect_result2<span style="color:#f92672">.</span>data[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>pos
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">#print(face2)</span>
</span></span><span style="display:flex;"><span>                points2 <span style="color:#f92672">=</span> facedata<span style="color:#f92672">.</span>seetaFace<span style="color:#f92672">.</span>mark5(rgb_small_frame,face2)
</span></span><span style="display:flex;"><span>                feature2 <span style="color:#f92672">=</span> facedata<span style="color:#f92672">.</span>seetaFace<span style="color:#f92672">.</span>Extract(rgb_small_frame,points2)
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#34;feature2&#34;</span>,feature2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>                face_names <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>                name<span style="color:#f92672">=</span>facedata<span style="color:#f92672">.</span>getFaceNameFromEncoding(feature2)
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 需要先把输出的中文字符转换成Unicode编码形式</span>
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#34;name&#34;</span>,name)
</span></span><span style="display:flex;"><span>                face_names<span style="color:#f92672">.</span>append(name)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> :
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#34;error&#34;</span>)
</span></span><span style="display:flex;"><span>               
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        process_this_frame <span style="color:#f92672">=</span> <span style="color:#f92672">not</span> process_this_frame
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Display the results</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># for (top, right, bottom, left), name in zip(face_locations, face_names):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#     # Scale back up face locations since the frame we detected in was scaled to 1/4 size</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#     top *= 4</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#     right *= 4</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#     bottom *= 4</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#     left *= 4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#     # Draw a box around the face</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#     cv2.rectangle(frame, (left, top), (right, bottom), (0, 0, 255), 2)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#     # Draw a label with a name below the face</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#     cv2.rectangle(frame, (left, bottom - 35), (right, bottom), (0, 0, 255), cv2.FILLED)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#     font = cv2.FONT_HERSHEY_DUPLEX</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#     cv2.putText(frame, name, (left + 6, bottom - 6), font, 1.0, (255, 255, 255), 1)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Display the resulting image</span>
</span></span><span style="display:flex;"><span>        cv2<span style="color:#f92672">.</span>imshow(<span style="color:#e6db74">&#39;Video&#39;</span>, frame)
</span></span><span style="display:flex;"><span>        cv2<span style="color:#f92672">.</span>waitKey(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Hit &#39;q&#39; on the keyboard to quit!</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> cv2<span style="color:#f92672">.</span>waitKey(<span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span> <span style="color:#f92672">==</span> ord(<span style="color:#e6db74">&#39;q&#39;</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Release handle to the webcam</span>
</span></span><span style="display:flex;"><span>    video_capture<span style="color:#f92672">.</span>release()
</span></span><span style="display:flex;"><span>    cv2<span style="color:#f92672">.</span>destroyAllWindows()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#print(&#34;\033c&#34;, end=&#34;&#34;) 	#清屏</span>
</span></span><span style="display:flex;"><span>    serverfl<span style="color:#f92672">=</span>TcpServer(<span style="color:#ae81ff">13333</span>)
</span></span><span style="display:flex;"><span>    serverfl<span style="color:#f92672">.</span>run()
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#localcameratestSeetaFace()</span>
</span></span></code></pre></div><ul>
<li>C# client</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Collections.Generic;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Text;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Net;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Net.Sockets;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Threading;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">namespace</span> KinectRFID.Util
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SocketUtil</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">object</span> _lockSend = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">object</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> Socket socket= <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">string</span> host;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> port ;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> SocketUtil() { }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> SocketUtil(<span style="color:#66d9ef">string</span> _host, <span style="color:#66d9ef">int</span> _port)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            host = _host;
</span></span><span style="display:flex;"><span>            port = _port;
</span></span><span style="display:flex;"><span>            connectToServer(host, port);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> connectToServer(<span style="color:#66d9ef">string</span> host, <span style="color:#66d9ef">int</span> port)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (socket == <span style="color:#66d9ef">null</span> || !socket.Connected)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    socket = <span style="color:#66d9ef">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
</span></span><span style="display:flex;"><span>                    IPAddress ip = IPAddress.Parse(host);
</span></span><span style="display:flex;"><span>                    IPEndPoint ipe = <span style="color:#66d9ef">new</span> IPEndPoint(ip, port);
</span></span><span style="display:flex;"><span>                    socket.SendTimeout = <span style="color:#ae81ff">2000</span>;
</span></span><span style="display:flex;"><span>                    socket.ReceiveTimeout = <span style="color:#ae81ff">2000</span>;
</span></span><span style="display:flex;"><span>                    socket.SendBufferSize = <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span>                    socket.ReceiveBufferSize = <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span>                    socket.Connect(ipe);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">catch</span> (Exception)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    Console.WriteLine(<span style="color:#e6db74">&#34;connectVisualiseServer error，服务器没有开启&#34;</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> Socket GetSocket()
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            connectToServer(host, port);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> socket;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#region Send</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/// Send</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> SendReceive(<span style="color:#66d9ef">string</span> data)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">lock</span> (_lockSend)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">//Encoding.ASCII.GetBytes(gestureDatas[gestureId].Id+&#34;;&#34;);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">//System.Diagnostics.Debug.WriteLine(&#34;Send data=&#34; + data);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">byte</span>[] lenArr = Encoding.UTF8.GetBytes(data);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">int</span> sendTotal = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">while</span> (sendTotal &lt; lenArr.Length)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">int</span> sendOnce = socket.Send(lenArr, sendTotal, lenArr.Length - sendTotal, SocketFlags.None);
</span></span><span style="display:flex;"><span>                    sendTotal += sendOnce;
</span></span><span style="display:flex;"><span>                    Thread.Sleep(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">//System.Diagnostics.Debug.WriteLine(&#34;send data ok, data=&#34; + Encoding.UTF8.GetString(lenArr));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>                {        <span style="color:#75715e">// 发送方 发送字符串，文件名前缀</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">int</span> block = <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">byte</span>[] buffer = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[block];
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">int</span> receiveCount = socket.Receive(buffer, <span style="color:#ae81ff">0</span>, block, SocketFlags.None);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (receiveCount == <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="color:#75715e">//System.Diagnostics.Debug.WriteLine(&#34;recieve data ok, data=&#34; + buffer.ToString());</span>
</span></span><span style="display:flex;"><span>                        System.Diagnostics.Debug.WriteLine(<span style="color:#e6db74">&#34;SendReceive: recieve data= &#34;</span> + Encoding.UTF8.GetString(buffer));
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">return</span> Encoding.UTF8.GetString(buffer);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    System.Diagnostics.Debug.WriteLine(<span style="color:#e6db74">&#34;接收数据出错：&#34;</span> + ex.Message + <span style="color:#e6db74">&#34;\r\n&#34;</span> + ex.StackTrace);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">#</span>endregion
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#region 断开服务器</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/// 断开服务器clientSocketFace</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">public</span>  <span style="color:#66d9ef">void</span> DisconnectServer(Socket socket)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (socket != <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (socket.Connected)
</span></span><span style="display:flex;"><span>                        socket.Disconnect(<span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>                    socket.Close();
</span></span><span style="display:flex;"><span>                    socket.Dispose();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                System.Diagnostics.Debug.WriteLine(<span style="color:#e6db74">&#34;已断开服务器&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                System.Diagnostics.Debug.WriteLine(<span style="color:#e6db74">&#34;断开服务器失败：&#34;</span> + ex.Message);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">#</span>endregion
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></div>
<div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title=2023-09-24&#32;17:00:05>更新于 2023-09-24&nbsp;</span>
      </div><div class="post-info-license">
          <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
        </div></div>
    <div class="post-info-line">
      <div class="post-info-md"><span><a href="/socket/index.md" title="阅读原始文档" class="link-to-markdown">阅读原始文档</a></span><span><a href="https://liudongdong1.github.io/edit/master/content/posts%5c%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80%5cpython%5cSocket.md" title="编辑此页"target="_blank" rel="external nofollow noopener noreferrer" class="link-to-edit">编辑此页</a></span></div>
      <div class="post-info-share">
        <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://liudongdong1.github.io/socket/" data-title="Socket" data-hashtags="Python,Network"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://liudongdong1.github.io/socket/" data-hashtag="Python"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://liudongdong1.github.io/socket/" data-title="Socket" data-image="https://gitee.com/github-25970295/blogImage/raw/master/img/20210510110733.png"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/python/">Python</a>,&nbsp;<a href="/tags/network/">Network</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/iostream/" class="prev" rel="prev" title="IOStream"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>IOStream</a>
      <a href="/number/" class="next" rel="next" title="Number">Number<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.118.2">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.2.17-RC"><img class="fixit-icon" src="/fixit.min.svg" alt="FixIt logo" />&nbsp;FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2020 - 2023</span><span class="author" itemprop="copyrightHolder">
              <a href="https://liudongdong1.github.io/"target="_blank" rel="external nofollow noopener noreferrer">LiuDongdong</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div><div class="footer-line statistics"><span class="site-time" title='网站运行中 ...'><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden="true"></i>&nbsp;<span class="run-times">网站运行中 ...</span></span></div><div class="footer-line ibruce">
          <span id="busuanzi_container_site_uv" title='总访客数'><i class="fa-regular fa-user fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span><span id="busuanzi_container_site_pv" class="footer-divider" title='总访问量'><i class="fa-regular fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span>
        </div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric">0%</span>
        </div></div><a href="https://liudongdong1.github.io/" title="在 GitHub 上查看源代码"target="_blank" rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;--bg-progress: #0076ff;--bg-progress-dark: #fff;"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/algoliasearch/algoliasearch-lite.umd.min.js" defer></script><script src="/lib/lazysizes/lazysizes.min.js" async defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="/lib/pangu/pangu.min.js" defer></script><script src="/lib/cell-watermark/watermark.min.js" defer></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"data":{"typeit-header-subtitle-desktop":"\u003cspan style='font-family: MMT,\"沐目体\";'\u003e吾日三省吾身\u003c/span\u003e","typeit-header-subtitle-mobile":"\u003cspan style='font-family: MMT,\"沐目体\";'\u003e吾日三省吾身\u003c/span\u003e"},"enablePWA":true,"enablePangu":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"2R1K9SKLQZ","algoliaIndex":"index.zh-cn","algoliaSearchKey":"4a226aa1c5c98d6859e4d1386adb2bc7","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"siteTime":"2020-12-18T16:15:22+08:00","typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"typeit-header-subtitle-desktop":["typeit-header-subtitle-desktop"],"typeit-header-subtitle-mobile":["typeit-header-subtitle-mobile"]},"duration":-1,"speed":100},"watermark":{"appendto":".wrapper\u003emain","colspacing":30,"content":"\u003cimg class=\"fixit-icon\" src=\"/fixit.min.svg\" alt=\"FixIt logo\" /\u003e FixIt 主题","enable":true,"fontfamily":"inherit","fontsize":0.85,"height":21,"opacity":0.0125,"rotate":15,"rowspacing":60,"width":150}};</script><script src="/js/theme.min.js" defer></script><script src="/js/custom.min.js" defer></script></body>
</html>
