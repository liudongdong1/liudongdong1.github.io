<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="数据密集型应用系统设计笔记-数据复制, AIOT,Space&amp;Temporal Sequence Analysis,SpringBoot,liudongdong1,cloud">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>数据密集型应用系统设计笔记-数据复制 | DaybyDay</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="DaybyDay" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">DaybyDay</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">

      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>About</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/about">
          
          <i class="fas fa-user-circle" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>about</span>
        </a>
      </li>
      
      <li>
        <a href="/resume">
          
          <i class="fa fa-user-secret" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>resume</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/gallery" class="waves-effect waves-light">
      
      <i class="fas fa-camera" style="zoom: 0.6;"></i>
      
      <span>Galleries</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">DaybyDay</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-user-circle"></i>
			
			About
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/about " style="margin-left:75px">
				  
				   <i class="fa fas fa-user-circle" style="position: absolute;left:50px" ></i>
			      
		          <span>about</span>
                  </a>
                </li>
              
                <li>

                  <a href="/resume " style="margin-left:75px">
				  
				   <i class="fa fa fa-user-secret" style="position: absolute;left:50px" ></i>
			      
		          <span>resume</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/gallery" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-camera"></i>
			
			Galleries
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/liudongdong1" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/liudongdong1" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.pixabay.com/photo/2022/02/22/03/22/passiflora-7027917__340.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">数据密集型应用系统设计笔记-数据复制</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    .toc-fixed .toc-link::before{
        position: fixed!important;/*当toc的位置改为fixed时，.toc-link::before也要改为fixed*/
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/storage/">
                                <span class="chip bg-color">storage</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Storage/" class="post-category">
                                Storage
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2022-04-14
                </div>
                

                <!-- 
                    <i class="fa fa-pencil"></i> Author: liudongdong1
                  -->

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>Update Date:&nbsp;&nbsp;
                    2022-04-15
                </div>
                

                <!-- 
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>Word Count:&nbsp;&nbsp;
                    7k
                </div>
                 -->

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>Read Times:&nbsp;&nbsp;
                    23 Min
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>Read Count:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <blockquote>
<p>数据密集型应用通常也是基于标准模块构建而成，每个模块负责单 的常用功能。例 如，许多应用系统都包含以下模块 </p>
<ul>
<li>数据库：用以存储数据，这样之后应用可以再次面问。</li>
<li>高速缓存 缓存那些复杂或操作代价昂贵的结果，以加快下一次访问。 </li>
<li>索引 用户可以按关键字搜索数据井支持各种过滤</li>
<li>流式处理：持续发送消息至另 个进程，处理采用异步方式。 </li>
<li>批处理 定期处理大量的累积数据。</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>可靠性：当出现意外情况如硬件、软件故障、人为失误等，系统应可以继续正常运转</li>
<li>可扩展性：随着规模 增长 ，例如数据 、流量或复杂性，系统应以合理的方式来匹配这种增长</li>
<li>可维护性：许多新的人员参与到系统开发和运维， 以维护现有功能或适配 新场景等，系统都应高效运转</li>
</ul>
</blockquote>
<p><img src="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20220413164916041.png" alt=""></p>
<blockquote>
<p>数据编码：JSON，XML和CSV等文本格式，或者Thrift，Protocal Buffers 和 Avro二进制处理模式。</p>
</blockquote>
<blockquote>
<p>数据流模式：</p>
<ul>
<li>数据库，其中写入进程对数据进行编码，读取数据库进程对数据进行解码</li>
<li>RPC和Rest API, 其中客户端对请求进行编码，服务器对请求进行解码，并对相应进行编码，客户端最终对响应进行解码</li>
<li>异步消息传递（Actor或者消息中间件），节点之间通信通过互相发送消息进行通信</li>
</ul>
</blockquote>
<h3 id="1-主节点与从节点"><a href="#1-主节点与从节点" class="headerlink" title="1. 主节点与从节点"></a>1. 主节点与从节点</h3><p><img src="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20220413212653237.png" alt=""></p>
<h4 id="1-同步复制-amp-异步复制"><a href="#1-同步复制-amp-异步复制" class="headerlink" title="1. 同步复制&amp;异步复制"></a>1. 同步复制&amp;异步复制</h4><p><img src="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20220413213101660.png" alt=""></p>
<h4 id="2-配置新的从节点"><a href="#2-配置新的从节点" class="headerlink" title="2. 配置新的从节点"></a>2. 配置新的从节点</h4><ul>
<li>如何确保新的从节点和主节点保持数据一致<ul>
<li>简单的文件复制，（客户端仍在不停地写，数据处于变化之中），导致不同节点上呈现不同时间点数据</li>
<li>锁定数据库：违反高可用设计原则</li>
</ul>
</li>
</ul>
<blockquote>
<ol>
<li>在某个时间点对主节点的数据副本产生一个 致性快照，这样避免长时间锁定整 个数据库。目前大多数数据库都支持此功能，快照也是系统备份所必需的。而在 某些情况下，可能需要第 方工具， MySQL innobackupex</li>
<li>将此快照拷贝到新的从节点</li>
<li>从节点连接到主节点并请求快照点之后所发 的数据更改日志。因为在第一步 建快照时，快照与系统复制日志的某个确定位置相 联，这个位置信息在不同的 系统有不同的称 乎，如PostgreS QL 其称为“ log sequence number” （日志序列 号），而MySQL将其称为“binlog coordinates </li>
<li>获得日志之后，从节点来应用这些快照点之后所有数据变更，这个过程称之为追 赶。接下来，它可以继 处理主节点上新的数据变化。井重复步骤 ～步骤</li>
</ol>
</blockquote>
<h4 id="3-节点失效"><a href="#3-节点失效" class="headerlink" title="3. 节点失效"></a>3. 节点失效</h4><h5 id="1-从节点失效-追赶模式"><a href="#1-从节点失效-追赶模式" class="headerlink" title=".1. 从节点失效-追赶模式"></a>.1. 从节点失效-追赶模式</h5><blockquote>
<p>从节点保存副本数据变更复制日志，可以指导发生故障之前所处理的最后一笔事务，然后连接到主节点，并请求自上次事务后中断期间所有的数据变更应用到本地。</p>
</blockquote>
<h5 id="2-主节点失效-节点切换"><a href="#2-主节点失效-节点切换" class="headerlink" title=".2. 主节点失效-节点切换"></a>.2. 主节点失效-节点切换</h5><blockquote>
<p>主节点失败时需要<code>提升某个从节点为新的主节点</code>，同时需要<code>通知客户端新的主节点</code>,其他从节点接受来自新的主节点数据变更。</p>
<p><strong>自动切换主节点的步骤通常如下</strong>：</p>
<ol>
<li><code>确认主节点失效</code>。大部分系统采用基于<code>超时的机制</code>，<code>主从节点直接发送心跳消息，主节点在某个时间内都没有响应，则认为主节点已经失效</code>。</li>
<li><code>选举新的主节点</code>。通过<code>选举</code>的方式（超过半数以上的从节点达成共识）来选举新的主节点，新的主节点是与旧的主节点数据差异最小的一个，最小化数据丢失的风险。（共识问题）</li>
<li><code>重新配置使新的主节点上线</code>。(请求路由)</li>
</ol>
<p>除了以上步骤之外，还有以下问题需要考虑：</p>
<ol>
<li>如果使用<code>异步复制机制</code>，而且在失效之前，<code>新的主节点并没有收到旧的主节点的所有数据</code>，那么在旧的主节点重新上线之后，<code>旧的主节点上未完成复制的数据将被丢弃(违背了数据持久化)</code>。</li>
<li>可能会出现<code>集群同时存在两个主节点的情况</code>，也就是所谓的<code>脑裂（split brain）</code>现象，此时两个主节点都认为自己是主节点并且都能接收客户端的写数据请求，会导致数据丢失或者破坏。</li>
<li>如何设置<code>合理的超时时间来判断主节点失效</code>？如果太大意味着总体恢复时间长，如果太小意味着某些情况下可能主节点并未失效但是被误判为失效了，比如网络峰值导致延迟高等原因，这样会导致很多不必要的主节点切换。</li>
</ol>
<p>上述的问题，包括<code>节点失效</code>、<code>网络不可靠</code>、<code>副本一致性</code>、<code>持久性</code>、<code>可用性</code>与<code>延迟</code>之间的各种细微的权衡，正是分布式系统核心的基本问题。</p>
</blockquote>
<h5 id="4-复制日志实现"><a href="#4-复制日志实现" class="headerlink" title="4. 复制日志实现"></a>4. 复制日志实现</h5><h6 id="1-基于语句的复制"><a href="#1-基于语句的复制" class="headerlink" title=".1. 基于语句的复制"></a>.1. 基于语句的复制</h6><blockquote>
<p>主节点<code>记录所执行的每个写请求</code>并将该语句<code>做为日志发送给从节点</code>。但是有些场景并不适合这么做，比如：</p>
<ul>
<li>调用任何<code>非确定函数</code>的语句，比如<code>NOW</code> () 获得当前时间，<code>RAND</code> () 返回一个随机数。</li>
<li>语句中使用了<code>自增列，或者依赖于当前数据库的数据</code>。</li>
<li>有副作用的语句(触发器，存储过程，用户自定义函数等），在每个副本上面执行的效果不一样。</li>
</ul>
</blockquote>
<h6 id="2-基于预写日志-WAL"><a href="#2-基于预写日志-WAL" class="headerlink" title=".2. 基于预写日志 (WAL)"></a>.2. 基于预写日志 (WAL)</h6><p>将<code>对数据库的操作写入日志，传送到从节点上然后执行</code>，得到与主节点相同的数据副本。</p>
<ul>
<li>对于日志结构的存储引擎，日志是主要存储方式，日志段在后台压缩并支持垃圾回收</li>
<li>采用覆盖写磁盘Btree结构，每次修改会预先写入日志。</li>
<li>一个WAL包含了哪些磁盘块的哪些自己发生改变。</li>
</ul>
<h6 id="3-基于行的逻辑日志复制"><a href="#3-基于行的逻辑日志复制" class="headerlink" title=".3. 基于行的逻辑日志复制"></a>.3. 基于行的逻辑日志复制</h6><p>所谓的逻辑日志，就是<code>复制与存储引擎采用不同的日志格式</code>，这样复制与存储逻辑剥离，这种日志称为逻辑日志，与物理存储引擎的数据区分开。由于逻辑日志与存储引擎逻辑上解耦，因此可以更好的向后兼容，也更好的能被外部程序解析。（如果不是行存储的怎么办）</p>
<p>对于关系型数据库，其逻辑日志是一系列用来描述数据表行级别的写请求：</p>
<ul>
<li>插入行：日志包括所有<code>相关列的新值</code>。</li>
<li>删除行：日志中保证要有足够的信息来唯一标识待删除的行，通常是<code>主键</code>。</li>
<li>更新行：日志中保证要有足够的信息来唯一<code>标识待更新的行，同时也有所有列的新值</code>。</li>
</ul>
<h6 id="4-基于触发器的复制"><a href="#4-基于触发器的复制" class="headerlink" title=".4. 基于触发器的复制"></a>.4. 基于触发器的复制</h6><p>指向复制数据的一部分，或者想从一种数据库复制到另一种数据库，或者需要定制，管理冲突解决逻辑，将复制控制交给应用程序层。</p>
<h3 id="2-复制滞后"><a href="#2-复制滞后" class="headerlink" title="2. 复制滞后"></a>2. 复制滞后</h3><blockquote>
<p>正常情 况下，主节点和从节点上完成写操作之间的时间延迟（复制滞后）可能不足 秒，这 样的滞后，在实践中通常不会导致太大影响。但是，如果系统已接近设计上限，或者 网络存在问题， 滞后可能轻松增 秒甚至 分钟不等。暂时的不一致性，最终的一致性。</p>
</blockquote>
<h4 id="1-读自己的写（reading-your-own-writes）"><a href="#1-读自己的写（reading-your-own-writes）" class="headerlink" title=".1. 读自己的写（reading your own writes）"></a>.1. 读自己的写（reading your own writes）</h4><p>用户在写入数据不久就马上查看数据，而新数据并未到达从节点，这样在用户看来可能读到了旧的数据。这样情况需要 “写后读一致性（read-after-write consistency）”，该机制保证每次用户读到的都是自己最近的更新数据，但是对其他用户则没有任何保证。</p>
<p><img src="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20220413222842376.png" alt=""></p>
<p>在上图中，用户 1234 首先向主节点写入数据，SQL 执行成功之后返回，而此时用户再次向从节点 2 发起读刚才写入数据的请求，但是却读到了旧的数据。</p>
<p>有以下方案实现写后读一致性。</p>
<ul>
<li><code>如果用户访问可能会被修改的内容，从主节点读取</code>。比如社交网络的本用户首页信息只会被本人修改，访问用户自己的首页信息通过主节点，而访问其他用户的首页信息则走的从节点。</li>
<li>如果应用大部分内容都可能被所有用户修改，则上述方法不太适用。此时需要其他机制来<code>判断哪些请求需要走主节点，比如更新后一分钟之内的请求都走的主节点。</code></li>
<li>客户端可以记住自己最近更新数据的时间戳，<code>在请求数据时带上时间戳，如果副本上没有至少包含该时间戳的数据则转发给其他副本处理，直到能处理为止</code>。但是在这里，“时间戳” 可以是<code>逻辑时钟</code>（比如用来指示写入数据的日志序列号）或者<code>实际系统时钟</code>（而使用系统时间又将时间同步变成了一个关键点）。</li>
<li>如果副本分布在<code>多数据中心，必须将请求路由到主节点所在的数据中心</code>。</li>
</ul>
<blockquote>
<p>如果同 用户可能会从多个设备访问数据，例如 个桌面We 浏览器和 个移动端的 应用，情 会变得更加复杂 此时 ，要提供<code>跨设备的写后读一致性</code>， 即如果用户在某 个设备上输入了 些信息然后在另 台设备上查看，也应该看到刚刚所输入的内容.</p>
<ul>
<li>如果同 用户可能会从多个设备访问数据，例如 个桌面We 浏览器和 个移动端的 应用，情 会变得更加复杂 此时 ，要提供跨设备的写后读一致性， 即如果用户在某 个设备上输入了 些信息然后在另 台设备上查看，也应该看到刚刚所输入的内容</li>
<li>如果副本分布在多数据中心， <code>无法保证来自不同设备的连接经过路由之后都到达同一个数据中心</code>。</li>
</ul>
</blockquote>
<h4 id="2-单调读（monotonic-reads）"><a href="#2-单调读（monotonic-reads）" class="headerlink" title=".2. 单调读（monotonic reads）"></a>.2. 单调读（monotonic reads）</h4><p>单调读一致性保证不会发生多次读同一条数据出现回滚（moving backward）的现象。这个是比强一致性弱，但是比最终一致性强的保证。</p>
<p><img src="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20220413223524255.png" alt=""></p>
<p>在上图中，用户 2345 发起了两次读请求，第一次向从节点 1 发起的请求拿到了最新的数据，但是第二次向从节点 2 发起的请求得到了旧的数据，这在用户看来，数据发生了 “回滚”。</p>
<p>单调读一致性可以确保不会发生这种异常。当读取数据时，<code>单调读保证：如果某个用户进行多次读取，则绝对不会看到数据回滚现象，即在读取到新值之后又发生读取到旧值的情况。</code></p>
<p>实现单调读一致性的一种方式<code>每个用户的每次读取都从固定的同一副本上进行读取</code>。</p>
<h4 id="3-前缀一致读（consistent-prefix-reads）"><a href="#3-前缀一致读（consistent-prefix-reads）" class="headerlink" title=".3. 前缀一致读（consistent prefix reads）"></a>.3. 前缀一致读（consistent prefix reads）</h4><p>前缀一致性读保证，<code>对于一系列按照某个顺序发生的写请求，读取这些内容时也会按照当时写入的顺序来</code>。</p>
<p>例如，正常情况下，是如下的对话：</p>
<ul>
<li>poons 先生：cake 小姐，您能看见多远的未来？</li>
<li>cacke 小姐：通常约 10 秒，poons 先生。</li>
</ul>
<p><img src="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20220413224411309.png" alt=""></p>
<p>但是在上图中，从观察者角度，数据的先后顺序发生了混淆，导致了逻辑上的混乱。这种问题是分区情况下出现的特殊问题，<code>在分布式数据库中，不同的分区独立运行，因此不存在全局写入顺序，这就导致用户从数据库中读取数据时，可能看到数据库某部分的旧值和一部分的新值</code>。</p>
<p>实现前缀一致性的一种方案是<code>确保任何具有因果顺序关系的写入都交给一个分区来完成</code>，但是该方案真实实现起来效率不高。</p>
<h3 id="3-多主节点复制"><a href="#3-多主节点复制" class="headerlink" title="3. 多主节点复制"></a>3. 多主节点复制</h3><h4 id="1-场景-多数据中心"><a href="#1-场景-多数据中心" class="headerlink" title=".1. 场景-多数据中心"></a>.1. 场景-多数据中心</h4><blockquote>
<p>为了容忍整个数据中心级别故障或更接近用户，可以把<code>数据库的副本横跨多个数据中心</code>。<code>在每个数据中心内，采用常规的主从复制方案</code>；而在<code>数据中心之间，由各个数据中心的主节点来负责同其他数据中心的主节点进行数据的交换、更新</code>。</p>
</blockquote>
<p><img src="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20220413225559250.png" alt=""></p>
<blockquote>
<ul>
<li>性能：<code>每个写操作可以在本地数据中心就近快速响应</code>，<code>采用异步复制方式将变化同步到其他数据中心</code>。</li>
<li>容忍数据中心失败：<code>单个数据中心失败，不影响其他数据中心的继续运行</code>。</li>
<li>容忍网络问题：主从复制模型中写操作是同步操作，<code>对数据中心之间的网络性能和稳定性等要求更高</code>。多主节点模型采用异步复制，可以更好的容忍这类问题。</li>
</ul>
<p>不同的数据中心可能会同 修改相同的数据，因而必须解决潜在的写冲突（如图5-6 中的“冲突解决”）</p>
</blockquote>
<h4 id="2-场景-离线客户端操作"><a href="#2-场景-离线客户端操作" class="headerlink" title=".2. 场景-离线客户端操作"></a>.2. 场景-离线客户端操作</h4><blockquote>
<p>在离线状态下进行的任何更改，会在下次设备上线时，与服务器以及其他设备 同步。</p>
<p><code>每个设备都有 个充当主节点的本地数据库</code>（用来接受写请求），然后 在所有设备之间采用异步方式同步这些多主节点上的副本，同步滞后可能是几小时或 者数天，具体时间取决于设备何时可以再次联网。</p>
</blockquote>
<h4 id="3-场景-协作编程"><a href="#3-场景-协作编程" class="headerlink" title=".3. 场景-协作编程"></a>.3. 场景-协作编程</h4><blockquote>
<p>当一个用户编辑文档时 ，所做的更改会立即应用到本地副本（ We 览器或客户端应 用程序），然后异步复制到服务器以及编辑同 文档的其他用户。这样每个用户就是一个独立的数据中心了。</p>
</blockquote>
<h4 id="4-处理写冲突"><a href="#4-处理写冲突" class="headerlink" title=".4. 处理写冲突"></a>.4. 处理写冲突</h4><blockquote>
<p>冲突解决通常用于单个行或文档，而不是整个事务，如果一个原子事务包含了多个不同写请求，每个写请求仍然是分开考虑的解决冲突。</p>
</blockquote>
<p><img src="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20220413230755597.png" alt=""></p>
<h5 id="1-同步与异步冲突检测"><a href="#1-同步与异步冲突检测" class="headerlink" title="1. 同步与异步冲突检测"></a>1. 同步与异步冲突检测</h5><blockquote>
<p>如果是主从复制数据库，第二个写请求会被阻塞到第一个写请求完成。而在多主从复制模型下，两个写请求都是成功的，并且只有在之后才能检测到写冲突，而那时候要用户来解决冲突已经为时已晚了。</p>
<p>如果要多主从复制模型来做到同步检测冲突，又失去了多主节点的优势：允许每个主节点接受写请求。</p>
<p>因此如果确实想要做到同步检测写冲突，应该考虑使用单主节点的模型而不是多主从节点模型。</p>
</blockquote>
<h5 id="2-避免冲突"><a href="#2-避免冲突" class="headerlink" title="2. 避免冲突"></a>2. 避免冲突</h5><blockquote>
<p>如果应用层可以保证<code>对特定记录的写请求总是通过一个主节点</code>，这样就不会发生写冲突。</p>
<p>但是，在<code>数据中心发生故障</code>，不得不路由请求到另外的数据中心，或者用户漫游到了另一个位置，更靠近另一个数据中心等场景下，冲突避免不再有效。</p>
</blockquote>
<h5 id="3-收敛于一致状态"><a href="#3-收敛于一致状态" class="headerlink" title="3. 收敛于一致状态"></a>3. 收敛于一致状态</h5><blockquote>
<p>对于主从复制模型，数据更符合顺序性原则，如果同一个字段有多个更新，则最后一个写操作决定该字段的最终值。而对于多主节点复制模型，则不存在。</p>
<ul>
<li><code>给每个写入分配唯一的 ID</code>，如时间戳、足够长的随机数、UUID 等，规定<code>只有高 ID 的写入做为胜利者</code>。如果是基于<code>时间戳</code>的对比，这种技术被称为后写入者获胜（last write win），但是很容易造成<code>数据丢失</code>。</li>
<li>给<code>每个副本分配一个唯一的 ID</code>，并制定规则比如最高 ID 的副本写入成功，这种方式也会导致数据丢失。</li>
<li>以<code>某种方式将这些值合并在一起</code>。</li>
<li>使用<code>预定义的格式将这些冲突的值返回给应用层，由应用层来解决</code>。</li>
</ul>
</blockquote>
<h5 id="4-自定义冲突解决逻辑"><a href="#4-自定义冲突解决逻辑" class="headerlink" title="4. 自定义冲突解决逻辑"></a>4. 自定义冲突解决逻辑</h5><blockquote>
<p>解决冲突最合适的方式还是依靠<code>应用层</code>，可以在写入或者读取时执行。</p>
</blockquote>
<ul>
<li><code>在写入时执行</code>：只要数据库系统在<code>复制变更日志时检测冲突</code>，就<code>调用应用层的冲突处理程序</code>。</li>
<li><code>在读取时执行</code>：当检测到冲突时，<code>所有 冲突写入值都会暂时保存下来</code>，下一次读取数据时，会<code>将数据多个版本读返回给应用层</code>。应用层会提示用户或者自行解决，并将最后的结果返回到数据库。</li>
</ul>
<h5 id="5-拓扑结构"><a href="#5-拓扑结构" class="headerlink" title="5. 拓扑结构"></a>5. 拓扑结构</h5><blockquote>
<p>为防止无限循环，每个节点需要赋予 个唯 标识符，在复 日志中的每个写请求都标记了已通过的节点标识符（43 ］。如果某个节点 收到了包含自身标识符的数据更改，表明该请求已经被处理过，因 会忽略 变更请 求，避免重复转发。</p>
<p>全链接拓扑也存在一些自身的问题。主要是存在某些网络链路比其他链 路更快的情况（例如由于不同网络拥塞），从而导致复制日志之间的覆盖</p>
</blockquote>
<p><img src="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20220413232344228.png" alt=""></p>
<p><img src="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20220413232559365.png" alt=""></p>
<blockquote>
<p>客户端 主节点 表中首先插入 行，然后客户端 在主节点 上对该 行记录进行更新。而在主节点 上，由于网络原因可能出现意外的写日志复制顺序， 例如它先接收到了主节点 的更新日志（从主节点 的角度来看，这是对数据库中不存 在行的更新操作），之后才接收到主节点 的插入日志（按道理应该在更新日志之前 到达）。</p>
<ul>
<li>在每笔写日志里简单地添加时间戳还不够，主要因为无能确保时钟 完全同步</li>
<li>版本向量技术，检测并发写入</li>
</ul>
</blockquote>
<h3 id="4-无主节点复制"><a href="#4-无主节点复制" class="headerlink" title="4. 无主节点复制"></a>4. 无主节点复制</h3><blockquote>
<p>对于某些无主节点系统实现，客户端直接将其写请求发送到多副本，而在其他 些实 现中，由一个协调者节点代表客户端进行写人，但与主节点的数据库不同，<code>协调者井 不负责写入顺序的维护</code>。</p>
</blockquote>
<h4 id="1-节点失效时写入数据库"><a href="#1-节点失效时写入数据库" class="headerlink" title=".1. 节点失效时写入数据库"></a>.1. 节点失效时写入数据库</h4><blockquote>
<p>当一个客户端从数据库中读取数据肘，它不是向 个副本发送请 求，而是井行地发送到多个副本。客户端可能会得到不同节点的不同响应，包括某些 节点的新值和某些节点的旧值。可以采用版本号技术确定哪个值更新（参见本章后面 的“<code>检测并发写入</code>”）。</p>
</blockquote>
<p><img src="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20220414094622411.png" alt=""></p>
<p>针对副本三因为掉线到时没有跟新最新的数据，更新策略：</p>
<ul>
<li>读修复：客户端读取多个副本的时候，可以检测出过期的返回值，然后将新值写入该副本中</li>
<li>反熵过程：一些数据存储后，有后台进程不断地查找副本之间的数据差异，将任何缺少的数据从一个副本复制到另一个副本中。（不保证以特定的顺序写入，并且会引入明显地同步滞后）</li>
</ul>
<h4 id="2-读写-quorum"><a href="#2-读写-quorum" class="headerlink" title=".2. 读写 quorum"></a>.2. 读写 quorum</h4><blockquote>
<p>如果有n 个副本，写人需要 w个节点确认，读取必须至少 查询 r节点， 则只要 w+r&gt;n ，读取的节点中一定会包含最新值。一般设置w=r=(n+1)/2; (仲裁读、写)</p>
</blockquote>
<h4 id="3-quorum-一致性的局限性"><a href="#3-quorum-一致性的局限性" class="headerlink" title=".3. quorum 一致性的局限性"></a>.3. quorum 一致性的局限性</h4><ul>
<li>如果采用了 sloppy  quorum (参阅本章后面的“宽松的quorum与数据回传”）， 写操作 节点和 读取的 节点可能完全不同，因此无法保证读写请求一定存在重叠 的节点 。</li>
<li>如果<code>两个写操作同时发生，则无法明确先后顺序</code>。这种情况下，唯一安全的解决方案是合并并发写入（参见本章前面的“处理写冲突”)。如果根据时间戳（最后写入获胜）挑选胜者，则由于时钟偏差问题!35]，某些写入可能会被错误地抛弃。</li>
<li>如果写操作与读操作同时发生，写操作可能仅在一部分副本上完成。此时，<code>读取时返回旧值还是新值存在不确定性</code>。</li>
<li>如果某些副本上已经写入成功，而其他一些副本发生写入失败（例如磁盘已满），且总的成功副本数少于w，那些已成功的副本上不会做回滚。这意味着尽管这样的写操作被视为失败，后续的<code>读操作仍可能返回新值</code>[47].</li>
<li>如果<code>具有新值的节点后来发生失效，但恢复数据来自某个旧值，则总的新值副本数会低于w</code>，这就打破了之前的判定条件。</li>
<li>即使一切工作正常，也会出现一些边界情况，如第9章所介绍的“可线性化与quorum”。</li>
</ul>
<h5 id="1-监控旧值"><a href="#1-监控旧值" class="headerlink" title="1. 监控旧值"></a>1. 监控旧值</h5><p>从运维角度来看，监视数据库是否返回最新结果非常重要。即使应用程序可以容忍读取旧值，也需要仔细<code>了解复制的当前运行状态</code>。如果已经出现了明显的滞后，它就是个重要的信号提醒我们需要采取必要措施来<code>排查原因</code>（例如网络问题或节点超负荷)。</p>
<h5 id="2-宽松地quorum与数据回传"><a href="#2-宽松地quorum与数据回传" class="headerlink" title="2. 宽松地quorum与数据回传"></a>2. 宽松地quorum与数据回传</h5><ul>
<li>如果无法达到w或r所要求quorum，将错误明确地返回给客户端?</li>
<li>或者，我们是否应该<code>接受该写请求，只是将它们暂时写入一些可访问的节点中?注意，这些节点并不在n个节点集合中</code>。</li>
</ul>
<h5 id="3-多数据中心操作"><a href="#3-多数据中心操作" class="headerlink" title="3. 多数据中心操作"></a>3. 多数据中心操作</h5><blockquote>
<p>Cassandra和Voldemort在其默认配置的无主节点模型中都支持跨数据中心操作:<code>副本的数量n是包含所有数据中心的节点总数</code>。配置时，可以<code>指定每个数据中心各有多少副本</code>。<code>每个客户端的写入都会发送到所有副本</code>，但客户端通常只会<code>等待来自本地数据中心内的quorum节点数的确认</code>，这样避免了高延迟和跨数据中心可能的网络异常。尽管可以灵活配置，但对远程数据中心的写入由于延迟很高，通常都被配置为<code>异步方式</code>150.51]</p>
</blockquote>
<h4 id="4-检测并发写"><a href="#4-检测并发写" class="headerlink" title=".4. 检测并发写"></a>.4. 检测并发写</h4><blockquote>
<p>一个核心问题是，由于网络延迟不稳定或者局部失效，请求在不同的节点上可能会呈现不同的顺序。</p>
</blockquote>
<p><img src="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20220414101706541.png" alt=""></p>
<h5 id="1-最后写入获胜（丢弃并发写）（LWW"><a href="#1-最后写入获胜（丢弃并发写）（LWW" class="headerlink" title="1. 最后写入获胜（丢弃并发写）（LWW)"></a>1. 最后写入获胜（丢弃并发写）（LWW)</h5><ul>
<li>为每个写请求附加一个时间戳，然后选择最新地及时间戳最大的，丢弃较早时间戳地写入。（丢失数据是否可以接受）</li>
<li>只写入一次然后写入值视为不可变，避免对同一个主键的并发覆盖写。（采用UUID作为主键，每个写操作都针对不同的，系统唯一地主键）<code>todo 这句话没太理解</code></li>
</ul>
<h5 id="2-Happens-before-关系和并发"><a href="#2-Happens-before-关系和并发" class="headerlink" title="2. Happens-before 关系和并发"></a>2. Happens-before 关系和并发</h5><ul>
<li>如果俩操作都不在另一个操作之前，则是并发，否则有因果关系 happens-before</li>
</ul>
<p><img src="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20220414102643517.png" alt=""></p>
<p><img src="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20220414102951601.png" alt=""></p>
<ul>
<li>服务器为每个主键维护一个版本号，每当主键新值写入时递增版本号，并将新版本号与写入的值一起保存。</li>
<li>当客户端读取主键时，服务器将返回<code>所有（未被覆盖的）当前值以及最新的版本号</code>。且要求写之前，客户必须先发送读请求。</li>
<li>客户端写主键，<code>写请求必须包含之前读到的版本号、读到的值和新值合并后的集合</code>。写请求的响应可以像读操作一样，会返回所有当前值，这样就可以像购物车例子那样一步步链接起多个写入的值。</li>
<li>当服务器收到带有特定版本号的写入时，<code>覆盖该版本号或更低版本的所有值（因为知道这些值已经被合并到新传入的值集合中），但必须保存更高版本号的所有值</code>（因为这些值与当前的写操作属于并发)。</li>
</ul>
<blockquote>
<p>当写请求包含了前一次读取的版本号时，意味着修改的是基于以前的状态。如果一个写请求没有包含版本号，它将与所有其他写入同时进行，不会覆盖任何已有值，其传入的值将包含在后续读请求的返回值列表当中。（通过版本号，可以实现数据不丢弃）</p>
</blockquote>
<h5 id="3-合并同时写入地值"><a href="#3-合并同时写入地值" class="headerlink" title="3. 合并同时写入地值"></a>3. 合并同时写入地值</h5><ul>
<li>如果合并了两个客户端的值，且其中有一个商品被某客户端 除掉，被删除的项目会再次出现在合并的终值中（项目在删除时不能 简单地从数据 中删除 ，系统必须<code>保留一个对应的版本号以恰当的标记该项目需要在合井时被剔除</code>。这种删除标记被称为墓碑）（CRDT 数据结构todo）</li>
</ul>
<h5 id="4-版本矢量"><a href="#4-版本矢量" class="headerlink" title="4. 版本矢量"></a>4. 版本矢量</h5><ul>
<li>当多个副本同时接受写入时，我们需要为<code>每个副本和每个主键均定义一个版本号</code>。每个副本在处理写入时增加白己的版本号，并且跟踪从其他副本看到的版本号。通过这些信息来指示要覆盖哪些值、该保留哪些并发值。</li>
<li><code>所有副本的版本号集合称为版本矢量</code>。当读取数据时，数据库副本会返回版本矢量给客户端，而在随后写入时需要将<code>版本信息包含在请求当中一起发送到数据库</code>。Riak将版本矢量编码为一个称之为因果上下文的字符串。版本矢量技术使数据库可以区分究竟应该覆盖写还是保留并发值。</li>
<li>就像单副本的例子一样，应用程序仍然需要执行合并操作。版本矢量可以保证从某一个副本读取值然后写入到另一个副本，而这些值可能会导致在其他副本上衍生出来新的“兄弟”值，但至少不会发生数据丢失且可以正确合并所有并发值。</li>
</ul>
<p><img src="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20220414110827482.png" alt=""></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://liudongdong1.github.io" rel="external nofollow noreferrer">liudongdong1</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://liudongdong1.github.io/2022/04/14/cun-chu-she-ji/shu-ju-mi-ji-xing-ying-yong-xi-tong-she-ji-bi-ji-shu-ju-fu-zhi/">https://liudongdong1.github.io/2022/04/14/cun-chu-she-ji/shu-ju-mi-ji-xing-ying-yong-xi-tong-she-ji-bi-ji-shu-ju-fu-zhi/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint polocy. If reproduced, please indicate source
                    <a href="https://liudongdong1.github.io" target="_blank">liudongdong1</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/storage/">
                                    <span class="chip bg-color">storage</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq,qzone,wechat,weibo,douban" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2022/04/14/bian-cheng-yu-yan/c/stl-guan-lian-shi-rong-qi-hashtable/">
                    <div class="card-image">
                        
                        <img src="https://cdn.pixabay.com/photo/2022/04/02/13/43/music-7107045__340.jpg" class="responsive-img" alt="STL关联式容器-hashtable">
                        
                        <span class="card-title">STL关联式容器-hashtable</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            1. 哈希冲突.1. 线性探测
根据元素的值然后除以数组大小，然后插入指定的位置

.2. 二次探测
F(i)=i*i; 如果新元素起始插入位置为H，但是H已经被占用，则会尝试H+i^2; i=[1,n];


.3. 开链（链地址法）
2
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-04-14
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" class="post-category">
                                    编程语言
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/C/">
                        <span class="chip bg-color">C++</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/04/14/bian-cheng-yu-yan/c/stl-guan-lian-shi-rong-qi-hashmap/">
                    <div class="card-image">
                        
                        <img src="https://cdn.pixabay.com/photo/2019/11/25/06/21/leaf-4651088__340.jpg" class="responsive-img" alt="STL关联式容器-hashmap">
                        
                        <span class="card-title">STL关联式容器-hashmap</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            

hash_multimap 与 hash_map 使用起来相同，只是 hash_multimap 中允许键值重复
在源码中，hash_multimap 调用的是 insert_equal ()，而 hash_map 调用的是 inser
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-04-14
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" class="post-category">
                                    编程语言
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/C/">
                        <span class="chip bg-color">C++</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <!-- <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="463294659"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2019</span>
            <a href="https://liudongdong1.github.io" target="_blank">liudongdong</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">1413.4k</span>&nbsp;字
            
            
            
            
            
            
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/liudongdong1/" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:3463264078@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>














    <a href="https://blog.csdn.net/liudongdong19/" class="tooltipped" target="_blank" data-tooltip="关注我的CSDN: https://blog.csdn.net/liudongdong19/" data-position="top" data-delay="50">
        <i class="fab fa-csdn">C</i>
    </a>





</div>
    </div>
</footer>

<div class="progress-bar"></div>
 -->

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script type="text/javascript" src="/js/CFS.Snow.min.js"></script>
    <!-- 点击爆灯效果 -->
    <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
    <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
    <script type="text/javascript" src="/js/fireworks.js"></script>
    <!--动态线条背景-->
    <script type="text/javascript"
        color="122 103 238" opacity='0.7' zIndex="-2" count="200" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
    </script>
    <!-- 天气 -->
    <!-- weather -->
    <!-- weather -->
    <script type="text/javascript">
         WIDGET = {FID: 'knAMQaFanP'}
    </script>
    <script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script>
    <script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script>
    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    

    
    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon-refresh.min.js" async="async"></script>
    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    
    <!-- {% include '_custom/custom.swig' %} -->

</body>

</html>
