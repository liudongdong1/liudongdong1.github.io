<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Android_启动流程, AIOT,Space&amp;Temporal Sequence Analysis,SpringBoot,liudongdong1,cloud">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Android_启动流程 | DaybyDay</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="DaybyDay" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">DaybyDay</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">

      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>About</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/about">
          
          <i class="fas fa-user-circle" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>about</span>
        </a>
      </li>
      
      <li>
        <a href="/resume">
          
          <i class="fa fa-user-secret" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>resume</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/gallery" class="waves-effect waves-light">
      
      <i class="fas fa-camera" style="zoom: 0.6;"></i>
      
      <span>Galleries</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">DaybyDay</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-user-circle"></i>
			
			About
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/about " style="margin-left:75px">
				  
				   <i class="fa fas fa-user-circle" style="position: absolute;left:50px" ></i>
			      
		          <span>about</span>
                  </a>
                </li>
              
                <li>

                  <a href="/resume " style="margin-left:75px">
				  
				   <i class="fa fa fa-user-secret" style="position: absolute;left:50px" ></i>
			      
		          <span>resume</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/gallery" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-camera"></i>
			
			Galleries
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/liudongdong1" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/liudongdong1" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.pixabay.com/photo/2021/09/15/06/29/pot-marigold-6625895__340.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Android_启动流程</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    .toc-fixed .toc-link::before{
        position: fixed!important;/*当toc的位置改为fixed时，.toc-link::before也要改为fixed*/
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E8%AF%AD%E8%A8%80%E6%A1%86%E6%9E%B6/" class="post-category">
                                语言框架
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2022-12-02
                </div>
                

                <!-- 
                    <i class="fa fa-pencil"></i> Author: liudongdong1
                  -->

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>Update Date:&nbsp;&nbsp;
                    2023-01-01
                </div>
                

                <!-- 
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>Word Count:&nbsp;&nbsp;
                    5k
                </div>
                 -->

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>Read Times:&nbsp;&nbsp;
                    25 Min
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>Read Count:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><img src="https://gitee.com/github-25970295/blogimgv2022/raw/master/webp-166919226600621.webp" alt=""></p>
<h3 id="1-Bootloader"><a href="#1-Bootloader" class="headerlink" title="1. Bootloader"></a>1. Bootloader</h3><ul>
<li>U-boot启动流程<ul>
<li>第一阶段：汇编代码：U-boot的第一条指令从cpu/armXXX/start.S文件开始</li>
<li>第二阶段：C代码：从文件/lib_arm/board.c的start_armboot()函数开始。</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th>Bootloader</th>
<th align="center">Monitor？</th>
<th align="right">描述</th>
<th align="right">X86</th>
<th align="right">ARM</th>
<th align="right">PowerPC</th>
</tr>
</thead>
<tbody><tr>
<td>U-boot</td>
<td align="center">是</td>
<td align="right">通用引导程序</td>
<td align="right">是</td>
<td align="right">是</td>
<td align="right">是</td>
</tr>
<tr>
<td>ReBoot</td>
<td align="center">是</td>
<td align="right">是基于eCos的引导程序</td>
<td align="right">是</td>
<td align="right">是</td>
<td align="right">是</td>
</tr>
<tr>
<td>BLOB</td>
<td align="center">否</td>
<td align="right">(StrongARM架构) LART(主板)等硬件平台的引导程序</td>
<td align="right">否</td>
<td align="right">是</td>
<td align="right">否</td>
</tr>
<tr>
<td>LILO</td>
<td align="center">否</td>
<td align="right">Linux磁盘引导程序</td>
<td align="right">是</td>
<td align="right">否</td>
<td align="right">否</td>
</tr>
<tr>
<td>GRUB</td>
<td align="center">否</td>
<td align="right">GNU的LILO替代程序</td>
<td align="right">是</td>
<td align="right">否</td>
<td align="right">否</td>
</tr>
<tr>
<td>Loadlin</td>
<td align="center">否</td>
<td align="right">从DOS引导Linux</td>
<td align="right">是</td>
<td align="right">否</td>
<td align="right">否</td>
</tr>
<tr>
<td>Vivi</td>
<td align="center">是</td>
<td align="right">韩国mizi公司开发的bootloader</td>
<td align="right">否</td>
<td align="right">是</td>
<td align="right">否</td>
</tr>
</tbody></table>
<h3 id="2-Init-cpp"><a href="#2-Init-cpp" class="headerlink" title="2. Init.cpp"></a>2. Init.cpp</h3><p>init进程是Android系统启动的第一个进程。它通过解析init.rc脚本来构建出系统的初始形态。</p>
<ul>
<li><a href="http://androidxref.com/6.0.1_r10/xref/system/core/init/init.cpp" target="_blank" rel="noopener">http://androidxref.com/6.0.1_r10/xref/system/core/init/init.cpp</a>  ， <a href="https://www.jianshu.com/p/464c3d1203b1" target="_blank" rel="noopener">解析</a></li>
<li>android6 代码， android 10 不太一样</li>
</ul>
<pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token comment" spellcheck="true">// ****************** 第一部分 ****************** </span>
<span class="token comment" spellcheck="true">// 检查启动程序的文件名</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token function">basename</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ueventd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">ueventd_main</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token function">basename</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"watchdogd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">watchdogd_main</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// ****************** 第二部分 ****************** </span>
<span class="token comment" spellcheck="true">// 设置文件属性为0777</span>
    <span class="token comment" spellcheck="true">// Clear the umask.</span>
    <span class="token function">umask</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// ****************** 第三部分 ****************** </span>
<span class="token comment" spellcheck="true">// 设置环境变量</span>
    <span class="token function">add_environment</span><span class="token punctuation">(</span><span class="token string">"PATH"</span><span class="token punctuation">,</span> _PATH_DEFPATH<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// ****************** 第四部分 ****************** </span>
<span class="token comment" spellcheck="true">// 创建一些基本目录，并挂载</span>

    <span class="token comment" spellcheck="true">//判断是否是第一次</span>
    <span class="token keyword">bool</span> is_first_stage <span class="token operator">=</span> <span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"--second-stage"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Get the basic filesystem setup we need put together in the initramdisk</span>
    <span class="token comment" spellcheck="true">// on / and then we'll let the rc file figure out the rest</span>
    <span class="token comment" spellcheck="true">//如果是第一次.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>is_first_stage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">"tmpfs"</span><span class="token punctuation">,</span> <span class="token string">"/dev"</span><span class="token punctuation">,</span> <span class="token string">"tmpfs"</span><span class="token punctuation">,</span> MS_NOSUID<span class="token punctuation">,</span> <span class="token string">"mode=0755"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token string">"/dev/pts"</span><span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token string">"/dev/socket"</span><span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">"devpts"</span><span class="token punctuation">,</span> <span class="token string">"/dev/pts"</span><span class="token punctuation">,</span> <span class="token string">"devpts"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">"proc"</span><span class="token punctuation">,</span> <span class="token string">"/proc"</span><span class="token punctuation">,</span> <span class="token string">"proc"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">"sysfs"</span><span class="token punctuation">,</span> <span class="token string">"/sys"</span><span class="token punctuation">,</span> <span class="token string">"sysfs"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token comment" spellcheck="true">// ****************** 第五部分 ****************** </span>
<span class="token comment" spellcheck="true">// 把标准输入、标准输出和标准错误重定向到空设备文件"/dev/_null_"</span>

    <span class="token comment" spellcheck="true">// We must have some place other than / to create the device nodes for</span>
    <span class="token comment" spellcheck="true">// kmsg and null, otherwise we won't be able to remount / read-only</span>
    <span class="token comment" spellcheck="true">// later on. Now that tmpfs is mounted on /dev, we can actually talk</span>
    <span class="token comment" spellcheck="true">// to the outside world.</span>
    <span class="token function">open_devnull_stdio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment" spellcheck="true">// ****************** 第六部分 ****************** </span>
<span class="token comment" spellcheck="true">// 启动kernel log</span>
    <span class="token function">klog_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">klog_set_level</span><span class="token punctuation">(</span>KLOG_NOTICE_LEVEL<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 输出init启动阶段的log      </span>
    <span class="token function">NOTICE</span><span class="token punctuation">(</span><span class="token string">"init%s started!\n"</span><span class="token punctuation">,</span> is_first_stage <span class="token operator">?</span> <span class="token string">""</span> <span class="token operator">:</span> <span class="token string">" second stage"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment" spellcheck="true">// ****************** 第七部分 ****************** </span>
<span class="token comment" spellcheck="true">// 设置系统属性</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>is_first_stage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Indicate that booting is in progress to background fw loaders, etc.</span>
<span class="token comment" spellcheck="true">// 7.1 创建初始化标志</span>
        <span class="token function">close</span><span class="token punctuation">(</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/.booting"</span><span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_CLOEXEC<span class="token punctuation">,</span> <span class="token number">0000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//7.2 初始化Android的属性系统</span>
        <span class="token function">property_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// If arguments are passed both on the command line and in DT,</span>
        <span class="token comment" spellcheck="true">// properties set in DT always have priority over the command-line ones.</span>
<span class="token comment" spellcheck="true">//7.3  解析DT和命令行中的kernel启动参数</span>
        <span class="token function">process_kernel_dt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">process_kernel_cmdline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Propogate the kernel variables to internal variables</span>
        <span class="token comment" spellcheck="true">// used by init as well as the current required properties.</span>
<span class="token comment" spellcheck="true">//7.4  设置系统属性</span>
        <span class="token function">export_kernel_boot_props</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// ****************** 第八部分 ****************** </span>

    <span class="token comment" spellcheck="true">// Set up SELinux, including loading the SELinux policy if we're in the kernel domain.</span>
    <span class="token comment" spellcheck="true">// 调用selinux_initialize函数启动SELinux</span>
    <span class="token function">selinux_initialize</span><span class="token punctuation">(</span>is_first_stage<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// If we're in the kernel domain, re-exec init to transition to the init domain now</span>
    <span class="token comment" spellcheck="true">// that the SELinux policy has been loaded.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>is_first_stage<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment" spellcheck="true">// 按照selinux policy要求，重新设置init文件属性</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">restorecon</span><span class="token punctuation">(</span><span class="token string">"/init"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ERROR</span><span class="token punctuation">(</span><span class="token string">"restorecon failed: %s\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">security_failure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">char</span><span class="token operator">*</span> path <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 设置参数  --second-stage</span>
        <span class="token keyword">char</span><span class="token operator">*</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> <span class="token keyword">const_cast</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token string">"--second-stage"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 执行init进程，重新进入main函数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">execv</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ERROR</span><span class="token punctuation">(</span><span class="token string">"execv(\"%s\") failed: %s\n"</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">security_failure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// These directories were necessarily created before initial policy load</span>
    <span class="token comment" spellcheck="true">// and therefore need their security context restored to the proper value.</span>
    <span class="token comment" spellcheck="true">// This must happen before /dev is populated by ueventd.</span>
    <span class="token function">INFO</span><span class="token punctuation">(</span><span class="token string">"Running restorecon...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">restorecon</span><span class="token punctuation">(</span><span class="token string">"/dev"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">restorecon</span><span class="token punctuation">(</span><span class="token string">"/dev/socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">restorecon</span><span class="token punctuation">(</span><span class="token string">"/dev/__properties__"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">restorecon_recursive</span><span class="token punctuation">(</span><span class="token string">"/sys"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// ****************** 第九部分 ****************** </span>
    epoll_fd <span class="token operator">=</span> <span class="token function">epoll_create1</span><span class="token punctuation">(</span>EPOLL_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//调用epoll_create1创建epoll句柄</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>epoll_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ERROR</span><span class="token punctuation">(</span><span class="token string">"epoll_create1 failed: %s\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">signal_handler_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//调用signal_handler_init()函数，主要是装载进程信号处理器</span>
    <span class="token comment" spellcheck="true">//主要是当子进程被kill之后，会在父进程接受一个信号。处理这个信号的时候往sockpair一段写数据，而另一端的fd是加入epoll中</span>

<span class="token comment" spellcheck="true">// ****************** 第十部分 ****************** </span>

    <span class="token function">property_load_boot_defaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">start_property_service</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// ****************** 第十一部分 ****************** </span>
<span class="token comment" spellcheck="true">// 重点部分，我们后面用专门用一篇文章讲解</span>
    <span class="token function">init_parse_config_file</span><span class="token punctuation">(</span><span class="token string">"/init.rc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// ****************** 第十二部分 ****************** </span>

    <span class="token function">action_for_each_trigger</span><span class="token punctuation">(</span><span class="token string">"early-init"</span><span class="token punctuation">,</span> action_add_queue_tail<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Queue an action that waits for coldboot done so we know ueventd has set up all of /dev...</span>
    <span class="token function">queue_builtin_action</span><span class="token punctuation">(</span>wait_for_coldboot_done_action<span class="token punctuation">,</span> <span class="token string">"wait_for_coldboot_done"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// ... so that we can start queuing up actions that require stuff from /dev.</span>
    <span class="token function">queue_builtin_action</span><span class="token punctuation">(</span>mix_hwrng_into_linux_rng_action<span class="token punctuation">,</span> <span class="token string">"mix_hwrng_into_linux_rng"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">queue_builtin_action</span><span class="token punctuation">(</span>keychord_init_action<span class="token punctuation">,</span> <span class="token string">"keychord_init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">queue_builtin_action</span><span class="token punctuation">(</span>console_init_action<span class="token punctuation">,</span> <span class="token string">"console_init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Trigger all the boot actions to get us started.</span>
    <span class="token function">action_for_each_trigger</span><span class="token punctuation">(</span><span class="token string">"init"</span><span class="token punctuation">,</span> action_add_queue_tail<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Repeat mix_hwrng_into_linux_rng in case /dev/hw_random or /dev/random</span>
    <span class="token comment" spellcheck="true">// wasn't ready immediately after wait_for_coldboot_done</span>
    <span class="token function">queue_builtin_action</span><span class="token punctuation">(</span>mix_hwrng_into_linux_rng_action<span class="token punctuation">,</span> <span class="token string">"mix_hwrng_into_linux_rng"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Don't mount filesystems or start core system services in charger mode.</span>
    <span class="token keyword">char</span> bootmode<span class="token punctuation">[</span>PROP_VALUE_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">property_get</span><span class="token punctuation">(</span><span class="token string">"ro.bootmode"</span><span class="token punctuation">,</span> bootmode<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>bootmode<span class="token punctuation">,</span> <span class="token string">"charger"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">action_for_each_trigger</span><span class="token punctuation">(</span><span class="token string">"charger"</span><span class="token punctuation">,</span> action_add_queue_tail<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">action_for_each_trigger</span><span class="token punctuation">(</span><span class="token string">"late-init"</span><span class="token punctuation">,</span> action_add_queue_tail<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Run all property triggers based on current state of the properties.</span>
    <span class="token function">queue_builtin_action</span><span class="token punctuation">(</span>queue_property_triggers_action<span class="token punctuation">,</span> <span class="token string">"queue_property_triggers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// ****************** 第十三部分 ****************** </span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>waiting_for_exec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">execute_one_command</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">restart_processes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> timeout <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>process_needs_restart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            timeout <span class="token operator">=</span> <span class="token punctuation">(</span>process_needs_restart <span class="token operator">-</span> <span class="token function">gettime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                timeout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">action_queue_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> cur_action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            timeout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">bootchart_sample</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

        epoll_event ev<span class="token punctuation">;</span>
        <span class="token keyword">int</span> nr <span class="token operator">=</span> <span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">epoll_wait</span><span class="token punctuation">(</span>epoll_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nr <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ERROR</span><span class="token punctuation">(</span><span class="token string">"epoll_wait failed: %s\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nr <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<ul>
<li>signal_handler_init()  todo？  具体实现原理</li>
</ul>
<blockquote>
<p>每个进程在处理其他进程发送的signal信号时都需要先注册，当进程的运行状态改变或终止时会产生某种signal信号，init进程是所有用户空间进程的父进程，当其子进程终止时产生SIGCHLD信号，init进程调用信号安装函数sigaction()，传递参数给sigaction结构体，便完成信号处理的过程。</p>
<p>当init进程调用signal_handler_init后，一旦受到子进程终止带来的SIGCHLD消息后，将利用信号处理者SIGCHLD_handler向signal_write_fd写入信息；epoll句柄监听到signal_read_fd收到消息后，将调用handle_signal进行处理。</p>
</blockquote>
<pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">signal_handler_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">// 在Linux中，父进程是通过捕捉SIGCHILD信号来得知子进程运行结束的情况</span>
    <span class="token comment" spellcheck="true">// Create a signalling mechanism for SIGCHLD.</span>
    <span class="token keyword">int</span> s<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 利用socketpair创建出已经连接的两个socket，分别作为信号的读、写端</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">socketpair</span><span class="token punctuation">(</span>AF_UNIX<span class="token punctuation">,</span> SOCK_STREAM <span class="token operator">|</span> SOCK_NONBLOCK <span class="token operator">|</span> SOCK_CLOEXEC<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ERROR</span><span class="token punctuation">(</span><span class="token string">"socketpair failed: %s\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    signal_write_fd <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    signal_read_fd <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Write to signal_write_fd if we catch SIGCHLD.</span>
    <span class="token keyword">struct</span> sigaction act<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>act<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>act<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 信号处理器为SIGCHLD_handler，其被存在sigaction结构体重，负责处理SIGCHLD消息</span>

    <span class="token comment" spellcheck="true">// 信号处理器</span>
    act<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> SIGCHLD_handler<span class="token punctuation">;</span>

     <span class="token comment" spellcheck="true">// 仅当进程终止时才接受+</span>
    act<span class="token punctuation">.</span>sa_flags <span class="token operator">=</span> SA_NOCLDSTOP<span class="token punctuation">;</span>

     <span class="token comment" spellcheck="true">// 调用信号安装函数sigaction，将监听的信号及对应的信号处理器注册到内核中</span>
    <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>act<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">reap_any_outstanding_children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 定义在system/core/init/init.cpp中，注册epoll handler，当signal_read_fd 有数据可读时，调用handle_signal</span>
    <span class="token function">register_epoll_handler</span><span class="token punctuation">(</span>signal_read_fd<span class="token punctuation">,</span> handle_signal<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="2-init-rc-文件"><a href="#2-init-rc-文件" class="headerlink" title="2. init.rc 文件"></a>2. init.rc 文件</h4><ul>
<li><a href="http://androidxref.com/6.0.1_r10/xref/system/core/rootdir/init.rc" target="_blank" rel="noopener">http://androidxref.com/6.0.1_r10/xref/system/core/rootdir/init.rc</a></li>
<li><a href="https://www.jianshu.com/p/cb73a88b0eed" target="_blank" rel="noopener">https://www.jianshu.com/p/cb73a88b0eed</a>  解析</li>
</ul>
<h3 id="3-zygote"><a href="#3-zygote" class="headerlink" title="3. zygote"></a>3. <a href="https://www.jianshu.com/p/4e5909d24d65" target="_blank" rel="noopener">zygote</a></h3><blockquote>
<p>Linux的进程是通过系统调用fork产生的，fork出的子进程除了内核中的一些核心的数据结构和父进程不同之外，其余的内存映像都是和父进程共享的。只有当子进程需要去改写这些共享的内存时，操作系统才会为子进程分配一个新的页面，并将老的页面上的数据复制一份到新的页面，这就是所谓的”写拷贝”。</p>
<ul>
<li>Zygote创建应用程序时却只使用了fork，没有调用exec。Android应用中执行的是Java代码，Java代码的不同才造成了应用的区别，而对于运行Java的环境，要求却是一样的。</li>
<li>Zygote初始化时会创建创建虚拟机，同时把需要的系统类库和资源文件加载到内存里面。Zygote fork出子进程后，这个子进程也继承了能正常工作的虚拟机和各类系统资源，接下来子进程只需要装载APK文件的字节码文件就可以运行了。这样应用程序的启动时间就会大大缩短。</li>
</ul>
</blockquote>
<p><img src="https://gitee.com/github-25970295/blogimgv2022/raw/master/webp-166919953084124.webp" alt="img"></p>
<ul>
<li>具体代码解析  todo？ 没有看懂</li>
</ul>
<p><img src="https://gitee.com/github-25970295/blogimgv2022/raw/master/5713484-27464477f2175cbb.png" alt="img"></p>
<h4 id="2-AndroidRuntime"><a href="#2-AndroidRuntime" class="headerlink" title=".2. AndroidRuntime"></a>.2. AndroidRuntime</h4><ul>
<li>负责启动虚拟机以及Java线程。AndroidRuntime类是在一个进程中只有一个实例对象，并将其保存在全局变量gCurRuntime中。</li>
</ul>
<pre class=" language-java"><code class="language-java">AndroidRuntime<span class="token operator">:</span><span class="token operator">:</span><span class="token function">AndroidRuntime</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> argBlockStart<span class="token punctuation">,</span> <span class="token keyword">const</span> size_t argBlockLength<span class="token punctuation">)</span> <span class="token operator">:</span>
        <span class="token function">mExitWithoutCleanup</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mArgBlockStart</span><span class="token punctuation">(</span>argBlockStart<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mArgBlockLength</span><span class="token punctuation">(</span>argBlockLength<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    SkGraphics<span class="token operator">:</span><span class="token operator">:</span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// There is also a global font cache, but its budget is specified by</span>
    <span class="token comment" spellcheck="true">// SK_DEFAULT_FONT_CACHE_COUNT_LIMIT and SK_DEFAULT_FONT_CACHE_LIMIT.</span>

    <span class="token comment" spellcheck="true">// Pre-allocate enough space to hold a fair number of options.    </span>
    mOptions<span class="token punctuation">.</span><span class="token function">setCapacity</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">assert</span><span class="token punctuation">(</span>gCurRuntime <span class="token operator">==</span> NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// one per process</span>
    gCurRuntime <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<ul>
<li><strong>SkGraphics::Init()</strong>: 这里主要是初始化skia图形系统。skia是google的第一个底层的图形、图像、动画、SVG、文本等多方面的图形图，是Android图形系统的引擎。skia作为第三方软件放在external目录下： external/skia/。后面附了一个skia结构图</li>
<li><strong>mOptions.setCapacity(20);</strong>：预先分配空间来存放传入虚拟机的参数</li>
<li><strong>gCurRuntime = this;</strong>：首先通过的断言判断gCurRuntime是否为空，保证只能被初始化一次</li>
</ul>
<p><img src="https://gitee.com/github-25970295/blogimgv2022/raw/master/webp-166920030983629.webp" alt=""></p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">/*
 * Start the Android runtime.  This involves starting the virtual machine
 * and calling the "static void main(String[] args)" method in the class
 * named by "className".
 *
 * Passes the main function two arguments, the class name and the specified
 * options string.
 */</span>
<span class="token keyword">void</span> AndroidRuntime<span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> className<span class="token punctuation">,</span> <span class="token keyword">const</span> Vector<span class="token operator">&lt;</span>String8<span class="token operator">></span><span class="token operator">&amp;</span> options<span class="token punctuation">,</span> <span class="token keyword">bool</span> zygote<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token operator">/</span><span class="token comment" spellcheck="true">/******************* 第一部分**********************
    ALOGD(">>>>>> START %s uid %d &lt;&lt;&lt;&lt;&lt;&lt;\n",
            className != NULL ? className : "(unknown)", getuid());

    static const String8 startSystemServer("start-system-server");

    /*
     * 'startSystemServer == true' means runtime is obsolete and not run from
     * init.rc anymore, so we print out the boot start event here.
     */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> options<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> startSystemServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment" spellcheck="true">/* track our progress through the boot sequence */</span>
           <span class="token keyword">const</span> <span class="token keyword">int</span> LOG_BOOT_PROGRESS_START <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">;</span>
           <span class="token function">LOG_EVENT_LONG</span><span class="token punctuation">(</span>LOG_BOOT_PROGRESS_START<span class="token punctuation">,</span>  <span class="token function">ns2ms</span><span class="token punctuation">(</span><span class="token function">systemTime</span><span class="token punctuation">(</span>SYSTEM_TIME_MONOTONIC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

     <span class="token operator">/</span><span class="token comment" spellcheck="true">/******************* 第二部分**********************
    const char* rootDir = getenv("ANDROID_ROOT");
    if (rootDir == NULL) {
        rootDir = "/system";
        if (!hasDir("/system")) {
            LOG_FATAL("No root directory specified, and /android does not exist.");
            return;
        }
        setenv("ANDROID_ROOT", rootDir, 1);
    }

    //const char* kernelHack = getenv("LD_ASSUME_KERNEL");
    //ALOGD("Found LD_ASSUME_KERNEL='%s'\n", kernelHack);


    //******************* 第三部分**********************
    /* start the virtual machine */</span>
    JniInvocation jni_invocation<span class="token punctuation">;</span>
    jni_invocation<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startVm</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mJavaVM<span class="token punctuation">,</span> <span class="token operator">&amp;</span>env<span class="token punctuation">,</span> zygote<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">/</span><span class="token comment" spellcheck="true">/******************* 第四部分**********************
    onVmCreated(env);


    //******************* 第五部分**********************
    /*
     * Register android functions.
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startReg</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Unable to register all android natives\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

   <span class="token operator">/</span><span class="token comment" spellcheck="true">/******************* 第六部分**********************
    /*
     * We want to call main() with a String array with arguments in it.
     * At present we have two arguments, the class name and an option string.
     * Create an array to hold them.
     */</span>
    jclass <span class="token class-name">stringClass</span><span class="token punctuation">;</span>
    jobjectArray strArray<span class="token punctuation">;</span>
    jstring classNameStr<span class="token punctuation">;</span>

    stringClass <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token string">"java/lang/String"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>stringClass <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    strArray <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">NewObjectArray</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> stringClass<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>strArray <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    classNameStr <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>classNameStr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    env<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetObjectArrayElement</span><span class="token punctuation">(</span>strArray<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> classNameStr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> options<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        jstring optionsStr <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">itemAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assert</span><span class="token punctuation">(</span>optionsStr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetObjectArrayElement</span><span class="token punctuation">(</span>strArray<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> optionsStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


   <span class="token operator">/</span><span class="token comment" spellcheck="true">/******************* 第七部分**********************
    /*
     * Start VM.  This thread becomes the main thread of the VM, and will
     * not return until the VM exits.
     */</span>
    <span class="token keyword">char</span><span class="token operator">*</span> slashClassName <span class="token operator">=</span> <span class="token function">toSlashClassName</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
    jclass <span class="token class-name">startClass</span> <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">FindClass</span><span class="token punctuation">(</span>slashClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>startClass <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"JavaVM unable to locate class '%s'\n"</span><span class="token punctuation">,</span> slashClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/* keep going */</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        jmethodID startMeth <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetStaticMethodID</span><span class="token punctuation">(</span>startClass<span class="token punctuation">,</span> <span class="token string">"main"</span><span class="token punctuation">,</span>
            <span class="token string">"([Ljava/lang/String;)V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>startMeth <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"JavaVM unable to find main() in '%s'\n"</span><span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">/* keep going */</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            env<span class="token operator">-</span><span class="token operator">></span><span class="token function">CallStaticVoidMethod</span><span class="token punctuation">(</span>startClass<span class="token punctuation">,</span> startMeth<span class="token punctuation">,</span> strArray<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">if</span> 0</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token operator">-</span><span class="token operator">></span><span class="token function">ExceptionCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">threadExitUncaughtException</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">free</span><span class="token punctuation">(</span>slashClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"Shutting down VM\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mJavaVM<span class="token operator">-</span><span class="token operator">></span><span class="token function">DetachCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> JNI_OK<span class="token punctuation">)</span>
        <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Warning: unable to detach main thread\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mJavaVM<span class="token operator">-</span><span class="token operator">></span><span class="token function">DestroyJavaVM</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Warning: VM did not shut down cleanly\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="3-Java-层-ZygoteInit"><a href="#3-Java-层-ZygoteInit" class="headerlink" title="3. Java 层 ZygoteInit"></a>3. Java 层 ZygoteInit</h4><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>

        <span class="token comment" spellcheck="true">//**************** 第一阶段 **********************</span>

        <span class="token comment" spellcheck="true">// 启动DDMS</span>
        RuntimeInit<span class="token punctuation">.</span><span class="token function">enableDdms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Start profiling the zygote initialization.</span>

        <span class="token comment" spellcheck="true">// 启动性能统计 </span>
        SamplingProfilerIntegration<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> startSystemServer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        String socketName <span class="token operator">=</span> <span class="token string">"zygote"</span><span class="token punctuation">;</span>
        String abiList <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argv<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"start-system-server"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                startSystemServer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>ABI_LIST_ARG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                abiList <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>ABI_LIST_ARG<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>SOCKET_NAME_ARG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                socketName <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>SOCKET_NAME_ARG<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Unknown command line argument: "</span> <span class="token operator">+</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>abiList <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"No ABI list supplied."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//**************** 第二阶段 **********************</span>
        <span class="token function">registerZygoteSocket</span><span class="token punctuation">(</span>socketName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        EventLog<span class="token punctuation">.</span><span class="token function">writeEvent</span><span class="token punctuation">(</span>LOG_BOOT_PROGRESS_PRELOAD_START<span class="token punctuation">,</span>
                            SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//**************** 第三阶段 **********************</span>
        <span class="token function">preload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//系统预加载类、Framework资源和openGL的资源</span>
        EventLog<span class="token punctuation">.</span><span class="token function">writeEvent</span><span class="token punctuation">(</span>LOG_BOOT_PROGRESS_PRELOAD_END<span class="token punctuation">,</span>
                            SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Finish profiling the zygote initialization.</span>
        SamplingProfilerIntegration<span class="token punctuation">.</span><span class="token function">writeZygoteSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Do an initial gc to clean up after startup</span>
        <span class="token function">gcAndFinalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Disable tracing so that forked processes do not inherit stale tracing tags from</span>
        <span class="token comment" spellcheck="true">// Zygote.</span>
        Trace<span class="token punctuation">.</span><span class="token function">setTracingEnabled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//**************** 第四阶段 **********************</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>startSystemServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">startSystemServer</span><span class="token punctuation">(</span>abiList<span class="token punctuation">,</span> socketName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Accepting command socket connections"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment" spellcheck="true">//**************** 第五阶段 **********************</span>
        <span class="token function">runSelectLoop</span><span class="token punctuation">(</span>abiList<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">closeServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MethodAndArgsCaller</span> caller<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        caller<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Zygote died with exception"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">closeServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h5 id="runSelectLoop"><a href="#runSelectLoop" class="headerlink" title="runSelectLoop"></a>runSelectLoop</h5><pre class=" language-java"><code class="language-java"><span class="token number">654</span>    <span class="token comment" spellcheck="true">/**
655     * Runs the zygote process's select loop. Accepts new connections as
656     * they happen, and reads commands from connections one spawn-request's
657     * worth at a time.
658     *
659     * @throws MethodAndArgsCaller in a child process when a main() should
660     * be executed.
661     */</span>
<span class="token number">662</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">runSelectLoop</span><span class="token punctuation">(</span>String abiList<span class="token punctuation">)</span> <span class="token keyword">throws</span> MethodAndArgsCaller <span class="token punctuation">{</span>
<span class="token number">663</span>        ArrayList<span class="token operator">&lt;</span>FileDescriptor<span class="token operator">></span> fds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>FileDescriptor<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">664</span>        ArrayList<span class="token operator">&lt;</span>ZygoteConnection<span class="token operator">></span> peers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>ZygoteConnection<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">665</span>
          <span class="token comment" spellcheck="true">//fds[0]为sServerSocket，即sServerSocket为位于zygote进程中的socket服务端</span>
<span class="token number">666</span>        fds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sServerSocket<span class="token punctuation">.</span><span class="token function">getFileDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">667</span>        peers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">668</span>
<span class="token number">669</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//************************** 第1部分   ************************** </span>
<span class="token number">670</span>            StructPollfd<span class="token punctuation">[</span><span class="token punctuation">]</span> pollFds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructPollfd</span><span class="token punctuation">[</span>fds<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token number">671</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pollFds<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">672</span>                pollFds<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructPollfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token comment" spellcheck="true">// pollFds[0].fd即为sServerSocket，位于zygote进程中的socket服务端。</span>
<span class="token number">673</span>                pollFds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> fds<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">674</span>                pollFds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> POLLIN<span class="token punctuation">;</span>
<span class="token number">675</span>            <span class="token punctuation">}</span>
<span class="token number">676</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                   <span class="token comment" spellcheck="true">// 查询轮训状态，当pollFdd有事件到来则往下执行，否则阻塞在这里</span>
<span class="token number">677</span>                Os<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>pollFds<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">678</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ErrnoException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">679</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"poll failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">680</span>            <span class="token punctuation">}</span>
<span class="token number">681</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> pollFds<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token comment" spellcheck="true">// 采用I/O 多路复用机制，当接受到客户端发出的连接请求，或者处理出具时，则往下执行</span>
                 <span class="token comment" spellcheck="true">// 否则进入continue，跳出本次循环 </span>
<span class="token number">682</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pollFds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">683</span>                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token number">684</span>                <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//************************** 第2部分   **************************</span>
<span class="token number">685</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      <span class="token comment" spellcheck="true">// 客户端第一次请求服务端，服务端调用accept与客户端建立连接，客户端在zygote以ZygoteConnection对象表示</span>
<span class="token number">686</span>                    ZygoteConnection newPeer <span class="token operator">=</span> <span class="token function">acceptCommandPeer</span><span class="token punctuation">(</span>abiList<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">687</span>                    peers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newPeer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">688</span>                    fds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newPeer<span class="token punctuation">.</span><span class="token function">getFileDesciptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">689</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//*************************** 第3部分   **************************</span>
                      <span class="token comment" spellcheck="true">// 经过上个if操作后，客户端与服务端已经建立连接，并开始发送数据</span>
                      <span class="token comment" spellcheck="true">//peers.get(index)取得发送数据客户端的ZygoteConnection对象</span>
                      <span class="token comment" spellcheck="true">// 然后调用runOnce()方法来出具具体请求</span>
<span class="token number">690</span>                    <span class="token keyword">boolean</span> done <span class="token operator">=</span> peers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">runOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">691</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">692</span>                        peers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                           <span class="token comment" spellcheck="true">// 处理完则从fds中移除该文件描述符</span>
<span class="token number">693</span>                        fds<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">694</span>                    <span class="token punctuation">}</span>
<span class="token number">695</span>                <span class="token punctuation">}</span>
<span class="token number">696</span>            <span class="token punctuation">}</span>
<span class="token number">697</span>        <span class="token punctuation">}</span>
<span class="token number">698</span>    <span class="token punctuation">}</span></code></pre>
<h3 id="4-SystemService"><a href="#4-SystemService" class="headerlink" title="4. SystemService"></a>4. SystemService</h3><pre class=" language-java"><code class="language-java"><span class="token number">176</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">177</span>        <span class="token comment" spellcheck="true">// If a device's clock is before 1970 (before 0), a lot of</span>
<span class="token number">178</span>        <span class="token comment" spellcheck="true">// APIs crash dealing with negative numbers, notably</span>
<span class="token number">179</span>        <span class="token comment" spellcheck="true">// java.io.File#setLastModified, so instead we fake it and</span>
<span class="token number">180</span>        <span class="token comment" spellcheck="true">// hope that time from cell towers or NTP fixes it shortly.</span>
           <span class="token comment" spellcheck="true">// 计算时间 如果当前系统时间比1970年更早，就设置当前系统时间为1970年</span>
<span class="token number">181</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> EARLIEST_SUPPORTED_TIME<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">182</span>            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"System clock is before 1970; setting to 1970."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">183</span>            SystemClock<span class="token punctuation">.</span><span class="token function">setCurrentTimeMillis</span><span class="token punctuation">(</span>EARLIEST_SUPPORTED_TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">184</span>        <span class="token punctuation">}</span>
<span class="token number">185</span>
<span class="token number">186</span>        <span class="token comment" spellcheck="true">// If the system has "persist.sys.language" and friends set, replace them with</span>
<span class="token number">187</span>        <span class="token comment" spellcheck="true">// "persist.sys.locale". Note that the default locale at this point is calculated</span>
<span class="token number">188</span>        <span class="token comment" spellcheck="true">// using the "-Duser.locale" command line flag. That flag is usually populated by</span>
<span class="token number">189</span>        <span class="token comment" spellcheck="true">// AndroidRuntime using the same set of system properties, but only the system_server</span>
<span class="token number">190</span>        <span class="token comment" spellcheck="true">// and system apps are allowed to set them.</span>
<span class="token number">191</span>        <span class="token comment" spellcheck="true">//</span>
<span class="token number">192</span>        <span class="token comment" spellcheck="true">// NOTE: Most changes made here will need an equivalent change to</span>
<span class="token number">193</span>        <span class="token comment" spellcheck="true">// core/jni/AndroidRuntime.cpp</span>
           <span class="token comment" spellcheck="true">// 如果没有设置 语言，则设置当地的语言</span>
<span class="token number">194</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>SystemProperties<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"persist.sys.language"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">195</span>            <span class="token keyword">final</span> String languageTag <span class="token operator">=</span> Locale<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLanguageTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">196</span>
<span class="token number">197</span>            SystemProperties<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"persist.sys.locale"</span><span class="token punctuation">,</span> languageTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">198</span>            SystemProperties<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"persist.sys.language"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">199</span>            SystemProperties<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"persist.sys.country"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">200</span>            SystemProperties<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"persist.sys.localevar"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">201</span>        <span class="token punctuation">}</span>
<span class="token number">202</span>
<span class="token number">203</span>        <span class="token comment" spellcheck="true">// Here we go!</span>
<span class="token number">204</span>        Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Entered the Android system server!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">205</span>        EventLog<span class="token punctuation">.</span><span class="token function">writeEvent</span><span class="token punctuation">(</span>EventLogTags<span class="token punctuation">.</span>BOOT_PROGRESS_SYSTEM_RUN<span class="token punctuation">,</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">206</span>
<span class="token number">207</span>        <span class="token comment" spellcheck="true">// In case the runtime switched since last boot (such as when</span>
<span class="token number">208</span>        <span class="token comment" spellcheck="true">// the old runtime was removed in an OTA), set the system</span>
<span class="token number">209</span>        <span class="token comment" spellcheck="true">// property so that it is in sync. We can't do this in</span>
<span class="token number">210</span>        <span class="token comment" spellcheck="true">// libnativehelper's JniInvocation::Init code where we already</span>
<span class="token number">211</span>        <span class="token comment" spellcheck="true">// had to fallback to a different runtime because it is</span>
<span class="token number">212</span>        <span class="token comment" spellcheck="true">// running as root and we need to be the system user to set</span>
<span class="token number">213</span>        <span class="token comment" spellcheck="true">// the property. http://b/11463182</span>

            <span class="token comment" spellcheck="true">// 设置虚拟机库文件路径，5.0以后是libart.so</span>
<span class="token number">214</span>        SystemProperties<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"persist.sys.dalvik.vm.lib.2"</span><span class="token punctuation">,</span> VMRuntime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">vmLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">215</span>
<span class="token number">216</span>        <span class="token comment" spellcheck="true">// Enable the sampling profiler.</span>
           <span class="token comment" spellcheck="true">// 如果开启了性能分析标志，则开启性能分析</span>
<span class="token number">217</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>SamplingProfilerIntegration<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">218</span>            SamplingProfilerIntegration<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">219</span>            mProfilerSnapshotTimer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">220</span>            mProfilerSnapshotTimer<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimerTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">221</span>                <span class="token annotation punctuation">@Override</span>
<span class="token number">222</span>                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">223</span>                    SamplingProfilerIntegration<span class="token punctuation">.</span><span class="token function">writeSnapshot</span><span class="token punctuation">(</span><span class="token string">"system_server"</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">224</span>                <span class="token punctuation">}</span>
<span class="token number">225</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span> SNAPSHOT_INTERVAL<span class="token punctuation">,</span> SNAPSHOT_INTERVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">226</span>        <span class="token punctuation">}</span>
<span class="token number">227</span>
<span class="token number">228</span>        <span class="token comment" spellcheck="true">// Mmmmmm... more memory!</span>
          <span class="token comment" spellcheck="true">// 清楚VM内存增长上线，由于启动过程需要较多的虚拟机内存空间</span>
<span class="token number">229</span>        VMRuntime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clearGrowthLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">230</span>
<span class="token number">231</span>        <span class="token comment" spellcheck="true">// The system server has to run all of the time, so it needs to be</span>
<span class="token number">232</span>        <span class="token comment" spellcheck="true">// as efficient as possible with its memory usage.</span>
           <span class="token comment" spellcheck="true">// 设置内存可能有效使用率为0.8</span>
<span class="token number">233</span>        VMRuntime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTargetHeapUtilization</span><span class="token punctuation">(</span><span class="token number">0.8f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">234</span>
<span class="token number">235</span>        <span class="token comment" spellcheck="true">// Some devices rely on runtime fingerprint generation, so make sure</span>
<span class="token number">236</span>        <span class="token comment" spellcheck="true">// we've defined it before booting further.</span>
           <span class="token comment" spellcheck="true">// 针对部分设备依赖运行时就产生指纹信息，因此需要在开机完成前已经定义</span>
<span class="token number">237</span>        Build<span class="token punctuation">.</span><span class="token function">ensureFingerprintProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">238</span>
<span class="token number">239</span>        <span class="token comment" spellcheck="true">// Within the system server, it is an error to access Environment paths without</span>
<span class="token number">240</span>        <span class="token comment" spellcheck="true">// explicitly specifying a user.</span>

           <span class="token comment" spellcheck="true">// 设置访问环境变量的条件，即需要明确指定用户</span>
<span class="token number">241</span>        Environment<span class="token punctuation">.</span><span class="token function">setUserRequired</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">242</span>
<span class="token number">243</span>        <span class="token comment" spellcheck="true">// Ensure binder calls into the system always run at foreground priority.</span>
           <span class="token comment" spellcheck="true">//确保当前系统进程的binder调用，总是运行在前台优先级(foreground)</span>
<span class="token number">244</span>        BinderInternal<span class="token punctuation">.</span><span class="token function">disableBackgroundScheduling</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">245</span>
<span class="token number">246</span>        <span class="token comment" spellcheck="true">// Prepare the main looper thread (this thread).</span>
<span class="token number">247</span>        android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Process<span class="token punctuation">.</span><span class="token function">setThreadPriority</span><span class="token punctuation">(</span>
<span class="token number">248</span>                android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Process<span class="token punctuation">.</span>THREAD_PRIORITY_FOREGROUND<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">249</span>        android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Process<span class="token punctuation">.</span><span class="token function">setCanSelfBackground</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment" spellcheck="true">// 主线程Looper就在当前线程运行</span>
<span class="token number">250</span>        Looper<span class="token punctuation">.</span><span class="token function">prepareMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">251</span>
           <span class="token comment" spellcheck="true">// 加载“android_servers.so”库，该库包含源码在frameworks/base/services/目录下</span>
<span class="token number">252</span>        <span class="token comment" spellcheck="true">// Initialize native services.</span>
<span class="token number">253</span>        System<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"android_servers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">254</span>
<span class="token number">255</span>        <span class="token comment" spellcheck="true">// Check whether we failed to shut down last time we tried.</span>
<span class="token number">256</span>        <span class="token comment" spellcheck="true">// This call may not return.</span>
           <span class="token comment" spellcheck="true">//检查上次关键是否失败了，可能没有返回值</span>
<span class="token number">257</span>        <span class="token function">performPendingShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">258</span>
<span class="token number">259</span>        <span class="token comment" spellcheck="true">// Initialize the system context.</span>
           <span class="token comment" spellcheck="true">// 初始化系统上下文</span>
<span class="token number">260</span>        <span class="token function">createSystemContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">261</span>
<span class="token number">262</span>        <span class="token comment" spellcheck="true">// Create the system service manager.</span>

           <span class="token comment" spellcheck="true">// 创建SystemServiceManager 用于后面的binder机制</span>
<span class="token number">263</span>        mSystemServiceManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SystemServiceManager</span><span class="token punctuation">(</span>mSystemContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">264</span>        LocalServices<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span>SystemServiceManager<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> mSystemServiceManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">265</span>
<span class="token number">266</span>        <span class="token comment" spellcheck="true">// Start services.</span>
           <span class="token comment" spellcheck="true">//启动各种系统服务</span>
<span class="token number">267</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token number">268</span>            <span class="token function">startBootstrapServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">269</span>            <span class="token function">startCoreServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">270</span>            <span class="token function">startOtherServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">271</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">272</span>            Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"System"</span><span class="token punctuation">,</span> <span class="token string">"******************************************"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">273</span>            Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"System"</span><span class="token punctuation">,</span> <span class="token string">"************ Failure starting system services"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">274</span>            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
<span class="token number">275</span>        <span class="token punctuation">}</span>
<span class="token number">276</span>
<span class="token number">277</span>        <span class="token comment" spellcheck="true">// For debug builds, log event loop stalls to dropbox for analysis.</span>
           <span class="token comment" spellcheck="true">// 如果是debug版本，为了方便分析，将log事件不断循环地输出到dropbox</span>
<span class="token number">278</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>StrictMode<span class="token punctuation">.</span><span class="token function">conditionallyEnableDebugLogging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">279</span>            Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Enabled StrictMode for system server main thread."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">280</span>        <span class="token punctuation">}</span>
<span class="token number">281</span>
<span class="token number">282</span>        <span class="token comment" spellcheck="true">// Loop forever.</span>
           <span class="token comment" spellcheck="true">// 主进程的looper开启死循环</span>
<span class="token number">283</span>        Looper<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">284</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Main thread loop unexpectedly exited"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">285</span>    <span class="token punctuation">}</span></code></pre>
<h4 id="createSystemContext"><a href="#createSystemContext" class="headerlink" title="createSystemContext"></a>createSystemContext</h4><pre class=" language-java"><code class="language-java"><span class="token number">09</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createSystemContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment" spellcheck="true">// 获取ActivityThread对象</span>
<span class="token number">310</span>        ActivityThread activityThread <span class="token operator">=</span> ActivityThread<span class="token punctuation">.</span><span class="token function">systemMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment" spellcheck="true">// 获取系统的Context</span>
<span class="token number">311</span>        mSystemContext <span class="token operator">=</span> activityThread<span class="token punctuation">.</span><span class="token function">getSystemContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment" spellcheck="true">// 设置主题</span>
<span class="token number">312</span>        mSystemContext<span class="token punctuation">.</span><span class="token function">setTheme</span><span class="token punctuation">(</span>android<span class="token punctuation">.</span>R<span class="token punctuation">.</span>style<span class="token punctuation">.</span>Theme_DeviceDefault_Light_DarkActionBar<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">313</span>    <span class="token punctuation">}</span></code></pre>
<h4 id="addService"><a href="#addService" class="headerlink" title="addService"></a>addService</h4><pre class=" language-java"><code class="language-java"><span class="token number">49</span>    <span class="token comment" spellcheck="true">/**
50     * Adds a service instance of the specified interface to the global registry of local services.
51     */</span>
<span class="token number">52</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token keyword">void</span> <span class="token function">addService</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span>T<span class="token operator">></span> type<span class="token punctuation">,</span> T service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">53</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>sLocalServiceObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">54</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>sLocalServiceObjects<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">55</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Overriding service registration"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">56</span>            <span class="token punctuation">}</span>
<span class="token number">57</span>            sLocalServiceObjects<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">58</span>        <span class="token punctuation">}</span>
<span class="token number">59</span>    <span class="token punctuation">}</span></code></pre>
<h4 id="startBootstrapServices"><a href="#startBootstrapServices" class="headerlink" title="startBootstrapServices"></a>startBootstrapServices</h4><ul>
<li>ActivityManagerService, PowerManagerService, LightsService, DisplayManagerService, PackageManagerService, UserManagerService, sensor服务</li>
</ul>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
316     * Starts the small tangle of critical services that are needed to get
317     * the system off the ground.  These services have complex mutual dependencies
318     * which is why we initialize them all in one place here.  Unless your service
319     * is also entwined in these dependencies, it should be initialized in one of
320     * the other functions.
321     */</span>
<span class="token number">322</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startBootstrapServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">323</span>        <span class="token comment" spellcheck="true">// Wait for installd to finish starting up so that it has a chance to</span>
<span class="token number">324</span>        <span class="token comment" spellcheck="true">// create critical directories such as /data/user with the appropriate</span>
<span class="token number">325</span>        <span class="token comment" spellcheck="true">// permissions.  We need this to complete before we initialize other services.</span>
           <span class="token comment" spellcheck="true">// 阻塞等待与installd建立socket通道</span>
<span class="token number">326</span>        Installer installer <span class="token operator">=</span> mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>Installer<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">327</span>
<span class="token number">328</span>        <span class="token comment" spellcheck="true">// Activity manager runs the show.</span>
           <span class="token comment" spellcheck="true">//创建AMS(ActivityManagerService)，并启动</span>
<span class="token number">329</span>        mActivityManagerService <span class="token operator">=</span> mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>
<span class="token number">330</span>                ActivityManagerService<span class="token punctuation">.</span>Lifecycle<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">331</span>        mActivityManagerService<span class="token punctuation">.</span><span class="token function">setSystemServiceManager</span><span class="token punctuation">(</span>mSystemServiceManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">332</span>        mActivityManagerService<span class="token punctuation">.</span><span class="token function">setInstaller</span><span class="token punctuation">(</span>installer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">333</span>
<span class="token number">334</span>        <span class="token comment" spellcheck="true">// Power manager needs to be started early because other services need it.</span>
<span class="token number">335</span>        <span class="token comment" spellcheck="true">// Native daemons may be watching for it to be registered so it must be ready</span>
<span class="token number">336</span>        <span class="token comment" spellcheck="true">// to handle incoming binder calls immediately (including being able to verify</span>
<span class="token number">337</span>        <span class="token comment" spellcheck="true">// the permissions for those calls).</span>
           <span class="token comment" spellcheck="true">// 启动电源管理服务，即PowerManagerService</span>
<span class="token number">338</span>        mPowerManagerService <span class="token operator">=</span> mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>PowerManagerService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">339</span>
<span class="token number">340</span>        <span class="token comment" spellcheck="true">// Now that the power manager has been started, let the activity manager</span>
<span class="token number">341</span>        <span class="token comment" spellcheck="true">// initialize power management features.</span>
           <span class="token comment" spellcheck="true">// mActivityManagerService初始化，并在其中初始化PowerManager</span>
<span class="token number">342</span>        mActivityManagerService<span class="token punctuation">.</span><span class="token function">initPowerManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">343</span>
<span class="token number">344</span>        <span class="token comment" spellcheck="true">// Manages LEDs and display backlight so we need it to bring up the display.</span>
           <span class="token comment" spellcheck="true">// 开启服务LightsService，即灯光服务</span>
<span class="token number">345</span>        mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>LightsService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">346</span>
<span class="token number">347</span>        <span class="token comment" spellcheck="true">// Display manager is needed to provide display metrics before package manager</span>
<span class="token number">348</span>        <span class="token comment" spellcheck="true">// starts up.</span>
           <span class="token comment" spellcheck="true">// 开启服务DisplayManagerService，显示服务</span>
<span class="token number">349</span>        mDisplayManagerService <span class="token operator">=</span> mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>DisplayManagerService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">350</span>
<span class="token number">351</span>        <span class="token comment" spellcheck="true">// We need the default display before we can initialize the package manager.</span>
           <span class="token comment" spellcheck="true">// 在初始化package manager之前，需要默认的显示</span>
<span class="token number">352</span>        mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startBootPhase</span><span class="token punctuation">(</span>SystemService<span class="token punctuation">.</span>PHASE_WAIT_FOR_DEFAULT_DISPLAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">353</span>
<span class="token number">354</span>        <span class="token comment" spellcheck="true">// Only run "core" apps if we're encrypting the device.</span>
           <span class="token comment" spellcheck="true">// 根据加密设备状态，决定mOnlyCore的值</span>
<span class="token number">355</span>        String cryptState <span class="token operator">=</span> SystemProperties<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"vold.decrypt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">356</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ENCRYPTING_STATE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>cryptState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">357</span>            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Detected encryption in progress - only parsing core apps"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">358</span>            mOnlyCore <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token number">359</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ENCRYPTED_STATE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>cryptState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">360</span>            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Device encrypted - only parsing core apps"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">361</span>            mOnlyCore <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token number">362</span>        <span class="token punctuation">}</span>
<span class="token number">363</span>
<span class="token number">364</span>        <span class="token comment" spellcheck="true">// Start the package manager.</span>
<span class="token number">365</span>        Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Package Manager"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment" spellcheck="true">// 启动服务PackageManagerService 即包管理</span>
<span class="token number">366</span>        mPackageManagerService <span class="token operator">=</span> PackageManagerService<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>mSystemContext<span class="token punctuation">,</span> installer<span class="token punctuation">,</span>
<span class="token number">367</span>                mFactoryTestMode <span class="token operator">!=</span> FactoryTest<span class="token punctuation">.</span>FACTORY_TEST_OFF<span class="token punctuation">,</span> mOnlyCore<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">368</span>        mFirstBoot <span class="token operator">=</span> mPackageManagerService<span class="token punctuation">.</span><span class="token function">isFirstBoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">369</span>        mPackageManager <span class="token operator">=</span> mSystemContext<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">370</span>
<span class="token number">371</span>        Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"User Service"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment" spellcheck="true">// 启动UserManagerService，即用户服务，新建目录“/data/user/”</span>
<span class="token number">372</span>        ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>USER_SERVICE<span class="token punctuation">,</span> UserManagerService<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">373</span>
<span class="token number">374</span>        <span class="token comment" spellcheck="true">// Initialize attribute cache used to cache resources from packages.</span>
<span class="token number">375</span>        AttributeCache<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>mSystemContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">376</span>
<span class="token number">377</span>        <span class="token comment" spellcheck="true">// Set up the Application instance for the system process and get started.</span>
           <span class="token comment" spellcheck="true">// 设置AMS，这样SystemServer进程可以加入到AMS中，冰杯它管理。</span>
<span class="token number">378</span>        mActivityManagerService<span class="token punctuation">.</span><span class="token function">setSystemProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">379</span>
<span class="token number">380</span>        <span class="token comment" spellcheck="true">// The sensor service needs access to package manager service, app ops</span>
<span class="token number">381</span>        <span class="token comment" spellcheck="true">// service, and permissions service, therefore we start it after them.</span>
<span class="token comment" spellcheck="true">//启动传感器服务</span>
             <span class="token comment" spellcheck="true">//开启传感器服务</span>
<span class="token number">382</span>        <span class="token function">startSensorService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">383</span>    <span class="token punctuation">}</span> </code></pre>
<h4 id="startCoreServices"><a href="#startCoreServices" class="headerlink" title="startCoreServices"></a>startCoreServices</h4><pre class=" language-java"><code class="language-java"><span class="token number">385</span>    <span class="token comment" spellcheck="true">/**
386     * Starts some essential services that are not tangled up in the bootstrap process.
387     */</span>
<span class="token number">388</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startCoreServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">389</span>        <span class="token comment" spellcheck="true">// Tracks the battery level.  Requires LightService.</span>
          <span class="token comment" spellcheck="true">// 启动服务BatteryService，用于统计电池量量</span>
<span class="token number">390</span>        mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>BatteryService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">391</span>
<span class="token number">392</span>        <span class="token comment" spellcheck="true">// Tracks application usage stats.</span>
           <span class="token comment" spellcheck="true">// 启动服务UsageStatsService，用于统计应用使用情况</span>
<span class="token number">393</span>        mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>UsageStatsService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">394</span>        mActivityManagerService<span class="token punctuation">.</span><span class="token function">setUsageStatsManager</span><span class="token punctuation">(</span>
<span class="token number">395</span>                LocalServices<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>UsageStatsManagerInternal<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">396</span>        <span class="token comment" spellcheck="true">// Update after UsageStatsService is available, needed before performBootDexOpt.</span>
<span class="token number">397</span>        mPackageManagerService<span class="token punctuation">.</span><span class="token function">getUsageStatsIfNoPackageUsageInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">398</span>
<span class="token number">399</span>        <span class="token comment" spellcheck="true">// Tracks whether the updatable WebView is in a ready state and watches for update installs.</span>
           <span class="token comment" spellcheck="true">//启动服务WebViewUpdateService</span>
<span class="token number">400</span>        mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>WebViewUpdateService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">401</span>    <span class="token punctuation">}</span></code></pre>
<h4 id="startOtherServices"><a href="#startOtherServices" class="headerlink" title="startOtherServices"></a><a href="https://www.jianshu.com/p/327f583f970b#54576e41-16ed-b257-c092-01ad9e36c010" target="_blank" rel="noopener">startOtherServices</a></h4><pre class=" language-java"><code class="language-java"><span class="token number">403</span>    <span class="token comment" spellcheck="true">/**
404     * Starts a miscellaneous grab bag of stuff that has yet to be refactored
405     * and organized.
406     */</span>
<span class="token number">407</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startOtherServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">408</span>        <span class="token keyword">final</span> Context context <span class="token operator">=</span> mSystemContext<span class="token punctuation">;</span>
<span class="token number">409</span>        AccountManagerService accountManager <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">410</span>        ContentService contentService <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">411</span>        VibratorService vibrator <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">412</span>        IAlarmManager alarm <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">413</span>        IMountService mountService <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">414</span>        NetworkManagementService networkManagement <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">415</span>        NetworkStatsService networkStats <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">416</span>        NetworkPolicyManagerService networkPolicy <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">417</span>        ConnectivityService connectivity <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">418</span>        NetworkScoreService networkScore <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">419</span>        NsdService serviceDiscovery<span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">420</span>        WindowManagerService wm <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">421</span>        UsbService usb <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">422</span>        SerialService serial <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">423</span>        NetworkTimeUpdateService networkTimeUpdater <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">424</span>        CommonTimeManagementService commonTimeMgmtService <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">425</span>        InputManagerService inputManager <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">426</span>        TelephonyRegistry telephonyRegistry <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">427</span>        ConsumerIrService consumerIr <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">428</span>        AudioService audioService <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">429</span>        MmsServiceBroker mmsService <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">430</span>        EntropyMixer entropyMixer <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">431</span>        CameraService cameraService <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">535</span>        StatusBarManagerService statusBar <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">536</span>        INotificationManager notification <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">537</span>        InputMethodManagerService imm <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">538</span>        WallpaperManagerService wallpaper <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">539</span>        LocationManagerService location <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">540</span>        CountryDetectorService countryDetector <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">541</span>        TextServicesManagerService tsms <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">542</span>        LockSettingsService lockSettings <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">543</span>        AssetAtlasService atlas <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token number">544</span>        MediaRouterService mediaRouter <span class="token operator">=</span> null<span class="token punctuation">;</span>  
<span class="token punctuation">}</span></code></pre>
<h3 id="Resource"><a href="#Resource" class="headerlink" title="Resource"></a>Resource</h3><ul>
<li><a href="https://www.jianshu.com/p/4e5909d24d65" target="_blank" rel="noopener">https://www.jianshu.com/p/4e5909d24d65</a></li>
<li><a href="https://www.jianshu.com/p/4e5909d24d65#66fcc52f-96f9-9ad9-d07b-e7721cdd08af" target="_blank" rel="noopener">https://www.jianshu.com/p/4e5909d24d65#66fcc52f-96f9-9ad9-d07b-e7721cdd08af</a>  zyogte 介绍 todo？没太懂多少</li>
<li><a href="https://www.jianshu.com/p/327f583f970b#54576e41-16ed-b257-c092-01ad9e36c010" target="_blank" rel="noopener">https://www.jianshu.com/p/327f583f970b#54576e41-16ed-b257-c092-01ad9e36c010</a> SystemService 服务相关todo</li>
</ul>

            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://liudongdong1.github.io" rel="external nofollow noreferrer">liudongdong1</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://liudongdong1.github.io/2022/12/02/android/androidframework/android-qi-dong-liu-cheng/">https://liudongdong1.github.io/2022/12/02/android/androidframework/android-qi-dong-liu-cheng/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint polocy. If reproduced, please indicate source
                    <a href="https://liudongdong1.github.io" target="_blank">liudongdong1</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Android/">
                                    <span class="chip bg-color">Android</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq,qzone,wechat,weibo,douban" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2022/12/13/android/plugins/database-greedaos/">
                    <div class="card-image">
                        
                        <img src="https://cdn.pixabay.com/photo/2021/09/15/06/29/pot-marigold-6625895__340.jpg" class="responsive-img" alt="database-greeDaos">
                        
                        <span class="card-title">database-greeDaos</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
for new apps we recommend ObjectBox, a new object-oriented database that is much faster than SQLite and easier to use. 
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-12-13
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Android/" class="post-category">
                                    Android
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/12/02/kuang-jia-she-ji/codereading/android-universal-image-loader/">
                    <div class="card-image">
                        
                        <img src="https://cdn.stocksnap.io/img-thumbs/280h/CJCMX14Z4F.jpg" class="responsive-img" alt="Android_Universal_Image_Loader">
                        
                        <span class="card-title">Android_Universal_Image_Loader</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            ImageLoader–对外接口ImageLoader 单例建造者模式构建public static void initImageLoader(Context context) {
    // This configuration tun
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-12-02
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%AF%AD%E8%A8%80%E6%A1%86%E6%9E%B6/" class="post-category">
                                    语言框架
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Java/">
                        <span class="chip bg-color">Java</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <!-- <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="463294659"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2019</span>
            <a href="https://liudongdong1.github.io" target="_blank">liudongdong</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">1314.9k</span>&nbsp;字
            
            
            
            
            
            
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/liudongdong1/" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:3463264078@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>














    <a href="https://blog.csdn.net/liudongdong19/" class="tooltipped" target="_blank" data-tooltip="关注我的CSDN: https://blog.csdn.net/liudongdong19/" data-position="top" data-delay="50">
        <i class="fab fa-csdn">C</i>
    </a>





</div>
    </div>
</footer>

<div class="progress-bar"></div>
 -->

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script type="text/javascript" src="/js/CFS.Snow.min.js"></script>
    <!-- 点击爆灯效果 -->
    <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
    <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
    <script type="text/javascript" src="/js/fireworks.js"></script>
    <!--动态线条背景-->
    <script type="text/javascript"
        color="122 103 238" opacity='0.7' zIndex="-2" count="200" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
    </script>
    <!-- 天气 -->
    <!-- weather -->
    <!-- weather -->
    <script type="text/javascript">
         WIDGET = {FID: 'knAMQaFanP'}
    </script>
    <script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script>
    <script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script>
    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    

    
    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon-refresh.min.js" async="async"></script>
    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    
    <!-- {% include '_custom/custom.swig' %} -->

</body>

</html>
