<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="rpc框架-mercury, AIOT,Space&amp;Temporal Sequence Analysis,SpringBoot,liudongdong1,cloud">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>rpc框架-mercury | DaybyDay</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="DaybyDay" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">DaybyDay</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">

      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>About</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/about">
          
          <i class="fas fa-user-circle" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>about</span>
        </a>
      </li>
      
      <li>
        <a href="/resume">
          
          <i class="fa fa-user-secret" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>resume</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/gallery" class="waves-effect waves-light">
      
      <i class="fas fa-camera" style="zoom: 0.6;"></i>
      
      <span>Galleries</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">DaybyDay</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-user-circle"></i>
			
			About
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/about " style="margin-left:75px">
				  
				   <i class="fa fas fa-user-circle" style="position: absolute;left:50px" ></i>
			      
		          <span>about</span>
                  </a>
                </li>
              
                <li>

                  <a href="/resume " style="margin-left:75px">
				  
				   <i class="fa fa fa-user-secret" style="position: absolute;left:50px" ></i>
			      
		          <span>resume</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/gallery" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-camera"></i>
			
			Galleries
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/liudongdong1" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/liudongdong1" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/19.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">rpc框架-mercury</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    .toc-fixed .toc-link::before{
        position: fixed!important;/*当toc的位置改为fixed时，.toc-link::before也要改为fixed*/
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Framework/">
                                <span class="chip bg-color">Framework</span>
                            </a>
                        
                            <a href="/tags/middleware/">
                                <span class="chip bg-color">middleware</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E8%AF%AD%E8%A8%80%E6%A1%86%E6%9E%B6/" class="post-category">
                                语言框架
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2022-07-25
                </div>
                

                <!-- 
                    <i class="fa fa-pencil"></i> Author: liudongdong1
                  -->

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>Update Date:&nbsp;&nbsp;
                    2023-01-01
                </div>
                

                <!-- 
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>Word Count:&nbsp;&nbsp;
                    3.1k
                </div>
                 -->

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>Read Times:&nbsp;&nbsp;
                    17 Min
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>Read Count:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <blockquote>
<p>Mercury is a Remote Procedure Call (RPC) framework specifically designed for use in High-Performance Computing (HPC) systems with high-performance fabrics. </p>
</blockquote>
<h2 id="Objective-amp-comparision"><a href="#Objective-amp-comparision" class="headerlink" title="Objective &amp; comparision"></a>Objective &amp; comparision</h2><ul>
<li><strong>Objective</strong>: Create a <code>reusable RPC library</code>for use in HPC that can serve as a basis for services such as <code>storage systems</code>, <code>I/O forwarding</code>, <code>analysis frameworks</code> and other forms of <code>inter-application communication</code></li>
<li>优势：<ul>
<li>takes advantage of low-level HPC network fabrics and facilitates the development of user-level data services</li>
<li>provide reliable RPC functionality, support large data arguments, and take advantage of the HPC network fabrics.</li>
<li>Mercury remains as thin as possible in order to allow for reusability between various service components that must support different needs.</li>
<li>how one can enhance RPC to (1)<code>leverage RDMA-capable networks</code>; (2) support <code>node-local service scaling and leverage multi-core processors</code>; (3) enable <code>flexible, node-local deployment scenarios and service composition</code>; (4) <code>bridge nodes between multiple HPC networks</code>; (5) enable <code>fault tolerance</code>.</li>
</ul>
</li>
<li><strong>Comparision</strong>: <ul>
<li>Do not support <code>efficient large data transfers or asynchronous calls</code></li>
<li>Can potentially introduce a lot of jitter (extra threads / memory used / etc)</li>
<li>Mostly built on top of TCP/IP protocols <ul>
<li>Need support for <code>native transport</code></li>
<li>Need to be easy to port to new systems</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="HPC-network-support"><a href="#HPC-network-support" class="headerlink" title="HPC network support"></a>HPC network support</h3><ul>
<li>leverage low-level vendor APIs such as InfiniBandTM Verbs, IntelR Performance Scaled Messaging 2 (PSM2), and CrayR Generic Network Interface (GNI) by y using OFI libfabric [16] as the intermediate layer that abstracts RDMA capabilities for RDMA-capable networks or emulated RMA (over point-to-point) for noncapable networks.</li>
</ul>
<p><img src="../../../../../blogimgv2022/image-20220730104725547.png" alt=""></p>
<h3 id="Multi-Core-Architecture-Support"><a href="#Multi-Core-Architecture-Support" class="headerlink" title="Multi-Core Architecture Support"></a>Multi-Core Architecture Support</h3><ul>
<li>by either distributing the load of incoming RPCs across cores or by running multiple services co-located within the same node.</li>
<li>Communication frameworks typically adopt one of two progress models: either explicit or implicit. <ul>
<li>Explicit progress implies that the user will regularly make progress calls to effectively check into network completion queues, poll file descriptors, etc.</li>
<li>an implicit progress model will make progress in background without any need for the user to be involved.</li>
</ul>
</li>
<li><code>decouple the RPC execution activities from the network progress activities</code>, which leads us to actually adopt a progress-and-trigger model that gives services more control over the placement of the progress and execution threads.</li>
<li><code>Scalable endpoints allow for sharing a single endpoint resources between threads by assigning separate transmit and receive contexts (including completion queues) to each thread.</code>When SEPs are used, context switches between threads no longer exist— a fundamental advantage for RPC multi-core architectures.  todo? SEP 原理介绍</li>
</ul>
<h3 id="Flexible-Provisioning-and-Topology"><a href="#Flexible-Provisioning-and-Topology" class="headerlink" title="Flexible Provisioning and Topology"></a>Flexible Provisioning and Topology</h3><h4 id="Transparent-Node-Local-Deployment"><a href="#Transparent-Node-Local-Deployment" class="headerlink" title="Transparent Node-Local Deployment"></a>Transparent Node-Local Deployment</h4><blockquote>
<p>When deploying data services, it is common for some of these services to either issue RPCs to other local services (i.e., separate processes within the same node) or to send RPCs back to themselves (i.e., within the same process). todo? 没看懂这句话</p>
</blockquote>
<p>issue RPCs to other local service</p>
<ul>
<li>Mercury 可以通过检测目标地址在同一个节点上来透明地使用共享内存。</li>
<li>使用<code>无锁共享环形缓冲区和无锁队列</code>，可以以非常低的延迟实现无锁传输。</li>
<li>对于批量数据传输并防止任何中间 memcpy，可以使用 Linux Cross-Memory Attach 机制实现零拷贝传输（即从源缓冲区到目标缓冲区的一个单一和直接复制）</li>
</ul>
<p>send RPCs back to themselves</p>
<ul>
<li>Mercury 检测目标地址何时与源地址相同，并使用相同的参数打包机制发送 RPC</li>
<li>方法是立即将 RPC 排队到本地完成队列中，在内部发出完成信号以唤醒任何在进度调用中等待的潜在线程。</li>
<li>批量数据传输是通过源缓冲区和目标缓冲区之间的 memcpy 实现的。</li>
</ul>
<h4 id="Service-Composition"><a href="#Service-Composition" class="headerlink" title="Service Composition"></a>Service Composition</h4><ul>
<li>为了提供灵活的组合，RPC API 不能特定于任何实现，而只能依赖于源和目标概念。然后可以一致地使用 RPC 机制在不同的服务“服务器”和“客户端”之间进行通信。</li>
<li>使用代理模式，或者硬件支持的 SEP 模式</li>
</ul>
<p><img src="../../../../../blogimgv2022/image-20220730111134107.png" alt=""></p>
<h3 id="Resilience-and-Fault-Tolerance"><a href="#Resilience-and-Fault-Tolerance" class="headerlink" title="Resilience and Fault Tolerance"></a>Resilience and Fault Tolerance</h3><ul>
<li>允许服务在发生故障（例如，节点故障、服务组件无响应）后恢复，而不会影响性能，只需为取消挂起的操作提供强大的支持，<code>回收 RPC 操作先前分配的本地资源并从故障中正常恢复。</code></li>
<li>如果涉及的任何对等方不再响应，则 RPC 和批量数据传输操作都可能被中断，在这种情况下，必须取消挂起的操作。取消无法完成的操作，无论是因为发生了故障还是达到了超时，对于达到正确的完成都是必要的。</li>
</ul>
<p><img src="../../../../../blogimgv2022/image-20220730111635964.png" alt=""></p>
<h2 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h2><ul>
<li>function arguments / metadata transferred with RPC request<ul>
<li>two-sides model with unexpected /expected messaging  (todo? 含义)</li>
<li>Message size limited to a few kilobytes (low-latency)</li>
</ul>
</li>
<li>Bulk data transferred using separate and dedicated API<ul>
<li>one-sided model that exposes RMA semantics (high-bandwidth)</li>
</ul>
</li>
<li>Network Abstraction layer<ul>
<li>alows definition of multiple network plugins</li>
<li>MPI and BMI plugins first plugins</li>
<li>shared-memory plugin（mmap+CMA, supported on Cray w/CLE6)</li>
<li>CCI plugin contributed by ORNL</li>
<li>Libfabric plugin contributed by Intel</li>
</ul>
</li>
</ul>
<p><img src="../../../../../blogimgv2022/image-20220730093238545.png" alt=""></p>
<h2 id="Architecture"><a href="#Architecture" class="headerlink" title="Architecture"></a>Architecture</h2><blockquote>
<ol>
<li>the <a href="https://mercury-hpc.github.io/user/na/" target="_blank" rel="noopener">network abstraction layer</a>, which provides a high-performance communication interface on top of lower level network fabrics.</li>
<li>the <a href="https://mercury-hpc.github.io/user/hg/" target="_blank" rel="noopener">RPC layer</a>, which provides users with the necessary components for sending and receiving RPC metadata (small messages). This includes serialization and deserialization of function arguments;</li>
<li>the <a href="https://mercury-hpc.github.io/user/hg_bulk/" target="_blank" rel="noopener">bulk layer</a>, which provides the necessary components for handling large arguments—this implies large data transfers through RMA;</li>
<li>the (<em>optional</em>) <a href="https://mercury-hpc.github.io/user/hg_macros/" target="_blank" rel="noopener">high-level RPC layer</a>, which aims at providing a convenience API, builds on top of the lower layers and provides macros for generating RPC stubs as well as serialization and deserialization functions.</li>
</ol>
</blockquote>
<p><img src="../../../../../blogimgv2022/image-20220730091152203.png" alt=""></p>
<p><img src="../../../../../blogimgv2022/image-20220730104034328.png" alt=""></p>
<p><img src="../../../../../blogimgv2022/image-20220730102906929.png" alt=""></p>
<h3 id="Network-Abstraction-Layer"><a href="#Network-Abstraction-Layer" class="headerlink" title="Network Abstraction Layer"></a><a href="https://mercury-hpc.github.io/user/na/" target="_blank" rel="noopener">Network Abstraction Layer</a></h3><ul>
<li>The NA layer uses a plugin mechanism so that support for various network protocols can be easily added and selected at runtime.</li>
<li>NA provides a minimal set of function calls that abstract the underlying network fabric and that can be used to provide: <em>target address lookup</em>, <em>point-to-point messaging</em> with both unexpected and expected messaging, <em>remote memory access (RMA)</em>, <em>progress</em> and <em>cancelation</em>. </li>
<li>The API is non-blocking and uses a callback mechanism so that upper layers can provide asynchronous execution more easily</li>
</ul>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// info_string 表示使用 network plugin种类，listen表示是否是target</span>
na_class_t <span class="token operator">*</span> <span class="token function">NA_Initialize</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>info_string<span class="token punctuation">,</span> na_bool_t listen<span class="token punctuation">)</span><span class="token punctuation">;</span>

na_class_t <span class="token operator">*</span><span class="token function">NA_Initialize_opt</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>info_string<span class="token punctuation">,</span> na_bool_t listen<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">struct</span> na_init_info <span class="token operator">*</span>na_init_info<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// release na_class_t object</span>
<span class="token function">na_return_tNA_Finalize</span><span class="token punctuation">(</span>na_class_t <span class="token operator">*</span>na_class<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//a context within this plugin must be created, which internally creates and associates a completion queue for the operations</span>
na_context_t <span class="token operator">*</span><span class="token function">NA_Context_create</span><span class="token punctuation">(</span>na_class_t <span class="token operator">*</span>na_class<span class="token punctuation">)</span><span class="token punctuation">;</span>

na_return_t <span class="token function">NA_Context_destroy</span><span class="token punctuation">(</span>na_class_t <span class="token operator">*</span>na_class<span class="token punctuation">,</span> na_context_t <span class="token operator">*</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//Target Address Lookup</span>
na_return_t <span class="token function">NA_Addr_self</span><span class="token punctuation">(</span>na_class_t <span class="token operator">*</span>na_class<span class="token punctuation">,</span> na_addr_t <span class="token operator">*</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//convert that address to a string</span>
na_return_t <span class="token function">NA_Addr_to_string</span><span class="token punctuation">(</span>na_class_t <span class="token operator">*</span>na_class<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> na_size_t buf_size<span class="token punctuation">,</span> na_addr_t addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//string can then be exchanged to other processes through out-of-band mechanisms (e.g., using a file, etc), which can then look up the target</span>
na_return_t <span class="token function">NA_Addr_lookup</span><span class="token punctuation">(</span>na_class_t <span class="token operator">*</span>na_class<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> na_addr_t <span class="token operator">*</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

na_return_t <span class="token function">NA_Addr_free</span><span class="token punctuation">(</span>na_class_t <span class="token operator">*</span>na_class<span class="token punctuation">,</span> na_addr_t addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<ul>
<li>Point-to-point Messaging</li>
</ul>
<pre class=" language-c"><code class="language-c">na_return_t
<span class="token function">NA_Msg_send_unexpected</span><span class="token punctuation">(</span>na_class_t <span class="token operator">*</span>na_class<span class="token punctuation">,</span> na_context_t <span class="token operator">*</span>context<span class="token punctuation">,</span>na_cb_t callback<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> na_size_t buf_size<span class="token punctuation">,</span><span class="token keyword">void</span> <span class="token operator">*</span>plugin_data<span class="token punctuation">,</span> na_addr_t dest_addr<span class="token punctuation">,</span> na_uint8_t dest_id<span class="token punctuation">,</span> na_tag_t tag<span class="token punctuation">,</span>na_op_id_t <span class="token operator">*</span>op_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

na_return_t
<span class="token function">NA_Msg_send_expected</span><span class="token punctuation">(</span>na_class_t <span class="token operator">*</span>na_class<span class="token punctuation">,</span> na_context_t <span class="token operator">*</span>context<span class="token punctuation">,</span>
    na_cb_t callback<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> na_size_t buf_size<span class="token punctuation">,</span><span class="token keyword">void</span> <span class="token operator">*</span>plugin_data<span class="token punctuation">,</span> na_addr_t dest_addr<span class="token punctuation">,</span> na_uint8_t dest_id<span class="token punctuation">,</span> na_tag_t tag<span class="token punctuation">,</span>na_op_id_t <span class="token operator">*</span>op_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

na_return_t
<span class="token function">NA_Msg_recv_unexpected</span><span class="token punctuation">(</span>na_class_t <span class="token operator">*</span>na_class<span class="token punctuation">,</span> na_context_t <span class="token operator">*</span>context<span class="token punctuation">,</span>
    na_cb_t callback<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> na_size_t buf_size<span class="token punctuation">,</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>plugin_data<span class="token punctuation">,</span> na_op_id_t <span class="token operator">*</span>op_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

na_return_t
<span class="token function">NA_Msg_recv_expected</span><span class="token punctuation">(</span>na_class_t <span class="token operator">*</span>na_class<span class="token punctuation">,</span> na_context_t <span class="token operator">*</span>context<span class="token punctuation">,</span>
    na_cb_t callback<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> na_size_t buf_size<span class="token punctuation">,</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>plugin_data<span class="token punctuation">,</span> na_addr_t source_addr<span class="token punctuation">,</span> na_uint8_t source_id<span class="token punctuation">,</span>
    na_tag_t tag<span class="token punctuation">,</span> na_op_id_t <span class="token operator">*</span>op_id<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<ul>
<li>Remote Memory Access</li>
</ul>
<pre class=" language-c"><code class="language-c">na_return_t
<span class="token function">NA_Mem_handle_create</span><span class="token punctuation">(</span>na_class_t <span class="token operator">*</span>na_class<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> na_size_t buf_size<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">,</span> na_mem_handle_t <span class="token operator">*</span>mem_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

na_return_t
<span class="token function">NA_Mem_register</span><span class="token punctuation">(</span>na_class_t <span class="token operator">*</span>na_class<span class="token punctuation">,</span> na_mem_handle_t mem_handle<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<ul>
<li>serialise /deserialize</li>
</ul>
<pre class=" language-c"><code class="language-c">na_return_t
<span class="token function">NA_Mem_handle_serialize</span><span class="token punctuation">(</span>na_class_t <span class="token operator">*</span>na_class<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> na_size_t buf_size<span class="token punctuation">,</span>na_mem_handle_t mem_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

na_return_t
<span class="token function">NA_Mem_handle_deserialize</span><span class="token punctuation">(</span>na_class_t <span class="token operator">*</span>na_class<span class="token punctuation">,</span> na_mem_handle_t <span class="token operator">*</span>mem_handle<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> na_size_t buf_size<span class="token punctuation">)</span><span class="token punctuation">;</span>


na_return_t
<span class="token function">NA_Put</span><span class="token punctuation">(</span>na_class_t <span class="token operator">*</span>na_class<span class="token punctuation">,</span> na_context_t <span class="token operator">*</span>context<span class="token punctuation">,</span> na_cb_t callback<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span>
    na_mem_handle_t local_mem_handle<span class="token punctuation">,</span> na_offset_t local_offset<span class="token punctuation">,</span>
    na_mem_handle_t remote_mem_handle<span class="token punctuation">,</span> na_offset_t remote_offset<span class="token punctuation">,</span>
    na_size_t data_size<span class="token punctuation">,</span> na_addr_t remote_addr<span class="token punctuation">,</span> na_uint8_t remote_id<span class="token punctuation">,</span> na_op_id_t <span class="token operator">*</span>op_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

na_return_t
<span class="token function">NA_Get</span><span class="token punctuation">(</span>na_class_t <span class="token operator">*</span>na_class<span class="token punctuation">,</span> na_context_t <span class="token operator">*</span>context<span class="token punctuation">,</span> na_cb_t callback<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span>
    na_mem_handle_t local_mem_handle<span class="token punctuation">,</span> na_offset_t local_offset<span class="token punctuation">,</span>
    na_mem_handle_t remote_mem_handle<span class="token punctuation">,</span> na_offset_t remote_offset<span class="token punctuation">,</span>
    na_size_t data_size<span class="token punctuation">,</span> na_addr_t remote_addr<span class="token punctuation">,</span> na_uint8_t remote_id<span class="token punctuation">,</span> na_op_id_t <span class="token operator">*</span>op_id<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<ul>
<li>Progress and Cancelation</li>
<li><code>当调用 progress 时，一旦操作完成或已经在完成队列中，它就会返回，以便可以调用 NA_Trigger() 来清空队列并执行用户回调。</code></li>
</ul>
<pre class=" language-c"><code class="language-c">na_return_t
<span class="token function">NA_Progress</span><span class="token punctuation">(</span>na_class_t <span class="token operator">*</span>na_class<span class="token punctuation">,</span> na_context_t <span class="token operator">*</span>context<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

na_return_t
<span class="token function">NA_Trigger</span><span class="token punctuation">(</span>na_context_t <span class="token operator">*</span>context<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> timeout<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_count<span class="token punctuation">,</span><span class="token keyword">int</span> callback_ret<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>actual_count<span class="token punctuation">)</span><span class="token punctuation">;</span>

na_return_t
<span class="token function">NA_Cancel</span><span class="token punctuation">(</span>na_class_t <span class="token operator">*</span>na_class<span class="token punctuation">,</span> na_context_t <span class="token operator">*</span>context<span class="token punctuation">,</span> na_op_id_t <span class="token operator">*</span>op_id<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h3 id="Mercury-RPC-Layer"><a href="#Mercury-RPC-Layer" class="headerlink" title="Mercury RPC Layer"></a><a href="https://mercury-hpc.github.io/user/hg/" target="_blank" rel="noopener">Mercury RPC Layer</a></h3><ul>
<li>the HG interface provides the following primitives:<code>target address lookup, RPC registration, RPC execution, progress and cancelation.</code></li>
</ul>
<h4 id="initialization"><a href="#initialization" class="headerlink" title="initialization"></a>initialization</h4><pre class=" language-c"><code class="language-c">hg_class_t <span class="token operator">*</span>
<span class="token function">HG_Init</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>info_string<span class="token punctuation">,</span> hg_bool_t listen<span class="token punctuation">)</span><span class="token punctuation">;</span>

hg_return_t
<span class="token function">HG_Finalize</span><span class="token punctuation">(</span>hg_class_t <span class="token operator">*</span>hg_class<span class="token punctuation">)</span><span class="token punctuation">;</span>

hg_context_t <span class="token operator">*</span>
<span class="token function">HG_Context_create</span><span class="token punctuation">(</span>hg_class_t <span class="token operator">*</span>hg_class<span class="token punctuation">)</span><span class="token punctuation">;</span>
hg_return_t
<span class="token function">HG_Context_destroy</span><span class="token punctuation">(</span>hg_context_t <span class="token operator">*</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h4 id="Registration"><a href="#Registration" class="headerlink" title="Registration"></a>Registration</h4><ul>
<li>在这里注册具体函数名字，和对应的执行函数rpc_cb</li>
</ul>
<pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token function">hg_return_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>hg_proc_cb_t<span class="token punctuation">)</span><span class="token punctuation">(</span>hg_proc_t proc<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token function">hg_return_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>hg_rpc_cb_t<span class="token punctuation">)</span><span class="token punctuation">(</span>hg_handle_t handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

hg_id_t
<span class="token function">HG_Register_name</span><span class="token punctuation">(</span>hg_class_t <span class="token operator">*</span>hg_class<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>func_name<span class="token punctuation">,</span>
                 hg_proc_cb_t in_proc_cb<span class="token punctuation">,</span> hg_proc_cb_t out_proc_cb<span class="token punctuation">,</span>
                 hg_rpc_cb_t rpc_cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
hg_return_t
<span class="token function">HG_Registered_disable_response</span><span class="token punctuation">(</span>hg_class_t <span class="token operator">*</span>hg_class<span class="token punctuation">,</span> hg_id_t id<span class="token punctuation">,</span> hg_bool_t disable<span class="token punctuation">)</span><span class="token punctuation">;</span>

hg_return_t
<span class="token function">HG_Deregister</span><span class="token punctuation">(</span>hg_class_t <span class="token operator">*</span>hg_class<span class="token punctuation">,</span> hg_id_t id<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h4 id="Target-Address-Lookup"><a href="#Target-Address-Lookup" class="headerlink" title="Target Address Lookup"></a>Target Address Lookup</h4><pre class=" language-c"><code class="language-c">hg_return_t
<span class="token function">HG_Addr_self</span><span class="token punctuation">(</span>hg_class_t <span class="token operator">*</span>hg_class<span class="token punctuation">,</span> hg_addr_t <span class="token operator">*</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
hg_return_t
<span class="token function">HG_Addr_to_string</span><span class="token punctuation">(</span>hg_class_t <span class="token operator">*</span>hg_class<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> hg_size_t <span class="token operator">*</span>buf_size<span class="token punctuation">,</span> hg_addr_t addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
hg_return_t
<span class="token function">HG_Addr_lookup</span><span class="token punctuation">(</span>hg_class_t <span class="token operator">*</span>hg_class<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> hg_addr_t <span class="token operator">*</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
hg_return_t
<span class="token function">HG_Addr_free</span><span class="token punctuation">(</span>hg_class_t <span class="token operator">*</span>hg_class<span class="token punctuation">,</span> hg_addr_t addr<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h4 id="Execution-origin"><a href="#Execution-origin" class="headerlink" title="Execution-origin"></a>Execution-origin</h4><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">//Using the RPC ID defined after a call to HG_Register(), one can use the HG_Create() call to define a new hg_handle_t object that can be used (and later re-used without reallocating resources) to set/get input/output arguments.</span>
hg_return_t
<span class="token function">HG_Create</span><span class="token punctuation">(</span>hg_context_t <span class="token operator">*</span>context<span class="token punctuation">,</span> hg_addr_t addr<span class="token punctuation">,</span> hg_id_t id<span class="token punctuation">,</span> hg_handle_t <span class="token operator">*</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//pack the input arguments within a structure, for which a serialization function is provided with the HG_Register() call. The HG_Forward() function can then be used to send that structure (which describes the input arguments). This function is non-blocking. When it completes, the associated callback can be executed by calling HG_Trigger().</span>
<span class="token keyword">typedef</span> <span class="token function">hg_return_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>hg_cb_t<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> hg_cb_info <span class="token operator">*</span>callback_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
hg_return_t
<span class="token function">HG_Forward</span><span class="token punctuation">(</span>hg_handle_t handle<span class="token punctuation">,</span> hg_cb_t callback<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>in_struct<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//When HG_Forward() completes (i.e., when the user callback can be triggered), the RPC has been remotely executed and a response with the output results has been sent back. </span>
hg_return_t
<span class="token function">HG_Get_output</span><span class="token punctuation">(</span>hg_handle_t handle<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>out_struct<span class="token punctuation">)</span><span class="token punctuation">;</span>

hg_return_t
<span class="token function">HG_Free_output</span><span class="token punctuation">(</span>hg_handle_t handle<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>out_struct<span class="token punctuation">)</span><span class="token punctuation">;</span>

hg_return_t
<span class="token function">HG_Destroy</span><span class="token punctuation">(</span>hg_handle_t handle<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h4 id="Execution-target"><a href="#Execution-target" class="headerlink" title="Execution-target"></a>Execution-target</h4><ul>
<li>在 HG_Respond 函数中：This call is also non-blocking. When it completes, the associated callback is placed onto a completion queue. It can then be triggered after a call to <code>HG_Trigger()</code>.</li>
</ul>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">//On the target, the RPC callback function passed to the HG_Register() call must be defined.</span>
<span class="token keyword">typedef</span> <span class="token function">hg_return_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>hg_rpc_cb_t<span class="token punctuation">)</span><span class="token punctuation">(</span>hg_handle_t handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//Whenever a new RPC is received, that callback will be invoked. </span>
hg_return_t
<span class="token function">HG_Get_input</span><span class="token punctuation">(</span>hg_handle_t handle<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>in_struct<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//When the input has been retrieved, the arguments contained in the input structure can be passed to the actual function call. When the execution is done, an output structure can be filled with the return value and/or the output arguments of the function. </span>
<span class="token keyword">typedef</span> <span class="token function">hg_return_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>hg_cb_t<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> hg_cb_info <span class="token operator">*</span>callback_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
hg_return_t
<span class="token function">HG_Respond</span><span class="token punctuation">(</span>hg_handle_t handle<span class="token punctuation">,</span> hg_cb_t callback<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>out_struct<span class="token punctuation">)</span><span class="token punctuation">;</span>

hg_return_t
<span class="token function">HG_Free_input</span><span class="token punctuation">(</span>hg_handle_t handle<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>in_struct<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h4 id="Progress-amp-Cancelation"><a href="#Progress-amp-Cancelation" class="headerlink" title="Progress &amp;Cancelation"></a>Progress &amp;Cancelation</h4><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">//Mercury uses a callback model. Callbacks are passed to non-blocking functions and are pushed to the context's completion queue when the operation completes. </span>
hg_return_t
<span class="token function">HG_Progress</span><span class="token punctuation">(</span>hg_context_t <span class="token operator">*</span>context<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//When an operation completes, calling HG_Trigger() allows the callback execution to be separately controlled from the main progress loop.</span>
hg_return_t
<span class="token function">HG_Trigger</span><span class="token punctuation">(</span>hg_context_t <span class="token operator">*</span>context<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> timeout<span class="token punctuation">,</span>
           <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_count<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>actual_count<span class="token punctuation">)</span><span class="token punctuation">;</span>

hg_return_t
<span class="token function">HG_Cancel</span><span class="token punctuation">(</span>hg_handle_t handle<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h3 id="Mercury-Bulk-Layer"><a href="#Mercury-Bulk-Layer" class="headerlink" title="Mercury Bulk Layer"></a>Mercury Bulk Layer</h3><h4 id="bulk-descriptor"><a href="#bulk-descriptor" class="headerlink" title="bulk descriptor"></a>bulk descriptor</h4><pre class=" language-c"><code class="language-c">hg_return_t
<span class="token function">HG_Bulk_create</span><span class="token punctuation">(</span>hg_class_t <span class="token operator">*</span>hg_class<span class="token punctuation">,</span> hg_uint32_t count<span class="token punctuation">,</span>
               <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>buf_ptrs<span class="token punctuation">,</span> <span class="token keyword">const</span> hg_size_t <span class="token operator">*</span>buf_sizes<span class="token punctuation">,</span>
               hg_uint8_t flags<span class="token punctuation">,</span> hg_bulk_t <span class="token operator">*</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

hg_return_t <span class="token function">HG_Bulk_free</span><span class="token punctuation">(</span>hg_bulk_t handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//memory pointers from an existing bulk descriptor can be accessed with:</span>
hg_return_t
<span class="token function">HG_Bulk_access</span><span class="token punctuation">(</span>hg_bulk_t handle<span class="token punctuation">,</span> hg_size_t offset<span class="token punctuation">,</span> hg_size_t size<span class="token punctuation">,</span>
               hg_uint8_t flags<span class="token punctuation">,</span> hg_uint32_t max_count<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>buf_ptrs<span class="token punctuation">,</span>
               hg_size_t <span class="token operator">*</span>buf_sizes<span class="token punctuation">,</span> hg_uint32_t <span class="token operator">*</span>actual_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//通过 HG_Bulk_bind() 函数将源地址绑定到批量句柄，代价是序列化和反序列化寻址信息的额外开销。仅当从 HG_Get_info() 调用检索的源地址与必须用于传输的源地址不同（例如，多个源）时，才需要这样做。</span>
hg_return_t
<span class="token function">HG_Bulk_bind</span><span class="token punctuation">(</span>hg_bulk_t handle<span class="token punctuation">,</span> hg_context_t <span class="token operator">*</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

hg_addr_t
<span class="token function">HG_Bulk_get_addr</span><span class="token punctuation">(</span>hg_bulk_t handle<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h4 id="Serialization"><a href="#Serialization" class="headerlink" title="Serialization"></a>Serialization</h4><pre class=" language-c"><code class="language-c">hg_return_t
<span class="token function">hg_proc_hg_bulk_t</span><span class="token punctuation">(</span>hg_proc_t proc<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h4 id="Bulk-Transfer"><a href="#Bulk-Transfer" class="headerlink" title="Bulk Transfer"></a>Bulk Transfer</h4><pre class=" language-c"><code class="language-c">hg_return_t
<span class="token function">HG_Bulk_transfer</span><span class="token punctuation">(</span>hg_context_t <span class="token operator">*</span>context<span class="token punctuation">,</span> hg_bulk_cb_t callback<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span>
                 hg_bulk_op_t op<span class="token punctuation">,</span> hg_addr_t origin_addr<span class="token punctuation">,</span>
                 hg_bulk_t origin_handle<span class="token punctuation">,</span> hg_size_t origin_offset<span class="token punctuation">,</span>
                 hg_bulk_t local_handle<span class="token punctuation">,</span> hg_size_t local_offset<span class="token punctuation">,</span>
                 hg_size_t size<span class="token punctuation">,</span> hg_op_id_t <span class="token operator">*</span>op_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> hg_info <span class="token punctuation">{</span>
    hg_class_t <span class="token operator">*</span>hg_class<span class="token punctuation">;</span>               <span class="token comment" spellcheck="true">/* HG class */</span>
    hg_context_t <span class="token operator">*</span>context<span class="token punctuation">;</span>              <span class="token comment" spellcheck="true">/* HG context */</span>
    hg_addr_t addr<span class="token punctuation">;</span>                     <span class="token comment" spellcheck="true">/* HG address */</span>
    hg_id_t id<span class="token punctuation">;</span>                         <span class="token comment" spellcheck="true">/* RPC ID */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> hg_info <span class="token operator">*</span>
<span class="token function">HG_Get_info</span><span class="token punctuation">(</span>hg_handle_t handle<span class="token punctuation">)</span><span class="token punctuation">;</span>       </code></pre>
<h3 id="Mercury-Serialization-Macros"><a href="#Mercury-Serialization-Macros" class="headerlink" title="Mercury Serialization Macros"></a>Mercury Serialization Macros</h3><blockquote>
<p>Mercury 提供的宏可以减少发送 RPC 调用所需的代码量。 Mercury 没有使用繁琐的 RPC 存根和代码生成器，而是使用 Boost 预处理器库，以便用户可以生成序列化和反序列化函数参数所需的所有样板代码。</p>
</blockquote>
<pre class=" language-c"><code class="language-c"><span class="token function">MERCURY_REGISTER</span><span class="token punctuation">(</span>hg_class<span class="token punctuation">,</span> func_name<span class="token punctuation">,</span> in_struct_type_name<span class="token punctuation">,</span> out_struct_type_name<span class="token punctuation">,</span> rpc_cb<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h3 id="相关使用案例–Mochi"><a href="#相关使用案例–Mochi" class="headerlink" title="相关使用案例–Mochi"></a>相关使用案例–Mochi</h3><p><img src="../../../../../blogimgv2022/image-20220730102455807.png" alt=""></p>
<ul>
<li>其他： DAOS / DeltaFS / UnifyCR / Dataspaces / ParaView / Visit / SOS / Faodel</li>
</ul>
<h2 id="RPC-执行流程"><a href="#RPC-执行流程" class="headerlink" title="RPC 执行流程"></a>RPC 执行流程</h2><ol>
<li>define the mechanism to send an RPC reqeust (ignore response or not)</li>
<li><strong>origin &amp; target:</strong>  register call and get request id </li>
<li><strong>origin</strong>: (pre-post recieve for target response) post unexpected send with request id and serialized parameters; <strong>target:</strong> Post receive for unexpected request/ make progress</li>
<li><strong>target:</strong> execute call</li>
<li><strong>target:</strong> post send with serialized response; <strong>Origin:</strong> make <code>progess</code></li>
</ol>
<p>![](../../../../../blogimgv2022/Screenshot from 2022-07-30 09-41-39.png)</p>
<h3 id="Progress-Model"><a href="#Progress-Model" class="headerlink" title="Progress Model"></a>Progress Model</h3><ul>
<li><code>callback-based model with completion queue</code></li>
<li>explicit progress with <code>HG_Progress() and HG_Trigger()</code><ul>
<li>allows user to create workflow</li>
<li>no need to have an explicit wait call (shim layers possible)</li>
<li>facilitate operation scheduling, multi-threaded execution and cancellation</li>
</ul>
</li>
</ul>
<pre class=" language-c"><code class="language-c"><span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> actual_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> <span class="token function">HG_Trigger</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>actual_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> HG_SUCCESS<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> actual_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">HG_Progress</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> HG_MAX_IDLE_TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> HG_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><img src="../../../../../blogimgv2022/image-20220730095114525.png" alt=""></p>
<h3 id="RPC-代码"><a href="#RPC-代码" class="headerlink" title="RPC 代码"></a>RPC 代码</h3><h4 id="1-客户端代码"><a href="#1-客户端代码" class="headerlink" title=".1. 客户端代码"></a>.1. 客户端代码</h4><pre class=" language-c"><code class="language-c">open_in_t in_struct<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* Initialize the interface and get target address */</span>
hg_class <span class="token operator">=</span> <span class="token function">HG_Init</span><span class="token punctuation">(</span><span class="token string">"ofi+tcp://eth0:22222"</span><span class="token punctuation">,</span> HG_FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
hg_context <span class="token operator">=</span> <span class="token function">HG_Context_create</span><span class="token punctuation">(</span>hg_class<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token function">HG_Addr_lookup_wait</span><span class="token punctuation">(</span>hg_context<span class="token punctuation">,</span> target_name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>target_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* Register RPC call */</span>
rpc_id <span class="token operator">=</span> <span class="token function">MERCURY_REGISTER</span><span class="token punctuation">(</span>hg_class<span class="token punctuation">,</span> <span class="token string">"open"</span><span class="token punctuation">,</span> open_in_t<span class="token punctuation">,</span> open_out_t<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* Set input parameters */</span>
in_struct<span class="token punctuation">.</span>in_param0 <span class="token operator">=</span> in_param0<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* Create RPC request */</span>
<span class="token function">HG_Create</span><span class="token punctuation">(</span>hg_context<span class="token punctuation">,</span> target_addr<span class="token punctuation">,</span> rpc_id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hg_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* Send RPC request */</span>
<span class="token function">HG_Forward</span><span class="token punctuation">(</span>hg_handle<span class="token punctuation">,</span> rpc_done_cb<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rpc_done_args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>in_struct<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* Make progress */</span>

<span class="token comment" spellcheck="true">/* cancellation */</span>
<span class="token comment" spellcheck="true">// Cancellation: HG Cancel() on handle</span>
<span class="token comment" spellcheck="true">// Callback still triggered (canceled = completion)</span></code></pre>
<h4 id="2-回调函数"><a href="#2-回调函数" class="headerlink" title=".2. 回调函数"></a>.2. 回调函数</h4><pre class=" language-c"><code class="language-c">hg_return_t
    <span class="token function">rpc_done_cb</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> hg_cb_info <span class="token operator">*</span>callback_info<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    open_out_t out_struct<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* Get output */</span>
    <span class="token function">HG_Get_output</span><span class="token punctuation">(</span>callback_info<span class="token operator">-></span>handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>out_struct<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* Get output parameters */</span>
    ret <span class="token operator">=</span> out_struct<span class="token punctuation">.</span>ret<span class="token punctuation">;</span>
    out_param0 <span class="token operator">=</span> out_struct<span class="token punctuation">.</span>out_param0<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* Free output */</span>
    <span class="token function">HG_Free_output</span><span class="token punctuation">(</span>callback_info<span class="token operator">-></span>handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>out_struct<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> HG_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="3-服务端代码"><a href="#3-服务端代码" class="headerlink" title=".3. 服务端代码"></a>.3. 服务端代码</h4><ul>
<li>客户端和服务端代码基本一致，HG_Init(“ofi+tcp://eth0:22222”, HG_TRUE);  TRUE 表示是服务端</li>
</ul>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/* Initialize the interface and listen */</span>
    hg_class <span class="token operator">=</span> <span class="token function">HG_Init</span><span class="token punctuation">(</span><span class="token string">"ofi+tcp://eth0:22222"</span><span class="token punctuation">,</span> HG_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
    <span class="token comment" spellcheck="true">/* Register RPC call */</span>
    <span class="token function">MERCURY_REGISTER</span><span class="token punctuation">(</span>hg_class<span class="token punctuation">,</span> <span class="token string">"open"</span><span class="token punctuation">,</span> open_in_t<span class="token punctuation">,</span> open_out_t<span class="token punctuation">,</span> open_rpc_cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* Make progress */</span>
    <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
    <span class="token comment" spellcheck="true">/* Finalize the interface */</span>
    <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="4-打开回调函数"><a href="#4-打开回调函数" class="headerlink" title=".4. 打开回调函数"></a>.4. 打开回调函数</h4><pre class=" language-c"><code class="language-c">hg_return_t <span class="token function">open_rpc_cb</span><span class="token punctuation">(</span>hg_handle_t handle<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    open_in_t in_struct<span class="token punctuation">;</span>
    open_out_t out_struct<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* Get input */</span>
    <span class="token function">HG_Get_input</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>in_struct<span class="token punctuation">)</span><span class="token punctuation">;</span>
    in_param0 <span class="token operator">=</span> in_struct<span class="token punctuation">.</span>in_param0<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* Execute call */</span>
    out_param0 <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>in_param0<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* Set output */</span>
    open_out_struct<span class="token punctuation">.</span>out_param0 <span class="token operator">=</span> out_param0<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* Send response back to origin */</span>
    <span class="token function">HG_Respond</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>out_struct<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* Free input and destroy handle */</span>
    <span class="token function">HG_Free_input</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>in_struct<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HG_Destroy</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> HG_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="Bulk-Data-Transfers"><a href="#Bulk-Data-Transfers" class="headerlink" title="Bulk Data Transfers"></a>Bulk Data Transfers</h3><ul>
<li><code>Transfer</code>controlled by target (better flow control)</li>
<li><code>Memory buffer(s)</code>abstracted by handle </li>
<li>Handle must be serialized and exchanged using other means</li>
</ul>
<p><img src="../../../../../blogimgv2022/image-20220730100912164.png" alt=""></p>
<ul>
<li>客户端代码</li>
</ul>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* Initialize the interface and get target address */</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token comment" spellcheck="true">/* Create bulk handle (only change) */</span>
<span class="token function">HG_Bulk_create</span><span class="token punctuation">(</span>hg_info<span class="token operator">-></span>hg_bulk_class<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf_size<span class="token punctuation">,</span> HG_BULK_READ_ONLY<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bulk_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* Attach bulk handle to input parameters */</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
in_struct<span class="token punctuation">.</span>bulk_handle <span class="token operator">=</span> bulk_handle<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* Create RPC request */</span>
<span class="token function">HG_Create</span><span class="token punctuation">(</span>hg_context<span class="token punctuation">,</span> target_addr<span class="token punctuation">,</span> rpc_id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hg_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* Send RPC request */</span>
<span class="token function">HG_Forward</span><span class="token punctuation">(</span>hg_handle<span class="token punctuation">,</span> rpc_done_cb<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rpc_done_args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>in_struct<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* Make progress */</span></code></pre>
<ul>
<li>服务端代码</li>
</ul>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* Get input parameters and bulk handle */</span>
<span class="token function">HG_Get_input</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>in_struct<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
origin_bulk_handle <span class="token operator">=</span> in_struct<span class="token punctuation">.</span>bulk_handle<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* Get size of data and allocate buffer */</span>
nbytes <span class="token operator">=</span> <span class="token function">HG_Bulk_get_size</span><span class="token punctuation">(</span>bulk_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* Create block handle to read data */</span>
<span class="token function">HG_Bulk_create</span><span class="token punctuation">(</span>hg_info<span class="token operator">-></span>hg_bulk_class<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>nbytes<span class="token punctuation">,</span>
               HG_BULK_READWRITE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>local_bulk_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* Start pulling bulk data (execute call / send response in callback) */</span>
<span class="token function">HG_Bulk_transfer</span><span class="token punctuation">(</span>hg_info<span class="token operator">-></span>bulk_context<span class="token punctuation">,</span> bulk_transfer_cb<span class="token punctuation">,</span>
                 bulk_args<span class="token punctuation">,</span> HG_BULK_PULL<span class="token punctuation">,</span> hg_info<span class="token operator">-></span>addr<span class="token punctuation">,</span> origin_bulk_handle<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                 local_bulk_handle<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> nbytes<span class="token punctuation">,</span> HG_OP_ID_IGNORE<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h3 id="Non-contiguous-memory-bulk"><a href="#Non-contiguous-memory-bulk" class="headerlink" title="Non contiguous memory bulk"></a>Non contiguous memory bulk</h3><ul>
<li>allows for scatter/gather memory transfers using virtual memory offsets and length</li>
</ul>
<pre class=" language-c"><code class="language-c">hg_return_t <span class="token function">HG_Bulk_create</span><span class="token punctuation">(</span>
    hg_bulk_class_t <span class="token operator">*</span>hg_bulk_class<span class="token punctuation">,</span>
    hg_size_t count<span class="token punctuation">,</span>
    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>buf_ptrs<span class="token punctuation">,</span>
    <span class="token keyword">const</span> hg_size_t <span class="token operator">*</span>buf_sizes<span class="token punctuation">,</span>
    hg_uint8_t flags<span class="token punctuation">,</span>
    hg_bulk_t <span class="token operator">*</span>handle
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h3 id="Macros"><a href="#Macros" class="headerlink" title="Macros"></a>Macros</h3><ul>
<li>generate as  much boilerplate code as possible for <ul>
<li>serialization/deserialization of parameters</li>
<li>sending/executing rpc</li>
</ul>
</li>
<li>single include <code>header file shared</code> between origin and target</li>
<li>make use of boost preprocessor for macro definition<ul>
<li>generate serialization / deserialization functions and structure that contains parameters.</li>
</ul>
</li>
</ul>
<p><img src="../../../../../blogimgv2022/image-20220730102020501.png" alt=""></p>
<h2 id="Resource"><a href="#Resource" class="headerlink" title="Resource"></a>Resource</h2><ul>
<li><a href="https://mercury-hpc.github.io/assets/publications/2016-07-14-Intel-meeting.pdf" target="_blank" rel="noopener">https://mercury-hpc.github.io/assets/publications/2016-07-14-Intel-meeting.pdf</a></li>
<li><a href="https://mercury-hpc.github.io/assets/publications/2017-06-22-Nersc_slides.pdf" target="_blank" rel="noopener">https://mercury-hpc.github.io/assets/publications/2017-06-22-Nersc_slides.pdf</a></li>
<li><a href="https://mercury-hpc.github.io/assets/publications/SC18_BOF_Intro_mercury.pdf" target="_blank" rel="noopener">https://mercury-hpc.github.io/assets/publications/SC18_BOF_Intro_mercury.pdf</a></li>
<li><a href="http://sites.computer.org/debull/A20mar/p23.pdf" target="_blank" rel="noopener">http://sites.computer.org/debull/A20mar/p23.pdf</a>  </li>
<li><a href="https://mercury-hpc.github.io/user/hg_macros/" target="_blank" rel="noopener">https://mercury-hpc.github.io/user/hg_macros/</a></li>
<li>案例代码：<a href="https://github1s.com/mercury-hpc/mercury/blob/HEAD/src/mercury_core.c#L5056" target="_blank" rel="noopener">https://github1s.com/mercury-hpc/mercury/blob/HEAD/src/mercury_core.c#L5056</a></li>
<li>案例代码：<a href="https://mochi.readthedocs.io/en/latest/mercury/05_bulk.html" target="_blank" rel="noopener">https://mochi.readthedocs.io/en/latest/mercury/05_bulk.html</a></li>
</ul>

            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://liudongdong1.github.io" rel="external nofollow noreferrer">liudongdong1</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://liudongdong1.github.io/2022/07/25/kuang-jia-she-ji/middleware/rpc/rpc-kuang-jia-mercury/">https://liudongdong1.github.io/2022/07/25/kuang-jia-she-ji/middleware/rpc/rpc-kuang-jia-mercury/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint polocy. If reproduced, please indicate source
                    <a href="https://liudongdong1.github.io" target="_blank">liudongdong1</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Framework/">
                                    <span class="chip bg-color">Framework</span>
                                </a>
                            
                                <a href="/tags/middleware/">
                                    <span class="chip bg-color">middleware</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq,qzone,wechat,weibo,douban" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2022/07/30/cun-chu-she-ji/kai-yuan-xiang-mu-spdk/spdk-cun-chu-yin-qing-blobstore-blobfs/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/20.jpg" class="responsive-img" alt="SPDK存储引擎-Blobstore&amp;BlobFs">
                        
                        <span class="card-title">SPDK存储引擎-Blobstore&amp;BlobFs</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
Blobstore是位于SPDK bdev之上的Blob管理层，用于与用户态文件系统Blobstore Filesystem （BlobFS）集成，从而代替传统的文件系统，支持更上层的服务，如数据库MySQL、K-V存储引擎Rocksdb
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-07-30
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Storage/" class="post-category">
                                    Storage
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Storage/">
                        <span class="chip bg-color">Storage</span>
                    </a>
                    
                    <a href="/tags/Framework/">
                        <span class="chip bg-color">Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/07/24/cun-chu-she-ji/xu-ni-hua-ji-zhu/kubernetes-cun-chu-ceph/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/23.jpg" class="responsive-img" alt="Kubernetes-_存储-ceph">
                        
                        <span class="card-title">Kubernetes-_存储-ceph</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
一个 Ceph 存储集群至少需要一个 Ceph Monitor（监视器）、Ceph Manager（管理） 和 Ceph OSD（对象存储守护进程）。
Monitors：Ceph Monitor ( ceph-mon) 维护集群状态的映射
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-07-24
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Storage/" class="post-category">
                                    Storage
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Storage/">
                        <span class="chip bg-color">Storage</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <!-- <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="463294659"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2019</span>
            <a href="https://liudongdong1.github.io" target="_blank">liudongdong</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">1314.9k</span>&nbsp;字
            
            
            
            
            
            
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/liudongdong1/" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:3463264078@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>














    <a href="https://blog.csdn.net/liudongdong19/" class="tooltipped" target="_blank" data-tooltip="关注我的CSDN: https://blog.csdn.net/liudongdong19/" data-position="top" data-delay="50">
        <i class="fab fa-csdn">C</i>
    </a>





</div>
    </div>
</footer>

<div class="progress-bar"></div>
 -->

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script type="text/javascript" src="/js/CFS.Snow.min.js"></script>
    <!-- 点击爆灯效果 -->
    <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
    <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
    <script type="text/javascript" src="/js/fireworks.js"></script>
    <!--动态线条背景-->
    <script type="text/javascript"
        color="122 103 238" opacity='0.7' zIndex="-2" count="200" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
    </script>
    <!-- 天气 -->
    <!-- weather -->
    <!-- weather -->
    <script type="text/javascript">
         WIDGET = {FID: 'knAMQaFanP'}
    </script>
    <script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script>
    <script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script>
    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    

    
    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon-refresh.min.js" async="async"></script>
    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    
    <!-- {% include '_custom/custom.swig' %} -->

</body>

</html>
