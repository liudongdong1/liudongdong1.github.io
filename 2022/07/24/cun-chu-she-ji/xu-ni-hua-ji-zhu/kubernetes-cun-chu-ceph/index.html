<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Kubernetes-_存储-ceph, AIOT,Space&amp;Temporal Sequence Analysis,SpringBoot,liudongdong1,cloud">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Kubernetes-_存储-ceph | DaybyDay</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="DaybyDay" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">DaybyDay</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">

      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>About</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/about">
          
          <i class="fas fa-user-circle" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>about</span>
        </a>
      </li>
      
      <li>
        <a href="/resume">
          
          <i class="fa fa-user-secret" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>resume</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/gallery" class="waves-effect waves-light">
      
      <i class="fas fa-camera" style="zoom: 0.6;"></i>
      
      <span>Galleries</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">DaybyDay</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-user-circle"></i>
			
			About
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/about " style="margin-left:75px">
				  
				   <i class="fa fas fa-user-circle" style="position: absolute;left:50px" ></i>
			      
		          <span>about</span>
                  </a>
                </li>
              
                <li>

                  <a href="/resume " style="margin-left:75px">
				  
				   <i class="fa fa fa-user-secret" style="position: absolute;left:50px" ></i>
			      
		          <span>resume</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/gallery" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-camera"></i>
			
			Galleries
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/liudongdong1" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/liudongdong1" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/23.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Kubernetes-_存储-ceph</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    .toc-fixed .toc-link::before{
        position: fixed!important;/*当toc的位置改为fixed时，.toc-link::before也要改为fixed*/
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Storage/">
                                <span class="chip bg-color">Storage</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Storage/" class="post-category">
                                Storage
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2022-07-24
                </div>
                

                <!-- 
                    <i class="fa fa-pencil"></i> Author: liudongdong1
                  -->

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>Update Date:&nbsp;&nbsp;
                    2023-01-01
                </div>
                

                <!-- 
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>Word Count:&nbsp;&nbsp;
                    5.3k
                </div>
                 -->

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>Read Times:&nbsp;&nbsp;
                    28 Min
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>Read Count:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <blockquote>
<p>一个 Ceph 存储集群至少需要一个 Ceph Monitor（监视器）、Ceph Manager（管理） 和 Ceph OSD（对象存储守护进程）。</p>
<p><strong>Monitors</strong>：Ceph Monitor ( ceph-mon) 维护集群状态的映射，包括监视器映射、管理器映射、OSD 映射、MDS 映射和 CRUSH 映射。这些映射是 Ceph 守护进程相互协调所需的关键集群状态。监视器还负责管理守护进程和客户端之间的身份验证。冗余和高可用性通常需要至少三个监视器。<br><strong>Managers</strong>：Ceph Manager守护进程 ( ceph-mgr) 负责跟踪运行时指标和 Ceph 集群的当前状态，包括存储利用率、当前性能指标和系统负载。高可用性通常需要至少两个管理器。<br><strong>Ceph OSD</strong>：一个Ceph OSD（ceph-osd）存储数据、处理数据复制、恢复、重新平衡，并通过检查其他 Ceph OSD 守护进程的心跳来向 Ceph 监视器和管理器提供一些监视信息。冗余和高可用性通常需要至少三个 Ceph OSD。<br><strong>MDS</strong>：Ceph 元数据服务器(MDS ceph-mds) 代表Ceph 文件系统存储元数据（即 Ceph 块设备和 Ceph 对象存储不使用 MDS）。Ceph 元数据服务器允许 POSIX 文件系统用户执行基本命令（如 ls、find等），而不会给 Ceph 存储集群带来巨大负担。</p>
</blockquote>
<h1 id="搭建ceph（操作篇）"><a href="#搭建ceph（操作篇）" class="headerlink" title="搭建ceph（操作篇）"></a>搭建ceph（操作篇）</h1><table>
<thead>
<tr>
<th>主机名</th>
<th>IP</th>
<th>网卡模式</th>
<th>内存</th>
<th>系统盘</th>
<th>数据盘</th>
</tr>
</thead>
<tbody><tr>
<td>ceph-1</td>
<td>192.168.200.43</td>
<td>NAT</td>
<td>2G</td>
<td>100G</td>
<td>20G</td>
</tr>
<tr>
<td>ceph-2</td>
<td>192.168.200.44</td>
<td>NAT</td>
<td>2G</td>
<td>100G</td>
<td>20G</td>
</tr>
<tr>
<td>ceph-3</td>
<td>192.168.200.45</td>
<td>NAT</td>
<td>2G</td>
<td>100G</td>
<td>20G</td>
</tr>
<tr>
<td>ceph-client</td>
<td>192.168.200.45</td>
<td>NAT</td>
<td>2G</td>
<td>100G</td>
<td>20G</td>
</tr>
</tbody></table>
<h2 id="1、基础配置"><a href="#1、基础配置" class="headerlink" title="1、基础配置"></a>1、基础配置</h2><p>后面的操作步骤，请注意观察命令是在那台主机上执行的（<code>非常重要</code>）</p>
<p>1、修改主机名称（三节点操作）</p>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># hostnamectl set-hostname ceph-1</span>
<span class="token punctuation">[</span>root@ceph-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># bash</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># hostnamectl set-hostname ceph-2</span>
<span class="token punctuation">[</span>root@ceph-2 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># bash</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># hostnamectl set-hostname ceph-3</span>
<span class="token punctuation">[</span>root@ceph-3 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># bash</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># hostnamectl set-hostname ceph-client</span>
<span class="token punctuation">[</span>root@ceph-clinet ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># bash</span></code></pre>
<p>2、配置hosts文件映射（三节点操作）</p>
<pre class=" language-bash"><code class="language-bash">$ <span class="token function">cat</span> <span class="token operator">>></span> /etc/hosts <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
192.168.200.43 ceph-1
192.168.200.44 ceph-2
192.168.200.45 ceph-3
192.168.200.46 ceph-client
EOF</span></code></pre>
<p>3、关闭防火墙（三节点操作）</p>
<pre class=" language-bash"><code class="language-bash">$ systemctl stop firewalld <span class="token operator">&amp;&amp;</span> systemctl disable firewalld
$ setenforce 0
$ <span class="token function">sed</span> -i <span class="token string">'s/SELINUX=.*/SELINUX=permissive/g'</span> /etc/selinux/config</code></pre>
<p>4、配置ssh免密登录</p>
<blockquote>
<p>使用 ssh-keygen 命令生成公钥、私钥（一直按回车），再使用 ssh-copy-id 命令将公钥copy复制到目标主机，最后使用一个for循环测试是否可免密登录。</p>
</blockquote>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ssh-keygen</span>
<span class="token punctuation">[</span>root@ceph-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ssh-copy-id ceph-1</span>
<span class="token punctuation">[</span>root@ceph-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ssh-copy-id ceph-2</span>
<span class="token punctuation">[</span>root@ceph-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ssh-copy-id ceph-3</span>
<span class="token punctuation">[</span>root@ceph-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ssh-copy-id ceph-client</span>
<span class="token punctuation">[</span>root@ceph-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># for i in 1 2 3 client; do ssh ceph-$i hostname ; done</span>
ceph-1
ceph-2
ceph-3
ceph-clinet</code></pre>
<p>5、配置yum源（ceph-1节点执行）</p>
<pre class=" language-bash"><code class="language-bash">$ yum <span class="token function">install</span> -y <span class="token function">wget</span>
$ <span class="token function">mv</span> /etc/yum.repos.d/* /media/  <span class="token comment" spellcheck="true"># 所有节点执行</span>
$ <span class="token function">wget</span> -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
$ <span class="token function">wget</span> -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
$ <span class="token function">vi</span> /etc/yum.repos.d/ceph.rpeo
<span class="token punctuation">[</span>ceph<span class="token punctuation">]</span>
name<span class="token operator">=</span>Ceph packages <span class="token keyword">for</span>
baseurl<span class="token operator">=</span>https://mirrors.aliyun.com/ceph/rpm-mimic/el7/<span class="token variable">$basearch</span>
enabled<span class="token operator">=</span>1
gpgcheck<span class="token operator">=</span>1
type<span class="token operator">=</span>rpm-md
gpgkey<span class="token operator">=</span>https://mirrors.aliyun.com/ceph/keys/release.asc
priority<span class="token operator">=</span>1

<span class="token punctuation">[</span>ceph-noarch<span class="token punctuation">]</span>
name<span class="token operator">=</span>Ceph noarch packages 
baseurl<span class="token operator">=</span>https://mirrors.aliyun.com/ceph/rpm-mimic/el7/noarch/
enabled<span class="token operator">=</span>1
gpgcheck<span class="token operator">=</span>1
type<span class="token operator">=</span>rpm-md
gpgkey<span class="token operator">=</span>https://mirrors.aliyun.com/ceph/keys/release.asc
priority<span class="token operator">=</span>1

<span class="token punctuation">[</span>ceph-source<span class="token punctuation">]</span>
name<span class="token operator">=</span>Ceph <span class="token function">source</span> packages 
baseurl<span class="token operator">=</span>https://mirrors.aliyun.com/ceph/rpm-mimic/el7/SRPMS/
enabled<span class="token operator">=</span>1
gpgcheck<span class="token operator">=</span>1
type<span class="token operator">=</span>rpm-md
gpgkey<span class="token operator">=</span>https://mirrors.aliyun.com/ceph/keys/release.asc
priority<span class="token operator">=</span>1

<span class="token comment" spellcheck="true">#将ceph-1节点yum，复制到ceph-2、ceph-3、ceph-client节点（需要提前移除默认repo文件）</span>
$ <span class="token keyword">for</span> i <span class="token keyword">in</span> 2 3 client<span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">scp</span> /etc/yum.repos.d/* ceph-<span class="token variable">$i</span>:/etc/yum.repos.d/ <span class="token punctuation">;</span><span class="token keyword">done</span></code></pre>
<p>6、chrony配置时间同步</p>
<ul>
<li>ceph-1节点执行</li>
</ul>
<blockquote>
<p>注意：chronyc sources命令查看时间同步是否成功，左下角 ^* 表示成功， ^? 表示不成功。<br>这一步很重要确保完成，否则安装ceph集群时会报一些奇奇怪怪的错误。</p>
</blockquote>
<pre class=" language-bash"><code class="language-bash">$ yum <span class="token function">install</span> chrony -y
$ <span class="token function">sed</span> -i <span class="token string">'3,6s/^/#/g'</span> /etc/chrony.conf
$ <span class="token function">sed</span> -i <span class="token string">'7s/^/server ceph-1 iburst/g'</span> /etc/chrony.conf
$ <span class="token keyword">echo</span> <span class="token string">"allow 192.168.200.0/24"</span> <span class="token operator">>></span> /etc/chrony.conf
$ <span class="token keyword">echo</span> <span class="token string">"local stratum 10"</span> <span class="token operator">>></span> /etc/chrony.conf
$ systemctl restart chronyd <span class="token operator">&amp;&amp;</span> systemctl <span class="token function">enable</span> chronyd

$ chronyc sources
210 Number of sources <span class="token operator">=</span> 1
MS Name/IP address         Stratum Poll Reach LastRx Last sample
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
^* ceph-1                       10   6     7     2    -25ns<span class="token punctuation">[</span>-6354ns<span class="token punctuation">]</span> +/-   10us
<span class="token punctuation">[</span>root@ceph-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># date</span>
Fri Jun  3 17:45:29 CST 2022</code></pre>
<ul>
<li>ceph-2、ceph-3、ceph-client节点执行</li>
</ul>
<pre class=" language-bash"><code class="language-bash">$ yum <span class="token function">install</span> chrony -y
$ <span class="token function">sed</span> -i <span class="token string">'3,6s/^/#/g'</span> /etc/chrony.conf
$ <span class="token function">sed</span> -i <span class="token string">'7s/^/server ceph-1 iburst/g'</span> /etc/chrony.conf
$ systemctl restart chronyd <span class="token operator">&amp;&amp;</span> systemctl <span class="token function">enable</span> chronyd

$ chronyc sources
210 Number of sources <span class="token operator">=</span> 1
MS Name/IP address         Stratum Poll Reach LastRx Last sample
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
^* ceph-1                       11   6     7     1  -2624ns<span class="token punctuation">[</span> -411ms<span class="token punctuation">]</span> +/- 1195us
<span class="token punctuation">[</span>root@ceph-2 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># date</span>
Fri Jun  3 17:45:29 CST 2022</code></pre>
<h2 id="2、创建ceph集群"><a href="#2、创建ceph集群" class="headerlink" title="2、创建ceph集群"></a>2、创建ceph集群</h2><p>后面的操作步骤，请注意观察命令是在那台主机上执行的（<code>非常重要</code>），几乎所有操作在ceph-1节点。</p>
<p>1、 安装ceph-deploy（三节点操作）</p>
<blockquote>
<p>注意：检查ceph版本是否为 ceph-deploy-2.0.1 版本。如果使用ceph-deploy-1.5.x版本使用此文档会有小问题。<br>推荐使用ceph-deploy-2.0.1 版本</p>
</blockquote>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum install ceph-deploy ceph python-setuptools -y</span>
<span class="token punctuation">[</span>root@ceph-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph-deploy --version</span>
2.0.1
<span class="token punctuation">[</span>root@ceph-2 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum install ceph python-setuptools -y</span>
<span class="token punctuation">[</span>root@ceph-3 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum install ceph python-setuptools -y</span></code></pre>
<p>2、部署集群</p>
<blockquote>
<p>ceph.conf：ceph配置文件<br>ceph-deploy-ceph.log：日志文件<br>ceph.mon.keyring：mon密钥文件（mon之间通信会用到）</p>
</blockquote>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cd /etc/ceph</span>
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph-deploy new ceph-1</span>
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ll</span>
total 16
-rw-r--r--. 1 root root  198 Jun  2 16:06 ceph.conf
-rw-r--r--. 1 root root 2933 Jun  2 16:06 ceph-deploy-ceph.log
-rw-------. 1 root root   73 Jun  2 16:06 ceph.mon.keyring
-rw-r--r--. 1 root root   92 Apr 24  2020 rbdmap</code></pre>
<p>修改副本数</p>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat ceph.conf</span>
<span class="token punctuation">[</span>global<span class="token punctuation">]</span>
fsid <span class="token operator">=</span> 1bd553c0-75e5-4f1e-aa51-88cb9aae7ba5
mon_initial_members <span class="token operator">=</span> ceph-1
mon_host <span class="token operator">=</span> 192.168.200.43
auth_cluster_required <span class="token operator">=</span> cephx
auth_service_required <span class="token operator">=</span> cephx
auth_client_required <span class="token operator">=</span> cephx
osd_pool_default_size <span class="token operator">=</span> 2          <span class="token comment" spellcheck="true">#添加</span></code></pre>
<p>安装ceph相关程序包、依赖包</p>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph-deploy install ceph-1 ceph-2 ceph-3</span></code></pre>
<p>安装ceph monitor监视器</p>
<blockquote>
<p>安装monitor后使用ceph -s查看集群状态报错（需要身份验证文件）</p>
</blockquote>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph-deploy mon create ceph-1</span>
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph -s</span>
2022-06-02 16:07:16.087 7fb927470700 -1 auth: unable to <span class="token function">find</span> a keyring on /etc/ceph/ceph.client.admin.keyring,/etc/ceph/ceph.keyring,/etc/ceph/keyring,/etc/ceph/keyring.bin,: <span class="token punctuation">(</span>2<span class="token punctuation">)</span> No such <span class="token function">file</span> or directory
2022-06-02 16:07:16.087 7fb927470700 -1 monclient: ERROR: missing keyring, cannot use cephx <span class="token keyword">for</span> authentication
<span class="token punctuation">[</span>errno 2<span class="token punctuation">]</span> error connecting to the cluster</code></pre>
<p>使用gatherkeys子命令，收集配置新节点的身份验证密钥。</p>
<blockquote>
<p>这时你会发现/etc/ceph目录下多了5个密钥文件，再一次使用ceph -s发现可以使用并且集群状态是HEALTH_OK。</p>
</blockquote>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph-deploy gatherkeys ceph-1</span>
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ll</span>
total 44
-rw-------. 1 root root   113 May 31 09:51 ceph.bootstrap-mds.keyring   <span class="token comment" spellcheck="true">#mds密钥</span>
-rw-------. 1 root root   113 May 31 09:51 ceph.bootstrap-mgr.keyring   <span class="token comment" spellcheck="true">#mgr密钥</span>
-rw-------. 1 root root   113 May 31 09:51 ceph.bootstrap-osd.keyring    <span class="token comment" spellcheck="true">#osd密钥</span>
-rw-------. 1 root root   113 May 31 09:51 ceph.bootstrap-rgw.keyring    <span class="token comment" spellcheck="true">#rgw密钥</span>
-rw-------. 1 root root   151 May 31 09:51 ceph.client.admin.keyring    <span class="token comment" spellcheck="true">#admin管理用户密钥</span>
-rw-r--r--. 1 root root   223 May 31 09:50 ceph.conf
-rw-r--r--. 1 root root 14695 May 31 09:51 ceph-deploy-ceph.log
-rw-------. 1 root root    73 May 31 09:47 ceph.mon.keyring
<span class="token comment" spellcheck="true"># 连接ceph集群admin用户密码</span>
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat ceph.client.admin.keyring</span>
<span class="token punctuation">[</span>client.admin<span class="token punctuation">]</span>
        key <span class="token operator">=</span> AQAWHZZiaX5eFBAAwkKizCr+cjbeQpqmjMZ5sQ<span class="token operator">==</span>
        caps mds <span class="token operator">=</span> <span class="token string">"allow *"</span>
        caps mgr <span class="token operator">=</span> <span class="token string">"allow *"</span>
        caps mon <span class="token operator">=</span> <span class="token string">"allow *"</span>
        caps osd <span class="token operator">=</span> <span class="token string">"allow *"</span>
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph -s</span>
  cluster:
    id:     48a5d20d-b4b7-49cd-b50e-3876509024e2
    health: HEALTH_OK

  services:
    mon: 1 daemons, quorum ceph-1
    mgr: no daemons active
    osd: 0 osds: 0 up, 0 <span class="token keyword">in</span>

  data:
    pools:   0 pools, 0 pgs
    objects: 0  objects, 0 B
    usage:   0 B used, 0 B / 0 B avail
    pgs:</code></pre>
<h2 id="3、部署mgr管理服务"><a href="#3、部署mgr管理服务" class="headerlink" title="3、部署mgr管理服务"></a>3、部署mgr管理服务</h2><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph-deploy mgr create ceph-1</span>
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph -s</span>
  cluster:
    id:     48a5d20d-b4b7-49cd-b50e-3876509024e2
    health: HEALTH_OK

  services:
    mon: 1 daemons, quorum ceph-1
    mgr: ceph-1<span class="token punctuation">(</span>active<span class="token punctuation">)</span>
    osd: 3 osds: 3 up, 3 <span class="token keyword">in</span>

  data:
    pools:   0 pools, 0 pgs
    objects: 0  objects, 0 B
    usage:   3.0 GiB used, 27 GiB / 30 GiB avail
    pgs:</code></pre>
<p>统一集群配置</p>
<blockquote>
<p>将admin密钥文件拷贝到指定节点，这样每次执行ceph命令时就无需指定monitor地址和ceph.client.admin.keyring了。</p>
</blockquote>
<pre class=" language-bash"><code class="language-bash">$ ceph-deploy admin ceph-1 ceph-2 ceph-3
 <span class="token comment" spellcheck="true">#各节点添加r读权限</span>
$ <span class="token function">chmod</span> +r /etc/ceph/ceph.client.admin.keyring</code></pre>
<h2 id="4、部署osd"><a href="#4、部署osd" class="headerlink" title="4、部署osd"></a>4、部署osd</h2><blockquote>
<p>三节点磁盘都格式化为xfs格式</p>
</blockquote>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># lsblk</span>
NAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
<span class="token punctuation">..</span>.
sdb               8:16   0   20G  0 disk
sr0              11:0    1 1024M  0 rom

<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mkfs.xfs /dev/sdb  #所有集群节点执行</span>
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># lsblk -f</span>
NAME            FSTYPE      LABEL UUID                                   MOUNTPOINT
<span class="token punctuation">..</span>.
sdb             xfs               5dfa0891-e40f-48ee-9591-da7e353cf842

<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph-deploy osd create ceph-1 --data /dev/sdb</span>
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph-deploy osd create ceph-2 --data /dev/sdb</span>
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph-deploy osd create ceph-3 --data /dev/sdb</span>
<span class="token comment" spellcheck="true">#查看osd状态</span>
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph-deploy osd list ceph-1 ceph-2 ceph-3</span>

<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#  ceph -s</span>
  cluster:
    id:     e9ae008c-8567-4af5-a6be-22c75d430f2e
    health: HEALTH_OK

  services:
    mon: 1 daemons, quorum ceph-1
    mgr: ceph-1<span class="token punctuation">(</span>active<span class="token punctuation">)</span>
    osd: 3 osds: 3 up, 3 <span class="token keyword">in</span>

  data:
    pools:   0 pools, 0 pgs
    objects: 0  objects, 0 B
    usage:   3.0 GiB used, 57 GiB / 60 GiB avail
    pgs:</code></pre>
<h1 id="使用ceph"><a href="#使用ceph" class="headerlink" title="使用ceph"></a>使用ceph</h1><h2 id="一、cephfs文件系统"><a href="#一、cephfs文件系统" class="headerlink" title="一、cephfs文件系统"></a>一、cephfs文件系统</h2><p>1、部署mds</p>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph-deploy mds create ceph-1 ceph-2 ceph-3</span>
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph mds stat</span>
, 3 up:standby
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph -s</span>
  cluster:
    id:     e9ae008c-8567-4af5-a6be-22c75d430f2e
    health: HEALTH_OK

  services:
    mon: 1 daemons, quorum ceph-1
    mgr: ceph-1<span class="token punctuation">(</span>active<span class="token punctuation">)</span>
    osd: 3 osds: 3 up, 3 <span class="token keyword">in</span>

  data:
    pools:   0 pools, 0 pgs
    objects: 0  objects, 0 B
    usage:   3.0 GiB used, 57 GiB / 60 GiB avail
    pgs:</code></pre>
<p>2、创建存储池</p>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph osd pool create cephfs_data 128</span>
pool <span class="token string">'cephfs_data'</span> created
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph osd pool create cephfs_metadata 60</span>
pool <span class="token string">'cephfs_metadata'</span> created</code></pre>
<p>3、创建文件系统</p>
<blockquote>
<p>语法：ceph fs new <fs_name> <metadata> <data></p>
</blockquote>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph fs new cephfs cephfs_metadata cephfs_data</span>
new fs with metadata pool 2 and data pool 1
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph fs ls</span>
name: cephfs, metadata pool: cephfs_metadata, data pools: <span class="token punctuation">[</span>cephfs_data <span class="token punctuation">]</span></code></pre>
<p>4、创建文件系统后，MDS 进入活动状态。</p>
<blockquote>
<p>创建了文件系统并且 MDS 处于活动状态（active），就可以挂载文件系统了。</p>
</blockquote>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph mds stat  #1个处于活跃、2个处于热备份</span>
cephfs-1/1/1 up  <span class="token punctuation">{</span>0<span class="token operator">=</span>ceph-1<span class="token operator">=</span>up:active<span class="token punctuation">}</span>, 2 up:standby
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph -s</span>
  cluster:
    id:     e9ae008c-8567-4af5-a6be-22c75d430f2e
    health: HEALTH_OK

  services:
    mon: 1 daemons, quorum ceph-1
    mgr: ceph-1<span class="token punctuation">(</span>active<span class="token punctuation">)</span>
    mds: cephfs-1/1/1 up  <span class="token punctuation">{</span>0<span class="token operator">=</span>ceph-1<span class="token operator">=</span>up:active<span class="token punctuation">}</span>, 2 up:standby
    osd: 3 osds: 3 up, 3 <span class="token keyword">in</span>

  data:
    pools:   2 pools, 188 pgs
    objects: 22  objects, 2.2 KiB
    usage:   3.0 GiB used, 57 GiB / 60 GiB avail
    pgs:     188 active+clean</code></pre>
<p>5、 <strong>挂载使用cephfs</strong></p>
<blockquote>
<p>再客户端使用命令挂载</p>
</blockquote>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat ceph.client.admin.keyring</span>
<span class="token punctuation">[</span>client.admin<span class="token punctuation">]</span>
        key <span class="token operator">=</span> AQCcb5hi9KIrGRAA+4Pq24BCk/JgnkX7WDMiqQ<span class="token operator">==</span>
       <span class="token punctuation">..</span>.
<span class="token punctuation">[</span>root@ceph-clinet ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mount -t ceph 192.168.200.43:6789:/ /mnt -o name=admin,secret=AQCcb5hi9KIrGRAA+4Pq24BCk/JgnkX7WDMiqQ==</span>
<span class="token punctuation">[</span>root@ceph-clinet ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># df -hT</span>
Filesystem              Type      Size  Used Avail Use% Mounted on
<span class="token punctuation">..</span>.
192.168.200.43:6789:/   ceph       13G     0   13G   0% /mnt
<span class="token punctuation">[</span>root@ceph-clinet ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># umount /mnt  #取消挂载</span></code></pre>
<p>6、密钥文件挂载客户端需要安装ceph-common，否则报错</p>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-clinet ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat admin.secret</span>
AQCcb5hi9KIrGRAA+4Pq24BCk/JgnkX7WDMiqQ<span class="token operator">==</span>
<span class="token punctuation">[</span>root@ceph-clinet ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mount -t ceph 192.168.200.43:6789:/ /opt/cephfs/ -o name=admin,secret=/etc/ceph/admin.secret</span>
mount: wrong fs type, bad option, bad superblock on 192.168.200.43:6789:/,
       missing codepage or helper program, or other error

       In some cases useful info is found <span class="token keyword">in</span> syslog - try
       <span class="token function">dmesg</span> <span class="token operator">|</span> <span class="token function">tail</span> or so.</code></pre>
<p>7、使用 FUSE 挂载 CEPHFS</p>
<blockquote>
<p>ceph -fuse是挂载 CephFS 的另一种方式，尽管它挂载在用户空间。因此，FUSE 的性能可能相对较低，但 FUSE 客户端更易于管理，尤其是在升级 CephFS 时。</p>
</blockquote>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-clinet ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum install -y ceph-fuse</span>
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># scp /etc/ceph/ceph.client.admin.keyring ceph-client:/etc/ceph</span>
<span class="token punctuation">[</span>root@ceph-clinet ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mkdir /etc/cephfs &amp;&amp; ceph-fuse -m 192.168.200.43:6789 /opt/cephfs/</span>
<span class="token punctuation">[</span>root@ceph-clinet ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># df -h</span>
Filesystem               Size  Used Avail Use% Mounted on
<span class="token punctuation">..</span>.
ceph-fuse                 13G     0   13G   0% /opt/cephfs
<span class="token punctuation">[</span>root@ceph-clinet ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># umount /opt/cephfs/</span></code></pre>
<blockquote>
<p>cephfs文件系统配置使用完，给虚拟机做个快照。后面会使用。</p>
</blockquote>
<h2 id="二、块存储"><a href="#二、块存储" class="headerlink" title="二、块存储"></a>二、块存储</h2><p>1、创建存储池pool</p>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph osd pool create block_data 60</span>
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph osd lspools</span>
1 cephfs_data
2 cephfs_metadata
3 block_data</code></pre>
<p>2、创建RBD镜像，feature为layering</p>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#  rbd create myimage -s 10G --image-feature layering -p block_data</span>
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#  rbd ls -p block_data</span>
myimage
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># rbd info myimage -p block_data</span>
rbd image <span class="token string">'myimage'</span><span class="token keyword">:</span>
        size 10 GiB <span class="token keyword">in</span> 2560 objects
        order 22 <span class="token punctuation">(</span>4 MiB objects<span class="token punctuation">)</span>
        id: 108b6b8b4567
        block_name_prefix: rbd_data.108b6b8b4567
        format: 2
        features: layering
        op_features:
        flags:
        create_timestamp: Thu Jun  2 21:33:40 2022</code></pre>
<p>3、将myimage映射为块设备</p>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># rbd map myimage -p block_data</span>
/dev/rbd0
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># rbd showmapped</span>
<span class="token function">id</span> pool       image   snap device
0  block_data myimage -    /dev/rbd0

<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># lsblk</span>
NAME                        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
<span class="token punctuation">..</span>.
rbd0                        252:0    0   10G  0 disk</code></pre>
<p>4、格式化挂载使用</p>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mkfs.xfs /dev/rbd0</span>
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mount /dev/rbd0 /mnt</span>
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># df -h</span>
Filesystem               Size  Used Avail Use% Mounted on
/dev/mapper/centos-root   50G  1.6G   49G   4% /
devtmpfs                 899M     0  899M   0% /dev
tmpfs                    911M     0  911M   0% /dev/shm
tmpfs                    911M  9.6M  902M   2% /run
tmpfs                    911M     0  911M   0% /sys/fs/cgroup
/dev/sda1               1014M  142M  873M  14% /boot
/dev/mapper/centos-home   47G   33M   47G   1% /home
tmpfs                    183M     0  183M   0% /run/user/0
tmpfs                    911M   52K  911M   1% /var/lib/ceph/osd/ceph-0
/dev/rbd0                 10G   33M   10G   1% /mnt</code></pre>
<h2 id="三、对象存储"><a href="#三、对象存储" class="headerlink" title="三、对象存储"></a>三、对象存储</h2><blockquote>
<p>在使用对象存储之前，使用我们cephfs快照。（如果安装了块存储，这里的对象存储网关启动不了，原因不明。）</p>
</blockquote>
<p>1、在 ceph-1 上通过 ceph-deploy 将 ceph-radosgw 软件包安装到 ceph-1 中</p>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph-deploy install --rgw ceph-1</span></code></pre>
<p>2、创建RGW服务</p>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph-deploy rgw create ceph-1</span>
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ps -ef | grep radosgw</span>
ceph        2347       1  2 15:50 ?        00:00:00 /usr/bin/radosgw -f --cluster ceph --name client.rgw.ceph-1 --setuser ceph --setgroup ceph
root        2962    1771  0 15:51 pts/0    00:00:00 <span class="token function">grep</span> --color<span class="token operator">=</span>auto radosgw

<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># systemctl status ceph-radosgw\*</span>
● ceph-radosgw@rgw.ceph-1.service - Ceph rados gateway
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/ceph-radosgw@.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Fri 2022-06-03 15:50:45 CST<span class="token punctuation">;</span> 31s ago
 Main PID: 2347 <span class="token punctuation">(</span>radosgw<span class="token punctuation">)</span>
   CGroup: /system.slice/system-ceph\x2dradosgw.slice/ceph-radosgw@rgw.ceph-1.service
           └─2347 /usr/bin/radosgw -f --cluster ceph --name client.rgw.ceph-1 --setuser ceph --setgroup ceph

Jun 03 15:50:45 ceph-1 systemd<span class="token punctuation">[</span>1<span class="token punctuation">]</span>: Started Ceph rados gateway.
Jun 03 15:50:45 ceph-1 systemd<span class="token punctuation">[</span>1<span class="token punctuation">]</span>: Starting Ceph rados gateway<span class="token punctuation">..</span>.</code></pre>
<p>3、访问RGW</p>
<blockquote>
<p>RGW默认端口 7480</p>
</blockquote>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum install -y net-tools</span>
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># netstat -tnplu</span>
Active Internet connections <span class="token punctuation">(</span>only servers<span class="token punctuation">)</span>
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
<span class="token punctuation">..</span>.
tcp        0      0 0.0.0.0:7480            0.0.0.0:*               LISTEN      2347/radosgw</code></pre>
<p>浏览器访问<a href="http://192.168.200.43:7480/" target="_blank" rel="noopener">http://192.168.200.43:7480/</a><br><img src="../../../../blogimgv2022/417588d72b0a425dadfa0c6a3ae7ff55.png" alt="在这里插入图片描述"></p>
<h3 id="使用-S3-访问-RGW"><a href="#使用-S3-访问-RGW" class="headerlink" title="使用 S3 访问 RGW"></a>使用 S3 访问 RGW</h3><p>1、创建 s3 的兼容用户</p>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># radosgw-admin user create --uid ceph-s3-user --display-name "Ceph S3 User Demo"</span>
<span class="token punctuation">..</span>.
    <span class="token string">"keys"</span><span class="token keyword">:</span> <span class="token punctuation">[</span> 
        <span class="token punctuation">{</span> 
            <span class="token string">"user"</span><span class="token keyword">:</span> <span class="token string">"ceph-s3-user"</span>, 
            <span class="token string">"access_key"</span><span class="token keyword">:</span> <span class="token string">"V3J9L4M1WKV5O5ECAKPU"</span>, 
           <span class="token string">"secret_key"</span><span class="token keyword">:</span><span class="token string">"f5LqLVYOVNu38cuQwi0jXC2ZTboCSJDmdvB8oeYw"</span> 
  <span class="token punctuation">..</span>.
        <span class="token punctuation">}</span> </code></pre>
<blockquote>
<p>access_key 与 secret_key 这里可以记录一下，也可以使用命令再次查看。</p>
</blockquote>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># radosgw-admin user info --uid ceph-s3-user </span></code></pre>
<h3 id="使用命令行方式操作-rgw"><a href="#使用命令行方式操作-rgw" class="headerlink" title="使用命令行方式操作 rgw"></a>使用命令行方式操作 rgw</h3><p>1、配置命令行工具</p>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum -y install s3cmd </span>
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># s3cmd --configure</span>

Enter new values or accept defaults <span class="token keyword">in</span> brackets with Enter.
Refer to user manual <span class="token keyword">for</span> detailed description of all options.

Access key and Secret key are your identifiers <span class="token keyword">for</span> Amazon S3. Leave them empty <span class="token keyword">for</span> using the <span class="token function">env</span> variables.
Access Key: 82EWM49KPWGFVR0CWSD4  <span class="token comment" spellcheck="true">#输入用户Access </span>
Secret Key: 129CSMM9Dk3CC1lZwM7kn75lXMhrWBAMPEuyJL5k <span class="token comment" spellcheck="true">##输入用户Secret </span>
Default Region <span class="token punctuation">[</span>US<span class="token punctuation">]</span>: <span class="token comment" spellcheck="true">#默认回车</span>

Use <span class="token string">"s3.amazonaws.com"</span> <span class="token keyword">for</span> S3 Endpoint and not modify it to the target Amazon S3.
S3 Endpoint <span class="token punctuation">[</span>s3.amazonaws.com<span class="token punctuation">]</span>: 192.168.200.43:7480  <span class="token comment" spellcheck="true">#输入Rgw服务地址</span>

Use <span class="token string">"%(bucket)s.s3.amazonaws.com"</span> to the target Amazon S3. <span class="token string">"%(bucket)s"</span> and <span class="token string">"%(location)s"</span> vars can be used
<span class="token keyword">if</span> the target S3 system supports dns based buckets.
DNS-style bucket+hostname:port template <span class="token keyword">for</span> accessing a bucket <span class="token punctuation">[</span>%<span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>s.s3.amazonaws.com<span class="token punctuation">]</span>: 192.168.200.43:7480/%<span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>s  <span class="token comment" spellcheck="true">#输入</span>

Encryption password is used to protect your files from reading
by unauthorized persons <span class="token keyword">while</span> <span class="token keyword">in</span> transfer to S3
Encryption password:  <span class="token comment" spellcheck="true">##默认回车</span>
Path to GPG program <span class="token punctuation">[</span>/usr/bin/gpg<span class="token punctuation">]</span>: <span class="token comment" spellcheck="true">##默认回车</span>

When using secure HTTPS protocol all communication with Amazon S3
servers is protected from 3rd party eavesdropping. This method is
slower than plain HTTP, and can only be proxied with Python 2.7 or newer
Use HTTPS protocol <span class="token punctuation">[</span>Yes<span class="token punctuation">]</span>: no  <span class="token comment" spellcheck="true">#输入no</span>

On some networks all internet access must go through a HTTP proxy.
Try setting it here <span class="token keyword">if</span> you can<span class="token string">'t connect to S3 directly
HTTP Proxy server name:   

New settings:
  Access Key: 82EWM49KPWGFVR0CWSD4
  Secret Key: 129CSMM9Dk3CC1lZwM7kn75lXMhrWBAMPEuyJL5k
  Default Region: US
  S3 Endpoint: 192.168.200.43:7480  ##输入Rgw服务地址
  DNS-style bucket+hostname:port template for accessing a bucket: 192.168.200.43:7480/%(bucket)s
  Encryption password:  
  Path to GPG program: /usr/bin/gpg
  Use HTTPS protocol: False
  HTTP Proxy server name: 
  HTTP Proxy server port: 0

Test access with supplied credentials? [Y/n] y  #输入y
Please wait, attempting to list all buckets...
Success. Your access key and secret key worked fine :-)

Now verifying that encryption works...
Not configured. Never mind.

Save settings? [y/N] y  #输入y
Configuration saved to '</span>/root/.s3cfg'</code></pre>
<p>2、这是需要修改版本，启用v2版本即可</p>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># s3cmd mb s3://s3cmd-demo</span>
ERROR: S3 error: 403 <span class="token punctuation">(</span>SignatureDoesNotMatch<span class="token punctuation">)</span>
<span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># sed -i '/signature_v2/s/False/True/g' /root/.s3cfg</span></code></pre>
<p>3、创建</p>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># s3cmd mb s3://s3cmd-demo</span>
Bucket <span class="token string">'s3://s3cmd-demo/'</span> created</code></pre>
<p>4、上传</p>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># s3cmd put /etc/fstab s3://s3cmd-demo/fatab-demo</span>
upload: <span class="token string">'/etc/fstab'</span> -<span class="token operator">></span> <span class="token string">'s3://s3cmd-demo/fatab-demo'</span>  <span class="token punctuation">[</span>1 of 1<span class="token punctuation">]</span>
 541 of 541   100% <span class="token keyword">in</span>    1s   327.08 B/s  <span class="token keyword">done</span></code></pre>
<p>5、下载</p>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># s3cmd get s3://s3cmd-demo/fatab-demo</span>
download: <span class="token string">'s3://s3cmd-demo/fatab-demo'</span> -<span class="token operator">></span> <span class="token string">'./fatab-demo'</span>  <span class="token punctuation">[</span>1 of 1<span class="token punctuation">]</span>
 541 of 541   100% <span class="token keyword">in</span>    0s    39.79 KB/s  <span class="token keyword">done</span></code></pre>
<p>6、删除</p>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-1 ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># s3cmd del s3://s3cmd-demo/fatab-demo</span>
delete: <span class="token string">'s3://s3cmd-demo/fatab-demo'</span></code></pre>
<h1 id="K8s-provision-对接Ceph存储"><a href="#K8s-provision-对接Ceph存储" class="headerlink" title="K8s-provision 对接Ceph存储"></a>K8s-provision 对接Ceph存储</h1><h3 id="CephRBD"><a href="#CephRBD" class="headerlink" title="CephRBD"></a>CephRBD</h3><h4 id="配置-rbd-provisioner"><a href="#配置-rbd-provisioner" class="headerlink" title="配置 rbd-provisioner"></a>配置 rbd-provisioner</h4><pre class=" language-yaml"><code class="language-yaml">cat <span class="token punctuation">></span>external<span class="token punctuation">-</span>storage<span class="token punctuation">-</span>rbd<span class="token punctuation">-</span>provisioner.yaml&lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rbd<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system

<span class="token punctuation">---</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rbd<span class="token punctuation">-</span>provisioner
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"persistentvolumes"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"delete"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"persistentvolumeclaims"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"storage.k8s.io"</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"storageclasses"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"events"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"endpoints"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"services"</span><span class="token punctuation">]</span>
    <span class="token key atrule">resourceNames</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"kube-dns"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"get"</span><span class="token punctuation">]</span>

<span class="token punctuation">---</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rbd<span class="token punctuation">-</span>provisioner
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
    <span class="token key atrule">name</span><span class="token punctuation">:</span> rbd<span class="token punctuation">-</span>provisioner
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rbd<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io

<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rbd<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"secrets"</span><span class="token punctuation">]</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">]</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rbd<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rbd<span class="token punctuation">-</span>provisioner
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rbd<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system

<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rbd<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> rbd<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> rbd<span class="token punctuation">-</span>provisioner
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rbd<span class="token punctuation">-</span>provisioner
        <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">"quay.io/external_storage/rbd-provisioner:v2.0.0-k8s1.11"</span>
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROVISIONER_NAME
          <span class="token key atrule">value</span><span class="token punctuation">:</span> ceph.com/rbd
      <span class="token key atrule">serviceAccount</span><span class="token punctuation">:</span> rbd<span class="token punctuation">-</span>provisioner
EOF
kubectl apply <span class="token punctuation">-</span>f external<span class="token punctuation">-</span>storage<span class="token punctuation">-</span>rbd<span class="token punctuation">-</span>provisioner.yaml
<span class="token comment" spellcheck="true"># 查看状态 等待running之后 再进行后续的操作</span>
kubectl get pod <span class="token punctuation">-</span>n kube<span class="token punctuation">-</span>system</code></pre>
<h4 id="配置StorageClass"><a href="#配置StorageClass" class="headerlink" title="配置StorageClass"></a>配置StorageClass</h4><pre><code>1、创建pod时，kubelet需要使用rbd命令去检测和挂载pv对应的ceph image，所以要在所有的worker节点安装ceph客户端ceph-common。
将ceph的ceph.client.admin.keyring和ceph.conf文件拷贝到master的/etc/ceph目录下
yum -y install ceph-common
2、创建 osd pool 在ceph的mon或者admin节点
ceph osd pool create kube 128 128  
ceph osd pool ls
3、创建k8s访问ceph的用户 在ceph的mon或者admin节点
ceph auth get-or-create client.kube mon &#39;allow r&#39; osd &#39;allow class-read object_prefix rbd_children, allow rwx pool=kube&#39; -o ceph.client.kube.keyring
4、查看key 在ceph的mon或者admin节点
ceph auth get-key client.admin
ceph auth get-key client.kube
5、创建 admin secret
kubectl create secret generic ceph-secret --type=&quot;kubernetes.io/rbd&quot; \
--from-literal=key=AQCtovZdgFEhARAAoKhLtquAyM8ROvmBv55Jig== \
--namespace=kube-system
6、在 default 命名空间创建pvc用于访问ceph的 secret
kubectl create secret generic ceph-user-secret --type=&quot;kubernetes.io/rbd&quot; \
--from-literal=key=AQAM9PxdEFi3AhAAzvvhuyk1AfN5twlY+4zNMA== \
--namespace=default</code></pre><pre class=" language-yaml"><code class="language-yaml">cat <span class="token punctuation">></span>storageclass<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>rdb.yaml&lt;&lt;EOF
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dynamic<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>rdb
<span class="token key atrule">provisioner</span><span class="token punctuation">:</span> ceph.com/rbd
<span class="token key atrule">parameters</span><span class="token punctuation">:</span>
  <span class="token key atrule">monitors</span><span class="token punctuation">:</span> 192.168.0.201<span class="token punctuation">:</span><span class="token number">6789</span><span class="token punctuation">,</span>192.168.0.202<span class="token punctuation">:</span><span class="token number">6789</span><span class="token punctuation">,</span>192.168.0.203<span class="token punctuation">:</span><span class="token number">6789</span>
  <span class="token key atrule">adminId</span><span class="token punctuation">:</span> admin
  <span class="token key atrule">adminSecretName</span><span class="token punctuation">:</span> ceph<span class="token punctuation">-</span>secret
  <span class="token key atrule">adminSecretNamespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">pool</span><span class="token punctuation">:</span> kube
  <span class="token key atrule">userId</span><span class="token punctuation">:</span> kube
  <span class="token key atrule">userSecretName</span><span class="token punctuation">:</span> ceph<span class="token punctuation">-</span>user<span class="token punctuation">-</span>secret
  <span class="token key atrule">fsType</span><span class="token punctuation">:</span> ext4
  <span class="token key atrule">imageFormat</span><span class="token punctuation">:</span> <span class="token string">"2"</span>
  <span class="token key atrule">imageFeatures</span><span class="token punctuation">:</span> <span class="token string">"layering"</span>
EOF</code></pre>
<pre><code>kubectl apply -f storageclass-ceph-rdb.yaml  
kubectl get storageclasses </code></pre><h4 id="声明使用PVC"><a href="#声明使用PVC" class="headerlink" title="声明使用PVC"></a>声明使用PVC</h4><pre><code>cat &gt;ceph-rdb-pvc-test.yaml&lt;&lt;EOF
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: ceph-rdb-claim
spec:
  accessModes:     
    - ReadWriteOnce
  storageClassName: dynamic-ceph-rdb
  resources:
    requests:
      storage: 2Gi
EOF
kubectl apply -f ceph-rdb-pvc-test.yaml</code></pre><h4 id="应用声明使用PVC"><a href="#应用声明使用PVC" class="headerlink" title="应用声明使用PVC"></a>应用声明使用PVC</h4><pre><code>cat &gt;nginx-pod.yaml&lt;&lt;EOF
apiVersion: v1
kind: Pod
metadata:
  name: nginx-pod1
  labels:
    name: nginx-pod1
spec:
  containers:
  - name: nginx-pod1
    image: nginx:alpine
    ports:
    - name: web
      containerPort: 80
    volumeMounts:
    - name: ceph-rdb
      mountPath: /usr/share/nginx/html
  volumes:
  - name: ceph-rdb
    persistentVolumeClaim:
      claimName: ceph-rdb-claim
EOF
kubectl apply -f nginx-pod.yaml</code></pre><h3 id="CephFS"><a href="#CephFS" class="headerlink" title="CephFS"></a>CephFS</h3><pre><code># 在cephfs 的 mon或者admin节点
ceph osd pool create fs_data 128
ceph osd pool create fs_metadata 128
ceph osd lspools

# 创建cephfs 文件系统
ceph fs new cephfs fs_metadata fs_data
ceph fs ls</code></pre><h4 id="配置-ceph-fs-provisioner"><a href="#配置-ceph-fs-provisioner" class="headerlink" title="配置 ceph-fs-provisioner"></a>配置 ceph-fs-provisioner</h4><pre class=" language-yaml"><code class="language-yaml">cat <span class="token punctuation">></span>external<span class="token punctuation">-</span>storage<span class="token punctuation">-</span>cephfs<span class="token punctuation">-</span>provisioner.yaml&lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> cephfs
   <span class="token key atrule">labels</span><span class="token punctuation">:</span>
     <span class="token key atrule">name</span><span class="token punctuation">:</span> cephfs

<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cephfs<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> cephfs

<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cephfs<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> cephfs
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"secrets"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"delete"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"endpoints"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span><span class="token punctuation">]</span>

<span class="token punctuation">---</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cephfs<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> cephfs
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"persistentvolumes"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"delete"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"persistentvolumeclaims"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"storage.k8s.io"</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"storageclasses"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"events"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"services"</span><span class="token punctuation">]</span>
    <span class="token key atrule">resourceNames</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"kube-dns"</span><span class="token punctuation">,</span><span class="token string">"coredns"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"get"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"secrets"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"delete"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"policy"</span><span class="token punctuation">]</span>
    <span class="token key atrule">resourceNames</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"cephfs-provisioner"</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"podsecuritypolicies"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"use"</span><span class="token punctuation">]</span>

<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cephfs<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> cephfs
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cephfs<span class="token punctuation">-</span>provisioner
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cephfs<span class="token punctuation">-</span>provisioner

<span class="token punctuation">---</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cephfs<span class="token punctuation">-</span>provisioner
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cephfs<span class="token punctuation">-</span>provisioner
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> cephfs
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cephfs<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io

<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cephfs<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> cephfs
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> cephfs<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> cephfs<span class="token punctuation">-</span>provisioner
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cephfs<span class="token punctuation">-</span>provisioner
        <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">"quay.io/external_storage/cephfs-provisioner:latest"</span>
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROVISIONER_NAME
          <span class="token key atrule">value</span><span class="token punctuation">:</span> ceph.com/cephfs
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token string">"/usr/local/bin/cephfs-provisioner"</span>
        <span class="token key atrule">args</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token string">"-id=cephfs-provisioner-1"</span>
        <span class="token punctuation">-</span> <span class="token string">"-disable-ceph-namespace-isolation=true"</span>
      <span class="token key atrule">serviceAccount</span><span class="token punctuation">:</span> cephfs<span class="token punctuation">-</span>provisioner
EOF
kubectl apply <span class="token punctuation">-</span>f external<span class="token punctuation">-</span>storage<span class="token punctuation">-</span>cephfs<span class="token punctuation">-</span>provisioner.yaml</code></pre>
<h4 id="配置storageclass"><a href="#配置storageclass" class="headerlink" title="配置storageclass"></a>配置storageclass</h4><pre class=" language-yaml"><code class="language-yaml">cat <span class="token punctuation">></span>storageclass<span class="token punctuation">-</span>cephfs.yaml&lt;&lt;EOF
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dynamic<span class="token punctuation">-</span>cephfs
<span class="token key atrule">provisioner</span><span class="token punctuation">:</span> ceph.com/cephfs
<span class="token key atrule">parameters</span><span class="token punctuation">:</span>
    <span class="token key atrule">monitors</span><span class="token punctuation">:</span> 192.168.0.101<span class="token punctuation">:</span><span class="token number">6789</span><span class="token punctuation">,</span>192.168.0.102<span class="token punctuation">:</span><span class="token number">6789</span><span class="token punctuation">,</span>192.168.0.103<span class="token punctuation">:</span><span class="token number">6789</span>
    <span class="token key atrule">adminId</span><span class="token punctuation">:</span> admin
    <span class="token key atrule">adminSecretName</span><span class="token punctuation">:</span> ceph<span class="token punctuation">-</span>secret
    <span class="token key atrule">adminSecretNamespace</span><span class="token punctuation">:</span> <span class="token string">"kube-system"</span>
    <span class="token key atrule">claimRoot</span><span class="token punctuation">:</span> /volumes/kubernetes
EOF</code></pre>
<h4 id="创建pvc"><a href="#创建pvc" class="headerlink" title="创建pvc"></a>创建pvc</h4><pre class=" language-yaml"><code class="language-yaml">cat <span class="token punctuation">></span>cephfs<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>test.yaml&lt;&lt;EOF
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cephfs<span class="token punctuation">-</span>claim
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>     
    <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> dynamic<span class="token punctuation">-</span>cephfs
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 2Gi
EOF
kubectl apply <span class="token punctuation">-</span>f cephfs<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>test.yaml</code></pre>
<h4 id="用户声明使用pvc"><a href="#用户声明使用pvc" class="headerlink" title="用户声明使用pvc"></a>用户声明使用pvc</h4><pre class=" language-yaml"><code class="language-yaml">cat <span class="token punctuation">></span>nginx<span class="token punctuation">-</span>pod.yaml&lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod2
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod2
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod2
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> web
      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cephfs
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cephfs
    <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
      <span class="token key atrule">claimName</span><span class="token punctuation">:</span> cephfs<span class="token punctuation">-</span>claim
EOF
kubectl apply <span class="token punctuation">-</span>f nginx<span class="token punctuation">-</span>pod.yaml</code></pre>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://docs.ceph.com/en/latest/" target="_blank" rel="noopener">https://docs.ceph.com/en/latest/</a></li>
<li>From：<a href="https://bbs.huaweicloud.com/blogs/358172" target="_blank" rel="noopener">https://bbs.huaweicloud.com/blogs/358172</a></li>
<li>Ceph 和K8s 存储对接：<a href="https://blog.jairmir.com/index.php/2021/03/27/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8ceph%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E5%AE%9E%E6%88%98/#1PVPVC" target="_blank" rel="noopener">https://blog.jairmir.com/index.php/2021/03/27/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8ceph%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E5%AE%9E%E6%88%98/#1PVPVC</a></li>
<li>Ceph 和K8s 存储对接 <a href="https://www.cnblogs.com/lvzhenjiang/p/15377425.html" target="_blank" rel="noopener">https://www.cnblogs.com/lvzhenjiang/p/15377425.html</a></li>
</ul>

            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://liudongdong1.github.io" rel="external nofollow noreferrer">liudongdong1</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://liudongdong1.github.io/2022/07/24/cun-chu-she-ji/xu-ni-hua-ji-zhu/kubernetes-cun-chu-ceph/">https://liudongdong1.github.io/2022/07/24/cun-chu-she-ji/xu-ni-hua-ji-zhu/kubernetes-cun-chu-ceph/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint polocy. If reproduced, please indicate source
                    <a href="https://liudongdong1.github.io" target="_blank">liudongdong1</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Storage/">
                                    <span class="chip bg-color">Storage</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq,qzone,wechat,weibo,douban" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2022/07/25/kuang-jia-she-ji/middleware/rpc/rpc-kuang-jia-mercury/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/19.jpg" class="responsive-img" alt="rpc框架-mercury">
                        
                        <span class="card-title">rpc框架-mercury</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
Mercury is a Remote Procedure Call (RPC) framework specifically designed for use in High-Performance Computing (HPC) sy
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-07-25
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%AF%AD%E8%A8%80%E6%A1%86%E6%9E%B6/" class="post-category">
                                    语言框架
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Framework/">
                        <span class="chip bg-color">Framework</span>
                    </a>
                    
                    <a href="/tags/middleware/">
                        <span class="chip bg-color">middleware</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/07/23/bian-cheng-yu-yan/c-yu-yan/bing-fa-bian-cheng/argobots/">
                    <div class="card-image">
                        
                        <img src="https://gitee.com/github-25970295/blogImage/raw/master/img/30.jpeg" class="responsive-img" alt="argobots">
                        
                        <span class="card-title">argobots</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
  d686cb0a25b96ced5ce99713a9124a673d062885ac16e110c2f41953e478773bbfd33b98b34a863d306739e60fffd289fe61ebfbe2a460307c9e3
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-07-23
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%AF%AD%E8%A8%80%E6%A1%86%E6%9E%B6/" class="post-category">
                                    语言框架
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/c/">
                        <span class="chip bg-color">c</span>
                    </a>
                    
                    <a href="/tags/%E5%B9%B6%E5%8F%91/">
                        <span class="chip bg-color">并发</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <!-- <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="463294659"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2019</span>
            <a href="https://liudongdong1.github.io" target="_blank">liudongdong</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">1314.9k</span>&nbsp;字
            
            
            
            
            
            
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/liudongdong1/" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:3463264078@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>














    <a href="https://blog.csdn.net/liudongdong19/" class="tooltipped" target="_blank" data-tooltip="关注我的CSDN: https://blog.csdn.net/liudongdong19/" data-position="top" data-delay="50">
        <i class="fab fa-csdn">C</i>
    </a>





</div>
    </div>
</footer>

<div class="progress-bar"></div>
 -->

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script type="text/javascript" src="/js/CFS.Snow.min.js"></script>
    <!-- 点击爆灯效果 -->
    <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
    <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
    <script type="text/javascript" src="/js/fireworks.js"></script>
    <!--动态线条背景-->
    <script type="text/javascript"
        color="122 103 238" opacity='0.7' zIndex="-2" count="200" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
    </script>
    <!-- 天气 -->
    <!-- weather -->
    <!-- weather -->
    <script type="text/javascript">
         WIDGET = {FID: 'knAMQaFanP'}
    </script>
    <script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script>
    <script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script>
    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    

    
    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon-refresh.min.js" async="async"></script>
    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    
    <!-- {% include '_custom/custom.swig' %} -->

</body>

</html>
