<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Socket, AIOT,Space&amp;Temporal Sequence Analysis,SpringBoot,liudongdong1,cloud">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Socket | DaybyDay</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="DaybyDay" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">DaybyDay</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">

      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>About</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/about">
          
          <i class="fas fa-user-circle" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>about</span>
        </a>
      </li>
      
      <li>
        <a href="/resume">
          
          <i class="fa fa-user-secret" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>resume</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/gallery" class="waves-effect waves-light">
      
      <i class="fas fa-camera" style="zoom: 0.6;"></i>
      
      <span>Galleries</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">DaybyDay</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-user-circle"></i>
			
			About
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/about " style="margin-left:75px">
				  
				   <i class="fa fas fa-user-circle" style="position: absolute;left:50px" ></i>
			      
		          <span>about</span>
                  </a>
                </li>
              
                <li>

                  <a href="/resume " style="margin-left:75px">
				  
				   <i class="fa fa fa-user-secret" style="position: absolute;left:50px" ></i>
			      
		          <span>resume</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/gallery" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-camera"></i>
			
			Galleries
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/liudongdong1" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/liudongdong1" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://gitee.com/github-25970295/blogImage/raw/master/img/20210510110733.png')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Socket</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    .toc-fixed .toc-link::before{
        position: fixed!important;/*当toc的位置改为fixed时，.toc-link::before也要改为fixed*/
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/python/">
                                <span class="chip bg-color">python</span>
                            </a>
                        
                            <a href="/tags/socket/">
                                <span class="chip bg-color">socket</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E8%AF%AD%E8%A8%80%E6%A1%86%E6%9E%B6/" class="post-category">
                                语言框架
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2021-05-10
                </div>
                

                <!-- 
                    <i class="fa fa-pencil"></i> Author: liudongdong1
                  -->

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>Update Date:&nbsp;&nbsp;
                    2021-12-21
                </div>
                

                <!-- 
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>Word Count:&nbsp;&nbsp;
                    6.7k
                </div>
                 -->

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>Read Times:&nbsp;&nbsp;
                    32 Min
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>Read Count:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <blockquote>
<p>socket屏蔽了各个协议的通信细节，使得程序员无需关注协议本身，直接使用socket提供的接口来进行互联的不同主机间的进程的通信。</p>
</blockquote>
<p><img src="https://gitee.com/github-25970295/blogImage/raw/master/img/20210510111010.png" alt=""></p>
<h3 id="1-API"><a href="#1-API" class="headerlink" title="1.API"></a>1.API</h3><h4 id="1-socket-接口"><a href="#1-socket-接口" class="headerlink" title=".1.  socket 接口"></a>.1.  socket 接口</h4><blockquote>
<p>int socket(int protofamily, int so_type, int protocol);</p>
</blockquote>
<ul>
<li><p>protofamily 指协议族，常见的值有：</p>
<p>AF_INET，指定so_pcb中的地址要采用ipv4地址类型</p>
<p>AF_INET6，指定so_pcb中的地址要采用ipv6的地址类型</p>
<p>AF_LOCAL/AF_UNIX，指定so_pcb中的地址要使用绝对路径名</p>
<p>当然也还有其他的协议族，用到再学习了</p>
</li>
<li><p>so_type 指定socket的类型，也就是上面讲到的so_type字段，比较常用的类型有：</p>
<p>SOCK_STREAM:对应tcp</p>
<p>SOCK_DGRAM：对应udp</p>
<p>SOCK_RAW：自定义协议或者直接对应ip层</p>
</li>
<li><p>protocol 指定具体的协议，也就是指定本次通信能接受的数据包的类型和发送数据包的类型，常见的值有：</p>
<p>IPPROTO_TCP，TCP协议</p>
<p>IPPROTO_UDP，UPD协议</p>
<p>0，如果指定为0，表示由内核根据so_type指定默认的通信协议</p>
</li>
</ul>
<p><img src="https://gitee.com/github-25970295/blogImage/raw/master/img/20210510111221.png" alt=""></p>
<blockquote>
<p>int bind(int sockfd, const struct sockaddr *addr, socklen_t addrlen);</p>
</blockquote>
<p>bind函数就是给图三种so_pcb结构中的地址赋值的接口</p>
<ul>
<li>sockfd 是调用socket()函数创建的socket描述符</li>
<li>addr 是具体的地址</li>
<li>addrlen 表示addr的长度</li>
</ul>
<p>举struct sockaddr其实是void的typedef，其常见的结构如下图（图片来源传智播客邢文鹏linux系统编程的笔记），这也是为什么需要addrlen参数的原因，不同的地址类型，其地址长度不一样：</p>
<p><img src="https://img2018.cnblogs.com/blog/988061/201809/988061-20180904170327305-518430882.png" alt=""></p>
<blockquote>
<p>int connect(int sockfd, const struct sockaddr *addr, socklen_t addrlen);</p>
</blockquote>
<p>这三个参数和bind的三个参数类型一直，只不过此处strcut sockaddr表示对端公开的地址。三个参数都是传入参数。connect顾名思义就是拿来建立连接的函数，只有像tcp这样面向连接、提供可靠服务的协议才需要建立连接</p>
<blockquote>
<p>int listen(int sockfd, int backlog)</p>
</blockquote>
<p>告知内核在sockfd这个描述符上监听是否有连接到来，并设置同时能完成的最大连接数为backlog当调用listen后，内核就会建立两个队列，一个SYN队列，表示接受到请求，但未完成三次握手的连接；另一个是ACCEPT队列，表示已经完成了三次握手的队列</p>
<ul>
<li>sockfd 是调用socket()函数创建的socket描述符</li>
<li>backlog 已经完成三次握手而等待accept的连接数</li>
</ul>
<p>关于backlog , man listen的描述如下：</p>
<ul>
<li>The behavior of the backlog argument on TCP sockets changed with Linux 2.2. Now it specifies the queue length for completely established sockets waiting to be accepted, instead of the number of incomplete connection requests. The maximum length of the queue for incomplete sockets can be set using /proc/sys/net/ipv4/tcp_max_syn_backlog. When syncookies are enabled there is no logical maximum length and this setting is ignored. See tcp(7) for more information.翻译：TCP套接字上的积压参数的行为随着Linux 2.2而改变。现在，它指定等待被接受的完全建立的套接字的队列长度，而不是不完整连接请求的数量。不完整套接字队列的最大长度可以使用/PRO/sys／NET/IPv4/TCPPMAX Syth-ByLoSQL来设置。当启用同步功能时，没有逻辑最大长度，并且忽略该设置。有关更多信息，请参见TCP（7）。</li>
<li>If the backlog argument is greater than the value in /proc/sys/net/core/somaxconn, then it is silently truncated to that value; the default value in this file is 128. In kernels before 2.4.25, this limit was a hard coded value, SOMAXCONN, with the value 128.如果backlog参数大于/proc/sys/net/core/somaxconn中的值，那么它将被悄悄地截断为该值；该文件中的默认值为128。在2.4.25之前的内核中，这个限制是一个硬编码的值，SOMAXCONN，值为128。</li>
</ul>
<blockquote>
<p>accept接口</p>
</blockquote>
<p>int accept(int listen_sockfd, struct sockaddr *addr, socklen_t *addrlen)</p>
<p>这三个参数与bind的三个参数含义一致，不过，此处的后两个参数是传出参数。在使用listen函数告知内核监听的描述符后，内核就会建立两个队列，一个SYN队列，表示接受到请求，但未完成三次握手的连接；另一个是ACCEPT队列，表示已经完成了三次握手的队列。而accept函数就是从ACCEPT队列中拿一个连接，并生成一个新的描述符，新的描述符所指向的结构体so_pcb中的请求端ip地址、请求端端口将被初始化。</p>
<p><img src="https://gitee.com/github-25970295/blogImage/raw/master/img/20210510111521.png" alt=""></p>
<blockquote>
<ol>
<li>服务器端在调用listen之后，内核会建立两个队列，SYN队列和ACCEPT队列，其中ACCPET队列的长度由backlog指定。</li>
<li>服务器端在调用accpet之后，将阻塞，等待ACCPT队列有元素。</li>
<li>客户端在调用connect之后，将开始发起SYN请求，请求与服务器建立连接，此时称为第一次握手。</li>
<li>服务器端在接受到SYN请求之后，把请求方放入SYN队列中，并给客户端回复一个确认帧ACK，此帧还会携带一个请求与客户端建立连接的请求标志，也就是SYN，这称为第二次握手</li>
<li>客户端收到SYN+ACK帧后，connect返回，并发送确认建立连接帧ACK给服务器端。这称为第三次握手</li>
<li>服务器端收到ACK帧后，会把请求方从SYN队列中移出，放至ACCEPT队列中，而accept函数也等到了自己的资源，从阻塞中唤醒，从ACCEPT队列中取出请求方，重新建立一个新的sockfd，并返回。</li>
</ol>
</blockquote>
<ul>
<li>TCP: <ul>
<li>send函数只负责将数据提交给协议层。 当调用该函数时，send先比较待发送数据的长度len和套接字s的发送缓冲区的长度，如果len大于s的发送缓冲区的长度，该函数返回SOCKET_ERROR； 如果len小于或者等于s的发送缓冲区的长度，那么send先检查协议是否正在发送s的发送缓冲中的数据； 如果是就等待协议把数据发送完，如果协议还没有开始发送s的发送缓冲中的数据或者s的发送缓冲中没有数据，那么send就比较s的发送缓冲区的剩余空间和len； 如果len大于剩余空间大小，send就一直等待协议把s的发送缓冲中的数据发送完，如果len小于剩余空间大小，send就仅仅把buf中的数据copy到剩余空间里（注意并不是send把s的发送缓冲中的数据传到连接的另一端的，而是协议传的，send仅仅是把buf中的数据copy到s的发送缓冲区的剩余空间里）。 如果send函数copy数据成功，就返回实际copy的字节数，如果send在copy数据时出现错误，那么send就返回SOCKET_ERROR； 如果send在等待协议传送数据时网络断开的话，那么send函数也返回SOCKET_ERROR。要注意send函数把buf中的数据成功copy到s的发送缓冲的剩余空间里后它就返回了，但是此时这些数据并不一定马上被传到连接的另一端。 如果协议在后续的传送过程中出现网络错误的话，那么下一个Socket函数就会返回SOCKET_ERROR。（每一个除send外的Socket函数在执行的最开始总要先等待套接字的发送缓冲中的数据被协议传送完毕才能继续，如果在等待时出现网络错误，那么该Socket函数就返回SOCKET_ERROR）</li>
<li>recv先检查套接字s的接收缓冲区，如果s接收缓冲区中没有数据或者协议正在接收数据，那么recv就一直等待，直到协议把数据接收完毕。当协议把数据接收完毕，recv函数就把s的接收缓冲中的数据copy到buf中（注意协议接收到的数据可能大于buf的长度，所以在这种情况下要调用几次recv函数才能把s的接收缓冲中的数据copy完。recv函数仅仅是copy数据，真正的接收数据是协议来完成的），recv函数返回其实际copy的字节数。如果recv在copy时出错，那么它返回SOCKET_ERROR；如果recv函数在等待协议接收数据时网络中断了，那么它返回0 。对方优雅的关闭socket并不影响本地recv的正常接收数据；如果协议缓冲区内没有数据，recv返回0，指示对方关闭；如果协议缓冲区有数据，则返回对应数据(可能需要多次recv)，在最后一次recv时，返回0，指示对方关闭。</li>
</ul>
</li>
</ul>
<h3 id="2-python"><a href="#2-python" class="headerlink" title="2. python"></a>2. python</h3><h4 id="2-1-多线程基本结构"><a href="#2-1-多线程基本结构" class="headerlink" title="2.1. 多线程基本结构"></a>2.1. 多线程基本结构</h4><ul>
<li>服务器代码</li>
</ul>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!C:\Python3.6.5\python.exe</span>
<span class="token comment" spellcheck="true"># -*- coding: gbk -*-</span>

<span class="token keyword">import</span> socket
<span class="token keyword">import</span> threading

<span class="token keyword">class</span> <span class="token class-name">WSGIServer</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""初始化对象"""</span>
        <span class="token comment" spellcheck="true"># 创建套接字</span>
        self<span class="token punctuation">.</span>tcp_server_socket <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># 解决程序端口占用问题</span>
        self<span class="token punctuation">.</span>tcp_server_socket<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># 绑定本地ip地址</span>
        self<span class="token punctuation">.</span>tcp_server_socket<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># 将套接字变为监听套接字，最大连接数量为100</span>
        self<span class="token punctuation">.</span>tcp_server_socket<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">run_forever</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""设备连接"""</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true"># 1.等待设备连接(通过ip地址和端口建立tcp连接)</span>
            <span class="token comment" spellcheck="true">#   如果有设备连接，则会生成用于设备和服务器通讯的套接字：new_socket</span>
            <span class="token comment" spellcheck="true">#   会获取到设备的ip地址和端口</span>
            new_socket<span class="token punctuation">,</span> client_addr <span class="token operator">=</span> self<span class="token punctuation">.</span>tcp_server_socket<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"设备{0}已连接"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>client_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token comment" spellcheck="true"># 2.创建线程处理设备的需求</span>
            t1 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>self<span class="token punctuation">.</span>service_machine<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>new_socket<span class="token punctuation">,</span> client_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
            t1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">service_machine</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> new_socket<span class="token punctuation">,</span> client_addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""业务处理"""</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true"># 3.接收设备发送的数据，单次最大1024字节，按‘gbk’格式解码</span>
            receive_data <span class="token operator">=</span> new_socket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"gbk"</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true"># 4.如果设备发送的数据不为空</span>
            <span class="token keyword">if</span> receive_data<span class="token punctuation">:</span>
                <span class="token comment" spellcheck="true"># 4.1 打印接收的数据，这里可以将设备发送的数据写入到文件中</span>
                <span class="token comment" spellcheck="true"># 获取设备的ID信息</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>receive_data<span class="token punctuation">)</span>
                <span class="token keyword">if</span> receive_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"report"</span><span class="token punctuation">:</span>
                    response <span class="token operator">=</span> <span class="token string">"SET OK:"</span> <span class="token operator">+</span> receive_data
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    receive_data <span class="token operator">=</span> receive_data<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                    <span class="token comment" spellcheck="true"># 拼接响应数据</span>
                    response <span class="token operator">=</span> <span class="token string">"alarm="</span> <span class="token operator">+</span> receive_data <span class="token operator">+</span> <span class="token string">",Switch:clear"</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true"># 4.2 返回原数据作为应答，按‘utf-8’格式编码</span>
                new_socket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>response<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true"># 5.当设备断开连接时，会收到空的字节数据，判断设备已断开连接</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'设备{0}断开连接...'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>client_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span>
        <span class="token comment" spellcheck="true"># 关闭套接字</span>
        new_socket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""创建一个WEB服务器"""</span>
    wsgi_server <span class="token operator">=</span> WSGIServer<span class="token punctuation">(</span>port<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"服务器已开启"</span><span class="token punctuation">)</span>
    wsgi_server<span class="token punctuation">.</span>run_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    port <span class="token operator">=</span> <span class="token number">8125</span>     <span class="token comment" spellcheck="true"># 指定端口</span>
    main<span class="token punctuation">(</span><span class="token number">8125</span><span class="token punctuation">)</span></code></pre>
<ul>
<li>客户端</li>
</ul>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> time
<span class="token keyword">import</span> socket

<span class="token keyword">def</span> <span class="token function">start_client</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    PLC_ADDR <span class="token operator">=</span> addr
    PLC_PORT <span class="token operator">=</span> port
    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>PLC_ADDR<span class="token punctuation">,</span> PLC_PORT<span class="token punctuation">)</span><span class="token punctuation">)</span>
    count <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        msg <span class="token operator">=</span> <span class="token string">'进程{pid}发送数据'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>pid<span class="token operator">=</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        msg <span class="token operator">=</span> msg<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        recv_data <span class="token operator">=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>recv_data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
        count <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">if</span> count <span class="token operator">></span> <span class="token number">20</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>

    s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    start_client<span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token number">8801</span><span class="token punctuation">)</span></code></pre>
<h4 id="2-2-图片传输python-c"><a href="#2-2-图片传输python-c" class="headerlink" title="2.2. 图片传输python+c++"></a>2.2. 图片传输python+c++</h4><ul>
<li>python</li>
</ul>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token comment" spellcheck="true">#-*-coding:utf-8 -*-</span>
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy

<span class="token comment" spellcheck="true"># 接受图片大小的信息</span>
<span class="token keyword">def</span> <span class="token function">recv_size</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">:</span>
    buf <span class="token operator">=</span> b<span class="token string">''</span>
    <span class="token keyword">while</span> count<span class="token punctuation">:</span>
        newbuf <span class="token operator">=</span> sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>count<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> newbuf<span class="token punctuation">:</span> <span class="token keyword">return</span> None
        buf <span class="token operator">+=</span> newbuf
        count <span class="token operator">-=</span> len<span class="token punctuation">(</span>newbuf<span class="token punctuation">)</span>
    <span class="token keyword">return</span> buf

<span class="token comment" spellcheck="true"># 接收图片</span>
<span class="token keyword">def</span> <span class="token function">recv_all</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">:</span>
    buf <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">while</span> count<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># 这里每次只接收一个字节的原因是增强python与C++的兼容性</span>
        <span class="token comment" spellcheck="true"># python可以发送任意的字符串，包括乱码，但C++发送的字符中不能包含'\0'，也就是字符串结束标志位</span>
        newbuf <span class="token operator">=</span> sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> newbuf<span class="token punctuation">:</span> <span class="token keyword">return</span> None
        buf <span class="token operator">+=</span> newbuf
        count <span class="token operator">-=</span> len<span class="token punctuation">(</span>newbuf<span class="token punctuation">)</span>
    <span class="token keyword">return</span> buf

<span class="token comment" spellcheck="true"># socket.AF_INET用于服务器与服务器之间的网络通信</span>
<span class="token comment" spellcheck="true"># socket.SOCK_STREAM代表基于TCP的流式socket通信</span>
s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 设置地址与端口，如果是接收任意ip对本服务器的连接，地址栏可空，但端口必须设置</span>
address <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token number">8010</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>bind<span class="token punctuation">(</span>address<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 将Socket（套接字）绑定到地址</span>
s<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 开始监听TCP传入连接</span>
<span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">'Waiting for images...'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 接受TCP链接并返回（conn, addr），其中conn是新的套接字对象，可以用来接收和发送数据，addr是链接客户端的地址。</span>
conn<span class="token punctuation">,</span> addr <span class="token operator">=</span> s<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
    length <span class="token operator">=</span> recv_size<span class="token punctuation">(</span>conn<span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#首先接收来自客户端发送的大小信息</span>
    <span class="token keyword">if</span> isinstance <span class="token punctuation">(</span>length<span class="token punctuation">,</span>str<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#若成功接收到大小信息，进一步再接收整张图片</span>
        stringData <span class="token operator">=</span> recv_all<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> int<span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>
        data <span class="token operator">=</span> numpy<span class="token punctuation">.</span>fromstring<span class="token punctuation">(</span>stringData<span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">'uint8'</span><span class="token punctuation">)</span>
        decimg<span class="token operator">=</span>cv2<span class="token punctuation">.</span>imdecode<span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#解码处理，返回mat图片</span>
        cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'SERVER'</span><span class="token punctuation">,</span>decimg<span class="token punctuation">)</span>
        <span class="token keyword">if</span> cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">27</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span> 
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Image recieved successfully!'</span><span class="token punctuation">)</span>
        conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"Server has recieved messages!"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">27</span><span class="token punctuation">:</span>
        <span class="token keyword">break</span> 

s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#client</span>
<span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token comment" spellcheck="true">#-*-coding:utf-8 -*-</span>
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy

<span class="token comment" spellcheck="true"># socket.AF_INET用于服务器与服务器之间的网络通信</span>
<span class="token comment" spellcheck="true"># socket.SOCK_STREAM代表基于TCP的流式socket通信</span>
sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span>socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 连接服务端</span>
address_server <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'10.106.20.111'</span><span class="token punctuation">,</span> <span class="token number">8010</span><span class="token punctuation">)</span>
sock<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>address_server<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 从摄像头采集图像</span>
capture <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
ret<span class="token punctuation">,</span> frame <span class="token operator">=</span> capture<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
encode_param<span class="token operator">=</span><span class="token punctuation">[</span>int<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>IMWRITE_JPEG_QUALITY<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">90</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">#设置编码参数</span>

<span class="token keyword">while</span> ret<span class="token punctuation">:</span> 
    <span class="token comment" spellcheck="true"># 首先对图片进行编码，因为socket不支持直接发送图片</span>
    result<span class="token punctuation">,</span> imgencode <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imencode<span class="token punctuation">(</span><span class="token string">'.jpg'</span><span class="token punctuation">,</span> frame<span class="token punctuation">)</span>
    data <span class="token operator">=</span> numpy<span class="token punctuation">.</span>array<span class="token punctuation">(</span>imgencode<span class="token punctuation">)</span>
    stringData <span class="token operator">=</span> data<span class="token punctuation">.</span>tostring<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 首先发送图片编码后的长度</span>
    sock<span class="token punctuation">.</span>send<span class="token punctuation">(</span>str<span class="token punctuation">(</span>len<span class="token punctuation">(</span>stringData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 然后一个字节一个字节发送编码的内容</span>
    <span class="token comment" spellcheck="true"># 如果是python对python那么可以一次性发送，如果发给c++的server则必须分开发因为编码里面有字符串结束标志位，c++会截断</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token punctuation">(</span>stringData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        sock<span class="token punctuation">.</span>send<span class="token punctuation">(</span>stringData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    ret<span class="token punctuation">,</span> frame <span class="token operator">=</span> capture<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#cv2.imshow('CLIENT',frame)</span>
    <span class="token comment" spellcheck="true"># if cv2.waitKey(10) == 27:</span>
    <span class="token comment" spellcheck="true">#     break</span>
    <span class="token comment" spellcheck="true"># 接收server发送的返回信息</span>
    data_r <span class="token operator">=</span> sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> <span class="token punctuation">(</span>data_r<span class="token punctuation">)</span>

sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<ul>
<li>c++</li>
</ul>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;Winsock2.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/opencv.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;vector></span> </span>
<span class="token macro property">#<span class="token directive keyword">pragma</span> comment(lib,"ws2_32.lib")</span>

using namespace cv<span class="token punctuation">;</span>
using namespace std<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    WSADATA wsaData<span class="token punctuation">;</span>
    SOCKET sockServer<span class="token punctuation">;</span>
    SOCKADDR_IN addrServer<span class="token punctuation">;</span>
    SOCKET conn<span class="token punctuation">;</span>
    SOCKADDR_IN addr<span class="token punctuation">;</span>

    <span class="token function">WSAStartup</span><span class="token punctuation">(</span><span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsaData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//����Socket  </span>
    sockServer <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//׼��ͨ�ŵ�ַ  </span>
    addrServer<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>S_un<span class="token punctuation">.</span>S_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    addrServer<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    addrServer<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">8010</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//��  </span>
    <span class="token function">bind</span><span class="token punctuation">(</span>sockServer<span class="token punctuation">,</span> <span class="token punctuation">(</span>SOCKADDR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addrServer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>SOCKADDR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//����  </span>
    <span class="token function">listen</span><span class="token punctuation">(</span>sockServer<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Waiting for images...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>SOCKADDR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//��������  </span>
    conn <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sockServer<span class="token punctuation">,</span> <span class="token punctuation">(</span>SOCKADDR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span> recvBuf<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> recvBuf_1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    Mat img_decode<span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>uchar<span class="token operator">></span> data<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">recv</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> recvBuf<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>recvBuf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token string">'0'</span> <span class="token operator">||</span> recvBuf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">></span><span class="token string">'9'</span><span class="token punctuation">)</span> recvBuf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            data<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>recvBuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">atoi</span><span class="token punctuation">(</span>recvBuf<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">recv</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> recvBuf_1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> recvBuf_1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Image recieved successfully!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">send</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token string">"Server has recieved messages!"</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            img_decode <span class="token operator">=</span> <span class="token function">imdecode</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> CV_LOAD_IMAGE_COLOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"server"</span><span class="token punctuation">,</span> img_decode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">27</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">closesocket</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property">#client</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;Winsock2.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/opencv.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;vector></span> </span>
<span class="token macro property">#<span class="token directive keyword">pragma</span> comment(lib,"ws2_32.lib")</span>

using namespace cv<span class="token punctuation">;</span>
using namespace std<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    WSADATA wsaData<span class="token punctuation">;</span>
    SOCKET sockClient<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//�ͻ���Socket</span>
    SOCKADDR_IN addrServer<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//����˵�ַ</span>
    <span class="token function">WSAStartup</span><span class="token punctuation">(</span><span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsaData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//�½��ͻ���socket</span>
    sockClient <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//����Ҫ���ӵķ���˵�ַ</span>
    addrServer<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>S_un<span class="token punctuation">.</span>S_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">"10.106.20.111"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//Ŀ��IP(10.106.20.74�ǻ��͵�ַ)</span>
    addrServer<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    addrServer<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">8010</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//���Ӷ˿�</span>
    <span class="token comment" spellcheck="true">//���ӵ������</span>
    <span class="token function">connect</span><span class="token punctuation">(</span>sockClient<span class="token punctuation">,</span> <span class="token punctuation">(</span>SOCKADDR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addrServer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>SOCKADDR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Mat image<span class="token punctuation">;</span>
    VideoCapture <span class="token function">capture</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>uchar<span class="token operator">></span> data_encode<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>capture<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token function">imencode</span><span class="token punctuation">(</span><span class="token string">".jpg"</span><span class="token punctuation">,</span> image<span class="token punctuation">,</span> data_encode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> len_encode <span class="token operator">=</span> data_encode<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        string len <span class="token operator">=</span> <span class="token function">to_string</span><span class="token punctuation">(</span>len_encode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> length <span class="token operator">=</span> len<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">16</span> <span class="token operator">-</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            len <span class="token operator">=</span> len <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//��������</span>
        <span class="token function">send</span><span class="token punctuation">(</span>sockClient<span class="token punctuation">,</span> len<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>len<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> send_char<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len_encode<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            send_char<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> data_encode<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">send</span><span class="token punctuation">(</span>sockClient<span class="token punctuation">,</span> send_char<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//���շ�����Ϣ</span>
        <span class="token keyword">char</span> recvBuf<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">recv</span><span class="token punctuation">(</span>sockClient<span class="token punctuation">,</span> recvBuf<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> recvBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">closesocket</span><span class="token punctuation">(</span>sockClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="2-3-pyqt通信"><a href="#2-3-pyqt通信" class="headerlink" title="2.3. pyqt通信"></a>2.3. <a href="https://github.com/Wangler2333/tcp_udp_web_tools-pyqt5" target="_blank" rel="noopener">pyqt通信</a></h4><p><img src="https://gitee.com/github-25970295/blogpictureV2/raw/master/image-20210510155418975.png" alt=""></p>
<ul>
<li><a href="D:\projectBack\tcp_udp_web_tools-pyqt5">TCP_Logic</a></li>
</ul>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> PyQt5 <span class="token keyword">import</span> QtWidgets
<span class="token keyword">import</span> tcp_udp_web_ui
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> threading
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> stopThreading
<span class="token keyword">import</span> time


<span class="token keyword">class</span> <span class="token class-name">TcpLogic</span><span class="token punctuation">(</span>tcp_udp_web_ui<span class="token punctuation">.</span>ToolsUi<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">:</span>
        super<span class="token punctuation">(</span>TcpLogic<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>num<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>tcp_socket <span class="token operator">=</span> None
        self<span class="token punctuation">.</span>sever_th <span class="token operator">=</span> None
        self<span class="token punctuation">.</span>client_th <span class="token operator">=</span> None
        self<span class="token punctuation">.</span>client_socket_list <span class="token operator">=</span> list<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>link <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment" spellcheck="true"># 用于标记是否开启了连接</span>

    <span class="token keyword">def</span> <span class="token function">tcp_server_start</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        功能函数，TCP服务端开启的方法
        :return: None
        """</span>
        self<span class="token punctuation">.</span>tcp_socket <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># 取消主动断开连接四次握手后的TIME_WAIT状态</span>
        self<span class="token punctuation">.</span>tcp_socket<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># 设定套接字为非阻塞式</span>
        self<span class="token punctuation">.</span>tcp_socket<span class="token punctuation">.</span>setblocking<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            port <span class="token operator">=</span> int<span class="token punctuation">(</span>self<span class="token punctuation">.</span>lineEdit_port<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>tcp_socket<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> ret<span class="token punctuation">:</span>
            msg <span class="token operator">=</span> <span class="token string">'请检查端口号\n'</span>
            self<span class="token punctuation">.</span>signal_write_msg<span class="token punctuation">.</span>emit<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>tcp_socket<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>sever_th <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>self<span class="token punctuation">.</span>tcp_server_concurrency<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>sever_th<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
            msg <span class="token operator">=</span> <span class="token string">'TCP服务端正在监听端口:%s\n'</span> <span class="token operator">%</span> str<span class="token punctuation">(</span>port<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>signal_write_msg<span class="token punctuation">.</span>emit<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">tcp_server_concurrency</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        功能函数，供创建线程的方法；
        使用子线程用于监听并创建连接，使主线程可以继续运行，以免无响应
        使用非阻塞式并发用于接收客户端消息，减少系统资源浪费，使软件轻量化
        :return:None
        """</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                client_socket<span class="token punctuation">,</span> client_address <span class="token operator">=</span> self<span class="token punctuation">.</span>tcp_socket<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> ret<span class="token punctuation">:</span>
                time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.001</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                client_socket<span class="token punctuation">.</span>setblocking<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true"># 将创建的客户端套接字存入列表,client_address为ip和端口的元组</span>
                self<span class="token punctuation">.</span>client_socket_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>client_socket<span class="token punctuation">,</span> client_address<span class="token punctuation">)</span><span class="token punctuation">)</span>
                msg <span class="token operator">=</span> <span class="token string">'TCP服务端已连接IP:%s端口:%s\n'</span> <span class="token operator">%</span> client_address
                self<span class="token punctuation">.</span>signal_write_msg<span class="token punctuation">.</span>emit<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true"># 轮询客户端套接字列表，接收数据</span>
            <span class="token keyword">for</span> client<span class="token punctuation">,</span> address <span class="token keyword">in</span> self<span class="token punctuation">.</span>client_socket_list<span class="token punctuation">:</span>
                <span class="token keyword">try</span><span class="token punctuation">:</span>
                    recv_msg <span class="token operator">=</span> client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
                <span class="token keyword">except</span> Exception <span class="token keyword">as</span> ret<span class="token punctuation">:</span>
                    <span class="token keyword">pass</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> recv_msg<span class="token punctuation">:</span>
                        msg <span class="token operator">=</span> recv_msg<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
                        msg <span class="token operator">=</span> <span class="token string">'来自IP:{}端口:{}:\n{}\n'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>address<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> address<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
                        self<span class="token punctuation">.</span>signal_write_msg<span class="token punctuation">.</span>emit<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        self<span class="token punctuation">.</span>client_socket_list<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">tcp_client_start</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        功能函数，TCP客户端连接其他服务端的方法
        :return:
        """</span>
        self<span class="token punctuation">.</span>tcp_socket <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            address <span class="token operator">=</span> <span class="token punctuation">(</span>str<span class="token punctuation">(</span>self<span class="token punctuation">.</span>lineEdit_ip_send<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>self<span class="token punctuation">.</span>lineEdit_port<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> ret<span class="token punctuation">:</span>
            msg <span class="token operator">=</span> <span class="token string">'请检查目标IP，目标端口\n'</span>
            self<span class="token punctuation">.</span>signal_write_msg<span class="token punctuation">.</span>emit<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                msg <span class="token operator">=</span> <span class="token string">'正在连接目标服务器\n'</span>
                self<span class="token punctuation">.</span>signal_write_msg<span class="token punctuation">.</span>emit<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>tcp_socket<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>address<span class="token punctuation">)</span>
            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> ret<span class="token punctuation">:</span>
                msg <span class="token operator">=</span> <span class="token string">'无法连接目标服务器\n'</span>
                self<span class="token punctuation">.</span>signal_write_msg<span class="token punctuation">.</span>emit<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>client_th <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>self<span class="token punctuation">.</span>tcp_client_concurrency<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>client_th<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
                msg <span class="token operator">=</span> <span class="token string">'TCP客户端已连接IP:%s端口:%s\n'</span> <span class="token operator">%</span> address
                self<span class="token punctuation">.</span>signal_write_msg<span class="token punctuation">.</span>emit<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">tcp_client_concurrency</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        功能函数，用于TCP客户端创建子线程的方法，阻塞式接收
        :return:
        """</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            recv_msg <span class="token operator">=</span> self<span class="token punctuation">.</span>tcp_socket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> recv_msg<span class="token punctuation">:</span>
                msg <span class="token operator">=</span> recv_msg<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
                msg <span class="token operator">=</span> <span class="token string">'来自IP:{}端口:{}:\n{}\n'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>address<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> address<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>signal_write_msg<span class="token punctuation">.</span>emit<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>tcp_socket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
                msg <span class="token operator">=</span> <span class="token string">'从服务器断开连接\n'</span>
                self<span class="token punctuation">.</span>signal_write_msg<span class="token punctuation">.</span>emit<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
                <span class="token keyword">break</span>

    <span class="token keyword">def</span> <span class="token function">tcp_send</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        功能函数，用于TCP服务端和TCP客户端发送消息
        :return: None
        """</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>link <span class="token keyword">is</span> <span class="token boolean">False</span><span class="token punctuation">:</span>
            msg <span class="token operator">=</span> <span class="token string">'请选择服务，并点击连接网络\n'</span>
            self<span class="token punctuation">.</span>signal_write_msg<span class="token punctuation">.</span>emit<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                send_msg <span class="token operator">=</span> <span class="token punctuation">(</span>str<span class="token punctuation">(</span>self<span class="token punctuation">.</span>textEdit_send<span class="token punctuation">.</span>toPlainText<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>comboBox_tcp<span class="token punctuation">.</span>currentIndex<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                    <span class="token comment" spellcheck="true"># 向所有连接的客户端发送消息</span>
                    <span class="token keyword">for</span> client<span class="token punctuation">,</span> address <span class="token keyword">in</span> self<span class="token punctuation">.</span>client_socket_list<span class="token punctuation">:</span>
                        client<span class="token punctuation">.</span>send<span class="token punctuation">(</span>send_msg<span class="token punctuation">)</span>
                    msg <span class="token operator">=</span> <span class="token string">'TCP服务端已发送\n'</span>
                    self<span class="token punctuation">.</span>signal_write_msg<span class="token punctuation">.</span>emit<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>comboBox_tcp<span class="token punctuation">.</span>currentIndex<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>tcp_socket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>send_msg<span class="token punctuation">)</span>
                    msg <span class="token operator">=</span> <span class="token string">'TCP客户端已发送\n'</span>
                    self<span class="token punctuation">.</span>signal_write_msg<span class="token punctuation">.</span>emit<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> ret<span class="token punctuation">:</span>
                msg <span class="token operator">=</span> <span class="token string">'发送失败\n'</span>
                self<span class="token punctuation">.</span>signal_write_msg<span class="token punctuation">.</span>emit<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">tcp_close</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        功能函数，关闭网络连接的方法
        :return:
        """</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>comboBox_tcp<span class="token punctuation">.</span>currentIndex<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token keyword">for</span> client<span class="token punctuation">,</span> address <span class="token keyword">in</span> self<span class="token punctuation">.</span>client_socket_list<span class="token punctuation">:</span>
                    client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>tcp_socket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>link <span class="token keyword">is</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
                    msg <span class="token operator">=</span> <span class="token string">'已断开网络\n'</span>
                    self<span class="token punctuation">.</span>signal_write_msg<span class="token punctuation">.</span>emit<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> ret<span class="token punctuation">:</span>
                <span class="token keyword">pass</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>comboBox_tcp<span class="token punctuation">.</span>currentIndex<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>tcp_socket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>link <span class="token keyword">is</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
                    msg <span class="token operator">=</span> <span class="token string">'已断开网络\n'</span>
                    self<span class="token punctuation">.</span>signal_write_msg<span class="token punctuation">.</span>emit<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> ret<span class="token punctuation">:</span>
                <span class="token keyword">pass</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            stopThreading<span class="token punctuation">.</span>stop_thread<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sever_th<span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
            <span class="token keyword">pass</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            stopThreading<span class="token punctuation">.</span>stop_thread<span class="token punctuation">(</span>self<span class="token punctuation">.</span>client_th<span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
            <span class="token keyword">pass</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app <span class="token operator">=</span> QtWidgets<span class="token punctuation">.</span>QApplication<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>
    ui <span class="token operator">=</span> TcpLogic<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    ui<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>app<span class="token punctuation">.</span>exec_<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="2-4-python-amp-C-通信"><a href="#2-4-python-amp-C-通信" class="headerlink" title="2.4. python&amp;C# 通信"></a>2.4. python&amp;C# 通信</h4><blockquote>
<p>注意发送内容编码形式</p>
</blockquote>
<ul>
<li>server.py</li>
</ul>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> face_recognition
<span class="token keyword">import</span> os
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> json   
<span class="token keyword">from</span> socket <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread
<span class="token keyword">from</span> seetaface<span class="token punctuation">.</span>api <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pickle
<span class="token keyword">import</span> threading
<span class="token keyword">class</span> <span class="token class-name">SeetaFaceHandle</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        使用到的函数:
            Extract：提取一张原始图像里的一个指定区域的人脸的特征值
            ExtractCroppedFace: 提取一张已经裁剪好，只包含人脸图的人脸的特征值
            CalculateSimilarity: 计算两个特征值之间的相似度
        要加载的功能 :
            人脸识别功能：FACERECOGNITION
        该功能依赖 ：
            FACE_DETECT :人脸检测
            LANDMARKER5 :5点关键点识别
        path: 人脸图片所在的目录
        """</span>
        self<span class="token punctuation">.</span>init_mask <span class="token operator">=</span> FACE_DETECT<span class="token operator">|</span>FACERECOGNITION<span class="token operator">|</span>LANDMARKER5
        self<span class="token punctuation">.</span>seetaFace <span class="token operator">=</span> SeetaFace<span class="token punctuation">(</span>self<span class="token punctuation">.</span>init_mask<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pic_path<span class="token operator">=</span>path
        self<span class="token punctuation">.</span>faces<span class="token punctuation">,</span>self<span class="token punctuation">.</span>faceNames<span class="token operator">=</span>self<span class="token punctuation">.</span>initFaceData<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">initFaceData</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        known_faces<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        known_faceNames<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        known_face_sids<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        json_lists<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">'known_faces'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true"># npz = np.load('all4.npz')</span>
            <span class="token comment" spellcheck="true"># known_faceNames = npz['names']</span>
            <span class="token comment" spellcheck="true"># known_faces=npz['encode']</span>
            <span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">'known_faces'</span><span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                known_faces<span class="token operator">=</span>pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span>known_faces<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
            <span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">'known_faceNames'</span><span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                known_faceNames<span class="token operator">=</span>pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span>known_faceNames<span class="token punctuation">,</span> f<span class="token punctuation">)</span>

            <span class="token comment" spellcheck="true">#print("type",type(known_faces))</span>
            <span class="token comment" spellcheck="true">#known_faces=self.seetaFace.get_feature_numpy(known_faces)</span>
            <span class="token comment" spellcheck="true">#print("type",type(known_faces))</span>
            <span class="token comment" spellcheck="true">#print("\nfaceimg",known_faces,"\nfacename",known_faceNames)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            i<span class="token operator">=</span><span class="token number">0</span>
            files<span class="token operator">=</span>os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pic_path<span class="token punctuation">)</span>
            <span class="token keyword">for</span> file <span class="token keyword">in</span> files<span class="token punctuation">:</span>
                img_path<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pic_path<span class="token punctuation">,</span>file<span class="token punctuation">)</span>
                obj_img <span class="token operator">=</span> self<span class="token punctuation">.</span>load_image_file<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">#print(file,"obj_img:",obj_img.size)</span>

                <span class="token keyword">import</span> time
                a1 <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
                detect_result1 <span class="token operator">=</span> self<span class="token punctuation">.</span>seetaFace<span class="token punctuation">.</span>Detect<span class="token punctuation">(</span>obj_img<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">#print("detect_result1:",detect_result1)</span>
                face1 <span class="token operator">=</span> detect_result1<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pos
                <span class="token comment" spellcheck="true">#print("face1:",face1)</span>
                points1 <span class="token operator">=</span> self<span class="token punctuation">.</span>seetaFace<span class="token punctuation">.</span>mark5<span class="token punctuation">(</span>obj_img<span class="token punctuation">,</span>face1<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">#print("points1:",points1)</span>
                obj_face_encoding <span class="token operator">=</span> self<span class="token punctuation">.</span>seetaFace<span class="token punctuation">.</span>Extract<span class="token punctuation">(</span>obj_img<span class="token punctuation">,</span>points1<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">#print("name:",file,"feature:",obj_face_encoding)</span>
                <span class="token comment" spellcheck="true">#print("obj_face_encoding:",obj_face_encoding)</span>
                <span class="token comment" spellcheck="true">#print('handlefile=',file,'time used:', time.time()-a1)</span>
                <span class="token keyword">if</span> <span class="token operator">not</span> len<span class="token punctuation">(</span>obj_face_encoding<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'eee:'</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span>
                    <span class="token keyword">continue</span>
                known_faces<span class="token punctuation">.</span>append<span class="token punctuation">(</span>obj_face_encoding<span class="token punctuation">)</span>
                name <span class="token operator">=</span> file<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                known_faceNames<span class="token punctuation">.</span>append<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
                known_face_sids<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
                json_lists<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'img'</span><span class="token punctuation">:</span> file<span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">:</span> name<span class="token punctuation">,</span> <span class="token string">'sid'</span><span class="token punctuation">:</span> str<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true"># with open('known_faces', 'wb') as f:</span>
            <span class="token comment" spellcheck="true">#     pickle.dump(known_faces, f)</span>
            <span class="token comment" spellcheck="true"># with open('known_faceNames', 'wb') as f:</span>
            <span class="token comment" spellcheck="true">#     pickle.dump(known_faceNames, f)</span>
            <span class="token comment" spellcheck="true">#np.savez('all4.npz', encode=known_faces, sids=known_face_sids, names=known_faceNames)</span>
            <span class="token comment" spellcheck="true"># with open('facename.json', 'w') as f:</span>
            <span class="token comment" spellcheck="true">#     json_list_str = json.dumps(json_lists)</span>
            <span class="token comment" spellcheck="true">#     f.write(json_list_str)</span>
        <span class="token keyword">return</span> known_faces<span class="token punctuation">,</span>known_faceNames

    <span class="token keyword">def</span> <span class="token function">load_image_file</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> file<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'RGB'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"pic_file"</span><span class="token punctuation">,</span>file<span class="token punctuation">)</span>
        im <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imdecode<span class="token punctuation">(</span>np<span class="token punctuation">.</span>fromfile<span class="token punctuation">(</span>file<span class="token punctuation">,</span>dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> im

    <span class="token keyword">def</span> <span class="token function">getFaceNameFromFile</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>targetPath<span class="token punctuation">)</span><span class="token punctuation">:</span>
        name<span class="token operator">=</span><span class="token string">"None"</span>
        image2<span class="token operator">=</span>self<span class="token punctuation">.</span>load_image_file<span class="token punctuation">(</span>targetPath<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            detect_result2 <span class="token operator">=</span> self<span class="token punctuation">.</span>seetaFace<span class="token punctuation">.</span>Detect<span class="token punctuation">(</span>image2<span class="token punctuation">)</span>
            face2 <span class="token operator">=</span> detect_result2<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pos
            points2 <span class="token operator">=</span> self<span class="token punctuation">.</span>seetaFace<span class="token punctuation">.</span>mark5<span class="token punctuation">(</span>image2<span class="token punctuation">,</span>face2<span class="token punctuation">)</span>
            feature2 <span class="token operator">=</span> self<span class="token punctuation">.</span>seetaFace<span class="token punctuation">.</span>Extract<span class="token punctuation">(</span>image2<span class="token punctuation">,</span>points2<span class="token punctuation">)</span>
            max<span class="token operator">=</span><span class="token number">0</span>
            index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span>
            <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token punctuation">(</span>self<span class="token punctuation">.</span>faces<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                
                <span class="token comment" spellcheck="true">#targetEncoding=self.seetaFace.get_feature_numpy(feature2)</span>
                <span class="token comment" spellcheck="true">#print("similar1:",type(self.faces[i]),"  feature2:",type(targetEncoding))</span>
                <span class="token comment" spellcheck="true">#similar1 = self.seetaFace.compare_feature_np(self.faces[i],targetEncoding) #0.688</span>
                similar1 <span class="token operator">=</span> self<span class="token punctuation">.</span>seetaFace<span class="token punctuation">.</span>CalculateSimilarity<span class="token punctuation">(</span>self<span class="token punctuation">.</span>faces<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>feature2<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#0.999</span>
                <span class="token keyword">if</span> similar1<span class="token operator">></span>max<span class="token punctuation">:</span>
                    max<span class="token operator">=</span>similar1
                    index<span class="token operator">=</span>i

            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"最大相似度： "</span><span class="token punctuation">,</span>max<span class="token punctuation">,</span> <span class="token string">"\t 人脸name:"</span><span class="token punctuation">,</span>self<span class="token punctuation">.</span>faceNames<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"\t人脸特征:"</span><span class="token punctuation">,</span>self<span class="token punctuation">.</span>faces<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>faceNames<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"file don't detect face"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> name

    <span class="token keyword">def</span> <span class="token function">getFaceNameFromEncoding</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>targetEncoding<span class="token punctuation">)</span><span class="token punctuation">:</span>
        name<span class="token operator">=</span><span class="token string">"None"</span>
        max<span class="token operator">=</span><span class="token number">0</span>
        index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span>
        targetEncoding<span class="token operator">=</span>self<span class="token punctuation">.</span>seetaFace<span class="token punctuation">.</span>get_feature_numpy<span class="token punctuation">(</span>targetEncoding<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>len<span class="token punctuation">(</span>self<span class="token punctuation">.</span>faces<span class="token punctuation">)</span><span class="token punctuation">,</span>type<span class="token punctuation">(</span>self<span class="token punctuation">.</span>faces<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>type<span class="token punctuation">(</span>targetEncoding<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"处理"</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span>type<span class="token punctuation">(</span>self<span class="token punctuation">.</span>face<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>type<span class="token punctuation">(</span>targetEncoding<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">#similar1 = self.seetaFace.compare_feature_np(self.faces[i],targetEncoding)</span>
            similar1<span class="token operator">=</span>i
            <span class="token keyword">if</span> similar1<span class="token operator">></span>max<span class="token punctuation">:</span>
                max<span class="token operator">=</span>similar1
                index<span class="token operator">=</span>i

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"最大相似度： "</span><span class="token punctuation">,</span>max<span class="token punctuation">,</span> <span class="token string">"\t 人脸name:"</span><span class="token punctuation">,</span>self<span class="token punctuation">.</span>faceNames<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"\t人脸特征:"</span><span class="token punctuation">,</span>self<span class="token punctuation">.</span>faces<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>faceNames<span class="token punctuation">[</span>index<span class="token punctuation">]</span>


<span class="token keyword">class</span> <span class="token class-name">FaceData</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>pic_path<span class="token operator">=</span>path
        <span class="token comment" spellcheck="true">#self.initFaceDatatoFile()</span>
        self<span class="token punctuation">.</span>faces<span class="token punctuation">,</span>self<span class="token punctuation">.</span>faceNames<span class="token operator">=</span>self<span class="token punctuation">.</span>initFaceData<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">initFaceData</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        known_faces<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        known_faceNames<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">"all4.npz"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            npz<span class="token operator">=</span>np<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'all4.npz'</span><span class="token punctuation">)</span>
            known_faceNames <span class="token operator">=</span> npz<span class="token punctuation">[</span><span class="token string">'names'</span><span class="token punctuation">]</span>
            known_faces<span class="token operator">=</span>npz<span class="token punctuation">[</span><span class="token string">'encode'</span><span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> file <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pic_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
                filepath<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pic_path<span class="token punctuation">,</span>file<span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span>
                image<span class="token operator">=</span>face_recognition<span class="token punctuation">.</span>load_image_file<span class="token punctuation">(</span>filepath<span class="token punctuation">)</span>
                <span class="token keyword">try</span><span class="token punctuation">:</span>
                    imageEncoding<span class="token operator">=</span>face_recognition<span class="token punctuation">.</span>face_encodings<span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                    known_faceNames<span class="token punctuation">.</span>append<span class="token punctuation">(</span>file<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                    known_faces<span class="token punctuation">.</span>append<span class="token punctuation">(</span>imageEncoding<span class="token punctuation">)</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span>known_faceNames<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token keyword">except</span><span class="token punctuation">:</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"file don't detect face"</span><span class="token punctuation">)</span>
            np<span class="token punctuation">.</span>savez<span class="token punctuation">(</span><span class="token string">'all4.npz'</span><span class="token punctuation">,</span> encode<span class="token operator">=</span>known_faces<span class="token punctuation">,</span> names<span class="token operator">=</span>known_faceNames<span class="token punctuation">)</span>
        <span class="token keyword">return</span> known_faces<span class="token punctuation">,</span>known_faceNames

    <span class="token keyword">def</span> <span class="token function">loadFaceDataFromFile</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        fw <span class="token operator">=</span>open<span class="token punctuation">(</span><span class="token string">'face_info.json'</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#打开一个名字为‘user_info.json’的空文件</span>
        face_dic<span class="token operator">=</span>json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>fw<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> face_dic<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>face_dic<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">initFaceDatatoFile</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        known_faces<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        known_faceNames<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> file <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pic_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            filepath<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pic_path<span class="token punctuation">,</span>file<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span>
            image<span class="token operator">=</span>face_recognition<span class="token punctuation">.</span>load_image_file<span class="token punctuation">(</span>filepath<span class="token punctuation">)</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                imageEncoding<span class="token operator">=</span>face_recognition<span class="token punctuation">.</span>face_encodings<span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                known_faceNames<span class="token punctuation">.</span>append<span class="token punctuation">(</span>file<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                known_faces<span class="token punctuation">.</span>append<span class="token punctuation">(</span>imageEncoding<span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>known_faceNames<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"file don't detect face"</span><span class="token punctuation">)</span>
        d3 <span class="token operator">=</span>dict<span class="token punctuation">(</span>zip<span class="token punctuation">(</span>known_faceNames<span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>known_faces<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">#print(d3)</span>
        <span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">"./face_info.json"</span><span class="token punctuation">,</span><span class="token string">"w"</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>known_faces<span class="token punctuation">,</span> f<span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


    <span class="token keyword">def</span> <span class="token function">getFaceNameFromFile</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>targetPath<span class="token punctuation">)</span><span class="token punctuation">:</span>
        name<span class="token operator">=</span><span class="token string">"None"</span>
        image<span class="token operator">=</span>face_recognition<span class="token punctuation">.</span>load_image_file<span class="token punctuation">(</span>targetPath<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            face_encoding<span class="token operator">=</span>face_recognition<span class="token punctuation">.</span>face_encodings<span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            matches <span class="token operator">=</span> face_recognition<span class="token punctuation">.</span>compare_faces<span class="token punctuation">(</span>self<span class="token punctuation">.</span>faces<span class="token punctuation">,</span> face_encoding<span class="token punctuation">)</span>
            face_distances <span class="token operator">=</span> face_recognition<span class="token punctuation">.</span>face_distance<span class="token punctuation">(</span>self<span class="token punctuation">.</span>faces<span class="token punctuation">,</span> face_encoding<span class="token punctuation">)</span>
            best_match_index <span class="token operator">=</span> np<span class="token punctuation">.</span>argmin<span class="token punctuation">(</span>face_distances<span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">#print("最小距离： ",face_distances[best_match_index])</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>face_distances<span class="token punctuation">)</span>
            <span class="token keyword">if</span> matches<span class="token punctuation">[</span>best_match_index<span class="token punctuation">]</span><span class="token punctuation">:</span>
                name <span class="token operator">=</span> self<span class="token punctuation">.</span>faceNames<span class="token punctuation">[</span>best_match_index<span class="token punctuation">]</span>
            <span class="token keyword">return</span> name
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"file don't detect face"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> name   


    <span class="token keyword">def</span> <span class="token function">getFaceNameFromEncoding</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>targetEncoding<span class="token punctuation">)</span><span class="token punctuation">:</span>
        name<span class="token operator">=</span><span class="token string">"None"</span>
        matches <span class="token operator">=</span> face_recognition<span class="token punctuation">.</span>compare_faces<span class="token punctuation">(</span>self<span class="token punctuation">.</span>faces<span class="token punctuation">,</span> targetEncoding<span class="token punctuation">)</span>
        face_distances <span class="token operator">=</span> face_recognition<span class="token punctuation">.</span>face_distance<span class="token punctuation">(</span>self<span class="token punctuation">.</span>faces<span class="token punctuation">,</span> targetEncoding<span class="token punctuation">)</span>
        best_match_index <span class="token operator">=</span> np<span class="token punctuation">.</span>argmin<span class="token punctuation">(</span>face_distances<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"最小距离： "</span><span class="token punctuation">,</span>face_distances<span class="token punctuation">[</span>best_match_index<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>face_distances<span class="token punctuation">)</span>
        <span class="token keyword">if</span> matches<span class="token punctuation">[</span>best_match_index<span class="token punctuation">]</span><span class="token punctuation">:</span>
            name <span class="token operator">=</span> self<span class="token punctuation">.</span>faceNames<span class="token punctuation">[</span>best_match_index<span class="token punctuation">]</span>
        <span class="token keyword">return</span> name

    <span class="token keyword">def</span> <span class="token function">faceRecAcc</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>folder<span class="token punctuation">)</span><span class="token punctuation">:</span>
        cnt<span class="token operator">=</span><span class="token number">0</span>
        <span class="token keyword">for</span> tempfile <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>folder<span class="token punctuation">)</span><span class="token punctuation">:</span>
            filename<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>folder<span class="token punctuation">,</span>tempfile<span class="token punctuation">)</span>
            name<span class="token operator">=</span>self<span class="token punctuation">.</span>getFaceNameFromFile<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
            <span class="token keyword">if</span> name <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">"葛伟平"</span><span class="token punctuation">,</span><span class="token string">"刘冬冬"</span><span class="token punctuation">,</span><span class="token string">"徐小龙"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                cnt<span class="token operator">=</span>cnt<span class="token operator">+</span><span class="token number">1</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>folder<span class="token punctuation">,</span><span class="token string">" 总个数为:"</span><span class="token punctuation">,</span>len<span class="token punctuation">(</span>os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>folder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">" 正确个数为:"</span><span class="token punctuation">,</span>cnt<span class="token punctuation">)</span>




<span class="token keyword">class</span> <span class="token class-name">TcpServer</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Tcp服务器"""</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> Port<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""初始化对象"""</span>
        self<span class="token punctuation">.</span>code_mode <span class="token operator">=</span> <span class="token string">"utf-8"</span>    <span class="token comment" spellcheck="true">#收发数据编码/解码格式</span>
        self<span class="token punctuation">.</span>server_socket <span class="token operator">=</span> socket<span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#创建socket</span>
        self<span class="token punctuation">.</span>server_socket<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#设置端口复用</span>
        self<span class="token punctuation">.</span>server_socket<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> Port<span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token comment" spellcheck="true">#绑定IP和Port</span>
        self<span class="token punctuation">.</span>server_socket<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#设置为被动socket</span>
        self<span class="token punctuation">.</span>mutex<span class="token operator">=</span>threading<span class="token punctuation">.</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>facedata<span class="token operator">=</span>FaceData<span class="token punctuation">(</span><span class="token string">"./picture"</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Listen..."</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""运行"""</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            client_socket<span class="token punctuation">,</span> client_addr <span class="token operator">=</span> self<span class="token punctuation">.</span>server_socket<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#等待客户端连接</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"{} online"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>client_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                tr <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>self<span class="token punctuation">.</span>recv_data<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>client_socket<span class="token punctuation">,</span> client_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#创建线程为客户端服务</span>
                tr<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#开启线程</span>
            <span class="token keyword">except</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'face_server error'</span><span class="token punctuation">)</span>


    <span class="token keyword">def</span> <span class="token function">recv_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> client_socket<span class="token punctuation">,</span> client_addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""收发数据"""</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> client_socket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span>self<span class="token punctuation">.</span>code_mode<span class="token punctuation">)</span>
            <span class="token keyword">if</span> data<span class="token punctuation">:</span>
                data<span class="token operator">=</span>data<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">";"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"{}:{}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>client_addr<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true"># 锁定资源</span>
                self<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
                name<span class="token operator">=</span>self<span class="token punctuation">.</span>facedata<span class="token punctuation">.</span>getFaceNameFromFile<span class="token punctuation">(</span><span class="token string">"./realtime/"</span><span class="token operator">+</span>data<span class="token operator">+</span><span class="token string">".png"</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true"># 解锁资源</span>
                self<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"人脸姓名:"</span><span class="token operator">+</span>name<span class="token punctuation">)</span>
                client_socket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>name<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>self<span class="token punctuation">.</span>code_mode<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>     <span class="token comment" spellcheck="true">#客户端断开连接</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"{} offline"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>client_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span>

        client_socket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">localcameratestFaceData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    video_capture <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    facedata<span class="token operator">=</span>FaceData<span class="token punctuation">(</span><span class="token string">"./picture"</span><span class="token punctuation">)</span>
    process_this_frame <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># Grab a single frame of video</span>
        ret<span class="token punctuation">,</span> frame <span class="token operator">=</span> video_capture<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># Resize frame of video to 1/4 size for faster face recognition processing</span>
        small_frame <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fx<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span> fy<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># Convert the image from BGR color (which OpenCV uses) to RGB color (which face_recognition uses)</span>
        rgb_small_frame <span class="token operator">=</span> small_frame<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

        <span class="token comment" spellcheck="true"># Only process every other frame of video to save time</span>
        <span class="token keyword">if</span> process_this_frame<span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true"># Find all the faces and face encodings in the current frame of video</span>
            face_locations <span class="token operator">=</span> face_recognition<span class="token punctuation">.</span>face_locations<span class="token punctuation">(</span>rgb_small_frame<span class="token punctuation">)</span>
            face_encodings <span class="token operator">=</span> face_recognition<span class="token punctuation">.</span>face_encodings<span class="token punctuation">(</span>rgb_small_frame<span class="token punctuation">,</span> face_locations<span class="token punctuation">)</span>

            face_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token keyword">for</span> face_encoding <span class="token keyword">in</span> face_encodings<span class="token punctuation">:</span>
                <span class="token comment" spellcheck="true"># See if the face is a match for the known face(s)</span>
                name<span class="token operator">=</span>facedata<span class="token punctuation">.</span>getFaceNameFromEncoding<span class="token punctuation">(</span>face_encoding<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true"># 需要先把输出的中文字符转换成Unicode编码形式</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span>
                face_names<span class="token punctuation">.</span>append<span class="token punctuation">(</span>name<span class="token punctuation">)</span>

        process_this_frame <span class="token operator">=</span> <span class="token operator">not</span> process_this_frame


        <span class="token comment" spellcheck="true"># Display the results</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> left<span class="token punctuation">)</span><span class="token punctuation">,</span> name <span class="token keyword">in</span> zip<span class="token punctuation">(</span>face_locations<span class="token punctuation">,</span> face_names<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true"># Scale back up face locations since the frame we detected in was scaled to 1/4 size</span>
            top <span class="token operator">*=</span> <span class="token number">4</span>
            right <span class="token operator">*=</span> <span class="token number">4</span>
            bottom <span class="token operator">*=</span> <span class="token number">4</span>
            left <span class="token operator">*=</span> <span class="token number">4</span>

            <span class="token comment" spellcheck="true"># Draw a box around the face</span>
            cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token punctuation">(</span>left<span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>right<span class="token punctuation">,</span> bottom<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

            <span class="token comment" spellcheck="true"># Draw a label with a name below the face</span>
            cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token punctuation">(</span>left<span class="token punctuation">,</span> bottom <span class="token operator">-</span> <span class="token number">35</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>right<span class="token punctuation">,</span> bottom<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>FILLED<span class="token punctuation">)</span>
            font <span class="token operator">=</span> cv2<span class="token punctuation">.</span>FONT_HERSHEY_DUPLEX
            cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token punctuation">(</span>left <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">,</span> bottom <span class="token operator">-</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> font<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># Display the resulting image</span>
        cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'Video'</span><span class="token punctuation">,</span> frame<span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># Hit 'q' on the keyboard to quit!</span>
        <span class="token keyword">if</span> cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span> <span class="token operator">==</span> ord<span class="token punctuation">(</span><span class="token string">'q'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>

    <span class="token comment" spellcheck="true"># Release handle to the webcam</span>
    video_capture<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">localcameratestSeetaFace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    video_capture <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    facedata<span class="token operator">=</span>SeetaFaceHandle<span class="token punctuation">(</span><span class="token string">"./picture"</span><span class="token punctuation">)</span>
    process_this_frame <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># Grab a single frame of video</span>
        ret<span class="token punctuation">,</span> frame <span class="token operator">=</span> video_capture<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># Resize frame of video to 1/4 size for faster face recognition processing</span>
        <span class="token comment" spellcheck="true">#small_frame = cv2.resize(frame, (0, 0), fx=0.25, fy=0.25)</span>
        small_frame<span class="token operator">=</span>frame
        <span class="token comment" spellcheck="true"># Convert the image from BGR color (which OpenCV uses) to RGB color (which face_recognition uses)</span>
        rgb_small_frame <span class="token operator">=</span> small_frame<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

        <span class="token comment" spellcheck="true"># Only process every other frame of video to save time</span>
        <span class="token keyword">if</span> process_this_frame<span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true"># Find all the faces and face encodings in the current frame of video</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                detect_result2 <span class="token operator">=</span> facedata<span class="token punctuation">.</span>seetaFace<span class="token punctuation">.</span>Detect<span class="token punctuation">(</span>rgb_small_frame<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">#print(detect_result2)</span>
                face2 <span class="token operator">=</span> detect_result2<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pos
                <span class="token comment" spellcheck="true">#print(face2)</span>
                points2 <span class="token operator">=</span> facedata<span class="token punctuation">.</span>seetaFace<span class="token punctuation">.</span>mark5<span class="token punctuation">(</span>rgb_small_frame<span class="token punctuation">,</span>face2<span class="token punctuation">)</span>
                feature2 <span class="token operator">=</span> facedata<span class="token punctuation">.</span>seetaFace<span class="token punctuation">.</span>Extract<span class="token punctuation">(</span>rgb_small_frame<span class="token punctuation">,</span>points2<span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"feature2"</span><span class="token punctuation">,</span>feature2<span class="token punctuation">)</span>


                face_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                name<span class="token operator">=</span>facedata<span class="token punctuation">.</span>getFaceNameFromEncoding<span class="token punctuation">(</span>feature2<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true"># 需要先把输出的中文字符转换成Unicode编码形式</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span>
                face_names<span class="token punctuation">.</span>append<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
            <span class="token keyword">except</span> <span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span>


        process_this_frame <span class="token operator">=</span> <span class="token operator">not</span> process_this_frame


        <span class="token comment" spellcheck="true"># Display the results</span>
        <span class="token comment" spellcheck="true"># for (top, right, bottom, left), name in zip(face_locations, face_names):</span>
        <span class="token comment" spellcheck="true">#     # Scale back up face locations since the frame we detected in was scaled to 1/4 size</span>
        <span class="token comment" spellcheck="true">#     top *= 4</span>
        <span class="token comment" spellcheck="true">#     right *= 4</span>
        <span class="token comment" spellcheck="true">#     bottom *= 4</span>
        <span class="token comment" spellcheck="true">#     left *= 4</span>

        <span class="token comment" spellcheck="true">#     # Draw a box around the face</span>
        <span class="token comment" spellcheck="true">#     cv2.rectangle(frame, (left, top), (right, bottom), (0, 0, 255), 2)</span>

        <span class="token comment" spellcheck="true">#     # Draw a label with a name below the face</span>
        <span class="token comment" spellcheck="true">#     cv2.rectangle(frame, (left, bottom - 35), (right, bottom), (0, 0, 255), cv2.FILLED)</span>
        <span class="token comment" spellcheck="true">#     font = cv2.FONT_HERSHEY_DUPLEX</span>
        <span class="token comment" spellcheck="true">#     cv2.putText(frame, name, (left + 6, bottom - 6), font, 1.0, (255, 255, 255), 1)</span>

        <span class="token comment" spellcheck="true"># Display the resulting image</span>
        cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'Video'</span><span class="token punctuation">,</span> frame<span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># Hit 'q' on the keyboard to quit!</span>
        <span class="token keyword">if</span> cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span> <span class="token operator">==</span> ord<span class="token punctuation">(</span><span class="token string">'q'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>

    <span class="token comment" spellcheck="true"># Release handle to the webcam</span>
    video_capture<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true">#print("\033c", end="")     #清屏</span>
    serverfl<span class="token operator">=</span>TcpServer<span class="token punctuation">(</span><span class="token number">13333</span><span class="token punctuation">)</span>
    serverfl<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#localcameratestSeetaFace()</span></code></pre>
<ul>
<li>C# client   </li>
</ul>
<pre class=" language-c#"><code class="language-c#">using System;
using System.Collections.Generic;
using System.Text;
using System.Net;
using System.Net.Sockets;
using System.Threading;

namespace KinectRFID.Util
{
    public class SocketUtil
    {
        private object _lockSend = new object();
        private Socket socket= null;
        private string host;
        private int port ;
        public SocketUtil() { }
        public SocketUtil(string _host, int _port)
        {
            host = _host;
            port = _port;
            connectToServer(host, port);
        }

        public void connectToServer(string host, int port)
        {
            if (socket == null || !socket.Connected)
            {
                try
                {
                    socket = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
                    IPAddress ip = IPAddress.Parse(host);
                    IPEndPoint ipe = new IPEndPoint(ip, port);
                    socket.SendTimeout = 2000;
                    socket.ReceiveTimeout = 2000;
                    socket.SendBufferSize = 1024;
                    socket.ReceiveBufferSize = 1024;
                    socket.Connect(ipe);
                }
                catch (Exception)
                {
                    Console.WriteLine("connectVisualiseServer error，服务器没有开启");
                }
            }
        }
        public Socket GetSocket()
        {
            connectToServer(host, port);
            return socket;
        }

        #region Send
            /// <summary>
            /// Send
            /// </summary>
            public string SendReceive(string data)
        {
            lock (_lockSend)
            {
                //Encoding.ASCII.GetBytes(gestureDatas[gestureId].Id+";");

                //System.Diagnostics.Debug.WriteLine("Send data=" + data);
                byte[] lenArr = Encoding.UTF8.GetBytes(data);
                int sendTotal = 0;
                while (sendTotal < lenArr.Length)
                {
                    int sendOnce = socket.Send(lenArr, sendTotal, lenArr.Length - sendTotal, SocketFlags.None);
                    sendTotal += sendOnce;
                    Thread.Sleep(1);
                }
                //System.Diagnostics.Debug.WriteLine("send data ok, data=" + Encoding.UTF8.GetString(lenArr));

                try
                {        // 发送方 发送字符串，文件名前缀
                    int block = 1024;
                    byte[] buffer = new byte[block];
                    int receiveCount = socket.Receive(buffer, 0, block, SocketFlags.None);
                    if (receiveCount == 0)
                    {
                        return null;
                    }
                    else
                    {
                        //System.Diagnostics.Debug.WriteLine("recieve data ok, data=" + buffer.ToString());
                        System.Diagnostics.Debug.WriteLine("SendReceive: recieve data= " + Encoding.UTF8.GetString(buffer));
                        return Encoding.UTF8.GetString(buffer);
                    }
                }
                catch (Exception ex)
                {
                    System.Diagnostics.Debug.WriteLine("接收数据出错：" + ex.Message + "\r\n" + ex.StackTrace);
                    return null;
                }

            }

        }
        #endregion



            #region 断开服务器
            /// <summary>
            /// 断开服务器clientSocketFace
            /// </summary>
            public  void DisconnectServer(Socket socket)
        {
            try
            {
                if (socket != null)
                {
                    if (socket.Connected)
                        socket.Disconnect(false);
                    socket.Close();
                    socket.Dispose();
                }
                System.Diagnostics.Debug.WriteLine("已断开服务器");
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine("断开服务器失败：" + ex.Message);
            }
        }
        #endregion

    }
}</code></pre>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://liudongdong1.github.io" rel="external nofollow noreferrer">liudongdong1</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://liudongdong1.github.io/2021/05/10/yu-yan-kuang-jia/python/socket/">https://liudongdong1.github.io/2021/05/10/yu-yan-kuang-jia/python/socket/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint polocy. If reproduced, please indicate source
                    <a href="https://liudongdong1.github.io" target="_blank">liudongdong1</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/python/">
                                    <span class="chip bg-color">python</span>
                                </a>
                            
                                <a href="/tags/socket/">
                                    <span class="chip bg-color">socket</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq,qzone,wechat,weibo,douban" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2021/05/10/yu-yan-kuang-jia/java/exceptionhandle/">
                    <div class="card-image">
                        
                        <img src="https://gitee.com/github-25970295/blogImage/raw/master/img/20210510093804.png" class="responsive-img" alt="ExceptionHandle">
                        
                        <span class="card-title">ExceptionHandle</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
异常本质上是程序上的错误，包括程序逻辑错误和系统错误。比如使用空的引用、数组下标越界、内存溢出错误等. 错误在我们编写程序的过程中会经常发生，包括编译期间和运行期间的错误，在编译期间出现的错误有编译器帮助我们一起修正，然而运行期间的错误便
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-05-10
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%AF%AD%E8%A8%80%E6%A1%86%E6%9E%B6/" class="post-category">
                                    语言框架
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/java/">
                        <span class="chip bg-color">java</span>
                    </a>
                    
                    <a href="/tags/exception/">
                        <span class="chip bg-color">exception</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/05/10/yu-yan-kuang-jia/java/datastructure/number/">
                    <div class="card-image">
                        
                        <img src="https://gitee.com/github-25970295/blogImage/raw/master/img/20210510093856.png" class="responsive-img" alt="Number">
                        
                        <span class="card-title">Number</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
8种基本数据类型并不支持面向对象的特征，它们既不是类，也不能调用方法。



1. Number
BigDecimal 和 BigInteger 用于高精度计算。AtomicInteger 和 AtomicLong 用于多线程应用程序。

                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-05-10
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%AF%AD%E8%A8%80%E6%A1%86%E6%9E%B6/" class="post-category">
                                    语言框架
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/java/">
                        <span class="chip bg-color">java</span>
                    </a>
                    
                    <a href="/tags/datastructure/">
                        <span class="chip bg-color">datastructure</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <!-- <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="463294659"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2019</span>
            <a href="https://liudongdong1.github.io" target="_blank">liudongdong</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">1195.6k</span>&nbsp;字
            
            
            
            
            
            
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/liudongdong1/" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:3463264078@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>














    <a href="https://blog.csdn.net/liudongdong19/" class="tooltipped" target="_blank" data-tooltip="关注我的CSDN: https://blog.csdn.net/liudongdong19/" data-position="top" data-delay="50">
        <i class="fab fa-csdn">C</i>
    </a>





</div>
    </div>
</footer>

<div class="progress-bar"></div>
 -->

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script type="text/javascript" src="/js/CFS.Snow.min.js"></script>
    <!-- 点击爆灯效果 -->
    <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
    <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
    <script type="text/javascript" src="/js/fireworks.js"></script>
    <!--动态线条背景-->
    <script type="text/javascript"
        color="122 103 238" opacity='0.7' zIndex="-2" count="200" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
    </script>
    <!-- 天气 -->
    <!-- weather -->
    <!-- weather -->
    <script type="text/javascript">
         WIDGET = {FID: 'knAMQaFanP'}
    </script>
    <script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script>
    <script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script>
    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    

    
    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon-refresh.min.js" async="async"></script>
    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    
    <!-- {% include '_custom/custom.swig' %} -->

</body>

</html>
