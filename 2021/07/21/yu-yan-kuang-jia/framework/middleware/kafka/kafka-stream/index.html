<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="kafka_Stream, AIOT,Space&amp;Temporal Sequence Analysis,SpringBoot,liudongdong1,cloud">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>kafka_Stream | DaybyDay</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="DaybyDay" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">DaybyDay</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">

      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>About</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/about">
          
          <i class="fas fa-user-circle" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>about</span>
        </a>
      </li>
      
      <li>
        <a href="/resume">
          
          <i class="fa fa-user-secret" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>resume</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/gallery" class="waves-effect waves-light">
      
      <i class="fas fa-camera" style="zoom: 0.6;"></i>
      
      <span>Galleries</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">DaybyDay</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-user-circle"></i>
			
			About
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/about " style="margin-left:75px">
				  
				   <i class="fa fas fa-user-circle" style="position: absolute;left:50px" ></i>
			      
		          <span>about</span>
                  </a>
                </li>
              
                <li>

                  <a href="/resume " style="margin-left:75px">
				  
				   <i class="fa fa fa-user-secret" style="position: absolute;left:50px" ></i>
			      
		          <span>resume</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/gallery" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-camera"></i>
			
			Galleries
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/liudongdong1" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/liudongdong1" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.stocksnap.io/img-thumbs/280h/spider-web_A1MWQJDC12.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">kafka_Stream</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    .toc-fixed .toc-link::before{
        position: fixed!important;/*当toc的位置改为fixed时，.toc-link::before也要改为fixed*/
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Framework/">
                                <span class="chip bg-color">Framework</span>
                            </a>
                        
                            <a href="/tags/middleware/">
                                <span class="chip bg-color">middleware</span>
                            </a>
                        
                            <a href="/tags/kafka/">
                                <span class="chip bg-color">kafka</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E8%AF%AD%E8%A8%80%E6%A1%86%E6%9E%B6/" class="post-category">
                                语言框架
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2021-07-21
                </div>
                

                <!-- 
                    <i class="fa fa-pencil"></i> Author: liudongdong1
                  -->

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>Update Date:&nbsp;&nbsp;
                    2021-07-25
                </div>
                

                <!-- 
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>Word Count:&nbsp;&nbsp;
                    8.6k
                </div>
                 -->

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>Read Times:&nbsp;&nbsp;
                    34 Min
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>Read Count:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>From: <a href="http://www.jasongj.com/kafka/kafka_stream/" target="_blank" rel="noopener">http://www.jasongj.com/kafka/kafka_stream/</a></p>
<h1 id="一、Kafka-Stream背景"><a href="#一、Kafka-Stream背景" class="headerlink" title="一、Kafka Stream背景"></a>一、Kafka Stream背景</h1><h2 id="1-Kafka-Stream是什么"><a href="#1-Kafka-Stream是什么" class="headerlink" title="1. Kafka Stream是什么"></a>1. Kafka Stream是什么</h2><p>Kafka Stream是Apache Kafka从0.10版本引入的一个新Feature。它是<code>提供了对存储于Kafka内的数据进行流式处理和分析的功能</code>。</p>
<p>Kafka Stream的特点如下：</p>
<ul>
<li>Kafka Stream提供了一个非常简单而轻量的Library，它可以非常<code>方便地嵌入任意Java应用中，也可以任意方式打包和部署</code></li>
<li><code>除了Kafka外，无任何外部依赖</code></li>
<li>充分<code>利用Kafka分区机制实现水平扩展和顺序性保证</code></li>
<li>通过可容错的state store实现高效的状态操作（如windowed join和aggregation）</li>
<li>支持<code>正好一次处理语义</code></li>
<li>提供<code>记录级的处理能力，从而实现毫秒级的低延迟</code></li>
<li>支持<code>基于事件时间的窗口操作，并且可处理晚到的数据（late arrival of records）</code></li>
<li>同时<code>提供底层的处理原语Processor（类似于Storm的spout和bolt）</code>，以及<code>高层抽象的DSL（类似于Spark的map/group/reduce）</code></li>
</ul>
<h2 id="2-什么是流式计算"><a href="#2-什么是流式计算" class="headerlink" title="2. 什么是流式计算"></a>2. 什么是流式计算</h2><p>一般流式计算会与批量计算相比较。在流式计算模型中，输入是持续的，可以认为在时间上是无界的，也就意味着，永远拿不到全量数据去做计算。同时，计算结果是持续输出的，也即计算结果在时间上也是无界的。流式计算一般对实时性要求较高，同时一般是先定义目标计算，然后数据到来之后将计算逻辑应用于数据。同时为了提高计算效率，往往尽可能采用增量计算代替全量计算。</p>
<p><img src="https://gitee.com/github-25970295/blogpictureV2/raw/master/963903-20180823011917613-280268935.png" alt=""></p>
<p>批量处理模型中，一般先有全量数据集，然后定义计算逻辑，并将计算应用于全量数据。特点是全量计算，并且计算结果一次性全量输出。</p>
<p><img src="https://gitee.com/github-25970295/blogpictureV2/raw/master/963903-20180823011948353-603485187.png" alt=""></p>
<h2 id="3-为什么要有Kafka-Stream"><a href="#3-为什么要有Kafka-Stream" class="headerlink" title="3. 为什么要有Kafka Stream"></a>3. 为什么要有Kafka Stream</h2><p>当前已经有非常多的流式处理系统，最知名且应用最多的开源流式处理系统有<code>Spark Streaming</code>和<code>Apache Storm</code>。Apache Storm发展多年，应用广泛，提供记录级别的处理能力，当前也支持SQL on Stream。而Spark Streaming基于Apache Spark，可以非常方便与图计算，SQL处理等集成，功能强大，对于熟悉其它Spark应用开发的用户而言使用门槛低。另外，目前主流的Hadoop发行版，如MapR，Cloudera和Hortonworks，都集成了Apache Storm和Apache Spark，使得部署更容易。</p>
<p>既然Apache Spark与Apache Storm拥用如此多的优势，那为何还需要Kafka Stream呢？笔者认为主要有如下原因。</p>
<p>第一，<code>Spark和Storm都是流式处理框架，而Kafka Stream提供的是一个基于Kafka的流式处理类库</code><strong>。框架要求开发者按照特定的方式去开发逻辑部分，供框架调用。开发者很难了解框架的具体运行方式，从而使得调试成本高，并且使用受限。而Kafka Stream作为流式处理</strong>类库**，直接提供具体的类给开发者调用，<code>整个应用的运行方式主要由开发者控制，方便使用和调试。</code></p>
<p><img src="https://gitee.com/github-25970295/blogpictureV2/raw/master/963903-20180823012034870-605607318.png" alt=""></p>
<p>第二，虽然Cloudera与Hortonworks方便了Storm和Spark的部署，但是这些框架的<code>部署</code>仍然相对复杂。而Kafka Stream作为类库，可以非常方便的嵌入应用程序中，它对应用的打包和部署基本没有任何要求。更为重要的是，Kafka Stream充分利用了<a href="http://www.jasongj.com/2015/03/10/KafkaColumn1/#Topic-amp-Partition" target="_blank" rel="noopener">Kafka的分区机制</a>和<a href="http://www.jasongj.com/2015/08/09/KafkaColumn4/#High-Level-Consumer-Rebalance" target="_blank" rel="noopener">Consumer的Rebalance机制</a>，使得Kafka Stream可以<code>非常方便的水平扩展</code>，<code>并且各个实例可以使用不同的部署方式</code>。具体来说，每个运行Kafka Stream的应用程序实例都包含了Kafka Consumer实例，多个同一应用的实例之间并行处理数据集。而不同实例之间的部署方式并不要求一致，比如部分实例可以运行在Web容器中，部分实例可运行在Docker或Kubernetes中。</p>
<p>第三，<code>就流式处理系统而言，基本都支持Kafka作为数据源</code>。例如Storm具有专门的kafka-spout，而Spark也提供专门的spark-streaming-kafka模块。事实上，Kafka基本上是主流的流式处理系统的标准数据源。换言之，大部分流式系统中都已部署了Kafka，此时<code>使用Kafka Stream的成本非常低</code>。</p>
<p>第四，使用Storm或Spark Streaming时，需要为框架本身的进程预留资源，如Storm的supervisor和Spark on YARN的node manager。即使对于应用实例而言，<code>框架本身也会占用部分资源</code>，如Spark Streaming需要为shuffle和storage预留内存。</p>
<p>第五，由于<code>Kafka本身提供数据持久化</code>，因此Kafka Stream<code>提供滚动部署和滚动升级以及重新计算的能力。</code></p>
<p>第六，由于Kafka Consumer Rebalance机制，<code>Kafka Stream可以在线动态调整并行度。</code></p>
<h1 id="二、Kafka-Stream架构"><a href="#二、Kafka-Stream架构" class="headerlink" title="二、Kafka Stream架构"></a>二、Kafka Stream架构</h1><h2 id="1-Kafka-Stream整体架构"><a href="#1-Kafka-Stream整体架构" class="headerlink" title="1. Kafka Stream整体架构"></a>1. Kafka Stream整体架构</h2><p><img src="https://gitee.com/github-25970295/blogpictureV2/raw/master/963903-20180823012221127-657291327.png" alt=""></p>
<pre class=" language-java"><code class="language-java">KStream<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> stream <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token string">"words-stream"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
KTable<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> table <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">"words-table"</span><span class="token punctuation">,</span> <span class="token string">"words-store"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>另外，上图中的Consumer和Producer并不需要开发者在应用中显示实例化，而是<code>由Kafka Stream根据参数隐式实例化和管理</code>，从而降低了使用门槛。<code>开发者只需要专注于开发核心业务逻辑，也即上图中Task内的部分</code>。</p>
<h2 id="2-Processor-Topology"><a href="#2-Processor-Topology" class="headerlink" title="2. Processor Topology"></a>2. Processor Topology</h2><p>基于Kafka Stream的流式应用的业务逻辑<code>全部通过一个被称为Processor Topology的地方执行</code>。它与Storm的Topology和Spark的DAG类似，都定义了数据在各个处理单元（在Kafka Stream中被称作Processor）间的流动方式，或者说定义了数据的处理逻辑。</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WordCountProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">Processor</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> ProcessorContext context<span class="token punctuation">;</span>
    <span class="token keyword">private</span> KeyValueStore<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> kvStore<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token comment" spellcheck="true">//init()方法：可以获取ProcessorContext实例，用来维护当前上下文；通过上下文ProcessorContext得到状态仓库实例以及使用上下文用于基于时间推移周期性的执行；</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>ProcessorContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>kvStore <span class="token operator">=</span> <span class="token punctuation">(</span>KeyValueStore<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getStateStore</span><span class="token punctuation">(</span><span class="token string">"Counts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//process方法：用于对收到的数据集执行对状态仓库的操作；</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span> String value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Stream<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>String word<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
            Optional<span class="token operator">&lt;</span>Integer<span class="token operator">></span> counts <span class="token operator">=</span> Optional<span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>kvStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> count <span class="token operator">=</span> counts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>wordcount <span class="token operator">-</span><span class="token operator">></span> wordcount <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            kvStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">punctuate</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">//punctuate():用于基于时间推移周期性执行；</span>
        KeyValueIterator<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> iterator <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>kvStore<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        iterator<span class="token punctuation">.</span><span class="token function">forEachRemaining</span><span class="token punctuation">(</span>entry <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
            context<span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>key<span class="token punctuation">,</span> entry<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>kvStore<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>   <span class="token comment" spellcheck="true">//close:关闭相应资源操作</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>kvStore<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<ul>
<li><code>process定义了对每条记录的处理逻辑</code>，也印证了Kafka可具有记录级的数据处理能力。</li>
<li>context.scheduler定义了<code>punctuate被执行的周期</code>，从而提供了实现窗口操作的能力。</li>
<li>context.getStateStore提供的<code>状态存储为有状态计算（如窗口，聚合）提供了可能。</code></li>
</ul>
<h2 id="3-Kafka-Stream并行模型"><a href="#3-Kafka-Stream并行模型" class="headerlink" title="3. Kafka Stream并行模型"></a>3. Kafka Stream并行模型</h2><p>Kafka Stream的并行模型中，<code>最小粒度为Task</code>，而<code>每个Task包含一个特定子Topology的所有Processor</code>。因此每个Task所执行的代码完全一样，唯一的不同在于所处理的数据集互补。这一点跟Storm的Topology完全不一样。Storm的Topology的每一个Task只包含一个Spout或Bolt的实例。因此Storm的一个Topology内的不同Task之间需要通过网络通信传递数据，而Kafka Stream的Task包含了完整的子Topology，所以<code>Task之间不需要传递数据，也就不需要网络通信</code>。这一点降低了系统复杂度，也提高了处理效率。</p>
<p>如果某个Stream的输入Topic有多个(比如2个Topic，1个Partition数为4，另一个Partition数为3)，则总的Task数等于Partition数最多的那个Topic的Partition数（max(4,3)=4）。这是因为Kafka Stream使用了Consumer的Rebalance机制，每个Partition对应一个Task。</p>
<p>下图展示了在一个进程（Instance）中<code>以2个Topic（Partition数均为4）为数据源的Kafka Stream应用的并行模型。</code>从图中可以看到，由于Kafka Stream应用的默认线程数为1，所以4个Task全部在一个线程中运行。</p>
<p><img src="https://gitee.com/github-25970295/blogpictureV2/raw/master/963903-20180823012423201-1891805178.png" alt=""></p>
<p>为了充分利用多线程的优势，可以设置Kafka Stream的线程数。下图展示了线程数为2时的并行模型。</p>
<p><img src="https://gitee.com/github-25970295/blogpictureV2/raw/master/963903-20180823012446423-1214824884.png" alt=""></p>
<p>前文有提到，Kafka Stream可被嵌入任意Java应用（理论上基于JVM的应用都可以）中，下图展示了在<code>同一台机器的不同进程中同时启动同一Kafka Stream应用时的并行模型</code>。注意，这里要保证两个进程的StreamsConfig.<code>APPLICATION_ID_CONFIG完全一样</code>。因为<code>Kafka Stream将APPLICATION_ID_CONFIG作为隐式启动的Consumer的Group ID</code>。只有保证APPLICATION_ID_CONFIG相同，才能保证这两个进程的Consumer属于同一个Group，从而可以通过Consumer Rebalance机制拿到互补的数据集。</p>
<p><img src="https://gitee.com/github-25970295/blogpictureV2/raw/master/963903-20180823012616004-1473262041.png" alt=""></p>
<p>既然实现了多进程部署，可以以同样的方式实现多机器部署。该部署方式也要求所有进程的APPLICATION_ID_CONFIG完全一样。从图上也可以看到，每个实例中的线程数并不要求一样。但是无论如何部署，Task总数总会保证一致。</p>
<p><img src="https://gitee.com/github-25970295/blogpictureV2/raw/master/963903-20180823012703011-1321655264.png" alt=""></p>
<p>这里对比一下Kafka Stream的Processor Topology与Storm的Topology。</p>
<ul>
<li><code>Storm的Topology由Spout和Bolt组成，Spout提供数据源，而Bolt提供计算和数据导出</code>。Kafka Stream的Processor Topology完全<code>由Processor组成，因为它的数据固定由Kafka的Topic提供</code>。</li>
<li>Storm的不同Bolt运行在不同的Executor中，很可能位于不同的机器，需要通过网络通信传输数据。而Kafka Stream的Processor Topology的<code>不同Processor完全运行于同一个Task中</code>，也就完全处于同一个线程，无需网络通信。</li>
<li>Storm的Topology可以同时包含Shuffle部分和非Shuffle部分，并且往往一个Topology就是一个完整的应用。而Kafka Stream的一个物理Topology只包含非Shuffle部分，而Shuffle部分需要通过through操作显示完成，该操作将一个大的Topology分成了2个子Topology。</li>
<li>Storm的Topology内，不同Bolt/Spout的并行度可以不一样，而Kafka Stream的子Topology内，所有Processor的并行度完全一样。</li>
<li>Storm的一个Task只包含一个Spout或者Bolt的实例，而<code>Kafka Stream的一个Task包含了一个子Topology的所有Processor。</code></li>
</ul>
<h2 id="4-KTable-vs-KStream"><a href="#4-KTable-vs-KStream" class="headerlink" title="4. KTable vs. KStream"></a>4. KTable vs. KStream</h2><p><code>KTable和KStream</code>是Kafka Stream中非常重要的两个概念，它们是Kafka实现各种语义的基础。因此这里有必要分析下二者的区别。</p>
<ul>
<li><p><code>KStream是一个数据流</code>，可以认为<code>所有记录都通过Insert only的方式插入进这个数据流里</code>。</p>
</li>
<li><p><code>KTable代表一个完整的数据集</code>，可以<code>理解为数据库中的表</code>。由于每条记录都是Key-Value对，这里可以将Key理解为数据库中的Primary Key，而Value可以理解为一行记录。可以认为KTable中的数据都是<code>通过Update only的方式进入的</code>。也就意味着，<code>如果KTable对应的Topic中新进入的数据的Key已经存在，那么从KTable只会取出同一Key对应的最后一条数据，相当于新的数据更新了旧的数据。</code></p>
</li>
</ul>
<p>以下图为例，假设有一个KStream和KTable，基于同一个Topic创建，并且该Topic中包含如下图所示5条数据。此时遍历KStream将得到与Topic内数据完全一样的所有5条数据，且顺序不变。而此时遍历KTable时，因为这5条记录中有3个不同的Key，所以将得到3条记录，每个Key对应最新的值，并且这三条数据之间的顺序与原来在Topic中的顺序保持一致。这一点与Kafka的日志compact相同。</p>
<p><img src="https://gitee.com/github-25970295/blogpictureV2/raw/master/963903-20180823012822162-142241598.png" alt=""></p>
<p>此时如果对该KStream和KTable分别基于key做Group，对Value进行Sum，得到的结果将会不同。对KStream的计算结果是&lt;Jack，4&gt;，&lt;Lily，7&gt;，&lt;Mike，4&gt;。而对Ktable的计算结果是&lt;Mike，4&gt;，&lt;Jack，3&gt;，&lt;Lily，5&gt;。</p>
<h2 id="5-State-store"><a href="#5-State-store" class="headerlink" title="5. State store"></a>5. State store</h2><p>流式处理中，部分操作是无状态的，例如过滤操作（Kafka Stream DSL中用<code>filer</code>方法实现）。而部分操作是有状态的，需要记录中间状态，如Window操作和聚合计算。<code>State store被用来存储中间状态。它可以是一个持久化的Key-Value存储，也可以是内存中的HashMap，或者是数据库。Kafka提供了基于Topic的状态存储。</code></p>
<h1 id="三、Kafka-Stream如何解决流式系统中关键问题"><a href="#三、Kafka-Stream如何解决流式系统中关键问题" class="headerlink" title="三、Kafka Stream如何解决流式系统中关键问题"></a>三、Kafka Stream如何解决流式系统中关键问题</h1><h2 id="1-时间"><a href="#1-时间" class="headerlink" title="1. 时间"></a>1. 时间</h2><p>在流式数据处理中，<code>时间是数据的一个非常重要的属性</code>。从<code>Kafka 0.10开始</code>，每条记录除了Key和Value外，还增加了timestamp属性。目前Kafka Stream支持三种时间</p>
<ul>
<li><strong>事件发生时间</strong>。事件发生的时间，包含在数据记录中。发生时间<code>由Producer在构造ProducerRecord时指定</code>。并且<code>需要Broker或者Topic将message.timestamp.type设置为CreateTime（默认值）才能生效。</code></li>
<li><strong>消息接收时间</strong>。也即<code>消息存入Broker的时间</code>。当<code>Broker或Topic将message.timestamp.type设置为LogAppendTime时生效</code>。此时Broker会在<code>接收到消息后，存入磁盘前</code>，将其timestamp属性值设置为当前机器时间。一般消息接收时间比较接近于事件发生时间，部分场景下可代替事件发生时间。</li>
<li><strong>消息处理时间</strong>。也即Kafka Stream<code>处理消息时的时间</code>。</li>
</ul>
<blockquote>
<p>注：Kafka Stream允许通过实现org.apache.kafka.streams.processor.TimestampExtractor接口自定义记录时间。</p>
</blockquote>
<h2 id="2-窗口"><a href="#2-窗口" class="headerlink" title="2. 窗口"></a>2. 窗口</h2><p>流式数据是在时间上无界的数据。而聚合操作只能作用在特定的数据集，也即有界的数据集上。因此需要通过某种方式从无界的数据集上按特定的语义选取出有界的数据。窗口是一种非常常用的设定计算边界的方式。不同的流式处理系统支持的窗口类似，但不尽相同。</p>
<p>Kafka Stream支持的窗口如下。</p>
<p>（1）<strong>Hopping Time Window</strong> 该窗口定义如下图所示。它有两个属性，一个是<code>Window size，一个是Advance interval</code>。<code>Window size指定了窗口的大小</code>，也即每次计算的数据集的大小。而<code>Advance interval定义输出的时间间隔</code>。一个典型的应用场景是，每隔5秒钟输出一次过去1个小时内网站的PV或者UV。</p>
<p><img src="https://images2018.cnblogs.com/blog/963903/201808/963903-20180823013127357-1860834711.gif" alt="img"></p>
<p>（2）<strong>Tumbling Time Window</strong>该窗口定义如下图所示。可以认为它是Hopping Time Window的一种特例，也即<strong>Window size和Advance interval相等</strong>。它的特点是各个Window之间完全不相交。</p>
<p><img src="https://images2018.cnblogs.com/blog/963903/201808/963903-20180823013225516-1830552448.gif" alt="img"></p>
<p>（3）<strong>Sliding Window</strong> 该窗口<code>只用于2个KStream进行Join计算时</code>。该窗口的大小定义<code>了Join两侧KStream的数据记录被认为在同一个窗口的最大时间差</code>。假设该窗口的大小为5秒，则参与Join的2个KStream中，记录时间差小于5的记录被认为在同一个窗口中，可以进行Join计算。</p>
<p>（4）<strong>Session Window</strong>该窗口用于对Key做Group后的聚合操作中。它需要对Key做分组，然后对组内的数据根据业务需求定义一个窗口的起始点和结束点。一个典型的案例是，希望通过Session Window计算某个用户访问网站的时间。对于一个特定的用户（用Key表示）而言，当发生登录操作时，该用户（Key）的窗口即开始，当发生退出操作或者超时时，该用户（Key）的窗口即结束。窗口结束时，可计算该用户的访问时间或者点击次数等。</p>
<h2 id="3-Join"><a href="#3-Join" class="headerlink" title="3. Join"></a>3. Join</h2><p>Kafka Stream由于包含<code>KStream</code>和<code>Ktable</code>两种数据集，因此提供如下Join计算</p>
<ul>
<li><code>KTable Join KTable 结果仍为KTable</code>。任意一边有更新，结果KTable都会更新。</li>
<li><code>KStream Join KStream 结果为KStream</code>。必须带窗口操作，否则会造成Join操作一直不结束。</li>
<li><code>KStream Join KTable / GlobalKTable 结果为KStream</code>。只有当KStream中有新数据时，才会触发Join计算并输出结果。KStream无新数据时，KTable的更新并不会触发Join计算，也不会输出数据。并且该更新只对下次Join生效。一个典型的使用场景是，KStream中的订单信息与KTable中的用户信息做关联计算。</li>
</ul>
<p><code>对于Join操作，如果要得到正确的计算结果，需要保证参与Join的KTable或KStream中Key相同的数据被分配到同一个Task</code>。具体方法是</p>
<ul>
<li>参与Join的KTable或KStream的<code>Key类型相同</code>（实际上，业务含意也应该相同）</li>
<li>参与Join的KTable或KStream<code>对应的Topic的Partition数相同</code></li>
<li>Partitioner策略的最终结果等效（实现不需要完全一样，只要效果一样即可），也即Key相同的情况下，被分配到ID相同的Partition内</li>
</ul>
<p>如果上述条件不满足，可通过调用如下方法使得它满足上述条件。</p>
<pre class=" language-java"><code class="language-java">KStream<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> <span class="token function">through</span><span class="token punctuation">(</span>Serde<span class="token operator">&lt;</span>K<span class="token operator">></span> keySerde<span class="token punctuation">,</span> Serde<span class="token operator">&lt;</span>V<span class="token operator">></span> valSerde<span class="token punctuation">,</span> StreamPartitioner<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> partitioner<span class="token punctuation">,</span> String topic<span class="token punctuation">)</span></code></pre>
<h2 id="4-聚合与乱序处理"><a href="#4-聚合与乱序处理" class="headerlink" title="4. 聚合与乱序处理"></a>4. 聚合与乱序处理</h2><p>聚合操作可应用于KStream和KTable。当<code>聚合发生在KStream上时必须指定窗口，从而限定计算的目标数据集。</code></p>
<p>需要说明的是，聚合操作的<code>结果肯定是KTable</code>。因为KTable是可更新的，可以在晚到的数据到来时（也即发生数据乱序时）更新结果KTable。</p>
<p>但需要说明的是，<code>Kafka Stream并不会对所有晚到的数据都重新计算并更新结果集</code>，而是让用户设置一个<code>retention period</code>，将每个窗口的结果集在内存中保留一定时间，该窗口内的数据晚到时，直接合并计算，并更新结果KTable。超过<code>retention period</code>后，该窗口结果将从内存中删除，并且晚到的数据即使落入窗口，也会被直接丢弃。</p>
<h2 id="5-容错"><a href="#5-容错" class="headerlink" title="5. 容错"></a>5. 容错</h2><p>Kafka Stream从如下几个方面进行容错</p>
<ul>
<li><code>高可用的Partition保证无数据丢失</code>。每个Task计算一个Partition，而Kafka数据复制机制保证了Partition内数据的高可用性，故无数据丢失风险。同时由于数据是持久化的，即使任务失败，依然可以重新计算。</li>
<li><code>状态存储实现快速故障恢复和从故障点继续处理</code>。对于Join和聚合及窗口等有状态计算，状态存储可保存中间状态。即使发生Failover或Consumer Rebalance，仍然可以通过状态存储恢复中间状态，从而可以继续从Failover或Consumer Rebalance前的点继续计算。</li>
<li><code>KTable与retention period提供了对乱序数据的处理能力</code>。</li>
</ul>
<h1 id="四、Kafka-Stream应用示例"><a href="#四、Kafka-Stream应用示例" class="headerlink" title="四、Kafka Stream应用示例"></a>四、Kafka Stream应用示例</h1><ul>
<li><strong>创建KTable和KStream</strong></li>
</ul>
<pre class=" language-java"><code class="language-java">StreamsBuilder builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamsBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//StreamsBuilder.table(final String topic)创建KTable实例的同时，内部会创建一个StateStore来跟踪流的状态，但它不可用于交互式查询。</span>
<span class="token comment" spellcheck="true">// 创建KTable实例</span>
KTable<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> StockTickerData<span class="token operator">></span> stockTickerTable <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">"stock-ticker-table"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 创建KStream实例</span>
KStream<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> StockTickerData<span class="token operator">></span> stockTickerStream <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token string">"stock-ticker-stream"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 打印结果到控制台</span>
stockTickerTable<span class="token punctuation">.</span><span class="token function">toStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>Printed<span class="token punctuation">.</span>&lt;String<span class="token punctuation">,</span> StockTickerData<span class="token operator">></span><span class="token function">toSysOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withLabel</span><span class="token punctuation">(</span><span class="token string">"Stocks-KTable"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stockTickerStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>Printed<span class="token punctuation">.</span>&lt;String<span class="token punctuation">,</span> StockTickerData<span class="token operator">></span><span class="token function">toSysOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withLabel</span><span class="token punctuation">(</span><span class="token string">"Stocks-KStream"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<ul>
<li><strong>属性配置</strong></li>
</ul>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//application id相当于group id，bootstrap servers配置kafka的brokers地址，并配置key与value的序列化、反序列化实现类。</span>
Properties props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>StreamsConfig<span class="token punctuation">.</span>APPLICATION_ID_CONFIG<span class="token punctuation">,</span> <span class="token string">"streams-pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>StreamsConfig<span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> <span class="token string">"localhost:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>StreamsConfig<span class="token punctuation">.</span>DEFAULT_KEY_SERDE_CLASS_CONFIG<span class="token punctuation">,</span> Serdes<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>StreamsConfig<span class="token punctuation">.</span>DEFAULT_VALUE_SERDE_CLASS_CONFIG<span class="token punctuation">,</span> Serdes<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<ul>
<li><strong>读取并处理输出</strong></li>
</ul>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//最后通过StreamsBuilder来创建KStream，进行数据处理转换后输出到一个新的topic或者其他外部存储器中。</span>
builder<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token string">"streams-plaintext-input"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token string">"streams-pipe-output"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> Topology topology <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> KafkaStreams streams <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaStreams</span><span class="token punctuation">(</span>topology<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<ul>
<li><strong>推出时处理逻辑</strong></li>
</ul>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// attach shutdown handler to catch control-c</span>
Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addShutdownHook</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token string">"streams-shutdown-hook"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> streams<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> cc<span class="token punctuation">.</span>gmem<span class="token punctuation">.</span>study<span class="token punctuation">.</span>kafka<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span>Serdes<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>streams<span class="token punctuation">.</span>KafkaStreams<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>streams<span class="token punctuation">.</span>StreamsBuilder<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>streams<span class="token punctuation">.</span>StreamsConfig<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>streams<span class="token punctuation">.</span>kstream<span class="token punctuation">.</span>KStream<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>streams<span class="token punctuation">.</span>kstream<span class="token punctuation">.</span>KTable<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>streams<span class="token punctuation">.</span>kstream<span class="token punctuation">.</span>Materialized<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>streams<span class="token punctuation">.</span>kstream<span class="token punctuation">.</span>Produced<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>LogManager<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>Logger<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Arrays<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Properties<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>TimeUnit<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NameCountApplication</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Logger LOGGER <span class="token operator">=</span> LogManager<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span> NameCountApplication<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span> <span class="token keyword">final</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        Properties config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 应用的标识符，不同的实例依据此标识符相互发现</span>
        config<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span> StreamsConfig<span class="token punctuation">.</span>APPLICATION_ID_CONFIG<span class="token punctuation">,</span> <span class="token string">"names-counter-application"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 启动时使用的Kafka服务器</span>
        config<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span> StreamsConfig<span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> <span class="token string">"kafka-1.gmem.cc:9092"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 键值串行化类</span>
        config<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span> StreamsConfig<span class="token punctuation">.</span>DEFAULT_KEY_SERDE_CLASS_CONFIG<span class="token punctuation">,</span> Serdes<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span> StreamsConfig<span class="token punctuation">.</span>DEFAULT_VALUE_SERDE_CLASS_CONFIG<span class="token punctuation">,</span> Serdes<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// High Level DSL for building topologies</span>
        StreamsBuilder builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamsBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// KStream是记录（KeyValue）流的抽象</span>
        KStream<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> nameBatches <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span> <span class="token string">"names"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        KTable<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Long<span class="token operator">></span> nameCounts <span class="token operator">=</span> nameBatches
            <span class="token comment" spellcheck="true">// 一到多映射，分割字符串</span>
            <span class="token punctuation">.</span><span class="token function">flatMapValues</span><span class="token punctuation">(</span> nameBatch <span class="token operator">-</span><span class="token operator">></span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span> nameBatch<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span> <span class="token string">"\\W+"</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// 根据人名分组</span>
            <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> key<span class="token punctuation">,</span> name <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> name <span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// 进行聚合，结果存放到StateStore中</span>
            <span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span> Materialized<span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span> <span class="token string">"names-count-store"</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 输出到目标</span>
        nameCounts<span class="token punctuation">.</span><span class="token function">toStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span> <span class="token string">"names-count"</span><span class="token punctuation">,</span> Produced<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span> Serdes<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Serdes<span class="token punctuation">.</span><span class="token function">Long</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 构建流处理程序并启动</span>
        KafkaStreams streams <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaStreams</span><span class="token punctuation">(</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> config <span class="token punctuation">)</span><span class="token punctuation">;</span>
        LOGGER<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span> <span class="token string">"Prepare to start stream processing."</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        streams<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        TimeUnit<span class="token punctuation">.</span>DAYS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 阻塞主线程</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h1 id="五、API"><a href="#五、API" class="headerlink" title="五、API"></a>五、API</h1><h2 id="1-Topology"><a href="#1-Topology" class="headerlink" title="1. Topology"></a>1. Topology</h2><pre class=" language-java"><code class="language-java">Topology topology <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Topology</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 指定拓扑的输入，也就是Kafka主题</span>
topology<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span> <span class="token string">"SOURCE"</span><span class="token punctuation">,</span> <span class="token string">"src-topic"</span> <span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 添加一个处理器PROCESS1，其上游为拓扑输入（通过名称引用）</span>
        <span class="token punctuation">.</span><span class="token function">addProcessor</span><span class="token punctuation">(</span> <span class="token string">"PROCESS1"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">Processor1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"SOURCE"</span> <span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 添加另一个处理器PROCESS2，以PROCESS1为上游</span>
        <span class="token punctuation">.</span><span class="token function">addProcessor</span><span class="token punctuation">(</span> <span class="token string">"PROCESS2"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">Processor2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"PROCESS1"</span> <span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 添加另一个处理器PROCESS3，仍然以PROCESS1为上游，注意拓扑分叉了</span>
        <span class="token punctuation">.</span><span class="token function">addProcessor</span><span class="token punctuation">(</span> <span class="token string">"PROCESS3"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">Processor3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"PROCESS1"</span> <span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 添加一个输出处理器，输出到sink-topic1，以PROCESS1为上游</span>
        <span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span> <span class="token string">"SINK1"</span><span class="token punctuation">,</span> <span class="token string">"sink-topic1"</span><span class="token punctuation">,</span> <span class="token string">"PROCESS1"</span> <span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 添加一个输出处理器，输出到sink-topic2，以PROCESS2为上游</span>
        <span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span> <span class="token string">"SINK2"</span><span class="token punctuation">,</span> <span class="token string">"sink-topic2"</span><span class="token punctuation">,</span> <span class="token string">"PROCESS2"</span> <span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 添加一个输出处理器，输出到sink-topic3，以PROCESS3为上游</span>
        <span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span> <span class="token string">"SINK3"</span><span class="token punctuation">,</span> <span class="token string">"sink-topic3"</span><span class="token punctuation">,</span> <span class="token string">"PROCESS3"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h2 id="2-Processor"><a href="#2-Processor" class="headerlink" title="2.Processor"></a>2.Processor</h2><blockquote>
<p>该接口用于定义一个流处理器，也就是<code>处理器拓扑中的节点</code>。流处理器以参数化类型的方式限定了<code>其键、值的类型</code>。你可以定义任意数量的流处理器，并且连同它们关联的状态存储一起，组装出拓扑。Processor.process()方法针对收到的每一个记录进行处理。<code>Processor.init()方法实例化了一个ProcessorContext</code>，流处理器可以调用上下文：</p>
<ol>
<li><code>context().schedule，调度一个Punctuation函数，周期性执行</code></li>
<li><code>context().forward，转发新的或者被修改的键值对给下游处理器</code></li>
<li><code>context().commit，提交当前处理进度</code></li>
</ol>
</blockquote>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> cc<span class="token punctuation">.</span>gmem<span class="token punctuation">.</span>study<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>streams<span class="token punctuation">.</span>low<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>streams<span class="token punctuation">.</span>KeyValue<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>streams<span class="token punctuation">.</span>processor<span class="token punctuation">.</span>Processor<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>streams<span class="token punctuation">.</span>processor<span class="token punctuation">.</span>ProcessorContext<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>streams<span class="token punctuation">.</span>processor<span class="token punctuation">.</span>PunctuationType<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>streams<span class="token punctuation">.</span>state<span class="token punctuation">.</span>KeyValueIterator<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>streams<span class="token punctuation">.</span>state<span class="token punctuation">.</span>KeyValueStore<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NameCounterProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">Processor</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> ProcessorContext context<span class="token punctuation">;</span>
    <span class="token keyword">private</span> KeyValueStore<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Long<span class="token operator">></span> kvStore<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span> ProcessorContext context <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 保存引用，类似于Storm的TopologyContext</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 从上下文中取回一个状态存储</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>kvStore <span class="token operator">=</span> <span class="token punctuation">(</span>KeyValueStore<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Long<span class="token operator">></span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getStateStore</span><span class="token punctuation">(</span> <span class="token string">"NameCounts"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 以墙上时间为准，每秒执行Punctuator逻辑</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span> <span class="token number">1000</span><span class="token punctuation">,</span> PunctuationType<span class="token punctuation">.</span>WALL_CLOCK_TIME<span class="token punctuation">,</span> timestamp <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
            NameCounterProcessor<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">punctuate</span><span class="token punctuation">(</span> timestamp <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">/**
     * 接收一个记录（人名列表）并处理
     *
     * @param dummy 记录的键，无用
     * @param line  记录的值
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span> String dummy<span class="token punctuation">,</span> String line <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> names <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span> <span class="token string">" "</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 在键值存储中更新人名计数</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span> String name <span class="token operator">:</span> names <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Long oldCount <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>kvStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span> name <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> oldCount <span class="token operator">==</span> null <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>kvStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span> name<span class="token punctuation">,</span> 1L <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>kvStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span> name<span class="token punctuation">,</span> oldCount <span class="token operator">+</span> 1L <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">punctuate</span><span class="token punctuation">(</span> <span class="token keyword">long</span> timestamp <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 获得键值存储的迭代器</span>
        KeyValueIterator<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Long<span class="token operator">></span> iter <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>kvStore<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span> iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            KeyValue<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Long<span class="token operator">></span> entry <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 转发记录给下游处理器</span>
            context<span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span> entry<span class="token punctuation">.</span>key<span class="token punctuation">,</span> entry<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">/**
         * 调用者必须要负责关闭状态存储上的迭代器
         * 否则可能（取决于底层状态存储的实现）导致内存、文件句柄的泄漏
         */</span>
        iter<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 请求提交当前流状态（消费进度）</span>
        context<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 在此关闭所有持有的资源，但是状态存储不需要关闭，由Kafka Stream自己维护其生命周期</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="3-StateStore"><a href="#3-StateStore" class="headerlink" title="3. StateStore"></a>3. <strong>StateStore</strong></h2><h4 id="1-使用状态存储"><a href="#1-使用状态存储" class="headerlink" title=".1. 使用状态存储"></a>.1. 使用状态存储</h4><blockquote>
<p>使用状态存储: 要位拓扑中每个Processor提供状态存储，调用：</p>
</blockquote>
<pre class=" language-java"><code class="language-java">Topology topology <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Topology</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
topology<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token string">"Source"</span><span class="token punctuation">,</span> <span class="token string">"source-topic"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">addProcessor</span><span class="token punctuation">(</span><span class="token string">"Process"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">WordCountProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Source"</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 为处理器Process提供一个状态存储 </span>
    <span class="token punctuation">.</span><span class="token function">addStateStore</span><span class="token punctuation">(</span>countStoreSupplier<span class="token punctuation">,</span> <span class="token string">"Process"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h4 id="2-changelog"><a href="#2-changelog" class="headerlink" title="2. changelog"></a>2. changelog</h4><blockquote>
<p>为了支持容错、支持<code>无数据丢失的状态迁移</code>， 状态存储可以<code>持续不断的、在后台备份到Kafka主题中</code>。上述用于主题被称为状态存储的changelog主题，或者直接叫changelog。你可以启用或者禁用状态存储的备份特性。持久性的KV存储是容错的，它备份在一个紧凑格式的changelog主题中。使用紧凑格式的原因是：</p>
<ol>
<li><code>防止主题无限增长</code></li>
<li><code>减少主题占用的存储空间</code></li>
<li><code>当状态存储需要通过Changelog恢复时，缩短需要的时间</code></li>
</ol>
<p>持久性的窗口化存储也是容错的，它基于紧凑格式、支持删除机制的主题备份。窗口化存储的changelog的键的一部分是窗口时间戳，过期的窗口对应的段会被Kafka的日志清理器清理。changelog的默认存留时间是Windows#maintainMs() + 1天。指定StreamsConfig.WINDOW_STORE_CHANGE_LOG_ADDITIONAL_RETENTION_MS_CONFIG可以覆盖之。</p>
</blockquote>
<h4 id="3-监控状态恢复"><a href="#3-监控状态恢复" class="headerlink" title=".3. 监控状态恢复"></a>.3. 监控状态恢复</h4><blockquote>
<p><code>启动应用程序时，状态存储通常不需要根据changelog来恢复</code>，<code>直接加载磁盘上持久化的数据</code>就可以。但以下场景中：</p>
<ol>
<li>宕机导致本地状态丢失</li>
<li>运行在无状态环境下的应用程序重启</li>
</ol>
<p>状态存储需要基于changelog进行完整的恢复。如果changelog中的数据量很大，则恢复过程可能相当的耗时。在恢复完成之前，处理器拓扑不能处理新的数据。</p>
<p>要监控状态存储的恢复进度，你需要实现org.apache.kafka.streams.processor.<code>StateRestoreListener接口</code>，并调用KafkaStreams#<code>setGlobalStateRestoreListener注册之</code></p>
</blockquote>
<pre class=" language-java"><code class="language-java"><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>TopicPartition<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>streams<span class="token punctuation">.</span>processor<span class="token punctuation">.</span>StateRestoreListener<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 监听器会被所有org.apache.kafka.streams.processor.internals.StreamThread实例共享，并必须线程安全</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsoleGlobalRestoreListerner</span> <span class="token keyword">implements</span> <span class="token class-name">StateRestoreListener</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 在恢复过程开始时回调</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onRestoreStart</span><span class="token punctuation">(</span>
            <span class="token keyword">final</span> TopicPartition topicPartition<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 主题分区</span>
            <span class="token keyword">final</span> String storeName<span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">// 状态存储名称</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> startingOffset<span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">// 需要恢复的起点</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> endingOffset               <span class="token comment" spellcheck="true">// 需要恢复的终点</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 在恢复一批次数据后回调</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onBatchRestored</span><span class="token punctuation">(</span> <span class="token keyword">final</span> TopicPartition topicPartition<span class="token punctuation">,</span>
            <span class="token keyword">final</span> String storeName<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> batchEndOffset<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> numRestored 
    <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 恢复完成后回调</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onRestoreEnd</span><span class="token punctuation">(</span> <span class="token keyword">final</span> TopicPartition topicPartition<span class="token punctuation">,</span>
            <span class="token keyword">final</span> String storeName<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> totalRestored <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="4-启-禁changelog"><a href="#4-启-禁changelog" class="headerlink" title="4. 启/禁changelog"></a>4. <strong>启/禁changelog</strong></h4><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 启用：StateStoreBuilder#withLoggingEnabled(Map&lt;String, String>);</span>
<span class="token comment" spellcheck="true">// 禁用：StateStoreBuilder#withLoggingDisabled();</span>
KeyValueBytesStoreSupplier countStoreSupplier <span class="token operator">=</span> Stores<span class="token punctuation">.</span><span class="token function">inMemoryKeyValueStore</span><span class="token punctuation">(</span><span class="token string">"Counts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
StateStoreBuilder builder <span class="token operator">=</span> Stores
    <span class="token punctuation">.</span><span class="token function">keyValueStoreBuilder</span><span class="token punctuation">(</span>countStoreSupplier<span class="token punctuation">,</span>Serdes<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Serdes<span class="token punctuation">.</span><span class="token function">Long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withLoggingDisabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h3 id="4-流表二元性"><a href="#4-流表二元性" class="headerlink" title="4. 流表二元性"></a>4. 流表二元性</h3><ul>
<li>Stream as Table：<code>一个流可以看做是一个表的changelog</code>。流中的每条记录都捕获了表的一次状态变更，通过Replay changelog，流可以转变为表。流记录和表行不一定是1:1对应关系，流记录可能经过聚合，更新到表中的一行</li>
<li>Table as Stream：<code>表可以看做是某个瞬间的、流中每个键的最终值构成的快照。</code>迭代表中的键值对很容易将其转换为流</li>
</ul>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//通过读取Kafka主题，即可为Kafka Streams提供输入流。首先你需要实例化一个StreamsBuilder：</span>
StreamsBuilder builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamsBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//创建 KStream 流</span>
KStream<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Long<span class="token operator">></span> nameCounts <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span> 
    <span class="token string">"names-counts-input-topic"</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 输入主题名称</span>
    Consumed<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span>Serdes<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Serdes<span class="token punctuation">.</span><span class="token function">Long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 指定键值的串行化器</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//创建 KTable</span>
KTable<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Long<span class="token operator">></span> nameCounts <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span>
    Serdes<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* 键串行化器 */</span>
    Serdes<span class="token punctuation">.</span><span class="token function">Long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">/* 值串行化器 */</span>
    <span class="token string">"name-counts-input-topic"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* 输入主题 */</span>
    <span class="token string">"name-counts-partitioned-store"</span> <span class="token comment" spellcheck="true">/* 表名 */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//创建GlobalKTable</span>
GlobalKTable<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Long<span class="token operator">></span> nameCounts <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">globalTable</span><span class="token punctuation">(</span>
    Serdes<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* 键串行化器 */</span>
    Serdes<span class="token punctuation">.</span><span class="token function">Long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">/* 值串行化器 */</span>
    <span class="token string">"name-counts-input-topic"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* 输入主题 */</span>
    <span class="token string">"name-counts-global-store"</span> <span class="token comment" spellcheck="true">/* 表名 */</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><code>可以把任何主题看做是changelog，并将其读入到KTable</code>。当：</p>
<ol>
<li>记录的键<code>不存在时</code>，相当于执行<code>INSERT操作</code></li>
<li>记录的键存在，值不为null时，相当于执行<code>UPDATE操作</code></li>
<li>记录的键存在，<code>值为null时</code>，相当于执行<code>DELETE操作</code></li>
</ol>
<p>KTable对应了从输入主题读取的、分区化的记录的流。流处理程序的每个实例，都会消费输入主题的分区的子集，并且在整体上保证所有分区都被消费。</p>
<h3 id="5-流转换操作"><a href="#5-流转换操作" class="headerlink" title="5. 流转换操作"></a>5. 流转换操作</h3><h4 id="1-无状态转化"><a href="#1-无状态转化" class="headerlink" title=".1. 无状态转化"></a>.1. 无状态转化</h4><ul>
<li>不依赖于任何状态即可完成转换，不要求流处理器有关联的StateStore。</li>
<li><strong>branch</strong></li>
</ul>
<blockquote>
<p>IO：KStream → KStream，<code>基于给定的断言集分割KStream，将其分割为1-N个KStream实例</code>。断言按照声明的顺序依次估算，每个记录只被转发到第一个匹配的下游流中：</p>
</blockquote>
<pre class=" language-java"><code class="language-java">KStream<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Long<span class="token operator">></span> stream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
KStream<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Long<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> branches <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">branch</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> key<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* 以A开头的键  */</span>
        <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> key<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* 以B开头的键 */</span>
        <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">true</span>                 <span class="token comment" spellcheck="true">/* 所有其它的记录均发往此流  */</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<ul>
<li><strong>Filter</strong>   <strong>filterNot</strong></li>
</ul>
<blockquote>
<p>IO：KStream → KStream 或 KTable → KTable; 基于给定的断言，<code>针对每个记录进行估算。估算结果为true的记录进入下游流：</code></p>
</blockquote>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 仅保留正数值</span>
stream<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> value <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 针对一个KTable进行过滤，结果物化到一个StageStore中</span>
Materialized m <span class="token operator">=</span> Materialized<span class="token punctuation">.</span>&lt;String<span class="token punctuation">,</span> Long<span class="token punctuation">,</span> KeyValueStore<span class="token operator">&lt;</span>Bytes<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"filtered"</span><span class="token punctuation">)</span>
table<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> value <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<ul>
<li><strong>flatMap</strong></li>
</ul>
<blockquote>
<p>IO：KStream → KStream; 基于一个记录，产生0-N个输出记录：</p>
</blockquote>
<pre class=" language-java"><code class="language-java">KStream<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> transformed <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 键值对的列表</span>
        List<span class="token operator">&lt;</span>KeyValue<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">>></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>KeyValue<span class="token punctuation">.</span><span class="token function">pair</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>KeyValue<span class="token punctuation">.</span><span class="token function">pair</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">9000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<ul>
<li><strong>foreach</strong></li>
</ul>
<blockquote>
<p>IO：KStream → void; 终结性操作，<code>针对每个记录执行无状态的操作</code>; 需要注意：操作的副作用（例如对外部系统的写）无法被Kafka跟踪，也就是说<code>无法获得Kafka的处理语义保证</code></p>
<p>示例： stream.<strong>foreach</strong>((key, value) -&gt; System.out.println(key + “ =&gt; “ + value)); </p>
</blockquote>
<ul>
<li><strong>groupByKey</strong></li>
</ul>
<blockquote>
<p> IO：KStream → KGroupedStream; <code>分组是进行流/表的聚合操作的前提</code>。分组保证了数据被正确的分区，保证后续操作的正常进行和分组相关的一个操作是窗口化。<code>利用窗口化，可以将分组后的记录二次分组，形成一个个窗口，然后以窗口为单位进行聚合、Join仅当流被标记用于重新分区</code>，则此操作才会导致重新分区。该操作不允许修改键或者键类型</p>
</blockquote>
<pre class=" language-java"><code class="language-java">KGroupedStream<span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> String<span class="token operator">></span> groupedStream <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">groupByKey</span><span class="token punctuation">(</span>
    <span class="token comment" spellcheck="true">// 如果键值的类型不匹配配置的默认串行化器，则需要明确指定：</span>
    Serialized<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span>
         Serdes<span class="token punctuation">.</span><span class="token function">ByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         Serdes<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<ul>
<li><strong>groupBy</strong></li>
</ul>
<blockquote>
<p>IO：KStream → KGroupedStream 或 KTable → KGroupedTable; 实际上是<code>selectKey+groupByKey的组合</code>; 基于<code>一个新的键来分组记录，新键的类型可能和记录旧的键类型不同。</code>当对表进行分组时，还可以指定新的值、值类型; 该操作总是会导致数据的重新分区，因此在可能的情况下你应该优选groupByKey，后者仅在必要的时候分区.</p>
</blockquote>
<pre class=" language-java"><code class="language-java">KGroupedStream<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> groupedStream <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> value<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 产生键值对value:value并依此分组</span>
    Serialize<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span>
         Serdes<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* 键的类型发生改变 */</span>
         Serdes<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">/* value */</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span> 
KGroupedTable<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> groupedTable <span class="token operator">=</span> table<span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span>
    <span class="token comment" spellcheck="true">// 产生键值对  value:length(value)，并依此分组</span>
    <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> KeyValue<span class="token punctuation">.</span><span class="token function">pair</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Serialized<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span>
        Serdes<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* 键的类发生改变 */</span>
        Serdes<span class="token punctuation">.</span><span class="token function">Integer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">/* 值的类型发生改变  */</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<ul>
<li><strong>map</strong></li>
</ul>
<blockquote>
<p>IO：KStream → KStream;  <code>根据一个输入记录产生一个输出记录，你可以修改键值的类型</code></p>
</blockquote>
<pre class=" language-java"><code class="language-java">KStream<span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> String<span class="token operator">></span> stream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
KStream<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> transformed <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> KeyValue<span class="token punctuation">.</span><span class="token function">pair</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<ul>
<li><strong>mapValues</strong>: 类似上面，但是仅仅映射值，键不变 </li>
<li><strong>print</strong>: IO：KStream → void; <code>终结操作</code>，<code>打印记录到输出流中。</code>stream.print(Printed.toFile(“stream.out”));</li>
<li><strong>selectKey</strong></li>
</ul>
<blockquote>
<p>IO：KStream → KStream;  对每个记录分配一个新的键，键类型可能改变。</p>
</blockquote>
<pre class=" language-java"><code class="language-java">KStream<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> rekeyed <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">selectKey</span><span class="token punctuation">(</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> value<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre>
<ul>
<li><strong>toStream</strong></li>
</ul>
<blockquote>
<p>IO：KTable → KStream;  将表转换为流： table.toStream();</p>
</blockquote>
<ul>
<li><strong>WriteAsText</strong></li>
</ul>
<blockquote>
<p> IO：KStream → void; <code>终结性操作，将流写出到文件</code></p>
</blockquote>
<h4 id="2-有状态转转化"><a href="#2-有状态转转化" class="headerlink" title=".2. 有状态转转化"></a>.2. 有状态转转化</h4><blockquote>
<p>这类转换操作<code>需要依赖于某些状态信息</code>。例如在聚合性操作中，会<code>使用窗口化状态存储来保存上一个窗口的聚合结果</code>。在Join操作中，会使用窗<code>口化状态存储到目前为止接收到的、窗口边界内部的所有记录</code>。状态存储默认支持容错，<code>如果出现失败，则Kafka Streams会首先恢复所有的状态存储，然后再进行后续的处理</code>。高级的有状态转换操作包括：聚合、Join，以及针对两者的窗口化支持。</p>
</blockquote>
<ul>
<li><strong>aggregate</strong></li>
</ul>
<blockquote>
<p>IO：KGroupedStream → KTable 或 KGroupedTable → KTable; 滚动聚合（Rolling Aggregation）操作，根据分组键对非窗口化的记录的值进行聚合</p>
<p>当对已分组流进行聚合时，你需要提供初始化器（确定聚合初值）、聚合器adder。当聚合已分组表时，你需要额外提供聚合器subtractor。</p>
</blockquote>
<pre class=" language-java"><code class="language-java">KGroupedStream<span class="token operator">&lt;</span>Bytes<span class="token punctuation">,</span> String<span class="token operator">></span> groupedStream <span class="token operator">=</span> null<span class="token punctuation">;</span>
KGroupedTable<span class="token operator">&lt;</span>Bytes<span class="token punctuation">,</span> String<span class="token operator">></span> groupedTable <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 聚合一个分组流，值类型从字符串变为整数</span>
KTable<span class="token operator">&lt;</span>Bytes<span class="token punctuation">,</span> Long<span class="token operator">></span> aggregatedStream <span class="token operator">=</span> groupedStream<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> 0L<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* 初始化器 */</span>
    <span class="token punctuation">(</span> aggKey<span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> aggValue <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> aggValue <span class="token operator">+</span> newValue<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* 累加器 */</span>
    Serdes<span class="token punctuation">.</span><span class="token function">Long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* 值的串行化器 */</span>
    <span class="token string">"aggregated-stream-store"</span> <span class="token comment" spellcheck="true">/* 状态存储的名称 */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

KTable<span class="token operator">&lt;</span>Bytes<span class="token punctuation">,</span> Long<span class="token operator">></span> aggregatedTable <span class="token operator">=</span> groupedTable<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> 0L<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* 初始化器 */</span>
    <span class="token punctuation">(</span> aggKey<span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> aggValue <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> aggValue <span class="token operator">+</span> newValue<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* 累加器 */</span>
    <span class="token punctuation">(</span> aggKey<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> aggValue <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> aggValue <span class="token operator">-</span> oldValue<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* 减法器 */</span>
    Serdes<span class="token punctuation">.</span><span class="token function">Long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* 值的串行化器 */</span>
    <span class="token string">"aggregated-table-store"</span> <span class="token comment" spellcheck="true">/* 状态存储的名称 */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>KGroupedStream的聚合操作的行为：</p>
<ol>
<li>值为null的记录被忽略</li>
<li>当首次收到某个新的记录键时，初始化器被调用</li>
<li>每当接收到非null值的记录时，累加器被调用</li>
</ol>
<p>KGroupedTable的聚合操作的行为：</p>
<ol>
<li>值为null的记录被忽略</li>
<li>当首次收到某个新的记录键时，初始化器被调用（在调用累加器/减法器之前）。与KGroupedStream不同，随着时间的推移，针对一个键，可能调用初始化器多次。只要接收到目标键的墓碑记录</li>
<li>当首次收到某个键的非null值时（INSERT操作），调用累加器</li>
<li>当非首次收到某个键的非null值时（UPDATE操作）：<ol>
<li>调用减法器，传入存储在KTable表中的旧值</li>
<li>调用累加器，传入刚刚接收到的新值</li>
<li>上述两个聚合器的执行顺序未定义</li>
</ol>
</li>
<li>当接收到墓碑记录（DELETE操作）亦即null值的记录时，调用减法器</li>
<li>不论何时，减法器返回null时都会导致相应的键从结果KTable表中删除。遇到相同键的下一个记录时，会执行第3步的行为</li>
</ol>
<ul>
<li><strong>KGroupedStream → KTable</strong></li>
</ul>
<blockquote>
<p>窗口化聚合：<code>以窗口为单位，根据分组键</code>，对KGroupedStream中的记录进行聚合操作，并把结果存放到窗口化的KTable</p>
</blockquote>
<pre class=" language-java"><code class="language-java">KGroupedStream<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Long<span class="token operator">></span> groupedStream <span class="token operator">=</span> null<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 基于时间的窗口化（滚动窗口）</span>
KTable<span class="token operator">&lt;</span>Windowed<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">,</span> Long<span class="token operator">></span> timeWindowedAggregatedStream <span class="token operator">=</span> groupedStream
    <span class="token punctuation">.</span><span class="token function">windowedBy</span><span class="token punctuation">(</span> TimeWindows<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span> TimeUnit<span class="token punctuation">.</span>MINUTES<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span> <span class="token number">5</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> 0L<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* 初始化器 */</span>
    <span class="token punctuation">(</span> aggKey<span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> aggValue <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> aggValue <span class="token operator">+</span> newValue<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* 累加器 */</span>
    <span class="token comment" spellcheck="true">/* 状态存储 */</span>
    Materialized<span class="token punctuation">.</span>&lt;String<span class="token punctuation">,</span> Long<span class="token punctuation">,</span> WindowStore<span class="token operator">&lt;</span>Bytes<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token function">as</span><span class="token punctuation">(</span> <span class="token string">"time-windowed-aggregated-stream-store"</span> <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withValueSerde</span><span class="token punctuation">(</span> Serdes<span class="token punctuation">.</span><span class="token function">Long</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 基于会话的窗口化</span>
KTable<span class="token operator">&lt;</span>Windowed<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">,</span> Long<span class="token operator">></span> sessionizedAggregatedStream <span class="token operator">=</span> groupedStream
    <span class="token punctuation">.</span><span class="token function">windowedBy</span><span class="token punctuation">(</span> SessionWindows<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span> TimeUnit<span class="token punctuation">.</span>MINUTES<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span> <span class="token number">5</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment" spellcheck="true">/* 窗口定义 */</span>
    <span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> 0L<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* 初始化器 */</span>
    <span class="token punctuation">(</span> aggKey<span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> aggValue <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> aggValue <span class="token operator">+</span> newValue<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* 累加器 */</span>
    <span class="token punctuation">(</span> aggKey<span class="token punctuation">,</span> leftAggValue<span class="token punctuation">,</span> rightAggValue <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> leftAggValue <span class="token operator">+</span> rightAggValue<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* 会话合并器 */</span>
    Materialized<span class="token punctuation">.</span>&lt;String<span class="token punctuation">,</span> Long<span class="token punctuation">,</span> SessionStore<span class="token operator">&lt;</span>Bytes<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token function">as</span><span class="token punctuation">(</span> <span class="token string">"sessionized-aggregated-stream-store"</span> <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withValueSerde</span><span class="token punctuation">(</span> Serdes<span class="token punctuation">.</span><span class="token function">Long</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://liudongdong1.github.io" rel="external nofollow noreferrer">liudongdong1</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://liudongdong1.github.io/2021/07/21/yu-yan-kuang-jia/framework/middleware/kafka/kafka-stream/">https://liudongdong1.github.io/2021/07/21/yu-yan-kuang-jia/framework/middleware/kafka/kafka-stream/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint polocy. If reproduced, please indicate source
                    <a href="https://liudongdong1.github.io" target="_blank">liudongdong1</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Framework/">
                                    <span class="chip bg-color">Framework</span>
                                </a>
                            
                                <a href="/tags/middleware/">
                                    <span class="chip bg-color">middleware</span>
                                </a>
                            
                                <a href="/tags/kafka/">
                                    <span class="chip bg-color">kafka</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq,qzone,wechat,weibo,douban" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2021/07/21/yu-yan-kuang-jia/framework/middleware/kafka/kafka-shi-shi-ji-qi-xue-xi/">
                    <div class="card-image">
                        
                        <img src="https://cdn.stocksnap.io/img-thumbs/280h/poppy-flower_5ID3FW4GTD.jpg" class="responsive-img" alt="kafka_实时机器学习">
                        
                        <span class="card-title">kafka_实时机器学习</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
在Kafka应用程序中部署一个分析模型来进行实时预测。模式训练和模型部署可以是两个独立的过程。但是相同的步骤也可应用于数据集成和数据预处理，因为模型训练和模型推导需要呈现同样的数据集成、过滤、充实和聚合

有RPC的服务端模型（RPCs）
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-07-21
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%AF%AD%E8%A8%80%E6%A1%86%E6%9E%B6/" class="post-category">
                                    语言框架
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Framework/">
                        <span class="chip bg-color">Framework</span>
                    </a>
                    
                    <a href="/tags/middleware/">
                        <span class="chip bg-color">middleware</span>
                    </a>
                    
                    <a href="/tags/kafka/">
                        <span class="chip bg-color">kafka</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/07/21/ruan-jian-gong-ju/paperdraw/keyshot/">
                    <div class="card-image">
                        
                        <img src="https://images.unsplash.com/photo-1629486997190-dcfbabe0ab8b?ixid=MnwxMjA3fDB8MHxlZGl0b3JpYWwtZmVlZHwyfHx8ZW58MHx8fHw%3D&ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" class="responsive-img" alt="keyshot">
                        
                        <span class="card-title">keyshot</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            1. 操作界面
导入/导出/保存文件： KeyShot主菜单在界面顶部区域，如图所示。在这里可以进行文件导入/保存、添加编辑几何体、设置环境阴影、选择照明环境模式、编辑相机、查看帮助等操作。

导入：KeyShot支持大部分的3D模型文件格
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-07-21
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E5%85%B7/" class="post-category">
                                    软件工具
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/paper/">
                        <span class="chip bg-color">paper</span>
                    </a>
                    
                    <a href="/tags/keyshot/">
                        <span class="chip bg-color">keyshot</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <!-- <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="463294659"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2019</span>
            <a href="https://liudongdong1.github.io" target="_blank">liudongdong</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">1195.6k</span>&nbsp;字
            
            
            
            
            
            
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/liudongdong1/" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:3463264078@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>














    <a href="https://blog.csdn.net/liudongdong19/" class="tooltipped" target="_blank" data-tooltip="关注我的CSDN: https://blog.csdn.net/liudongdong19/" data-position="top" data-delay="50">
        <i class="fab fa-csdn">C</i>
    </a>





</div>
    </div>
</footer>

<div class="progress-bar"></div>
 -->

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script type="text/javascript" src="/js/CFS.Snow.min.js"></script>
    <!-- 点击爆灯效果 -->
    <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
    <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
    <script type="text/javascript" src="/js/fireworks.js"></script>
    <!--动态线条背景-->
    <script type="text/javascript"
        color="122 103 238" opacity='0.7' zIndex="-2" count="200" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
    </script>
    <!-- 天气 -->
    <!-- weather -->
    <!-- weather -->
    <script type="text/javascript">
         WIDGET = {FID: 'knAMQaFanP'}
    </script>
    <script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script>
    <script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script>
    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    

    
    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon-refresh.min.js" async="async"></script>
    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    
    <!-- {% include '_custom/custom.swig' %} -->

</body>

</html>
