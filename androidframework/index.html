<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>AndroidFramework - DAY By DAY</title><meta name=author content="LiuDongdong"><meta name=author-link content="https://liudongdong1.github.io/"><meta name=description content="Android底层内核空间以Linux Kernel作为基石，上层用户空间由Native系统库、虚拟机运行环境、框架层组成，通过系统调用(Sy"><meta name=keywords content="Android"><meta itemprop=name content="AndroidFramework"><meta itemprop=description content="Android底层内核空间以Linux Kernel作为基石，上层用户空间由Native系统库、虚拟机运行环境、框架层组成，通过系统调用(Sy"><meta itemprop=datePublished content="2020-10-21T22:02:27+00:00"><meta itemprop=dateModified content="2023-09-24T17:00:03+08:00"><meta itemprop=wordCount content="8741"><meta itemprop=image content="/logo.png"><meta itemprop=keywords content="Android,"><meta property="og:title" content="AndroidFramework"><meta property="og:description" content="Android底层内核空间以Linux Kernel作为基石，上层用户空间由Native系统库、虚拟机运行环境、框架层组成，通过系统调用(Sy"><meta property="og:type" content="article"><meta property="og:url" content="liudongdong1.github.io/androidframework/"><meta property="og:image" content="/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-10-21T22:02:27+00:00"><meta property="article:modified_time" content="2023-09-24T17:00:03+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/logo.png"><meta name=twitter:title content="AndroidFramework"><meta name=twitter:description content="Android底层内核空间以Linux Kernel作为基石，上层用户空间由Native系统库、虚拟机运行环境、框架层组成，通过系统调用(Sy"><meta name=application-name content="DAY By DAY"><meta name=apple-mobile-web-app-title content="DAY By DAY"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=liudongdong1.github.io/androidframework/><link rel=prev href=liudongdong1.github.io/makebuildrelative/><link rel=next href=liudongdong1.github.io/androidaidl/><link rel=stylesheet href=/liudongdong1.github.io/css/style.min.css><link rel=stylesheet href=/liudongdong1.github.io/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/liudongdong1.github.io/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"AndroidFramework","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"liudongdong1.github.io\/androidframework\/"},"genre":"posts","keywords":"Android","wordcount":8741,"url":"liudongdong1.github.io\/androidframework\/","datePublished":"2020-10-21T22:02:27+00:00","dateModified":"2023-09-24T17:00:03+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"LiuDongdong","logo":"\/images\/person.png"},"author":{"@type":"Person","name":"liudongdong1"},"description":""}</script></head><body data-header-desktop=auto data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=right><div class=header-title><a href=liudongdong1.github.io/ title="DAY By DAY"><img class="lazyload logo" src=/liudongdong1.github.io/svg/loading.min.svg data-src=/fixit.min.svg data-srcset="/fixit.min.svg, /fixit.min.svg 1.5x, /fixit.min.svg 2x" data-sizes=auto alt="DAY By DAY" title="DAY By DAY"><span class=header-title-text></span></a><span id=typeit-header-subtitle-desktop class="typeit header-subtitle"></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/liudongdong1.github.io/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 所有文章</a></li><li class=menu-item><a class=menu-link href=/liudongdong1.github.io/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/liudongdong1.github.io/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/liudongdong1.github.io/friends/ title=友情链接><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/liudongdong1.github.io/about/><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item language"><span role=button aria-label=选择语言 title=选择语言>简体中文<i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i></span><ul class=sub-menu><li class=menu-item>没有更多翻译</li></ul></li><li class="menu-item search" id=search-desktop><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=liudongdong1.github.io/ title="DAY By DAY"><img class="lazyload logo" src=/liudongdong1.github.io/svg/loading.min.svg data-src=/fixit.min.svg data-srcset="/fixit.min.svg, /fixit.min.svg 1.5x, /fixit.min.svg 2x" data-sizes=auto alt=/fixit.min.svg title=/fixit.min.svg><span class=header-title-text></span></a><span id=typeit-header-subtitle-mobile class="typeit header-subtitle"></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/liudongdong1.github.io/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 所有文章</a></li><li class=menu-item><a class=menu-link href=/liudongdong1.github.io/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/liudongdong1.github.io/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/liudongdong1.github.io/friends/ title=友情链接><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/liudongdong1.github.io/about/><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item text-center"><a class=menu-link href=https://liudongdong1.github.io/ title=GitHub rel="noopener noreferrer" target=_blank><i class='fa-brands fa-github fa-fw' aria-hidden=true></i></a></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li><li class="menu-item language"><span role=button aria-label=选择语言 title=选择语言>简体中文<i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i></span>
<select class=language-select onchange="location=this.value"><option disabled>没有更多翻译</option></select></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container data-page-style=normal><aside class=toc id=toc-auto><h2 class=toc-title>目录 <i class="toc-icon fa-solid fa-angle-down fa-fw"></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom id=aside-sakana><div class=sakana-widget><div class=sakana-item id=takina-widget></div><div class=sakana-item id=chisato-widget></div></div><script>function initSakanaWidget(){const e=SakanaWidget.getCharacter("takina");SakanaWidget.registerCharacter("takina-slow",e),new SakanaWidget({character:"takina-slow",controls:!1,autoFit:!0,stroke:{color:"#b4b4b4",width:2}}).mount("#takina-widget");const t=SakanaWidget.getCharacter("chisato");SakanaWidget.registerCharacter("chisato-slow",t),new SakanaWidget({character:"chisato-slow",controls:!1,autoFit:!0,stroke:{color:"#b4b4b4",width:2}}).mount("#chisato-widget")}</script><script async onload=initSakanaWidget() src=https://cdn.jsdelivr.net/npm/sakana-widget@2.3.0/lib/sakana.min.js></script></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>AndroidFramework</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><i class="fa-solid fa-user-circle" aria-hidden=true></i>
liudongdong1</span></span>
<span class=post-category>收录于 <a href=liudongdong1.github.io/categories/><i class="fa-regular fa-folder fa-fw"></i>&nbsp;Categories</a>&ensp;<a href=liudongdong1.github.io/categories/aiot/><i class="fa-regular fa-folder fa-fw"></i>&nbsp;AIOT</a></span></div><div class=post-meta-line><span title="2020-10-21 22:02:27"><i class="fa-regular fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2020-10-21>2020-10-21</time>
</span>&nbsp;<i class="fa-solid fa-pencil-alt fa-fw"></i>&nbsp;约 8741 字&nbsp;
<i class="fa-regular fa-clock fa-fw"></i>&nbsp;预计阅读 18 分钟&nbsp;<span id=busuanzi_container_page_pv class="busuanzi_visitors comment-visitors" data-flag-title=AndroidFramework>
<i class="fa-regular fa-eye fa-fw"></i>&nbsp;<span id=busuanzi_value_page_pv>-</span>&nbsp;次阅读
</span>&nbsp;</div></div><div class=featured-image><img class=lazyload src=/liudongdong1.github.io/svg/loading.min.svg data-src=https://cdn.stocksnap.io/img-thumbs/280h/2UNU086C0B.jpg data-srcset="https://cdn.stocksnap.io/img-thumbs/280h/2UNU086C0B.jpg, https://cdn.stocksnap.io/img-thumbs/280h/2UNU086C0B.jpg 1.5x, https://cdn.stocksnap.io/img-thumbs/280h/2UNU086C0B.jpg 2x" data-sizes=auto alt=https://cdn.stocksnap.io/img-thumbs/280h/2UNU086C0B.jpg title=https://cdn.stocksnap.io/img-thumbs/280h/2UNU086C0B.jpg></div><div class="details toc" id=toc-static kept=true><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#1-android-系统框架>1. Android 系统框架</a></li><li><a href=#2-android-镜像文件httpswwwcnblogscomschipspintroduction_of_image_about_androidhtml>2. android <a href=https://www.cnblogs.com/schips/p/introduction_of_image_about_android.html>镜像文件</a></a></li><li><a href=#3-android-mk-文件>3. Android mk 文件</a></li><li><a href=#4-通信方式>4. 通信方式</a></li><li><a href=#5-android-进程线程理解>5. Android 进程线程理解</a></li><li><a href=#6-gui显示>6. GUI显示</a></li><li><a href=#resource>Resource</a></li></ul></li></ul></nav></div></div><div class=content id=content><blockquote><p>Android底层内核空间以Linux Kernel作为基石，上层用户空间由<code>Native系统库</code>、<code>虚拟机运行环境</code>、<code>框架层组成</code>，通过<code>系统调用(Syscall)连通系统的内核空间与用户空间</code>。对于用户空间主要采用C++和Java代码编写，通过<code>JNI技术打通用户空间的Java层和Native层(C++/C)</code>，从而连通整个系统。</p></blockquote><h3 id=1-android-系统框架>1. Android 系统框架</h3><p><img class=lazyload src=/liudongdong1.github.io/svg/loading.min.svg data-src=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221120085004076.png data-srcset="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221120085004076.png, https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221120085004076.png 1.5x, https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221120085004076.png 2x" data-sizes=auto alt=image-20221120085004076 title=image-20221120085004076></p><p><img class=lazyload src=/liudongdong1.github.io/svg/loading.min.svg data-src=https://gitee.com/github-25970295/blogpictureV2/raw/master/image-20211107141336894.png data-srcset="https://gitee.com/github-25970295/blogpictureV2/raw/master/image-20211107141336894.png, https://gitee.com/github-25970295/blogpictureV2/raw/master/image-20211107141336894.png 1.5x, https://gitee.com/github-25970295/blogpictureV2/raw/master/image-20211107141336894.png 2x" data-sizes=auto alt=https://gitee.com/github-25970295/blogpictureV2/raw/master/image-20211107141336894.png title=https://gitee.com/github-25970295/blogpictureV2/raw/master/image-20211107141336894.png></p><blockquote><p>Android系统启动过程由上图从下往上的一个过程是由Boot Loader引导开机，然后依次进入 -> Kernel -> Native -> Framework -> App，接来下简要说说每个过程：</p></blockquote><h4 id=1-loader-层>.1. Loader 层</h4><ul><li>Boot ROM: 当手机处于关机状态时，长按Power键开机，引导芯片开始从固化在 ROM里的预设代码开始执行，然后加载引导程序到 RAM；</li><li>Boot Loader：这是启动Android系统之前的引导程序，主要是检查RAM，初始化硬件参数等功能。</li></ul><h4 id=2-linux-内核层>.2. Linux 内核层</h4><ul><li>启动Kernel的swapper进程(pid=0)：该进程又称为idle进程, 系统初始化过程Kernel由无到有开创的第一个进程, 用于<code>初始化进程管理、内存管理，加载Display,Camera Driver，Binder Driver等相关工作</code>；</li><li>启动kthreadd进程（pid=2）：是Linux系统的内核进程，会<code>创建内核工作线程kworkder</code>，<code>软中断线程ksoftirqd</code>，<code>thermal等内核守护进程</code>。 kthreadd进程是所有内核进程的鼻祖。</li></ul><h4 id=3-硬件抽象层>.3. 硬件抽象层</h4><blockquote><p>硬件抽象层 (HAL) 提供标准接口，HAL包含多个库模块，其中每个模块都为特定类型的硬件组件实现一组接口，比如WIFI/蓝牙模块，当框架API请求访问设备硬件时，Android系统将为该硬件加载相应的库模块。</p></blockquote><h4 id=4-android-runtime系统库>.4. Android Runtime&系统库</h4><p>每个应用都在其自己的进程中运行，都有自己的虚拟机实例。<code>ART通过执行DEX文件可在设备运行多个虚拟机</code>，<code>DEX文件是一种专为Android设计的字节码格式文件，经过优化，使用内存很少</code>。ART主要功能包括：<code>预先(AOT)和即时(JIT)编译，优化的垃圾回收(GC)，以及调试相关的支持</code>。</p><p>DX 工具将.class文件编译成.dex文件，运行该.dex文件。</p><p>这里的<code>Native系统库</code>主要包括<code>init孵化来的用户空间的守护进程、HAL层以及开机动画等</code>。启动init进程(pid=1),是Linux系统的用户进程，<code> init进程是所有用户进程的鼻祖</code>。</p><ul><li>init进程会孵化出ueventd、logd、healthd、installd、adbd、lmkd等用户守护进程；</li><li>init进程还启动 servicemanager(binder服务管家)、 bootanim(开机动画)等重要服务</li><li>init进程孵化出Zygote进程，Zygote进程是Android系统的第一个Java进程(即虚拟机进程)， Zygote是所有Java进程的父进程，Zygote进程本身是由init进程孵化而来的。</li></ul><h4 id=5-framework层>.5. Framework层</h4><ul><li>Zygote进程，是由init进程通过解析init.rc文件后fork生成的，Zygote进程主要包含：<ul><li>加载ZygoteInit类，注册Zygote Socket服务端套接字</li><li>加载虚拟机</li><li>提前加载类preloadClasses</li><li>提前加载资源preloadResouces</li></ul></li><li>System Server进程，是由Zygote进程fork而来， SystemServer是Zygote孵化的第一个进程，System Server负责启动和管理整个Java framework，包含ActivityManager，WindowManager，PackageManager，PowerManager等服务。</li><li>Media Server进程，是由init进程fork而来，负责启动和管理整个C++<strong>framework，包含AudioFlinger，Camera Service等服务。</strong></li></ul><h4 id=6-app-层>.6. App 层</h4><ul><li>Zygote进程孵化出的第一个App进程是<code>Launcher，这是用户看到的桌面App</code>；</li><li>Zygote进程还会<code>创建Browser，Phone，Email等App进程，每个App至少运行在一个进程上</code>。</li><li>所有的<code>App进程都是由Zygote进程fork生成的</code>。</li></ul><h4 id=7-syscall--jni>.7. Syscall && JNI</h4><ul><li>Native与Kernel之间有一层系统调用(SysCall)层，见Linux系统调用(Syscall)原理;</li><li><code>Java层与Native(C/C++)层之间的纽带JNI</code>，见Android JNI原理分析。</li></ul><h3 id=2-android-镜像文件httpswwwcnblogscomschipspintroduction_of_image_about_androidhtml>2. android <a href=https://www.cnblogs.com/schips/p/introduction_of_image_about_android.html target=_blank rel="external nofollow noopener noreferrer">镜像文件<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></h3><ul><li><code>cache.img（缓存镜像）</code>：用于存储系统或用户应用产生的临时数据。</li><li><code>vendor.img</code>：包含所有不可分发给 Android 开源项目 (AOSP) 的二进制文件。如果没有专有信息，则可以省略此分区。</li><li><code>misc.img</code>：misc 分区供恢复映像使用，存储空间不能小于 4KB。</li><li><code>userdata.img</code>：userdata 分区包含用户安装的应用和数据，包括自定义数据。</li><li><code>vbmeta.img</code>：用于安全验证，bootloader验证vbmeta的签名，再用vbmeta的key以及hash值验证dtbo/boot/system/vendor。</li><li><code>system.img（系统镜像）</code>：系统镜像是地址ROM最常使用的一个镜像，用于存储Android系统的核心文件，System.img就是设备中system目录的镜像，里面包含了Android系统主要的目录和文件。一般这些文件是不允许修改的。</li><li><code>userdata.img（用户数据镜像）</code>：将会被挂接到 /data 下，包含了所有应用相关的配置文件，以及用户相关的数据 。</li><li>system.img、userdata.img、vendor.img、persist.img都是sparse压缩文件系统镜像，目的是方便传输/刷机/存储等。</li><li><code>recovery.img</code>： recovery分区的镜像，一般用作系统恢复（刷机）。</li><li>boot.img（Linux内核镜像）： Android系统中，通常会把zImage （ 内核镜像uImage文件） 和ramdisk.img打包到一起，生成一个boot.img镜像文件，放到boot分区，由bootloader来引导启动，其启动过程本质也是和分开的uImage&amp;ramdisk.img类似，只不过把两个镜像按照一定的格式合并为一个镜像而已。</li><li><code>amdisk.img（内存磁盘镜像）</code>是根文件系统：android启动时 首先加载ramdisk.img镜像，并挂载到/目录下，并进行了一系列的初始化动作，包括创建各种需要的目录，初始化console，开启服务等，尽管ramdisk.img需要放在Linux内核镜像（boot.img）中，但却属于Android源代码的一部分。</li></ul><h3 id=3-android-mk-文件>3. Android mk 文件</h3><ul><li><a href=https://www.jianshu.com/p/703ef39dff3f target=_blank rel="external nofollow noopener noreferrer">https://www.jianshu.com/p/703ef39dff3f<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></li></ul><h3 id=4-通信方式>4. 通信方式</h3><blockquote><p>对于IPC(Inter-Process Communication, 进程间通信)，Linux现有<code>管道</code>、<a href="https://cloud.tencent.com/product/cmq?from=10680" target=_blank rel="external nofollow noopener noreferrer">消息队列<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a>、<code>共享内存</code>、<code>套接字</code>、<code>信号量</code>、<code>信号</code>这些IPC机制，Android额外还有<code>Binder IPC机制</code>，Android OS中的Zygote进程的IPC采用的是Socket机制，在上层system server、media server以及上层App之间更多的是采用Binder IPC方式来完成跨进程间的通信。对于Android上层架构中，很多时候是在同一个进程的线程之间需要相互通信，例如<code>同一个进程的主线程与工作线程之间的通信，往往采用的Handler消息机制</code>。</p><ol><li><p>**管道：**在创建时分配一个page大小的内存，缓存区大小比较有限；</p></li><li><p><strong>消息队列</strong>：信息复制两次，额外的CPU消耗；不合适频繁或信息量大的通信；</p></li><li><p><strong>共享内存</strong>：无须复制，共享缓冲区直接付附加到进程虚拟地址空间，速度快；但进程间的同步问题操作系统无法实现，必须各进程利用同步工具解决；</p></li><li><p><strong>套接字</strong>：作为更通用的接口，传输效率低，主要用于不通机器或跨网络的通信；</p></li><li><p><strong>信号量</strong>：常作为一种锁机制，防止某进程正在访问共享资源时，其他进程也访问该资源。因此，主要作为进程间以及同一进程内不同线程之间的同步手段。</p></li><li><p><strong>信号</strong>: 不适用于信息交换，更适用于进程中断控制，比如非法内存访问，杀死某个进程等；</p></li></ol></blockquote><h4 id=1-共享内存方式httpsblogcsdnnetaliven888articledetails119248596>1. <a href=https://blog.csdn.net/Aliven888/article/details/119248596 target=_blank rel="external nofollow noopener noreferrer">共享内存方式<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></h4><blockquote><p>1、mmap保存到实际硬盘，实际存储并没有反映到主存上。优点：储存量可以很大（多于主存）（这里一个问题，需要高手解答,会不会太多拷贝到主存里面？？？）；缺点：进程间读取和写入速度要比主存的要慢。</p><p>2、shm保存到物理存储器（主存），实际的储存量直接反映到主存上。优点，进程间访问速度（读写）比磁盘要快；缺点，储存量不能非常大（多于主存）</p><p>使用上看：如果分配的存储量不大，那么使用shm；如果存储量大，那么使用mmap。</p><p>2）使用特殊文件提供匿名内存映射：适用于具有亲缘关系的进程之间；由于父子进程特殊的亲缘关系，在父进程中先调用mmap()，然后调用fork()。那么在调用fork()之后，子进程继承父进程匿名映射后的地址空间，同样也继承mmap()返回的地址，这样，父子进程就可以通过映射区域进行通信了。</p></blockquote><ul><li><p><code>创建共享内存</code>，使用shmget函数。</p></li><li><p><code>映射共享内存</code>，将这段创建的共享内存映射到具体的进程空间去，使用shmat函数。</p></li><li><p>当一个进程想和另外一个进程通信的时候，它将按以下顺序运行：</p><ul><li>获取mutex对象，锁定共享区域。</li><li>将要通信的数据写入共享区域。</li><li>释放mutex对象。</li></ul></li><li><p>当一个进程从从这个区域读数据时候，它将重复同样的步骤，只是将第二步变成读取。</p></li></ul><p><img class=lazyload src=/liudongdong1.github.io/svg/loading.min.svg data-src=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221120110134019.png data-srcset="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221120110134019.png, https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221120110134019.png 1.5x, https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221120110134019.png 2x" data-sizes=auto alt=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221120110134019.png title=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221120110134019.png></p><p><img class=lazyload src=/liudongdong1.github.io/svg/loading.min.svg data-src=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221120110146858.png data-srcset="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221120110146858.png, https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221120110146858.png 1.5x, https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221120110146858.png 2x" data-sizes=auto alt=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221120110146858.png title=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221120110146858.png></p><pre tabindex=0><code>usage : ipcs -asmq -tclup 
    ipcs [-s -m -q] -i id
    ipcs -h for help.
m      输出有关共享内存(shared memory)的信息
-q      输出有关信息队列(message queue)的信息
-s      输出有关“遮断器”(semaphore)的信息

usage: ipcrm [ [-q msqid] [-m shmid] [-s semid]
          [-Q msgkey] [-M shmkey] [-S semkey] ... ]
</code></pre><h5 id=1-映射共享内存>1. 映射共享内存</h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/ipc.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/shm.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define IPCKEY 0x366378
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> st_setting
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> agen[<span style=color:#ae81ff>10</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> file_no;
</span></span><span style=display:flex><span>}st_setting;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span><span style=color:#f92672>**</span> argv)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span>         shm_id;
</span></span><span style=display:flex><span>    <span style=color:#75715e>//key_t       key;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    st_setting  <span style=color:#f92672>*</span>p_setting;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//  首先检查共享内存是否存在，存在则先删除
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    shm_id <span style=color:#f92672>=</span> <span style=color:#a6e22e>shmget</span>(IPCKEY , <span style=color:#ae81ff>1028</span>, <span style=color:#ae81ff>0640</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(shm_id <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        p_setting <span style=color:#f92672>=</span> (st_setting <span style=color:#f92672>*</span>)<span style=color:#a6e22e>shmat</span>(shm_id, NULL, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (p_setting <span style=color:#f92672>!=</span> (<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>shmdt</span>(p_setting);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>shmctl</span>(shm_id,IPC_RMID,<span style=color:#ae81ff>0</span>) ;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//  创建共享内存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    shm_id <span style=color:#f92672>=</span> <span style=color:#a6e22e>shmget</span>(IPCKEY, <span style=color:#ae81ff>1028</span>, <span style=color:#ae81ff>0640</span> <span style=color:#f92672>|</span> IPC_CREAT <span style=color:#f92672>|</span> IPC_EXCL);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(shm_id <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;shmget error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//  将这块共享内存区附加到自己的内存段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    p_setting <span style=color:#f92672>=</span> (st_setting <span style=color:#f92672>*</span>)<span style=color:#a6e22e>shmat</span>(shm_id, NULL, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>strncpy</span>(p_setting<span style=color:#f92672>-&gt;</span>agen, <span style=color:#e6db74>&#34;gatieme&#34;</span>, <span style=color:#ae81ff>10</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;agen : %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, p_setting<span style=color:#f92672>-&gt;</span>agen);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    p_setting<span style=color:#f92672>-&gt;</span>file_no <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;file_no : %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,p_setting<span style=color:#f92672>-&gt;</span>file_no);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>system</span>(<span style=color:#e6db74>&#34;ipcs -m&#34;</span>);<span style=color:#75715e>//  此时可看到有进程关联到共享内存的信息，nattch为1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//  将这块共享内存区从自己的内存段删除出去
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>shmdt</span>(p_setting) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34; detach error &#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>system</span>(<span style=color:#e6db74>&#34;ipcs -m&#34;</span>);<span style=color:#75715e>//  此时可看到有进程关联到共享内存的信息，nattch为0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//  删除共享内存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>shmctl</span>( shm_id , IPC_RMID , NULL ) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34; delete error &#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>system</span>(<span style=color:#e6db74>&#34;ipcs -m&#34;</span>);<span style=color:#75715e>//  此时可看到有进程关联到共享内存的信息，nattch为0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> EXIT_SUCCESS;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=2-俩个进程读写案例httpsblogcsdnnetaliven888articledetails119248596>2. <a href=https://blog.csdn.net/Aliven888/article/details/119248596 target=_blank rel="external nofollow noopener noreferrer">俩个进程读写案例<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>//shmDatadef.h
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/shm.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;iostream&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>using namespace std;
</span></span><span style=display:flex><span><span style=color:#75715e>#define SHARE_MEMORY_BUFFER_LEN 1024
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>struct</span> stuShareMemory{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> iSignal;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> chBuffer[SHARE_MEMORY_BUFFER_LEN];
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>stuShareMemory</span>(){
</span></span><span style=display:flex><span>		iSignal <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>memset</span>(chBuffer,<span style=color:#ae81ff>0</span>,SHARE_MEMORY_BUFFER_LEN);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//writeShareMemory.cpp
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;shmDatadef.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> argv[])
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>shm <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> stuShareMemory <span style=color:#f92672>*</span>stu <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> shmid <span style=color:#f92672>=</span> <span style=color:#a6e22e>shmget</span>((<span style=color:#66d9ef>key_t</span>)<span style=color:#ae81ff>1234</span>, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> stuShareMemory), <span style=color:#ae81ff>0666</span><span style=color:#f92672>|</span>IPC_CREAT);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span>(shmid <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;shmget err.</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	shm <span style=color:#f92672>=</span> <span style=color:#a6e22e>shmat</span>(shmid, (<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span>(shm <span style=color:#f92672>==</span> (<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;shmat err.</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	stu <span style=color:#f92672>=</span> (<span style=color:#66d9ef>struct</span> stuShareMemory<span style=color:#f92672>*</span>)shm;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	stu<span style=color:#f92672>-&gt;</span>iSignal <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//while(true) //如果需要多次 读取 可以启用 while
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span>(stu<span style=color:#f92672>-&gt;</span>iSignal <span style=color:#f92672>!=</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;write txt to shm.&#34;</span>);
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>memcpy</span>(stu<span style=color:#f92672>-&gt;</span>chBuffer, <span style=color:#e6db74>&#34;hello world 666 - 888.</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#ae81ff>30</span>);
</span></span><span style=display:flex><span>			stu<span style=color:#f92672>-&gt;</span>iSignal <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sleep</span>(<span style=color:#ae81ff>10</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>shmdt</span>(shm);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	std<span style=color:#f92672>::</span>cout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;end progress.&#34;</span> <span style=color:#f92672>&lt;&lt;</span> endl;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//readShareMemory.cpp
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;shmDatadef.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> argv[])
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>shm <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> stuShareMemory <span style=color:#f92672>*</span>stu;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> shmid <span style=color:#f92672>=</span> <span style=color:#a6e22e>shmget</span>((<span style=color:#66d9ef>key_t</span>)<span style=color:#ae81ff>1234</span>, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> stuShareMemory), <span style=color:#ae81ff>0666</span><span style=color:#f92672>|</span>IPC_CREAT);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span>(shmid <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;shmget err.</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	shm <span style=color:#f92672>=</span> <span style=color:#a6e22e>shmat</span>(shmid, (<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span>(shm <span style=color:#f92672>==</span> (<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;shmat err.</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	stu <span style=color:#f92672>=</span> (<span style=color:#66d9ef>struct</span> stuShareMemory<span style=color:#f92672>*</span>)shm;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	stu<span style=color:#f92672>-&gt;</span>iSignal <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//while(true)  //如果需要多次写入，可以启用while
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span>(stu<span style=color:#f92672>-&gt;</span>iSignal <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;current txt : %s&#34;</span>, stu<span style=color:#f92672>-&gt;</span>chBuffer);
</span></span><span style=display:flex><span>			stu<span style=color:#f92672>-&gt;</span>iSignal <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sleep</span>(<span style=color:#ae81ff>10</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>shmdt</span>(shm);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>shmctl</span>(shmid, IPC_RMID, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	std<span style=color:#f92672>::</span>cout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;end progress.&#34;</span> <span style=color:#f92672>&lt;&lt;</span> endl;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=2-管道>2. 管道</h4><ul><li>管道是单向的，管道有容量，当满了之后，读写会发送阻塞</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span><span style=color:#75715e>&lt;iostream&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/types.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/stat.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/stat.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;fcntl.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span><span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;signal.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define FIFO  &#34;/home/whb/projects/11.fifo&#34; </span><span style=color:#75715e>//有名管道的名字
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>using namespace std;
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> result , fd;<span style=color:#75715e>//result 为接收mkfifo的返回值   fd为打开文件的文件描述符
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>char</span> buffer[<span style=color:#ae81ff>20</span>] <span style=color:#f92672>=</span> { <span style=color:#ae81ff>0</span> };<span style=color:#75715e>//定义一个字符数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>access</span>(FIFO, F_OK)<span style=color:#f92672>==-</span><span style=color:#ae81ff>1</span>)<span style=color:#75715e>//判断是否已经创建了有名管道，如果已经创建，则返回0 否则返回非0的数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	{
</span></span><span style=display:flex><span>		result <span style=color:#f92672>=</span> <span style=color:#a6e22e>mkfifo</span>(FIFO, <span style=color:#ae81ff>0777</span>);<span style=color:#75715e>//创建有名管道,成功返回0,失败返回-1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> (result <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;creat mkfifo error&#34;</span>);
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	cout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;请输入数据：&#34;</span> <span style=color:#f92672>&lt;&lt;</span> endl;
</span></span><span style=display:flex><span>	<span style=color:#75715e>//以只写方式打开有名管道，不能同时以读写权限打开,成功返回文件描述符，失败返回 - 1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	fd <span style=color:#f92672>=</span> <span style=color:#a6e22e>open</span>(FIFO,O_WRONLY);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (fd <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;open error&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fgets</span>(buffer, <span style=color:#66d9ef>sizeof</span>(buffer), stdin);<span style=color:#75715e>//从终端输入数据到buffer中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>write</span>(fd, buffer, <span style=color:#a6e22e>strlen</span>(buffer));<span style=color:#75715e>//数据写到有名管道
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>memset</span>(buffer, <span style=color:#ae81ff>0x0</span>, <span style=color:#66d9ef>sizeof</span>(buffer));<span style=color:#75715e>//清空缓存区
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>close</span>(fd);<span style=color:#75715e>//关闭有名管道
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span><span style=color:#75715e>&lt;iostream&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/types.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/stat.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/types.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/stat.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;fcntl.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span><span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;signal.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define FIFO  &#34;/home/whb/projects/11.fifo&#34;</span><span style=color:#75715e>//有名管道的名字
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>using namespace std;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> result ,fd;<span style=color:#75715e>//result 接收mkfifo 的返回值  fd 文件描述符
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>char</span> buffer[<span style=color:#ae81ff>20</span>] <span style=color:#f92672>=</span> { <span style=color:#ae81ff>0</span> };
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>access</span>(FIFO, F_OK)<span style=color:#f92672>==-</span><span style=color:#ae81ff>1</span>)<span style=color:#75715e>//判断有名管道是否存在  不存在就创建  存在就不创建   已经创建返回0  否则非0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	{
</span></span><span style=display:flex><span>		result <span style=color:#f92672>=</span> <span style=color:#a6e22e>mkfifo</span>(FIFO, <span style=color:#ae81ff>0777</span>);<span style=color:#75715e>//创建有名管道  0 成功   -1 失败
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> (result <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;creat mkfifo error&#34;</span>);
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	fd <span style=color:#f92672>=</span> <span style=color:#a6e22e>open</span>(FIFO, O_RDONLY);<span style=color:#75715e>//只读的方式打开  返回小于0的值为打开失败
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> (fd <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;open error&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>read</span>(fd, buffer, <span style=color:#66d9ef>sizeof</span>(buffer));
</span></span><span style=display:flex><span>		cout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;buffer= &#34;</span> <span style=color:#f92672>&lt;&lt;</span> buffer <span style=color:#f92672>&lt;&lt;</span> endl;
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>memset</span>(buffer,<span style=color:#ae81ff>0</span>,<span style=color:#66d9ef>sizeof</span>(buffer));
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>close</span>(fd);<span style=color:#75715e>//关闭有名管道
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=3-unix-domain-socket-案例>3. Unix Domain Socket 案例</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span><span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span><span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span><span style=color:#75715e>&lt;sys/types.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span><span style=color:#75715e>&lt;sys/socket.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span><span style=color:#75715e>&lt;sys/un.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span><span style=color:#75715e>&lt;errno.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>//define send and recv buf size
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define BUFSIZE 512*1024
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>//define unix domain socket path
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define pmmanager &#34;/tmp/pmmanager&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define pmapi &#34;/tmp/pmapi&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span><span style=color:#f92672>**</span> argv)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> rx_buf[BUFSIZE];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> pmmanager_fd, ret;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>socklen_t</span> len;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> sockaddr_un pmmanager_addr, pmapi_addr;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//create pmmanager socket fd
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    pmmanager_fd <span style=color:#f92672>=</span> <span style=color:#a6e22e>socket</span>(AF_UNIX, SOCK_DGRAM, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(pmmanager_fd <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;cannot create pmmanager fd.&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>unlink</span>(pmmanager);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>pmmanager_addr, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(pmmanager_addr));
</span></span><span style=display:flex><span>    pmmanager_addr.sun_family <span style=color:#f92672>=</span> AF_UNIX;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>strncpy</span>(pmmanager_addr.sun_path, pmmanager, <span style=color:#66d9ef>sizeof</span>(pmmanager_addr.sun_path)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//bind pmmanager_fd to pmmanager_addr
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>bind</span>(pmmanager_fd, (<span style=color:#66d9ef>struct</span> sockaddr<span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>pmmanager_addr, <span style=color:#66d9ef>sizeof</span>(pmmanager_addr));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(ret <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;can not bind pmmanager_addr&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> recvBufSize;
</span></span><span style=display:flex><span>    len <span style=color:#f92672>=</span> <span style=color:#66d9ef>sizeof</span>(recvBufSize);
</span></span><span style=display:flex><span>    ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>getsockopt</span>(pmmanager_fd, SOL_SOCKET, SO_RCVBUF, <span style=color:#f92672>&amp;</span>recvBufSize, <span style=color:#f92672>&amp;</span>len);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(ret <span style=color:#f92672>==-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;getsocket error.&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Before setsockopt, SO_RCVBUF-%d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,recvBufSize); 
</span></span><span style=display:flex><span>    recvBufSize <span style=color:#f92672>=</span> <span style=color:#ae81ff>512</span><span style=color:#f92672>*</span><span style=color:#ae81ff>1024</span>;
</span></span><span style=display:flex><span>    ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>setsockopt</span>(pmmanager_fd, SOL_SOCKET, SO_RCVBUF, <span style=color:#f92672>&amp;</span>recvBufSize, len);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(ret <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;setsockopt error.&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>getsockopt</span>(pmmanager_fd, SOL_SOCKET, SO_RCVBUF, <span style=color:#f92672>&amp;</span>recvBufSize, <span style=color:#f92672>&amp;</span>len);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(ret <span style=color:#f92672>==-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;getsocket error.&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Set recv buf successful, SO_RCVBUF-%d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,recvBufSize); 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> recvSize;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>pmapi_addr, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(pmapi_addr));
</span></span><span style=display:flex><span>    len <span style=color:#f92672>=</span> <span style=color:#66d9ef>sizeof</span>(pmapi_addr);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;==============wait for msg from pmapi====================</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span>(;;)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>memset</span>(rx_buf, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(rx_buf));
</span></span><span style=display:flex><span>        recvSize <span style=color:#f92672>=</span> <span style=color:#a6e22e>recvfrom</span>(pmmanager_fd, rx_buf, <span style=color:#66d9ef>sizeof</span>(rx_buf), <span style=color:#ae81ff>0</span>, (<span style=color:#66d9ef>struct</span> sockaddr<span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>pmapi_addr, <span style=color:#f92672>&amp;</span>len);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(recvSize <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;recvfrom error.&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Recved message from pmapi: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, rx_buf);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span><span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span><span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span><span style=color:#75715e>&lt;sys/types.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span><span style=color:#75715e>&lt;sys/socket.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span><span style=color:#75715e>&lt;sys/un.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span><span style=color:#75715e>&lt;errno.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>//define send and recv buf size
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define BUFSIZE 250*1024
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>//define unix domain socket path
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define pmmanager &#34;/tmp/pmmanager&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define pmapi &#34;/tmp/pmapi&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span><span style=color:#f92672>**</span> argv)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> tx_buf[BUFSIZE];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> pmapi_fd, ret;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>socklen_t</span> len;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> sockaddr_un pmmanager_addr, pmapi_addr;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//create pmmanager socket fd
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    pmapi_fd <span style=color:#f92672>=</span> <span style=color:#a6e22e>socket</span>(AF_UNIX, SOCK_DGRAM, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(pmapi_fd <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;cannot create pmapi fd.&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>unlink</span>(pmapi);
</span></span><span style=display:flex><span>    <span style=color:#75715e>//configure pmapi&#39;s addr
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>pmapi_addr, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(pmapi_addr));
</span></span><span style=display:flex><span>    pmapi_addr.sun_family <span style=color:#f92672>=</span> AF_UNIX;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>strncpy</span>(pmapi_addr.sun_path, pmapi, <span style=color:#66d9ef>sizeof</span>(pmapi_addr.sun_path)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>//bind pmapi_fd to pmapi_addr
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>bind</span>(pmapi_fd, (<span style=color:#66d9ef>struct</span> sockaddr<span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>pmapi_addr, <span style=color:#66d9ef>sizeof</span>(pmapi_addr));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(ret <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;bind error.&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> sendBufSize;
</span></span><span style=display:flex><span>    len <span style=color:#f92672>=</span> <span style=color:#66d9ef>sizeof</span>(sendBufSize);
</span></span><span style=display:flex><span>    ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>getsockopt</span>(pmapi_fd, SOL_SOCKET, SO_SNDBUF, <span style=color:#f92672>&amp;</span>sendBufSize, <span style=color:#f92672>&amp;</span>len);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(ret <span style=color:#f92672>==-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;getsocket error.&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Before setsockopt, SO_SNDBUF-%d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,sendBufSize); 
</span></span><span style=display:flex><span>    sendBufSize <span style=color:#f92672>=</span> <span style=color:#ae81ff>512</span><span style=color:#f92672>*</span><span style=color:#ae81ff>1024</span>;
</span></span><span style=display:flex><span>    ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>setsockopt</span>(pmapi_fd, SOL_SOCKET, SO_SNDBUF, <span style=color:#f92672>&amp;</span>sendBufSize, len);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(ret <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;setsockopt error.&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>getsockopt</span>(pmapi_fd, SOL_SOCKET, SO_SNDBUF, <span style=color:#f92672>&amp;</span>sendBufSize, <span style=color:#f92672>&amp;</span>len);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(ret <span style=color:#f92672>==-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;getsocket error.&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Set send buf successful, SO_SNDBUF-%d</span><span style=color:#ae81ff>\n\n\n</span><span style=color:#e6db74>&#34;</span>, sendBufSize); 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//configure pmmanager&#39;s addr
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>pmmanager_addr, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(pmmanager_addr));
</span></span><span style=display:flex><span>    pmmanager_addr.sun_family <span style=color:#f92672>=</span> AF_UNIX;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>strncpy</span>(pmmanager_addr.sun_path, pmmanager, <span style=color:#66d9ef>sizeof</span>(pmmanager_addr)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    len <span style=color:#f92672>=</span> <span style=color:#66d9ef>sizeof</span>(pmmanager_addr);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> sendSize <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> i;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span>(i<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>; i<span style=color:#f92672>&lt;=</span><span style=color:#ae81ff>4</span>; i<span style=color:#f92672>++</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>memset</span>(tx_buf, <span style=color:#e6db74>&#39;0&#39;</span>, <span style=color:#66d9ef>sizeof</span>(tx_buf));
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sprintf</span>(tx_buf, <span style=color:#e6db74>&#34;send msg %d to pmmanager.&#34;</span>, i);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;%s, msg size - %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,tx_buf, <span style=color:#66d9ef>sizeof</span>(tx_buf));
</span></span><span style=display:flex><span>        sendSize <span style=color:#f92672>=</span> <span style=color:#a6e22e>sendto</span>(pmapi_fd, tx_buf, <span style=color:#66d9ef>sizeof</span>(tx_buf), <span style=color:#ae81ff>0</span>, (<span style=color:#66d9ef>struct</span> sockaddr<span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>pmmanager_addr, len);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(sendSize <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;sendto error.&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Send message to pmmanager: %s</span><span style=color:#ae81ff>\n\n\n</span><span style=color:#e6db74>&#34;</span>, tx_buf);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=4mmap>4.mmap</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/stat.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;fcntl.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/mman.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sys_err</span>(<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>str)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>perror</span>(str);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>mem <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> len <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> fd <span style=color:#f92672>=</span> <span style=color:#a6e22e>open</span>(<span style=color:#e6db74>&#34;hello244&#34;</span>, O_RDWR<span style=color:#f92672>|</span>O_CREAT<span style=color:#f92672>|</span>O_TRUNC, <span style=color:#ae81ff>0644</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (fd <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>){
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sys_err</span>(<span style=color:#e6db74>&#34;open error&#34;</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>	<span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>	注意：由于mmap的参2是开辟文件大小的映射区，完美open时是一个新文件，
</span></span></span><span style=display:flex><span><span style=color:#75715e>	此时大小为0，所以必须保证文件大小充足才能成功调用mmap开辟映射区。
</span></span></span><span style=display:flex><span><span style=color:#75715e>	这就是下面两个方法的原因。
</span></span></span><span style=display:flex><span><span style=color:#75715e>	方法1
</span></span></span><span style=display:flex><span><span style=color:#75715e>    lseek(fd, 19, SEEK_END);	  //将文件下标移至19个字节
</span></span></span><span style=display:flex><span><span style=color:#75715e>    write(fd, &#34;\0&#34;, 1);			  //往文件写0，补充结尾。19+1=20个字节
</span></span></span><span style=display:flex><span><span style=color:#75715e>	len = lseek(fd, 0, SEEK_END); //利用lseek的返回值获取当前文件下标即文件大小
</span></span></span><span style=display:flex><span><span style=color:#75715e>	printf(&#34;The length of file = %d\n&#34;, len);
</span></span></span><span style=display:flex><span><span style=color:#75715e>    */</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>//方法2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ftruncate</span>(fd, <span style=color:#ae81ff>20</span>);<span style=color:#75715e>//该函数和lseek+write作用一样
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	len <span style=color:#f92672>=</span> <span style=color:#a6e22e>lseek</span>(fd, <span style=color:#ae81ff>0</span>, SEEK_END);
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>    mem <span style=color:#f92672>=</span> <span style=color:#a6e22e>mmap</span>(NULL, len, PROT_WRITE, MAP_SHARED, fd, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (mem <span style=color:#f92672>==</span> MAP_FAILED){
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sys_err</span>(<span style=color:#e6db74>&#34;mmap err: &#34;</span>);
</span></span><span style=display:flex><span>	} 
</span></span><span style=display:flex><span>	<span style=color:#75715e>//此时可以直接关闭描述符，因为mem已经代替其作用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>close</span>(fd);
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>//使用mem(内存)对磁盘文件进行读写操作。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>strcpy</span>(mem, <span style=color:#e6db74>&#34;hello mmap&#34;</span>);<span style=color:#75715e>//写
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;%s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, mem);<span style=color:#75715e>//读
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>munmap</span>(mem, mem) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>){
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sys_err</span>(<span style=color:#e6db74>&#34;munmap&#34;</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=4-rpc-机制>4. RPC 机制</h4><ul><li>学习具体框架MecuryRPC 框架深入学习</li></ul><h4 id=5-同步互斥>5. 同步互斥</h4><h5 id=1-信号量semaphore--mutex>1. 信号量（Semaphore) & Mutex</h5><ul><li><strong>Mutex</strong>是一把钥匙，一个人拿了就可进入一个房间，出来的时候把钥匙交给队列的第一个。一般的用法是用于串行化对critical section代码的访问，保证这段代码不会被并行的运行。</li><li><strong>Semaphore</strong>是一件可以容纳N人的房间，如果人不满就可以进去，如果人满了，就要等待有人出来。对于N=1的情况，称为binary semaphore。一般的用法是，用于限制对于某一资源的同时访问。</li></ul><h5 id=2-monitor>2. Monitor</h5><h5 id=3-condition>3. Condition</h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Condition</span>{
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>enum</span>{
</span></span><span style=display:flex><span>        PRIVATE<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        SHARED<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    status_t <span style=color:#a6e22e>wait</span>(Mutex<span style=color:#f92672>&amp;</span> mutex);
</span></span><span style=display:flex><span>    status_t <span style=color:#a6e22e>waitRelative</span>(Mutex<span style=color:#f92672>&amp;</span> mutex, nsecs_t reltime);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>signal</span>(); <span style=color:#75715e>//条件满足时通知相应等待者
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>broadcast</span>(); <span style=color:#75715e>//条件满足时通知所有等待者
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>private</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#if defined {HAVE_PTHREADS}
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    	pthread_cond_t mCond;
</span></span><span style=display:flex><span>    <span style=color:#75715e>#else
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    	<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> mState;
</span></span><span style=display:flex><span>    <span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span></code></pre></div><h5 id=4-barrier>4. Barrier</h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Barrier</span>{
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>inline</span> Barrier()<span style=color:#f92672>:</span>state(CLOSED){}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>inline</span> <span style=color:#f92672>~</span>Barrier(){}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>open</span>(){
</span></span><span style=display:flex><span>        Mutex<span style=color:#f92672>::</span> Autolock _l(lock);
</span></span><span style=display:flex><span>        state<span style=color:#f92672>=</span>OPENED;
</span></span><span style=display:flex><span>        cv.broadcast();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>close</span>(){
</span></span><span style=display:flex><span>        Mutex<span style=color:#f92672>::</span> Autolock _l(lock);
</span></span><span style=display:flex><span>        state<span style=color:#f92672>=</span>CLOSED;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wait</span>() <span style=color:#66d9ef>const</span>{
</span></span><span style=display:flex><span>        Mutex<span style=color:#f92672>::</span> Autolock _l(lock);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span>(state<span style=color:#f92672>==</span>CLOSED){
</span></span><span style=display:flex><span>            cv.wait(lock);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>enum</span> {OPENED,CLOSED};
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>mutable</span> Mutex lock;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>mutable</span> Condition cv;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>int</span> state;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Autolock</span>{
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>inline</span> Autolock(Mutex<span style=color:#f92672>&amp;</span> mutex)<span style=color:#f92672>:</span> mLock(mutex){mLock.lock();}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>inline</span> <span style=color:#a6e22e>AUtolock</span>(Mutex<span style=color:#f92672>*</span> mutex)<span style=color:#f92672>:</span> mLock(<span style=color:#f92672>*</span>mutex){mLock.lock();}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>inline</span> <span style=color:#f92672>~</span>Autolock(){mLock.unlock();}
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    Mutex<span style=color:#f92672>&amp;</span> mLock;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h3 id=5-android-进程线程理解>5. Android 进程线程理解</h3><ul><li>activity 和 service 的主线程是 ActivityThread.java,</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>traceBegin</span><span style=color:#f92672>(</span>Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>TRACE_TAG_ACTIVITY_MANAGER</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;ActivityThreadMain&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Install selective syscall interception
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        AndroidOs<span style=color:#f92672>.</span><span style=color:#a6e22e>install</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// CloseGuard defaults to true and can be quite spammy.  We
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// disable it here, but selectively enable it later (via
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// StrictMode) on debug builds, but using DropBox, not logs.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        CloseGuard<span style=color:#f92672>.</span><span style=color:#a6e22e>setEnabled</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Environment<span style=color:#f92672>.</span><span style=color:#a6e22e>initForCurrentUser</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Make sure TrustedCertificateStore looks in the right place for CA certificates
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>final</span> File configDir <span style=color:#f92672>=</span> Environment<span style=color:#f92672>.</span><span style=color:#a6e22e>getUserConfigDirectory</span><span style=color:#f92672>(</span>UserHandle<span style=color:#f92672>.</span><span style=color:#a6e22e>myUserId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        TrustedCertificateStore<span style=color:#f92672>.</span><span style=color:#a6e22e>setDefaultUserDirectory</span><span style=color:#f92672>(</span>configDir<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Call per-process mainline module initialization.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        initializeMainlineModules<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Process<span style=color:#f92672>.</span><span style=color:#a6e22e>setArgV0</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&lt;pre-initialized&gt;&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>prepareMainLooper</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Find the value for {@link #PROC_START_SEQ_IDENT} if provided on the command line.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// It will be in the format &#34;seq=114&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>long</span> startSeq <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>args <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> args<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> 1<span style=color:#f92672>;</span> i <span style=color:#f92672>&gt;=</span> 0<span style=color:#f92672>;</span> <span style=color:#f92672>--</span>i<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>args<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> args<span style=color:#f92672>[</span>i<span style=color:#f92672>].</span><span style=color:#a6e22e>startsWith</span><span style=color:#f92672>(</span>PROC_START_SEQ_IDENT<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    startSeq <span style=color:#f92672>=</span> Long<span style=color:#f92672>.</span><span style=color:#a6e22e>parseLong</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                            args<span style=color:#f92672>[</span>i<span style=color:#f92672>].</span><span style=color:#a6e22e>substring</span><span style=color:#f92672>(</span>PROC_START_SEQ_IDENT<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        ActivityThread thread <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ActivityThread<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        thread<span style=color:#f92672>.</span><span style=color:#a6e22e>attach</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> startSeq<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sMainThreadHandler <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            sMainThreadHandler <span style=color:#f92672>=</span> thread<span style=color:#f92672>.</span><span style=color:#a6e22e>getHandler</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>myLooper</span><span style=color:#f92672>().</span><span style=color:#a6e22e>setMessageLogging</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span>
</span></span><span style=display:flex><span>                    LogPrinter<span style=color:#f92672>(</span>Log<span style=color:#f92672>.</span><span style=color:#a6e22e>DEBUG</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;ActivityThread&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// End of event ActivityThreadMain.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>traceEnd</span><span style=color:#f92672>(</span>Trace<span style=color:#f92672>.</span><span style=color:#a6e22e>TRACE_TAG_ACTIVITY_MANAGER</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>loop</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Main thread loop unexpectedly exited&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>同一个程序包中包含俩个 Activity， 他们关系：运行在同一个进程中，可以访问静态变量， 主线程只有一个，切换时Binder数量有变化</li><li>不同包的组件可以通过android:process 属性表明组件运行在哪一个进程空间中。</li><li>一个Activity启动后至少会有3个线程，及一个主线程&俩个Binder线程。</li><li>四大组件 activity，service，receiver，provider只是Application零件。</li></ul><h4 id=0-handler-looper-message-messagequeue-类关系>.0. Handler, Looper, Message, MessageQueue 类关系</h4><p><img class=lazyload src=/liudongdong1.github.io/svg/loading.min.svg data-src=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221128104919571.png data-srcset="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221128104919571.png, https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221128104919571.png 1.5x, https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221128104919571.png 2x" data-sizes=auto alt=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221128104919571.png title=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221128104919571.png></p><h4 id=1-binder>.1. <strong>Binder</strong></h4><blockquote><p>Binder通信采用c/s架构，从组件视角来说，包含<code>Client、Server、ServiceManager以及binder驱动</code>，其中ServiceManager用于管理系统中的各种服务。Service Manager是指Native层的ServiceManager（C++），并非指framework层的ServiceManager(Java)。ServiceManager是整个Binder通信机制的大管家，是Android进程间通信机制Binder的守护进程，要掌握Binder机制，首先需要了解系统是如何首次<a href=http://gityuan.com/2015/11/07/binder-start-sm/ target=_blank rel="external nofollow noopener noreferrer">启动Service Manager<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a>。当Service Manager启动之后，Client端和Server端通信时都需要先<a href=http://gityuan.com/2015/11/08/binder-get-sm/ target=_blank rel="external nofollow noopener noreferrer">获取Service Manager<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a>接口，才能开始通信服务。</p><ul><li>binder dirver会将自己注册成一个misc device，并向上层提供一个/dev/binder节点，该驱动运行与内核态，提供open，ioctl，mmap操作</li></ul><ol><li><strong><a href=http://gityuan.com/2015/11/14/binder-add-service/ target=_blank rel="external nofollow noopener noreferrer">注册服务(addService)<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></strong>：Server进程要先注册Service到ServiceManager。该过程：Server是客户端，ServiceManager是服务端。</li><li><strong><a href=http://gityuan.com/2015/11/15/binder-get-service/ target=_blank rel="external nofollow noopener noreferrer">获取服务(getService)<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></strong>：Client进程使用某个Service前，须先向ServiceManager中获取相应的Service。该过程：Client是客户端，ServiceManager是服务端。</li><li><strong>使用服务</strong>：Client根据得到的Service信息建立与Service所在的Server进程通信的通路，然后就可以直接与Service交互。该过程：client是客户端，server是服务端。</li></ol></blockquote><p><img class=lazyload src=/liudongdong1.github.io/svg/loading.min.svg data-src=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221122110712185.png data-srcset="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221122110712185.png, https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221122110712185.png 1.5x, https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221122110712185.png 2x" data-sizes=auto alt=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221122110712185.png title=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221122110712185.png></p><p><img class=lazyload src=/liudongdong1.github.io/svg/loading.min.svg data-src=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221128123857494.png data-srcset="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221128123857494.png, https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221128123857494.png 1.5x, https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221128123857494.png 2x" data-sizes=auto alt=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221128123857494.png title=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221128123857494.png></p><p><img class=lazyload src=/liudongdong1.github.io/svg/loading.min.svg data-src=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221123154311314.png data-srcset="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221123154311314.png, https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221123154311314.png 1.5x, https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221123154311314.png 2x" data-sizes=auto alt=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221123154311314.png title=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221123154311314.png></p><p><img class=lazyload src=/liudongdong1.github.io/svg/loading.min.svg data-src=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221122101702736.png data-srcset="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221122101702736.png, https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221122101702736.png 1.5x, https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221122101702736.png 2x" data-sizes=auto alt=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221122101702736.png title=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221122101702736.png></p><ul><li>以后自己理解代码调用过程的时候，借鉴这里的分析流程，做好说明</li><li>Service Manager 不断读取消息的循环中处理客户端请求</li></ul><p><img class=lazyload src=/liudongdong1.github.io/svg/loading.min.svg data-src=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221128151112016.png data-srcset="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221128151112016.png, https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221128151112016.png 1.5x, https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221128151112016.png 2x" data-sizes=auto alt=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221128151112016.png title=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221128151112016.png></p><blockquote><p><code>每个Android的进程，只能运行在自己进程所拥有的虚拟地址空间</code>。对应一个4GB的虚拟地址空间，其中3GB是用户空间，1GB是内核空间，当然内核空间的大小是可以通过参数配置调整的。对于<code>用户空间，不同进程之间彼此是不能共享的，而内核空间却是可共享的</code>。Client进程向Server进程通信，恰恰是<code>利用进程间可共享的内核内存空间来完成底层通信工作的</code>，Client端与Server端进程往往采用ioctl等方法跟内核空间的驱动进行交互。</p></blockquote><h4 id=2-socket>.2. Socket</h4><p>Socket通信方式也是C/S架构，比Binder简单很多。在Android系统中采用Socket通信方式的主要有：</p><ul><li>zygote：用于孵化进程，<code>system_server创建进程是通过socket向zygote进程发起请求</code>；</li><li>installd：用于<code>安装App的守护进程</code>，上层PackageManagerService很多实现最终都是交给它来完成；</li><li>lmkd：lowmemorykiller的守护进程，Java层的LowMemoryKiller最终都是由lmkd来完成；</li><li>adbd：这个也不用说，用于<code>服务adb</code>；</li><li>logcatd:这个不用说，用于<code>服务logcat</code>；</li><li>vold：即volume Daemon，是存储类的守护进程，用于负责如USB、Sdcard等存储设备的事件处理。</li></ul><h4 id=3-handler>.3. Handler</h4><blockquote><p><code>Binder/Socket用于进程间通信</code>，而``Handler消息机制用于同进程的线程间通信<code>(</code>只能用于共享内存地址空间的两个线程间通信)，Handler消息机制是由一组<code>MessageQueue、Message、Looper、Handler共同组成的</code>，为了方便且称之为Handler消息机制。</p></blockquote><p><img class=lazyload src=/liudongdong1.github.io/svg/loading.min.svg data-src=https://gitee.com/github-25970295/blogpictureV2/raw/master/image-20211107143740784.png data-srcset="https://gitee.com/github-25970295/blogpictureV2/raw/master/image-20211107143740784.png, https://gitee.com/github-25970295/blogpictureV2/raw/master/image-20211107143740784.png 1.5x, https://gitee.com/github-25970295/blogpictureV2/raw/master/image-20211107143740784.png 2x" data-sizes=auto alt=https://gitee.com/github-25970295/blogpictureV2/raw/master/image-20211107143740784.png title=https://gitee.com/github-25970295/blogpictureV2/raw/master/image-20211107143740784.png></p><blockquote><p>由于工作线程与主线程共享地址空间，即Handler实例对象mHandler位于线程间共享的内存堆上，工作线程与主线程都能直接使用该对象，只需要<code>注意多线程的同步问题</code>。工作线程通过mHandler向其成员变量MessageQueue中添加新Message，主线程一直处于loop()方法内，当收到新的Message时按照一定规则分发给相应的handleMessage()方法来处理。</p></blockquote><p><img class=lazyload src=/liudongdong1.github.io/svg/loading.min.svg data-src=https://gitee.com/github-25970295/blogpictureV2/raw/master/image-20211107144203557.png data-srcset="https://gitee.com/github-25970295/blogpictureV2/raw/master/image-20211107144203557.png, https://gitee.com/github-25970295/blogpictureV2/raw/master/image-20211107144203557.png 1.5x, https://gitee.com/github-25970295/blogpictureV2/raw/master/image-20211107144203557.png 2x" data-sizes=auto alt=https://gitee.com/github-25970295/blogpictureV2/raw/master/image-20211107144203557.png title=https://gitee.com/github-25970295/blogpictureV2/raw/master/image-20211107144203557.png></p><p>Low Memory Killer</p><ul><li>进行资源释放回收</li></ul><p>Anonymous Shared Memory（代码解析87页）</p><ul><li>将指定的物理内存分别映射到各自的虚拟地址空间中，从而便捷的实现进程间内存共享</li><li>类似binder可以看作时一个共享设备</li><li>设备节点什么时候创建</li><li>提供了哪些函数操作，以及函数实现原理</li><li>与Linux 内存共享机制有什么区别</li><li>代码解析： <a href=https://redspider110.github.io/2018/01/17/0043-android-ashmem/ target=_blank rel="external nofollow noopener noreferrer">https://redspider110.github.io/2018/01/17/0043-android-ashmem/<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></li></ul><p><img class=lazyload src=/liudongdong1.github.io/svg/loading.min.svg data-src=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221120153232402.png data-srcset="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221120153232402.png, https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221120153232402.png 1.5x, https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221120153232402.png 2x" data-sizes=auto alt=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221120153232402.png title=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221120153232402.png></p><h3 id=6-gui显示>6. GUI显示</h3><h4 id=1-surfaceflinger>.1. SurfaceFlinger</h4><ul><li>SurfaceFlinger 需要手机系统中所有的应用程序绘制的图像数据，然后集中显示到物理屏幕上</li><li>OpenGL ES 通过ANativeWindow 来与本地窗口系统建立正确的连接。</li></ul><p><img class=lazyload src=/liudongdong1.github.io/svg/loading.min.svg data-src=https://gitee.com/github-25970295/blogimgv2022/raw/master/Center.png data-srcset="https://gitee.com/github-25970295/blogimgv2022/raw/master/Center.png, https://gitee.com/github-25970295/blogimgv2022/raw/master/Center.png 1.5x, https://gitee.com/github-25970295/blogimgv2022/raw/master/Center.png 2x" data-sizes=auto alt=https://gitee.com/github-25970295/blogimgv2022/raw/master/Center.png title=https://gitee.com/github-25970295/blogimgv2022/raw/master/Center.png></p><p>1） 这里的FrameBuffer指显示设备驱动和Gralloc帧缓冲区管理</p><p>2） 面向SurfaceFlinger的<a href="https://so.csdn.net/so/search?q=Native&amp;spm=1001.2101.3001.7020" target=_blank rel="external nofollow noopener noreferrer">Native<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a> Window</p><p>3） 通过<a href="https://so.csdn.net/so/search?q=OpenGl&amp;spm=1001.2101.3001.7020" target=_blank rel="external nofollow noopener noreferrer">OpenGl<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a> ES图形库来处理图形数据后绘制到NativeWindow</p><p>4） SurfaceFlinger，是一个binderservice，用于管理接收各个App传输过来的图形数据</p><p>5） 面向App应用窗口绘制的Native Window</p><p>6） 采用OpenGL ES或者SKIA将图形数据绘制到Native Window，对于普通应用开发人员来说，使用OpenGLES的门槛相对会比较高，所以SKIA第三方<a href="https://so.csdn.net/so/search?q=%e5%9b%be%e5%bd%a2%e5%ba%93&amp;spm=1001.2101.3001.7020" target=_blank rel="external nofollow noopener noreferrer">图形库<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a>基于OpenGL ES做了封装，提供更加简单的GUI接口供开发人员使用，SKIA是Android应用默认的图形引擎</p><h4 id=2-windowmanageservicewms>.2. WindowManageService(WMS)</h4><p><img class=lazyload src=/liudongdong1.github.io/svg/loading.min.svg data-src=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221129092634957.png data-srcset="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221129092634957.png, https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221129092634957.png 1.5x, https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221129092634957.png 2x" data-sizes=auto alt=image-20221129092634957 title=image-20221129092634957></p><p><img class=lazyload src=/liudongdong1.github.io/svg/loading.min.svg data-src=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221129093908589.png data-srcset="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221129093908589.png, https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221129093908589.png 1.5x, https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221129093908589.png 2x" data-sizes=auto alt=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221129093908589.png title=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221129093908589.png></p><p><img class=lazyload src=/liudongdong1.github.io/svg/loading.min.svg data-src=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221129094135012.png data-srcset="https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221129094135012.png, https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221129094135012.png 1.5x, https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221129094135012.png 2x" data-sizes=auto alt=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221129094135012.png title=https://gitee.com/github-25970295/blogimgv2022/raw/master/image-20221129094135012.png></p><h3 id=resource>Resource</h3><ul><li>学习链接： <a href=https://cloud.tencent.com/developer/article/1415759 target=_blank rel="external nofollow noopener noreferrer">https://cloud.tencent.com/developer/article/1415759<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="2023-09-24 17:00:03">更新于 2023-09-24&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=liudongdong1.github.io/androidframework/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span><span><a href=https://liudongdong1.github.io/edit/master/content/posts%5cAndroid%5cAndroidFramework%5cAndroidFrameWork.md title=编辑此页 target=_blank rel="external nofollow noopener noreferrer" class=link-to-edit>编辑此页</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=liudongdong1.github.io/androidframework/ data-title=AndroidFramework data-hashtags=Android><i class="fa-brands fa-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=liudongdong1.github.io/androidframework/ data-hashtag=Android><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=liudongdong1.github.io/androidframework/ data-title=AndroidFramework data-image=https://cdn.stocksnap.io/img-thumbs/280h/2UNU086C0B.jpg><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=liudongdong1.github.io/tags/android/>Android</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=liudongdong1.github.io/>主页</a></span></section></div><div class=post-nav><a href=liudongdong1.github.io/makebuildrelative/ class=prev rel=prev title=MakeBuildRelative><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>MakeBuildRelative</a>
<a href=liudongdong1.github.io/androidaidl/ class=next rel=next title=AndroidAIDL>AndroidAIDL<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line powered">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.118.2">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.2.17-RC"><img class=fixit-icon src=/liudongdong1.github.io/fixit.min.svg alt="FixIt logo">&nbsp;FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2020 - 2023</span><span class=author itemprop=copyrightHolder>
<a href=https://liudongdong1.github.io/ target=_blank rel="external nofollow noopener noreferrer">LiuDongdong</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"><span class=site-time title='网站运行中 ...'><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden=true></i>&nbsp;<span class=run-times>网站运行中 ...</span></span></div><div class="footer-line ibruce"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div></div><a href=https://liudongdong1.github.io/ title="在 GitHub 上查看源代码" target=_blank rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;top:0;--bg-progress:#0076ff;--bg-progress-dark:#fff></div><noscript><div class=noscript-warning>FixIt 主题在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/liudongdong1.github.io/lib/katex/katex.min.css><link rel=stylesheet href=/liudongdong1.github.io/lib/cookieconsent/cookieconsent.min.css><script src=/liudongdong1.github.io/lib/autocomplete/autocomplete.min.js defer></script><script src=/liudongdong1.github.io/lib/algoliasearch/algoliasearch-lite.umd.min.js defer></script><script src=/liudongdong1.github.io/lib/lazysizes/lazysizes.min.js async defer></script><script src=/liudongdong1.github.io/lib/sharer/sharer.min.js async defer></script><script src=/liudongdong1.github.io/lib/typeit/index.umd.js defer></script><script src=/liudongdong1.github.io/lib/katex/katex.min.js defer></script><script src=/liudongdong1.github.io/lib/katex/auto-render.min.js defer></script><script src=/liudongdong1.github.io/lib/katex/copy-tex.min.js defer></script><script src=/liudongdong1.github.io/lib/katex/mhchem.min.js defer></script><script src=/liudongdong1.github.io/lib/cookieconsent/cookieconsent.min.js defer></script><script src=/liudongdong1.github.io/lib/pangu/pangu.min.js defer></script><script src=/liudongdong1.github.io/lib/cell-watermark/watermark.min.js defer></script><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:10},comment:{enable:!1},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},data:{"typeit-header-subtitle-desktop":`<span style='font-family: MMT,"沐目体";'>吾日三省吾身</span>`,"typeit-header-subtitle-mobile":`<span style='font-family: MMT,"沐目体";'>吾日三省吾身</span>`},enablePWA:!0,enablePangu:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"2R1K9SKLQZ",algoliaIndex:"index.zh-cn",algoliaSearchKey:"4a226aa1c5c98d6859e4d1386adb2bc7",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},siteTime:"2020-12-18T16:15:22+08:00",typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"typeit-header-subtitle-desktop":["typeit-header-subtitle-desktop"],"typeit-header-subtitle-mobile":["typeit-header-subtitle-mobile"]},duration:-1,speed:100},watermark:{appendto:".wrapper>main",colspacing:30,content:'<img class="fixit-icon" src="/fixit.min.svg" alt="FixIt logo" /> FixIt 主题',enable:!0,fontfamily:"inherit",fontsize:.85,height:21,opacity:.0125,rotate:15,rowspacing:60,width:150}}</script><script src=/liudongdong1.github.io/js/theme.min.js defer></script><script src=/liudongdong1.github.io/js/custom.min.js defer></script></body></html>