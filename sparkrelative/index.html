<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>sparkRelative - DAY By DAY</title><meta name="author" content="LiuDongdong">
<meta name="author-link" content="https://liudongdong1.github.io/">
<meta name="description" content="1. 部署方式 1.1. Local 模式 Local模式就是运行在一台计算机上的模式，通常用于在本机上测试，当不设置master参数的值时，默认此模式，具体有以下几" /><meta name="keywords" content='stream, spark' /><meta itemprop="name" content="sparkRelative">
<meta itemprop="description" content="1. 部署方式 1.1. Local 模式 Local模式就是运行在一台计算机上的模式，通常用于在本机上测试，当不设置master参数的值时，默认此模式，具体有以下几"><meta itemprop="datePublished" content="2020-01-13T21:59:57+00:00" />
<meta itemprop="dateModified" content="2023-12-31T16:28:09+08:00" />
<meta itemprop="wordCount" content="7876"><meta itemprop="image" content="https://liudongdong1.github.io/logo.png"/>
<meta itemprop="keywords" content="stream,spark," /><meta property="og:title" content="sparkRelative" />
<meta property="og:description" content="1. 部署方式 1.1. Local 模式 Local模式就是运行在一台计算机上的模式，通常用于在本机上测试，当不设置master参数的值时，默认此模式，具体有以下几" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://liudongdong1.github.io/sparkrelative/" /><meta property="og:image" content="https://liudongdong1.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-01-13T21:59:57+00:00" />
<meta property="article:modified_time" content="2023-12-31T16:28:09+08:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://liudongdong1.github.io/logo.png"/>

<meta name="twitter:title" content="sparkRelative"/>
<meta name="twitter:description" content="1. 部署方式 1.1. Local 模式 Local模式就是运行在一台计算机上的模式，通常用于在本机上测试，当不设置master参数的值时，默认此模式，具体有以下几"/>
<meta name="application-name" content="DAY By DAY">
<meta name="apple-mobile-web-app-title" content="DAY By DAY"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://liudongdong1.github.io/sparkrelative/" /><link rel="prev" href="https://liudongdong1.github.io/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" /><link rel="next" href="https://liudongdong1.github.io/virtualkeys/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "sparkRelative",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/liudongdong1.github.io\/sparkrelative\/"
    },"genre": "posts","keywords": "stream, spark","wordcount":  7876 ,
    "url": "https:\/\/liudongdong1.github.io\/sparkrelative\/","datePublished": "2020-01-13T21:59:57+00:00","dateModified": "2023-12-31T16:28:09+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
      "@type": "Organization",
      "name": "LiuDongdong","logo": "https:\/\/liudongdong1.github.io\/images\/person.png"},"author": {
        "@type": "Person",
        "name": "liudongdong1"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="auto" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper"><script type="text/javascript"
        async
        src="https://cdnjs.cloudflare.com/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$']],
    displayMath: [['$$','$$']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>
<header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper" data-github-corner="right">
    <div class="header-title">
      <a href="/" title="DAY By DAY"><img
    class="lazyload logo"
    src="/svg/loading.min.svg"
    data-src="/fixit.min.svg"
    data-srcset="/fixit.min.svg, /fixit.min.svg 1.5x, /fixit.min.svg 2x"
    data-sizes="auto"
    alt="DAY By DAY"
    title="DAY By DAY"/><span class="header-title-text"></span></a><span id="typeit-header-subtitle-desktop" class="typeit header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 所有文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/friends/"
                title="友情链接"
                
              ><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden="true"></i> 友链</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              ><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden="true"></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item language">
            <span role="button" aria-label="选择语言" title="选择语言">简体中文<i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden="true"></i>
            </span>
            <ul class="sub-menu"><li class="menu-item">没有更多翻译</li></ul>
          </li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li>
      </ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="DAY By DAY"><img
    class="lazyload logo"
    src="/svg/loading.min.svg"
    data-src="/fixit.min.svg"
    data-srcset="/fixit.min.svg, /fixit.min.svg 1.5x, /fixit.min.svg 2x"
    data-sizes="auto"
    alt="/fixit.min.svg"
    title="/fixit.min.svg"/><span class="header-title-text"></span></a><span id="typeit-header-subtitle-mobile" class="typeit header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 所有文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/friends/"
                  title="友情链接"
                  
                ><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden="true"></i> 友链</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                ><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden="true"></i> 关于</a></li><li
              class="menu-item text-center"
            ><a
                  class="menu-link"
                  href="/"
                  title="GitHub"
                  
                ><i class='fa-brands fa-github fa-fw' aria-hidden='true'></i> </a></li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li><li class="menu-item language">
            <span role="button" aria-label="选择语言" title="选择语言">简体中文<i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden="true"></i>
            </span>
            <select class="language-select" onchange="location = this.value;"><option disabled>没有更多翻译</option></select>
          </li></ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container" data-page-style="normal"><aside class="toc" id="toc-auto"><h2 class="toc-title">目录 <i class="toc-icon fa-solid fa-angle-down fa-fw"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside>

  <aside class="aside-custom" id="aside-sakana">
    

<div class="sakana-widget">
  <div class="sakana-item" id="takina-widget"></div>
  <div class="sakana-item" id="chisato-widget"></div>
</div>
<script>
  function initSakanaWidget() {
    const takina = SakanaWidget.getCharacter('takina')
    SakanaWidget.registerCharacter('takina-slow', takina);
    new SakanaWidget({
      character: 'takina-slow',
      controls: false,
      autoFit: true,
      stroke: {
        color: "#b4b4b4",
        width: 2
      }
    }).mount('#takina-widget');

    const chisato = SakanaWidget.getCharacter('chisato')
    SakanaWidget.registerCharacter('chisato-slow', chisato);
    new SakanaWidget({
      character: 'chisato-slow',
      controls: false,
      autoFit: true,
      stroke: {
        color: "#b4b4b4",
        width: 2
      }
    }).mount('#chisato-widget');
  }
</script>
<script async onload="initSakanaWidget()" src="https://cdn.jsdelivr.net/npm/sakana-widget@2.3.0/lib/sakana.min.js">
</script></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX">
        <span>sparkRelative</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      liudongdong1</span></span>
          <span class="post-category">收录于 <a href="/categories/"><i class="fa-regular fa-folder fa-fw"></i>&nbsp;Categories</a>&ensp;<a href="/categories/framework/"><i class="fa-regular fa-folder fa-fw"></i>&nbsp;Framework</a></span></div>
      <div class="post-meta-line"><span title=2020-01-13&#32;21:59:57>
            <i class="fa-regular fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2020-01-13" >2020-01-13</time>
          </span>&nbsp;<i class="fa-solid fa-pencil-alt fa-fw"></i>&nbsp;约 7876 字&nbsp;
        <i class="fa-regular fa-clock fa-fw"></i>&nbsp;预计阅读 16 分钟&nbsp;<span id="busuanzi_container_page_pv" class="busuanzi_visitors comment-visitors" data-flag-title="sparkRelative">
            <i class="fa-regular fa-eye fa-fw"></i>&nbsp;<span id="busuanzi_value_page_pv">-</span>&nbsp;次阅读
          </span>&nbsp;</div>
    </div><div class="featured-image"><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/20210501132438.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/20210501132438.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/20210501132438.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/20210501132438.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/20210501132438.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/20210501132438.png"/></div><div class="details toc" id="toc-static" kept="true">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div
      class="content"
      id="content"
      
      
    ><h4 id="1-部署方式">1. 部署方式</h4>
<h5 id="11-local-模式">1.1. Local 模式</h5>
<ul>
<li><strong>Local模式</strong>就是运行在一台计算机上的模式，通常用于在本机上测试，当不设置master参数的值时，默认此模式，具体有以下几种设置master的方式。
<ol>
<li>local：所有计算都运行在一个线程当中，没有任何并行计算。</li>
<li>local[n]：指定使用n个线程来运行计算。</li>
<li>local[*]：按照CPU的最多核数来设置线程数。</li>
</ol>
</li>
</ul>
<h5 id="12--standalone-模式">1.2.  Standalone 模式</h5>
<ul>
<li><strong>Standalone</strong>：独立模式，Spark原生的简单集群管理器，自带完整的服务，可单独部署到一个集群中，无需依赖任何其他资源管理系统，使用Standalone可以很方便地搭建一个集群；</li>
</ul>
<blockquote>
<p>Standalone集群有四个重要运行机制:</p>
<ul>
<li>Master: 是一个进程，主要负责资源的调度和分配，并进行集群的监控等职责</li>
<li>Worker: 是一个进程，可以启动其他的进程和线程(Executor)；同时用自己的内存存储RDD的某些partition</li>
<li>Driver：是一个进程，我们编写的Spark应用程序就运行在Driver上</li>
<li>Executor: 是一个进程，一个Worker可以运行多个Executor,Executor通过启动多个线程(task)来执行对RDD的partition进行并行计算。</li>
</ul>
</blockquote>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210219095555023.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210219095555023.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210219095555023.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210219095555023.png 2x"
    data-sizes="auto"
    alt="standalone-client"
    title="standalone-client"/></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Run on a Spark standalone cluster in client deploy mode</span>
</span></span><span style="display:flex;"><span>./bin/spark-submit <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --class org.apache.spark.examples.SparkPi <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --master spark://207.184.161.138:7077 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --deploy-mode client <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --executor-memory 20G <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--total-executor-cores <span style="color:#ae81ff">100</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>/path/to/examples.jar <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#ae81ff">1000</span>
</span></span></code></pre></div><p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210219095555023.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210219095555023.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210219095555023.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210219095555023.png 2x"
    data-sizes="auto"
    alt="standalone-cluster"
    title="standalone-cluster"/></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Run on a Spark standalone cluster in cluster deploy mode with supervise</span>
</span></span><span style="display:flex;"><span>./bin/spark-submit <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --class org.apache.spark.examples.SparkPi <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --master spark://207.184.161.138:7077 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --deploy-mode cluster <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --supervise <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --executor-memory 20G <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --total-executor-cores <span style="color:#ae81ff">100</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  /path/to/examples.jar <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  <span style="color:#ae81ff">1000</span>
</span></span></code></pre></div><h5 id="13-apache-mesos模式">1.3. Apache Mesos模式</h5>
<ul>
<li><strong>Apache Mesos</strong>：一个强大的分布式资源管理框架，它允许多种不同的框架部署在其上，包括yarn；</li>
</ul>
<h5 id="14-hadoop-yarn模式">1.4. Hadoop Yarn模式</h5>
<ul>
<li><strong>Hadoop YARN</strong>：统一的资源管理机制，在上面可以运行多套计算框架，如map reduce、storm等，根据driver在集群中的位置不同，分为yarn client和yarn cluster。</li>
<li>俩种模式区别：</li>
</ul>
<blockquote>
<p>　①. 在于driver端启动在本地(client)，还是在Yarn集群内部的AM中(cluster)。</p>
<p>　②. client提交作业的进程是不能停止的，否则作业就挂了；cluster提交作业后就断开了，因为driver运行在AM中。</p>
<p>　③. client提交的作业，日志在客户端看不到，因为作业运行在yarn上，可以通过 yarn logs -applicationId &lt;application_id&gt; 查看。</p>
<p>　④. Cluster适合生产环境，Client适合交互和调试。</p>
</blockquote>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210219101359930.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210219101359930.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210219101359930.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210219101359930.png 2x"
    data-sizes="auto"
    alt="Client"
    title="Client"/></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210219101430442.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210219101430442.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210219101430442.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210219101430442.png 2x"
    data-sizes="auto"
    alt="cluster"
    title="cluster"/></p>
<table>
<thead>
<tr>
<th>Master URL（主节点参数）</th>
<th>Meaning（含义）</th>
</tr>
</thead>
<tbody>
<tr>
<td>local</td>
<td>在本地运行，只有一个工作进程，无并行计算能力。</td>
</tr>
<tr>
<td>local[K]</td>
<td>在本地运行，有K个工作进程，通常设置K为机器的CPU核心数量。</td>
</tr>
<tr>
<td>local[*]</td>
<td>在本地运行，工作进程数量等于机器的CPU核心数量。</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Master URL（主节点参数）</th>
<th>Meaning（含义）</th>
</tr>
</thead>
<tbody>
<tr>
<td>spark://HOST:PORT</td>
<td>以Standalone模式运行，这是Spark自身提供的集群运行模式， 默认端口号: 7077。</td>
</tr>
<tr>
<td>mesos://HOST:PORT</td>
<td>在Mesos集群上运行，Driver进程和Worker进程运行在Mesos集群上， 部署模式必须使用固定值:–deploy-mode cluster</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Master URL（主节点参数）</th>
<th>Meaning（含义）</th>
</tr>
</thead>
<tbody>
<tr>
<td>yarn-client</td>
<td>在Yarn集群上运行，Driver进程在本地，Executor进程在Yarn集群上， 部署模式必须使用固定值:–deploy-mode client。 Yarn集群地址必须在HADOOP_CONF_DIR or YARN_CONF_DIR变量里定义。</td>
</tr>
<tr>
<td>yarn-cluster</td>
<td>在Yarn集群上运行，Driver进程在Yarn集群上，Work进程也在Yarn集群上， 部署模式必须使用固定值:–deploy-mode cluster。 Yarn集群地址必须在HADOOP_CONF_DIR or YARN_CONF_DIR变量里定义。</td>
</tr>
</tbody>
</table>
<h4 id="2-demo">2. Demo</h4>
<h5 id="21-文本处理">2.1. 文本处理</h5>
<ul>
<li><a href="https://cloud.tencent.com/developer/article/1096712"target="_blank" rel="external nofollow noopener noreferrer">将旧金山犯罪记录（San Francisco Crime Description）分类到33个类目中<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.sql <span style="color:#f92672">import</span> SQLContext
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark <span style="color:#f92672">import</span> SparkContext
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 利用spark的csv库直接载入csv格式的数据</span>
</span></span><span style="display:flex;"><span>sc <span style="color:#f92672">=</span> SparkContext()
</span></span><span style="display:flex;"><span>sqlContext <span style="color:#f92672">=</span> SQLContext(sc)
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> sqlContext<span style="color:#f92672">.</span>read<span style="color:#f92672">.</span>format(<span style="color:#e6db74">&#39;com.databricks.spark.csv&#39;</span>)<span style="color:#f92672">.</span>options(header<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;true&#39;</span>,                                                             inferschema<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;true&#39;</span>)<span style="color:#f92672">.</span>load(<span style="color:#e6db74">&#39;train.csv&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 选10000条数据集，减少运行时间</span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>sample(<span style="color:#66d9ef">False</span>, <span style="color:#ae81ff">0.01</span>, <span style="color:#ae81ff">100</span>)
</span></span><span style="display:flex;"><span>print(data<span style="color:#f92672">.</span>count())
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 除去一些不要的列，并展示前五行</span>
</span></span><span style="display:flex;"><span>drop_list <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;Dates&#39;</span>, <span style="color:#e6db74">&#39;DayOfWeek&#39;</span>, <span style="color:#e6db74">&#39;PdDistrict&#39;</span>, <span style="color:#e6db74">&#39;Resolution&#39;</span>, <span style="color:#e6db74">&#39;Address&#39;</span>, <span style="color:#e6db74">&#39;X&#39;</span>, <span style="color:#e6db74">&#39;Y&#39;</span>]
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>select([column <span style="color:#66d9ef">for</span> column <span style="color:#f92672">in</span> data<span style="color:#f92672">.</span>columns <span style="color:#66d9ef">if</span> column <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> drop_list])
</span></span><span style="display:flex;"><span>data<span style="color:#f92672">.</span>show(<span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>data<span style="color:#f92672">.</span>printSchema()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 包含数量最多的20类犯罪</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.sql.functions <span style="color:#f92672">import</span> col
</span></span><span style="display:flex;"><span>data<span style="color:#f92672">.</span>groupBy(<span style="color:#e6db74">&#39;Category&#39;</span>)<span style="color:#f92672">.</span>count()<span style="color:#f92672">.</span>orderBy(col(<span style="color:#e6db74">&#39;count&#39;</span>)<span style="color:#f92672">.</span>desc())<span style="color:#f92672">.</span>show()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.feature <span style="color:#f92672">import</span> RegexTokenizer, StopWordsRemover, CountVectorizer
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.classification <span style="color:#f92672">import</span> LogisticRegression
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 正则切分单词</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># inputCol:输入字段名</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># outputCol:输出字段名</span>
</span></span><span style="display:flex;"><span>regexTokenizer <span style="color:#f92672">=</span> RegexTokenizer(inputCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Descript&#39;</span>, outputCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;words&#39;</span>, pattern<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">W&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 停用词</span>
</span></span><span style="display:flex;"><span>add_stopwords <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;http&#39;</span>, <span style="color:#e6db74">&#39;https&#39;</span>, <span style="color:#e6db74">&#39;amp&#39;</span>, <span style="color:#e6db74">&#39;rt&#39;</span>, <span style="color:#e6db74">&#39;t&#39;</span>, <span style="color:#e6db74">&#39;c&#39;</span>, <span style="color:#e6db74">&#39;the&#39;</span>]
</span></span><span style="display:flex;"><span>stopwords_remover <span style="color:#f92672">=</span> StopWordsRemover(inputCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;words&#39;</span>, outputCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;filtered&#39;</span>)<span style="color:#f92672">.</span>setStopWords(add_stopwords)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 构建词频向量</span>
</span></span><span style="display:flex;"><span>count_vectors <span style="color:#f92672">=</span> CountVectorizer(inputCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;filtered&#39;</span>, outputCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;features&#39;</span>, vocabSize<span style="color:#f92672">=</span><span style="color:#ae81ff">10000</span>, minDF<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml <span style="color:#f92672">import</span> Pipeline
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.feature <span style="color:#f92672">import</span> OneHotEncoder, StringIndexer, VectorAssembler
</span></span><span style="display:flex;"><span>label_stringIdx <span style="color:#f92672">=</span> StringIndexer(inputCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Category&#39;</span>, outputCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;label&#39;</span>)
</span></span><span style="display:flex;"><span>pipeline <span style="color:#f92672">=</span> Pipeline(stages<span style="color:#f92672">=</span>[regexTokenizer, stopwords_remover, count_vectors, label_stringIdx])
</span></span><span style="display:flex;"><span><span style="color:#75715e"># fit the pipeline to training documents</span>
</span></span><span style="display:flex;"><span>pipeline_fit <span style="color:#f92672">=</span> pipeline<span style="color:#f92672">.</span>fit(data)
</span></span><span style="display:flex;"><span>dataset <span style="color:#f92672">=</span> pipeline_fit<span style="color:#f92672">.</span>transform(data)
</span></span><span style="display:flex;"><span>dataset<span style="color:#f92672">.</span>show(<span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># set seed for reproducibility</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 数据集划分训练集和测试集，比例7:3， 设置随机种子100</span>
</span></span><span style="display:flex;"><span>(trainingData, testData) <span style="color:#f92672">=</span> dataset<span style="color:#f92672">.</span>randomSplit([<span style="color:#ae81ff">0.7</span>, <span style="color:#ae81ff">0.3</span>], seed<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;Training Dataset Count:</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(trainingData<span style="color:#f92672">.</span>count()))
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;Test Dataset Count:</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(testData<span style="color:#f92672">.</span>count()))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>lr <span style="color:#f92672">=</span> LogisticRegression(maxIter<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>, regParam<span style="color:#f92672">=</span><span style="color:#ae81ff">0.3</span>, elasticNetParam<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>lrModel <span style="color:#f92672">=</span> lr<span style="color:#f92672">.</span>fit(trainingData)
</span></span><span style="display:flex;"><span>predictions <span style="color:#f92672">=</span> lrModel<span style="color:#f92672">.</span>transform(testData)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 过滤prediction类别为0数据集</span>
</span></span><span style="display:flex;"><span>predictions<span style="color:#f92672">.</span>filter(predictions[<span style="color:#e6db74">&#39;prediction&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>select(<span style="color:#e6db74">&#39;Descript&#39;</span>, <span style="color:#e6db74">&#39;Category&#39;</span>, <span style="color:#e6db74">&#39;probability&#39;</span>, <span style="color:#e6db74">&#39;label&#39;</span>, <span style="color:#e6db74">&#39;prediction&#39;</span>)<span style="color:#f92672">.</span>orderBy(<span style="color:#e6db74">&#39;probability&#39;</span>, accending<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)<span style="color:#f92672">.</span>show(n<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>, truncate<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.evaluation <span style="color:#f92672">import</span> MulticlassClassificationEvaluator
</span></span><span style="display:flex;"><span><span style="color:#75715e"># predictionCol: 预测列的名称</span>
</span></span><span style="display:flex;"><span>evaluator <span style="color:#f92672">=</span> MulticlassClassificationEvaluator(predictionCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;prediction&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 预测准确率</span>
</span></span><span style="display:flex;"><span>print(evaluator<span style="color:#f92672">.</span>evaluate(predictions))
</span></span><span style="display:flex;"><span>end_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>print(end_time <span style="color:#f92672">-</span> start_time)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#以TF-ID作为特征，利用逻辑回归进行分类</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.feature <span style="color:#f92672">import</span> HashingTF, IDF
</span></span><span style="display:flex;"><span>start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span><span style="color:#75715e"># numFeatures: 最大特征数</span>
</span></span><span style="display:flex;"><span>hashingTF <span style="color:#f92672">=</span> HashingTF(inputCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;filtered&#39;</span>, outputCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;rawFeatures&#39;</span>, numFeatures<span style="color:#f92672">=</span><span style="color:#ae81ff">10000</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># minDocFreq：过滤的最少文档数量</span>
</span></span><span style="display:flex;"><span>idf <span style="color:#f92672">=</span> IDF(inputCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;rawFeatures&#39;</span>, outputCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;features&#39;</span>, minDocFreq<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>pipeline <span style="color:#f92672">=</span> Pipeline(stages<span style="color:#f92672">=</span>[regexTokenizer, stopwords_remover, hashingTF, idf, label_stringIdx])
</span></span><span style="display:flex;"><span>pipeline_fit <span style="color:#f92672">=</span> pipeline<span style="color:#f92672">.</span>fit(data)
</span></span><span style="display:flex;"><span>dataset <span style="color:#f92672">=</span> pipeline_fit<span style="color:#f92672">.</span>transform(data)
</span></span><span style="display:flex;"><span>(trainingData, testData) <span style="color:#f92672">=</span> dataset<span style="color:#f92672">.</span>randomSplit([<span style="color:#ae81ff">0.7</span>, <span style="color:#ae81ff">0.3</span>], seed<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>lr <span style="color:#f92672">=</span> LogisticRegression(maxIter<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>, regParam<span style="color:#f92672">=</span><span style="color:#ae81ff">0.3</span>, elasticNetParam<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>lr_model <span style="color:#f92672">=</span> lr<span style="color:#f92672">.</span>fit(trainingData)
</span></span><span style="display:flex;"><span>predictions <span style="color:#f92672">=</span> lr_model<span style="color:#f92672">.</span>transform(testData)
</span></span><span style="display:flex;"><span>predictions<span style="color:#f92672">.</span>filter(predictions[<span style="color:#e6db74">&#39;prediction&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>select(<span style="color:#e6db74">&#39;Descript&#39;</span>, <span style="color:#e6db74">&#39;Category&#39;</span>, <span style="color:#e6db74">&#39;probability&#39;</span>, <span style="color:#e6db74">&#39;label&#39;</span>, <span style="color:#e6db74">&#39;prediction&#39;</span>)<span style="color:#f92672">.</span>\
</span></span><span style="display:flex;"><span>orderBy(<span style="color:#e6db74">&#39;probability&#39;</span>, ascending<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)<span style="color:#f92672">.</span>show(n<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>, truncate<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>evaluator <span style="color:#f92672">=</span> MulticlassClassificationEvaluator(predictionCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;prediction&#39;</span>)
</span></span><span style="display:flex;"><span>print(evaluator<span style="color:#f92672">.</span>evaluate(predictions))
</span></span><span style="display:flex;"><span>end_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>print(end_time <span style="color:#f92672">-</span> start_time)
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.tuning <span style="color:#f92672">import</span> ParamGridBuilder, CrossValidator
</span></span><span style="display:flex;"><span>start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>pipeline <span style="color:#f92672">=</span> Pipeline(stages<span style="color:#f92672">=</span>[regexTokenizer, stopwords_remover, count_vectors, label_stringIdx])
</span></span><span style="display:flex;"><span>pipeline_fit <span style="color:#f92672">=</span> pipeline<span style="color:#f92672">.</span>fit(data)
</span></span><span style="display:flex;"><span>(trainingData, testData) <span style="color:#f92672">=</span> dataset<span style="color:#f92672">.</span>randomSplit([<span style="color:#ae81ff">0.7</span>, <span style="color:#ae81ff">0.3</span>], seed<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>)
</span></span><span style="display:flex;"><span>lr <span style="color:#f92672">=</span> LogisticRegression(maxIter<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>, regParam<span style="color:#f92672">=</span><span style="color:#ae81ff">0.3</span>, elasticNetParam<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 为交叉验证创建参数</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ParamGridBuilder：用于基于网格搜索的模型选择的参数网格的生成器</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># addGrid：将网格中给定参数设置为固定值</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># parameter：正则化参数</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># maxIter：迭代次数</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># numFeatures：特征值</span>
</span></span><span style="display:flex;"><span>paramGrid <span style="color:#f92672">=</span> (ParamGridBuilder()
</span></span><span style="display:flex;"><span>             <span style="color:#f92672">.</span>addGrid(lr<span style="color:#f92672">.</span>regParam, [<span style="color:#ae81ff">0.1</span>, <span style="color:#ae81ff">0.3</span>, <span style="color:#ae81ff">0.5</span>])
</span></span><span style="display:flex;"><span>             <span style="color:#f92672">.</span>addGrid(lr<span style="color:#f92672">.</span>elasticNetParam, [<span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.1</span>, <span style="color:#ae81ff">0.2</span>])
</span></span><span style="display:flex;"><span>             <span style="color:#f92672">.</span>addGrid(lr<span style="color:#f92672">.</span>maxIter, [<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">50</span>])
</span></span><span style="display:flex;"><span><span style="color:#75715e">#              .addGrid(idf.numFeatures, [10, 100, 1000])</span>
</span></span><span style="display:flex;"><span>             <span style="color:#f92672">.</span>build())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建五折交叉验证</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># estimator：要交叉验证的估计器</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># estimatorParamMaps：网格搜索的最优参数</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># evaluator：评估器</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># numFolds：交叉次数</span>
</span></span><span style="display:flex;"><span>cv <span style="color:#f92672">=</span> CrossValidator(estimator<span style="color:#f92672">=</span>lr,\
</span></span><span style="display:flex;"><span>                   estimatorParamMaps<span style="color:#f92672">=</span>paramGrid,\
</span></span><span style="display:flex;"><span>                   evaluator<span style="color:#f92672">=</span>evaluator,\
</span></span><span style="display:flex;"><span>                   numFolds<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>cv_model <span style="color:#f92672">=</span> cv<span style="color:#f92672">.</span>fit(trainingData)
</span></span><span style="display:flex;"><span>predictions <span style="color:#f92672">=</span> cv_model<span style="color:#f92672">.</span>transform(testData)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 模型评估</span>
</span></span><span style="display:flex;"><span>evaluator <span style="color:#f92672">=</span> MulticlassClassificationEvaluator(predictionCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;prediction&#39;</span>)
</span></span><span style="display:flex;"><span>print(evaluator<span style="color:#f92672">.</span>evaluate(predictions))
</span></span><span style="display:flex;"><span>end_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>print(end_time <span style="color:#f92672">-</span> start_time)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#朴素贝叶斯</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.classification <span style="color:#f92672">import</span> NaiveBayes
</span></span><span style="display:flex;"><span>start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span><span style="color:#75715e"># smoothing：平滑参数</span>
</span></span><span style="display:flex;"><span>nb <span style="color:#f92672">=</span> NaiveBayes(smoothing<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> nb<span style="color:#f92672">.</span>fit(trainingData)
</span></span><span style="display:flex;"><span>predictions <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>transform(testData)
</span></span><span style="display:flex;"><span>predictions<span style="color:#f92672">.</span>filter(predictions[<span style="color:#e6db74">&#39;prediction&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) \
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span>select(<span style="color:#e6db74">&#39;Descript&#39;</span>, <span style="color:#e6db74">&#39;Category&#39;</span>, <span style="color:#e6db74">&#39;probability&#39;</span>, <span style="color:#e6db74">&#39;label&#39;</span>, <span style="color:#e6db74">&#39;prediction&#39;</span>) \
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span>orderBy(<span style="color:#e6db74">&#39;probability&#39;</span>, ascending<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>) \
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span>show(n<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>, truncate<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#75715e">#随机森林</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.classification <span style="color:#f92672">import</span> RandomForestClassifier
</span></span><span style="display:flex;"><span>start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span><span style="color:#75715e"># numTree：训练树的个数</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># maxDepth：最大深度</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># maxBins：连续特征离散化的最大分类数</span>
</span></span><span style="display:flex;"><span>rf <span style="color:#f92672">=</span> RandomForestClassifier(labelCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;label&#39;</span>, \
</span></span><span style="display:flex;"><span>                            featuresCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;features&#39;</span>, \
</span></span><span style="display:flex;"><span>                            numTrees<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>, \
</span></span><span style="display:flex;"><span>                            maxDepth<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>, \
</span></span><span style="display:flex;"><span>                            maxBins<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Train model with Training Data</span>
</span></span><span style="display:flex;"><span>rfModel <span style="color:#f92672">=</span> rf<span style="color:#f92672">.</span>fit(trainingData)
</span></span><span style="display:flex;"><span>predictions <span style="color:#f92672">=</span> rfModel<span style="color:#f92672">.</span>transform(testData)
</span></span><span style="display:flex;"><span>predictions<span style="color:#f92672">.</span>filter(predictions[<span style="color:#e6db74">&#39;prediction&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) \
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span>select(<span style="color:#e6db74">&#39;Descript&#39;</span>,<span style="color:#e6db74">&#39;Category&#39;</span>,<span style="color:#e6db74">&#39;probability&#39;</span>,<span style="color:#e6db74">&#39;label&#39;</span>,<span style="color:#e6db74">&#39;prediction&#39;</span>) \
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span>orderBy(<span style="color:#e6db74">&#39;probability&#39;</span>, ascending<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>) \
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span>show(n <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>, truncate <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>evaluator <span style="color:#f92672">=</span> MulticlassClassificationEvaluator(predictionCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;prediction&#39;</span>)
</span></span><span style="display:flex;"><span>print(evaluator<span style="color:#f92672">.</span>evaluate(predictions))
</span></span><span style="display:flex;"><span>end_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>print(end_time <span style="color:#f92672">-</span> start_time)
</span></span></code></pre></div><ul>
<li>评语分类</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#coding:utf-8</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark <span style="color:#f92672">import</span> SparkContext
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.mllib.regression <span style="color:#f92672">import</span> LabeledPoint
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.mllib.feature <span style="color:#f92672">import</span> HashingTF,IDF,StandardScaler
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.mllib.classification <span style="color:#f92672">import</span> LogisticRegressionWithSGD,SVMWithSGD,NaiveBayes
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.mllib.tree <span style="color:#f92672">import</span> DecisionTree
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">split2</span>(line):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;自定义的字符串分割函数，本例已步长3分割字符串&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    step <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    length <span style="color:#f92672">=</span> len(line)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> xrange(<span style="color:#ae81ff">0</span>,length,step):
</span></span><span style="display:flex;"><span>        result<span style="color:#f92672">.</span>append(line[i:i<span style="color:#f92672">+</span>step])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> result
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check</span>(test,model):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;模型检测函数，输出模型的正确率、准确率和召回率，本例省略&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__<span style="color:#f92672">==</span><span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    sc <span style="color:#f92672">=</span> SparkContext(appName<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#分别读取正文件和负文件的训练集，然后读取测试集</span>
</span></span><span style="display:flex;"><span>    spam <span style="color:#f92672">=</span> sc<span style="color:#f92672">.</span>textFile(<span style="color:#e6db74">&#34;hdfs://ubuntu:9000/xxx/bad.txt&#34;</span>)
</span></span><span style="display:flex;"><span>    normal <span style="color:#f92672">=</span> sc<span style="color:#f92672">.</span>textFile(<span style="color:#e6db74">&#34;hdfs://ubuntu:9000/xxx/good.txt&#34;</span>)
</span></span><span style="display:flex;"><span>    test <span style="color:#f92672">=</span> sc<span style="color:#f92672">.</span>textFile(<span style="color:#e6db74">&#34;hdfs://ubuntu:9000/xxx/test.txt&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 创建一个HashingTF实例来把文本映射为包含10000个特征的向量</span>
</span></span><span style="display:flex;"><span>    tf <span style="color:#f92672">=</span> HashingTF(numFeatures <span style="color:#f92672">=</span> <span style="color:#ae81ff">10000</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 各http请求都被切分为单词，每个单词被映射为一个特征</span>
</span></span><span style="display:flex;"><span>    spamFeatures <span style="color:#f92672">=</span> spam<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> line: tf<span style="color:#f92672">.</span>transform(split2(line)))
</span></span><span style="display:flex;"><span>    normalFeatures <span style="color:#f92672">=</span> normal<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> line: tf<span style="color:#f92672">.</span>transform(split2(line)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># =========使用词频统计构建向量=========</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># positiveExamples = spamFeatures.map(lambda features: LabeledPoint(0, features))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># negativeExamples = normalFeatures.map(lambda features: LabeledPoint(1, features))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># trainingData = positiveExamples.union(negativeExamples)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># trainingData.cache() # 因为逻辑回归是迭代算法，所以缓存训练数据RDD</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#print trainingData.take(1)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># =========使用TF-IDF构建向量=========</span>
</span></span><span style="display:flex;"><span>    spamFeatures<span style="color:#f92672">.</span>cache() <span style="color:#75715e"># 因为逻辑回归是迭代算法，所以缓存训练数据RDD</span>
</span></span><span style="display:flex;"><span>    idf <span style="color:#f92672">=</span> IDF()
</span></span><span style="display:flex;"><span>    idfModel <span style="color:#f92672">=</span> idf<span style="color:#f92672">.</span>fit(spamFeatures)
</span></span><span style="display:flex;"><span>    spamVectors <span style="color:#f92672">=</span> idfModel<span style="color:#f92672">.</span>transform(spamFeatures)
</span></span><span style="display:flex;"><span>    normalFeatures<span style="color:#f92672">.</span>cache() <span style="color:#75715e"># 因为逻辑回归是迭代算法，所以缓存训练数据RDD</span>
</span></span><span style="display:flex;"><span>    idfModel <span style="color:#f92672">=</span> idf<span style="color:#f92672">.</span>fit(normalFeatures)
</span></span><span style="display:flex;"><span>    normalVectors <span style="color:#f92672">=</span> idfModel<span style="color:#f92672">.</span>transform(normalFeatures)
</span></span><span style="display:flex;"><span>    positiveExamples <span style="color:#f92672">=</span> normalVectors<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> features: LabeledPoint(<span style="color:#ae81ff">1</span>, features))
</span></span><span style="display:flex;"><span>    negativeExamples <span style="color:#f92672">=</span> spamVectors<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> features: LabeledPoint(<span style="color:#ae81ff">0</span>, features))
</span></span><span style="display:flex;"><span>    dataAll <span style="color:#f92672">=</span> positiveExamples<span style="color:#f92672">.</span>union(negativeExamples)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># =========特征向量压缩=========</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># scaler = StandardScaler(withMean=True, withStd=True)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># normalScaler = scaler.fit(normalVectors)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># normalResult = normalScaler.transform(normalVectors)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># spamScaler = scaler.fit(spamVectors)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># spamResult = spamScaler.transform(spamVectors)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 使用分类算法进行训练,iterations位迭代次数,step为迭代步长</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># LogisticRegressionWithSGD可以替换为SVMWithSGD和NaiveBayes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 其中train函数的参数可以根据模型效果自定义</span>
</span></span><span style="display:flex;"><span>    model <span style="color:#f92672">=</span> LogisticRegressionWithSGD<span style="color:#f92672">.</span>train(data<span style="color:#f92672">=</span>dataAll,iterations<span style="color:#f92672">=</span><span style="color:#ae81ff">10000</span>,step<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>) 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 决策树的分类类别为2，映射表为空，不纯净度测量为gini，树的深度为5，数据箱子为32</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># model = DecisionTree.trainClassifier(dataAll, numClasses=2, categoricalFeaturesInfo={},</span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e">#                                     impurity=&#39;gini&#39;, maxDepth=5, maxBins=32) </span>
</span></span><span style="display:flex;"><span>    check(test,model)
</span></span><span style="display:flex;"><span>    sc<span style="color:#f92672">.</span>stop()
</span></span></code></pre></div><h5 id="22-蘑菇分类httpswwwkagglecomucimlmushroom-classification">2.2. <a href="https://www.kaggle.com/uciml/mushroom-classification"target="_blank" rel="external nofollow noopener noreferrer">蘑菇分类<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#分类毒蘑菇和可食用蘑菇，共22个特征值，其中特征描述都是字符，用于机器学习的话，要将特征转换成数值。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#https://blog.csdn.net/m0_37442062/article/details/91357264</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> findspark <span style="color:#75715e">#pip install findspark</span>
</span></span><span style="display:flex;"><span>findspark<span style="color:#f92672">.</span>init()
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.sql <span style="color:#f92672">import</span> SparkSession
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark <span style="color:#f92672">import</span> SparkConf, SparkContext
</span></span><span style="display:flex;"><span>spark <span style="color:#f92672">=</span> SparkSession<span style="color:#f92672">.</span>builder<span style="color:#f92672">.</span>master(<span style="color:#e6db74">&#39;local[1]&#39;</span>)<span style="color:#f92672">.</span>appName(<span style="color:#e6db74">&#39;classification&#39;</span>)<span style="color:#f92672">.</span>getOrCreate()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 载入数据</span>
</span></span><span style="display:flex;"><span>df0 <span style="color:#f92672">=</span> spark<span style="color:#f92672">.</span>read<span style="color:#f92672">.</span>csv(<span style="color:#e6db74">&#39;mushrooms.csv&#39;</span>, header<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inferSchema<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;utf-8&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看是否有缺失值</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># df0.toPandas().isna().sum()</span>
</span></span><span style="display:flex;"><span>df0<span style="color:#f92672">.</span>toPandas()<span style="color:#f92672">.</span>isna()<span style="color:#f92672">.</span>values<span style="color:#f92672">.</span>any()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#先使用StringIndexer将字符转化为数值，然后将特征整合到一起</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.feature <span style="color:#f92672">import</span> StringIndexer, VectorAssembler
</span></span><span style="display:flex;"><span>old_columns_names <span style="color:#f92672">=</span> df0<span style="color:#f92672">.</span>columns
</span></span><span style="display:flex;"><span>new_columns_names <span style="color:#f92672">=</span> [name<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;-new&#39;</span> <span style="color:#66d9ef">for</span> name <span style="color:#f92672">in</span> old_columns_names]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(old_columns_names)):
</span></span><span style="display:flex;"><span>    indexer <span style="color:#f92672">=</span> StringIndexer(inputCol<span style="color:#f92672">=</span>old_columns_names[i], outputCol<span style="color:#f92672">=</span>new_columns_names[i])
</span></span><span style="display:flex;"><span>    df0 <span style="color:#f92672">=</span> indexer<span style="color:#f92672">.</span>fit(df0)<span style="color:#f92672">.</span>transform(df0)
</span></span><span style="display:flex;"><span>vecAss <span style="color:#f92672">=</span> VectorAssembler(inputCols<span style="color:#f92672">=</span>new_columns_names[<span style="color:#ae81ff">1</span>:], outputCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;features&#39;</span>)
</span></span><span style="display:flex;"><span>df0 <span style="color:#f92672">=</span> vecAss<span style="color:#f92672">.</span>transform(df0)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 更换label列名</span>
</span></span><span style="display:flex;"><span>df0 <span style="color:#f92672">=</span> df0<span style="color:#f92672">.</span>withColumnRenamed(new_columns_names[<span style="color:#ae81ff">0</span>], <span style="color:#e6db74">&#39;label&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># df0.show()</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建新的只有label和features的表</span>
</span></span><span style="display:flex;"><span>dfi <span style="color:#f92672">=</span> df0<span style="color:#f92672">.</span>select([<span style="color:#e6db74">&#39;label&#39;</span>, <span style="color:#e6db74">&#39;features&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 数据概观</span>
</span></span><span style="display:flex;"><span>dfi<span style="color:#f92672">.</span>show(<span style="color:#ae81ff">5</span>, truncate<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#构建训练数据</span>
</span></span><span style="display:flex;"><span>train_data, test_data <span style="color:#f92672">=</span> dfi<span style="color:#f92672">.</span>randomSplit([<span style="color:#ae81ff">4.0</span>, <span style="color:#ae81ff">1.0</span>], <span style="color:#ae81ff">100</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.classification <span style="color:#f92672">import</span> LogisticRegression
</span></span><span style="display:flex;"><span>blor <span style="color:#f92672">=</span> LogisticRegression(regParam<span style="color:#f92672">=</span><span style="color:#ae81ff">0.01</span>)<span style="color:#75715e">#设置regParam为0.01</span>
</span></span><span style="display:flex;"><span>blorModel <span style="color:#f92672">=</span> blor<span style="color:#f92672">.</span>fit(train_data)
</span></span><span style="display:flex;"><span>result <span style="color:#f92672">=</span> blorModel<span style="color:#f92672">.</span>transform(test_data)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 计算准确率</span>
</span></span><span style="display:flex;"><span>a <span style="color:#f92672">=</span> result<span style="color:#f92672">.</span>filter(result<span style="color:#f92672">.</span>label <span style="color:#f92672">==</span> result<span style="color:#f92672">.</span>prediction)<span style="color:#f92672">.</span>count()<span style="color:#f92672">/</span>result<span style="color:#f92672">.</span>count()
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;逻辑回归： &#34;</span><span style="color:#f92672">+</span>str(a))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.classification <span style="color:#f92672">import</span> DecisionTreeClassifier
</span></span><span style="display:flex;"><span>dt <span style="color:#f92672">=</span> DecisionTreeClassifier(maxDepth<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>) <span style="color:#75715e">#树的最大深度</span>
</span></span><span style="display:flex;"><span>dtModel <span style="color:#f92672">=</span> dt<span style="color:#f92672">.</span>fit(train_data)
</span></span><span style="display:flex;"><span>result <span style="color:#f92672">=</span> dtModel<span style="color:#f92672">.</span>transform(test_data)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># accuracy</span>
</span></span><span style="display:flex;"><span>b <span style="color:#f92672">=</span> result<span style="color:#f92672">.</span>filter(result<span style="color:#f92672">.</span>label <span style="color:#f92672">==</span> result<span style="color:#f92672">.</span>prediction)<span style="color:#f92672">.</span>count()<span style="color:#f92672">/</span>result<span style="color:#f92672">.</span>count()
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;决策树： &#34;</span><span style="color:#f92672">+</span>str(b))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.classification <span style="color:#f92672">import</span> GBTClassifier
</span></span><span style="display:flex;"><span>gbt <span style="color:#f92672">=</span> GBTClassifier(maxDepth<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>gbtModel <span style="color:#f92672">=</span> gbt<span style="color:#f92672">.</span>fit(train_data)
</span></span><span style="display:flex;"><span>result <span style="color:#f92672">=</span> gbtModel<span style="color:#f92672">.</span>transform(test_data)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># accuracy</span>
</span></span><span style="display:flex;"><span>c <span style="color:#f92672">=</span> result<span style="color:#f92672">.</span>filter(result<span style="color:#f92672">.</span>label <span style="color:#f92672">==</span> result<span style="color:#f92672">.</span>prediction)<span style="color:#f92672">.</span>count()<span style="color:#f92672">/</span>result<span style="color:#f92672">.</span>count()
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;梯度增强树： &#34;</span><span style="color:#f92672">+</span>str(c))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.classification <span style="color:#f92672">import</span> RandomForestClassifier
</span></span><span style="display:flex;"><span>rf <span style="color:#f92672">=</span> RandomForestClassifier(numTrees<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>, maxDepth<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>rfModel <span style="color:#f92672">=</span> rf<span style="color:#f92672">.</span>fit(train_data)
</span></span><span style="display:flex;"><span>result <span style="color:#f92672">=</span> rfModel<span style="color:#f92672">.</span>transform(test_data)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># accuracy</span>
</span></span><span style="display:flex;"><span>d <span style="color:#f92672">=</span> result<span style="color:#f92672">.</span>filter(result<span style="color:#f92672">.</span>label <span style="color:#f92672">==</span> result<span style="color:#f92672">.</span>prediction)<span style="color:#f92672">.</span>count()<span style="color:#f92672">/</span>result<span style="color:#f92672">.</span>count()
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1.0</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;随机森林： &#34;</span><span style="color:#f92672">+</span>str(d))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.classification <span style="color:#f92672">import</span> NaiveBayes
</span></span><span style="display:flex;"><span>nb <span style="color:#f92672">=</span> NaiveBayes()
</span></span><span style="display:flex;"><span>nbModel <span style="color:#f92672">=</span> nb<span style="color:#f92672">.</span>fit(train_data)
</span></span><span style="display:flex;"><span>result <span style="color:#f92672">=</span> nbModel<span style="color:#f92672">.</span>transform(test_data)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#accuracy</span>
</span></span><span style="display:flex;"><span>e <span style="color:#f92672">=</span> result<span style="color:#f92672">.</span>filter(result<span style="color:#f92672">.</span>label <span style="color:#f92672">==</span> result<span style="color:#f92672">.</span>prediction)<span style="color:#f92672">.</span>count()<span style="color:#f92672">/</span>result<span style="color:#f92672">.</span>count()
</span></span><span style="display:flex;"><span><span style="color:#75715e">#0.9231714812538414</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;朴素贝叶斯： &#34;</span><span style="color:#f92672">+</span>str(e))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.classification <span style="color:#f92672">import</span> LinearSVC
</span></span><span style="display:flex;"><span>svm <span style="color:#f92672">=</span> LinearSVC(maxIter<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>, regParam<span style="color:#f92672">=</span><span style="color:#ae81ff">0.01</span>)
</span></span><span style="display:flex;"><span>svmModel <span style="color:#f92672">=</span> svm<span style="color:#f92672">.</span>fit(train_data)
</span></span><span style="display:flex;"><span>result <span style="color:#f92672">=</span> svmModel<span style="color:#f92672">.</span>transform(test_data)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># accuracy</span>
</span></span><span style="display:flex;"><span>f <span style="color:#f92672">=</span> result<span style="color:#f92672">.</span>filter(result<span style="color:#f92672">.</span>label <span style="color:#f92672">==</span> result<span style="color:#f92672">.</span>prediction)<span style="color:#f92672">.</span>count()<span style="color:#f92672">/</span>result<span style="color:#f92672">.</span>count()
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 0.9797172710510141</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;支持向量机： &#34;</span><span style="color:#f92672">+</span>str(f))
</span></span></code></pre></div><h5 id="23-商品推荐">2.3. 商品推荐</h5>
<ul>
<li>ItemSimilarity</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Item-Item Similarity computation on pySpark with cosine similarity</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> itertools <span style="color:#f92672">import</span> combinations
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark <span style="color:#f92672">import</span> SparkContext
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parseVector</span>(line):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Parse each line of the specified data file, assuming a &#34;|&#34; delimiter.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Converts each rating to a float
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    line <span style="color:#f92672">=</span> line<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;|&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> line[<span style="color:#ae81ff">0</span>],(line[<span style="color:#ae81ff">1</span>],float(line[<span style="color:#ae81ff">2</span>]))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">findItemPairs</span>(user_id,items_with_rating):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    For each user, find all item-item pairs combos. (i.e. items with the same user) 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> item1,item2 <span style="color:#f92672">in</span> combinations(items_with_rating,<span style="color:#ae81ff">2</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (item1[<span style="color:#ae81ff">0</span>],item2[<span style="color:#ae81ff">0</span>]),(item1[<span style="color:#ae81ff">1</span>],item2[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calcSim</span>(item_pair,rating_pairs):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    For each item-item pair, return the specified similarity measure,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    along with co_raters_count
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    sum_xx, sum_xy, sum_yy, sum_x, sum_y, n <span style="color:#f92672">=</span> (<span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> rating_pair <span style="color:#f92672">in</span> rating_pairs:
</span></span><span style="display:flex;"><span>        sum_xx <span style="color:#f92672">+=</span> np<span style="color:#f92672">.</span>float(rating_pair[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">*</span> np<span style="color:#f92672">.</span>float(rating_pair[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>        sum_yy <span style="color:#f92672">+=</span> np<span style="color:#f92672">.</span>float(rating_pair[<span style="color:#ae81ff">1</span>]) <span style="color:#f92672">*</span> np<span style="color:#f92672">.</span>float(rating_pair[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>        sum_xy <span style="color:#f92672">+=</span> np<span style="color:#f92672">.</span>float(rating_pair[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">*</span> np<span style="color:#f92672">.</span>float(rating_pair[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># sum_y += rt[1]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># sum_x += rt[0]</span>
</span></span><span style="display:flex;"><span>        n <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    cos_sim <span style="color:#f92672">=</span> cosine(sum_xy,np<span style="color:#f92672">.</span>sqrt(sum_xx),np<span style="color:#f92672">.</span>sqrt(sum_yy))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> item_pair, (cos_sim,n)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">cosine</span>(dot_product,rating_norm_squared,rating2_norm_squared):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    The cosine between two vectors A, B
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       dotProduct(A, B) / (norm(A) * norm(B))
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    numerator <span style="color:#f92672">=</span> dot_product
</span></span><span style="display:flex;"><span>    denominator <span style="color:#f92672">=</span> rating_norm_squared <span style="color:#f92672">*</span> rating2_norm_squared
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (numerator <span style="color:#f92672">/</span> (float(denominator))) <span style="color:#66d9ef">if</span> denominator <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">3</span>:
</span></span><span style="display:flex;"><span>        print <span style="color:#f92672">&gt;&gt;</span> sys<span style="color:#f92672">.</span>stderr, \
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Usage: PythonUserCF &lt;master&gt; &lt;file&gt;&#34;</span>
</span></span><span style="display:flex;"><span>        exit(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    sc <span style="color:#f92672">=</span> SparkContext(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>], <span style="color:#e6db74">&#34;PythonUserCF&#34;</span>)
</span></span><span style="display:flex;"><span>    lines <span style="color:#f92672">=</span> sc<span style="color:#f92672">.</span>textFile(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Obtain the sparse user-item matrix
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        user_id -&gt; [(item_id_1, rating_1),
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                   [(item_id_2, rating_2),
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    ...]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    user_item_pairs <span style="color:#f92672">=</span> lines<span style="color:#f92672">.</span>map(parseVector)<span style="color:#f92672">.</span>groupByKey()<span style="color:#f92672">.</span>cache()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Get all item-item pair combos
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        (item1,item2) -&gt;    [(item1_rating,item2_rating),
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                             (item1_rating,item2_rating),
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                             ...]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pairwise_items <span style="color:#f92672">=</span> user_item_pairs<span style="color:#f92672">.</span>filter(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">lambda</span> p: len(p[<span style="color:#ae81ff">1</span>]) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>map(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">lambda</span> p: findItemPairs(p[<span style="color:#ae81ff">0</span>],p[<span style="color:#ae81ff">1</span>]))<span style="color:#f92672">.</span>groupByKey()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Calculate the cosine similarity for each item pair
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        (item1,item2) -&gt;    (similarity,co_raters_count)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    item_sims <span style="color:#f92672">=</span> pairwise_items<span style="color:#f92672">.</span>map(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">lambda</span> p: calcSim(p[<span style="color:#ae81ff">0</span>],p[<span style="color:#ae81ff">1</span>]))<span style="color:#f92672">.</span>collect()
</span></span></code></pre></div><ul>
<li>UserSimilarity</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># User-User Similarity computation on pySpark</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> itertools <span style="color:#f92672">import</span> combinations
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pdb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark <span style="color:#f92672">import</span> SparkContext
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parseVector</span>(line):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Parse each line of the specified data file, assuming a &#34;|&#34; delimiter.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Converts each rating to a float
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    line <span style="color:#f92672">=</span> line<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;|&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> line[<span style="color:#ae81ff">1</span>],(line[<span style="color:#ae81ff">0</span>],float(line[<span style="color:#ae81ff">2</span>]))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">keyOnUserPair</span>(item_id,user_and_rating_pair):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Convert each item and co_rating user pairs to a new vector
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    keyed on the user pair ids, with the co_ratings as their value. 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    (user1_with_rating,user2_with_rating) <span style="color:#f92672">=</span> user_and_rating_pair
</span></span><span style="display:flex;"><span>    user1_id,user2_id <span style="color:#f92672">=</span> user1_with_rating[<span style="color:#ae81ff">0</span>],user2_with_rating[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    user1_rating,user2_rating <span style="color:#f92672">=</span> user1_with_rating[<span style="color:#ae81ff">1</span>],user2_with_rating[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (user1_id,user2_id),(user1_rating,user2_rating)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calcSim</span>(user_pair,rating_pairs):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    For each user-user pair, return the specified similarity measure,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    along with co_raters_count.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    sum_xx, sum_xy, sum_yy, sum_x, sum_y, n <span style="color:#f92672">=</span> (<span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> rating_pair <span style="color:#f92672">in</span> rating_pairs:
</span></span><span style="display:flex;"><span>        sum_xx <span style="color:#f92672">+=</span> np<span style="color:#f92672">.</span>float(rating_pair[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">*</span> np<span style="color:#f92672">.</span>float(rating_pair[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>        sum_yy <span style="color:#f92672">+=</span> np<span style="color:#f92672">.</span>float(rating_pair[<span style="color:#ae81ff">1</span>]) <span style="color:#f92672">*</span> np<span style="color:#f92672">.</span>float(rating_pair[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>        sum_xy <span style="color:#f92672">+=</span> np<span style="color:#f92672">.</span>float(rating_pair[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">*</span> np<span style="color:#f92672">.</span>float(rating_pair[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># sum_y += rt[1]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># sum_x += rt[0]</span>
</span></span><span style="display:flex;"><span>        n <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    cos_sim <span style="color:#f92672">=</span> cosine(sum_xy,np<span style="color:#f92672">.</span>sqrt(sum_xx),np<span style="color:#f92672">.</span>sqrt(sum_yy))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> user_pair, (cos_sim,n)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">cosine</span>(dot_product,rating_norm_squared,rating2_norm_squared):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    The cosine between two vectors A, B
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       dotProduct(A, B) / (norm(A) * norm(B))
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    numerator <span style="color:#f92672">=</span> dot_product
</span></span><span style="display:flex;"><span>    denominator <span style="color:#f92672">=</span> rating_norm_squared <span style="color:#f92672">*</span> rating2_norm_squared
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (numerator <span style="color:#f92672">/</span> (float(denominator))) <span style="color:#66d9ef">if</span> denominator <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">3</span>:
</span></span><span style="display:flex;"><span>        print <span style="color:#f92672">&gt;&gt;</span> sys<span style="color:#f92672">.</span>stderr, \
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Usage: PythonUserCF &lt;master&gt; &lt;file&gt;&#34;</span>
</span></span><span style="display:flex;"><span>        exit(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    sc <span style="color:#f92672">=</span> SparkContext(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>], <span style="color:#e6db74">&#34;PythonUserCF&#34;</span>)
</span></span><span style="display:flex;"><span>    lines <span style="color:#f92672">=</span> sc<span style="color:#f92672">.</span>textFile(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Parse the vector with item_id as the key:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        item_id -&gt; (user_id,rating)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    item_user <span style="color:#f92672">=</span> lines<span style="color:#f92672">.</span>map(parseVector)<span style="color:#f92672">.</span>cache()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Get co_rating users by joining on item_id:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        item_id -&gt; ((user_1,rating),(user2,rating))
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    item_user_pairs <span style="color:#f92672">=</span> item_user<span style="color:#f92672">.</span>join(item_user)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Key each item_user_pair on the user_pair and get rid of non-unique 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    user pairs, then aggregate all co-rating pairs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        (user1_id,user2_id) -&gt; [(rating1,rating2),
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                (rating1,rating2),
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                (rating1,rating2),
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                ...]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    user_item_rating_pairs <span style="color:#f92672">=</span> item_user_pairs<span style="color:#f92672">.</span>map(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">lambda</span> p: keyOnUserPair(p[<span style="color:#ae81ff">0</span>],p[<span style="color:#ae81ff">1</span>]))<span style="color:#f92672">.</span>filter(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">lambda</span> p: p[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>] <span style="color:#f92672">!=</span> p[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">1</span>])<span style="color:#f92672">.</span>groupByKey()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Calculate the cosine similarity for each user pair:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        (user1,user2) -&gt;    (similarity,co_raters_count)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    user_pair_sims <span style="color:#f92672">=</span> user_item_rating_pairs<span style="color:#f92672">.</span>map(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">lambda</span> p: calcSim(p[<span style="color:#ae81ff">0</span>],p[<span style="color:#ae81ff">1</span>]))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> p <span style="color:#f92672">in</span> user_pair_sims<span style="color:#f92672">.</span>collect():
</span></span><span style="display:flex;"><span>        print p
</span></span></code></pre></div><ul>
<li>ItemBasedRecommender</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Item-based Collaborative Filtering on pySpark with cosine similarity and weighted sums</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> collections <span style="color:#f92672">import</span> defaultdict
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> itertools <span style="color:#f92672">import</span> combinations
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> csv
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pdb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark <span style="color:#f92672">import</span> SparkContext
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> recsys.evaluation.prediction <span style="color:#f92672">import</span> MAE
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parseVector</span>(line):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Parse each line of the specified data file, assuming a &#34;|&#34; delimiter.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Converts each rating to a float
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    line <span style="color:#f92672">=</span> line<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;|&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> line[<span style="color:#ae81ff">0</span>],(line[<span style="color:#ae81ff">1</span>],float(line[<span style="color:#ae81ff">2</span>]))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sampleInteractions</span>(user_id,items_with_rating,n):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    For users with # interactions &gt; n, replace their interaction history
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    with a sample of n items_with_rating
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(items_with_rating) <span style="color:#f92672">&gt;</span> n:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> user_id, random<span style="color:#f92672">.</span>sample(items_with_rating,n)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> user_id, items_with_rating
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">findItemPairs</span>(user_id,items_with_rating):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    For each user, find all item-item pairs combos. (i.e. items with the same user) 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> item1,item2 <span style="color:#f92672">in</span> combinations(items_with_rating,<span style="color:#ae81ff">2</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (item1[<span style="color:#ae81ff">0</span>],item2[<span style="color:#ae81ff">0</span>]),(item1[<span style="color:#ae81ff">1</span>],item2[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calcSim</span>(item_pair,rating_pairs):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    For each item-item pair, return the specified similarity measure,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    along with co_raters_count
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    sum_xx, sum_xy, sum_yy, sum_x, sum_y, n <span style="color:#f92672">=</span> (<span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> rating_pair <span style="color:#f92672">in</span> rating_pairs:
</span></span><span style="display:flex;"><span>        sum_xx <span style="color:#f92672">+=</span> np<span style="color:#f92672">.</span>float(rating_pair[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">*</span> np<span style="color:#f92672">.</span>float(rating_pair[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>        sum_yy <span style="color:#f92672">+=</span> np<span style="color:#f92672">.</span>float(rating_pair[<span style="color:#ae81ff">1</span>]) <span style="color:#f92672">*</span> np<span style="color:#f92672">.</span>float(rating_pair[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>        sum_xy <span style="color:#f92672">+=</span> np<span style="color:#f92672">.</span>float(rating_pair[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">*</span> np<span style="color:#f92672">.</span>float(rating_pair[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># sum_y += rt[1]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># sum_x += rt[0]</span>
</span></span><span style="display:flex;"><span>        n <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    cos_sim <span style="color:#f92672">=</span> cosine(sum_xy,np<span style="color:#f92672">.</span>sqrt(sum_xx),np<span style="color:#f92672">.</span>sqrt(sum_yy))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> item_pair, (cos_sim,n)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">cosine</span>(dot_product,rating_norm_squared,rating2_norm_squared):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    The cosine between two vectors A, B
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       dotProduct(A, B) / (norm(A) * norm(B))
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    numerator <span style="color:#f92672">=</span> dot_product
</span></span><span style="display:flex;"><span>    denominator <span style="color:#f92672">=</span> rating_norm_squared <span style="color:#f92672">*</span> rating2_norm_squared
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (numerator <span style="color:#f92672">/</span> (float(denominator))) <span style="color:#66d9ef">if</span> denominator <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">correlation</span>(size, dot_product, rating_sum, \
</span></span><span style="display:flex;"><span>            rating2sum, rating_norm_squared, rating2_norm_squared):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    The correlation between two vectors A, B is
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      [n * dotProduct(A, B) - sum(A) * sum(B)] /
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        sqrt{ [n * norm(A)^2 - sum(A)^2] [n * norm(B)^2 - sum(B)^2] }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    numerator <span style="color:#f92672">=</span> size <span style="color:#f92672">*</span> dot_product <span style="color:#f92672">-</span> rating_sum <span style="color:#f92672">*</span> rating2sum
</span></span><span style="display:flex;"><span>    denominator <span style="color:#f92672">=</span> sqrt(size <span style="color:#f92672">*</span> rating_norm_squared <span style="color:#f92672">-</span> rating_sum <span style="color:#f92672">*</span> rating_sum) <span style="color:#f92672">*</span> \
</span></span><span style="display:flex;"><span>                    sqrt(size <span style="color:#f92672">*</span> rating2_norm_squared <span style="color:#f92672">-</span> rating2sum <span style="color:#f92672">*</span> rating2sum)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (numerator <span style="color:#f92672">/</span> (float(denominator))) <span style="color:#66d9ef">if</span> denominator <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">keyOnFirstItem</span>(item_pair,item_sim_data):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    For each item-item pair, make the first item&#39;s id the key
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    (item1_id,item2_id) <span style="color:#f92672">=</span> item_pair
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> item1_id,(item2_id,item_sim_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">nearestNeighbors</span>(item_id,items_and_sims,n):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Sort the predictions list by similarity and select the top-N neighbors
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    items_and_sims<span style="color:#f92672">.</span>sort(key<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> x: x[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">0</span>],reverse<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> item_id, items_and_sims[:n]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">topNRecommendations</span>(user_id,items_with_rating,item_sims,n):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Calculate the top-N item recommendations for each user using the 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    weighted sums method
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># initialize dicts to store the score of each individual item,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># since an item can exist in more than one item neighborhood</span>
</span></span><span style="display:flex;"><span>    totals <span style="color:#f92672">=</span> defaultdict(int)
</span></span><span style="display:flex;"><span>    sim_sums <span style="color:#f92672">=</span> defaultdict(int)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (item,rating) <span style="color:#f92672">in</span> items_with_rating:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># lookup the nearest neighbors for this item</span>
</span></span><span style="display:flex;"><span>        nearest_neighbors <span style="color:#f92672">=</span> item_sims<span style="color:#f92672">.</span>get(item,<span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> nearest_neighbors:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> (neighbor,(sim,count)) <span style="color:#f92672">in</span> nearest_neighbors:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> neighbor <span style="color:#f92672">!=</span> item:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e"># update totals and sim_sums with the rating data</span>
</span></span><span style="display:flex;"><span>                    totals[neighbor] <span style="color:#f92672">+=</span> sim <span style="color:#f92672">*</span> rating
</span></span><span style="display:flex;"><span>                    sim_sums[neighbor] <span style="color:#f92672">+=</span> sim
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># create the normalized list of scored items </span>
</span></span><span style="display:flex;"><span>    scored_items <span style="color:#f92672">=</span> [(total<span style="color:#f92672">/</span>sim_sums[item],item) <span style="color:#66d9ef">for</span> item,total <span style="color:#f92672">in</span> totals<span style="color:#f92672">.</span>items()]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># sort the scored items in ascending order</span>
</span></span><span style="display:flex;"><span>    scored_items<span style="color:#f92672">.</span>sort(reverse<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># take out the item score</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ranked_items = [x[1] for x in scored_items]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> user_id,scored_items[:n]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">3</span>:
</span></span><span style="display:flex;"><span>        print <span style="color:#f92672">&gt;&gt;</span> sys<span style="color:#f92672">.</span>stderr, \
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Usage: PythonUserCF &lt;master&gt; &lt;file&gt;&#34;</span>
</span></span><span style="display:flex;"><span>        exit(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    sc <span style="color:#f92672">=</span> SparkContext(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>], <span style="color:#e6db74">&#34;PythonUserCF&#34;</span>)
</span></span><span style="display:flex;"><span>    lines <span style="color:#f92672">=</span> sc<span style="color:#f92672">.</span>textFile(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Obtain the sparse user-item matrix:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        user_id -&gt; [(item_id_1, rating_1),
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                   [(item_id_2, rating_2),
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    ...]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    user_item_pairs <span style="color:#f92672">=</span> lines<span style="color:#f92672">.</span>map(parseVector)<span style="color:#f92672">.</span>groupByKey()<span style="color:#f92672">.</span>map(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">lambda</span> p: sampleInteractions(p[<span style="color:#ae81ff">0</span>],p[<span style="color:#ae81ff">1</span>],<span style="color:#ae81ff">500</span>))<span style="color:#f92672">.</span>cache()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Get all item-item pair combos:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        (item1,item2) -&gt;    [(item1_rating,item2_rating),
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                             (item1_rating,item2_rating),
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                             ...]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pairwise_items <span style="color:#f92672">=</span> user_item_pairs<span style="color:#f92672">.</span>filter(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">lambda</span> p: len(p[<span style="color:#ae81ff">1</span>]) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>map(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">lambda</span> p: findItemPairs(p[<span style="color:#ae81ff">0</span>],p[<span style="color:#ae81ff">1</span>]))<span style="color:#f92672">.</span>groupByKey()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Calculate the cosine similarity for each item pair and select the top-N nearest neighbors:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        (item1,item2) -&gt;    (similarity,co_raters_count)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    item_sims <span style="color:#f92672">=</span> pairwise_items<span style="color:#f92672">.</span>map(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">lambda</span> p: calcSim(p[<span style="color:#ae81ff">0</span>],p[<span style="color:#ae81ff">1</span>]))<span style="color:#f92672">.</span>map(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">lambda</span> p: keyOnFirstItem(p[<span style="color:#ae81ff">0</span>],p[<span style="color:#ae81ff">1</span>]))<span style="color:#f92672">.</span>groupByKey()<span style="color:#f92672">.</span>map(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">lambda</span> p : (p[<span style="color:#ae81ff">0</span>], list(p[<span style="color:#ae81ff">1</span>])))<span style="color:#f92672">.</span>map(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">lambda</span> p: nearestNeighbors(p[<span style="color:#ae81ff">0</span>],p[<span style="color:#ae81ff">1</span>],<span style="color:#ae81ff">50</span>))<span style="color:#f92672">.</span>collect()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Preprocess the item similarity matrix into a dictionary and store it as a broadcast variable:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    item_sim_dict <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (item,data) <span style="color:#f92672">in</span> item_sims: 
</span></span><span style="display:flex;"><span>        item_sim_dict[item] <span style="color:#f92672">=</span> data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    isb <span style="color:#f92672">=</span> sc<span style="color:#f92672">.</span>broadcast(item_sim_dict)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Calculate the top-N item recommendations for each user
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        user_id -&gt; [item1,item2,item3,...]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    user_item_recs <span style="color:#f92672">=</span> user_item_pairs<span style="color:#f92672">.</span>map(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">lambda</span> p: topNRecommendations(p[<span style="color:#ae81ff">0</span>],p[<span style="color:#ae81ff">1</span>],isb<span style="color:#f92672">.</span>value,<span style="color:#ae81ff">500</span>))<span style="color:#f92672">.</span>collect()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Read in test data and calculate MAE
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    test_ratings <span style="color:#f92672">=</span> defaultdict(list)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># read in the test data</span>
</span></span><span style="display:flex;"><span>    f <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;tests/data/cftest.txt&#34;</span>, <span style="color:#e6db74">&#39;rt&#39;</span>)
</span></span><span style="display:flex;"><span>    reader <span style="color:#f92672">=</span> csv<span style="color:#f92672">.</span>reader(f, delimiter<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;|&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> reader:
</span></span><span style="display:flex;"><span>        user <span style="color:#f92672">=</span> row[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        item <span style="color:#f92672">=</span> row[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        rating <span style="color:#f92672">=</span> row[<span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>        test_ratings[user] <span style="color:#f92672">+=</span> [(item,rating)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># create train-test rating tuples</span>
</span></span><span style="display:flex;"><span>    preds <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (user,items_with_rating) <span style="color:#f92672">in</span> user_item_recs:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (rating,item) <span style="color:#f92672">in</span> items_with_rating:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> (test_item,test_rating) <span style="color:#f92672">in</span> test_ratings[user]:                
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> str(test_item) <span style="color:#f92672">==</span> str(item):
</span></span><span style="display:flex;"><span>                    preds<span style="color:#f92672">.</span>append((rating,float(test_rating)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    mae <span style="color:#f92672">=</span> MAE(preds)
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> mae<span style="color:#f92672">.</span>compute()
</span></span><span style="display:flex;"><span>    print <span style="color:#e6db74">&#34;Mean Absolute Error: &#34;</span>,result
</span></span></code></pre></div><ul>
<li>userbasedRemcommender</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># User-based Collaborative Filtering on pySpark with cosine similarity and weighted sums</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> collections <span style="color:#f92672">import</span> defaultdict
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> itertools <span style="color:#f92672">import</span> combinations
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pdb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark <span style="color:#f92672">import</span> SparkContext
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parseVectorOnUser</span>(line):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Parse each line of the specified data file, assuming a &#34;|&#34; delimiter.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Key is user_id, converts each rating to a float.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    line <span style="color:#f92672">=</span> line<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;|&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> line[<span style="color:#ae81ff">0</span>],(line[<span style="color:#ae81ff">1</span>],float(line[<span style="color:#ae81ff">2</span>]))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parseVectorOnItem</span>(line):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Parse each line of the specified data file, assuming a &#34;|&#34; delimiter.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Key is item_id, converts each rating to a float.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    line <span style="color:#f92672">=</span> line<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;|&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> line[<span style="color:#ae81ff">1</span>],(line[<span style="color:#ae81ff">0</span>],float(line[<span style="color:#ae81ff">2</span>]))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sampleInteractions</span>(item_id,users_with_rating,n):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    For items with # interactions &gt; n, replace their interaction history
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    with a sample of n users_with_rating
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(users_with_rating) <span style="color:#f92672">&gt;</span> n:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> item_id, random<span style="color:#f92672">.</span>sample(users_with_rating,n)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> item_id, users_with_rating
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">findUserPairs</span>(item_id,users_with_rating):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    For each item, find all user-user pairs combos. (i.e. users with the same item) 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> user1,user2 <span style="color:#f92672">in</span> combinations(users_with_rating,<span style="color:#ae81ff">2</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (user1[<span style="color:#ae81ff">0</span>],user2[<span style="color:#ae81ff">0</span>]),(user1[<span style="color:#ae81ff">1</span>],user2[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calcSim</span>(user_pair,rating_pairs):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    For each user-user pair, return the specified similarity measure,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    along with co_raters_count.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    sum_xx, sum_xy, sum_yy, sum_x, sum_y, n <span style="color:#f92672">=</span> (<span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> rating_pair <span style="color:#f92672">in</span> rating_pairs:
</span></span><span style="display:flex;"><span>        sum_xx <span style="color:#f92672">+=</span> np<span style="color:#f92672">.</span>float(rating_pair[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">*</span> np<span style="color:#f92672">.</span>float(rating_pair[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>        sum_yy <span style="color:#f92672">+=</span> np<span style="color:#f92672">.</span>float(rating_pair[<span style="color:#ae81ff">1</span>]) <span style="color:#f92672">*</span> np<span style="color:#f92672">.</span>float(rating_pair[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>        sum_xy <span style="color:#f92672">+=</span> np<span style="color:#f92672">.</span>float(rating_pair[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">*</span> np<span style="color:#f92672">.</span>float(rating_pair[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># sum_y += rt[1]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># sum_x += rt[0]</span>
</span></span><span style="display:flex;"><span>        n <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    cos_sim <span style="color:#f92672">=</span> cosine(sum_xy,np<span style="color:#f92672">.</span>sqrt(sum_xx),np<span style="color:#f92672">.</span>sqrt(sum_yy))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> user_pair, (cos_sim,n)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">cosine</span>(dot_product,rating_norm_squared,rating2_norm_squared):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    The cosine between two vectors A, B
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       dotProduct(A, B) / (norm(A) * norm(B))
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    numerator <span style="color:#f92672">=</span> dot_product
</span></span><span style="display:flex;"><span>    denominator <span style="color:#f92672">=</span> rating_norm_squared <span style="color:#f92672">*</span> rating2_norm_squared
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (numerator <span style="color:#f92672">/</span> (float(denominator))) <span style="color:#66d9ef">if</span> denominator <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">keyOnFirstUser</span>(user_pair,item_sim_data):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    For each user-user pair, make the first user&#39;s id the key
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    (user1_id,user2_id) <span style="color:#f92672">=</span> user_pair
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> user1_id,(user2_id,item_sim_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">nearestNeighbors</span>(user,users_and_sims,n):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Sort the predictions list by similarity and select the top-N neighbors
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    users_and_sims<span style="color:#f92672">.</span>sort(key<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> x: x[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">0</span>],reverse<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> user, users_and_sims[:n]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">topNRecommendations</span>(user_id,user_sims,users_with_rating,n):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Calculate the top-N item recommendations for each user using the 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    weighted sums method
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># initialize dicts to store the score of each individual item,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># since an item can exist in more than one item neighborhood</span>
</span></span><span style="display:flex;"><span>    totals <span style="color:#f92672">=</span> defaultdict(int)
</span></span><span style="display:flex;"><span>    sim_sums <span style="color:#f92672">=</span> defaultdict(int)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (neighbor,(sim,count)) <span style="color:#f92672">in</span> user_sims:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># lookup the item predictions for this neighbor</span>
</span></span><span style="display:flex;"><span>        unscored_items <span style="color:#f92672">=</span> users_with_rating<span style="color:#f92672">.</span>get(neighbor,<span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> unscored_items:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> (item,rating) <span style="color:#f92672">in</span> unscored_items:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> neighbor <span style="color:#f92672">!=</span> item:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e"># update totals and sim_sums with the rating data</span>
</span></span><span style="display:flex;"><span>                    totals[neighbor] <span style="color:#f92672">+=</span> sim <span style="color:#f92672">*</span> rating
</span></span><span style="display:flex;"><span>                    sim_sums[neighbor] <span style="color:#f92672">+=</span> sim
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># create the normalized list of scored items </span>
</span></span><span style="display:flex;"><span>    scored_items <span style="color:#f92672">=</span> [(total<span style="color:#f92672">/</span>sim_sums[item],item) <span style="color:#66d9ef">for</span> item,total <span style="color:#f92672">in</span> totals<span style="color:#f92672">.</span>items()]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># sort the scored items in ascending order</span>
</span></span><span style="display:flex;"><span>    scored_items<span style="color:#f92672">.</span>sort(reverse<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># take out the item score</span>
</span></span><span style="display:flex;"><span>    ranked_items <span style="color:#f92672">=</span> [x[<span style="color:#ae81ff">1</span>] <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> scored_items]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> user_id,ranked_items[:n]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">3</span>:
</span></span><span style="display:flex;"><span>        print <span style="color:#f92672">&gt;&gt;</span> sys<span style="color:#f92672">.</span>stderr, \
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Usage: PythonUserCF &lt;master&gt; &lt;file&gt;&#34;</span>
</span></span><span style="display:flex;"><span>        exit(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    sc <span style="color:#f92672">=</span> SparkContext(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>],<span style="color:#e6db74">&#34;PythonUserItemCF&#34;</span>)
</span></span><span style="display:flex;"><span>    lines <span style="color:#f92672">=</span> sc<span style="color:#f92672">.</span>textFile(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Obtain the sparse item-user matrix:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        item_id -&gt; ((user_1,rating),(user2,rating))
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    item_user_pairs <span style="color:#f92672">=</span> lines<span style="color:#f92672">.</span>map(parseVectorOnItem)<span style="color:#f92672">.</span>groupByKey()<span style="color:#f92672">.</span>map(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">lambda</span> p: sampleInteractions(p[<span style="color:#ae81ff">0</span>],p[<span style="color:#ae81ff">1</span>],<span style="color:#ae81ff">500</span>))<span style="color:#f92672">.</span>cache()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Get all item-item pair combos:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        (user1_id,user2_id) -&gt; [(rating1,rating2),
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                (rating1,rating2),
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                (rating1,rating2),
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                ...]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    pairwise_users <span style="color:#f92672">=</span> item_user_pairs<span style="color:#f92672">.</span>filter(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">lambda</span> p: len(p[<span style="color:#ae81ff">1</span>]) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>map(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">lambda</span> p: findUserPairs(p[<span style="color:#ae81ff">0</span>],p[<span style="color:#ae81ff">1</span>]))<span style="color:#f92672">.</span>groupByKey()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Calculate the cosine similarity for each user pair and select the top-N nearest neighbors:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        (user1,user2) -&gt;    (similarity,co_raters_count)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    user_sims <span style="color:#f92672">=</span> pairwise_users<span style="color:#f92672">.</span>map(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">lambda</span> p: calcSim(p[<span style="color:#ae81ff">0</span>],p[<span style="color:#ae81ff">1</span>]))<span style="color:#f92672">.</span>map(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">lambda</span> p: keyOnFirstUser(p[<span style="color:#ae81ff">0</span>],p[<span style="color:#ae81ff">1</span>]))<span style="color:#f92672">.</span>groupByKey()<span style="color:#f92672">.</span>map(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">lambda</span> p: nearestNeighbors(p[<span style="color:#ae81ff">0</span>],p[<span style="color:#ae81ff">1</span>],<span style="color:#ae81ff">50</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Obtain the the item history for each user and store it as a broadcast variable
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        user_id -&gt; [(item_id_1, rating_1),
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                   [(item_id_2, rating_2),
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    ...]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    user_item_hist <span style="color:#f92672">=</span> lines<span style="color:#f92672">.</span>map(parseVectorOnUser)<span style="color:#f92672">.</span>groupByKey()<span style="color:#f92672">.</span>collect()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ui_dict <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (user,items) <span style="color:#f92672">in</span> user_item_hist: 
</span></span><span style="display:flex;"><span>        ui_dict[user] <span style="color:#f92672">=</span> items
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    uib <span style="color:#f92672">=</span> sc<span style="color:#f92672">.</span>broadcast(ui_dict)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Calculate the top-N item recommendations for each user
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        user_id -&gt; [item1,item2,item3,...]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    user_item_recs <span style="color:#f92672">=</span> user_sims<span style="color:#f92672">.</span>map(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">lambda</span> p: topNRecommendations(p[<span style="color:#ae81ff">0</span>],p[<span style="color:#ae81ff">1</span>],uib<span style="color:#f92672">.</span>value,<span style="color:#ae81ff">100</span>))<span style="color:#f92672">.</span>collect()
</span></span></code></pre></div><h5 id="24-图像分类http172268520265501notebookstransfer-learning-pyspark-masterpyspark-digit-image-multiclassipynb">2.4. <a href="http://172.26.85.202:65501/notebooks/Transfer-Learning-PySpark-master/PySpark-Digit-Image-MultiClass.ipynb"target="_blank" rel="external nofollow noopener noreferrer">图像分类<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#拼接展示图片数据</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> IPython.display <span style="color:#66d9ef">as</span> dp
</span></span><span style="display:flex;"><span><span style="color:#75715e"># collect all .png files in ssample dir</span>
</span></span><span style="display:flex;"><span>fs <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">!</span>ls sample<span style="color:#f92672">/*.</span>png
</span></span><span style="display:flex;"><span><span style="color:#75715e"># create list of image objects</span>
</span></span><span style="display:flex;"><span>images <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ea <span style="color:#f92672">in</span> fs:
</span></span><span style="display:flex;"><span>    images<span style="color:#f92672">.</span>append(dp<span style="color:#f92672">.</span>Image(filename<span style="color:#f92672">=</span>ea, format<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;png&#39;</span>))
</span></span><span style="display:flex;"><span><span style="color:#75715e"># display all images</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ea <span style="color:#f92672">in</span> images:
</span></span><span style="display:flex;"><span>    dp<span style="color:#f92672">.</span>display_png(ea)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.sql <span style="color:#f92672">import</span> SparkSession
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark <span style="color:#f92672">import</span> SparkContext, SparkConf
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.sql <span style="color:#f92672">import</span> SQLContext
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>spark <span style="color:#f92672">=</span> SparkSession<span style="color:#f92672">.</span>builder<span style="color:#f92672">.</span>\
</span></span><span style="display:flex;"><span>            config(<span style="color:#e6db74">&#34;spark.executor.memory&#34;</span>, <span style="color:#e6db74">&#34;1g&#34;</span>)<span style="color:#f92672">.</span>\
</span></span><span style="display:flex;"><span>            config(<span style="color:#e6db74">&#34;spark.driver.memory&#34;</span>, <span style="color:#e6db74">&#34;4g&#34;</span>)<span style="color:#f92672">.</span>\
</span></span><span style="display:flex;"><span>            config(<span style="color:#e6db74">&#34;spark.cores.max&#34;</span>, <span style="color:#e6db74">&#34;2&#34;</span>)<span style="color:#f92672">.</span>\
</span></span><span style="display:flex;"><span>            appName(<span style="color:#e6db74">&#39;SparkImageClassifier&#39;</span>)<span style="color:#f92672">.</span>getOrCreate()
</span></span><span style="display:flex;"><span><span style="color:#75715e">#加载图片数据</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys<span style="color:#f92672">,</span> glob<span style="color:#f92672">,</span> os
</span></span><span style="display:flex;"><span>sys<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>extend(glob<span style="color:#f92672">.</span>glob(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>expanduser(<span style="color:#e6db74">&#34;~&#34;</span>), <span style="color:#e6db74">&#34;.ivy2/jars/*.jar&#34;</span>)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.image <span style="color:#f92672">import</span> ImageSchema
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.sql.functions <span style="color:#f92672">import</span> lit
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># loaded image</span>
</span></span><span style="display:flex;"><span>zero_df <span style="color:#f92672">=</span> ImageSchema<span style="color:#f92672">.</span>readImages(<span style="color:#e6db74">&#34;images/0&#34;</span>)<span style="color:#f92672">.</span>withColumn(<span style="color:#e6db74">&#34;label&#34;</span>, lit(<span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>one_df <span style="color:#f92672">=</span> ImageSchema<span style="color:#f92672">.</span>readImages(<span style="color:#e6db74">&#34;images/1&#34;</span>)<span style="color:#f92672">.</span>withColumn(<span style="color:#e6db74">&#34;label&#34;</span>, lit(<span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>two_df <span style="color:#f92672">=</span> ImageSchema<span style="color:#f92672">.</span>readImages(<span style="color:#e6db74">&#34;images/2&#34;</span>)<span style="color:#f92672">.</span>withColumn(<span style="color:#e6db74">&#34;label&#34;</span>, lit(<span style="color:#ae81ff">2</span>))
</span></span><span style="display:flex;"><span>three_df <span style="color:#f92672">=</span> ImageSchema<span style="color:#f92672">.</span>readImages(<span style="color:#e6db74">&#34;images/3&#34;</span>)<span style="color:#f92672">.</span>withColumn(<span style="color:#e6db74">&#34;label&#34;</span>, lit(<span style="color:#ae81ff">3</span>))
</span></span><span style="display:flex;"><span>four_df <span style="color:#f92672">=</span> ImageSchema<span style="color:#f92672">.</span>readImages(<span style="color:#e6db74">&#34;images/4&#34;</span>)<span style="color:#f92672">.</span>withColumn(<span style="color:#e6db74">&#34;label&#34;</span>, lit(<span style="color:#ae81ff">4</span>))
</span></span><span style="display:flex;"><span>five_df <span style="color:#f92672">=</span> ImageSchema<span style="color:#f92672">.</span>readImages(<span style="color:#e6db74">&#34;images/5&#34;</span>)<span style="color:#f92672">.</span>withColumn(<span style="color:#e6db74">&#34;label&#34;</span>, lit(<span style="color:#ae81ff">5</span>))
</span></span><span style="display:flex;"><span>six_df <span style="color:#f92672">=</span> ImageSchema<span style="color:#f92672">.</span>readImages(<span style="color:#e6db74">&#34;images/6&#34;</span>)<span style="color:#f92672">.</span>withColumn(<span style="color:#e6db74">&#34;label&#34;</span>, lit(<span style="color:#ae81ff">6</span>))
</span></span><span style="display:flex;"><span>seven_df <span style="color:#f92672">=</span> ImageSchema<span style="color:#f92672">.</span>readImages(<span style="color:#e6db74">&#34;images/7&#34;</span>)<span style="color:#f92672">.</span>withColumn(<span style="color:#e6db74">&#34;label&#34;</span>, lit(<span style="color:#ae81ff">7</span>))
</span></span><span style="display:flex;"><span>eight_df <span style="color:#f92672">=</span> ImageSchema<span style="color:#f92672">.</span>readImages(<span style="color:#e6db74">&#34;images/8&#34;</span>)<span style="color:#f92672">.</span>withColumn(<span style="color:#e6db74">&#34;label&#34;</span>, lit(<span style="color:#ae81ff">8</span>))
</span></span><span style="display:flex;"><span>nine_df <span style="color:#f92672">=</span> ImageSchema<span style="color:#f92672">.</span>readImages(<span style="color:#e6db74">&#34;images/9&#34;</span>)<span style="color:#f92672">.</span>withColumn(<span style="color:#e6db74">&#34;label&#34;</span>, lit(<span style="color:#ae81ff">9</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># merge data frame</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> functools <span style="color:#f92672">import</span> reduce
</span></span><span style="display:flex;"><span>dataframes <span style="color:#f92672">=</span> [zero_df, one_df, two_df, three_df, 
</span></span><span style="display:flex;"><span>              four_df,five_df,six_df,seven_df,eight_df,nine_df]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>df <span style="color:#f92672">=</span> reduce(<span style="color:#66d9ef">lambda</span> first, second: first<span style="color:#f92672">.</span>union(second), dataframes)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># repartition dataframe </span>
</span></span><span style="display:flex;"><span>df <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>repartition(<span style="color:#ae81ff">200</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># On hot encoding </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.feature <span style="color:#f92672">import</span> OneHotEncoderEstimator
</span></span><span style="display:flex;"><span>encoder <span style="color:#f92672">=</span> OneHotEncoderEstimator(inputCols<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;label&#34;</span>],outputCols<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;one_hot_label&#34;</span>])
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> encoder<span style="color:#f92672">.</span>fit(df)
</span></span><span style="display:flex;"><span>df <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>transform(df)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># split the data-frame</span>
</span></span><span style="display:flex;"><span>train, test <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>randomSplit([<span style="color:#ae81ff">0.8</span>, <span style="color:#ae81ff">0.2</span>], <span style="color:#ae81ff">42</span>)
</span></span><span style="display:flex;"><span>train<span style="color:#f92672">.</span>printSchema()  <span style="color:#75715e">#image, label</span>
</span></span><span style="display:flex;"><span>test<span style="color:#f92672">.</span>printSchema()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">%%</span>time
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.evaluation <span style="color:#f92672">import</span> MulticlassClassificationEvaluator
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.classification <span style="color:#f92672">import</span> LogisticRegression
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml <span style="color:#f92672">import</span> Pipeline
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sparkdl <span style="color:#f92672">import</span> DeepImageFeaturizer 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># model: InceptionV3</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># extracting feature from images</span>
</span></span><span style="display:flex;"><span>featurizer <span style="color:#f92672">=</span> DeepImageFeaturizer(inputCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;image&#34;</span>, outputCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;features&#34;</span>,
</span></span><span style="display:flex;"><span>                                 modelName<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;InceptionV3&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># used as a multi class classifier</span>
</span></span><span style="display:flex;"><span>lr <span style="color:#f92672">=</span> LogisticRegression(maxIter<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>, regParam<span style="color:#f92672">=</span><span style="color:#ae81ff">0.03</span>, 
</span></span><span style="display:flex;"><span>                        elasticNetParam<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>, labelCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;label&#34;</span>) 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># define a pipeline model</span>
</span></span><span style="display:flex;"><span>sparkdn <span style="color:#f92672">=</span> Pipeline(stages<span style="color:#f92672">=</span>[featurizer, lr])
</span></span><span style="display:flex;"><span>spark_model <span style="color:#f92672">=</span> sparkdn<span style="color:#f92672">.</span>fit(train)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Evaluation</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.evaluation <span style="color:#f92672">import</span> MulticlassClassificationEvaluator
</span></span><span style="display:flex;"><span><span style="color:#75715e"># evaluate the model with test set</span>
</span></span><span style="display:flex;"><span>evaluator <span style="color:#f92672">=</span> MulticlassClassificationEvaluator() 
</span></span><span style="display:flex;"><span>transform_test <span style="color:#f92672">=</span> spark_model<span style="color:#f92672">.</span>transform(test)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;F1-Score &#39;</span>, evaluator<span style="color:#f92672">.</span>evaluate(transform_test, 
</span></span><span style="display:flex;"><span>                                      {evaluator<span style="color:#f92672">.</span>metricName: <span style="color:#e6db74">&#39;f1&#39;</span>}))
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;Precision &#39;</span>, evaluator<span style="color:#f92672">.</span>evaluate(transform_test,
</span></span><span style="display:flex;"><span>                                       {evaluator<span style="color:#f92672">.</span>metricName: <span style="color:#e6db74">&#39;weightedPrecision&#39;</span>}))
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;Recall &#39;</span>, evaluator<span style="color:#f92672">.</span>evaluate(transform_test, 
</span></span><span style="display:flex;"><span>                                    {evaluator<span style="color:#f92672">.</span>metricName: <span style="color:#e6db74">&#39;weightedRecall&#39;</span>}))
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;Accuracy &#39;</span>, evaluator<span style="color:#f92672">.</span>evaluate(transform_test, 
</span></span><span style="display:flex;"><span>                                      {evaluator<span style="color:#f92672">.</span>metricName: <span style="color:#e6db74">&#39;accuracy&#39;</span>}))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Confusion Matrix</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> itertools
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">plot_confusion_matrix</span>(cm, classes,
</span></span><span style="display:flex;"><span>                          normalize<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>                          title<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Confusion matrix&#39;</span>,
</span></span><span style="display:flex;"><span>                          cmap<span style="color:#f92672">=</span>plt<span style="color:#f92672">.</span>cm<span style="color:#f92672">.</span>GnBu):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>imshow(cm, interpolation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;nearest&#39;</span>, cmap<span style="color:#f92672">=</span>cmap)
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>title(title)
</span></span><span style="display:flex;"><span>    tick_marks <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>arange(len(classes))
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>xticks(tick_marks, classes, rotation<span style="color:#f92672">=</span><span style="color:#ae81ff">45</span>)
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>yticks(tick_marks, classes)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    fmt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;.2f&#39;</span> <span style="color:#66d9ef">if</span> normalize <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#39;d&#39;</span>
</span></span><span style="display:flex;"><span>    thresh <span style="color:#f92672">=</span> cm<span style="color:#f92672">.</span>max() <span style="color:#f92672">/</span> <span style="color:#ae81ff">2.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i, j <span style="color:#f92672">in</span> itertools<span style="color:#f92672">.</span>product(range(cm<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]), range(cm<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>])):
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>text(j, i, format(cm[i, j], fmt),
</span></span><span style="display:flex;"><span>                 horizontalalignment<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;center&#34;</span>,
</span></span><span style="display:flex;"><span>                 color<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;white&#34;</span> <span style="color:#66d9ef">if</span> cm[i, j] <span style="color:#f92672">&gt;</span> thresh <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;black&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>tight_layout()
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;True label&#39;</span>)
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;Predicted label&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- Convert Spark-DataFrame to Pnadas-DataFrame
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- Call Confusion Matrix With &#39;True&#39; and &#39;Predicted&#39; Label
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sklearn.metrics <span style="color:#f92672">import</span> confusion_matrix
</span></span><span style="display:flex;"><span>y_true <span style="color:#f92672">=</span> transform_test<span style="color:#f92672">.</span>select(<span style="color:#e6db74">&#34;label&#34;</span>)
</span></span><span style="display:flex;"><span>y_true <span style="color:#f92672">=</span> y_true<span style="color:#f92672">.</span>toPandas() <span style="color:#75715e"># convert to pandas dataframe from spark dataframe</span>
</span></span><span style="display:flex;"><span>y_pred <span style="color:#f92672">=</span> transform_test<span style="color:#f92672">.</span>select(<span style="color:#e6db74">&#34;prediction&#34;</span>)
</span></span><span style="display:flex;"><span>y_pred <span style="color:#f92672">=</span> y_pred<span style="color:#f92672">.</span>toPandas() <span style="color:#75715e"># convert to pandas dataframe from spark dataframe</span>
</span></span><span style="display:flex;"><span>cnf_matrix <span style="color:#f92672">=</span> confusion_matrix(y_true, y_pred,labels<span style="color:#f92672">=</span>range(<span style="color:#ae81ff">10</span>))
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- Visualize the &#39;Confusion Matrix&#39; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> seaborn <span style="color:#66d9ef">as</span> sns
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span>matplotlib inline
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sns<span style="color:#f92672">.</span>set_style(<span style="color:#e6db74">&#34;darkgrid&#34;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">7</span>))
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>grid(<span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># call pre defined function</span>
</span></span><span style="display:flex;"><span>plot_confusion_matrix(cnf_matrix, classes<span style="color:#f92672">=</span>range(<span style="color:#ae81ff">10</span>)) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- Classification Report of each class group
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sklearn.metrics <span style="color:#f92672">import</span> classification_report
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>target_names <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;Class </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(i) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10</span>)]
</span></span><span style="display:flex;"><span>print(classification_report(y_true, y_pred, target_names <span style="color:#f92672">=</span> target_names))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- A custom ROC AUC score function for multi-class classification problem
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sklearn.metrics <span style="color:#f92672">import</span> roc_curve, auc, roc_auc_score
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sklearn.preprocessing <span style="color:#f92672">import</span> LabelBinarizer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">multiclass_roc_auc_score</span>(y_test, y_pred, average<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;macro&#34;</span>):
</span></span><span style="display:flex;"><span>    lb <span style="color:#f92672">=</span> LabelBinarizer()
</span></span><span style="display:flex;"><span>    lb<span style="color:#f92672">.</span>fit(y_test)
</span></span><span style="display:flex;"><span>    y_test <span style="color:#f92672">=</span> lb<span style="color:#f92672">.</span>transform(y_test)
</span></span><span style="display:flex;"><span>    y_pred <span style="color:#f92672">=</span> lb<span style="color:#f92672">.</span>transform(y_pred)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> roc_auc_score(y_test, y_pred, average<span style="color:#f92672">=</span>average)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;ROC AUC score:&#39;</span>, multiclass_roc_auc_score(y_true,y_pred))
</span></span></code></pre></div><h4 id="3-文件读取">3. 文件读取</h4>
<ul>
<li>图片数据</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#方式一</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.image <span style="color:#f92672">import</span> ImageSchema
</span></span><span style="display:flex;"><span>image_df <span style="color:#f92672">=</span> ImageSchema<span style="color:#f92672">.</span>readImages(<span style="color:#e6db74">&#34;/data/myimages&#34;</span>)
</span></span><span style="display:flex;"><span>image_df<span style="color:#f92672">.</span>show()
</span></span><span style="display:flex;"><span><span style="color:#75715e">#方式二</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> keras.preprocessing <span style="color:#f92672">import</span> image
</span></span><span style="display:flex;"><span>img <span style="color:#f92672">=</span> image<span style="color:#f92672">.</span>load_img(<span style="color:#e6db74">&#34;/data/myimages/daisy.jpg&#34;</span>, target_size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">299</span>, <span style="color:#ae81ff">299</span>))
</span></span></code></pre></div><ul>
<li>TransferLearning</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#方式三</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.classification <span style="color:#f92672">import</span> LogisticRegression
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.evaluation <span style="color:#f92672">import</span> MulticlassClassificationEvaluator
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml <span style="color:#f92672">import</span> Pipeline
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sparkdl <span style="color:#f92672">import</span> DeepImageFeaturizer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>featurizer <span style="color:#f92672">=</span> DeepImageFeaturizer(inputCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;image&#34;</span>, outputCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;features&#34;</span>, modelName<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;InceptionV3&#34;</span>)
</span></span><span style="display:flex;"><span>lr <span style="color:#f92672">=</span> LogisticRegression(maxIter<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>, regParam<span style="color:#f92672">=</span><span style="color:#ae81ff">0.05</span>, elasticNetParam<span style="color:#f92672">=</span><span style="color:#ae81ff">0.3</span>, labelCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;label&#34;</span>)
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> Pipeline(stages<span style="color:#f92672">=</span>[featurizer, lr])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>fit(train_images_df)    <span style="color:#75715e"># train_images_df is a dataset of images and labels</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Inspect training error</span>
</span></span><span style="display:flex;"><span>df <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>transform(train_images_df<span style="color:#f92672">.</span>limit(<span style="color:#ae81ff">10</span>))<span style="color:#f92672">.</span>select(<span style="color:#e6db74">&#34;image&#34;</span>, <span style="color:#e6db74">&#34;probability&#34;</span>,  <span style="color:#e6db74">&#34;uri&#34;</span>, <span style="color:#e6db74">&#34;label&#34;</span>)
</span></span><span style="display:flex;"><span>predictionAndLabels <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>select(<span style="color:#e6db74">&#34;prediction&#34;</span>, <span style="color:#e6db74">&#34;label&#34;</span>)
</span></span><span style="display:flex;"><span>evaluator <span style="color:#f92672">=</span> MulticlassClassificationEvaluator(metricName<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;accuracy&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Training set accuracy = &#34;</span> <span style="color:#f92672">+</span> str(evaluator<span style="color:#f92672">.</span>evaluate(predictionAndLabels)))
</span></span></code></pre></div><ul>
<li>分布式调参</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> keras.applications <span style="color:#f92672">import</span> InceptionV3
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> InceptionV3(weights<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;imagenet&#34;</span>)
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>save(<span style="color:#e6db74">&#39;/tmp/model-full.h5&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> PIL.Image
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> keras.applications.imagenet_utils <span style="color:#f92672">import</span> preprocess_input
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sparkdl.estimators.keras_image_file_estimator <span style="color:#f92672">import</span> KerasImageFileEstimator
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load_image_from_uri</span>(local_uri):
</span></span><span style="display:flex;"><span>  img <span style="color:#f92672">=</span> (PIL<span style="color:#f92672">.</span>Image<span style="color:#f92672">.</span>open(local_uri)<span style="color:#f92672">.</span>convert(<span style="color:#e6db74">&#39;RGB&#39;</span>)<span style="color:#f92672">.</span>resize((<span style="color:#ae81ff">299</span>, <span style="color:#ae81ff">299</span>), PIL<span style="color:#f92672">.</span>Image<span style="color:#f92672">.</span>ANTIALIAS))
</span></span><span style="display:flex;"><span>  img_arr <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(img)<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>float32)
</span></span><span style="display:flex;"><span>  img_tnsr <span style="color:#f92672">=</span> preprocess_input(img_arr[np<span style="color:#f92672">.</span>newaxis, :])
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> img_tnsr
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>estimator <span style="color:#f92672">=</span> KerasImageFileEstimator( inputCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;uri&#34;</span>,
</span></span><span style="display:flex;"><span>                                     outputCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;prediction&#34;</span>,
</span></span><span style="display:flex;"><span>                                     labelCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;one_hot_label&#34;</span>,
</span></span><span style="display:flex;"><span>                                     imageLoader<span style="color:#f92672">=</span>load_image_from_uri,
</span></span><span style="display:flex;"><span>                                     kerasOptimizer<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;adam&#39;</span>,
</span></span><span style="display:flex;"><span>                                     kerasLoss<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;categorical_crossentropy&#39;</span>,
</span></span><span style="display:flex;"><span>                                     modelFile<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/tmp/model-full-tmp.h5&#39;</span> <span style="color:#75715e"># local file path for model</span>
</span></span><span style="display:flex;"><span>                                   )
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.evaluation <span style="color:#f92672">import</span> BinaryClassificationEvaluator
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.tuning <span style="color:#f92672">import</span> CrossValidator, ParamGridBuilder
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>paramGrid <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>  ParamGridBuilder()
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">.</span>addGrid(estimator<span style="color:#f92672">.</span>kerasFitParams, [{<span style="color:#e6db74">&#34;batch_size&#34;</span>: <span style="color:#ae81ff">32</span>, <span style="color:#e6db74">&#34;verbose&#34;</span>: <span style="color:#ae81ff">0</span>},
</span></span><span style="display:flex;"><span>                                      {<span style="color:#e6db74">&#34;batch_size&#34;</span>: <span style="color:#ae81ff">64</span>, <span style="color:#e6db74">&#34;verbose&#34;</span>: <span style="color:#ae81ff">0</span>}])
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">.</span>build()
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>bc <span style="color:#f92672">=</span> BinaryClassificationEvaluator(rawPredictionCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;prediction&#34;</span>, labelCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;label&#34;</span> )
</span></span><span style="display:flex;"><span>cv <span style="color:#f92672">=</span> CrossValidator(estimator<span style="color:#f92672">=</span>estimator, estimatorParamMaps<span style="color:#f92672">=</span>paramGrid, evaluator<span style="color:#f92672">=</span>bc, numFolds<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cvModel <span style="color:#f92672">=</span> cv<span style="color:#f92672">.</span>fit(train_df)
</span></span></code></pre></div><ul>
<li>deep learning models</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.image <span style="color:#f92672">import</span> ImageSchema
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sparkdl <span style="color:#f92672">import</span> DeepImagePredictor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>image_df <span style="color:#f92672">=</span> ImageSchema<span style="color:#f92672">.</span>readImages(sample_img_dir)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>predictor <span style="color:#f92672">=</span> DeepImagePredictor(inputCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;image&#34;</span>, outputCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;predicted_labels&#34;</span>, modelName<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;InceptionV3&#34;</span>, decodePredictions<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, topK<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>predictions_df <span style="color:#f92672">=</span> predictor<span style="color:#f92672">.</span>transform(image_df)
</span></span></code></pre></div><ul>
<li>KerasImageFileTransformer</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> keras.applications.inception_v3 <span style="color:#f92672">import</span> preprocess_input
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> keras.preprocessing.image <span style="color:#f92672">import</span> img_to_array, load_img
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.sql.types <span style="color:#f92672">import</span> StringType
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sparkdl <span style="color:#f92672">import</span> KerasImageFileTransformer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">loadAndPreprocessKerasInceptionV3</span>(uri):
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># this is a typical way to load and prep images in keras</span>
</span></span><span style="display:flex;"><span>  image <span style="color:#f92672">=</span> img_to_array(load_img(uri, target_size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">299</span>, <span style="color:#ae81ff">299</span>)))  <span style="color:#75715e"># image dimensions for InceptionV3</span>
</span></span><span style="display:flex;"><span>  image <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>expand_dims(image, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> preprocess_input(image)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>transformer <span style="color:#f92672">=</span> KerasImageFileTransformer(inputCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;uri&#34;</span>, outputCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;predictions&#34;</span>,
</span></span><span style="display:flex;"><span>                                        modelFile<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/tmp/model-full-tmp.h5&#39;</span>,  <span style="color:#75715e"># local file path for model</span>
</span></span><span style="display:flex;"><span>                              imageLoader<span style="color:#f92672">=</span>loadAndPreprocessKerasInceptionV3,
</span></span><span style="display:flex;"><span>                                        outputMode<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;vector&#34;</span>)
</span></span><span style="display:flex;"><span>files <span style="color:#f92672">=</span> [os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>abspath(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(dirpath, f)) <span style="color:#66d9ef">for</span> f <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(<span style="color:#e6db74">&#34;/data/myimages&#34;</span>) <span style="color:#66d9ef">if</span> f<span style="color:#f92672">.</span>endswith(<span style="color:#e6db74">&#39;.jpg&#39;</span>)]
</span></span><span style="display:flex;"><span>uri_df <span style="color:#f92672">=</span> sqlContext<span style="color:#f92672">.</span>createDataFrame(files, StringType())<span style="color:#f92672">.</span>toDF(<span style="color:#e6db74">&#34;uri&#34;</span>)
</span></span><span style="display:flex;"><span>keras_pred_df <span style="color:#f92672">=</span> transformer<span style="color:#f92672">.</span>transform(uri_df)
</span></span></code></pre></div><ul>
<li>kerasTransferm</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> sparkdl <span style="color:#f92672">import</span> KerasTransformer
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> keras.models <span style="color:#f92672">import</span> Sequential
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> keras.layers <span style="color:#f92672">import</span> Dense
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate random input data</span>
</span></span><span style="display:flex;"><span>num_features <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>num_examples <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>input_data <span style="color:#f92672">=</span> [{<span style="color:#e6db74">&#34;features&#34;</span> : np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>randn(num_features)<span style="color:#f92672">.</span>tolist()} <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(num_examples)]
</span></span><span style="display:flex;"><span>input_df <span style="color:#f92672">=</span> sqlContext<span style="color:#f92672">.</span>createDataFrame(input_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create and save a single-hidden-layer Keras model for binary classification</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># NOTE: In a typical workflow, we&#39;d train the model before exporting it to disk,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># but we skip that step here for brevity</span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> Sequential()
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>add(Dense(units<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>, input_shape<span style="color:#f92672">=</span>[num_features], activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>))
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>add(Dense(units<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;sigmoid&#39;</span>))
</span></span><span style="display:flex;"><span>model_path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/tmp/simple-binary-classification&#34;</span>
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>save(model_path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create transformer and apply it to our input data</span>
</span></span><span style="display:flex;"><span>transformer <span style="color:#f92672">=</span> KerasTransformer(inputCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;features&#34;</span>, outputCol<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;predictions&#34;</span>, modelFile<span style="color:#f92672">=</span>model_path)
</span></span><span style="display:flex;"><span>final_df <span style="color:#f92672">=</span> transformer<span style="color:#f92672">.</span>transform(input_df)
</span></span></code></pre></div><ul>
<li>keras model udf</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> keras.applications <span style="color:#f92672">import</span> InceptionV3
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sparkdl.udf.keras_image_model <span style="color:#f92672">import</span> registerKerasImageUDF
</span></span><span style="display:flex;"><span>registerKerasImageUDF(<span style="color:#e6db74">&#34;inceptionV3_udf&#34;</span>, InceptionV3(weights<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;imagenet&#34;</span>))
</span></span><span style="display:flex;"><span>registerKerasImageUDF(<span style="color:#e6db74">&#34;my_custom_keras_model_udf&#34;</span>, <span style="color:#e6db74">&#34;/tmp/model-full-tmp.h5&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> keras.applications <span style="color:#f92672">import</span> InceptionV3
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sparkdl.udf.keras_image_model <span style="color:#f92672">import</span> registerKerasImageUDF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">keras_load_img</span>(fpath):
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span> keras.preprocessing.image <span style="color:#f92672">import</span> load_img, img_to_array
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span>    img <span style="color:#f92672">=</span> load_img(fpath, target_size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">299</span>, <span style="color:#ae81ff">299</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> img_to_array(img)<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>uint8)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>registerKerasImageUDF(<span style="color:#e6db74">&#34;inceptionV3_udf_with_preprocessing&#34;</span>, InceptionV3(weights<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;imagenet&#34;</span>), keras_load_img)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.ml.image <span style="color:#f92672">import</span> ImageSchema
</span></span><span style="display:flex;"><span>image_df <span style="color:#f92672">=</span> ImageSchema<span style="color:#f92672">.</span>readImages(sample_img_dir)
</span></span><span style="display:flex;"><span>image_df<span style="color:#f92672">.</span>registerTempTable(<span style="color:#e6db74">&#34;sample_images&#34;</span>)
</span></span><span style="display:flex;"><span>SELECT my_custom_keras_model_udf(image) <span style="color:#66d9ef">as</span> predictions <span style="color:#f92672">from</span> sample_images
</span></span></code></pre></div><h4 id="4-dl-relative">4. DL Relative</h4>
<h5 id="41-sparkpytorch">4.1. spark+pytorch</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>cuda <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>spark<span style="color:#f92672">.</span>conf<span style="color:#f92672">.</span>set(<span style="color:#e6db74">&#34;spark.sql.execution.arrow.enabled&#34;</span>, <span style="color:#e6db74">&#34;true&#34;</span>)
</span></span><span style="display:flex;"><span>spark<span style="color:#f92672">.</span>conf<span style="color:#f92672">.</span>set(<span style="color:#e6db74">&#34;spark.sql.execution.arrow.maxRecordsPerBatch&#34;</span>, <span style="color:#e6db74">&#34;2048&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> shutil
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> tarfile
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> zipfile
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span> urllib.request <span style="color:#f92672">import</span> urlretrieve
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> <span style="color:#a6e22e">ImportError</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span> urllib <span style="color:#f92672">import</span> urlretrieve
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch.utils.data <span style="color:#f92672">import</span> Dataset
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torchvision <span style="color:#f92672">import</span> datasets, models, transforms
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torchvision.datasets.folder <span style="color:#f92672">import</span> default_loader  <span style="color:#75715e"># private API</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.sql.functions <span style="color:#f92672">import</span> col, pandas_udf, PandasUDFType
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark.sql.types <span style="color:#f92672">import</span> ArrayType, FloatType
</span></span><span style="display:flex;"><span>use_cuda <span style="color:#f92672">=</span> cuda <span style="color:#f92672">and</span> torch<span style="color:#f92672">.</span>cuda<span style="color:#f92672">.</span>is_available()
</span></span><span style="display:flex;"><span>device <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>device(<span style="color:#e6db74">&#34;cuda&#34;</span> <span style="color:#66d9ef">if</span> use_cuda <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;cpu&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>URL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://download.tensorflow.org/example_images/flower_photos.tgz&#34;</span>
</span></span><span style="display:flex;"><span>input_local_dir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/dbfs/ml/tmp/flower/&#34;</span>
</span></span><span style="display:flex;"><span>output_file_path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/tmp/predictions&#34;</span>
</span></span><span style="display:flex;"><span>bc_model_state <span style="color:#f92672">=</span> sc<span style="color:#f92672">.</span>broadcast(models<span style="color:#f92672">.</span>resnet50(pretrained<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)<span style="color:#f92672">.</span>state_dict())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_model_for_eval</span>():
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;&#34;&#34;Gets the broadcasted model.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  model <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>resnet50(pretrained<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>  model<span style="color:#f92672">.</span>load_state_dict(bc_model_state<span style="color:#f92672">.</span>value)
</span></span><span style="display:flex;"><span>  model<span style="color:#f92672">.</span>eval()
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> model
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">maybe_download_and_extract</span>(url, download_dir):
</span></span><span style="display:flex;"><span>    filename <span style="color:#f92672">=</span> url<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;/&#39;</span>)[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    file_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(download_dir, filename)
</span></span><span style="display:flex;"><span>    print(file_path)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(file_path):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(download_dir):
</span></span><span style="display:flex;"><span>            os<span style="color:#f92672">.</span>makedirs(download_dir)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        file_path, _ <span style="color:#f92672">=</span> urlretrieve(url<span style="color:#f92672">=</span>url, filename<span style="color:#f92672">=</span>file_path)
</span></span><span style="display:flex;"><span>        print()
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Download finished. Extracting files.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> file_path<span style="color:#f92672">.</span>endswith(<span style="color:#e6db74">&#34;.zip&#34;</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Unpack the zip-file.</span>
</span></span><span style="display:flex;"><span>            zipfile<span style="color:#f92672">.</span>ZipFile(file<span style="color:#f92672">=</span>file_path, mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;r&#34;</span>)<span style="color:#f92672">.</span>extractall(download_dir)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> file_path<span style="color:#f92672">.</span>endswith((<span style="color:#e6db74">&#34;.tar.gz&#34;</span>, <span style="color:#e6db74">&#34;.tgz&#34;</span>)):
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Unpack the tar-ball.</span>
</span></span><span style="display:flex;"><span>            tarfile<span style="color:#f92672">.</span>open(name<span style="color:#f92672">=</span>file_path, mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;r:gz&#34;</span>)<span style="color:#f92672">.</span>extractall(download_dir)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Done.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Data has apparently already been downloaded and unpacked.&#34;</span>)
</span></span><span style="display:flex;"><span>maybe_download_and_extract(url<span style="color:#f92672">=</span>URL, download_dir<span style="color:#f92672">=</span>input_local_dir)
</span></span><span style="display:flex;"><span>local_dir <span style="color:#f92672">=</span> input_local_dir <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;flower_photos/&#39;</span>
</span></span><span style="display:flex;"><span>files <span style="color:#f92672">=</span> [os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(dp, f) <span style="color:#66d9ef">for</span> dp, dn, filenames <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>walk(local_dir) <span style="color:#66d9ef">for</span> f <span style="color:#f92672">in</span> filenames <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>splitext(f)[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;.jpg&#39;</span>]
</span></span><span style="display:flex;"><span>len(files)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>files_df <span style="color:#f92672">=</span> spark<span style="color:#f92672">.</span>createDataFrame(
</span></span><span style="display:flex;"><span>  map(<span style="color:#66d9ef">lambda</span> path: (path,), files), [<span style="color:#e6db74">&#34;path&#34;</span>]
</span></span><span style="display:flex;"><span>)<span style="color:#f92672">.</span>repartition(<span style="color:#ae81ff">10</span>)  <span style="color:#75715e"># number of partitions should be a small multiple of total number of nodes</span>
</span></span><span style="display:flex;"><span>display(files_df<span style="color:#f92672">.</span>limit(<span style="color:#ae81ff">10</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ImageDataset</span>(Dataset):
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> __init__(self, paths, transform<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>paths <span style="color:#f92672">=</span> paths
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>transform <span style="color:#f92672">=</span> transform
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> __len__(self):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> len(self<span style="color:#f92672">.</span>paths)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> __getitem__(self, index):
</span></span><span style="display:flex;"><span>    image <span style="color:#f92672">=</span> default_loader(self<span style="color:#f92672">.</span>paths[index])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>transform <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>      image <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>transform(image)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> image
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">predict_batch</span>(paths):
</span></span><span style="display:flex;"><span>  transform <span style="color:#f92672">=</span> transforms<span style="color:#f92672">.</span>Compose([
</span></span><span style="display:flex;"><span>    transforms<span style="color:#f92672">.</span>Resize(<span style="color:#ae81ff">224</span>),
</span></span><span style="display:flex;"><span>    transforms<span style="color:#f92672">.</span>CenterCrop(<span style="color:#ae81ff">224</span>),
</span></span><span style="display:flex;"><span>    transforms<span style="color:#f92672">.</span>ToTensor(),
</span></span><span style="display:flex;"><span>    transforms<span style="color:#f92672">.</span>Normalize(mean<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0.485</span>, <span style="color:#ae81ff">0.456</span>, <span style="color:#ae81ff">0.406</span>],
</span></span><span style="display:flex;"><span>                       std<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0.229</span>, <span style="color:#ae81ff">0.224</span>, <span style="color:#ae81ff">0.225</span>])
</span></span><span style="display:flex;"><span>  ])
</span></span><span style="display:flex;"><span>  images <span style="color:#f92672">=</span> ImageDataset(paths, transform<span style="color:#f92672">=</span>transform)
</span></span><span style="display:flex;"><span>  loader <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>utils<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>DataLoader(images, batch_size<span style="color:#f92672">=</span><span style="color:#ae81ff">500</span>, num_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>  model <span style="color:#f92672">=</span> get_model_for_eval()
</span></span><span style="display:flex;"><span>  model<span style="color:#f92672">.</span>to(device)
</span></span><span style="display:flex;"><span>  all_predictions <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">with</span> torch<span style="color:#f92672">.</span>no_grad():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> batch <span style="color:#f92672">in</span> loader:
</span></span><span style="display:flex;"><span>      predictions <span style="color:#f92672">=</span> list(model(batch<span style="color:#f92672">.</span>to(device))<span style="color:#f92672">.</span>cpu()<span style="color:#f92672">.</span>numpy())
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span> prediction <span style="color:#f92672">in</span> predictions:
</span></span><span style="display:flex;"><span>        all_predictions<span style="color:#f92672">.</span>append(prediction)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> pd<span style="color:#f92672">.</span>Series(all_predictions)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>predictions <span style="color:#f92672">=</span> predict_batch(pd<span style="color:#f92672">.</span>Series(files[:<span style="color:#ae81ff">200</span>]))  <span style="color:#75715e">#本地测试</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>predict_udf <span style="color:#f92672">=</span> pandas_udf(ArrayType(FloatType()), PandasUDFType<span style="color:#f92672">.</span>SCALAR)(predict_batch)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>predictions_df <span style="color:#f92672">=</span> files_df<span style="color:#f92672">.</span>select(col(<span style="color:#e6db74">&#39;path&#39;</span>), predict_udf(col(<span style="color:#e6db74">&#39;path&#39;</span>))<span style="color:#f92672">.</span>alias(<span style="color:#e6db74">&#34;prediction&#34;</span>))
</span></span><span style="display:flex;"><span>predictions_df<span style="color:#f92672">.</span>write<span style="color:#f92672">.</span>mode(<span style="color:#e6db74">&#34;overwrite&#34;</span>)<span style="color:#f92672">.</span>parquet(output_file_path)
</span></span><span style="display:flex;"><span>result_df <span style="color:#f92672">=</span> spark<span style="color:#f92672">.</span>read<span style="color:#f92672">.</span>load(output_file_path)
</span></span><span style="display:flex;"><span>display(result_df)
</span></span></code></pre></div><h5 id="42-submarine">4.2. Submarine</h5>
<blockquote>
<p>Submarine计算引擎通过命令行向YARN提交定制的深度学习应用程序（如 Tensorflow，Pytorch 等）。这些应用程序与YARN上的其他应用程序并行运行，例如Apache Spark，Hadoop Map / Reduce 等。</p>
<ul>
<li>Submarine-Zeppelin integration：允许数据科学家在 Zeppelin 的notebook中编写算法和调参进行可视化输出，并直接从notebook提交和管理机器学习的训练工作。</li>
<li>Submarine-Azkaban integration：允许数据科学家从Zeppelin 的notebook中直接向Azkaban提交一组具有依赖关系的任务，组成工作流进行周期性调度。</li>
<li>Submarine-installer：在你的服务器环境中安装Submarine和 YARN，轻松解决Docker、Parallel network和nvidia驱动的安装部署难题，以便你更轻松地尝试强大的工具集。</li>
<li>Apache Hadoop 3.1 的 YARN 可以完全无误的支持 Hadoop 2.7 + 以上的 HDFS 系统。</li>
</ul>
</blockquote>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210227083551241.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210227083551241.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210227083551241.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210227083551241.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210227083551241.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210227083551241.png"/></p>
<h5 id="43--sparkdl">4.3.  SparkDL</h5>
<ul>
<li><a href="https://github.com/databricks/spark-deep-learning"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/databricks/spark-deep-learning<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a>  sparkdl 支持spark版本如下：</li>
</ul>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210226212016988.png"
    data-srcset="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210226212016988.png, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210226212016988.png 1.5x, https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210226212016988.png 2x"
    data-sizes="auto"
    alt="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210226212016988.png"
    title="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/image-20210226212016988.png"/></p>
<p>4.4. <strong><a href="https://github.com/tensorflow/ecosystem/tree/master/spark/spark-tensorflow-distributor."target="_blank" rel="external nofollow noopener noreferrer">Distributed TensorFlow on Apache Spark 3.0<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> spark_tensorflow_distributor <span style="color:#f92672">import</span> MirroredStrategyRunner
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Taken from https://github.com/tensorflow/ecosystem/tree/master/spark/spark-tensorflow-distributor#examples</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> tensorflow <span style="color:#66d9ef">as</span> tf
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> uuid
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    BUFFER_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">10000</span>
</span></span><span style="display:flex;"><span>    BATCH_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">make_datasets</span>():
</span></span><span style="display:flex;"><span>        (mnist_images, mnist_labels), _ <span style="color:#f92672">=</span> \
</span></span><span style="display:flex;"><span>            tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>datasets<span style="color:#f92672">.</span>mnist<span style="color:#f92672">.</span>load_data(path<span style="color:#f92672">=</span>str(uuid<span style="color:#f92672">.</span>uuid4())<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;mnist.npz&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        dataset <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>Dataset<span style="color:#f92672">.</span>from_tensor_slices((
</span></span><span style="display:flex;"><span>            tf<span style="color:#f92672">.</span>cast(mnist_images[<span style="color:#f92672">...</span>, tf<span style="color:#f92672">.</span>newaxis] <span style="color:#f92672">/</span> <span style="color:#ae81ff">255.0</span>, tf<span style="color:#f92672">.</span>float32),
</span></span><span style="display:flex;"><span>            tf<span style="color:#f92672">.</span>cast(mnist_labels, tf<span style="color:#f92672">.</span>int64))
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        dataset <span style="color:#f92672">=</span> dataset<span style="color:#f92672">.</span>repeat()<span style="color:#f92672">.</span>shuffle(BUFFER_SIZE)<span style="color:#f92672">.</span>batch(BATCH_SIZE)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> dataset
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build_and_compile_cnn_model</span>():
</span></span><span style="display:flex;"><span>        model <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>Sequential([
</span></span><span style="display:flex;"><span>            tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Conv2D(<span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">3</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>, input_shape<span style="color:#f92672">=</span>(<span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">1</span>)),
</span></span><span style="display:flex;"><span>            tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>MaxPooling2D(),
</span></span><span style="display:flex;"><span>            tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Flatten(),
</span></span><span style="display:flex;"><span>            tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(<span style="color:#ae81ff">64</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>),
</span></span><span style="display:flex;"><span>            tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(<span style="color:#ae81ff">10</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;softmax&#39;</span>),
</span></span><span style="display:flex;"><span>        ])
</span></span><span style="display:flex;"><span>        model<span style="color:#f92672">.</span>compile(
</span></span><span style="display:flex;"><span>            loss<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>losses<span style="color:#f92672">.</span>sparse_categorical_crossentropy,
</span></span><span style="display:flex;"><span>            optimizer<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>optimizers<span style="color:#f92672">.</span>SGD(learning_rate<span style="color:#f92672">=</span><span style="color:#ae81ff">0.001</span>),
</span></span><span style="display:flex;"><span>            metrics<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;accuracy&#39;</span>],
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> model
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    train_datasets <span style="color:#f92672">=</span> make_datasets()
</span></span><span style="display:flex;"><span>    options <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>Options()
</span></span><span style="display:flex;"><span>    options<span style="color:#f92672">.</span>experimental_distribute<span style="color:#f92672">.</span>auto_shard_policy <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>experimental<span style="color:#f92672">.</span>AutoShardPolicy<span style="color:#f92672">.</span>DATA
</span></span><span style="display:flex;"><span>    train_datasets <span style="color:#f92672">=</span> train_datasets<span style="color:#f92672">.</span>with_options(options)
</span></span><span style="display:flex;"><span>    multi_worker_model <span style="color:#f92672">=</span> build_and_compile_cnn_model()
</span></span><span style="display:flex;"><span>    multi_worker_model<span style="color:#f92672">.</span>fit(x<span style="color:#f92672">=</span>train_datasets, epochs<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, steps_per_epoch<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>MirroredStrategyRunner(num_slots<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>)<span style="color:#f92672">.</span>run(train)
</span></span></code></pre></div><h5 id="44">4.4.</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> __future__ <span style="color:#f92672">import</span> absolute_import
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> __future__ <span style="color:#f92672">import</span> print_function
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> keras.datasets <span style="color:#f92672">import</span> mnist
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> keras.models <span style="color:#f92672">import</span> Sequential
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> keras.layers.core <span style="color:#f92672">import</span> Dense, Dropout, Activation, Flatten
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> keras.optimizers <span style="color:#f92672">import</span> SGD, Adam, RMSprop
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> keras.layers.convolutional <span style="color:#f92672">import</span> Convolution2D, MaxPooling2D
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> keras.utils <span style="color:#f92672">import</span> np_utils
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> elephas.spark_model <span style="color:#f92672">import</span> SparkModel
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> elephas.utils.rdd_utils <span style="color:#f92672">import</span> to_simple_rdd
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyspark <span style="color:#f92672">import</span> SparkContext, SparkConf
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> gzip
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> cPickle
</span></span><span style="display:flex;"><span>APP_NAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mnist&#34;</span>
</span></span><span style="display:flex;"><span>MASTER_IP <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;local[24]&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Define basic parameters</span>
</span></span><span style="display:flex;"><span>batch_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">128</span>
</span></span><span style="display:flex;"><span>nb_classes <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>nb_epoch <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># input image dimensions</span>
</span></span><span style="display:flex;"><span>img_rows, img_cols <span style="color:#f92672">=</span> <span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">28</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># number of convolutional filters to use</span>
</span></span><span style="display:flex;"><span>nb_filters <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># size of pooling area for max pooling</span>
</span></span><span style="display:flex;"><span>nb_pool <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># convolution kernel size</span>
</span></span><span style="display:flex;"><span>nb_conv <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Load data</span>
</span></span><span style="display:flex;"><span>f <span style="color:#f92672">=</span> gzip<span style="color:#f92672">.</span>open(<span style="color:#e6db74">&#34;./mnist.pkl.gz&#34;</span>, <span style="color:#e6db74">&#34;rb&#34;</span>)
</span></span><span style="display:flex;"><span>dd <span style="color:#f92672">=</span> cPickle<span style="color:#f92672">.</span>load(f)
</span></span><span style="display:flex;"><span>(X_train, y_train), (X_test, y_test) <span style="color:#f92672">=</span> dd
</span></span><span style="display:flex;"><span>X_train <span style="color:#f92672">=</span> X_train<span style="color:#f92672">.</span>reshape(X_train<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>], <span style="color:#ae81ff">1</span>, img_rows, img_cols)
</span></span><span style="display:flex;"><span>X_test <span style="color:#f92672">=</span> X_test<span style="color:#f92672">.</span>reshape(X_test<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>], <span style="color:#ae81ff">1</span>, img_rows, img_cols)
</span></span><span style="display:flex;"><span>X_train <span style="color:#f92672">=</span> X_train<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#34;float32&#34;</span>)
</span></span><span style="display:flex;"><span>X_test <span style="color:#f92672">=</span> X_test<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#34;float32&#34;</span>)
</span></span><span style="display:flex;"><span>X_train <span style="color:#f92672">/=</span> <span style="color:#ae81ff">255</span>
</span></span><span style="display:flex;"><span>X_test <span style="color:#f92672">/=</span> <span style="color:#ae81ff">255</span>
</span></span><span style="display:flex;"><span>print(X_train<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>], <span style="color:#e6db74">&#39;train samples&#39;</span>)
</span></span><span style="display:flex;"><span>print(X_test<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>], <span style="color:#e6db74">&#39;test samples&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Convert class vectors to binary class matrices</span>
</span></span><span style="display:flex;"><span>Y_train <span style="color:#f92672">=</span> np_utils<span style="color:#f92672">.</span>to_categorical(y_train, nb_classes)
</span></span><span style="display:flex;"><span>Y_test <span style="color:#f92672">=</span> np_utils<span style="color:#f92672">.</span>to_categorical(y_test, nb_classes)
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> Sequential()
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>add(Convolution2D(nb_filters, nb_conv, nb_conv,
</span></span><span style="display:flex;"><span>                        border_mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;full&#39;</span>,
</span></span><span style="display:flex;"><span>                        input_shape<span style="color:#f92672">=</span>(<span style="color:#ae81ff">1</span>, img_rows, img_cols)))
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>add(Activation(<span style="color:#e6db74">&#39;relu&#39;</span>))
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>add(Convolution2D(nb_filters, nb_conv, nb_conv))
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>add(Activation(<span style="color:#e6db74">&#39;relu&#39;</span>))
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>add(MaxPooling2D(pool_size<span style="color:#f92672">=</span>(nb_pool, nb_pool)))
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>add(Dropout(<span style="color:#ae81ff">0.25</span>))
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>add(Flatten())
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>add(Dense(<span style="color:#ae81ff">128</span>))
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>add(Activation(<span style="color:#e6db74">&#39;relu&#39;</span>))
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>add(Dropout(<span style="color:#ae81ff">0.5</span>))
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>add(Dense(nb_classes))
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>add(Activation(<span style="color:#e6db74">&#39;softmax&#39;</span>))
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>compile(loss<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;categorical_crossentropy&#39;</span>, optimizer<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;adadelta&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">## spark</span>
</span></span><span style="display:flex;"><span>conf <span style="color:#f92672">=</span> SparkConf()<span style="color:#f92672">.</span>setAppName(APP_NAME)<span style="color:#f92672">.</span>setMaster(MASTER_IP)
</span></span><span style="display:flex;"><span>sc <span style="color:#f92672">=</span> SparkContext(conf<span style="color:#f92672">=</span>conf)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Build RDD from numpy features and labels</span>
</span></span><span style="display:flex;"><span>rdd <span style="color:#f92672">=</span> to_simple_rdd(sc, X_train, Y_train)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize SparkModel from Keras model and Spark context</span>
</span></span><span style="display:flex;"><span>spark_model <span style="color:#f92672">=</span> SparkModel(sc,model)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Train Spark model</span>
</span></span><span style="display:flex;"><span>spark_model<span style="color:#f92672">.</span>train(rdd, nb_epoch<span style="color:#f92672">=</span>nb_epoch, batch_size<span style="color:#f92672">=</span>batch_size, verbose<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, validation_split<span style="color:#f92672">=</span><span style="color:#ae81ff">0.1</span>, num_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">24</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Evaluate Spark model by evaluating the underlying model</span>
</span></span><span style="display:flex;"><span>score <span style="color:#f92672">=</span> spark_model<span style="color:#f92672">.</span>get_network()<span style="color:#f92672">.</span>evaluate(X_test, Y_test, show_accuracy<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, verbose<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;Test accuracy:&#39;</span>, score[<span style="color:#ae81ff">1</span>])
</span></span></code></pre></div><h4 id="4-相关学习资源">4. 相关学习资源</h4>
<ul>
<li><a href="https://github.com/jupyter-incubator/sparkmagic"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/jupyter-incubator/sparkmagic<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
</ul>
<h5 id="41-infrastructure-projects">4.1. Infrastructure Projects</h5>
<ul>
<li><a href="https://github.com/spark-jobserver/spark-jobserver"target="_blank" rel="external nofollow noopener noreferrer">REST Job Server for Apache Spark<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> - REST interface for managing and submitting Spark jobs on the same cluster.</li>
<li><a href="http://mlbase.org/"target="_blank" rel="external nofollow noopener noreferrer">MLbase<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> - Machine Learning research project on top of Spark</li>
<li><a href="https://mesos.apache.org/"target="_blank" rel="external nofollow noopener noreferrer">Apache Mesos<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> - Cluster management system that supports running Spark</li>
<li><a href="https://www.alluxio.org/"target="_blank" rel="external nofollow noopener noreferrer">Alluxio<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> (née Tachyon) - Memory speed virtual distributed storage system that supports running Spark</li>
<li><a href="https://github.com/filodb/FiloDB"target="_blank" rel="external nofollow noopener noreferrer">FiloDB<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> - a Spark integrated analytical/columnar database, with in-memory option capable of sub-second concurrent queries</li>
<li><a href="http://zeppelin-project.org/"target="_blank" rel="external nofollow noopener noreferrer">Zeppelin<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> - Multi-purpose notebook which supports 20+ language backends, including Apache Spark</li>
<li><a href="https://github.com/EclairJS/eclairjs-node"target="_blank" rel="external nofollow noopener noreferrer">EclairJS<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> - enables Node.js developers to code against Spark, and data scientists to use Javascript in Jupyter notebooks.</li>
<li><a href="https://github.com/Hydrospheredata/mist"target="_blank" rel="external nofollow noopener noreferrer">Mist<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> - Serverless proxy for Spark cluster (spark middleware)</li>
<li><a href="https://github.com/GoogleCloudPlatform/spark-on-k8s-operator"target="_blank" rel="external nofollow noopener noreferrer">K8S Operator for Apache Spark<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> - Kubernetes operator for specifying and managing the lifecycle of Apache Spark applications on Kubernetes.</li>
<li><a href="https://developer.ibm.com/storage/products/ibm-spectrum-conductor-spark/"target="_blank" rel="external nofollow noopener noreferrer">IBM Spectrum Conductor<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> - Cluster management software that integrates with Spark and modern computing frameworks.</li>
<li><a href="https://delta.io/"target="_blank" rel="external nofollow noopener noreferrer">Delta Lake<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> - Storage layer that provides ACID transactions and scalable metadata handling for Apache Spark workloads.</li>
<li><a href="https://mlflow.org/"target="_blank" rel="external nofollow noopener noreferrer">MLflow<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> - Open source platform to manage the machine learning lifecycle, including deploying models from diverse machine learning libraries on Apache Spark.</li>
<li><a href="https://github.com/databricks/koalas"target="_blank" rel="external nofollow noopener noreferrer">Koalas<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> - Data frame API on Apache Spark that more closely follows Python’s pandas.</li>
<li><a href="https://datafu.apache.org/docs/spark/getting-started.html"target="_blank" rel="external nofollow noopener noreferrer">Apache DataFu<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> - A collection of utils and user-defined-functions for working with large scale data in Apache Spark, as well as making Scala-Python interoperability easier.</li>
</ul>
<h5 id="42-applications-using-spark">4.2. Applications Using Spark</h5>
<ul>
<li><a href="https://mahout.apache.org/"target="_blank" rel="external nofollow noopener noreferrer">Apache Mahout<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> - Previously on Hadoop MapReduce, Mahout has switched to using Spark as the backend</li>
<li><a href="https://wiki.apache.org/mrql/"target="_blank" rel="external nofollow noopener noreferrer">Apache MRQL<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> - A query processing and optimization system for large-scale, distributed data analysis, built on top of Apache Hadoop, Hama, and Spark</li>
<li><a href="http://blinkdb.org/"target="_blank" rel="external nofollow noopener noreferrer">BlinkDB<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> - a massively parallel, approximate query engine built on top of Shark and Spark</li>
<li><a href="https://github.com/adobe-research/spindle"target="_blank" rel="external nofollow noopener noreferrer">Spindle<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> - Spark/Parquet-based web analytics query engine</li>
<li><a href="https://github.com/thunderain-project/thunderain"target="_blank" rel="external nofollow noopener noreferrer">Thunderain<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> - a framework for combining stream processing with historical data, think Lambda architecture</li>
<li><a href="https://github.com/AyasdiOpenSource/df"target="_blank" rel="external nofollow noopener noreferrer">DF<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> from Ayasdi - a Pandas-like data frame implementation for Spark</li>
<li><a href="https://github.com/OryxProject/oryx"target="_blank" rel="external nofollow noopener noreferrer">Oryx<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> - Lambda architecture on Apache Spark, Apache Kafka for real-time large scale machine learning</li>
<li><a href="https://github.com/bigdatagenomics/adam"target="_blank" rel="external nofollow noopener noreferrer">ADAM<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> - A framework and CLI for loading, transforming, and analyzing genomic data using Apache Spark</li>
<li><a href="https://github.com/salesforce/TransmogrifAI"target="_blank" rel="external nofollow noopener noreferrer">TransmogrifAI<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> - AutoML library for building modular, reusable, strongly typed machine learning workflows on Spark with minimal hand tuning</li>
<li><a href="https://github.com/JohnSnowLabs/spark-nlp"target="_blank" rel="external nofollow noopener noreferrer">Natural Language Processing for Apache Spark<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> - A library to provide simple, performant, and accurate NLP annotations for machine learning pipelines</li>
<li><a href="http://rumbledb.org/"target="_blank" rel="external nofollow noopener noreferrer">Rumble for Apache Spark<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a> - A JSONiq engine to query, with a functional language, large, nested, and heterogeneous JSON datasets that do not fit in dataframes.</li>
</ul>
</div>
<div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title=2023-12-31&#32;16:28:09>更新于 2023-12-31&nbsp;</span>
      </div><div class="post-info-license">
          <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
        </div></div>
    <div class="post-info-line">
      <div class="post-info-md"><span><a href="/sparkrelative/index.md" title="阅读原始文档" class="link-to-markdown">阅读原始文档</a></span><span><a href="https://liudongdong1.github.io/edit/master/content/posts%5c%e6%a1%86%e6%9e%b6%e8%ae%be%e8%ae%a1%5csparkhadoop%5csparkRelative.md" title="编辑此页"target="_blank" rel="external nofollow noopener noreferrer" class="link-to-edit">编辑此页</a></span></div>
      <div class="post-info-share">
        <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://liudongdong1.github.io/sparkrelative/" data-title="sparkRelative" data-hashtags="stream,spark"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://liudongdong1.github.io/sparkrelative/" data-hashtag="stream"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://liudongdong1.github.io/sparkrelative/" data-title="sparkRelative" data-image="https://lddpicture.oss-cn-beijing.aliyuncs.com/picture/20210501132438.png"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/stream/">stream</a>,&nbsp;<a href="/tags/spark/">spark</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" class="prev" rel="prev" title="正则表达式"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>正则表达式</a>
      <a href="/virtualkeys/" class="next" rel="next" title="VirtualKeys">VirtualKeys<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.118.2">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.2.17-RC"><img class="fixit-icon" src="/fixit.min.svg" alt="FixIt logo" />&nbsp;FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2020 - 2024</span><span class="author" itemprop="copyrightHolder">
              <a href="https://liudongdong1.github.io/"target="_blank" rel="external nofollow noopener noreferrer">LiuDongdong</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div><div class="footer-line statistics"><span class="site-time" title='网站运行中 ...'><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden="true"></i>&nbsp;<span class="run-times">网站运行中 ...</span></span></div><div class="footer-line ibruce">
          <span id="busuanzi_container_site_uv" title='总访客数'><i class="fa-regular fa-user fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span><span id="busuanzi_container_site_pv" class="footer-divider" title='总访问量'><i class="fa-regular fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span>
        </div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric">0%</span>
        </div></div><a href="https://liudongdong1.github.io/" title="在 GitHub 上查看源代码"target="_blank" rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;--bg-progress: #0076ff;--bg-progress-dark: #fff;"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/algoliasearch/algoliasearch-lite.umd.min.js" defer></script><script src="/lib/lazysizes/lazysizes.min.js" async defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="/lib/pangu/pangu.min.js" defer></script><script src="/lib/cell-watermark/watermark.min.js" defer></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"data":{"typeit-header-subtitle-desktop":"\u003cspan style='font-family: MMT,\"沐目体\";'\u003e吾日三省吾身\u003c/span\u003e","typeit-header-subtitle-mobile":"\u003cspan style='font-family: MMT,\"沐目体\";'\u003e吾日三省吾身\u003c/span\u003e"},"enablePWA":true,"enablePangu":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"2R1K9SKLQZ","algoliaIndex":"index.zh-cn","algoliaSearchKey":"4a226aa1c5c98d6859e4d1386adb2bc7","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"siteTime":"2020-12-18T16:15:22+08:00","typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"typeit-header-subtitle-desktop":["typeit-header-subtitle-desktop"],"typeit-header-subtitle-mobile":["typeit-header-subtitle-mobile"]},"duration":-1,"speed":100},"watermark":{"appendto":".wrapper\u003emain","colspacing":30,"content":"\u003cimg class=\"fixit-icon\" src=\"/fixit.min.svg\" alt=\"FixIt logo\" /\u003e FixIt 主题","enable":true,"fontfamily":"inherit","fontsize":0.85,"height":21,"opacity":0.0125,"rotate":15,"rowspacing":60,"width":150}};</script><script src="/js/theme.min.js" defer></script><script src="/js/custom.min.js" defer></script></body>
</html>
